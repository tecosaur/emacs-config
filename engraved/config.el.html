<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>config.el.html</title>
    <style>
      body { background: #fafafa; color: #383a42; }
      pre {
        font-size: 1rem;
        max-width: min(100rem, 100%);
        width: max-content;
        white-space: pre-wrap;
        margin: auto; }
      .ef-D {
        color: #383a42; background-color: #fafafa; font-weight: 400; }
      .ef-vp {
         }
      .ef-h {
        color: #84888b; }
      .ef-sc {
        color: #50a14f; }
      .ef-w {
        color: #986801; }
      .ef-e {
        color: #e45649; }
      .ef-l {
        color: #4078f2; font-weight: 700; }
      .ef-lv {
        color: #8b008b; font-weight: 700; }
      .ef-hi {
        color: #f0f0f0; background-color: #4078f2; }
      .ef-c {
        color: #84888b; }
      .ef-cd {
        color: #84888b; }
      .ef-s {
        color: #50a14f; }
      .ef-d {
        color: #727578; text-decoration: italic; }
      .ef-m {
        color: #b751b6; }
      .ef-k {
        color: #e45649; }
      .ef-b {
        color: #a626a4; }
      .ef-f {
        color: #a626a4; }
      .ef-v {
        color: #6a1868; }
      .ef-t {
        color: #986801; }
      .ef-o {
        color: #b751b6; }
      .ef-wr {
        color: #986801; }
      .ef-nc {
        color: #4078f2; font-weight: 700; }
      .ef-pp {
        color: #4078f2; font-weight: 700; }
      .ef-rc {
        color: #4078f2; font-weight: 700; }
      .ef-rb {
        color: #4078f2; font-weight: 700; }
      .ef-ob {
        background-color: #e7e7e7; }
      .ef-obb {
        background-color: #e7e7e7; text-decoration: italic; }
      .ef-obe {
        background-color: #e7e7e7; text-decoration: italic; }
      .ef-Oa {
        color: #e45649; font-weight: nil; font-size: 1.25em }
      .ef-Ob {
        color: #da8548; font-weight: 700; font-size: 1.15em }
      .ef-Oc {
        color: #b751b6; font-weight: 700; font-size: 1.12em }
      .ef-Od {
        color: #6f99f5; font-weight: 600; font-size: 1.09em }
      .ef-Oe {
        color: #bc5cba; font-weight: 600; font-size: 1.06em }
      .ef-Of {
        color: #9fbbf8; font-weight: 600; font-size: 1.03em }
      .ef-Og {
        color: #d292d1; font-weight: 700; }
      .ef-Oh {
        color: #d8e4fc; font-weight: 600; }
      .ef-hn {
        color: #da8548; font-weight: 700; }
      .ef-hq {
        color: #4078f2; }
      .ef-hs {
        color: #986801; }
      .ef-rda {
        color: #4078f2; }
      .ef-rdb {
        color: #a626a4; }
      .ef-rdc {
        color: #50a14f; }
      .ef-rdd {
        color: #b751b6; }
      .ef-rde {
        color: #4db5bd; }
      .ef-rdf {
        color: #4078f2; }
      .ef-rdg {
        color: #a626a4; }
      .ef-rdh {
        color: #50a14f; }
      .ef-rdi {
        color: #b751b6; }
    </style>
  </head>
  <body>
<pre>
<span class="ef-cd">;;; </span><span class="ef-c">config.el -*- lexical-binding: t; -*-
</span>
<span class="ef-cd">;; </span><span class="ef-c">SPDX-FileCopyrightText: Â© 2020-2025 tecosaur &lt;contact@tecosaur.net&gt;
</span><span class="ef-cd">;; </span><span class="ef-c">SPDX-License-Identifier: MIT
</span>
<span class="ef-cd">;; </span><span class="ef-c">Generated at 2025-06-14T10:26:22+0000 from the literate configuration.
</span>
(add-to-list 'load-path <span class="ef-s">"~/.config/doom/subconf/"</span>)

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Confpkg timings
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">confpkg-timings-report</span><span class="ef-c">', `</span><span style="color: #b751b6;">confpkg-with-record</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">confpkg-finish-record</span><span class="ef-c">', `</span><span style="color: #b751b6;">confpkg-start-record</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">confpkg-create-record</span><span class="ef-c">', `</span><span style="color: #b751b6;">confpkg-record-num</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">confpkg-record-branch</span><span class="ef-c">', and `</span><span style="color: #b751b6;">confpkg-load-time-tree</span><span class="ef-c">'.
</span>
(<span class="ef-k">defvar</span> <span class="ef-v">confpkg-load-time-tree</span> (list (list 'root)))
(<span class="ef-k">defvar</span> <span class="ef-v">confpkg-record-branch</span> (list 'root))
(<span class="ef-k">defvar</span> <span class="ef-v">confpkg-record-num</span> 0)

(<span class="ef-k">defun</span> <span class="ef-f">confpkg-create-record</span> (name elapsed <span class="ef-t">&amp;optional</span> parent enclosing)
  (<span class="ef-k">let</span> ((parent (assoc (<span class="ef-k">or</span> parent (car confpkg-record-branch))
                       confpkg-load-time-tree))
        (record (cons name (list (list 'self
                                       <span class="ef-b">:name</span> (format <span class="ef-s">"%s"</span> name)
                                       <span class="ef-b">:num</span> (<span class="ef-k">cl-incf</span> confpkg-record-num)
                                       <span class="ef-b">:elapsed</span> elapsed
                                       <span class="ef-b">:enclosing</span> enclosing)))))
    (<span class="ef-k">push</span> record confpkg-load-time-tree)
    (<span class="ef-k">push</span> record (cdr parent))
    record))

(<span class="ef-k">defun</span> <span class="ef-f">confpkg-start-record</span> (name <span class="ef-t">&amp;optional</span> parent)
  (<span class="ef-k">let</span> ((record (confpkg-create-record name 0.0e+NaN parent t)))
    (plist-put (cdadr record) <span class="ef-b">:start</span> (float-time))
    (<span class="ef-k">push</span> name confpkg-record-branch)
    record))

(<span class="ef-k">defun</span> <span class="ef-f">confpkg-finish-record</span> (name)
  (<span class="ef-k">let</span> ((self-record (cdar (last (cdr (assoc name confpkg-load-time-tree))))))
    (plist-put self-record <span class="ef-b">:elapsed</span>
               (- (float-time) (plist-get self-record <span class="ef-b">:start</span>) 0.0))
    (<span class="ef-k">unless</span> (equal (car confpkg-record-branch) name)
      (message <span class="ef-s">"Warning: Confpkg timing record expected to finish %S, instead found %S. %S"</span>
               name (car confpkg-record-branch) confpkg-record-branch))
    (<span class="ef-k">setq</span> confpkg-record-branch (cdr confpkg-record-branch))))

(<span class="ef-k">defmacro</span> <span class="ef-f">confpkg-with-record</span> (name <span class="ef-t">&amp;rest</span> body)
  <span class="ef-d">"Create a time record around BODY.
The record must have a NAME."</span>
  (<span class="ef-k">declare</span> (indent 1))
  (<span class="ef-k">let</span> ((name-val (make-symbol <span class="ef-s">"name-val"</span>))
        (record-spec (make-symbol <span class="ef-s">"record-spec"</span>)))
    `(<span class="ef-k">let*</span> ((,name-val ,name)
            (,record-spec (<span class="ef-k">if</span> (consp ,name-val) ,name-val (list ,name-val))))
       (apply #'confpkg-start-record ,record-spec)
       (<span class="ef-k">unwind-protect</span>
           (<span class="ef-k">progn</span> ,@body)
         (confpkg-finish-record (car ,record-spec))))))

(<span class="ef-k">defadvice!</span> +require--log-timing-a (orig-fn feature <span class="ef-t">&amp;optional</span> filename noerror)
  <span class="ef-b">:around</span> #'require
  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (<span class="ef-k">featurep</span> <span class="ef-o">feature</span>)
          (eq feature 'cus-start) <span class="ef-cd">; </span><span class="ef-c">HACK Why!?!
</span>          (assoc (format <span class="ef-s">"require: %s"</span> feature) confpkg-load-time-tree))
      (funcall orig-fn feature filename noerror)
    (confpkg-with-record (list (format <span class="ef-s">"require: %s"</span> feature)
                               (<span class="ef-k">and</span> (eq (car confpkg-record-branch) 'root)
                                    'requires))
      (funcall orig-fn feature filename noerror))))

(<span class="ef-k">defun</span> <span class="ef-f">confpkg-timings-report</span> (<span class="ef-t">&amp;optional</span> sort-p node)
  <span class="ef-d">"Display a report on load-time information.
Supply SORT-P (or the universal argument) to sort the results.
NODE defaults to the root node."</span>
  (<span class="ef-k">interactive</span>
   (list (<span class="ef-k">and</span> current-prefix-arg t)))
  (<span class="ef-k">let</span> ((buf (get-buffer-create <span class="ef-s">"*Confpkg Load Time Report*"</span>))
        (depth 0)
        num-pad name-pad max-time max-total-time max-depth)
    (<span class="ef-k">cl-labels</span>
        ((sort-records-by-time
          (record)
          (<span class="ef-k">let</span> ((self (assoc 'self record)))
            (append (list self)
                    (sort (nreverse (remove self (cdr record)))
                          (<span class="ef-k">lambda</span> (a b)
                            (&gt; (<span class="ef-k">or</span> (plist-get (alist-get 'self a) <span class="ef-b">:total</span>) 0.0)
                               (<span class="ef-k">or</span> (plist-get (alist-get 'self b) <span class="ef-b">:total</span>) 0.0)))))))
         (print-record
          (record)
          (<span class="ef-k">cond</span>
           ((eq (car record) 'self)
            (insert
             (propertize
              (string-pad (number-to-string (plist-get (cdr record) <span class="ef-b">:num</span>)) num-pad)
              'face 'font-lock-keyword-face)
             <span class="ef-s">" "</span>
             (propertize
              (apply #'concat
                     (make-list (1- depth) <span class="ef-s">"â¢ "</span>))
              'face 'font-lock-comment-face)
             (string-pad (format <span class="ef-s">"%s"</span> (plist-get (cdr record) <span class="ef-b">:name</span>)) name-pad)
             (make-string (* (- max-depth depth) 2) ?\s)
             (propertize
              (format <span class="ef-s">"%.4fs"</span> (plist-get (cdr record) <span class="ef-b">:elapsed</span>))
              'face
              (list <span class="ef-b">:foreground</span>
                    (doom-blend 'orange 'green
                                (/ (plist-get (cdr record) <span class="ef-b">:elapsed</span>) max-time))))
             (<span class="ef-k">if</span> (= (plist-get (cdr record) <span class="ef-b">:elapsed</span>)
                    (plist-get (cdr record) <span class="ef-b">:total</span>))
                 <span class="ef-s">""</span>
               (concat <span class="ef-s">"   (Î£="</span>
                       (propertize
                        (format <span class="ef-s">"%.3fs"</span> (plist-get (cdr record) <span class="ef-b">:total</span>))
                        'face
                        (list <span class="ef-b">:foreground</span>
                              (doom-blend 'orange 'green
                                          (/ (plist-get (cdr record) <span class="ef-b">:total</span>) max-total-time))))
                       <span class="ef-s">")"</span>))
             <span class="ef-s">"\n"</span>))
           (t
            (<span class="ef-k">cl-incf</span> depth)
            (mapc
             #'print-record
             (<span class="ef-k">if</span> sort-p
                 (sort-records-by-time record)
               (reverse (cdr record))))
            (<span class="ef-k">cl-decf</span> depth))))
         (flatten-records
          (records)
          (<span class="ef-k">if</span> (eq (car records) 'self)
              (list records)
            (mapcan
             #'flatten-records
             (reverse (cdr records)))))
         (tree-depth
          (records <span class="ef-t">&amp;optional</span> depth)
          (<span class="ef-k">if</span> (eq (car records) 'self)
              (<span class="ef-k">or</span> depth 0)
            (1+ (cl-reduce #'max (cdr records) <span class="ef-b">:key</span> #'tree-depth))))
         (mapreduceprop
          (list map reduce prop)
          (cl-reduce
           reduce list
           <span class="ef-b">:key</span>
           (<span class="ef-k">lambda</span> (p) (funcall map (plist-get (cdr p) prop)))))
         (elaborate-timings
          (record)
          (<span class="ef-k">if</span> (eq (car record) 'self)
              (plist-get (cdr record) <span class="ef-b">:elapsed</span>)
            (<span class="ef-k">let</span> ((total (cl-reduce #'+ (cdr record)
                                    <span class="ef-b">:key</span> #'elaborate-timings))
                  (self (cdr (assoc 'self record))))
              (<span class="ef-k">if</span> (plist-get self <span class="ef-b">:enclosing</span>)
                  (<span class="ef-k">prog1</span>
                      (plist-get self <span class="ef-b">:elapsed</span>)
                    (plist-put self <span class="ef-b">:total</span> (plist-get self <span class="ef-b">:elapsed</span>))
                    (plist-put self <span class="ef-b">:elapsed</span>
                               (- (* 2 (plist-get self <span class="ef-b">:elapsed</span>)) total)))
                (plist-put self <span class="ef-b">:total</span> total)
                total))))
         (elaborated-timings
          (record)
          (<span class="ef-k">let</span> ((record (copy-tree record)))
            (elaborate-timings record)
            record)))
      (<span class="ef-k">let*</span> ((tree
              (elaborated-timings
               (append '(root)
                       (copy-tree
                        (alist-get (<span class="ef-k">or</span> node 'root)
                                   confpkg-load-time-tree
                                   nil nil #'equal))
                       '((self <span class="ef-b">:num</span> 0 <span class="ef-b">:elapsed</span> 0)))))
             (flat-records
              (cl-remove-if
               (<span class="ef-k">lambda</span> (rec) (= (plist-get (cdr rec) <span class="ef-b">:num</span>) 0))
               (flatten-records tree))))
        (<span class="ef-k">setq</span> max-time (mapreduceprop flat-records #'identity #'max <span class="ef-b">:elapsed</span>)
              max-total-time (mapreduceprop flat-records #'identity #'max <span class="ef-b">:total</span>)
              name-pad (mapreduceprop flat-records #'length #'max <span class="ef-b">:name</span>)
              num-pad (mapreduceprop flat-records
                                     (<span class="ef-k">lambda</span> (n) (length (number-to-string n)))
                                     #'max <span class="ef-b">:num</span>)
              max-depth (tree-depth tree))
        (<span class="ef-k">with-current-buffer</span> buf
          (erase-buffer)
          (<span class="ef-k">setq-local</span> outline-regexp <span class="ef-s">"[0-9]+ *</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">â¢ </span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">*"</span>)
          (outline-minor-mode 1)
          (use-local-map (make-sparse-keymap))
          (local-set-key <span class="ef-s">"TAB"</span> #'outline-toggle-children)
          (local-set-key <span class="ef-s">"\t"</span> #'outline-toggle-children)
          (local-set-key (kbd <span class="ef-s">"&lt;backtab&gt;"</span>) #'outline-show-subtree)
          (local-set-key (kbd <span class="ef-s">"C-&lt;iso-lefttab&gt;"</span>)
                         (eval `(<span class="ef-k">cmd!</span> (<span class="ef-k">if</span> current-prefix-arg
                                          (outline-show-all)
                                        (outline-hide-sublevels (+ ,num-pad 2))))))
          (insert
           (propertize
            (concat (string-pad <span class="ef-s">"#"</span> num-pad) <span class="ef-s">" "</span>
                    (string-pad <span class="ef-s">"Confpkg"</span>
                                (+ name-pad (* 2 max-depth) -3))
                    (format <span class="ef-s">" Load Time (Î£=%.3fs)\n"</span>
                            (plist-get (cdr (assoc 'self tree)) <span class="ef-b">:total</span>)))
            'face '(<span class="ef-b">:inherit</span> (tab-bar-tab bold) <span class="ef-b">:extend</span> t <span class="ef-b">:underline</span> t)))
          (<span class="ef-k">dolist</span> (record (<span class="ef-k">if</span> sort-p
                              (sort-records-by-time tree)
                            (reverse (cdr tree))))
            (<span class="ef-k">unless</span> (eq (car record) 'self)
              (print-record record)))
          (set-buffer-modified-p nil)
          (goto-char (point-min)))
        (pop-to-buffer buf)))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-confpkg-timings</span>)

(confpkg-create-record 'doom-pre-config (float-time (time-subtract (current-time) before-init-time)))
(confpkg-start-record 'config)
(confpkg-create-record 'config-defered 0.0 'config)
(confpkg-create-record 'set-hooks 0.0 'config-defered)
(confpkg-create-record 'load-hooks 0.0 'config-defered)
(confpkg-create-record 'requires 0.0 'root)

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Personal Information
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: personal-information"</span> config)
(<span class="ef-k">setq</span> user-full-name <span class="ef-s">"TEC"</span>
      user-mail-address <span class="ef-s">"contact@tecosaur.net"</span>)

(<span class="ef-k">setq</span> auth-sources '(<span class="ef-s">"~/.authinfo.gpg"</span>)
      auth-source-cache-expiry nil) <span class="ef-cd">; </span><span class="ef-c">default is 7200 (2h)
</span>
(<span class="ef-k">provide</span> '<span class="ef-o">config-personal-information</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Better defaults
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+he-suffix-strip-a</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+he-subst-suffix-overlap</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: better-defaults"</span> config)
(<span class="ef-k">setq-default</span>
 delete-by-moving-to-trash t                      <span class="ef-cd">; </span><span class="ef-c">Delete files to trash
</span> window-combination-resize t                      <span class="ef-cd">; </span><span class="ef-c">take new window space from all other windows (not just current)
</span> x-stretch-cursor t)                              <span class="ef-cd">; </span><span class="ef-c">Stretch cursor to the glyph width
</span>
(<span class="ef-k">setq</span> undo-limit 80000000                         <span class="ef-cd">; </span><span class="ef-c">Raise undo-limit to 80Mb
</span>      evil-want-fine-undo t                       <span class="ef-cd">; </span><span class="ef-c">By default while in insert all changes are one big blob. Be more granular
</span>      auto-save-default t                         <span class="ef-cd">; </span><span class="ef-c">Nobody likes to loose work, I certainly don't
</span>      truncate-string-ellipsis <span class="ef-s">"â¦"</span>                <span class="ef-cd">; </span><span class="ef-c">Unicode ellispis are nicer than "...", and also save /precious/ space
</span>      password-cache-expiry nil                   <span class="ef-cd">; </span><span class="ef-c">I can trust my computers ... can't I?
</span>      <span class="ef-cd">;; </span><span class="ef-c">scroll-preserve-screen-position 'always     ; Don't have `</span><span style="color: #b751b6;">point</span><span class="ef-c">' jump around
</span>      scroll-margin 2                             <span class="ef-cd">; </span><span class="ef-c">It's nice to maintain a little margin
</span>      display-time-default-load-average nil)      <span class="ef-cd">; </span><span class="ef-c">I don't think I've ever found this useful
</span>
(display-time-mode 1)                             <span class="ef-cd">; </span><span class="ef-c">Enable time in the mode-line
</span>(global-subword-mode 1)                           <span class="ef-cd">; </span><span class="ef-c">Iterate through CamelCase words
</span>


(add-to-list 'default-frame-alist '(height . 24))
(add-to-list 'default-frame-alist '(width . 80))

(<span class="ef-k">setq-default</span> custom-file (expand-file-name <span class="ef-s">".custom.el"</span> doom-user-dir))
(<span class="ef-k">when</span> (file-exists-p custom-file)
  (load custom-file))

(<span class="ef-k">setq</span> evil-vsplit-window-right t
      evil-split-window-below t)

(<span class="ef-k">defadvice!</span> prompt-for-buffer (<span class="ef-t">&amp;rest</span> _)
  <span class="ef-b">:after</span> '(evil-window-split evil-window-vsplit)
  (consult-buffer))

(map! <span class="ef-b">:map</span> evil-window-map
      <span class="ef-s">"SPC"</span> #'rotate-layout
      <span class="ef-cd">;; </span><span class="ef-c">Navigation
</span>      <span class="ef-s">"&lt;left&gt;"</span>     #'evil-window-left
      <span class="ef-s">"&lt;down&gt;"</span>     #'evil-window-down
      <span class="ef-s">"&lt;up&gt;"</span>       #'evil-window-up
      <span class="ef-s">"&lt;right&gt;"</span>    #'evil-window-right
      <span class="ef-cd">;; </span><span class="ef-c">Swapping windows
</span>      <span class="ef-s">"C-&lt;left&gt;"</span>       #'+evil/window-move-left
      <span class="ef-s">"C-&lt;down&gt;"</span>       #'+evil/window-move-down
      <span class="ef-s">"C-&lt;up&gt;"</span>         #'+evil/window-move-up
      <span class="ef-s">"C-&lt;right&gt;"</span>      #'+evil/window-move-right)

(global-set-key [remap dabbrev-expand] #'hippie-expand)

(<span class="ef-k">setq</span> hippie-expand-try-functions-list
      '(try-expand-list
        try-expand-dabbrev-visible
        try-expand-dabbrev
        try-expand-all-abbrevs
        try-expand-dabbrev-all-buffers
        try-complete-file-name-partially
        try-complete-file-name
        try-expand-dabbrev-from-kill
        try-expand-whole-kill
        try-expand-line
        try-complete-lisp-symbol-partially
        try-complete-lisp-symbol))

(<span class="ef-k">defun</span> <span class="ef-f">+he-subst-suffix-overlap</span> (ins rem)
  <span class="ef-d">"The longest suffix of the string INS that is a prefix of REM.
This is intended to be used when INS is a newly inserted string and REM is the
remainder of the line, to allow for handling potentially duplicated content."</span>
  (<span class="ef-k">let</span> ((len (min (length ins) (length rem))))
    (<span class="ef-k">while</span> (<span class="ef-k">and</span> (&gt; len 0)
                (not (eq 't (compare-strings ins (- len) nil rem 0 len))))
      (<span class="ef-k">setq</span> len (1- len)))
    len))

(<span class="ef-k">defun</span> <span class="ef-f">+he-suffix-strip-a</span> (args)
  <span class="ef-d">"Filter ARG list for `</span><span style="color: #b751b6; text-decoration: italic;">he-substitute-string</span><span class="ef-d">', truncating duplicated suffix.
ARGS is the raw argument list (STRING &amp;optional TRANS-CASE)."</span>
  (<span class="ef-k">pcase-let*</span> ((`(,ins <span class="ef-t">&amp;optional</span> ,trans-case) args)
               (rem (<span class="ef-k">save-excursion</span>
                      (goto-char (marker-position he-string-end))
                      (buffer-substring-no-properties
                       (point) (line-end-position))))
               (ov (+he-subst-suffix-overlap ins rem)))
    (<span class="ef-k">when</span> (&gt;= ov 0)
      (<span class="ef-k">setq</span> ins (substring ins 0 (- (length ins) ov))))
    (list ins trans-case)))

(advice-add #'he-substitute-string <span class="ef-b">:filter-args</span> #'+he-suffix-strip-a)

<span class="ef-cd">;; </span><span class="ef-c">(setq-default major-mode 'org-mode)
</span>
(<span class="ef-k">provide</span> '<span class="ef-o">config-better-defaults</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Doom
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+doom-init-theme-termaware</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+interpret-term-bg</span><span class="ef-c">', `</span><span style="color: #b751b6;">term-background-rgb</span><span class="ef-c">', `</span><span style="color: #b751b6;">+emoji-rx</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+emoji-set-font</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: doom"</span> config)
(<span class="ef-k">setq</span> doom-font (font-spec <span class="ef-b">:family</span> <span class="ef-s">"JetBrains Mono"</span> <span class="ef-b">:size</span> 24)
      doom-big-font (font-spec <span class="ef-b">:family</span> <span class="ef-s">"JetBrains Mono"</span> <span class="ef-b">:size</span> 36)
      doom-variable-pitch-font (font-spec <span class="ef-b">:family</span> <span class="ef-s">"Overpass"</span> <span class="ef-b">:size</span> 26)
      doom-symbol-font (font-spec <span class="ef-b">:family</span> <span class="ef-s">"JuliaMono"</span>)
      doom-emoji-font (font-spec <span class="ef-b">:family</span> <span class="ef-s">"Twitter Color Emoji"</span>) <span class="ef-cd">; </span><span class="ef-c">Just used by me
</span>      doom-serif-font (font-spec <span class="ef-b">:family</span> <span class="ef-s">"IBM Plex Mono"</span> <span class="ef-b">:size</span> 22 <span class="ef-b">:weight</span> 'light))

(<span class="ef-k">dolist</span> (char '(?â© ?âª ?â))
  (set-char-table-range char-script-table char 'symbol))

(<span class="ef-k">add-hook!</span> 'after-setting-font-hook
  (<span class="ef-k">defun</span> <span class="ef-f">+emoji-set-font</span> ()
    (set-fontset-font t 'emoji doom-emoji-font nil 'prepend)))

(<span class="ef-k">defvar</span> <span class="ef-v">+emoji-rx</span>
  (<span class="ef-k">let</span> (emojis)
    (map-char-table
     (<span class="ef-k">lambda</span> (char set)
       (<span class="ef-k">when</span> (eq set 'emoji)
         (<span class="ef-k">push</span> (copy-tree char) emojis)))
     char-script-table)
    (rx-to-string `(any ,@emojis)))
  <span class="ef-d">"A regexp to find all emoji-script characters."</span>)

(<span class="ef-k">setq</span> emoji-alternate-names
      '((<span class="ef-s">"ð"</span> <span class="ef-s">":)"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">":D"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">";)"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">":("</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"laughing face"</span> <span class="ef-s">"xD"</span>)
        (<span class="ef-s">"ð¤£"</span> <span class="ef-s">"ROFL face"</span>)
        (<span class="ef-s">"ð¢"</span> <span class="ef-s">":'("</span>)
        (<span class="ef-s">"ð¥²"</span> <span class="ef-s">":')"</span>)
        (<span class="ef-s">"ð®"</span> <span class="ef-s">":o"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">":|"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"cool face"</span>)
        (<span class="ef-s">"ð¤ª"</span> <span class="ef-s">"goofy face"</span>)
        (<span class="ef-s">"ð¤¥"</span> <span class="ef-s">"pinnochio face"</span> <span class="ef-s">"liar face"</span>)
        (<span class="ef-s">"ð "</span> <span class="ef-s">"&gt;:("</span>)
        (<span class="ef-s">"ð¡"</span> <span class="ef-s">"angry+ face"</span>)
        (<span class="ef-s">"ð¤¬"</span> <span class="ef-s">"swearing face"</span>)
        (<span class="ef-s">"ð¤¢"</span> <span class="ef-s">"sick face"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"smiling imp"</span>)
        (<span class="ef-s">"ð¿"</span> <span class="ef-s">"frowning imp"</span>)
        (<span class="ef-s">"â¤ï¸"</span> <span class="ef-s">"&lt;3"</span>)
        (<span class="ef-s">"ð«¡"</span> <span class="ef-s">"o7"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"+1"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"-1"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"left"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"right"</span>)
        (<span class="ef-s">"ð"</span> <span class="ef-s">"up"</span>)
        (<span class="ef-s">"ð¯"</span> <span class="ef-s">"100"</span>)
        (<span class="ef-s">"ð¸"</span> <span class="ef-s">"flying money"</span>)))

(<span class="ef-k">when</span> (&gt;= emacs-major-version 29)
  (map! <span class="ef-b">:leader</span>
        (<span class="ef-b">:prefix</span> (<span class="ef-s">"e"</span> . <span class="ef-s">"Emoji"</span>)
         <span class="ef-b">:desc</span> <span class="ef-s">"Search"</span> <span class="ef-s">"s"</span> #'emoji-search
         <span class="ef-b">:desc</span> <span class="ef-s">"Recent"</span> <span class="ef-s">"r"</span> #'emoji-recent
         <span class="ef-b">:desc</span> <span class="ef-s">"List"</span> <span class="ef-s">"l"</span> #'emoji-list
         <span class="ef-b">:desc</span> <span class="ef-s">"Describe"</span> <span class="ef-s">"d"</span> #'emoji-describe
         <span class="ef-b">:desc</span> <span class="ef-s">"Insert"</span> <span class="ef-s">"i"</span> #'emoji-insert
         <span class="ef-b">:desc</span> <span class="ef-s">"Insert"</span> <span class="ef-s">"e"</span> #'emoji-insert)))

(<span class="ef-k">unless</span> noninteractive
  (<span class="ef-k">add-hook!</span> 'doom-init-ui-hook
    (run-at-time nil nil
		 (<span class="ef-k">lambda</span> nil
		   (<span class="ef-k">let</span> (required-fonts available-fonts missing-fonts)
		     (<span class="ef-k">setq</span> required-fonts
			   '(<span class="ef-s">"JetBrains ?Mono.*"</span> <span class="ef-s">"Overpass"</span>
			     <span class="ef-s">"JuliaMono"</span> <span class="ef-s">"IBM Plex Mono"</span>
			     <span class="ef-s">"Merriweather"</span> <span class="ef-s">"Alegreya"</span>
			     <span class="ef-s">"Twitter Color Emoji"</span>))
		     (<span class="ef-k">setq</span> available-fonts
			   (delete-dups
			    (<span class="ef-k">or</span> (font-family-list)
				(<span class="ef-k">and</span> (executable-find <span class="ef-s">"fc-list"</span>)
				     (<span class="ef-k">with-temp-buffer</span>
				       (call-process <span class="ef-s">"fc-list"</span> nil t
						     nil <span class="ef-s">":"</span> <span class="ef-s">"family"</span>)
				       (split-string (buffer-string)
						     <span class="ef-s">"[,\n]"</span>))))))
		     (<span class="ef-k">setq</span> missing-fonts
			   (delq nil
				 (mapcar
				  (<span class="ef-k">lambda</span> (font)
				    (<span class="ef-k">unless</span>
					(delq nil
					      (mapcar
					       (<span class="ef-k">lambda</span> (f)
						 (string-match-p
						  (format <span class="ef-s">"^%s$"</span> font)
						  f))
					       available-fonts))
				      font))
				  required-fonts)))
		     (message <span class="ef-s">"%s missing the following fonts: %s"</span>
			      (propertize <span class="ef-s">"Warning!"</span> 'face
					  '(bold warning))
			      (mapconcat
			       (<span class="ef-k">lambda</span> (font)
				 (propertize font 'face
					     'font-lock-variable-name-face))
			       '(<span class="ef-s">"JetBrains ?Mono.*"</span> <span class="ef-s">"Overpass"</span>
				 <span class="ef-s">"JuliaMono"</span> <span class="ef-s">"IBM Plex Mono"</span>
				 <span class="ef-s">"Merriweather"</span> <span class="ef-s">"Alegreya"</span>
				 <span class="ef-s">"Twitter Color Emoji"</span>)
			       <span class="ef-s">", "</span>)))
		   (sleep-for 0.5)))))


(<span class="ef-k">setq</span> doom-theme <span class="ef-cd">; </span><span class="ef-c">Set according to the env var or system-dependent default
</span>      (<span class="ef-k">let</span> ((env-theme (getenv <span class="ef-s">"DOOM_THEME"</span>)))
        (<span class="ef-k">if</span> env-theme
            (intern env-theme) <span class="ef-cd">; </span><span class="ef-c">Note: `</span><span style="color: #b751b6;">intern-soft</span><span class="ef-c">' doesn't work here
</span>          'doom-vibrant)))

(<span class="ef-k">delq!</span> t custom-theme-load-path)

(<span class="ef-k">declare-function</span> 'xterm-query <span class="ef-s">"xterm"</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">term-background-rgb</span> nil
  <span class="ef-d">"A RGB triple corresponding to the current terminal background, if known."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">+interpret-term-bg</span> ()
  <span class="ef-d">"Examine an OSC color query response, and set `</span><span style="color: #b751b6; text-decoration: italic;">term-background-rgb</span><span class="ef-d">' accordingly."</span>
  (<span class="ef-k">let</span> ((str <span class="ef-s">""</span>)
        chr)
    <span class="ef-cd">;; </span><span class="ef-c">The reply should be: \e ] 11 ; rgb: NUMBER1 / NUMBER2 / NUMBER3 \e \\
</span>    (<span class="ef-k">while</span> (<span class="ef-k">and</span> (<span class="ef-k">setq</span> chr (xterm--read-event-for-query)) (not (equal chr ?\\)))
      (<span class="ef-k">setq</span> str (concat str (string chr))))
    (<span class="ef-k">when</span> (string-match
           <span class="ef-s">"rgb:</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[a-f0-9]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">/</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[a-f0-9]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">/</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[a-f0-9]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> str)
      (<span class="ef-k">let</span> ((r (string-to-number (match-string 1 str) 16))
            (g (string-to-number (match-string 2 str) 16))
            (b (string-to-number (match-string 3 str) 16)))
        (<span class="ef-k">setq</span> term-background-rgb (list r g b))))))

(<span class="ef-k">defun</span> <span class="ef-f">+doom-init-theme-termaware</span> ()
  <span class="ef-d">"Update `</span><span style="color: #b751b6; text-decoration: italic;">doom-theme</span><span class="ef-d">' if in a terminal, unless DOOM_THEME has been set."</span>
  (<span class="ef-k">let</span> (term-shade)
    (<span class="ef-k">when</span> (<span class="ef-k">and</span> (not (display-graphic-p (selected-frame)))
               (not (getenv <span class="ef-s">"DOOM_THEME"</span>))
               (<span class="ef-k">require</span> '<span class="ef-o">xterm</span> nil t))
      (message <span class="ef-s">"Querying terminal background color"</span>)
      (xterm--query <span class="ef-s">"\e]11;?\e\\"</span> '((<span class="ef-s">"\e]11;"</span> . +interpret-term-bg)))
      (<span class="ef-k">when</span> term-background-rgb
        (<span class="ef-k">setq</span> term-shade (<span class="ef-k">if</span> (&lt; (apply #'+ term-background-rgb) (* 0.6 3 65535))
                             'dark 'light))
        (<span class="ef-k">pcase</span> term-shade
          ('dark (<span class="ef-k">setq</span> doom-theme 'doom-vibrant))
          ('light (<span class="ef-k">setq</span> doom-theme 'doom-tomorrow-day)))))
    (doom-init-theme-h)))

(remove-hook 'window-setup-hook #'doom-init-theme-h)
(remove-hook 'after-init-hook   #'doom-init-theme-h)
(add-hook    'after-init-hook   #'+doom-init-theme-termaware 'append)

(<span class="ef-k">setq</span> display-line-numbers-type 'relative)

(evil-define-command +evil-buffer-org-new (_count file)
  <span class="ef-s">"Creates a new ORG buffer replacing the current window, optionally
   editing a certain FILE"</span>
  <span class="ef-b">:repeat</span> nil
  (<span class="ef-k">interactive</span> <span class="ef-s">"P&lt;f&gt;"</span>)
  (<span class="ef-k">if</span> file
      (evil-edit file)
    (<span class="ef-k">let</span> ((buffer (generate-new-buffer <span class="ef-s">"*new org*"</span>)))
      (set-window-buffer nil buffer)
      (<span class="ef-k">with-current-buffer</span> buffer
        (org-mode)
        (<span class="ef-k">setq-local</span> doom-real-buffer-p t)))))

(map! <span class="ef-b">:leader</span>
      (<span class="ef-b">:prefix</span> <span class="ef-s">"b"</span>
       <span class="ef-b">:desc</span> <span class="ef-s">"New empty Org buffer"</span> <span class="ef-s">"o"</span> #'+evil-buffer-org-new))

(<span class="ef-k">provide</span> '<span class="ef-o">config-doom</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Dashboard
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+doom-dashboard-tweak</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+doom-dashboard-benchmark-line</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+doom-dashboard-setup-modified-keymap</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">doom-dashboard-draw-ascii-emacs-banner-fn</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: dashboard"</span> config)
(<span class="ef-k">defun</span> <span class="ef-f">doom-dashboard-draw-ascii-emacs-banner-fn</span> ()
  (<span class="ef-k">let*</span> ((banner
          '(<span class="ef-s">",---.,-.-.,---.,---.,---."</span>
            <span class="ef-s">"|---'| | |,---||    `---."</span>
            <span class="ef-s">"`</span><span style="color: #b751b6;">---</span><span class="ef-s">'` ' '`---^`</span><span style="color: #b751b6;">---</span><span class="ef-s">'`</span><span style="color: #b751b6;">---</span><span class="ef-s">'"</span>))
         (longest-line (apply #'max (mapcar #'length banner))))
    (put-text-property
     (point)
     (<span class="ef-k">dolist</span> (line banner (point))
       (insert (+doom-dashboard--center
                +doom-dashboard--width
                (concat
                 line (make-string (max 0 (- longest-line (length line)))
                                   32)))
               <span class="ef-s">"\n"</span>))
     'face 'doom-dashboard-banner)))

(<span class="ef-k">unless</span> (display-graphic-p) <span class="ef-cd">; </span><span class="ef-c">for some reason this messes up the graphical splash screen atm
</span>  (<span class="ef-k">setq</span> +doom-dashboard-ascii-banner-fn #'doom-dashboard-draw-ascii-emacs-banner-fn))

(<span class="ef-k">defun</span> <span class="ef-f">+doom-dashboard-setup-modified-keymap</span> ()
  (<span class="ef-k">setq</span> +doom-dashboard-mode-map (make-sparse-keymap))
  (map! <span class="ef-b">:map</span> +doom-dashboard-mode-map
        <span class="ef-b">:desc</span> <span class="ef-s">"Find file"</span> <span class="ef-b">:ng</span> <span class="ef-s">"f"</span> #'find-file
        <span class="ef-b">:desc</span> <span class="ef-s">"Recent files"</span> <span class="ef-b">:ng</span> <span class="ef-s">"r"</span> #'consult-recent-file
        <span class="ef-b">:desc</span> <span class="ef-s">"Config dir"</span> <span class="ef-b">:ng</span> <span class="ef-s">"C"</span> #'doom/open-private-config
        <span class="ef-b">:desc</span> <span class="ef-s">"Open config.org"</span> <span class="ef-b">:ng</span> <span class="ef-s">"c"</span> (<span class="ef-k">cmd!</span> (find-file (expand-file-name <span class="ef-s">"config.org"</span> doom-user-dir)))
        <span class="ef-b">:desc</span> <span class="ef-s">"Open org-mode root"</span> <span class="ef-b">:ng</span> <span class="ef-s">"O"</span> (<span class="ef-k">cmd!</span> (find-file (expand-file-name <span class="ef-s">"lisp/org/"</span> doom-user-dir)))
        <span class="ef-b">:desc</span> <span class="ef-s">"Open dotfile"</span> <span class="ef-b">:ng</span> <span class="ef-s">"."</span> (<span class="ef-k">cmd!</span> (doom-project-find-file <span class="ef-s">"~/.config/"</span>))
        <span class="ef-b">:desc</span> <span class="ef-s">"Notes (roam)"</span> <span class="ef-b">:ng</span> <span class="ef-s">"n"</span> #'org-roam-node-find
        <span class="ef-b">:desc</span> <span class="ef-s">"Switch buffer"</span> <span class="ef-b">:ng</span> <span class="ef-s">"b"</span> #'+vertico/switch-workspace-buffer
        <span class="ef-b">:desc</span> <span class="ef-s">"Switch buffers (all)"</span> <span class="ef-b">:ng</span> <span class="ef-s">"B"</span> #'consult-buffer
        <span class="ef-b">:desc</span> <span class="ef-s">"IBuffer"</span> <span class="ef-b">:ng</span> <span class="ef-s">"i"</span> #'ibuffer
        <span class="ef-b">:desc</span> <span class="ef-s">"Previous buffer"</span> <span class="ef-b">:ng</span> <span class="ef-s">"p"</span> #'previous-buffer
        <span class="ef-b">:desc</span> <span class="ef-s">"Set theme"</span> <span class="ef-b">:ng</span> <span class="ef-s">"t"</span> #'consult-theme
        <span class="ef-b">:desc</span> <span class="ef-s">"Quit"</span> <span class="ef-b">:ng</span> <span class="ef-s">"Q"</span> #'save-buffers-kill-terminal
        <span class="ef-b">:desc</span> <span class="ef-s">"Show keybindings"</span> <span class="ef-b">:ng</span> <span class="ef-s">"h"</span> (<span class="ef-k">cmd!</span> (which-key-show-keymap '+doom-dashboard-mode-map))))

(<span class="ef-k">add-transient-hook!</span> #'+doom-dashboard-mode (+doom-dashboard-setup-modified-keymap))
(<span class="ef-k">add-transient-hook!</span> #'+doom-dashboard-mode <span class="ef-b">:append</span> (+doom-dashboard-setup-modified-keymap))
(<span class="ef-k">add-hook!</span> 'doom-init-ui-hook <span class="ef-b">:append</span> (+doom-dashboard-setup-modified-keymap))

(map! <span class="ef-b">:leader</span> <span class="ef-b">:desc</span> <span class="ef-s">"Dashboard"</span> <span class="ef-s">"d"</span> #'+doom-dashboard/open)

(<span class="ef-k">defun</span> <span class="ef-f">+doom-dashboard-benchmark-line</span> ()
  <span class="ef-d">"Insert the load time line."</span>
  (<span class="ef-k">when</span> doom-init-time
    (insert
     <span class="ef-s">"\n\n"</span>
     (propertize
      (+doom-dashboard--center
       +doom-dashboard--width
       (doom-display-benchmark-h 'return))
      'face 'doom-dashboard-loaded))))

(remove-hook 'doom-after-init-hook #'doom-display-benchmark-h)

(<span class="ef-k">setq</span> +doom-dashboard-functions
      (list #'doom-dashboard-widget-banner
            #'+doom-dashboard-benchmark-line
            #'splash-phrase-dashboard-insert))

(<span class="ef-k">defun</span> <span class="ef-f">+doom-dashboard-tweak</span> (<span class="ef-t">&amp;optional</span> _)
  (<span class="ef-k">with-current-buffer</span> (get-buffer +doom-dashboard-name)
    (<span class="ef-k">setq-local</span> line-spacing 0.2
                mode-line-format nil
                mode-name <span class="ef-s">""</span>
                evil-normal-state-cursor (list nil))))

(add-hook '+doom-dashboard-mode-hook #'+doom-dashboard-tweak)

(add-hook 'doom-after-init-hook #'+doom-dashboard-tweak 1)

(<span class="ef-k">setq</span> +doom-dashboard-name <span class="ef-s">"âº Doom"</span>
      doom-fallback-buffer-name +doom-dashboard-name)

(add-hook 'window-size-change-functions #'fancy-splash-apply-appropriate-image)
(add-hook 'doom-load-theme-hook #'fancy-splash-apply-appropriate-image)

(<span class="ef-k">provide</span> '<span class="ef-o">config-dashboard</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">fancy-splash
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">fancy-splash-apply-appropriate-image</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-get-appropriate-size</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-switch-template</span><span class="ef-c">', `</span><span style="color: #b751b6;">fancy-splash-clear-cache</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-ensure-theme-images-exist</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-generate-all-images</span><span class="ef-c">', `</span><span style="color: #b751b6;">fancy-splash-generate-image</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-filename</span><span class="ef-c">', `</span><span style="color: #b751b6;">fancy-splash-sizes</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-cache-dir</span><span class="ef-c">', `</span><span style="color: #b751b6;">fancy-splash-check-buffer</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-template-colours</span><span class="ef-c">', `</span><span style="color: #b751b6;">fancy-splash-image-template</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">fancy-splash-image-directory</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: fancy-splash"</span> config)
(<span class="ef-k">defvar</span> <span class="ef-v">fancy-splash-image-directory</span>
  (expand-file-name <span class="ef-s">"misc/splash-images/"</span> doom-user-dir)
  <span class="ef-d">"Directory in which to look for splash image templates."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">fancy-splash-image-template</span>
  (expand-file-name <span class="ef-s">"emacs-e-template.svg"</span> fancy-splash-image-directory)
  <span class="ef-d">"Default template svg used for the splash image.
Colours are substituted as per `</span><span style="color: #b751b6; text-decoration: italic;">fancy-splash-template-colours</span><span class="ef-d">'."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">fancy-splash-template-colours</span>
  '((<span class="ef-s">"#111112"</span> <span class="ef-b">:face</span> default   <span class="ef-b">:attr</span> <span class="ef-b">:foreground</span>)
    (<span class="ef-s">"#8b8c8d"</span> <span class="ef-b">:face</span> shadow)
    (<span class="ef-s">"#eeeeef"</span> <span class="ef-b">:face</span> default   <span class="ef-b">:attr</span> <span class="ef-b">:background</span>)
    (<span class="ef-s">"#e66100"</span> <span class="ef-b">:face</span> highlight <span class="ef-b">:attr</span> <span class="ef-b">:background</span>)
    (<span class="ef-s">"#1c71d8"</span> <span class="ef-b">:face</span> font-lock-keyword-face)
    (<span class="ef-s">"#f5c211"</span> <span class="ef-b">:face</span> font-lock-type-face)
    (<span class="ef-s">"#813d9c"</span> <span class="ef-b">:face</span> font-lock-constant-face)
    (<span class="ef-s">"#865e3c"</span> <span class="ef-b">:face</span> font-lock-function-name-face)
    (<span class="ef-s">"#2ec27e"</span> <span class="ef-b">:face</span> font-lock-string-face)
    (<span class="ef-s">"#c01c28"</span> <span class="ef-b">:face</span> error)
    (<span class="ef-s">"#000001"</span> <span class="ef-b">:face</span> ansi-color-black)
    (<span class="ef-s">"#ff0000"</span> <span class="ef-b">:face</span> ansi-color-red)
    (<span class="ef-s">"#ff00ff"</span> <span class="ef-b">:face</span> ansi-color-magenta)
    (<span class="ef-s">"#00ff00"</span> <span class="ef-b">:face</span> ansi-color-green)
    (<span class="ef-s">"#ffff00"</span> <span class="ef-b">:face</span> ansi-color-yellow)
    (<span class="ef-s">"#0000ff"</span> <span class="ef-b">:face</span> ansi-color-blue)
    (<span class="ef-s">"#00ffff"</span> <span class="ef-b">:face</span> ansi-color-cyan)
    (<span class="ef-s">"#fffffe"</span> <span class="ef-b">:face</span> ansi-color-white))
  <span class="ef-d">"Alist of colour-replacement plists.
Each plist is of the form (\"$placeholder\" :doom-color 'key :face 'face).
If the current theme is a doom theme :doom-color will be used,
otherwise the colour will be face foreground."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-check-buffer</span> ()
  <span class="ef-d">"Check the current SVG buffer for bad colours."</span>
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">when</span> (eq major-mode 'image-mode)
    (xml-mode))
  (<span class="ef-k">when</span> (<span class="ef-k">and</span> (<span class="ef-k">featurep</span> '<span class="ef-o">rainbow-mode</span>)
             (not (<span class="ef-k">bound-and-true-p</span> rainbow-mode)))
    (rainbow-mode 1))
  (<span class="ef-k">let*</span> ((colours (mapcar #'car fancy-splash-template-colours))
         (colourise-hex
          (<span class="ef-k">lambda</span> (hex)
            (propertize
             hex
             'face `((<span class="ef-b">:foreground</span>
                      ,(<span class="ef-k">if</span> (&lt; 0.5
                              (<span class="ef-k">cl-destructuring-bind</span> (r g b) (x-color-values hex)
                                <span class="ef-cd">;; </span><span class="ef-c">Values taken from `</span><span style="color: #b751b6;">rainbow-color-luminance</span><span class="ef-c">'
</span>                                (/ (+ (* .2126 r) (* .7152 g) (* .0722 b))
                                   (* 256 255 1.0))))
                           <span class="ef-s">"white"</span> <span class="ef-s">"black"</span>)
                      (<span class="ef-b">:background</span> ,hex))))))
         (cn 96)
         (colour-menu-entries
          (mapcar
           (<span class="ef-k">lambda</span> (colour)
             (<span class="ef-k">cl-incf</span> cn)
             (cons cn
                   (cons
                    (substring-no-properties colour)
                    (format <span class="ef-s">" (%s) %s %s"</span>
                            (propertize (char-to-string cn)
                                        'face 'font-lock-keyword-face)
                            (funcall colourise-hex colour)
                            (propertize
                             (symbol-name
                              (plist-get
                               (cdr (assoc colour fancy-splash-template-colours))
                               <span class="ef-b">:face</span>))
                             'face 'shadow)))))
           colours))
         (colour-menu-template
          (format
           <span class="ef-s">"Colour %%s is unexpected! Should this be one of the following?\n
%s
 %s to ignore
 %s to quit"</span>
           (mapconcat
            #'cddr
            colour-menu-entries
            <span class="ef-s">"\n"</span>)
           (propertize <span class="ef-s">"SPC"</span> 'face 'font-lock-keyword-face)
           (propertize <span class="ef-s">"ESC"</span> 'face 'font-lock-keyword-face)))
         (colour-menu-choice-keys
          (append (mapcar #'car colour-menu-entries)
                  (list ?\s)))
         (buf (get-buffer-create <span class="ef-s">"*fancy-splash-lint-colours-popup*"</span>))
         (good-colour-p
          (<span class="ef-k">lambda</span> (colour)
            (<span class="ef-k">or</span> (assoc colour fancy-splash-template-colours)
                <span class="ef-cd">;; </span><span class="ef-c">Check if greyscale
</span>                (<span class="ef-k">or</span> (<span class="ef-k">and</span> (= (length colour) 4)
                         (= (aref colour 1)   <span class="ef-cd">; </span><span class="ef-c">r
</span>                            (aref colour 2)   <span class="ef-cd">; </span><span class="ef-c">g
</span>                            (aref colour 3))) <span class="ef-cd">; </span><span class="ef-c">b
</span>                    (<span class="ef-k">and</span> (= (length colour) 7)
                         (string= (substring colour 1 3)       <span class="ef-cd">; </span><span class="ef-c">rr =
</span>                                  (substring colour 3 5))      <span class="ef-cd">; </span><span class="ef-c">gg
</span>                         (string= (substring colour 3 5)       <span class="ef-cd">; </span><span class="ef-c">gg =
</span>                                  (substring colour 5 7))))))) <span class="ef-cd">; </span><span class="ef-c">bb
</span>         (prompt-to-replace
          (<span class="ef-k">lambda</span> (target)
            (<span class="ef-k">with-current-buffer</span> buf
              (erase-buffer)
              (insert (format colour-menu-template
                              (funcall colourise-hex target)))
              (<span class="ef-k">setq-local</span> cursor-type nil)
              (set-buffer-modified-p nil)
              (goto-char (point-min)))
            (<span class="ef-k">save-window-excursion</span>
              (pop-to-buffer buf)
              (fit-window-to-buffer (get-buffer-window buf))
              (car (alist-get
                    (read-char-choice
                     (format <span class="ef-s">"Select replacement, %s-%s or SPC: "</span>
                             (char-to-string (caar colour-menu-entries))
                             (char-to-string (caar (last colour-menu-entries))))
                     colour-menu-choice-keys)
                    colour-menu-entries))))))
    (<span class="ef-k">save-excursion</span>
      (goto-char (point-min))
      (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"#[0-9A-Fa-f]\\{</span><span style="color: #6a1868;">6\\</span><span class="ef-s">}</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">#[0-9A-Fa-f]\\{</span><span style="color: #6a1868;">3\\</span><span class="ef-s">}"</span> nil t)
        (recenter)
        (<span class="ef-k">let*</span> ((colour (match-string 0))
               (replacement (<span class="ef-k">and</span> (not (funcall good-colour-p colour))
                                 (funcall prompt-to-replace colour))))
          (<span class="ef-k">when</span> replacement
            (replace-match replacement t t))))
      (message <span class="ef-s">"Done"</span>))))

(<span class="ef-k">defvar</span> <span class="ef-v">fancy-splash-cache-dir</span> (expand-file-name <span class="ef-s">"theme-splashes/"</span> doom-cache-dir))

(<span class="ef-k">defvar</span> <span class="ef-v">fancy-splash-sizes</span>
  `((<span class="ef-b">:height</span> 300 <span class="ef-b">:min-height</span> 50 <span class="ef-b">:padding</span> (0 . 2))
    (<span class="ef-b">:height</span> 250 <span class="ef-b">:min-height</span> 42 <span class="ef-b">:padding</span> (2 . 4))
    (<span class="ef-b">:height</span> 200 <span class="ef-b">:min-height</span> 35 <span class="ef-b">:padding</span> (3 . 3))
    (<span class="ef-b">:height</span> 150 <span class="ef-b">:min-height</span> 28 <span class="ef-b">:padding</span> (3 . 3))
    (<span class="ef-b">:height</span> 100 <span class="ef-b">:min-height</span> 20 <span class="ef-b">:padding</span> (2 . 2))
    (<span class="ef-b">:height</span> 75  <span class="ef-b">:min-height</span> 15 <span class="ef-b">:padding</span> (2 . 1))
    (<span class="ef-b">:height</span> 50  <span class="ef-b">:min-height</span> 10 <span class="ef-b">:padding</span> (1 . 0))
    (<span class="ef-b">:height</span> 1   <span class="ef-b">:min-height</span> 0  <span class="ef-b">:padding</span> (0 . 0)))
  <span class="ef-d">"List of plists specifying image sizing states.
Each plist should have the following properties:
- :height, the height of the image
- :min-height, the minimum `</span><span style="color: #b751b6; text-decoration: italic;">frame-height</span><span class="ef-d">' for image
- :padding, a `</span><span style="color: #b751b6; text-decoration: italic;">+doom-dashboard-banner-padding</span><span class="ef-d">' (top . bottom) padding
  specification to apply
Optionally, each plist may set the following two properties:
- :template, a non-default template file
- :file, a file to use instead of template"</span>)

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-filename</span> (theme template height)
  <span class="ef-d">"Get the file name for the splash image with THEME and of HEIGHT."</span>
  (expand-file-name (format <span class="ef-s">"%s-%s-%d.svg"</span> theme (file-name-base template) height) fancy-splash-cache-dir))

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-generate-image</span> (template height)
  <span class="ef-d">"Create a themed image from TEMPLATE of HEIGHT.
The theming is performed using `</span><span style="color: #b751b6; text-decoration: italic;">fancy-splash-template-colours</span><span class="ef-d">'
and the current theme."</span>
  (<span class="ef-k">with-temp-buffer</span>
    (insert-file-contents template)
    (goto-char (point-min))
    (<span class="ef-k">if</span> (re-search-forward <span class="ef-s">"$height"</span> nil t)
        (replace-match (number-to-string height) t t)
      (<span class="ef-k">if</span> (re-search-forward <span class="ef-s">"height=\"100</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">\\.0[0-9]*</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?\""</span> nil t)
          (<span class="ef-k">progn</span>
            (replace-match (format <span class="ef-s">"height=\"%s\""</span> height) t t)
            (goto-char (point-min))
            (<span class="ef-k">when</span> (re-search-forward <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[ \t\n]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">width=\"[\\.0-9]+\"[ \t\n]*"</span> nil t)
              (replace-match <span class="ef-s">"\\1"</span>)))
        (<span class="ef-wr">warn</span> <span class="ef-s">"Warning! fancy splash template: neither $height nor height=100 not found in %s"</span> template)))
    (<span class="ef-k">dolist</span> (substitution fancy-splash-template-colours)
      (goto-char (point-min))
      (<span class="ef-k">let*</span> ((replacement-colour
              (face-attribute (plist-get (cdr substitution) <span class="ef-b">:face</span>)
                              (<span class="ef-k">or</span> (plist-get (cdr substitution) <span class="ef-b">:attr</span>) <span class="ef-b">:foreground</span>)
                              nil 'default))
             (replacement-hex
              (<span class="ef-k">if</span> (string-prefix-p <span class="ef-s">"#"</span> replacement-colour)
                  replacement-colour
                (apply 'format <span class="ef-s">"#%02x%02x%02x"</span>
                       (mapcar (<span class="ef-k">lambda</span> (c) (ash c -8))
                               (color-values replacement-colour))))))
        (<span class="ef-k">while</span> (search-forward (car substitution) nil t)
          (replace-match replacement-hex nil nil))))
    (<span class="ef-k">unless</span> (file-exists-p fancy-splash-cache-dir)
      (make-directory fancy-splash-cache-dir t))
    (<span class="ef-k">let</span> ((inhibit-message t))
      (write-region nil nil (fancy-splash-filename (car custom-enabled-themes) template height)))))

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-generate-all-images</span> ()
  <span class="ef-d">"Perform `</span><span style="color: #b751b6; text-decoration: italic;">fancy-splash-generate-image</span><span class="ef-d">' in bulk."</span>
  (<span class="ef-k">dolist</span> (size fancy-splash-sizes)
    (<span class="ef-k">unless</span> (plist-get size <span class="ef-b">:file</span>)
      (fancy-splash-generate-image
       (<span class="ef-k">or</span> (plist-get size <span class="ef-b">:template</span>)
           fancy-splash-image-template)
       (plist-get size <span class="ef-b">:height</span>)))))

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-ensure-theme-images-exist</span> (<span class="ef-t">&amp;optional</span> height)
  <span class="ef-d">"Ensure that the relevant images exist.
Use the image of HEIGHT to check, defaulting to the height of the first
specification in `</span><span style="color: #b751b6; text-decoration: italic;">fancy-splash-sizes</span><span class="ef-d">'. If that file does not exist for
the current theme, `</span><span style="color: #b751b6; text-decoration: italic;">fancy-splash-generate-all-images</span><span class="ef-d">' is called. "</span>
  (<span class="ef-k">unless</span> (file-exists-p
           (fancy-splash-filename
            (car custom-enabled-themes)
            fancy-splash-image-template
            (<span class="ef-k">or</span> height (plist-get (car fancy-splash-sizes) <span class="ef-b">:height</span>))))
    (fancy-splash-generate-all-images)))

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-clear-cache</span> (<span class="ef-t">&amp;optional</span> delete-files)
  <span class="ef-d">"Clear all cached fancy splash images.
Optionally delete all cache files and regenerate the currently relevant set."</span>
  (<span class="ef-k">interactive</span> (list t))
  (<span class="ef-k">dolist</span> (size fancy-splash-sizes)
    (<span class="ef-k">unless</span> (plist-get size <span class="ef-b">:file</span>)
      (<span class="ef-k">let</span> ((image-file
             (fancy-splash-filename
              (car custom-enabled-themes)
              (<span class="ef-k">or</span> (plist-get size <span class="ef-b">:template</span>)
                  fancy-splash-image-template)
              (plist-get size <span class="ef-b">:height</span>))))
        (image-flush (create-image image-file) t))))
  (message <span class="ef-s">"Fancy splash image cache cleared!"</span>)
  (<span class="ef-k">when</span> delete-files
    (delete-directory fancy-splash-cache-dir t)
    (fancy-splash-generate-all-images)
    (message <span class="ef-s">"Fancy splash images cache deleted!"</span>)))

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-switch-template</span> ()
  <span class="ef-d">"Switch the template used for the fancy splash image."</span>
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">let</span> ((new (completing-read
              <span class="ef-s">"Splash template: "</span>
              (mapcar
               (<span class="ef-k">lambda</span> (template)
                 (replace-regexp-in-string <span class="ef-s">"-template\\.svg$"</span> <span class="ef-s">""</span> template))
               (directory-files fancy-splash-image-directory nil <span class="ef-s">"-template\\.svg\\'"</span>))
              nil t)))
    (<span class="ef-k">setq</span> fancy-splash-image-template
          (expand-file-name (concat new <span class="ef-s">"-template.svg"</span>) fancy-splash-image-directory))
    (fancy-splash-clear-cache)
    (message <span class="ef-s">""</span>) <span class="ef-cd">; </span><span class="ef-c">Clear message from `</span><span style="color: #b751b6;">fancy-splash-clear-cache</span><span class="ef-c">'.
</span>    (<span class="ef-k">setq</span> fancy-splash--last-size nil)
    (fancy-splash-apply-appropriate-image)))

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-get-appropriate-size</span> ()
  <span class="ef-d">"Find the firt `</span><span style="color: #b751b6; text-decoration: italic;">fancy-splash-sizes</span><span class="ef-d">' with min-height of at least frame height."</span>
  (<span class="ef-k">let</span> ((height (frame-height)))
    (cl-some (<span class="ef-k">lambda</span> (size) (<span class="ef-k">when</span> (&gt;= height (plist-get size <span class="ef-b">:min-height</span>)) size))
             fancy-splash-sizes)))

(<span class="ef-k">setq</span> fancy-splash--last-size nil)
(<span class="ef-k">setq</span> fancy-splash--last-theme nil)

(<span class="ef-k">defun</span> <span class="ef-f">fancy-splash-apply-appropriate-image</span> (<span class="ef-t">&amp;rest</span> _)
  <span class="ef-d">"Ensure the appropriate splash image is applied to the dashboard.
This function's signature is \"&amp;rest _\" to allow it to be used
in hooks that call functions with arguments."</span>
  (<span class="ef-k">let</span> ((appropriate-size (fancy-splash-get-appropriate-size)))
    (<span class="ef-k">unless</span> (<span class="ef-k">and</span> (equal appropriate-size fancy-splash--last-size)
                 (equal (car custom-enabled-themes) fancy-splash--last-theme))
      (<span class="ef-k">unless</span> (plist-get appropriate-size <span class="ef-b">:file</span>)
        (fancy-splash-ensure-theme-images-exist (plist-get appropriate-size <span class="ef-b">:height</span>)))
      (<span class="ef-k">setq</span> fancy-splash-image
            (<span class="ef-k">or</span> (plist-get appropriate-size <span class="ef-b">:file</span>)
                (fancy-splash-filename (car custom-enabled-themes)
                                       fancy-splash-image-template
                                       (plist-get appropriate-size <span class="ef-b">:height</span>)))
            +doom-dashboard-banner-padding (plist-get appropriate-size <span class="ef-b">:padding</span>)
            fancy-splash--last-size appropriate-size
            fancy-splash--last-theme (car custom-enabled-themes))
      (+doom-dashboard-reload))))

(<span class="ef-k">provide</span> '<span class="ef-o">fancy-splash</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">splash-phrases
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">splash-phrase-dashboard-insert</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">splash-phrase-dashboard-formatted</span><span class="ef-c">', `</span><span style="color: #b751b6;">splash-phrase</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">splash-phrase-get-from-file</span><span class="ef-c">', `</span><span style="color: #b751b6;">splash-phrase--cached-lines</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">splash-phrase-select-set</span><span class="ef-c">', `</span><span style="color: #b751b6;">splash-phrase-set-random-set</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">splash-phrase-set</span><span class="ef-c">', `</span><span style="color: #b751b6;">splash-phrase-sources</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">splash-phrase-source-folder</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: splash-phrases"</span> config)
(<span class="ef-k">defvar</span> <span class="ef-v">splash-phrase-source-folder</span>
  (expand-file-name <span class="ef-s">"misc/splash-phrases"</span> doom-user-dir)
  <span class="ef-d">"A folder of text files with a fun phrase on each line."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">splash-phrase-sources</span>
  (<span class="ef-k">let*</span> ((files (directory-files splash-phrase-source-folder nil <span class="ef-s">"\\.txt\\'"</span>))
         (sets (delete-dups (mapcar
                             (<span class="ef-k">lambda</span> (file)
                               (replace-regexp-in-string <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">-[0-9]+-\\w+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?\\.txt"</span> <span class="ef-s">""</span> file))
                             files))))
    (mapcar (<span class="ef-k">lambda</span> (sset)
              (cons sset
                    (delq nil (mapcar
                               (<span class="ef-k">lambda</span> (file)
                                 (<span class="ef-k">when</span> (string-match-p (regexp-quote sset) file)
                                   file))
                               files))))
            sets))
  <span class="ef-d">"A list of cons giving the phrase set name, and a list of files which contain phrase components."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">splash-phrase-set</span>
  (nth (random (length splash-phrase-sources)) (mapcar #'car splash-phrase-sources))
  <span class="ef-d">"The default phrase set. See `</span><span style="color: #b751b6; text-decoration: italic;">splash-phrase-sources</span><span class="ef-d">'."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">splash-phrase-set-random-set</span> ()
  <span class="ef-d">"Set a new random splash phrase set."</span>
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">setq</span> splash-phrase-set
        (nth (random (1- (length splash-phrase-sources)))
             (cl-set-difference (mapcar #'car splash-phrase-sources) (list splash-phrase-set))))
  (+doom-dashboard-reload t))

(<span class="ef-k">defun</span> <span class="ef-f">splash-phrase-select-set</span> ()
  <span class="ef-d">"Select a specific splash phrase set."</span>
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">setq</span> splash-phrase-set (completing-read <span class="ef-s">"Phrase set: "</span> (mapcar #'car splash-phrase-sources)))
  (+doom-dashboard-reload t))

(<span class="ef-k">defvar</span> <span class="ef-v">splash-phrase--cached-lines</span> nil)

(<span class="ef-k">defun</span> <span class="ef-f">splash-phrase-get-from-file</span> (file)
  <span class="ef-d">"Fetch a random line from FILE."</span>
  (<span class="ef-k">let</span> ((lines (<span class="ef-k">or</span> (cdr (assoc file splash-phrase--cached-lines))
                   (cdar (<span class="ef-k">push</span> (cons file
                                     (<span class="ef-k">with-temp-buffer</span>
                                       (insert-file-contents (expand-file-name file splash-phrase-source-folder))
                                       (split-string (string-trim (buffer-string)) <span class="ef-s">"\n"</span>)))
                               splash-phrase--cached-lines)))))
    (nth (random (length lines)) lines)))

(<span class="ef-k">defun</span> <span class="ef-f">splash-phrase</span> (<span class="ef-t">&amp;optional</span> set)
  <span class="ef-d">"Construct a splash phrase from SET. See `</span><span style="color: #b751b6; text-decoration: italic;">splash-phrase-sources</span><span class="ef-d">'."</span>
  (mapconcat
   #'splash-phrase-get-from-file
   (cdr (assoc (<span class="ef-k">or</span> set splash-phrase-set) splash-phrase-sources))
   <span class="ef-s">" "</span>))

(<span class="ef-k">defun</span> <span class="ef-f">splash-phrase-dashboard-formatted</span> ()
  <span class="ef-d">"Get a splash phrase, flow it over multiple lines as needed, and fontify it."</span>
  (mapconcat
   (<span class="ef-k">lambda</span> (line)
     (+doom-dashboard--center
      +doom-dashboard--width
      (<span class="ef-k">with-temp-buffer</span>
        (insert-text-button
         line
         'action
         (<span class="ef-k">lambda</span> (_) (+doom-dashboard-reload t))
         'face 'doom-dashboard-menu-title
         'mouse-face 'doom-dashboard-menu-title
         'help-echo <span class="ef-s">"Random phrase"</span>
         'follow-link t)
        (buffer-string))))
   (split-string
    (<span class="ef-k">with-temp-buffer</span>
      (insert (splash-phrase))
      (<span class="ef-k">setq</span> fill-column (min 70 (/ (* 2 (window-width)) 3)))
      (fill-region (point-min) (point-max))
      (buffer-string))
    <span class="ef-s">"\n"</span>)
   <span class="ef-s">"\n"</span>))

(<span class="ef-k">defun</span> <span class="ef-f">splash-phrase-dashboard-insert</span> ()
  <span class="ef-d">"Insert the splash phrase surrounded by newlines."</span>
  (insert <span class="ef-s">"\n"</span> (splash-phrase-dashboard-formatted) <span class="ef-s">"\n"</span>))

(<span class="ef-k">provide</span> '<span class="ef-o">splash-phrases</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Better jumper mouse
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: better-jumper-mouse"</span> config)
(map! <span class="ef-b">:n</span> [mouse-8] #'better-jumper-jump-backward
      <span class="ef-b">:n</span> [mouse-9] #'better-jumper-jump-forward)

(<span class="ef-k">provide</span> '<span class="ef-o">config-better-jumper-mouse</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Frame title
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: frame-title"</span> config)
(<span class="ef-k">setq</span> frame-title-format
      '(<span class="ef-s">""</span>
        (<span class="ef-b">:eval</span>
         (<span class="ef-k">if</span> (string-match-p (regexp-quote (<span class="ef-k">or</span> (<span class="ef-k">bound-and-true-p</span> org-roam-directory) <span class="ef-s">"\u0000"</span>))
                             (<span class="ef-k">or</span> buffer-file-name <span class="ef-s">""</span>))
             (replace-regexp-in-string
              <span class="ef-s">".*/[0-9]*-?"</span> <span class="ef-s">"â° "</span>
              (subst-char-in-string ?_ ?\s buffer-file-name))
           <span class="ef-s">"%b"</span>))
        (<span class="ef-b">:eval</span>
         (<span class="ef-k">when-let</span> ((project-name (<span class="ef-k">and</span> (<span class="ef-k">featurep</span> '<span class="ef-o">projectile</span>) (projectile-project-name))))
           (<span class="ef-k">unless</span> (string= <span class="ef-s">"-"</span> project-name)
             (format (<span class="ef-k">if</span> (buffer-modified-p)  <span class="ef-s">" â %s"</span> <span class="ef-s">" âââ %s"</span>) project-name))))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-frame-title</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Emacs daemon setup
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">greedily-do-daemon-setup</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: emacs-daemon-setup"</span> config)
(<span class="ef-k">defun</span> <span class="ef-f">greedily-do-daemon-setup</span> ()
  (<span class="ef-k">require</span> '<span class="ef-o">org</span>)
  (<span class="ef-k">when</span> (<span class="ef-k">require</span> '<span class="ef-o">mu4e</span> nil t)
    (<span class="ef-k">setq</span> mu4e-confirm-quit t)
    (<span class="ef-k">setq</span> +mu4e-lock-greedy t)
    (<span class="ef-k">setq</span> +mu4e-lock-relaxed t)
    (<span class="ef-k">when</span> (+mu4e-lock-available t)
      (mu4e--start)))
  (<span class="ef-k">when</span> (<span class="ef-k">require</span> '<span class="ef-o">elfeed</span> nil t)
    (run-at-time nil (* 8 60 60) #'elfeed-update)))

(<span class="ef-k">when</span> (daemonp)
  (add-hook 'emacs-startup-hook #'greedily-do-daemon-setup)
  (<span class="ef-k">add-hook!</span> 'server-after-make-frame-hook
    (<span class="ef-k">unless</span> (string-match-p <span class="ef-s">"\\*draft</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\*stdin</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">emacs-everywhere"</span> (buffer-name))
      (switch-to-buffer +doom-dashboard-name))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-emacs-daemon-setup</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Setup script prompt
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+config-run-setup</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: setup-script-prompt"</span> config)
(<span class="ef-k">unless</span> noninteractive
  (<span class="ef-k">defun</span> <span class="ef-f">+config-run-setup</span> nil
    (<span class="ef-k">when-let</span>
	((setup-file (expand-file-name <span class="ef-s">"setup.sh"</span> doom-user-dir))
	 ((file-exists-p setup-file))
	 (setup-content
	  (string-trim
	   (<span class="ef-k">with-temp-buffer</span>
	     (insert-file-contents setup-file) (buffer-string))
	   <span class="ef-s">"#!/usr/bin/env bash"</span>))
	 ((not (string-empty-p setup-content)))
	 ((yes-or-no-p
	   (format
	    <span class="ef-s">"%s The setup script has content. Check and run the script?"</span>
	    (propertize <span class="ef-s">"Warning!"</span> 'face '(bold warning))))))
      (find-file setup-file)
      (<span class="ef-k">when</span> (yes-or-no-p <span class="ef-s">"Would you like to run this script?"</span>)
	(async-shell-command <span class="ef-s">"./setup.sh"</span>))))
  (<span class="ef-k">add-hook!</span> 'doom-init-ui-hook
    (run-at-time nil nil #'+config-run-setup)))


(<span class="ef-k">provide</span> '<span class="ef-o">config-setup-script-prompt</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg avy
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-avy"</span> config)
<span class="ef-cd">;; </span><span class="ef-c">Avy: Colemak layout not detected (ErgoDox not mentioned in dmesg).
</span>
(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-avy</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg emacs-everywhere
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">emacs-everywhere-raise-frame-1</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-emacs-everywhere"</span> config)
(use-package! emacs-everywhere
  <span class="ef-b">:if</span> (daemonp)
  <span class="ef-b">:config</span>
  (<span class="ef-k">require</span> '<span class="ef-o">spell-fu</span>)
  (<span class="ef-k">setq</span> emacs-everywhere-major-mode-function #'org-mode
        emacs-everywhere-frame-name-format <span class="ef-s">"Edit â· %s â %s"</span>)
  (<span class="ef-k">defadvice!</span> emacs-everywhere-raise-frame ()
    <span class="ef-b">:after</span> #'emacs-everywhere-set-frame-name
    (<span class="ef-k">setq</span> emacs-everywhere-frame-name (format emacs-everywhere-frame-name-format
                                (emacs-everywhere-app-class emacs-everywhere-current-app)
                                (truncate-string-to-width
                                 (emacs-everywhere-app-title emacs-everywhere-current-app)
                                 45 nil nil <span class="ef-s">"â¦"</span>)))
    <span class="ef-cd">;; </span><span class="ef-c">need to wait till frame refresh happen before really set
</span>    (run-with-timer 0.1 nil #'emacs-everywhere-raise-frame-1))
  (<span class="ef-k">defun</span> <span class="ef-f">emacs-everywhere-raise-frame-1</span> ()
    (call-process <span class="ef-s">"wmctrl"</span> nil nil nil <span class="ef-s">"-a"</span> emacs-everywhere-frame-name)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-emacs-everywhere</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg which-key
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-which-key"</span> config)
(<span class="ef-k">setq</span> which-key-idle-delay 0.5) <span class="ef-cd">;; </span><span class="ef-c">I need the help, I really do
</span>
(<span class="ef-k">setq</span> which-key-allow-multiple-replacements t)
(<span class="ef-k">after!</span> which-key
  (<span class="ef-k">pushnew!</span>
   which-key-replacement-alist
   '((<span class="ef-s">""</span> . <span class="ef-s">"\\`+?evil[-:]?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">a-</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.*</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span>) . (nil . <span class="ef-s">"â\\1"</span>))
   '((<span class="ef-s">"\\`g s"</span> . <span class="ef-s">"\\`evilem--?motion-</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.*</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span>) . (nil . <span class="ef-s">"â\\1"</span>))
   ))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-which-key</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Abbrev
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: abbrev"</span> config)
(<span class="ef-k">setq-default</span> abbrev-mode t)

(<span class="ef-k">setq</span> abbrev-file-name (expand-file-name <span class="ef-s">"abbrev.el"</span> doom-user-dir))

(<span class="ef-k">setq</span> save-abbrevs nil)

(<span class="ef-k">provide</span> '<span class="ef-o">config-abbrev</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg VLF
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+vlf-isearch-wrap</span><span class="ef-c">', `</span><span style="color: #b751b6;">+vlf-last-chunk-or-end</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+vlf-next-chunk-or-start</span><span class="ef-c">', `</span><span style="color: #b751b6;">+vlf-update-linum</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">vlf-application</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-vlf"</span> config)
(use-package! vlf-setup
  <span class="ef-b">:defer-incrementally</span> vlf-tune vlf-base vlf-write
  vlf-search vlf-occur vlf-follow vlf-ediff vlf
  <span class="ef-b">:commands</span> vlf vlf-mode
  <span class="ef-b">:init</span>
  (<span class="ef-k">defvar</span> <span class="ef-v">vlf-application</span> 'ask) <span class="ef-cd">; </span><span class="ef-c">Avoid load-order issues
</span>  (<span class="ef-k">defadvice!</span> +files--ask-about-large-file-vlf (size op-type filename offer-raw)
  <span class="ef-d">"Like `</span><span style="color: #b751b6; text-decoration: italic;">files--ask-user-about-large-file</span><span class="ef-d">', but with support for `</span><span style="color: #b751b6; text-decoration: italic;">vlf</span><span class="ef-d">'."</span>
  <span class="ef-b">:override</span> #'files--ask-user-about-large-file
  (<span class="ef-k">if</span> (eq vlf-application 'dont-ask)
      (<span class="ef-k">progn</span> (vlf filename) (<span class="ef-wr">error</span> <span class="ef-s">""</span>))
    (<span class="ef-k">let</span> ((prompt (format <span class="ef-s">"File %s is large (%s), really %s?"</span>
                          (file-name-nondirectory filename)
                          (funcall byte-count-to-string-function size) op-type)))
      (<span class="ef-k">if</span> (not offer-raw)
          (<span class="ef-k">if</span> (y-or-n-p prompt) nil 'abort)
        (<span class="ef-k">let</span> ((choice
               (car
                (read-multiple-choice
                 prompt '((?y <span class="ef-s">"yes"</span>)
                          (?n <span class="ef-s">"no"</span>)
                          (?l <span class="ef-s">"literally"</span>)
                          (?v <span class="ef-s">"vlf"</span>))
                 (files--ask-user-about-large-file-help-text
                  op-type (funcall byte-count-to-string-function size))))))
          (<span class="ef-k">cond</span> ((eq choice ?y) nil)
                ((eq choice ?l) 'raw)
                ((eq choice ?v)
                 (vlf filename)
                 (<span class="ef-wr">error</span> <span class="ef-s">""</span>))
                (t 'abort)))))))
  <span class="ef-b">:config</span>
  (advice-remove 'abort-if-file-too-large #'ad-Advice-abort-if-file-too-large)
  (<span class="ef-k">defvar-local</span> <span class="ef-v">+vlf-cumulative-linenum</span> '((0 . 0))
  <span class="ef-d">"An alist keeping track of the cumulative line number."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">+vlf-update-linum</span> ()
  <span class="ef-d">"Update the line number offset."</span>
  (<span class="ef-k">let</span> ((linenum-offset (alist-get vlf-start-pos +vlf-cumulative-linenum)))
    (<span class="ef-k">setq</span> display-line-numbers-offset (<span class="ef-k">or</span> linenum-offset 0))
    (<span class="ef-k">when</span> (<span class="ef-k">and</span> linenum-offset (not (assq vlf-end-pos +vlf-cumulative-linenum)))
      (<span class="ef-k">push</span> (cons vlf-end-pos (+ linenum-offset
                                 (count-lines (point-min) (point-max))))
            +vlf-cumulative-linenum))))

(add-hook 'vlf-after-chunk-update-hook #'+vlf-update-linum)

<span class="ef-cd">;; </span><span class="ef-c">Since this only works with absolute line numbers, let's make sure we use them.
</span>(<span class="ef-k">add-hook!</span> 'vlf-mode-hook (<span class="ef-k">setq-local</span> display-line-numbers t))
  (<span class="ef-k">defun</span> <span class="ef-f">+vlf-next-chunk-or-start</span> ()
  (<span class="ef-k">if</span> (= vlf-file-size vlf-end-pos)
      (vlf-jump-to-chunk 1)
    (vlf-next-batch 1))
  (goto-char (point-min)))

(<span class="ef-k">defun</span> <span class="ef-f">+vlf-last-chunk-or-end</span> ()
  (<span class="ef-k">if</span> (= 0 vlf-start-pos)
      (vlf-end-of-file)
    (vlf-prev-batch 1))
  (goto-char (point-max)))

(<span class="ef-k">defun</span> <span class="ef-f">+vlf-isearch-wrap</span> ()
  (<span class="ef-k">if</span> isearch-forward
      (+vlf-next-chunk-or-start)
    (+vlf-last-chunk-or-end)))

(<span class="ef-k">add-hook!</span> 'vlf-mode-hook (<span class="ef-k">setq-local</span> isearch-wrap-function #'+vlf-isearch-wrap)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-vlf</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Eros
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-eros"</span> config)
(<span class="ef-k">setq</span> eros-eval-result-prefix <span class="ef-s">"â¹ "</span>) <span class="ef-cd">; </span><span class="ef-c">default =&gt;
</span>
(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-eros</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg evil
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-evil"</span> config)
(<span class="ef-k">after!</span> evil
  (<span class="ef-k">setq</span> evil-ex-substitute-global t     <span class="ef-cd">; </span><span class="ef-c">I like my s/../.. to by global by default
</span>        evil-move-cursor-back nil       <span class="ef-cd">; </span><span class="ef-c">Don't move the block cursor when toggling insert mode
</span>        evil-kill-on-visual-paste nil)) <span class="ef-cd">; </span><span class="ef-c">Don't put overwritten text in the kill ring
</span>
(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-evil</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg gptel
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-gptel"</span> config)
(use-package! gptel
  <span class="ef-b">:commands</span> gptel gptel-menu gptel-mode gptel-send
  <span class="ef-b">:config</span>
  (<span class="ef-k">let</span> ((groq-backend
         (gptel-make-openai <span class="ef-s">"Groq"</span>
           <span class="ef-b">:host</span> <span class="ef-s">"api.groq.com"</span>
           <span class="ef-b">:endpoint</span> <span class="ef-s">"/openai/v1/chat/completions"</span>
           <span class="ef-b">:stream</span> t
           <span class="ef-b">:key</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">or</span> (secrets-get-secret <span class="ef-s">"Login"</span> <span class="ef-s">"groq"</span>)
                          (secrets-get-secret <span class="ef-s">"kdewallet"</span> <span class="ef-s">"groq"</span>)))
           <span class="ef-b">:models</span> '(<span class="ef-s">"llama3-70b-8192"</span>
                     <span class="ef-s">"llama3-8b-8192"</span>
                     <span class="ef-s">"llama-3.1-70b-versatile"</span>
                     <span class="ef-s">"llama-3.1-8b-instant"</span>
                     <span class="ef-s">"llama-3.2-1b-preview"</span>
                     <span class="ef-s">"deepseek-r1-distill-llama-70b"</span>
                     <span class="ef-s">"mixtral-8x7b-32768"</span>
                     <span class="ef-s">"gemma-7b-it"</span>
                     <span class="ef-s">"gemma2-9b-it"</span>)))
        (openai-backend
         (gptel-make-openai <span class="ef-s">"ChatGPT"</span>
           <span class="ef-b">:host</span> <span class="ef-s">"api.openai.com"</span>
           <span class="ef-b">:stream</span> t
           <span class="ef-b">:key</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">or</span> (secrets-get-secret <span class="ef-s">"Login"</span> <span class="ef-s">"openai"</span>)
                          (secrets-get-secret <span class="ef-s">"kdewallet"</span> <span class="ef-s">"openai"</span>)))
           <span class="ef-b">:models</span> '(<span class="ef-s">"gpt-4o"</span> <span class="ef-s">"gpt-4o-mini"</span> <span class="ef-s">"chatgpt-4o-latest"</span>
                     <span class="ef-s">"o1"</span> <span class="ef-s">"o1-mini"</span>)))
        (anthropic-backend
         (gptel-make-anthropic <span class="ef-s">"Claude"</span>
           <span class="ef-b">:stream</span> t
           <span class="ef-b">:key</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">or</span> (secrets-get-secret <span class="ef-s">"Login"</span> <span class="ef-s">"anthropic"</span>)
                          (secrets-get-secret <span class="ef-s">"kdewallet"</span> <span class="ef-s">"anthropic"</span>)))
           <span class="ef-b">:models</span> '(<span class="ef-s">"claude-3-5-sonnet-20240620"</span>
                     <span class="ef-s">"claude-3-sonnet-20240229"</span>
                     <span class="ef-s">"claude-3-haiku-20240307"</span>)))
        (ollama-backend
         (<span class="ef-k">let</span> (ollama-models)
           (<span class="ef-k">when</span> (executable-find <span class="ef-s">"ollama"</span>)
             (<span class="ef-k">with-temp-buffer</span>
               (call-process <span class="ef-s">"ollama"</span> nil t nil <span class="ef-s">"list"</span>)
               (goto-char (point-min))
               (forward-line 1)
               (<span class="ef-k">while</span> (<span class="ef-k">and</span> (not (eobp)) (looking-at <span class="ef-s">"[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s"> \t]+"</span>))
                 (<span class="ef-k">push</span> (match-string 0) ollama-models)
                 (forward-line 1)))
             (gptel-make-ollama <span class="ef-s">"Ollama"</span> <span class="ef-b">:models</span> ollama-models <span class="ef-b">:stream</span> t)))))
    (<span class="ef-k">setq-default</span> gptel-model <span class="ef-s">"llama-3.1-70b-versatile"</span>
                  gptel-backend groq-backend))
  (delete (assoc <span class="ef-s">"ChatGPT"</span> gptel--known-backends) gptel--known-backends)
  (<span class="ef-k">setq</span> gptel-default-mode #'org-mode))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-gptel</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Headlice
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-headlice"</span> config)
(use-package! headlice
  <span class="ef-b">:hook</span> (prog-mode . headlice-auto-insert)
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> headlice-preferred-license 'mpl
        headlice-use-spdx-headers t
        headlice-ignored-licenses '(gpl-3)
        headlice-user-email <span class="ef-s">"contact@tecosaur.net"</span>)
  (<span class="ef-k">defalias</span> '<span class="ef-f">+file-templates/insert-license</span> #'headlice-create-license))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-headlice</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Consult
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-consult"</span> config)
(<span class="ef-k">after!</span> consult
  (set-face-attribute 'consult-file nil <span class="ef-b">:inherit</span> 'consult-buffer)
  (<span class="ef-k">setf</span> (plist-get (alist-get 'perl consult-async-split-styles-alist) <span class="ef-b">:initial</span>) <span class="ef-s">";"</span>))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-consult</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Magit
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+org-commit-message-template</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+magit-fill-in-commit-template</span><span class="ef-c">', `</span><span style="color: #b751b6;">+magit-default-forge-remote</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">and `</span><span style="color: #b751b6;">+magit-project-commit-templates-alist</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-magit"</span> config)
(<span class="ef-k">defvar</span> <span class="ef-v">+magit-project-commit-templates-alist</span> nil
  <span class="ef-d">"Alist of toplevel dirs and template hf strings/functions."</span>)
(<span class="ef-k">after!</span> magit
  (<span class="ef-k">defvar</span> <span class="ef-v">+magit-default-forge-remote</span> <span class="ef-s">"git@ssh.tecosaur.net:tec/%s.git"</span>
  <span class="ef-d">"Format string that fills out to a remote from the repo name.
Set to nil to disable this functionality."</span>)
(<span class="ef-k">defadvice!</span> +magit-remote-add--streamline-forge-a (args)
  <span class="ef-d">"Prompt to setup a remote using `</span><span style="color: #b751b6; text-decoration: italic;">+magit-default-forge-remote</span><span class="ef-d">'."</span>
  <span class="ef-b">:filter-args</span> #'magit-remote-add
  (<span class="ef-k">interactive</span>
   (<span class="ef-k">let</span> ((default-name
          (subst-char-in-string
           ?\s ?-
           (file-name-nondirectory
            (directory-file-name
             (<span class="ef-k">or</span> (doom-project-root) default-directory))))))
     (<span class="ef-k">or</span> (<span class="ef-k">and</span> +magit-default-forge-remote
              (not (magit-list-remotes))
              (eq (read-char-choice
                   (format <span class="ef-s">"Setup %s remote? [y/n]: "</span>
                           (replace-regexp-in-string
                            <span class="ef-s">"\\`</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">@]+@</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">https://</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">:/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">[:/].*\\'"</span> <span class="ef-s">"\\1"</span>
                            +magit-default-forge-remote))
                   '(?y ?n))
                  ?y)
              (<span class="ef-k">let</span> ((name (read-string <span class="ef-s">"Name: "</span> default-name)))
                (list <span class="ef-s">"origin"</span> (format +magit-default-forge-remote name)
                      (transient-args 'magit-remote))))
         (<span class="ef-k">let</span> ((origin (magit-get <span class="ef-s">"remote.origin.url"</span>))
               (remote (magit-read-string-ns <span class="ef-s">"Remote name"</span>))
               (gh-user (magit-get <span class="ef-s">"github.user"</span>)))
           (<span class="ef-k">and</span> (equal remote gh-user)
                (<span class="ef-k">if</span> origin
                    (<span class="ef-k">and</span>
                     (string-match <span class="ef-s">"\\`https://github\\.com/</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">/</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">\\.git\\'"</span>
                                   origin)
                     (not (string= (match-string 1 origin) gh-user)))
                  t)
                (<span class="ef-k">setq</span> origin
                      (<span class="ef-k">if</span> origin
                          (replace-regexp-in-string
                           <span class="ef-s">"\\`https://github\\.com/"</span> <span class="ef-s">"git@github.com:"</span>
                           origin)
                        (format <span class="ef-s">"git@github.com:%s/%s"</span> gh-user (read-string <span class="ef-s">"GitHub repo Name: "</span> default-name)))))
           (list remote
                 (magit-read-url
                  <span class="ef-s">"Remote url"</span>
                  (<span class="ef-k">and</span> origin
                       (string-match <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">:/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">/[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">\\.git</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?\\'"</span> origin)
                       (replace-match remote t t origin 1)))
                 (transient-args 'magit-remote))))))
  args)
(<span class="ef-k">defun</span> <span class="ef-f">+magit-fill-in-commit-template</span> ()
  <span class="ef-d">"Insert template from `</span><span style="color: #b751b6; text-decoration: italic;">+magit-fill-in-commit-template</span><span class="ef-d">' if applicable."</span>
  (<span class="ef-k">when-let</span> ((template (<span class="ef-k">and</span> (<span class="ef-k">save-excursion</span> (goto-char (point-min)) (string-match-p <span class="ef-s">"\\`\\s-*$"</span> (thing-at-point 'line)))
                            (cdr (assoc (file-name-base (directory-file-name (magit-toplevel)))
                                        +magit-project-commit-templates-alist)))))
    (goto-char (point-min))
    (insert (<span class="ef-k">if</span> (stringp template) template (funcall template)))
    (goto-char (point-min))
    (end-of-line)))
(add-hook 'git-commit-setup-hook #'+magit-fill-in-commit-template 90)
(<span class="ef-k">defun</span> <span class="ef-f">+org-commit-message-template</span> ()
  <span class="ef-d">"Create a skeleton for an Org commit message based on the staged diff."</span>
  (<span class="ef-k">let</span> (change-data last-file file-changes temp-point)
    (<span class="ef-k">with-temp-buffer</span>
      (apply #'call-process magit-git-executable
             nil t nil
             (append
              magit-git-global-arguments
              (list <span class="ef-s">"diff"</span> <span class="ef-s">"--cached"</span>)))
      (goto-char (point-min))
      (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"^@@</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">^\\+\\+\\+ b/"</span> nil t)
        (<span class="ef-k">if</span> (looking-back <span class="ef-s">"^\\+\\+\\+ b/"</span> (line-beginning-position))
            (<span class="ef-k">progn</span>
              (<span class="ef-k">push</span> (list last-file file-changes) change-data)
              (<span class="ef-k">setq</span> last-file (buffer-substring-no-properties (point) (line-end-position))
                    file-changes nil))
          (<span class="ef-k">setq</span> temp-point (line-beginning-position))
          (re-search-forward <span class="ef-s">"^\\+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">^-"</span> nil t)
          (end-of-line)
          (<span class="ef-k">cond</span>
           ((string-match-p <span class="ef-s">"\\.el$"</span> last-file)
            (<span class="ef-k">when</span> (re-search-backward <span class="ef-s">"^</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">[+-]? *</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">@@[ +-\\d,]+@@ </span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">(</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">cl-</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">defun</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">defvar</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">defmacro</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">defcustom</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> temp-point t)
              (re-search-forward <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">cl-</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">defun</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">defvar</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">defmacro</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">defcustom</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span> <span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">[:space:]\n]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> nil t)
              (<span class="ef-k">push</span> (match-string 1) file-changes)))
           ((string-match-p <span class="ef-s">"\\.org$"</span> last-file)
            (<span class="ef-k">when</span> (re-search-backward <span class="ef-s">"^[+-]\\*+ </span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">^@@[ +-\\d,]+@@ \\*+ "</span> temp-point t)
              (re-search-forward <span class="ef-s">"@@ \\*+ "</span> nil t)
              (<span class="ef-k">push</span> (buffer-substring-no-properties (point) (line-end-position)) file-changes)))))))
    (<span class="ef-k">setq</span> file-changes (delete-dups file-changes))
    (<span class="ef-k">push</span> (list last-file file-changes) change-data)
    (<span class="ef-k">setq</span> change-data (delete '(nil nil) change-data))
    (concat
     (<span class="ef-k">if</span> (= 1 (length change-data))
         (replace-regexp-in-string <span class="ef-s">"^.*/</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">.[a-z]+$"</span> <span class="ef-s">""</span> (caar change-data))
       <span class="ef-s">"?"</span>)
     <span class="ef-s">": \n\n"</span>
     (mapconcat
      (<span class="ef-k">lambda</span> (file-changes)
        (<span class="ef-k">if</span> (cadr file-changes)
            (format <span class="ef-s">"* %s (%s): "</span>
                    (car file-changes)
                    (mapconcat #'identity (cadr file-changes) <span class="ef-s">", "</span>))
          (format <span class="ef-s">"* %s: "</span> (car file-changes))))
      change-data
      <span class="ef-s">"\n\n"</span>))))

(add-to-list '+magit-project-commit-templates-alist (cons <span class="ef-s">"org"</span> #'+org-commit-message-template)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-magit</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Smerge
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">smerge-repeatedly</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-smerge"</span> config)
(<span class="ef-k">defun</span> <span class="ef-f">smerge-repeatedly</span> ()
  <span class="ef-d">"Perform smerge actions again and again"</span>
  (<span class="ef-k">interactive</span>)
  (smerge-mode 1)
  (smerge-transient))
(<span class="ef-k">after!</span> transient
  (transient-define-prefix smerge-transient ()
    [[<span class="ef-s">"Move"</span>
      (<span class="ef-s">"n"</span> <span class="ef-s">"next"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-next)) (smerge-repeatedly)))
      (<span class="ef-s">"p"</span> <span class="ef-s">"previous"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-prev)) (smerge-repeatedly)))]
     [<span class="ef-s">"Keep"</span>
      (<span class="ef-s">"b"</span> <span class="ef-s">"base"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-keep-base)) (smerge-repeatedly)))
      (<span class="ef-s">"u"</span> <span class="ef-s">"upper"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-keep-upper)) (smerge-repeatedly)))
      (<span class="ef-s">"l"</span> <span class="ef-s">"lower"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-keep-lower)) (smerge-repeatedly)))
      (<span class="ef-s">"a"</span> <span class="ef-s">"all"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-keep-all)) (smerge-repeatedly)))
      (<span class="ef-s">"RET"</span> <span class="ef-s">"current"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-keep-current)) (smerge-repeatedly)))]
     [<span class="ef-s">"Diff"</span>
      (<span class="ef-s">"&lt;"</span> <span class="ef-s">"upper/base"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-diff-base-upper)) (smerge-repeatedly)))
      (<span class="ef-s">"="</span> <span class="ef-s">"upper/lower"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-diff-upper-lower)) (smerge-repeatedly)))
      (<span class="ef-s">"&gt;"</span> <span class="ef-s">"base/lower"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-diff-base-lower)) (smerge-repeatedly)))
      (<span class="ef-s">"R"</span> <span class="ef-s">"refine"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-refine)) (smerge-repeatedly)))
      (<span class="ef-s">"E"</span> <span class="ef-s">"ediff"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-ediff)) (smerge-repeatedly)))]
     [<span class="ef-s">"Other"</span>
      (<span class="ef-s">"c"</span> <span class="ef-s">"combine"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-combine-with-next)) (smerge-repeatedly)))
      (<span class="ef-s">"r"</span> <span class="ef-s">"resolve"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-resolve)) (smerge-repeatedly)))
      (<span class="ef-s">"k"</span> <span class="ef-s">"kill current"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (<span class="ef-k">ignore-errors</span> (smerge-kill-current)) (smerge-repeatedly)))
      (<span class="ef-s">"q"</span> <span class="ef-s">"quit"</span> (<span class="ef-k">lambda</span> () (<span class="ef-k">interactive</span>) (smerge-auto-leave)))]]))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-smerge</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Corfu
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"hook: pkg-corfu"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'corfu
(confpkg-with-record '(<span class="ef-s">"load: pkg-corfu"</span> load-hooks)
(<span class="ef-k">setq</span> corfu-auto-delay 0.5)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-corfu</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Projectile
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">projectile-ignored-project-function</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-projectile"</span> config)
(<span class="ef-k">setq</span> projectile-ignored-projects
      (list <span class="ef-s">"~/"</span> <span class="ef-s">"/tmp"</span> (expand-file-name <span class="ef-s">"straight/repos"</span> doom-local-dir)))
(<span class="ef-k">defun</span> <span class="ef-f">projectile-ignored-project-function</span> (filepath)
  <span class="ef-d">"Return t if FILEPATH is within any of `</span><span style="color: #b751b6; text-decoration: italic;">projectile-ignored-projects</span><span class="ef-d">'"</span>
  (<span class="ef-k">or</span> (mapcar (<span class="ef-k">lambda</span> (p) (string-prefix-p p filepath)) projectile-ignored-projects)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-projectile</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Jinx
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: jinx"</span> config)
(use-package! jinx
  <span class="ef-b">:defer</span> t
  <span class="ef-b">:init</span>
  (add-hook 'doom-init-ui-hook #'global-jinx-mode)
  <span class="ef-b">:config</span>
  <span class="ef-cd">;; </span><span class="ef-c">Use my custom dictionary
</span>  (<span class="ef-k">setq</span> jinx-languages <span class="ef-s">"en-custom"</span>)
  <span class="ef-cd">;; </span><span class="ef-c">Extra face(s) to ignore
</span>  (<span class="ef-k">push</span> 'org-inline-src-block
        (alist-get 'org-mode jinx-exclude-faces))
  <span class="ef-cd">;; </span><span class="ef-c">Take over the relevant bindings.
</span>  (<span class="ef-k">after!</span> ispell
    (global-set-key [remap ispell-word] #'jinx-correct))
  (<span class="ef-k">after!</span> evil-commands
    (global-set-key [remap evil-next-flyspell-error] #'jinx-next)
    (global-set-key [remap evil-prev-flyspell-error] #'jinx-previous))
  <span class="ef-cd">;; </span><span class="ef-c">I prefer for `</span><span style="color: #b751b6;">point</span><span class="ef-c">' to end up at the start of the word,
</span>  <span class="ef-cd">;; </span><span class="ef-c">not just after the end.
</span>  (advice-add 'jinx-next <span class="ef-b">:after</span> (<span class="ef-k">lambda</span> (_) (left-word))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-jinx</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Autocorrect
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">autocorrect-jinx-appropriate</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">autocorrect-jinx-check-spelling</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">autocorrect-jinx-record-correction</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: autocorrect"</span> config)
(use-package! autocorrect
  <span class="ef-b">:after</span> jinx
  <span class="ef-b">:config</span>
  <span class="ef-cd">;; </span><span class="ef-c">Integrate with Jinx
</span>  (<span class="ef-k">defun</span> <span class="ef-f">autocorrect-jinx-record-correction</span> (overlay corrected)
    <span class="ef-d">"Record that Jinx corrected the text in OVERLAY to CORRECTED."</span>
    (<span class="ef-k">let</span> ((text
           (buffer-substring-no-properties
            (overlay-start overlay)
            (overlay-end overlay))))
      (autocorrect-record-correction text corrected)))

  (<span class="ef-k">defun</span> <span class="ef-f">autocorrect-jinx-check-spelling</span> (word)
    <span class="ef-d">"Check if WORD is valid."</span>
    <span class="ef-cd">;; </span><span class="ef-c">Mostly a copy of `</span><span style="color: #b751b6;">jinx--word-valid-p</span><span class="ef-c">', just without the buffer substring.
</span>    <span class="ef-cd">;; </span><span class="ef-c">It would have been nice if `</span><span style="color: #b751b6;">jinx--word-valid-p</span><span class="ef-c">' implemented like this
</span>    <span class="ef-cd">;; </span><span class="ef-c">with `</span><span style="color: #b751b6;">jinx--this-word-valid-p</span><span class="ef-c">' (or similar) as the at-point variant.
</span>    (<span class="ef-k">or</span> (member word jinx--session-words)
        <span class="ef-cd">;; </span><span class="ef-c">Allow capitalized words
</span>        (<span class="ef-k">and</span> (string-match-p <span class="ef-s">"\\`[[:upper:]][[:lower:]]+\\'"</span> word)
             (<span class="ef-k">cl-loop</span>
              for w in jinx--session-words
              thereis (<span class="ef-k">and</span> (string-equal-ignore-case word w)
                           (string-match-p <span class="ef-s">"\\`[[:lower:]]+\\'"</span> w))))
        (<span class="ef-k">cl-loop</span> for dict in jinx--dicts
                 thereis (jinx--mod-check dict word))))

  (<span class="ef-k">defun</span> <span class="ef-f">autocorrect-jinx-appropriate</span> (pos)
    <span class="ef-d">"Return non-nil if it is appropriate to spellcheck at POS according to jinx."</span>
    (<span class="ef-k">and</span> (not (jinx--face-ignored-p pos))
         (not (jinx--regexp-ignored-p pos))))

  (<span class="ef-k">setq</span> autocorrect-check-spelling-function #'autocorrect-jinx-check-spelling)
  (add-to-list 'autocorrect-predicates #'autocorrect-jinx-appropriate)
  (advice-add 'jinx--correct-replace <span class="ef-b">:before</span> #'autocorrect-jinx-record-correction)

  <span class="ef-cd">;; </span><span class="ef-c">Run setup
</span>  (run-with-idle-timer 0.5 nil #'autocorrect-setup)

  <span class="ef-cd">;; </span><span class="ef-c">Make work with evil-mode
</span>  (evil-collection-set-readonly-bindings 'autocorrect-list-mode-map)
  (evil-collection-define-key 'normal 'autocorrect-list-mode-map
    (kbd <span class="ef-s">"a"</span>) #'autocorrect-create-correction
    (kbd <span class="ef-s">"x"</span>) #'autocorrect-remove-correction
    (kbd <span class="ef-s">"i"</span>) #'autocorrect-ignore-word))

(<span class="ef-k">provide</span> '<span class="ef-o">config-autocorrect</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">TRAMP
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: tramp"</span> config)
(<span class="ef-k">after!</span> tramp
  (setenv <span class="ef-s">"SHELL"</span> <span class="ef-s">"/bin/bash"</span>)
  (<span class="ef-k">setq</span> tramp-shell-prompt-pattern <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">^</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\n</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\x0d</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">]#$%&gt;\n]*#?[]#$%&gt;î°] *</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">\e\\[[0-9;]*[a-zA-Z] *</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">*"</span>)) <span class="ef-cd">;; </span><span class="ef-c">default + î°
</span>
(<span class="ef-k">after!</span> tramp
  (<span class="ef-k">appendq!</span> tramp-remote-path
            '(<span class="ef-s">"~/.guix-profile/bin"</span> <span class="ef-s">"~/.guix-profile/sbin"</span>
              <span class="ef-s">"/run/current-system/profile/bin"</span>
              <span class="ef-s">"/run/current-system/profile/sbin"</span>)))

(<span class="ef-k">provide</span> '<span class="ef-o">config-tramp</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg AAS
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-aas"</span> config)
(use-package! aas
  <span class="ef-b">:commands</span> aas-mode)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-aas</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Screenshot
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-screenshot"</span> config)
(use-package! screenshot
  <span class="ef-b">:defer</span> t
  <span class="ef-b">:config</span> (<span class="ef-k">setq</span> screenshot-upload-fn <span class="ef-s">"upload %s 2&gt;/dev/null"</span>))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-screenshot</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg etrace
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-etrace"</span> config)
(use-package! etrace
  <span class="ef-b">:after</span> elp)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-etrace</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg YASnippet
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-yasnippet"</span> config)
(<span class="ef-k">setq</span> yas-triggers-in-field t)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-yasnippet</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg String Inflection
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-string-inflection"</span> config)
(use-package! string-inflection
  <span class="ef-b">:commands</span> (string-inflection-all-cycle
             string-inflection-toggle
             string-inflection-camelcase
             string-inflection-lower-camelcase
             string-inflection-kebab-case
             string-inflection-underscore
             string-inflection-capital-underscore
             string-inflection-upcase)
  <span class="ef-b">:init</span>
  (map! <span class="ef-b">:leader</span> <span class="ef-b">:prefix</span> (<span class="ef-s">"c~"</span> . <span class="ef-s">"naming convention"</span>)
        <span class="ef-b">:desc</span> <span class="ef-s">"cycle"</span> <span class="ef-s">"~"</span> #'string-inflection-all-cycle
        <span class="ef-b">:desc</span> <span class="ef-s">"toggle"</span> <span class="ef-s">"t"</span> #'string-inflection-toggle
        <span class="ef-b">:desc</span> <span class="ef-s">"CamelCase"</span> <span class="ef-s">"c"</span> #'string-inflection-camelcase
        <span class="ef-b">:desc</span> <span class="ef-s">"downCase"</span> <span class="ef-s">"d"</span> #'string-inflection-lower-camelcase
        <span class="ef-b">:desc</span> <span class="ef-s">"kebab-case"</span> <span class="ef-s">"k"</span> #'string-inflection-kebab-case
        <span class="ef-b">:desc</span> <span class="ef-s">"under_score"</span> <span class="ef-s">"_"</span> #'string-inflection-underscore
        <span class="ef-b">:desc</span> <span class="ef-s">"Upper_Score"</span> <span class="ef-s">"u"</span> #'string-inflection-capital-underscore
        <span class="ef-b">:desc</span> <span class="ef-s">"UP_CASE"</span> <span class="ef-s">"U"</span> #'string-inflection-upcase)
  (<span class="ef-k">after!</span> evil
    (evil-define-operator evil-operator-string-inflection (beg end _type)
      <span class="ef-s">"Define a new evil operator that cycles symbol casing."</span>
      <span class="ef-b">:move-point</span> nil
      (<span class="ef-k">interactive</span> <span class="ef-s">"&lt;R&gt;"</span>)
      (string-inflection-all-cycle)
      (<span class="ef-k">setq</span> evil-repeat-info '([?g ?~])))
    (define-key evil-normal-state-map (kbd <span class="ef-s">"g~"</span>) 'evil-operator-string-inflection)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-string-inflection</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg SmartParens
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-smartparens"</span> config)
(sp-local-pair
 '(org-mode)
 <span class="ef-s">"&lt;&lt;"</span> <span class="ef-s">"&gt;&gt;"</span>
 <span class="ef-b">:actions</span> '(insert))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-smartparens</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Info colors
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-info-colors"</span> config)
(use-package! info-colors
  <span class="ef-b">:commands</span> (info-colors-fontify-node))

(add-hook 'Info-selection-hook 'info-colors-fontify-node)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-info-colors</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Theme magic
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-theme-magic"</span> config)
(use-package! theme-magic
  <span class="ef-b">:commands</span> theme-magic-from-emacs
  <span class="ef-b">:config</span>
  (<span class="ef-k">defadvice!</span> theme-magic--auto-extract-16-doom-colors ()
    <span class="ef-b">:override</span> #'theme-magic--auto-extract-16-colors
    (list
     (face-attribute 'default <span class="ef-b">:background</span>)
     (doom-color 'error)
     (doom-color 'success)
     (doom-color 'type)
     (doom-color 'keywords)
     (doom-color 'constants)
     (doom-color 'functions)
     (face-attribute 'default <span class="ef-b">:foreground</span>)
     (face-attribute 'shadow <span class="ef-b">:foreground</span>)
     (doom-blend 'base8 'error 0.1)
     (doom-blend 'base8 'success 0.1)
     (doom-blend 'base8 'type 0.1)
     (doom-blend 'base8 'keywords 0.1)
     (doom-blend 'base8 'constants 0.1)
     (doom-blend 'base8 'functions 0.1)
     (face-attribute 'default <span class="ef-b">:foreground</span>))))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-theme-magic</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg simple-comment-markup
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-simple-comment-markup"</span> config)
(use-package! simple-comment-markup
  <span class="ef-b">:hook</span> (prog-mode . simple-comment-markup-mode)
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> simple-comment-markup-set '(org markdown-code)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-simple-comment-markup</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Doom modeline
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">doom-modeline-update-pdf-pages</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+single-fullscreen-window-p</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">doom-modeline-conditional-buffer-encoding</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: pkg-doom-modeline"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'doom-modeline
(confpkg-with-record '(<span class="ef-s">"load: pkg-doom-modeline"</span> load-hooks)
(custom-set-faces!
  '(doom-modeline-buffer-modified <span class="ef-b">:foreground</span> <span class="ef-s">"orange"</span>))

(<span class="ef-k">setq</span> doom-modeline-height 45)

(<span class="ef-k">defun</span> <span class="ef-f">doom-modeline-conditional-buffer-encoding</span> ()
  <span class="ef-d">"We expect the encoding to be LF UTF-8, so only show the modeline when this is not the case"</span>
  (<span class="ef-k">setq-local</span> doom-modeline-buffer-encoding
              (<span class="ef-k">unless</span> (<span class="ef-k">and</span> (memq (plist-get (coding-system-plist buffer-file-coding-system) <span class="ef-b">:category</span>)
                                 '(coding-category-undecided coding-category-utf-8))
                           (not (memq (coding-system-eol-type buffer-file-coding-system) '(1 2))))
                t)))

(add-hook 'after-change-major-mode-hook #'doom-modeline-conditional-buffer-encoding)

(<span class="ef-k">setq</span> doom-modeline-time-clock-size 0.65)

(use-package! doom-modeline-media-player
  <span class="ef-b">:defer</span> t
  <span class="ef-b">:init</span>
  (<span class="ef-k">after!</span> doom-modeline
    (add-to-list 'doom-modeline-fn-alist
                 (cons 'media-player #'doom-modeline-segment--media-player)))
  <span class="ef-b">:config</span>
  (<span class="ef-k">defun</span> <span class="ef-f">+single-fullscreen-window-p</span> ()
    (<span class="ef-k">and</span> (memq (frame-parameter nil 'fullscreen) '(fullscreen fullboth))
         (not (consp (car (window-tree))))))
  (<span class="ef-k">setq</span> doom-modeline-media-player #'+single-fullscreen-window-p
        doom-modeline-media-player-playback-indication 'dim))

(doom-modeline-def-segment buffer-name
  <span class="ef-s">"Display the current buffer's name, without any other information."</span>
  (concat
   (doom-modeline-spc)
   (doom-modeline--buffer-name)))

(doom-modeline-def-segment pdf-icon
  <span class="ef-s">"PDF icon from nerd-icons."</span>
  (concat
   (doom-modeline-icon sucicon <span class="ef-s">"nf-seti-pdf"</span> nil nil
   (doom-modeline-spc)
                       <span class="ef-b">:face</span> (<span class="ef-k">if</span> (doom-modeline--active)
                                 'nerd-icons-red
                               'mode-line-inactive)
                       <span class="ef-b">:v-adjust</span> 0.02)))

(<span class="ef-k">defun</span> <span class="ef-f">doom-modeline-update-pdf-pages</span> ()
  <span class="ef-d">"Update PDF pages."</span>
  (<span class="ef-k">setq</span> doom-modeline--pdf-pages
        (<span class="ef-k">let</span> ((current-page-str (number-to-string (eval `(pdf-view-current-page))))
              (total-page-str (number-to-string (pdf-cache-number-of-pages))))
          (concat
           (propertize
            (concat (make-string (- (length total-page-str) (length current-page-str)) ? )
                    <span class="ef-s">" P"</span> current-page-str)
            'face 'mode-line)
           (propertize (concat <span class="ef-s">"/"</span> total-page-str) 'face 'doom-modeline-buffer-minor-mode)))))

(doom-modeline-def-segment pdf-pages
  <span class="ef-s">"Display PDF pages."</span>
  (<span class="ef-k">if</span> (doom-modeline--active) doom-modeline--pdf-pages
    (propertize doom-modeline--pdf-pages 'face 'mode-line-inactive)))

(doom-modeline-def-modeline 'pdf
  '(bar window-number pdf-pages pdf-icon buffer-name)
  '(media-player misc-info matches major-mode process vcs))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-doom-modeline</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Keycast
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-keycast"</span> config)
(use-package! keycast
  <span class="ef-b">:commands</span> keycast-mode
  <span class="ef-b">:config</span>
  (<span class="ef-k">define-minor-mode</span> <span class="ef-f">keycast-mode</span>
    <span class="ef-d">"Show current command and its key binding in the mode line."</span>
    <span class="ef-b">:global</span> t
    (<span class="ef-k">if</span> keycast-mode
        (<span class="ef-k">progn</span>
          (add-hook 'pre-command-hook 'keycast--update t)
          (add-to-list 'global-mode-string '(<span class="ef-s">""</span> mode-line-keycast <span class="ef-s">" "</span>)))
      (remove-hook 'pre-command-hook 'keycast--update)
      (<span class="ef-k">setq</span> global-mode-string (remove '(<span class="ef-s">""</span> mode-line-keycast <span class="ef-s">" "</span>) global-mode-string))))
  (custom-set-faces!
    '(keycast-command <span class="ef-b">:inherit</span> doom-modeline-debug
                      <span class="ef-b">:height</span> 0.9)
    '(keycast-key <span class="ef-b">:inherit</span> custom-modified
                  <span class="ef-b">:height</span> 1.1
                  <span class="ef-b">:weight</span> bold)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-keycast</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Screencast
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">gif-screencast-write-colormap</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-screencast"</span> config)
(use-package! gif-screencast
  <span class="ef-b">:commands</span> gif-screencast-mode
  <span class="ef-b">:config</span>
  (map! <span class="ef-b">:map</span> gif-screencast-mode-map
        <span class="ef-b">:g</span> <span class="ef-s">"&lt;f8&gt;"</span> #'gif-screencast-toggle-pause
        <span class="ef-b">:g</span> <span class="ef-s">"&lt;f9&gt;"</span> #'gif-screencast-stop)
  (<span class="ef-k">setq</span> gif-screencast-program <span class="ef-s">"maim"</span>
        gif-screencast-args `(<span class="ef-s">"--quality"</span> <span class="ef-s">"3"</span> <span class="ef-s">"-i"</span> ,(string-trim-right
                                                     (shell-command-to-string
                                                      <span class="ef-s">"xdotool getactivewindow"</span>)))
        gif-screencast-optimize-args '(<span class="ef-s">"--batch"</span> <span class="ef-s">"--optimize=3"</span> <span class="ef-s">"--usecolormap=/tmp/doom-color-theme"</span>))
  (<span class="ef-k">defun</span> <span class="ef-f">gif-screencast-write-colormap</span> ()
    (write-region
     (replace-regexp-in-string
      <span class="ef-s">"\n+"</span> <span class="ef-s">"\n"</span>
      (mapconcat (<span class="ef-k">lambda</span> (c) (<span class="ef-k">if</span> (listp (cdr c))
                            (cadr c))) <span class="ef-wr">doom-themes--colors </span><span style="color: #986801;">"\n"</span><span class="ef-wr">))</span>
     nil <span class="ef-s">"/tmp/doom-color-theme"</span>))
  (gif-screencast-write-colormap)
  (add-hook 'doom-load-theme-hook #'gif-screencast-write-colormap))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-screencast</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg mixed pitch
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">mixed-pitch-serif-mode</span><span class="ef-c">', `</span><span style="color: #b751b6;">init-mixed-pitch-h</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">and `</span><span style="color: #b751b6;">mixed-pitch-modes</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-mixed-pitch"</span> config)
(<span class="ef-k">defvar</span> <span class="ef-v">mixed-pitch-modes</span> '(org-mode LaTeX-mode markdown-mode gfm-mode Info-mode)
  <span class="ef-d">"Modes that `</span><span style="color: #b751b6; text-decoration: italic;">mixed-pitch-mode</span><span class="ef-d">' should be enabled in, but only after UI initialisation."</span>)
(<span class="ef-k">defun</span> <span class="ef-f">init-mixed-pitch-h</span> ()
  <span class="ef-d">"Hook `</span><span style="color: #b751b6; text-decoration: italic;">mixed-pitch-mode</span><span class="ef-d">' into each mode in `</span><span style="color: #b751b6; text-decoration: italic;">mixed-pitch-modes</span><span class="ef-d">'.
Also immediately enables `</span><span style="color: #b751b6; text-decoration: italic;">mixed-pitch-modes</span><span class="ef-d">' if currently in one of the modes."</span>
  (<span class="ef-k">when</span> (memq major-mode mixed-pitch-modes)
    (mixed-pitch-mode 1))
  (<span class="ef-k">dolist</span> (hook mixed-pitch-modes)
    (add-hook (intern (concat (symbol-name hook) <span class="ef-s">"-hook"</span>)) #'mixed-pitch-mode)))
(add-hook 'doom-init-ui-hook #'init-mixed-pitch-h)

(autoload #'mixed-pitch-serif-mode <span class="ef-s">"mixed-pitch"</span>
  <span class="ef-d">"Change the default face of the current buffer to a serifed variable pitch, while keeping some faces fixed pitch."</span> t)

(<span class="ef-k">setq!</span> variable-pitch-serif-font (font-spec <span class="ef-b">:family</span> <span class="ef-s">"Alegreya"</span> <span class="ef-b">:size</span> 27))

(<span class="ef-k">after!</span> mixed-pitch
  (<span class="ef-k">setq</span> mixed-pitch-set-height t)
  (set-face-attribute 'variable-pitch-serif nil <span class="ef-b">:font</span> variable-pitch-serif-font)
  (<span class="ef-k">defun</span> <span class="ef-f">mixed-pitch-serif-mode</span> (<span class="ef-t">&amp;optional</span> arg)
    <span class="ef-d">"Change the default face of the current buffer to a serifed variable pitch, while keeping some faces fixed pitch."</span>
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">let</span> ((mixed-pitch-face 'variable-pitch-serif))
      (mixed-pitch-mode (<span class="ef-k">or</span> arg 'toggle)))))

(set-char-table-range composition-function-table ?f '([<span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">ff?[fijlt]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> 0 font-shape-gstring]))
(set-char-table-range composition-function-table ?T '([<span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">Th</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> 0 font-shape-gstring]))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-mixed-pitch</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Variable pitch serif font
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">variable-pitch-serif-font</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">variable-pitch-serif</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: variable-pitch-serif-font"</span> config)
(<span class="ef-k">defface</span> <span class="ef-v">variable-pitch-serif</span>
    '((t (<span class="ef-b">:family</span> <span class="ef-s">"serif"</span>)))
    <span class="ef-d">"A variable-pitch face with serifs."</span>
    <span class="ef-b">:group</span> 'basic-faces)

(<span class="ef-k">defcustom</span> <span class="ef-v">variable-pitch-serif-font</span> (font-spec <span class="ef-b">:family</span> <span class="ef-s">"serif"</span>)
  <span class="ef-d">"The font face used for `</span><span style="color: #b751b6; text-decoration: italic;">variable-pitch-serif</span><span class="ef-d">'."</span>
  <span class="ef-b">:group</span> 'basic-faces
  <span class="ef-b">:type</span> '(restricted-sexp <span class="ef-b">:tag</span> <span class="ef-s">"font-spec"</span> <span class="ef-b">:match-alternatives</span> (fontp))
  <span class="ef-b">:set</span> (<span class="ef-k">lambda</span> (symbol value)
         (set-face-attribute 'variable-pitch-serif nil <span class="ef-b">:font</span> value)
         (set-default-toplevel-value symbol value)))

(<span class="ef-k">provide</span> '<span class="ef-o">config-variable-pitch-serif-font</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Marginalia
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+marginalia-file-size-colorful</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+marginalia--time-colorful</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-marginalia"</span> config)
(<span class="ef-k">after!</span> marginalia
  (<span class="ef-k">setq</span> marginalia-censor-variables nil)

  (<span class="ef-k">defadvice!</span> +marginalia--anotate-local-file-colorful (cand)
    <span class="ef-d">"Just a more colourful version of `</span><span style="color: #b751b6; text-decoration: italic;">marginalia--anotate-local-file</span><span class="ef-d">'."</span>
    <span class="ef-b">:override</span> #'marginalia--annotate-local-file
    (<span class="ef-k">when-let</span> (attrs (file-attributes (substitute-in-file-name
                                       (marginalia--full-candidate cand))
                                      'integer))
      (marginalia--fields
       ((marginalia--file-owner attrs)
        <span class="ef-b">:width</span> 12 <span class="ef-b">:face</span> 'marginalia-file-owner)
       ((marginalia--file-modes attrs))
       ((+marginalia-file-size-colorful (file-attribute-size attrs))
        <span class="ef-b">:width</span> 7)
       ((+marginalia--time-colorful (file-attribute-modification-time attrs))
        <span class="ef-b">:width</span> 12))))

  (<span class="ef-k">defun</span> <span class="ef-f">+marginalia--time-colorful</span> (time)
    (<span class="ef-k">let*</span> ((seconds (float-time (time-subtract (current-time) time)))
           (color (doom-blend
                   (face-attribute 'marginalia-date <span class="ef-b">:foreground</span> nil t)
                   (face-attribute 'marginalia-documentation <span class="ef-b">:foreground</span> nil t)
                   (/ 1.0 (log (+ 3 (/ (+ 1 seconds) 345600.0)))))))
      <span class="ef-cd">;; </span><span class="ef-c">1 - log(3 + 1/(days + 1)) % grey
</span>      (propertize (marginalia--time time) 'face (list <span class="ef-b">:foreground</span> color))))

  (<span class="ef-k">defun</span> <span class="ef-f">+marginalia-file-size-colorful</span> (size)
    (<span class="ef-k">let*</span> ((size-index (/ (log (+ 1 size)) 7.0))
           (color (<span class="ef-k">if</span> (&lt; size-index 10000000) <span class="ef-cd">; </span><span class="ef-c">10m
</span>                      (doom-blend 'orange 'green size-index)
                    (doom-blend 'red 'orange (- size-index 1)))))
      (propertize (file-size-human-readable size) 'face (list <span class="ef-b">:foreground</span> color)))))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-marginalia</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Centaur Tabs
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-centaur-tabs"</span> config)
(<span class="ef-k">after!</span> centaur-tabs
  (centaur-tabs-mode -1)
  (<span class="ef-k">setq</span> centaur-tabs-height 36
        centaur-tabs-set-icons t
        centaur-tabs-modified-marker <span class="ef-s">"o"</span>
        centaur-tabs-close-button <span class="ef-s">"Ã"</span>
        centaur-tabs-set-bar 'above
        centaur-tabs-gray-out-icons 'buffer)
  (centaur-tabs-change-fonts <span class="ef-s">"P22 Underground Book"</span> 160))
<span class="ef-cd">;; </span><span class="ef-c">(setq x-underline-at-descent-line t)
</span>
(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-centaur-tabs</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Nerd Icons
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-nerd-icons"</span> config)
(<span class="ef-k">after!</span> nerd-icons
  (<span class="ef-k">when-let</span> ((matlab-icon (assoc <span class="ef-s">"matlab"</span> nerd-icons-extension-icon-alist)))
    (setcdr (assoc <span class="ef-s">"m"</span> nerd-icons-extension-icon-alist)
            (cdr matlab-icon))))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-nerd-icons</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg page break lines
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+evil-backward-page</span><span class="ef-c">' and `</span><span style="color: #b751b6;">+evil-forward-page</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-page-break-lines"</span> config)
(use-package! page-break-lines
  <span class="ef-b">:hook</span> (prog-mode . page-break-lines-mode)
  <span class="ef-b">:init</span>
  (autoload 'turn-on-page-break-lines-mode <span class="ef-s">"page-break-lines"</span>)
  <span class="ef-b">:config</span>
  (<span class="ef-k">defvaralias</span> '<span class="ef-v">page-break-lines-max-width</span> 'fill-column)
  (<span class="ef-k">defun</span> <span class="ef-f">+evil-forward-page</span> ()
    <span class="ef-d">"Call `</span><span style="color: #b751b6; text-decoration: italic;">forward-page</span><span class="ef-d">', such that it works as intended with evil-mode."</span>
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">when</span> (eq (char-after (point)) ?\^L)
      (forward-char 1))
    (forward-page))
  (<span class="ef-k">defun</span> <span class="ef-f">+evil-backward-page</span> ()
    <span class="ef-d">"Call `</span><span style="color: #b751b6; text-decoration: italic;">backward-page</span><span class="ef-d">', such that it works as intended with evil-mode."</span>
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">when</span> (eq (char-after (point)) ?\^L)
      (backward-char 1))
    (backward-page))
  (map! <span class="ef-b">:prefix</span> <span class="ef-s">"g"</span>
        <span class="ef-b">:desc</span> <span class="ef-s">"Prev page break"</span> <span class="ef-b">:nv</span> <span class="ef-s">"["</span> #'+evil-backward-page
        <span class="ef-b">:desc</span> <span class="ef-s">"Next page break"</span> <span class="ef-b">:nv</span> <span class="ef-s">"]"</span> #'+evil-forward-page)
  (map! <span class="ef-s">"&lt;C-M-prior&gt;"</span> #'+evil-backward-page
        <span class="ef-s">"&lt;C-M-next&gt;"</span> #'+evil-forward-page))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-page-break-lines</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Writeroom
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+zen-nonprose-org-h</span><span class="ef-c">', `</span><span style="color: #b751b6;">+zen-prose-org-h</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+zen-enable-mixed-pitch-mode-h</span><span class="ef-c">', `</span><span style="color: #b751b6;">+zen-org-starhide</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+zen-serif-p</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: writeroom"</span> config)
(<span class="ef-k">setq</span> +zen-text-scale 0.8)

(<span class="ef-k">defvar</span> <span class="ef-v">+zen-serif-p</span> t
  <span class="ef-d">"Whether to use a serifed font with `</span><span style="color: #b751b6; text-decoration: italic;">mixed-pitch-mode</span><span class="ef-d">'."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">+zen-org-starhide</span> t
  <span class="ef-d">"The value `</span><span style="color: #b751b6; text-decoration: italic;">org-modern-hide-stars</span><span class="ef-d">' is set to."</span>)

(<span class="ef-k">after!</span> writeroom-mode
  (<span class="ef-k">defvar-local</span> <span class="ef-v">+zen--original-org-indent-mode-p</span> nil)
  (<span class="ef-k">defvar-local</span> <span class="ef-v">+zen--original-mixed-pitch-mode-p</span> nil)
  (<span class="ef-k">defun</span> <span class="ef-f">+zen-enable-mixed-pitch-mode-h</span> ()
    <span class="ef-d">"Enable `</span><span style="color: #b751b6; text-decoration: italic;">mixed-pitch-mode</span><span class="ef-d">' when in `</span><span style="color: #b751b6; text-decoration: italic;">+zen-mixed-pitch-modes</span><span class="ef-d">'."</span>
    (<span class="ef-k">when</span> (apply #'derived-mode-p +zen-mixed-pitch-modes)
      (<span class="ef-k">if</span> writeroom-mode
          (<span class="ef-k">progn</span>
            (<span class="ef-k">setq</span> +zen--original-mixed-pitch-mode-p mixed-pitch-mode)
            (funcall (<span class="ef-k">if</span> +zen-serif-p #'mixed-pitch-serif-mode #'mixed-pitch-mode) 1))
        (funcall #'mixed-pitch-mode (<span class="ef-k">if</span> +zen--original-mixed-pitch-mode-p 1 -1)))))
  (<span class="ef-k">defun</span> <span class="ef-f">+zen-prose-org-h</span> ()
    <span class="ef-d">"Reformat the current Org buffer appearance for prose."</span>
    (<span class="ef-k">when</span> (eq major-mode 'org-mode)
      (<span class="ef-k">setq</span> display-line-numbers nil
            visual-fill-column-width 60
            org-adapt-indentation nil)
      (<span class="ef-k">when</span> (<span class="ef-k">featurep</span> '<span class="ef-o">org-modern</span>)
        (<span class="ef-k">setq-local</span> org-modern-star '(<span class="ef-s">"ð"</span> <span class="ef-s">"ð"</span> <span class="ef-s">"ð"</span> <span class="ef-s">"ð"</span>)
                    <span class="ef-cd">;; </span><span class="ef-c">org-modern-star '("ð" "ð" "ð" "ð" "ð" "ð" "ð" "ð")
</span>                    org-modern-hide-stars +zen-org-starhide)
        (org-modern-mode -1)
        (org-modern-mode 1))
      (<span class="ef-k">setq</span>
       +zen--original-org-indent-mode-p org-indent-mode)
      (org-indent-mode -1)))
  (<span class="ef-k">defun</span> <span class="ef-f">+zen-nonprose-org-h</span> ()
    <span class="ef-d">"Reverse the effect of `</span><span style="color: #b751b6; text-decoration: italic;">+zen-prose-org</span><span class="ef-d">'."</span>
    (<span class="ef-k">when</span> (eq major-mode 'org-mode)
      (<span class="ef-k">when</span> (<span class="ef-k">bound-and-true-p</span> org-modern-mode)
        (org-modern-mode -1)
        (org-modern-mode 1))
      (<span class="ef-k">when</span> +zen--original-org-indent-mode-p (org-indent-mode 1))))
  (<span class="ef-k">pushnew!</span> writeroom--local-variables
            'display-line-numbers
            'visual-fill-column-width
            'org-adapt-indentation
            'org-modern-mode
            'org-modern-star
            'org-modern-hide-stars)
  (add-hook 'writeroom-mode-enable-hook #'+zen-prose-org-h)
  (add-hook 'writeroom-mode-disable-hook #'+zen-nonprose-org-h))

(<span class="ef-k">provide</span> '<span class="ef-o">config-writeroom</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg treemacs
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">treemacs-ignore-filter</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">treemacs-file-ignore-generate-regexps</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">treemacs-file-ignore-regexps</span><span class="ef-c">', `</span><span style="color: #b751b6;">treemacs-file-ignore-globs</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">treemacs-file-ignore-extensions</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-treemacs"</span> config)
(<span class="ef-k">after!</span> treemacs
  (<span class="ef-k">defvar</span> <span class="ef-v">treemacs-file-ignore-extensions</span> '()
    <span class="ef-d">"File extension which `</span><span style="color: #b751b6; text-decoration: italic;">treemacs-ignore-filter</span><span class="ef-d">' will ensure are ignored"</span>)
  (<span class="ef-k">defvar</span> <span class="ef-v">treemacs-file-ignore-globs</span> '()
    <span class="ef-d">"Globs which will are transformed to `</span><span style="color: #b751b6; text-decoration: italic;">treemacs-file-ignore-regexps</span><span class="ef-d">' which `</span><span style="color: #b751b6; text-decoration: italic;">treemacs-ignore-filter</span><span class="ef-d">' will ensure are ignored"</span>)
  (<span class="ef-k">defvar</span> <span class="ef-v">treemacs-file-ignore-regexps</span> '()
    <span class="ef-d">"RegExps to be tested to ignore files, generated from `</span><span style="color: #b751b6; text-decoration: italic;">treeemacs-file-ignore-globs</span><span class="ef-d">'"</span>)
  (<span class="ef-k">defun</span> <span class="ef-f">treemacs-file-ignore-generate-regexps</span> ()
    <span class="ef-d">"Generate `</span><span style="color: #b751b6; text-decoration: italic;">treemacs-file-ignore-regexps</span><span class="ef-d">' from `</span><span style="color: #b751b6; text-decoration: italic;">treemacs-file-ignore-globs</span><span class="ef-d">'"</span>
    (<span class="ef-k">setq</span> treemacs-file-ignore-regexps (mapcar 'dired-glob-regexp treemacs-file-ignore-globs)))
  (<span class="ef-k">if</span> (equal treemacs-file-ignore-globs '()) nil (treemacs-file-ignore-generate-regexps))
  (<span class="ef-k">defun</span> <span class="ef-f">treemacs-ignore-filter</span> (file full-path)
    <span class="ef-d">"Ignore files specified by `</span><span style="color: #b751b6; text-decoration: italic;">treemacs-file-ignore-extensions</span><span class="ef-d">', and `</span><span style="color: #b751b6; text-decoration: italic;">treemacs-file-ignore-regexps</span><span class="ef-d">'"</span>
    (<span class="ef-k">or</span> (member (file-name-extension file) treemacs-file-ignore-extensions)
        (<span class="ef-k">let</span> ((ignore-file nil))
          (<span class="ef-k">dolist</span> (regexp treemacs-file-ignore-regexps ignore-file)
            (<span class="ef-k">setq</span> ignore-file (<span class="ef-k">or</span> ignore-file (<span class="ef-k">if</span> (string-match-p regexp full-path) t nil)))))))
  (add-to-list 'treemacs-ignored-file-predicates #'treemacs-ignore-filter))

(<span class="ef-k">setq</span> treemacs-file-ignore-extensions
      '(<span class="ef-cd">;; </span><span class="ef-c">LaTeX
</span>        <span class="ef-s">"aux"</span>
        <span class="ef-s">"ptc"</span>
        <span class="ef-s">"fdb_latexmk"</span>
        <span class="ef-s">"fls"</span>
        <span class="ef-s">"synctex.gz"</span>
        <span class="ef-s">"toc"</span>
        <span class="ef-cd">;; </span><span class="ef-c">LaTeX - glossary
</span>        <span class="ef-s">"glg"</span>
        <span class="ef-s">"glo"</span>
        <span class="ef-s">"gls"</span>
        <span class="ef-s">"glsdefs"</span>
        <span class="ef-s">"ist"</span>
        <span class="ef-s">"acn"</span>
        <span class="ef-s">"acr"</span>
        <span class="ef-s">"alg"</span>
        <span class="ef-cd">;; </span><span class="ef-c">LaTeX - pgfplots
</span>        <span class="ef-s">"mw"</span>
        <span class="ef-cd">;; </span><span class="ef-c">LaTeX - pdfx
</span>        <span class="ef-s">"pdfa.xmpi"</span>
        ))
(<span class="ef-k">setq</span> treemacs-file-ignore-globs
      '(<span class="ef-cd">;; </span><span class="ef-c">LaTeX
</span>        <span class="ef-s">"*/_minted-*"</span>
        <span class="ef-cd">;; </span><span class="ef-c">AucTeX
</span>        <span class="ef-s">"*/.auctex-auto"</span>
        <span class="ef-s">"*/_region_.log"</span>
        <span class="ef-s">"*/_region_.tex"</span>))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-treemacs</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg visual-fill-column
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+visual-fill-column--set-margins--fixed</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+visual-fill-column--window-max-text-width--fixed</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: pkg-visual-fill-column"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'visual-fill-column
(confpkg-with-record '(<span class="ef-s">"load: pkg-visual-fill-column"</span> load-hooks)
(<span class="ef-k">defun</span> <span class="ef-f">+visual-fill-column--window-max-text-width--fixed</span> (<span class="ef-t">&amp;optional</span> window)
  <span class="ef-d">"Return the maximum possible text width of WINDOW.
The maximum possible text width is the width of the current text
area plus the margins, but excluding the fringes, scroll bar, and
right divider.  WINDOW defaults to the selected window.  The
return value is scaled to account for `</span><span style="color: #b751b6; text-decoration: italic;">text-scale-mode-amount</span><span class="ef-d">'
and `</span><span style="color: #b751b6; text-decoration: italic;">text-scale-mode-step</span><span class="ef-d">'."</span>
  (<span class="ef-k">or</span> window (<span class="ef-k">setq</span> window (selected-window)))
  (<span class="ef-k">let*</span> ((margins (window-margins window))
         (buffer (window-buffer window))
         (scale (<span class="ef-k">if</span> (<span class="ef-k">and</span> visual-fill-column-adjust-for-text-scale
                         (boundp 'text-scale-mode-step)
                         (boundp 'text-scale-mode-amount))
                    (<span class="ef-k">with-current-buffer</span> buffer
                      (expt text-scale-mode-step
                            text-scale-mode-amount))
                  1.0))
         (remap-scale
          (<span class="ef-k">if</span> (&gt;= emacs-major-version 29)
              (/ (window-width window 'remap) (float (window-width window)))
            1.0)))
    (truncate (/ (+ (window-width window (<span class="ef-k">and</span> (&gt;= emacs-major-version 29) 'remap))
                    (* (<span class="ef-k">or</span> (car margins) 0) remap-scale)
                    (* (<span class="ef-k">or</span> (cdr margins) 0) remap-scale))
                 (float scale)))))

(advice-add 'visual-fill-column--window-max-text-width
            <span class="ef-b">:override</span> #'+visual-fill-column--window-max-text-width--fixed)

(<span class="ef-k">defun</span> <span class="ef-f">+visual-fill-column--set-margins--fixed</span> (window)
  <span class="ef-d">"Set window margins for WINDOW."</span>
  <span class="ef-cd">;; </span><span class="ef-c">Calculate left &amp; right margins.
</span>  (<span class="ef-k">let*</span> ((total-width (visual-fill-column--window-max-text-width window))
         (remap-scale
          (<span class="ef-k">if</span> (&gt;= emacs-major-version 29)
              (/ (window-width window 'remap) (float (window-width window)))
            1.0))
         (width (<span class="ef-k">or</span> visual-fill-column-width
                    fill-column))
         (margins (<span class="ef-k">if</span> (&lt; (- total-width width) 0) <span class="ef-cd">; </span><span class="ef-c">margins must be &gt;= 0
</span>                      0
                    (round (/ (- total-width width) remap-scale))))
         (left (<span class="ef-k">if</span> visual-fill-column-center-text
                   (/ margins 2)
                 0))
         (right (- margins left)))

    (<span class="ef-k">if</span> visual-fill-column-extra-text-width
        (<span class="ef-k">let</span> ((add-width (visual-fill-column--add-extra-width left right visual-fill-column-extra-text-width)))
          (<span class="ef-k">setq</span> left (car add-width)
                right (cdr add-width))))

    <span class="ef-cd">;; </span><span class="ef-c">put an explicitly R2L buffer on the right side of the window
</span>    (<span class="ef-k">when</span> (<span class="ef-k">and</span> (eq bidi-paragraph-direction 'right-to-left)
               (= left 0))
      (<span class="ef-k">setq</span> left right)
      (<span class="ef-k">setq</span> right 0))

    (set-window-margins window left right)))

(advice-add 'visual-fill-column--set-margins
            <span class="ef-b">:override</span> #'+visual-fill-column--set-margins--fixed)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-visual-fill-column</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">XKCD
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+xkcd-db-write</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-db-list-to-plist</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+xkcd-db-read-all</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-db-read</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-db-query</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-db</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+xkcd-db--init</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-db--get-connection</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-db--get</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+xkcd-db--connection</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-stored-info</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-check-latest</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+xkcd-latest-max-age</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-find-and-view</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-copy</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+xkcd-find-and-copy</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-fetch-info</span><span class="ef-c">', `</span><span style="color: #b751b6;">+xkcd-select-format</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">and `</span><span style="color: #b751b6;">+xkcd-select</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: xkcd"</span> config)
(use-package! xkcd
  <span class="ef-b">:commands</span> (xkcd-get-json
             xkcd-download xkcd-get
             <span class="ef-cd">;; </span><span class="ef-c">now for funcs from my extension of this pkg
</span>             +xkcd-find-and-copy +xkcd-find-and-view
             +xkcd-fetch-info +xkcd-select)
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> xkcd-cache-dir (expand-file-name <span class="ef-s">"xkcd/"</span> doom-cache-dir)
        xkcd-cache-latest (concat xkcd-cache-dir <span class="ef-s">"latest"</span>))
  (<span class="ef-k">unless</span> (file-exists-p xkcd-cache-dir)
    (make-directory xkcd-cache-dir))
  (<span class="ef-k">after!</span> evil-snipe
    (add-to-list 'evil-snipe-disabled-modes 'xkcd-mode))
  <span class="ef-b">:general</span> (<span class="ef-b">:states</span> 'normal
            <span class="ef-b">:keymaps</span> 'xkcd-mode-map
            <span class="ef-s">"&lt;right&gt;"</span> #'xkcd-next
            <span class="ef-s">"n"</span>       #'xkcd-next <span class="ef-cd">; </span><span class="ef-c">evil-ish
</span>            <span class="ef-s">"&lt;left&gt;"</span>  #'xkcd-prev
            <span class="ef-s">"N"</span>       #'xkcd-prev <span class="ef-cd">; </span><span class="ef-c">evil-ish
</span>            <span class="ef-s">"r"</span>       #'xkcd-rand
            <span class="ef-s">"a"</span>       #'xkcd-rand <span class="ef-cd">; </span><span class="ef-c">because image-rotate can interfere
</span>            <span class="ef-s">"t"</span>       #'xkcd-alt-text
            <span class="ef-s">"q"</span>       #'xkcd-kill-buffer
            <span class="ef-s">"o"</span>       #'xkcd-open-browser
            <span class="ef-s">"e"</span>       #'xkcd-open-explanation-browser
            <span class="ef-cd">;; </span><span class="ef-c">extras
</span>            <span class="ef-s">"s"</span>       #'+xkcd-find-and-view
            <span class="ef-s">"/"</span>       #'+xkcd-find-and-view
            <span class="ef-s">"y"</span>       #'+xkcd-copy))

(<span class="ef-k">after!</span> xkcd
  (<span class="ef-k">require</span> '<span class="ef-o">emacsql-sqlite</span>)

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-select</span> ()
    <span class="ef-d">"Prompt the user for an xkcd using `</span><span style="color: #b751b6; text-decoration: italic;">completing-read</span><span class="ef-d">' and `</span><span style="color: #b751b6; text-decoration: italic;">+xkcd-select-format</span><span class="ef-d">'. Return the xkcd number or nil"</span>
    (<span class="ef-k">let*</span> (prompt-lines
           (-dummy (maphash (<span class="ef-k">lambda</span> (key xkcd-info)
                              (<span class="ef-k">push</span> (+xkcd-select-format xkcd-info) prompt-lines))
                            +xkcd-stored-info))
           (num (completing-read (format <span class="ef-s">"xkcd (%s): "</span> xkcd-latest) prompt-lines)))
      (<span class="ef-k">if</span> (equal <span class="ef-s">""</span> num) xkcd-latest
        (string-to-number (replace-regexp-in-string <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[0-9]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">.*"</span> <span class="ef-s">"\\1"</span> num)))))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-select-format</span> (xkcd-info)
    <span class="ef-d">"Creates each completing-read line from an xkcd info plist. Must start with the xkcd number"</span>
    (format <span class="ef-s">"%-4s  %-30s %s"</span>
            (propertize (number-to-string (plist-get xkcd-info <span class="ef-b">:num</span>))
                        'face 'counsel-key-binding)
            (plist-get xkcd-info <span class="ef-b">:title</span>)
            (propertize (plist-get xkcd-info <span class="ef-b">:alt</span>)
                        'face '(variable-pitch font-lock-comment-face))))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-fetch-info</span> (<span class="ef-t">&amp;optional</span> num)
    <span class="ef-d">"Fetch the parsed json info for comic NUM. Fetches latest when omitted or 0"</span>
    (<span class="ef-k">require</span> '<span class="ef-o">xkcd</span>)
    (<span class="ef-k">when</span> (<span class="ef-k">or</span> (not num) (= num 0))
      (+xkcd-check-latest)
      (<span class="ef-k">setq</span> num xkcd-latest))
    (<span class="ef-k">let</span> ((res (<span class="ef-k">or</span> (gethash num +xkcd-stored-info)
                   (puthash num (+xkcd-db-read num) +xkcd-stored-info))))
      (<span class="ef-k">unless</span> res
        (+xkcd-db-write
         (<span class="ef-k">let*</span> ((url (format <span class="ef-s">"https://xkcd.com/%d/info.0.json"</span> num))
                (json-assoc
                 (<span class="ef-k">if</span> (gethash num +xkcd-stored-info)
                     (gethash num +xkcd-stored-info)
                   (json-read-from-string (xkcd-get-json url num)))))
           json-assoc))
        (<span class="ef-k">setq</span> res (+xkcd-db-read num)))
      res))

  <span class="ef-cd">;; </span><span class="ef-c">since we've done this, we may as well go one little step further
</span>  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-find-and-copy</span> ()
    <span class="ef-d">"Prompt for an xkcd using `</span><span style="color: #b751b6; text-decoration: italic;">+xkcd-select</span><span class="ef-d">' and copy url to clipboard"</span>
    (<span class="ef-k">interactive</span>)
    (+xkcd-copy (+xkcd-select)))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-copy</span> (<span class="ef-t">&amp;optional</span> num)
    <span class="ef-d">"Copy a url to xkcd NUM to the clipboard"</span>
    (<span class="ef-k">interactive</span> <span class="ef-s">"i"</span>)
    (<span class="ef-k">let</span> ((num (<span class="ef-k">or</span> num xkcd-cur)))
      (gui-select-text (format <span class="ef-s">"https://xkcd.com/%d"</span> num))
      (message <span class="ef-s">"xkcd.com/%d copied to clipboard"</span> num)))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-find-and-view</span> ()
    <span class="ef-d">"Prompt for an xkcd using `</span><span style="color: #b751b6; text-decoration: italic;">+xkcd-select</span><span class="ef-d">' and view it"</span>
    (<span class="ef-k">interactive</span>)
    (xkcd-get (+xkcd-select))
    (switch-to-buffer <span class="ef-s">"*xkcd*"</span>))

  (<span class="ef-k">defvar</span> <span class="ef-v">+xkcd-latest-max-age</span> (* 60 60) <span class="ef-cd">; </span><span class="ef-c">1 hour
</span>    <span class="ef-d">"Time after which xkcd-latest should be refreshed, in seconds"</span>)

  <span class="ef-cd">;; </span><span class="ef-c">initialise `</span><span style="color: #b751b6;">xkcd-latest</span><span class="ef-c">' and `</span><span style="color: #b751b6;">+xkcd-stored-info</span><span class="ef-c">' with latest xkcd
</span>  (<span class="ef-k">add-transient-hook!</span> '+xkcd-select
    (<span class="ef-k">require</span> '<span class="ef-o">xkcd</span>)
    (+xkcd-fetch-info xkcd-latest)
    (<span class="ef-k">setq</span> +xkcd-stored-info (+xkcd-db-read-all)))

  (<span class="ef-k">add-transient-hook!</span> '+xkcd-fetch-info
    (xkcd-update-latest))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-check-latest</span> ()
    <span class="ef-d">"Use value in `</span><span style="color: #b751b6; text-decoration: italic;">xkcd-cache-latest</span><span class="ef-d">' as long as it isn't older thabn `</span><span style="color: #b751b6; text-decoration: italic;">+xkcd-latest-max-age</span><span class="ef-d">'"</span>
    (<span class="ef-k">unless</span> (<span class="ef-k">and</span> (file-exists-p xkcd-cache-latest)
                 (&lt; (- (time-to-seconds (current-time))
                       (time-to-seconds (file-attribute-modification-time (file-attributes xkcd-cache-latest))))
                    +xkcd-latest-max-age))
      (<span class="ef-k">let*</span> ((out (xkcd-get-json <span class="ef-s">"http://xkcd.com/info.0.json"</span> 0))
             (json-assoc (json-read-from-string out))
             (latest (cdr (assoc 'num json-assoc))))
        (<span class="ef-k">when</span> (/= xkcd-latest latest)
          (+xkcd-db-write json-assoc)
          (<span class="ef-k">with-current-buffer</span> (find-file xkcd-cache-latest)
            (<span class="ef-k">setq</span> xkcd-latest latest)
            (erase-buffer)
            (insert (number-to-string latest))
            (save-buffer)
            (kill-buffer (current-buffer)))))
      (shell-command (format <span class="ef-s">"touch %s"</span> xkcd-cache-latest))))

  (<span class="ef-k">defvar</span> <span class="ef-v">+xkcd-stored-info</span> (make-hash-table <span class="ef-b">:test</span> 'eql)
    <span class="ef-d">"Basic info on downloaded xkcds, in the form of a hashtable"</span>)

  (<span class="ef-k">defadvice!</span> xkcd-get-json--and-cache (url <span class="ef-t">&amp;optional</span> num)
    <span class="ef-d">"Fetch the Json coming from URL.
If the file NUM.json exists, use it instead.
If NUM is 0, always download from URL.
The return value is a string."</span>
    <span class="ef-b">:override</span> #'xkcd-get-json
    (<span class="ef-k">let*</span> ((file (format <span class="ef-s">"%s%d.json"</span> xkcd-cache-dir num))
           (cached (<span class="ef-k">and</span> (file-exists-p file) (not (eq num 0))))
           (out (<span class="ef-k">with-current-buffer</span> (<span class="ef-k">if</span> cached
                                         (find-file file)
                                       (url-retrieve-synchronously url))
                  (goto-char (point-min))
                  (<span class="ef-k">unless</span> cached (re-search-forward <span class="ef-s">"^$"</span>))
                  (<span class="ef-k">prog1</span>
                      (buffer-substring-no-properties (point) (point-max))
                    (kill-buffer (current-buffer))))))
      (<span class="ef-k">unless</span> (<span class="ef-k">or</span> cached (eq num 0))
        (xkcd-cache-json num out))
      out))

  (<span class="ef-k">defadvice!</span> +xkcd-get (num)
    <span class="ef-d">"Get the xkcd number NUM."</span>
    <span class="ef-b">:override</span> 'xkcd-get
    (<span class="ef-k">interactive</span> <span class="ef-s">"nEnter comic number: "</span>)
    (xkcd-update-latest)
    (get-buffer-create <span class="ef-s">"*xkcd*"</span>)
    (switch-to-buffer <span class="ef-s">"*xkcd*"</span>)
    (xkcd-mode)
    (<span class="ef-k">let</span> (buffer-read-only)
      (erase-buffer)
      (<span class="ef-k">setq</span> xkcd-cur num)
      (<span class="ef-k">let*</span> ((xkcd-data (+xkcd-fetch-info num))
             (num (plist-get xkcd-data <span class="ef-b">:num</span>))
             (img (plist-get xkcd-data <span class="ef-b">:img</span>))
             (safe-title (plist-get xkcd-data <span class="ef-b">:safe-title</span>))
             (alt (plist-get xkcd-data <span class="ef-b">:alt</span>))
             title file)
        (message <span class="ef-s">"Getting comic..."</span>)
        (<span class="ef-k">setq</span> file (xkcd-download img num))
        (<span class="ef-k">setq</span> title (format <span class="ef-s">"%d: %s"</span> num safe-title))
        (insert (propertize title
                            'face 'outline-1))
        (center-line)
        (insert <span class="ef-s">"\n"</span>)
        (xkcd-insert-image file num)
        (<span class="ef-k">if</span> (eq xkcd-cur 0)
            (<span class="ef-k">setq</span> xkcd-cur num))
        (<span class="ef-k">setq</span> xkcd-alt alt)
        (message <span class="ef-s">"%s"</span> title))))

  (<span class="ef-k">defconst</span> <span class="ef-v">+xkcd-db--sqlite-available-p</span>
    (<span class="ef-k">with-demoted-errors</span> <span class="ef-s">"+org-xkcd initialization: %S"</span>
      (emacsql-sqlite-ensure-binary)
      t))

  (<span class="ef-k">defvar</span> <span class="ef-v">+xkcd-db--connection</span> (make-hash-table <span class="ef-b">:test</span> #'equal)
    <span class="ef-d">"Database connection to +org-xkcd database."</span>)

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db--get</span> ()
    <span class="ef-d">"Return the sqlite db file."</span>
    (expand-file-name <span class="ef-s">"xkcd.db"</span> xkcd-cache-dir))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db--get-connection</span> ()
    <span class="ef-d">"Return the database connection, if any."</span>
    (gethash (file-truename xkcd-cache-dir)
             +xkcd-db--connection))

  (<span class="ef-k">defconst</span> <span class="ef-v">+xkcd-db--table-schema</span>
    '((xkcds
       [(num integer <span class="ef-b">:unique</span> <span class="ef-b">:primary-key</span>)
        (year        <span class="ef-b">:not-null</span>)
        (month       <span class="ef-b">:not-null</span>)
        (link        <span class="ef-b">:not-null</span>)
        (news        <span class="ef-b">:not-null</span>)
        (safe_title  <span class="ef-b">:not-null</span>)
        (title       <span class="ef-b">:not-null</span>)
        (transcript  <span class="ef-b">:not-null</span>)
        (alt         <span class="ef-b">:not-null</span>)
        (img         <span class="ef-b">:not-null</span>)])))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db--init</span> (db)
    <span class="ef-d">"Initialize database DB with the correct schema and user version."</span>
    (emacsql-with-transaction db
      (<span class="ef-k">pcase-dolist</span> (`(,table . ,schema) +xkcd-db--table-schema)
        (emacsql db [<span class="ef-b">:create-table</span> $i1 $S2] table schema))))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db</span> ()
    <span class="ef-d">"Entrypoint to the +org-xkcd sqlite database.
Initializes and stores the database, and the database connection.
Performs a database upgrade when required."</span>
    (<span class="ef-k">unless</span> (<span class="ef-k">and</span> (+xkcd-db--get-connection)
                 (emacsql-live-p (+xkcd-db--get-connection)))
      (<span class="ef-k">let*</span> ((db-file (+xkcd-db--get))
             (init-db (not (file-exists-p db-file))))
        (make-directory (file-name-directory db-file) t)
        (<span class="ef-k">let</span> ((conn (emacsql-sqlite db-file)))
          (set-process-query-on-exit-flag (emacsql-process conn) nil)
          (puthash (file-truename xkcd-cache-dir)
                   conn
                   +xkcd-db--connection)
          (<span class="ef-k">when</span> init-db
            (+xkcd-db--init conn)))))
    (+xkcd-db--get-connection))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db-query</span> (sql <span class="ef-t">&amp;rest</span> args)
    <span class="ef-d">"Run SQL query on +org-xkcd database with ARGS.
SQL can be either the emacsql vector representation, or a string."</span>
    (<span class="ef-k">if</span>  (stringp sql)
        (emacsql (+xkcd-db) (apply #'format sql args))
      (apply #'emacsql (+xkcd-db) sql args)))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db-read</span> (num)
    (<span class="ef-k">when-let</span> ((res
                (car (+xkcd-db-query [<span class="ef-b">:select</span> * <span class="ef-b">:from</span> xkcds
                                      <span class="ef-b">:where</span> (= num $s1)]
                                     num
                                     <span class="ef-b">:limit</span> 1))))
      (+xkcd-db-list-to-plist res)))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db-read-all</span> ()
    (<span class="ef-k">let</span> ((xkcd-table (make-hash-table <span class="ef-b">:test</span> 'eql <span class="ef-b">:size</span> 4000)))
      (mapcar (<span class="ef-k">lambda</span> (xkcd-info-list)
                (puthash (car xkcd-info-list) (+xkcd-db-list-to-plist xkcd-info-list) xkcd-table))
              (+xkcd-db-query [<span class="ef-b">:select</span> * <span class="ef-b">:from</span> xkcds]))
      xkcd-table))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db-list-to-plist</span> (xkcd-datalist)
    `(<span class="ef-b">:num</span> ,(nth 0 xkcd-datalist)
      <span class="ef-b">:year</span> ,(nth 1 xkcd-datalist)
      <span class="ef-b">:month</span> ,(nth 2 xkcd-datalist)
      <span class="ef-b">:link</span> ,(nth 3 xkcd-datalist)
      <span class="ef-b">:news</span> ,(nth 4 xkcd-datalist)
      <span class="ef-b">:safe-title</span> ,(nth 5 xkcd-datalist)
      <span class="ef-b">:title</span> ,(nth 6 xkcd-datalist)
      <span class="ef-b">:transcript</span> ,(nth 7 xkcd-datalist)
      <span class="ef-b">:alt</span> ,(nth 8 xkcd-datalist)
      <span class="ef-b">:img</span> ,(nth 9 xkcd-datalist)))

  (<span class="ef-k">defun</span> <span class="ef-f">+xkcd-db-write</span> (data)
    (+xkcd-db-query [<span class="ef-b">:insert-into</span> xkcds
                     <span class="ef-b">:values</span> $v1]
                    (list (vector
                           (cdr (assoc 'num        data))
                           (cdr (assoc 'year       data))
                           (cdr (assoc 'month      data))
                           (cdr (assoc 'link       data))
                           (cdr (assoc 'news       data))
                           (cdr (assoc 'safe_title data))
                           (cdr (assoc 'title      data))
                           (cdr (assoc 'transcript data))
                           (cdr (assoc 'alt        data))
                           (cdr (assoc 'img        data))
                           )))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-xkcd</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Selectric
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-selectric"</span> config)
(use-package! selectic-mode
  <span class="ef-b">:commands</span> selectic-mode)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-selectric</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Wttrin
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-wttrin"</span> config)
(use-package! wttrin
  <span class="ef-b">:commands</span> wttrin)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-wttrin</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Spray
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">spray-mode-hide-cursor</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-spray"</span> config)
(use-package! spray
  <span class="ef-b">:commands</span> spray-mode
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> spray-wpm 600
        spray-height 800)
  (<span class="ef-k">defun</span> <span class="ef-f">spray-mode-hide-cursor</span> ()
    <span class="ef-d">"Hide or unhide the cursor as is appropriate."</span>
    (<span class="ef-k">if</span> spray-mode
        (<span class="ef-k">setq-local</span> spray--last-evil-cursor-state evil-normal-state-cursor
                    evil-normal-state-cursor '(nil))
      (<span class="ef-k">setq-local</span> evil-normal-state-cursor spray--last-evil-cursor-state)))
  (add-hook 'spray-mode-hook #'spray-mode-hide-cursor)
  (map! <span class="ef-b">:map</span> spray-mode-map
        <span class="ef-s">"&lt;return&gt;"</span> #'spray-start/stop
        <span class="ef-s">"f"</span> #'spray-faster
        <span class="ef-s">"s"</span> #'spray-slower
        <span class="ef-s">"t"</span> #'spray-time
        <span class="ef-s">"&lt;right&gt;"</span> #'spray-forward-word
        <span class="ef-s">"h"</span> #'spray-forward-word
        <span class="ef-s">"&lt;left&gt;"</span> #'spray-backward-word
        <span class="ef-s">"l"</span> #'spray-backward-word
        <span class="ef-s">"q"</span> #'spray-quit))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-spray</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Elcord
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-elcord"</span> config)
(use-package! elcord
  <span class="ef-b">:commands</span> elcord-mode
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> elcord-use-major-mode-as-main-icon t))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-elcord</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Systemd
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-systemd"</span> config)
(use-package! systemd
  <span class="ef-b">:defer</span> t)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-systemd</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Ebooks
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">doom-modeline-nov-title-max-length</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+nov-mode-setup</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: ebooks"</span> config)
(use-package! calibredb
  <span class="ef-b">:commands</span> calibredb
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> calibredb-root-dir <span class="ef-s">"~/.local/share/calibre-library"</span>
        calibredb-db-dir (expand-file-name <span class="ef-s">"metadata.db"</span> calibredb-root-dir))
  (map! <span class="ef-b">:map</span> calibredb-show-mode-map
        <span class="ef-b">:ne</span> <span class="ef-s">"?"</span> #'calibredb-entry-dispatch
        <span class="ef-b">:ne</span> <span class="ef-s">"o"</span> #'calibredb-find-file
        <span class="ef-b">:ne</span> <span class="ef-s">"O"</span> #'calibredb-find-file-other-frame
        <span class="ef-b">:ne</span> <span class="ef-s">"V"</span> #'calibredb-open-file-with-default-tool
        <span class="ef-b">:ne</span> <span class="ef-s">"s"</span> #'calibredb-set-metadata-dispatch
        <span class="ef-b">:ne</span> <span class="ef-s">"e"</span> #'calibredb-export-dispatch
        <span class="ef-b">:ne</span> <span class="ef-s">"q"</span> #'calibredb-entry-quit
        <span class="ef-b">:ne</span> <span class="ef-s">"."</span> #'calibredb-open-dired
        <span class="ef-b">:ne</span> [tab] #'calibredb-toggle-view-at-point
        <span class="ef-b">:ne</span> <span class="ef-s">"M-t"</span> #'calibredb-set-metadata--tags
        <span class="ef-b">:ne</span> <span class="ef-s">"M-a"</span> #'calibredb-set-metadata--author_sort
        <span class="ef-b">:ne</span> <span class="ef-s">"M-A"</span> #'calibredb-set-metadata--authors
        <span class="ef-b">:ne</span> <span class="ef-s">"M-T"</span> #'calibredb-set-metadata--title
        <span class="ef-b">:ne</span> <span class="ef-s">"M-c"</span> #'calibredb-set-metadata--comments)
  (map! <span class="ef-b">:map</span> calibredb-search-mode-map
        <span class="ef-b">:ne</span> [mouse-3] #'calibredb-search-mouse
        <span class="ef-b">:ne</span> <span class="ef-s">"RET"</span> #'calibredb-find-file
        <span class="ef-b">:ne</span> <span class="ef-s">"?"</span> #'calibredb-dispatch
        <span class="ef-b">:ne</span> <span class="ef-s">"a"</span> #'calibredb-add
        <span class="ef-b">:ne</span> <span class="ef-s">"A"</span> #'calibredb-add-dir
        <span class="ef-b">:ne</span> <span class="ef-s">"c"</span> #'calibredb-clone
        <span class="ef-b">:ne</span> <span class="ef-s">"d"</span> #'calibredb-remove
        <span class="ef-b">:ne</span> <span class="ef-s">"D"</span> #'calibredb-remove-marked-items
        <span class="ef-b">:ne</span> <span class="ef-s">"j"</span> #'calibredb-next-entry
        <span class="ef-b">:ne</span> <span class="ef-s">"k"</span> #'calibredb-previous-entry
        <span class="ef-b">:ne</span> <span class="ef-s">"l"</span> #'calibredb-virtual-library-list
        <span class="ef-b">:ne</span> <span class="ef-s">"L"</span> #'calibredb-library-list
        <span class="ef-b">:ne</span> <span class="ef-s">"n"</span> #'calibredb-virtual-library-next
        <span class="ef-b">:ne</span> <span class="ef-s">"N"</span> #'calibredb-library-next
        <span class="ef-b">:ne</span> <span class="ef-s">"p"</span> #'calibredb-virtual-library-previous
        <span class="ef-b">:ne</span> <span class="ef-s">"P"</span> #'calibredb-library-previous
        <span class="ef-b">:ne</span> <span class="ef-s">"s"</span> #'calibredb-set-metadata-dispatch
        <span class="ef-b">:ne</span> <span class="ef-s">"S"</span> #'calibredb-switch-library
        <span class="ef-b">:ne</span> <span class="ef-s">"o"</span> #'calibredb-find-file
        <span class="ef-b">:ne</span> <span class="ef-s">"O"</span> #'calibredb-find-file-other-frame
        <span class="ef-b">:ne</span> <span class="ef-s">"v"</span> #'calibredb-view
        <span class="ef-b">:ne</span> <span class="ef-s">"V"</span> #'calibredb-open-file-with-default-tool
        <span class="ef-b">:ne</span> <span class="ef-s">"."</span> #'calibredb-open-dired
        <span class="ef-b">:ne</span> <span class="ef-s">"b"</span> #'calibredb-catalog-bib-dispatch
        <span class="ef-b">:ne</span> <span class="ef-s">"e"</span> #'calibredb-export-dispatch
        <span class="ef-b">:ne</span> <span class="ef-s">"r"</span> #'calibredb-search-refresh-and-clear-filter
        <span class="ef-b">:ne</span> <span class="ef-s">"R"</span> #'calibredb-search-clear-filter
        <span class="ef-b">:ne</span> <span class="ef-s">"q"</span> #'calibredb-search-quit
        <span class="ef-b">:ne</span> <span class="ef-s">"m"</span> #'calibredb-mark-and-forward
        <span class="ef-b">:ne</span> <span class="ef-s">"f"</span> #'calibredb-toggle-favorite-at-point
        <span class="ef-b">:ne</span> <span class="ef-s">"x"</span> #'calibredb-toggle-archive-at-point
        <span class="ef-b">:ne</span> <span class="ef-s">"h"</span> #'calibredb-toggle-highlight-at-point
        <span class="ef-b">:ne</span> <span class="ef-s">"u"</span> #'calibredb-unmark-and-forward
        <span class="ef-b">:ne</span> <span class="ef-s">"i"</span> #'calibredb-edit-annotation
        <span class="ef-b">:ne</span> <span class="ef-s">"DEL"</span> #'calibredb-unmark-and-backward
        <span class="ef-b">:ne</span> [backtab] #'calibredb-toggle-view
        <span class="ef-b">:ne</span> [tab] #'calibredb-toggle-view-at-point
        <span class="ef-b">:ne</span> <span class="ef-s">"M-n"</span> #'calibredb-show-next-entry
        <span class="ef-b">:ne</span> <span class="ef-s">"M-p"</span> #'calibredb-show-previous-entry
        <span class="ef-b">:ne</span> <span class="ef-s">"/"</span> #'calibredb-search-live-filter
        <span class="ef-b">:ne</span> <span class="ef-s">"M-t"</span> #'calibredb-set-metadata--tags
        <span class="ef-b">:ne</span> <span class="ef-s">"M-a"</span> #'calibredb-set-metadata--author_sort
        <span class="ef-b">:ne</span> <span class="ef-s">"M-A"</span> #'calibredb-set-metadata--authors
        <span class="ef-b">:ne</span> <span class="ef-s">"M-T"</span> #'calibredb-set-metadata--title
        <span class="ef-b">:ne</span> <span class="ef-s">"M-c"</span> #'calibredb-set-metadata--comments))

(use-package! nov
  <span class="ef-b">:mode</span> (<span class="ef-s">"\\.epub\\'"</span> . nov-mode)
  <span class="ef-b">:config</span>
  (map! <span class="ef-b">:map</span> nov-mode-map
        <span class="ef-b">:n</span> <span class="ef-s">"RET"</span> #'nov-scroll-up)

  (advice-add 'nov-render-title <span class="ef-b">:override</span> #'ignore)

  (<span class="ef-k">defun</span> <span class="ef-f">+nov-mode-setup</span> ()
    <span class="ef-d">"Tweak nov-mode to our liking."</span>
    (face-remap-add-relative 'variable-pitch
                             <span class="ef-b">:family</span> <span class="ef-s">"Merriweather"</span>
                             <span class="ef-b">:height</span> 1.4
                             <span class="ef-b">:width</span> 'semi-expanded)
    (face-remap-add-relative 'default <span class="ef-b">:height</span> 1.3)
    (variable-pitch-mode 1)
    (<span class="ef-k">setq-local</span> line-spacing 0.2
                next-screen-context-lines 4
                shr-use-colors nil)
    (<span class="ef-k">when</span> (<span class="ef-k">require</span> '<span class="ef-o">visual-fill-column</span> nil t)
      (<span class="ef-k">setq-local</span> visual-fill-column-center-text t
                  visual-fill-column-width 64
                  nov-text-width 106)
      (visual-fill-column-mode 1))
    (<span class="ef-k">when</span> (<span class="ef-k">featurep</span> '<span class="ef-o">hl-line-mode</span>)
      (hl-line-mode -1))
    <span class="ef-cd">;; </span><span class="ef-c">Re-render with new display settings
</span>    (nov-render-document)
    <span class="ef-cd">;; </span><span class="ef-c">Look up words with the dictionary.
</span>    (add-to-list '+lookup-definition-functions #'+lookup/dictionary-definition))

  (add-hook 'nov-mode-hook #'+nov-mode-setup))

(<span class="ef-k">after!</span> doom-modeline
  (<span class="ef-k">defvar</span> <span class="ef-v">doom-modeline-nov-title-max-length</span> 40)
  (doom-modeline-def-segment nov-author
    (propertize
     (cdr (assoc 'creator nov-metadata))
     'face (doom-modeline-face 'doom-modeline-project-parent-dir)))
  (doom-modeline-def-segment nov-title
    (<span class="ef-k">let</span> ((title (<span class="ef-k">or</span> (cdr (assoc 'title nov-metadata)) <span class="ef-s">""</span>)))
      (<span class="ef-k">if</span> (&lt;= (length title) doom-modeline-nov-title-max-length)
          (concat <span class="ef-s">" "</span> title)
        (propertize
         (concat <span class="ef-s">" "</span> (truncate-string-to-width title doom-modeline-nov-title-max-length nil nil t))
         'help-echo title))))
  (doom-modeline-def-segment nov-current-page
    (<span class="ef-k">let</span> ((words (count-words (point-min) (point-max))))
      (propertize
       (format <span class="ef-s">" %d/%d"</span>
               (1+ nov-documents-index)
               (length nov-documents))
       'face (doom-modeline-face 'doom-modeline-info)
       'help-echo (<span class="ef-k">if</span> (= words 1) <span class="ef-s">"1 word in this chapter"</span>
                    (format <span class="ef-s">"%s words in this chapter"</span> words)))))
  (doom-modeline-def-segment scroll-percentage-subtle
    (concat
     (doom-modeline-spc)
     (propertize (format-mode-line '(<span class="ef-s">""</span> doom-modeline-percent-position <span class="ef-s">"%%"</span>))
                 'face (doom-modeline-face 'shadow)
                 'help-echo <span class="ef-s">"Buffer percentage"</span>)))

  (doom-modeline-def-modeline 'nov
    '(workspace-name window-number nov-author nov-title nov-current-page scroll-percentage-subtle)
    '(media-player misc-info major-mode time))

  (add-to-list 'doom-modeline-mode-alist '(nov-mode . nov)))

(<span class="ef-k">provide</span> '<span class="ef-o">config-ebooks</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Calculator
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">calc-embedded-calculator-window</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">calc-embedded-trail-window</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: calculator"</span> config)
(use-package! calctex
  <span class="ef-b">:commands</span> calctex-mode
  <span class="ef-b">:init</span>
  (add-hook 'calc-mode-hook #'calctex-mode)
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> calctex-additional-latex-packages <span class="ef-s">"
\\usepackage[usenames]{xcolor}
\\usepackage{soul}
\\usepackage{adjustbox}
\\usepackage{amsmath}
\\usepackage{amssymb}
\\usepackage{siunitx}
\\usepackage{cancel}
\\usepackage{mathtools}
\\usepackage{mathalpha}
\\usepackage{xparse}
\\usepackage{arevmath}"</span>
        calctex-additional-latex-macros
        (concat calctex-additional-latex-macros
                <span class="ef-s">"\n\\let\\evalto\\Rightarrow"</span>))
  (<span class="ef-k">defadvice!</span> no-messaging-a (orig-fn <span class="ef-t">&amp;rest</span> args)
    <span class="ef-b">:around</span> #'calctex-default-dispatching-render-process
    (<span class="ef-k">let</span> ((inhibit-message t) message-log-max)
      (apply orig-fn args)))
  <span class="ef-cd">;; </span><span class="ef-c">Fix hardcoded dvichop path (whyyyyyyy)
</span>  (<span class="ef-k">let</span> ((vendor-folder (concat (file-truename doom-local-dir)
                               <span class="ef-s">"straight/"</span>
                               (format <span class="ef-s">"build-%s"</span> emacs-version)
                               <span class="ef-s">"/calctex/vendor/"</span>)))
    (<span class="ef-k">setq</span> calctex-dvichop-sty (concat vendor-folder <span class="ef-s">"texd/dvichop"</span>)
          calctex-dvichop-bin (concat vendor-folder <span class="ef-s">"texd/dvichop"</span>)))
  (<span class="ef-k">unless</span> (file-exists-p calctex-dvichop-bin)
    (message <span class="ef-s">"CalcTeX: Building dvichop binary"</span>)
    (<span class="ef-k">let</span> ((default-directory (file-name-directory calctex-dvichop-bin)))
      (call-process <span class="ef-s">"make"</span> nil nil nil))))

(<span class="ef-k">setq</span> calc-angle-mode 'rad  <span class="ef-cd">; </span><span class="ef-c">radians are rad
</span>      calc-symbolic-mode t) <span class="ef-cd">; </span><span class="ef-c">keeps expressions like \sqrt{2} irrational for as long as possible
</span>
(map! <span class="ef-b">:map</span> calc-mode-map
      <span class="ef-b">:after</span> calc
      <span class="ef-b">:localleader</span>
      <span class="ef-b">:desc</span> <span class="ef-s">"Embedded calc (toggle)"</span> <span class="ef-s">"e"</span> #'calc-embedded)
(map! <span class="ef-b">:map</span> org-mode-map
      <span class="ef-b">:after</span> org
      <span class="ef-b">:localleader</span>
      <span class="ef-b">:desc</span> <span class="ef-s">"Embedded calc (toggle)"</span> <span class="ef-s">"E"</span> #'calc-embedded)
(map! <span class="ef-b">:map</span> latex-mode-map
      <span class="ef-b">:after</span> latex
      <span class="ef-b">:localleader</span>
      <span class="ef-b">:desc</span> <span class="ef-s">"Embedded calc (toggle)"</span> <span class="ef-s">"e"</span> #'calc-embedded)

(<span class="ef-k">defvar</span> <span class="ef-v">calc-embedded-trail-window</span> nil)
(<span class="ef-k">defvar</span> <span class="ef-v">calc-embedded-calculator-window</span> nil)

(<span class="ef-k">defadvice!</span> calc-embedded-with-side-pannel (<span class="ef-t">&amp;rest</span> _)
  <span class="ef-b">:after</span> #'calc-do-embedded
  (<span class="ef-k">when</span> calc-embedded-trail-window
    (<span class="ef-k">ignore-errors</span>
      (delete-window calc-embedded-trail-window))
    (<span class="ef-k">setq</span> calc-embedded-trail-window nil))
  (<span class="ef-k">when</span> calc-embedded-calculator-window
    (<span class="ef-k">ignore-errors</span>
      (delete-window calc-embedded-calculator-window))
    (<span class="ef-k">setq</span> calc-embedded-calculator-window nil))
  (<span class="ef-k">when</span> (<span class="ef-k">and</span> calc-embedded-info
             (&gt; (* (window-width) (window-height)) 1200))
    (<span class="ef-k">let</span> ((main-window (selected-window))
          (vertical-p (&gt; (window-width) 80)))
      (select-window
       (<span class="ef-k">setq</span> calc-embedded-trail-window
             (<span class="ef-k">if</span> vertical-p
                 (split-window-horizontally (- (max 30 (/ (window-width) 3))))
               (split-window-vertically (- (max 8 (/ (window-height) 4)))))))
      (switch-to-buffer <span class="ef-s">"*Calc Trail*"</span>)
      (select-window
       (<span class="ef-k">setq</span> calc-embedded-calculator-window
             (<span class="ef-k">if</span> vertical-p
                 (split-window-vertically -6)
               (split-window-horizontally (- (/ (window-width) 2))))))
      (switch-to-buffer <span class="ef-s">"*Calculator*"</span>)
      (select-window main-window))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-calculator</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Newsfeed
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">elfeed-show-pdf</span><span class="ef-c">', `</span><span style="color: #b751b6;">elfeed-link-pdfs</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">elfeed-pdf-dir</span><span class="ef-c">', `</span><span style="color: #b751b6;">+rss/elfeed-show-refresh--better-style</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+rss/elfeed-search-print-entry</span><span class="ef-c">', `</span><span style="color: #b751b6;">elfeed-show-author-face</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">elfeed-show-title-face</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: newsfeed"</span> config)
(map! <span class="ef-b">:map</span> elfeed-search-mode-map
      <span class="ef-b">:after</span> elfeed-search
      [remap kill-this-buffer] <span class="ef-s">"q"</span>
      [remap kill-buffer] <span class="ef-s">"q"</span>
      <span class="ef-b">:n</span> doom-leader-key nil
      <span class="ef-b">:n</span> <span class="ef-s">"q"</span> #'+rss/quit
      <span class="ef-b">:n</span> <span class="ef-s">"e"</span> #'elfeed-update
      <span class="ef-b">:n</span> <span class="ef-s">"r"</span> #'elfeed-search-untag-all-unread
      <span class="ef-b">:n</span> <span class="ef-s">"u"</span> #'elfeed-search-tag-all-unread
      <span class="ef-b">:n</span> <span class="ef-s">"s"</span> #'elfeed-search-live-filter
      <span class="ef-b">:n</span> <span class="ef-s">"RET"</span> #'elfeed-search-show-entry
      <span class="ef-b">:n</span> <span class="ef-s">"p"</span> #'elfeed-show-pdf
      <span class="ef-b">:n</span> <span class="ef-s">"+"</span> #'elfeed-search-tag-all
      <span class="ef-b">:n</span> <span class="ef-s">"-"</span> #'elfeed-search-untag-all
      <span class="ef-b">:n</span> <span class="ef-s">"S"</span> #'elfeed-search-set-filter
      <span class="ef-b">:n</span> <span class="ef-s">"b"</span> #'elfeed-search-browse-url
      <span class="ef-b">:n</span> <span class="ef-s">"y"</span> #'elfeed-search-yank)
(map! <span class="ef-b">:map</span> elfeed-show-mode-map
      <span class="ef-b">:after</span> elfeed-show
      [remap kill-this-buffer] <span class="ef-s">"q"</span>
      [remap kill-buffer] <span class="ef-s">"q"</span>
      <span class="ef-b">:n</span> doom-leader-key nil
      <span class="ef-b">:nm</span> <span class="ef-s">"q"</span> #'+rss/delete-pane
      <span class="ef-b">:nm</span> <span class="ef-s">"o"</span> #'ace-link-elfeed
      <span class="ef-b">:nm</span> <span class="ef-s">"RET"</span> #'org-ref-elfeed-add
      <span class="ef-b">:nm</span> <span class="ef-s">"n"</span> #'elfeed-show-next
      <span class="ef-b">:nm</span> <span class="ef-s">"N"</span> #'elfeed-show-prev
      <span class="ef-b">:nm</span> <span class="ef-s">"p"</span> #'elfeed-show-pdf
      <span class="ef-b">:nm</span> <span class="ef-s">"+"</span> #'elfeed-show-tag
      <span class="ef-b">:nm</span> <span class="ef-s">"-"</span> #'elfeed-show-untag
      <span class="ef-b">:nm</span> <span class="ef-s">"s"</span> #'elfeed-show-new-live-search
      <span class="ef-b">:nm</span> <span class="ef-s">"y"</span> #'elfeed-show-yank)

(<span class="ef-k">after!</span> elfeed-search
  (set-evil-initial-state! 'elfeed-search-mode 'normal))
(<span class="ef-k">after!</span> elfeed-show-mode
  (set-evil-initial-state! 'elfeed-show-mode   'normal))

(<span class="ef-k">after!</span> evil-snipe
  (<span class="ef-k">push</span> 'elfeed-show-mode   evil-snipe-disabled-modes)
  (<span class="ef-k">push</span> 'elfeed-search-mode evil-snipe-disabled-modes))

(<span class="ef-k">after!</span> elfeed

  (elfeed-org)
  (use-package! elfeed-link)

  (<span class="ef-k">setq</span> elfeed-search-filter <span class="ef-s">"@1-week-ago +unread"</span>
        elfeed-search-print-entry-function '+rss/elfeed-search-print-entry
        elfeed-search-title-min-width 80
        elfeed-show-entry-switch #'pop-to-buffer
        elfeed-show-entry-delete #'+rss/delete-pane
        elfeed-show-refresh-function #'+rss/elfeed-show-refresh--better-style
        shr-max-image-proportion 0.6)

  (<span class="ef-k">add-hook!</span> 'elfeed-show-mode-hook (hide-mode-line-mode 1))
  (<span class="ef-k">add-hook!</span> 'elfeed-search-update-hook #'hide-mode-line-mode)

  (<span class="ef-k">defface</span> <span class="ef-v">elfeed-show-title-face</span> '((t (<span class="ef-b">:weight</span> ultrabold <span class="ef-b">:slant</span> italic <span class="ef-b">:height</span> 1.5)))
    <span class="ef-d">"title face in elfeed show buffer"</span>
    <span class="ef-b">:group</span> 'elfeed)
  (<span class="ef-k">defface</span> <span class="ef-v">elfeed-show-author-face</span> `((t (<span class="ef-b">:weight</span> light)))
    <span class="ef-d">"title face in elfeed show buffer"</span>
    <span class="ef-b">:group</span> 'elfeed)
  (set-face-attribute 'elfeed-search-title-face nil
                      <span class="ef-b">:foreground</span> 'nil
                      <span class="ef-b">:weight</span> 'light)

  (<span class="ef-k">defadvice!</span> +rss-elfeed-wrap-h-nicer ()
    <span class="ef-d">"Enhances an elfeed entry's readability by wrapping it to a width of
`</span><span style="color: #b751b6; text-decoration: italic;">fill-column</span><span class="ef-d">' and centering it with `</span><span style="color: #b751b6; text-decoration: italic;">visual-fill-column-mode</span><span class="ef-d">'."</span>
    <span class="ef-b">:override</span> #'+rss-elfeed-wrap-h
    (<span class="ef-k">setq-local</span> truncate-lines nil
                shr-width 120
                visual-fill-column-center-text t
                default-text-properties '(line-height 1.1))
    (<span class="ef-k">let</span> ((inhibit-read-only t)
          (inhibit-modification-hooks t))
      (visual-fill-column-mode)
      <span class="ef-cd">;; </span><span class="ef-c">(setq-local shr-current-font '(:family "Merriweather" :height 1.2))
</span>      (set-buffer-modified-p nil)))

  (<span class="ef-k">defun</span> <span class="ef-f">+rss/elfeed-search-print-entry</span> (entry)
    <span class="ef-d">"Print ENTRY to the buffer."</span>
    (<span class="ef-k">let*</span> ((elfeed-goodies/tag-column-width 40)
           (elfeed-goodies/feed-source-column-width 30)
           (title (<span class="ef-k">or</span> (elfeed-meta entry <span class="ef-b">:title</span>) (elfeed-entry-title entry) <span class="ef-s">""</span>))
           (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
           (feed (elfeed-entry-feed entry))
           (feed-title
            (<span class="ef-k">when</span> feed
              (<span class="ef-k">or</span> (elfeed-meta feed <span class="ef-b">:title</span>) (elfeed-feed-title feed))))
           (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
           (tags-str (concat (mapconcat 'identity tags <span class="ef-s">","</span>)))
           (title-width (- (window-width) elfeed-goodies/feed-source-column-width
                           elfeed-goodies/tag-column-width 4))

           (tag-column (elfeed-format-column
                        tags-str (elfeed-clamp (length tags-str)
                                               elfeed-goodies/tag-column-width
                                               elfeed-goodies/tag-column-width)
                        <span class="ef-b">:left</span>))
           (feed-column (elfeed-format-column
                         feed-title (elfeed-clamp elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width)
                         <span class="ef-b">:left</span>)))

      (insert (propertize feed-column 'face 'elfeed-search-feed-face) <span class="ef-s">" "</span>)
      (insert (propertize tag-column 'face 'elfeed-search-tag-face) <span class="ef-s">" "</span>)
      (insert (propertize title 'face title-faces 'kbd-help title))
      (<span class="ef-k">setq-local</span> line-spacing 0.2)))

  (<span class="ef-k">defun</span> <span class="ef-f">+rss/elfeed-show-refresh--better-style</span> ()
    <span class="ef-d">"Update the buffer to match the selected entry, using a mail-style."</span>
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">let*</span> ((inhibit-read-only t)
           (title (elfeed-entry-title elfeed-show-entry))
           (date (seconds-to-time (elfeed-entry-date elfeed-show-entry)))
           (author (elfeed-meta elfeed-show-entry <span class="ef-b">:author</span>))
           (link (elfeed-entry-link elfeed-show-entry))
           (tags (elfeed-entry-tags elfeed-show-entry))
           (tagsstr (mapconcat #'symbol-name tags <span class="ef-s">", "</span>))
           (nicedate (format-time-string <span class="ef-s">"%a, %e %b %Y %T %Z"</span> date))
           (content (elfeed-deref (elfeed-entry-content elfeed-show-entry)))
           (type (elfeed-entry-content-type elfeed-show-entry))
           (feed (elfeed-entry-feed elfeed-show-entry))
           (feed-title (elfeed-feed-title feed))
           (base (<span class="ef-k">and</span> feed (elfeed-compute-base (elfeed-feed-url feed)))))
      (erase-buffer)
      (insert <span class="ef-s">"\n"</span>)
      (insert (format <span class="ef-s">"%s\n\n"</span> (propertize title 'face 'elfeed-show-title-face)))
      (insert (format <span class="ef-s">"%s\t"</span> (propertize feed-title 'face 'elfeed-search-feed-face)))
      (<span class="ef-k">when</span> (<span class="ef-k">and</span> author elfeed-show-entry-author)
        (insert (format <span class="ef-s">"%s\n"</span> (propertize author 'face 'elfeed-show-author-face))))
      (insert (format <span class="ef-s">"%s\n\n"</span> (propertize nicedate 'face 'elfeed-log-date-face)))
      (<span class="ef-k">when</span> tags
        (insert (format <span class="ef-s">"%s\n"</span>
                        (propertize tagsstr 'face 'elfeed-search-tag-face))))
      <span class="ef-cd">;; </span><span class="ef-c">(insert (propertize "Link: " 'face 'message-header-name))
</span>      <span class="ef-cd">;; </span><span class="ef-c">(elfeed-insert-link link link)
</span>      <span class="ef-cd">;; </span><span class="ef-c">(insert "\n")
</span>      (<span class="ef-k">cl-loop</span> for enclosure in (elfeed-entry-enclosures elfeed-show-entry)
               do (insert (propertize <span class="ef-s">"Enclosure: "</span> 'face 'message-header-name))
               do (elfeed-insert-link (car enclosure))
               do (insert <span class="ef-s">"\n"</span>))
      (insert <span class="ef-s">"\n"</span>)
      (<span class="ef-k">if</span> content
          (<span class="ef-k">if</span> (eq type 'html)
              (elfeed-insert-html content base)
            (insert content))
        (insert (propertize <span class="ef-s">"(empty)\n"</span> 'face 'italic)))
      (goto-char (point-min))))

  )

(<span class="ef-k">after!</span> elfeed-show
  (<span class="ef-k">require</span> '<span class="ef-o">url</span>)

  (<span class="ef-k">defvar</span> <span class="ef-v">elfeed-pdf-dir</span>
    (expand-file-name <span class="ef-s">"pdfs/"</span>
                      (file-name-directory (directory-file-name elfeed-enclosure-default-dir))))

  (<span class="ef-k">defvar</span> <span class="ef-v">elfeed-link-pdfs</span>
    '((<span class="ef-s">"https://www.jstatsoft.org/index.php/jss/article/view/v0</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> . <span class="ef-s">"https://www.jstatsoft.org/index.php/jss/article/view/v0\\1/v\\1.pdf"</span>)
      (<span class="ef-s">"http://arxiv.org/abs/</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> . <span class="ef-s">"https://arxiv.org/pdf/\\1.pdf"</span>))
    <span class="ef-d">"List of alists of the form (REGEX-FOR-LINK . FORM-FOR-PDF)"</span>)

  (<span class="ef-k">defun</span> <span class="ef-f">elfeed-show-pdf</span> (entry)
    (<span class="ef-k">interactive</span>
     (list (<span class="ef-k">or</span> elfeed-show-entry (elfeed-search-selected <span class="ef-b">:ignore-region</span>))))
    (<span class="ef-k">let</span> ((link (elfeed-entry-link entry))
          (feed-name (plist-get (elfeed-feed-meta (elfeed-entry-feed entry)) <span class="ef-b">:title</span>))
          (title (elfeed-entry-title entry))
          (file-view-function
           (<span class="ef-k">lambda</span> (f)
             (<span class="ef-k">when</span> elfeed-show-entry
               (elfeed-kill-buffer))
             (pop-to-buffer (find-file-noselect f))))
          pdf)

      (<span class="ef-k">let</span> ((file (expand-file-name
                   (concat (subst-char-in-string ?/ ?, title) <span class="ef-s">".pdf"</span>)
                   (expand-file-name (subst-char-in-string ?/ ?, feed-name)
                                     elfeed-pdf-dir))))
        (<span class="ef-k">if</span> (file-exists-p file)
            (funcall file-view-function file)
          (<span class="ef-k">dolist</span> (link-pdf elfeed-link-pdfs)
            (<span class="ef-k">when</span> (<span class="ef-k">and</span> (string-match-p (car link-pdf) link)
                       (not pdf))
              (<span class="ef-k">setq</span> pdf (replace-regexp-in-string (car link-pdf) (cdr link-pdf) link))))
          (<span class="ef-k">if</span> (not pdf)
              (message <span class="ef-s">"No associated PDF for entry"</span>)
            (message <span class="ef-s">"Fetching %s"</span> pdf)
            (<span class="ef-k">unless</span> (file-exists-p (file-name-directory file))
              (make-directory (file-name-directory file) t))
            (url-copy-file pdf file)
            (funcall file-view-function file))))))

  )

(<span class="ef-k">provide</span> '<span class="ef-o">config-newsfeed</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Mail
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+org-msg-goto-body-when-replying</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-msg-goto-body</span><span class="ef-c">', `</span><span style="color: #b751b6;">+mu4e-org-ml-signature</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+mu4e-goto-subject-not-to-once</span><span class="ef-c">', `</span><span style="color: #b751b6;">+mu4e-compose-org-ml-setup</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+browse-url-orgmode-ml</span><span class="ef-c">', `</span><span style="color: #b751b6;">+mu4e-ml-message-link</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-ml-transient-mu4e-action</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-ml-select-patch-thread</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-ml-current-patches</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-ml-apply-patch</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-ml--cache</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-ml--cache-timestamp</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-ml-max-age</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-ml-target-dir</span><span class="ef-c">', `</span><span style="color: #b751b6;">+mu4e-insert-woof-header</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+mu4e-get-woof-header</span><span class="ef-c">', `</span><span style="color: #b751b6;">+mu4e-evil-enter-insert-mode</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+mu4e-account-sent-folder</span><span class="ef-c">', `</span><span style="color: #b751b6;">+mu4e-update-personal-addresses</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">mu4e-from-name</span><span class="ef-c">', `</span><span style="color: #b751b6;">mu4e-compose-from-mailto</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+mu4e-header--folder-colors</span><span class="ef-c">', `</span><span style="color: #b751b6;">mu4e-reindex-maybe</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">mu4e-file-reindex-request</span><span class="ef-c">', `</span><span style="color: #b751b6;">mu4e-reindex-request--add-watcher</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">mu4e-reindex-request--last-time</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">mu4e-reindex-request--file-just-deleted</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">mu4e-reindex-request--file-watcher</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">mu4e-reindex-request-min-seperation</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">mu4e-reindex-request-file</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: mail"</span> set-hooks)
<span class="ef-cd">;; </span><span class="ef-c">Begin pre
</span>(<span class="ef-k">setq</span> +org-msg-accent-color <span class="ef-s">"#1a5fb4"</span>)
<span class="ef-cd">;; </span><span class="ef-c">End pre
</span>  (<span class="ef-k">with-eval-after-load</span> 'mu4e
(confpkg-with-record '(<span class="ef-s">"load: mail"</span> load-hooks)
(<span class="ef-k">require</span> '<span class="ef-o">config-mail</span>)
)))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">File Templates
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: file-templates"</span> config)
(set-file-template! <span class="ef-s">"\\.tex$"</span> <span class="ef-b">:trigger</span> <span class="ef-s">"__"</span> <span class="ef-b">:mode</span> 'latex-mode)
(set-file-template! <span class="ef-s">"\\.org$"</span> <span class="ef-b">:trigger</span> <span class="ef-s">"__"</span> <span class="ef-b">:mode</span> 'org-mode)
(set-file-template! <span class="ef-s">"/LICEN[CS]E$"</span> <span class="ef-b">:trigger</span> '+file-templates/insert-license)

(<span class="ef-k">provide</span> '<span class="ef-o">config-file-templates</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Plaintext
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+setup-text-mode-left-margin</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+text-mode-left-margin-width</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: plaintext"</span> config)
(<span class="ef-k">after!</span> text-mode
  (<span class="ef-k">add-hook!</span> 'text-mode-hook
    (<span class="ef-k">unless</span> (derived-mode-p 'org-mode)
      <span class="ef-cd">;; </span><span class="ef-c">Apply ANSI color codes
</span>      (<span class="ef-k">with-silent-modifications</span>
        (ansi-color-apply-on-region (point-min) (point-max) t)))))

(<span class="ef-k">defvar</span> <span class="ef-v">+text-mode-left-margin-width</span> 1
  <span class="ef-d">"The `</span><span style="color: #b751b6; text-decoration: italic;">left-margin-width</span><span class="ef-d">' to be used in `</span><span style="color: #b751b6; text-decoration: italic;">text-mode</span><span class="ef-d">' buffers."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">+setup-text-mode-left-margin</span> ()
  (<span class="ef-k">when</span> (<span class="ef-k">and</span> (derived-mode-p 'text-mode)
             (not (<span class="ef-k">and</span> (<span class="ef-k">bound-and-true-p</span> visual-fill-column-mode)
                       visual-fill-column-center-text))
             (eq (current-buffer) <span class="ef-cd">; </span><span class="ef-c">Check current buffer is active.
</span>                 (window-buffer (frame-selected-window))))
    (<span class="ef-k">setq</span> left-margin-width (<span class="ef-k">if</span> display-line-numbers
                                0 +text-mode-left-margin-width))
    (set-window-buffer (get-buffer-window (current-buffer))
                       (current-buffer))))


(add-hook 'window-configuration-change-hook #'+setup-text-mode-left-margin)
(add-hook 'display-line-numbers-mode-hook #'+setup-text-mode-left-margin)
(add-hook 'text-mode-hook #'+setup-text-mode-left-margin)

(<span class="ef-k">defadvice!</span> +doom/toggle-line-numbers--call-hook-a ()
  <span class="ef-b">:after</span> #'doom/toggle-line-numbers
  (run-hooks 'display-line-numbers-mode-hook))

(remove-hook 'text-mode-hook #'display-line-numbers-mode)

(<span class="ef-k">provide</span> '<span class="ef-o">config-plaintext</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-modern
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-modern"</span> config)
(use-package! org-modern
  <span class="ef-b">:hook</span> (org-mode . org-modern-mode)
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> org-modern-star '(<span class="ef-s">"â"</span> <span class="ef-s">"â"</span> <span class="ef-s">"â¸"</span> <span class="ef-s">"â¿"</span> <span class="ef-s">"â¤"</span> <span class="ef-s">"â"</span> <span class="ef-s">"â"</span> <span class="ef-s">"â¶"</span>)
        org-modern-table-vertical 1
        org-modern-table-horizontal 0.2
        org-modern-list '((43 . <span class="ef-s">"â¤"</span>)
                          (45 . <span class="ef-s">"â"</span>)
                          (42 . <span class="ef-s">"â¢"</span>))
        org-modern-todo-faces
        '((<span class="ef-s">"TODO"</span> <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> org-todo)
          (<span class="ef-s">"PROJ"</span> <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-project)
          (<span class="ef-s">"STRT"</span> <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-active)
          (<span class="ef-s">"[-]"</span>  <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-active)
          (<span class="ef-s">"HOLD"</span> <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-onhold)
          (<span class="ef-s">"WAIT"</span> <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-onhold)
          (<span class="ef-s">"[?]"</span>  <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-onhold)
          (<span class="ef-s">"KILL"</span> <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-cancel)
          (<span class="ef-s">"NO"</span>   <span class="ef-b">:inverse-video</span> t <span class="ef-b">:inherit</span> +org-todo-cancel))
        org-modern-footnote
        (cons nil (cadr org-script-display))
        org-modern-block-fringe nil
        org-modern-block-name
        '((t . t)
          (<span class="ef-s">"src"</span> <span class="ef-s">"Â»"</span> <span class="ef-s">"Â«"</span>)
          (<span class="ef-s">"example"</span> <span class="ef-s">"Â»â"</span> <span class="ef-s">"âÂ«"</span>)
          (<span class="ef-s">"quote"</span> <span class="ef-s">"â"</span> <span class="ef-s">"â"</span>)
          (<span class="ef-s">"export"</span> <span class="ef-s">"â©"</span> <span class="ef-s">"âª"</span>))
        org-modern-progress nil
        org-modern-priority nil
        org-modern-horizontal-rule (make-string 36 ?â)
        org-modern-keyword
        '((t . t)
          (<span class="ef-s">"title"</span> . <span class="ef-s">"ð"</span>)
          (<span class="ef-s">"subtitle"</span> . <span class="ef-s">"ð©"</span>)
          (<span class="ef-s">"author"</span> . <span class="ef-s">"ð¼"</span>)
          (<span class="ef-s">"email"</span> . <span class="ef-s">"ï¯"</span>)
          (<span class="ef-s">"date"</span> . <span class="ef-s">"ð¿"</span>)
          (<span class="ef-s">"property"</span> . <span class="ef-s">"ó° ³"</span>)
          (<span class="ef-s">"options"</span> . #(<span class="ef-s">"ó°µ"</span> 0 1 (display (height 0.75))))
          (<span class="ef-s">"startup"</span> . <span class="ef-s">"â»"</span>)
          (<span class="ef-s">"macro"</span> . <span class="ef-s">"ð"</span>)
          (<span class="ef-s">"bind"</span> . <span class="ef-s">"ó°·"</span>)
          (<span class="ef-s">"bibliography"</span> . <span class="ef-s">"ï"</span>)
          (<span class="ef-s">"print_bibliography"</span> . <span class="ef-s">"ó°±"</span>)
          (<span class="ef-s">"cite_export"</span> . <span class="ef-s">"ïâ®­"</span>)
          (<span class="ef-s">"print_glossary"</span> . <span class="ef-s">"ó°±á´¬á¶»"</span>)
          (<span class="ef-s">"glossary_sources"</span> . <span class="ef-s">"ó°»"</span>)
          (<span class="ef-s">"include"</span> . <span class="ef-s">"â¤"</span>)
          (<span class="ef-s">"setupfile"</span> . <span class="ef-s">"â"</span>)
          (<span class="ef-s">"html_head"</span> . <span class="ef-s">"ð·"</span>)
          (<span class="ef-s">"html"</span> . <span class="ef-s">"ð"</span>)
          (<span class="ef-s">"latex_class"</span> . <span class="ef-s">"ð»"</span>)
          (<span class="ef-s">"latex_class_options"</span> . <span class="ef-s">"ð»ó°"</span>)
          (<span class="ef-s">"latex_header"</span> . <span class="ef-s">"ð»"</span>)
          (<span class="ef-s">"latex_header_extra"</span> . <span class="ef-s">"ð»âº"</span>)
          (<span class="ef-s">"latex"</span> . <span class="ef-s">"ð"</span>)
          (<span class="ef-s">"beamer_theme"</span> . <span class="ef-s">"ð±"</span>)
          (<span class="ef-s">"beamer_color_theme"</span> . <span class="ef-s">"ð±ó°"</span>)
          (<span class="ef-s">"beamer_font_theme"</span> . <span class="ef-s">"ð±ð"</span>)
          (<span class="ef-s">"beamer_header"</span> . <span class="ef-s">"ð±"</span>)
          (<span class="ef-s">"beamer"</span> . <span class="ef-s">"ð"</span>)
          (<span class="ef-s">"attr_latex"</span> . <span class="ef-s">"ð"</span>)
          (<span class="ef-s">"attr_html"</span> . <span class="ef-s">"ð"</span>)
          (<span class="ef-s">"attr_org"</span> . <span class="ef-s">"âª"</span>)
          (<span class="ef-s">"call"</span> . <span class="ef-s">"ó°"</span>)
          (<span class="ef-s">"name"</span> . <span class="ef-s">"â"</span>)
          (<span class="ef-s">"header"</span> . <span class="ef-s">"âº"</span>)
          (<span class="ef-s">"caption"</span> . <span class="ef-s">"â°"</span>)
          (<span class="ef-s">"results"</span> . <span class="ef-s">"ð ¶"</span>)))
  (custom-set-faces! '(org-modern-statistics <span class="ef-b">:inherit</span> org-checkbox-statistics-todo)))

(<span class="ef-k">after!</span> spell-fu
  (<span class="ef-k">cl-pushnew</span> 'org-modern-tag (alist-get 'org-mode +spell-excluded-faces-alist)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-modern</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-appear
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-appear"</span> config)
(use-package! org-appear
  <span class="ef-b">:hook</span> (org-mode . org-appear-mode)
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> org-appear-autoemphasis t
        org-appear-autosubmarkers t
        org-appear-autolinks nil)
  <span class="ef-cd">;; </span><span class="ef-c">for proper first-time setup, `</span><span style="color: #b751b6;">org-appear--set-elements</span><span class="ef-c">'
</span>  <span class="ef-cd">;; </span><span class="ef-c">needs to be run after other hooks have acted.
</span>  (run-at-time nil nil #'org-appear--set-elements))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-appear</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-ol-tree
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-ol-tree"</span> config)
(use-package! org-ol-tree
  <span class="ef-b">:commands</span> org-ol-tree
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> org-ol-tree-ui-icon-set
        (<span class="ef-k">if</span> (<span class="ef-k">and</span> (display-graphic-p)
                 (fboundp 'all-the-icons-material))
            'all-the-icons
          'unicode))
  (org-ol-tree-ui--update-icon-set))

(map! <span class="ef-b">:map</span> org-mode-map
      <span class="ef-b">:after</span> org
      <span class="ef-b">:localleader</span>
      <span class="ef-b">:desc</span> <span class="ef-s">"Outline"</span> <span class="ef-s">"O"</span> #'org-ol-tree)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-ol-tree</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg ob-julia
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-ob-julia"</span> config)
(use-package! ob-julia
  <span class="ef-b">:commands</span> org-babel-execute:julia
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> org-babel-julia-command-arguments
        `(<span class="ef-s">"--sysimage"</span>
          ,(<span class="ef-k">when-let</span> ((img <span class="ef-s">"~/.local/lib/julia.so"</span>)
                      (exists? (file-exists-p img)))
             (expand-file-name img))
          <span class="ef-s">"--threads"</span>
          ,(number-to-string (- (doom-system-cpus) 2))
          <span class="ef-s">"--banner=no"</span>)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-ob-julia</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg ob-http
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-ob-http"</span> config)
(use-package! ob-http
  <span class="ef-b">:commands</span> org-babel-execute:http)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-ob-http</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-transclusion
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-transclusion"</span> config)
(use-package! org-transclusion
  <span class="ef-b">:commands</span> org-transclusion-mode
  <span class="ef-b">:init</span>
  (map! <span class="ef-b">:after</span> org <span class="ef-b">:map</span> org-mode-map
        <span class="ef-s">"&lt;f12&gt;"</span> #'org-transclusion-mode))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-transclusion</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-graph-view
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-graph-view"</span> config)
(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-graph-view</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-chef
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-chef"</span> config)
(use-package! org-chef
  <span class="ef-b">:commands</span> (org-chef-insert-recipe org-chef-get-recipe-from-url))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-chef</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-pandoc-import
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-pandoc-import"</span> config)
(use-package! org-pandoc-import
  <span class="ef-b">:after</span> org)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-pandoc-import</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-glossary
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+org-glossary--latex-cdef</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-glossary"</span> config)
(use-package! org-glossary
  <span class="ef-b">:hook</span> (org-mode . org-glossary-mode)
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> org-glossary-collection-root <span class="ef-s">"~/.config/doom/misc/glossaries/"</span>)
  (<span class="ef-k">defun</span> <span class="ef-f">+org-glossary--latex-cdef</span> (backend info term-entry form <span class="ef-t">&amp;optional</span> ref-index plural-p capitalized-p extra-parameters)
    (org-glossary--export-template
     (<span class="ef-k">if</span> (plist-get term-entry <span class="ef-b">:uses</span>)
         <span class="ef-s">"*%d*\\emsp{}%v\\ensp{}@@latex:\\labelcpageref{@@%b@@latex:}@@\n"</span>
       <span class="ef-s">"*%d*\\emsp{}%v\n"</span>)
     backend info term-entry ref-index
     plural-p capitalized-p extra-parameters))
  (org-glossary-set-export-spec
   'latex t
   <span class="ef-b">:backref</span> <span class="ef-s">"gls-%K-use-%r"</span>
   <span class="ef-b">:backref-seperator</span> <span class="ef-s">","</span>
   <span class="ef-b">:definition-structure</span> #'+org-glossary--latex-cdef))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-glossary</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg orgdiff
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+orgdiff-nicer-change-colours</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-orgdiff"</span> config)
(use-package! orgdiff
  <span class="ef-b">:defer</span> t
  <span class="ef-b">:config</span>
  (<span class="ef-k">defun</span> <span class="ef-f">+orgdiff-nicer-change-colours</span> ()
    (goto-char (point-min))
    <span class="ef-cd">;; </span><span class="ef-c">Set red/blue based on whether chameleon is being used
</span>    (<span class="ef-k">if</span> (search-forward <span class="ef-s">"%% make document follow Emacs theme"</span> nil t)
        (<span class="ef-k">setq</span> red  (substring (doom-blend 'red 'fg 0.8) 1)
              blue (substring (doom-blend 'blue 'teal 0.6) 1))
      (<span class="ef-k">setq</span> red  <span class="ef-s">"c82829"</span>
            blue <span class="ef-s">"00618a"</span>))
    (<span class="ef-k">when</span> (<span class="ef-k">and</span> (search-forward <span class="ef-s">"%DIF PREAMBLE EXTENSION ADDED BY LATEXDIFF"</span> nil t)
               (search-forward <span class="ef-s">"\\RequirePackage{color}"</span> nil t))
      (<span class="ef-k">when</span> (re-search-forward <span class="ef-s">"definecolor{red}{rgb}{1,0,0}"</span> (cdr (bounds-of-thing-at-point 'line)) t)
        (replace-match (format <span class="ef-s">"definecolor{red}{HTML}{%s}"</span> red)))
      (<span class="ef-k">when</span> (re-search-forward <span class="ef-s">"definecolor{blue}{rgb}{0,0,1}"</span> (cdr (bounds-of-thing-at-point 'line)) t)
        (replace-match (format <span class="ef-s">"definecolor{blue}{HTML}{%s}"</span> blue)))))
  (<span class="ef-k">setq</span> orgdiff-latexdiff-args '(<span class="ef-s">"--append-safecmd=acr,acrs"</span>))
  (add-to-list 'orgdiff-latexdiff-postprocess-hooks #'+orgdiff-nicer-change-colours))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-orgdiff</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-music
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-music"</span> config)
(use-package! org-music
  <span class="ef-b">:after</span> org
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> org-music-mpris-player <span class="ef-s">"Lollypop"</span>
        org-music-track-search-method 'beets
        org-music-beets-db <span class="ef-s">"~/Music/library.db"</span>))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-music</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Org Behaviour
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+org-export-yt</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-xkcd-complete</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-xkcd-export</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-xkcd-image-fn</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-xkcd-open-fn</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-syntax-convert-keyword-case-to-lower</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+yas/org-most-common-no-property-lang</span><span class="ef-c">', `</span><span style="color: #b751b6;">+yas/org-last-src-lang</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+yas/org-src-lang</span><span class="ef-c">', `</span><span style="color: #b751b6;">+yas/org-prompt-header-arg</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+yas/org-src-header-p</span><span class="ef-c">', `</span><span style="color: #b751b6;">unpackaged/org-return-dwim</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">unpackaged/org-element-descendant-of</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-capture-reinitialise-hook</span><span class="ef-c">', `</span><span style="color: #b751b6;">set-org-capture-templates</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-capture-recipies</span><span class="ef-c">', `</span><span style="color: #b751b6;">+doct-iconify-capture-templates</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+doct-icon-declaration-to-icon</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-mks-pretty</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-capture-select-template-prettier</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-view-external-file-extensions</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-view-output-file-extensions</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-view-output-file</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-babel-lang-list</span><span class="ef-c">', `</span><span style="color: #b751b6;">lsp-org-babel-enable</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-insert-file-link</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: org-behaviour"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'org
(confpkg-with-record '(<span class="ef-s">"load: org-behaviour"</span> load-hooks)
(<span class="ef-k">setq</span> org-directory (expand-file-name <span class="ef-s">"org"</span> (xdg-data-home)) <span class="ef-cd">; </span><span class="ef-c">Let's put files here.
</span>      org-agenda-files (list org-directory)                  <span class="ef-cd">; </span><span class="ef-c">Seems like the obvious place.
</span>      org-use-property-inheritance t                         <span class="ef-cd">; </span><span class="ef-c">It's convenient to have properties inherited.
</span>      org-log-done 'time                                     <span class="ef-cd">; </span><span class="ef-c">Having the time a item is done sounds convenient.
</span>      org-list-allow-alphabetical t                          <span class="ef-cd">; </span><span class="ef-c">Have a. A. a) A) list bullets.
</span>      org-catch-invisible-edits 'smart                       <span class="ef-cd">; </span><span class="ef-c">Try not to accidently do weird stuff in invisible regions.
</span>      org-export-with-sub-superscripts '{}                   <span class="ef-cd">; </span><span class="ef-c">Don't treat lone _ / ^ as sub/superscripts, require _{} / ^{}.
</span>      org-export-allow-bind-keywords t                       <span class="ef-cd">; </span><span class="ef-c">Bind keywords can be handy
</span>      org-image-actual-width '(0.9))                         <span class="ef-cd">; </span><span class="ef-c">Make the in-buffer display closer to the exported result..
</span>
(<span class="ef-k">setq</span> org-babel-default-header-args
      '((<span class="ef-b">:session</span> . <span class="ef-s">"none"</span>)
        (<span class="ef-b">:results</span> . <span class="ef-s">"replace"</span>)
        (<span class="ef-b">:exports</span> . <span class="ef-s">"code"</span>)
        (<span class="ef-b">:cache</span> . <span class="ef-s">"no"</span>)
        (<span class="ef-b">:noweb</span> . <span class="ef-s">"no"</span>)
        (<span class="ef-b">:hlines</span> . <span class="ef-s">"no"</span>)
        (<span class="ef-b">:tangle</span> . <span class="ef-s">"no"</span>)
        (<span class="ef-b">:comments</span> . <span class="ef-s">"link"</span>)))

(remove-hook 'text-mode-hook #'visual-line-mode)
(add-hook 'text-mode-hook #'auto-fill-mode)

(map! <span class="ef-b">:map</span> evil-org-mode-map
      <span class="ef-b">:after</span> evil-org
      <span class="ef-b">:n</span> <span class="ef-s">"g &lt;up&gt;"</span> #'org-backward-heading-same-level
      <span class="ef-b">:n</span> <span class="ef-s">"g &lt;down&gt;"</span> #'org-forward-heading-same-level
      <span class="ef-b">:n</span> <span class="ef-s">"g &lt;left&gt;"</span> #'org-up-element
      <span class="ef-b">:n</span> <span class="ef-s">"g &lt;right&gt;"</span> #'org-down-element)

(map! <span class="ef-b">:map</span> org-mode-map
      <span class="ef-b">:nie</span> <span class="ef-s">"M-SPC M-SPC"</span> (<span class="ef-k">cmd!</span> (insert <span class="ef-s">"\u200B"</span>)))

(<span class="ef-k">setq</span> org-list-demote-modify-bullet '((<span class="ef-s">"+"</span> . <span class="ef-s">"-"</span>) (<span class="ef-s">"-"</span> . <span class="ef-s">"+"</span>) (<span class="ef-s">"*"</span> . <span class="ef-s">"+"</span>) (<span class="ef-s">"1."</span> . <span class="ef-s">"a."</span>)))

(<span class="ef-k">defun</span> <span class="ef-f">+org-insert-file-link</span> ()
  <span class="ef-d">"Insert a file link.  At the prompt, enter the filename."</span>
  (<span class="ef-k">interactive</span>)
  (org-insert-link nil (org-link-complete-file)))

(map! <span class="ef-b">:after</span> org
      <span class="ef-b">:map</span> org-mode-map
      <span class="ef-b">:localleader</span>
      <span class="ef-s">"l f"</span> #'+org-insert-file-link)

(<span class="ef-k">defadvice!</span> +org-edit-latex-env-after-insert-a (<span class="ef-t">&amp;rest</span> _)
  <span class="ef-b">:after</span> #'org-cdlatex-environment-indent
  (org-edit-latex-environment))

(<span class="ef-k">cl-defmacro</span> <span class="ef-f">lsp-org-babel-enable</span> (lang)
  <span class="ef-d">"Support LANG in org source code block."</span>
  (<span class="ef-k">setq</span> centaur-lsp 'lsp-mode)
  (<span class="ef-wr">cl-check-type</span> lang string)
  (<span class="ef-k">let*</span> ((edit-pre (intern (format <span class="ef-s">"org-babel-edit-prep:%s"</span> lang)))
         (intern-pre (intern (format <span class="ef-s">"lsp--%s"</span> (symbol-name edit-pre)))))
    `(<span class="ef-k">progn</span>
       (<span class="ef-k">defun</span> ,intern-pre (info)
         (<span class="ef-k">let</span> ((file-name (<span class="ef-k">-&gt;&gt;</span> info caddr (alist-get <span class="ef-b">:file</span>))))
           (<span class="ef-k">unless</span> file-name
             (<span class="ef-k">setq</span> file-name (make-temp-file <span class="ef-s">"babel-lsp-"</span>)))
           (<span class="ef-k">setq</span> buffer-file-name file-name)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format <span class="ef-s">"Enable lsp-mode in the buffer of org source block (%s)."</span>
                    (upcase ,lang)))
       (<span class="ef-k">if</span> (fboundp ',edit-pre)
           (advice-add ',edit-pre <span class="ef-b">:after</span> ',intern-pre)
         (<span class="ef-k">progn</span>
           (<span class="ef-k">defun</span> ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format <span class="ef-s">"Prepare local buffer environment for org source block (%s)."</span>
                        (upcase ,lang))))))))
(<span class="ef-k">defvar</span> <span class="ef-v">org-babel-lang-list</span>
  '(<span class="ef-s">"go"</span> <span class="ef-s">"python"</span> <span class="ef-s">"ipython"</span> <span class="ef-s">"bash"</span> <span class="ef-s">"sh"</span>))
(<span class="ef-k">dolist</span> (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))

(map! <span class="ef-b">:map</span> org-mode-map
      <span class="ef-b">:localleader</span>
      <span class="ef-b">:desc</span> <span class="ef-s">"View exported file"</span> <span class="ef-s">"v"</span> #'org-view-output-file)

(<span class="ef-k">defun</span> <span class="ef-f">org-view-output-file</span> (<span class="ef-t">&amp;optional</span> org-file-path)
  <span class="ef-d">"Visit buffer open on the first output file (if any) found, using `</span><span style="color: #b751b6; text-decoration: italic;">org-view-output-file-extensions</span><span class="ef-d">'"</span>
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">let*</span> ((org-file-path (<span class="ef-k">or</span> org-file-path (buffer-file-name) <span class="ef-s">""</span>))
         (dir (file-name-directory org-file-path))
         (basename (file-name-base org-file-path))
         (output-file nil))
    (<span class="ef-k">dolist</span> (ext org-view-output-file-extensions)
      (<span class="ef-k">unless</span> output-file
        (<span class="ef-k">when</span> (file-exists-p
               (concat dir basename <span class="ef-s">"."</span> ext))
          (<span class="ef-k">setq</span> output-file (concat dir basename <span class="ef-s">"."</span> ext)))))
    (<span class="ef-k">if</span> output-file
        (<span class="ef-k">if</span> (member (file-name-extension output-file) org-view-external-file-extensions)
            (browse-url-xdg-open output-file)
          (pop-to-buffer (<span class="ef-k">or</span> (find-buffer-visiting output-file)
                             (find-file-noselect output-file))))
      (message <span class="ef-s">"No exported file found"</span>))))

(<span class="ef-k">defvar</span> <span class="ef-v">org-view-output-file-extensions</span> '(<span class="ef-s">"pdf"</span> <span class="ef-s">"md"</span> <span class="ef-s">"rst"</span> <span class="ef-s">"txt"</span> <span class="ef-s">"tex"</span> <span class="ef-s">"html"</span>)
  <span class="ef-d">"Search for output files with these extensions, in order, viewing the first that matches"</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-view-external-file-extensions</span> '(<span class="ef-s">"html"</span>)
  <span class="ef-d">"File formats that should be opened externally."</span>)

(use-package! doct
  <span class="ef-b">:commands</span> doct)

(<span class="ef-k">after!</span> org-capture
  (<span class="ef-k">defun</span> <span class="ef-f">org-capture-select-template-prettier</span> (<span class="ef-t">&amp;optional</span> keys)
    <span class="ef-d">"Select a capture template, in a prettier way than default
  Lisp programs can force the template by setting KEYS to a string."</span>
    (<span class="ef-k">let</span> ((org-capture-templates
           (<span class="ef-k">or</span> (org-contextualize-keys
                (org-capture-upgrade-templates org-capture-templates)
                org-capture-templates-contexts)
               '((<span class="ef-s">"t"</span> <span class="ef-s">"Task"</span> entry (file+headline <span class="ef-s">""</span> <span class="ef-s">"Tasks"</span>)
                  <span class="ef-s">"* TODO %?\n  %u\n  %a"</span>)))))
      (<span class="ef-k">if</span> keys
          (<span class="ef-k">or</span> (assoc keys org-capture-templates)
              (<span class="ef-wr">error</span> <span class="ef-s">"No capture template referred to by \"%s\" keys"</span> keys))
        (org-mks org-capture-templates
                 <span class="ef-s">"Select a capture template\nâââââââââââââââââââââââââ"</span>
                 <span class="ef-s">"Template key: "</span>
                 `((<span class="ef-s">"q"</span> ,(concat (nerd-icons-octicon <span class="ef-s">"nf-oct-stop"</span> <span class="ef-b">:face</span> 'nerd-icons-red <span class="ef-b">:v-adjust</span> 0.01) <span class="ef-s">"\tAbort"</span>)))))))
  (advice-add 'org-capture-select-template <span class="ef-b">:override</span> #'org-capture-select-template-prettier)
  
  (<span class="ef-k">defun</span> <span class="ef-f">org-mks-pretty</span> (table title <span class="ef-t">&amp;optional</span> prompt specials)
    <span class="ef-d">"Select a member of an alist with multiple keys. Prettified.
  
  TABLE is the alist which should contain entries where the car is a string.
  There should be two types of entries.
  
  1. prefix descriptions like (\"a\" \"Description\")
     This indicates that `</span><span style="color: #b751b6; text-decoration: italic;">a</span><span class="ef-d">' is a prefix key for multi-letter selection, and
     that there are entries following with keys like \"ab\", \"ax\"â¦
  
  2. Select-able members must have more than two elements, with the first
     being the string of keys that lead to selecting it, and the second a
     short description string of the item.
  
  The command will then make a temporary buffer listing all entries
  that can be selected with a single key, and all the single key
  prefixes.  When you press the key for a single-letter entry, it is selected.
  When you press a prefix key, the commands (and maybe further prefixes)
  under this key will be shown and offered for selection.
  
  TITLE will be placed over the selection in the temporary buffer,
  PROMPT will be used when prompting for a key.  SPECIALS is an
  alist with (\"key\" \"description\") entries.  When one of these
  is selected, only the bare key is returned."</span>
    (<span class="ef-k">save-window-excursion</span>
      (<span class="ef-k">let</span> ((inhibit-quit t)
            (buffer (org-switch-to-buffer-other-window <span class="ef-s">"*Org Select*"</span>))
            (prompt (<span class="ef-k">or</span> prompt <span class="ef-s">"Select: "</span>))
            case-fold-search
            current)
        (<span class="ef-k">unwind-protect</span>
            (<span class="ef-k">catch</span> '<span class="ef-o">exit</span>
              (<span class="ef-k">while</span> t
                (<span class="ef-k">setq-local</span> evil-normal-state-cursor (list nil))
                (erase-buffer)
                (insert title <span class="ef-s">"\n\n"</span>)
                (<span class="ef-k">let</span> ((des-keys nil)
                      (allowed-keys '(<span class="ef-s">"\C-g"</span>))
                      (tab-alternatives '(<span class="ef-s">"\s"</span> <span class="ef-s">"\t"</span> <span class="ef-s">"\r"</span>))
                      (cursor-type nil))
                  <span class="ef-cd">;; </span><span class="ef-c">Populate allowed keys and descriptions keys
</span>                  <span class="ef-cd">;; </span><span class="ef-c">available with CURRENT selector.
</span>                  (<span class="ef-k">let</span> ((re (format <span class="ef-s">"\\`%s</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">\\'"</span>
                                    (<span class="ef-k">if</span> current (regexp-quote current) <span class="ef-s">""</span>)))
                        (prefix (<span class="ef-k">if</span> current (concat current <span class="ef-s">" "</span>) <span class="ef-s">""</span>)))
                    (<span class="ef-k">dolist</span> (entry table)
                      (<span class="ef-k">pcase</span> entry
                        <span class="ef-cd">;; </span><span class="ef-c">Description.
</span>                        (`(,(<span class="ef-k">and</span> key (pred (string-match re))) ,desc)
                         (<span class="ef-k">let</span> ((k (match-string 1 key)))
                           (<span class="ef-k">push</span> k des-keys)
                           <span class="ef-cd">;; </span><span class="ef-c">Keys ending in tab, space or RET are equivalent.
</span>                           (<span class="ef-k">if</span> (member k tab-alternatives)
                               (<span class="ef-k">push</span> <span class="ef-s">"\t"</span> allowed-keys)
                             (<span class="ef-k">push</span> k allowed-keys))
                           (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) (propertize <span class="ef-s">"âº"</span> 'face 'font-lock-comment-face) <span class="ef-s">"  "</span> desc <span class="ef-s">"â¦"</span> <span class="ef-s">"\n"</span>)))
                        <span class="ef-cd">;; </span><span class="ef-c">Usable entry.
</span>                        (`(,(<span class="ef-k">and</span> key (pred (string-match re))) ,desc . ,_)
                         (<span class="ef-k">let</span> ((k (match-string 1 key)))
                           (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) <span class="ef-s">"   "</span> desc <span class="ef-s">"\n"</span>)
                           (<span class="ef-k">push</span> k allowed-keys)))
                        (_ nil))))
                  <span class="ef-cd">;; </span><span class="ef-c">Insert special entries, if any.
</span>                  (<span class="ef-k">when</span> specials
                    (insert <span class="ef-s">"âââââââââââââââââââââââââ\n"</span>)
                    (<span class="ef-k">pcase-dolist</span> (`(,key ,description) specials)
                      (insert (format <span class="ef-s">"%s   %s\n"</span> (propertize key 'face '(bold nerd-icons-red)) description))
                      (<span class="ef-k">push</span> key allowed-keys)))
                  <span class="ef-cd">;; </span><span class="ef-c">Display UI and let user select an entry or
</span>                  <span class="ef-cd">;; </span><span class="ef-c">a sub-level prefix.
</span>                  (goto-char (point-min))
                  (<span class="ef-k">unless</span> (pos-visible-in-window-p (point-max))
                    (org-fit-window-to-buffer))
                  (<span class="ef-k">let</span> ((pressed (org--mks-read-key allowed-keys
                                                    prompt
                                                    (not (pos-visible-in-window-p (1- (point-max)))))))
                    (<span class="ef-k">setq</span> current (concat current pressed))
                    (<span class="ef-k">cond</span>
                     ((equal pressed <span class="ef-s">"\C-g"</span>) (<span class="ef-wr">user-error</span> <span class="ef-s">"Abort"</span>))
                     <span class="ef-cd">;; </span><span class="ef-c">Selection is a prefix: open a new menu.
</span>                     ((member pressed des-keys))
                     <span class="ef-cd">;; </span><span class="ef-c">Selection matches an association: return it.
</span>                     ((<span class="ef-k">let</span> ((entry (assoc current table)))
                        (<span class="ef-k">and</span> entry (<span class="ef-k">throw</span> '<span class="ef-o">exit</span> entry))))
                     <span class="ef-cd">;; </span><span class="ef-c">Selection matches a special entry: return the
</span>                     <span class="ef-cd">;; </span><span class="ef-c">selection prefix.
</span>                     ((assoc current specials) (<span class="ef-k">throw</span> '<span class="ef-o">exit</span> current))
                     (t (<span class="ef-wr">error</span> <span class="ef-s">"No entry available"</span>)))))))
          (<span class="ef-k">when</span> buffer (kill-buffer buffer))))))
  (advice-add 'org-mks <span class="ef-b">:override</span> #'org-mks-pretty)

  (<span class="ef-k">defun</span> <span class="ef-f">+doct-icon-declaration-to-icon</span> (declaration)
    <span class="ef-d">"Convert :icon declaration to icon"</span>
    (<span class="ef-k">let</span> ((name (<span class="ef-k">pop</span> declaration))
          (set  (intern (concat <span class="ef-s">"nerd-icons-"</span> (plist-get declaration <span class="ef-b">:set</span>))))
          (face (intern (concat <span class="ef-s">"nerd-icons-"</span> (plist-get declaration <span class="ef-b">:color</span>))))
          (v-adjust (<span class="ef-k">or</span> (plist-get declaration <span class="ef-b">:v-adjust</span>) 0.01)))
      (apply set `(,name <span class="ef-b">:face</span> ,face <span class="ef-b">:v-adjust</span> ,v-adjust))))

  (<span class="ef-k">defun</span> <span class="ef-f">+doct-iconify-capture-templates</span> (groups)
    <span class="ef-d">"Add declaration's :icon to each template group in GROUPS."</span>
    (<span class="ef-k">let</span> ((templates (doct-flatten-lists-in groups)))
      (<span class="ef-k">setq</span> doct-templates (mapcar (<span class="ef-k">lambda</span> (template)
                                     (<span class="ef-k">when-let*</span> ((props (nthcdr (<span class="ef-k">if</span> (= (length template) 4) 2 5) template))
                                                 (spec (plist-get (plist-get props <span class="ef-b">:doct</span>) <span class="ef-b">:icon</span>)))
                                       (<span class="ef-k">setf</span> (nth 1 template) (concat (+doct-icon-declaration-to-icon spec)
                                                                      <span class="ef-s">"\t"</span>
                                                                      (nth 1 template))))
                                     template)
                                   templates))))

  (<span class="ef-k">setq</span> doct-after-conversion-functions '(+doct-iconify-capture-templates))

  (<span class="ef-k">defvar</span> <span class="ef-v">+org-capture-recipies</span>  <span class="ef-s">"~/Desktop/TEC/Organisation/recipies.org"</span>)

  (<span class="ef-k">defun</span> <span class="ef-f">set-org-capture-templates</span> ()
    (<span class="ef-k">setq</span> org-capture-templates
          (doct `((<span class="ef-s">"Personal todo"</span> <span class="ef-b">:keys</span> <span class="ef-s">"t"</span>
                   <span class="ef-b">:icon</span> (<span class="ef-s">"nf-oct-checklist"</span> <span class="ef-b">:set</span> <span class="ef-s">"octicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"green"</span>)
                   <span class="ef-b">:file</span> +org-capture-todo-file
                   <span class="ef-b">:prepend</span> t
                   <span class="ef-b">:headline</span> <span class="ef-s">"Inbox"</span>
                   <span class="ef-b">:type</span> entry
                   <span class="ef-b">:template</span> (<span class="ef-s">"* TODO %?"</span>
                              <span class="ef-s">"%i %a"</span>))
                  (<span class="ef-s">"Personal note"</span> <span class="ef-b">:keys</span> <span class="ef-s">"n"</span>
                   <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-sticky_note_o"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"green"</span>)
                   <span class="ef-b">:file</span> +org-capture-todo-file
                   <span class="ef-b">:prepend</span> t
                   <span class="ef-b">:headline</span> <span class="ef-s">"Inbox"</span>
                   <span class="ef-b">:type</span> entry
                   <span class="ef-b">:template</span> (<span class="ef-s">"* %?"</span>
                              <span class="ef-s">"%i %a"</span>))
                  (<span class="ef-s">"Email"</span> <span class="ef-b">:keys</span> <span class="ef-s">"e"</span>
                   <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-envelope"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"blue"</span>)
                   <span class="ef-b">:file</span> +org-capture-todo-file
                   <span class="ef-b">:prepend</span> t
                   <span class="ef-b">:headline</span> <span class="ef-s">"Inbox"</span>
                   <span class="ef-b">:type</span> entry
                   <span class="ef-b">:template</span> (<span class="ef-s">"* TODO %^{type|reply to|contact} %\\3 %? :email:"</span>
                              <span class="ef-s">"Send an email %^{urgancy|soon|ASAP|anon|at some point|eventually} to %^{recipiant}"</span>
                              <span class="ef-s">"about %^{topic}"</span>
                              <span class="ef-s">"%U %i %a"</span>))
                  (<span class="ef-s">"Interesting"</span> <span class="ef-b">:keys</span> <span class="ef-s">"i"</span>
                   <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-eye"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"lcyan"</span>)
                   <span class="ef-b">:file</span> +org-capture-todo-file
                   <span class="ef-b">:prepend</span> t
                   <span class="ef-b">:headline</span> <span class="ef-s">"Interesting"</span>
                   <span class="ef-b">:type</span> entry
                   <span class="ef-b">:template</span> (<span class="ef-s">"* [ ] %{desc}%? :%{i-type}:"</span>
                              <span class="ef-s">"%i %a"</span>)
                   <span class="ef-b">:children</span> ((<span class="ef-s">"Webpage"</span> <span class="ef-b">:keys</span> <span class="ef-s">"w"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-globe"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"green"</span>)
                               <span class="ef-b">:desc</span> <span class="ef-s">"%(org-cliplink-capture) "</span>
                               <span class="ef-b">:i-type</span> <span class="ef-s">"read:web"</span>)
                              (<span class="ef-s">"Article"</span> <span class="ef-b">:keys</span> <span class="ef-s">"a"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-file_text_o"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"yellow"</span>)
                               <span class="ef-b">:desc</span> <span class="ef-s">""</span>
                               <span class="ef-b">:i-type</span> <span class="ef-s">"read:reaserch"</span>)
                              (<span class="ef-s">"\tRecipie"</span> <span class="ef-b">:keys</span> <span class="ef-s">"r"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-spoon"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"dorange"</span>)
                               <span class="ef-b">:file</span> +org-capture-recipies
                               <span class="ef-b">:headline</span> <span class="ef-s">"Unsorted"</span>
                               <span class="ef-b">:template</span> <span class="ef-s">"%(org-chef-get-recipe-from-url)"</span>)
                              (<span class="ef-s">"Information"</span> <span class="ef-b">:keys</span> <span class="ef-s">"i"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-info_circle"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"blue"</span>)
                               <span class="ef-b">:desc</span> <span class="ef-s">""</span>
                               <span class="ef-b">:i-type</span> <span class="ef-s">"read:info"</span>)
                              (<span class="ef-s">"Idea"</span> <span class="ef-b">:keys</span> <span class="ef-s">"I"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-md-chart_bubble"</span> <span class="ef-b">:set</span> <span class="ef-s">"mdicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"silver"</span>)
                               <span class="ef-b">:desc</span> <span class="ef-s">""</span>
                               <span class="ef-b">:i-type</span> <span class="ef-s">"idea"</span>)))
                  (<span class="ef-s">"Tasks"</span> <span class="ef-b">:keys</span> <span class="ef-s">"k"</span>
                   <span class="ef-b">:icon</span> (<span class="ef-s">"nf-oct-inbox"</span> <span class="ef-b">:set</span> <span class="ef-s">"octicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"yellow"</span>)
                   <span class="ef-b">:file</span> +org-capture-todo-file
                   <span class="ef-b">:prepend</span> t
                   <span class="ef-b">:headline</span> <span class="ef-s">"Tasks"</span>
                   <span class="ef-b">:type</span> entry
                   <span class="ef-b">:template</span> (<span class="ef-s">"* TODO %? %^G%{extra}"</span>
                              <span class="ef-s">"%i %a"</span>)
                   <span class="ef-b">:children</span> ((<span class="ef-s">"General Task"</span> <span class="ef-b">:keys</span> <span class="ef-s">"k"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-oct-inbox"</span> <span class="ef-b">:set</span> <span class="ef-s">"octicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"yellow"</span>)
                               <span class="ef-b">:extra</span> <span class="ef-s">""</span>)
                              (<span class="ef-s">"Task with deadline"</span> <span class="ef-b">:keys</span> <span class="ef-s">"d"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-md-timer"</span> <span class="ef-b">:set</span> <span class="ef-s">"mdicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"orange"</span> <span class="ef-b">:v-adjust</span> -0.1)
                               <span class="ef-b">:extra</span> <span class="ef-s">"\nDEADLINE: %^{Deadline:}t"</span>)
                              (<span class="ef-s">"Scheduled Task"</span> <span class="ef-b">:keys</span> <span class="ef-s">"s"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-oct-calendar"</span> <span class="ef-b">:set</span> <span class="ef-s">"octicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"orange"</span>)
                               <span class="ef-b">:extra</span> <span class="ef-s">"\nSCHEDULED: %^{Start time:}t"</span>)))
                  (<span class="ef-s">"Project"</span> <span class="ef-b">:keys</span> <span class="ef-s">"p"</span>
                   <span class="ef-b">:icon</span> (<span class="ef-s">"nf-oct-repo"</span> <span class="ef-b">:set</span> <span class="ef-s">"octicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"silver"</span>)
                   <span class="ef-b">:prepend</span> t
                   <span class="ef-b">:type</span> entry
                   <span class="ef-b">:headline</span> <span class="ef-s">"Inbox"</span>
                   <span class="ef-b">:template</span> (<span class="ef-s">"* %{time-or-todo} %?"</span>
                              <span class="ef-s">"%i"</span>
                              <span class="ef-s">"%a"</span>)
                   <span class="ef-b">:file</span> <span class="ef-s">""</span>
                   <span class="ef-b">:custom</span> (<span class="ef-b">:time-or-todo</span> <span class="ef-s">""</span>)
                   <span class="ef-b">:children</span> ((<span class="ef-s">"Project-local todo"</span> <span class="ef-b">:keys</span> <span class="ef-s">"t"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-oct-checklist"</span> <span class="ef-b">:set</span> <span class="ef-s">"octicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"green"</span>)
                               <span class="ef-b">:time-or-todo</span> <span class="ef-s">"TODO"</span>
                               <span class="ef-b">:file</span> +org-capture-project-todo-file)
                              (<span class="ef-s">"Project-local note"</span> <span class="ef-b">:keys</span> <span class="ef-s">"n"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-sticky_note"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"yellow"</span>)
                               <span class="ef-b">:time-or-todo</span> <span class="ef-s">"%U"</span>
                               <span class="ef-b">:file</span> +org-capture-project-notes-file)
                              (<span class="ef-s">"Project-local changelog"</span> <span class="ef-b">:keys</span> <span class="ef-s">"c"</span>
                               <span class="ef-b">:icon</span> (<span class="ef-s">"nf-fa-list"</span> <span class="ef-b">:set</span> <span class="ef-s">"faicon"</span> <span class="ef-b">:color</span> <span class="ef-s">"blue"</span>)
                               <span class="ef-b">:time-or-todo</span> <span class="ef-s">"%U"</span>
                               <span class="ef-b">:heading</span> <span class="ef-s">"Unreleased"</span>
                               <span class="ef-b">:file</span> +org-capture-project-changelog-file)))
                  (<span class="ef-s">"\tCentralised project templates"</span>
                   <span class="ef-b">:keys</span> <span class="ef-s">"o"</span>
                   <span class="ef-b">:type</span> entry
                   <span class="ef-b">:prepend</span> t
                   <span class="ef-b">:template</span> (<span class="ef-s">"* %{time-or-todo} %?"</span>
                              <span class="ef-s">"%i"</span>
                              <span class="ef-s">"%a"</span>)
                   <span class="ef-b">:children</span> ((<span class="ef-s">"Project todo"</span>
                               <span class="ef-b">:keys</span> <span class="ef-s">"t"</span>
                               <span class="ef-b">:prepend</span> nil
                               <span class="ef-b">:time-or-todo</span> <span class="ef-s">"TODO"</span>
                               <span class="ef-b">:heading</span> <span class="ef-s">"Tasks"</span>
                               <span class="ef-b">:file</span> +org-capture-central-project-todo-file)
                              (<span class="ef-s">"Project note"</span>
                               <span class="ef-b">:keys</span> <span class="ef-s">"n"</span>
                               <span class="ef-b">:time-or-todo</span> <span class="ef-s">"%U"</span>
                               <span class="ef-b">:heading</span> <span class="ef-s">"Notes"</span>
                               <span class="ef-b">:file</span> +org-capture-central-project-notes-file)
                              (<span class="ef-s">"Project changelog"</span>
                               <span class="ef-b">:keys</span> <span class="ef-s">"c"</span>
                               <span class="ef-b">:time-or-todo</span> <span class="ef-s">"%U"</span>
                               <span class="ef-b">:heading</span> <span class="ef-s">"Unreleased"</span>
                               <span class="ef-b">:file</span> +org-capture-central-project-changelog-file)))))))

  (set-org-capture-templates)
  (<span class="ef-k">unless</span> (display-graphic-p)
    (add-hook 'server-after-make-frame-hook
              (<span class="ef-k">defun</span> <span class="ef-f">org-capture-reinitialise-hook</span> ()
                (<span class="ef-k">when</span> (display-graphic-p)
                  (set-org-capture-templates)
                  (remove-hook 'server-after-make-frame-hook
                               #'org-capture-reinitialise-hook))))))

(<span class="ef-k">setf</span> (alist-get 'height +org-capture-frame-parameters) 15)
<span class="ef-cd">;; </span><span class="ef-c">(alist-get 'name +org-capture-frame-parameters) "â Capture") ;; ATM hardcoded in other places, so changing breaks stuff
</span>(<span class="ef-k">setq</span> +org-capture-fn
      (<span class="ef-k">lambda</span> ()
        (<span class="ef-k">interactive</span>)
        (set-window-parameter nil 'mode-line-format 'none)
        (org-capture)))

(<span class="ef-k">defun</span> <span class="ef-f">unpackaged/org-element-descendant-of</span> (type element)
  <span class="ef-d">"Return non-nil if ELEMENT is a descendant of TYPE.
TYPE should be an element type, like `</span><span style="color: #b751b6; text-decoration: italic;">item</span><span class="ef-d">' or `</span><span style="color: #b751b6; text-decoration: italic;">paragraph</span><span class="ef-d">'.
ELEMENT should be a list like that returned by `</span><span style="color: #b751b6; text-decoration: italic;">org-element-context</span><span class="ef-d">'."</span>
  <span class="ef-cd">;; </span><span class="ef-c">MAYBE: Use `</span><span style="color: #b751b6;">org-element-lineage</span><span class="ef-c">'.
</span>  (<span class="ef-k">when-let*</span> ((parent (org-element-property <span class="ef-b">:parent</span> element)))
    (<span class="ef-k">or</span> (eq type (car parent))
        (unpackaged/org-element-descendant-of type parent))))

<span class="ef-cd">;;;</span><span class="ef-c">###</span><span style="color: #986801;">autoload</span>
(<span class="ef-k">defun</span> <span class="ef-f">unpackaged/org-return-dwim</span> (<span class="ef-t">&amp;optional</span> default)
  <span class="ef-d">"A helpful replacement for `</span><span style="color: #b751b6; text-decoration: italic;">org-return-indent</span><span class="ef-d">'.  With prefix, call `</span><span style="color: #b751b6; text-decoration: italic;">org-return-indent</span><span class="ef-d">'.

On headings, move point to position after entry content.  In
lists, insert a new item or end the list, with checkbox if
appropriate.  In tables, insert a new row or end the table."</span>
  <span class="ef-cd">;; </span><span class="ef-c">Inspired by John Kitchin: http://kitchingroup.cheme.cmu.edu/blog/2017/04/09/A-better-return-in-org-mode/
</span>  (<span class="ef-k">interactive</span> <span class="ef-s">"P"</span>)
  (<span class="ef-k">if</span> default
      (org-return t)
    (<span class="ef-k">cond</span>
     <span class="ef-cd">;; </span><span class="ef-c">Act depending on context around point.
</span>
     <span class="ef-cd">;; </span><span class="ef-c">NOTE: I prefer RET to not follow links, but by uncommenting this block, links will be
</span>     <span class="ef-cd">;; </span><span class="ef-c">followed.
</span>
     <span class="ef-cd">;; </span><span class="ef-c">((eq 'link (car (org-element-context)))
</span>     <span class="ef-cd">;;  </span><span class="ef-c">;; Link: Open it.
</span>     <span class="ef-cd">;;  </span><span class="ef-c">(org-open-at-point-global))
</span>
     ((org-at-heading-p)
      <span class="ef-cd">;; </span><span class="ef-c">Heading: Move to position after entry content.
</span>      <span class="ef-cd">;; </span><span class="ef-c">NOTE: This is probably the most interesting feature of this function.
</span>      (<span class="ef-k">let</span> ((heading-start (org-entry-beginning-position)))
        (goto-char (org-entry-end-position))
        (<span class="ef-k">cond</span> ((<span class="ef-k">and</span> (org-at-heading-p)
                    (= heading-start (org-entry-beginning-position)))
               <span class="ef-cd">;; </span><span class="ef-c">Entry ends on its heading; add newline after
</span>               (end-of-line)
               (insert <span class="ef-s">"\n\n"</span>))
              (t
               <span class="ef-cd">;; </span><span class="ef-c">Entry ends after its heading; back up
</span>               (forward-line -1)
               (end-of-line)
               (<span class="ef-k">when</span> (org-at-heading-p)
                 <span class="ef-cd">;; </span><span class="ef-c">At the same heading
</span>                 (forward-line)
                 (insert <span class="ef-s">"\n"</span>)
                 (forward-line -1))
               (<span class="ef-k">while</span> (not (looking-back <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">[[:blank:]]?\n</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">\\{</span><span style="color: #6a1868;">3\\</span><span class="ef-s">}"</span> nil))
                 (insert <span class="ef-s">"\n"</span>))
               (forward-line -1)))))

     ((org-at-item-checkbox-p)
      <span class="ef-cd">;; </span><span class="ef-c">Checkbox: Insert new item with checkbox.
</span>      (org-insert-todo-heading nil))

     ((org-in-item-p)
      <span class="ef-cd">;; </span><span class="ef-c">Plain list.  Yes, this gets a little complicated...
</span>      (<span class="ef-k">let</span> ((context (org-element-context)))
        (<span class="ef-k">if</span> (<span class="ef-k">or</span> (eq 'plain-list (car context))  <span class="ef-cd">; </span><span class="ef-c">First item in list
</span>                (<span class="ef-k">and</span> (eq 'item (car context))
                     (not (eq (org-element-property <span class="ef-b">:contents-begin</span> context)
                              (org-element-property <span class="ef-b">:contents-end</span> context))))
                (unpackaged/org-element-descendant-of 'item context))  <span class="ef-cd">; </span><span class="ef-c">Element in list item, e.g. a link
</span>            <span class="ef-cd">;; </span><span class="ef-c">Non-empty item: Add new item.
</span>            (org-insert-item)
          <span class="ef-cd">;; </span><span class="ef-c">Empty item: Close the list.
</span>          <span class="ef-cd">;; </span><span class="ef-c">TODO: Do this with org functions rather than operating on the text. Can't seem to find the right function.
</span>          (delete-region (line-beginning-position) (line-end-position))
          (insert <span class="ef-s">"\n"</span>))))

     ((<span class="ef-k">when</span> (fboundp 'org-inlinetask-in-task-p)
        (org-inlinetask-in-task-p))
      <span class="ef-cd">;; </span><span class="ef-c">Inline task: Don't insert a new heading.
</span>      (org-return t))

     ((org-at-table-p)
      (<span class="ef-k">cond</span> ((<span class="ef-k">save-excursion</span>
               (beginning-of-line)
               <span class="ef-cd">;; </span><span class="ef-c">See `</span><span style="color: #b751b6;">org-table-next-field</span><span class="ef-c">'.
</span>               (<span class="ef-k">cl-loop</span> with end = (line-end-position)
                        for cell = (org-element-table-cell-parser)
                        always (equal (org-element-property <span class="ef-b">:contents-begin</span> cell)
                                      (org-element-property <span class="ef-b">:contents-end</span> cell))
                        while (re-search-forward <span class="ef-s">"|"</span> end t)))
             <span class="ef-cd">;; </span><span class="ef-c">Empty row: end the table.
</span>             (delete-region (line-beginning-position) (line-end-position))
             (org-return t))
            (t
             <span class="ef-cd">;; </span><span class="ef-c">Non-empty row: call `</span><span style="color: #b751b6;">org-return-indent</span><span class="ef-c">'.
</span>             (org-return t))))
     (t
      <span class="ef-cd">;; </span><span class="ef-c">All other cases: call `</span><span style="color: #b751b6;">org-return-indent</span><span class="ef-c">'.
</span>      (org-return t)))))

(map!
 <span class="ef-b">:after</span> evil-org
 <span class="ef-b">:map</span> evil-org-mode-map
 <span class="ef-b">:i</span> [return] #'unpackaged/org-return-dwim)

(<span class="ef-k">defun</span> <span class="ef-f">+yas/org-src-header-p</span> ()
  <span class="ef-d">"Determine whether `</span><span style="color: #b751b6; text-decoration: italic;">point</span><span class="ef-d">' is within a src-block header or header-args."</span>
  (<span class="ef-k">pcase</span> (org-element-type (org-element-context))
    ('src-block (&lt; (point) <span class="ef-cd">; </span><span class="ef-c">before code part of the src-block
</span>                   (<span class="ef-k">save-excursion</span> (goto-char (org-element-property <span class="ef-b">:begin</span> (org-element-context)))
                                   (forward-line 1)
                                   (point))))
    ('inline-src-block (&lt; (point) <span class="ef-cd">; </span><span class="ef-c">before code part of the inline-src-block
</span>                          (<span class="ef-k">save-excursion</span> (goto-char (org-element-property <span class="ef-b">:begin</span> (org-element-context)))
                                          (search-forward <span class="ef-s">"]{"</span>)
                                          (point))))
    ('keyword (string-match-p <span class="ef-s">"^header-args"</span> (org-element-property <span class="ef-b">:value</span> (org-element-context))))))

(<span class="ef-k">defun</span> <span class="ef-f">+yas/org-prompt-header-arg</span> (arg question values)
  <span class="ef-d">"Prompt the user to set ARG header property to one of VALUES with QUESTION.
The default value is identified and indicated. If either default is selected,
or no selection is made: nil is returned."</span>
  (<span class="ef-k">let*</span> ((src-block-p (not (looking-back <span class="ef-s">"^#\\+property:[ \t]+header-args:.*"</span> (line-beginning-position))))
         (default
           (<span class="ef-k">or</span>
            (cdr (assoc arg
                        (<span class="ef-k">if</span> src-block-p
                            (nth 2 (org-babel-get-src-block-info t))
                          (org-babel-merge-params
                           org-babel-default-header-args
                           (<span class="ef-k">let</span> ((lang-headers
                                  (intern (concat <span class="ef-s">"org-babel-default-header-args:"</span>
                                                  (+yas/org-src-lang)))))
                             (<span class="ef-k">when</span> (boundp lang-headers) (eval lang-headers t)))))))
            <span class="ef-s">""</span>))
         default-value)
    (<span class="ef-k">setq</span> values (mapcar
                  (<span class="ef-k">lambda</span> (value)
                    (<span class="ef-k">if</span> (string-match-p (regexp-quote value) default)
                        (<span class="ef-k">setq</span> default-value
                              (concat value <span class="ef-s">" "</span>
                                      (propertize <span class="ef-s">"(default)"</span> 'face 'font-lock-doc-face)))
                      value))
                  values))
    (<span class="ef-k">let</span> ((selection (consult--read values <span class="ef-b">:prompt</span> question <span class="ef-b">:default</span> default-value)))
      (<span class="ef-k">unless</span> (<span class="ef-k">or</span> (string-match-p <span class="ef-s">"(default)$"</span> selection)
                  (string= <span class="ef-s">""</span> selection))
        selection))))

(<span class="ef-k">defun</span> <span class="ef-f">+yas/org-src-lang</span> ()
  <span class="ef-d">"Try to find the current language of the src/header at `</span><span style="color: #b751b6; text-decoration: italic;">point</span><span class="ef-d">'.
Return nil otherwise."</span>
  (<span class="ef-k">let</span> ((context (org-element-context)))
    (<span class="ef-k">pcase</span> (org-element-type context)
      ('src-block (org-element-property <span class="ef-b">:language</span> context))
      ('inline-src-block (org-element-property <span class="ef-b">:language</span> context))
      ('keyword (<span class="ef-k">when</span> (string-match <span class="ef-s">"^header-args:</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s"> ]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> (org-element-property <span class="ef-b">:value</span> context))
                  (match-string 1 (org-element-property <span class="ef-b">:value</span> context)))))))

(<span class="ef-k">defun</span> <span class="ef-f">+yas/org-last-src-lang</span> ()
  <span class="ef-d">"Return the language of the last src-block, if it exists."</span>
  (<span class="ef-k">save-excursion</span>
    (beginning-of-line)
    (<span class="ef-k">when</span> (re-search-backward <span class="ef-s">"^[ \t]*#\\+begin_src"</span> nil t)
      (org-element-property <span class="ef-b">:language</span> (org-element-context)))))

(<span class="ef-k">defun</span> <span class="ef-f">+yas/org-most-common-no-property-lang</span> ()
  <span class="ef-d">"Find the lang with the most source blocks that has no global header-args, else nil."</span>
  (<span class="ef-k">let</span> (src-langs header-langs)
    (<span class="ef-k">save-excursion</span>
      (goto-char (point-min))
      (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"^[ \t]*#\\+begin_src"</span> nil t)
        (<span class="ef-k">push</span> (+yas/org-src-lang) src-langs))
      (goto-char (point-min))
      (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"^[ \t]*#\\+property: +header-args"</span> nil t)
        (<span class="ef-k">push</span> (+yas/org-src-lang) header-langs)))

    (<span class="ef-k">setq</span> src-langs
          (mapcar #'car
                  <span class="ef-cd">;; </span><span class="ef-c">sort alist by frequency (desc.)
</span>                  (sort
                   <span class="ef-cd">;; </span><span class="ef-c">generate alist with form (value . frequency)
</span>                   (<span class="ef-k">cl-loop</span> for (n . m) in (seq-group-by #'identity src-langs)
                            collect (cons n (length m)))
                   (<span class="ef-k">lambda</span> (a b) (&gt; (cdr a) (cdr b))))))

    (car (cl-set-difference src-langs header-langs <span class="ef-b">:test</span> #'string=))))

(<span class="ef-k">defun</span> <span class="ef-f">org-syntax-convert-keyword-case-to-lower</span> ()
  <span class="ef-d">"Convert all #+KEYWORDS to #+keywords."</span>
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">save-excursion</span>
    (goto-char (point-min))
    (<span class="ef-k">let</span> ((count 0)
          (case-fold-search nil))
      (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"^[ \t]*#\\+[A-Z_]+"</span> nil t)
        (<span class="ef-k">unless</span> (string-match-p <span class="ef-s">"RESULTS"</span> (match-string 0))
          (replace-match (downcase (match-string 0)) t)
          (<span class="ef-k">setq</span> count (1+ count))))
      (message <span class="ef-s">"Replaced %d occurances"</span> count))))

(org-link-set-parameters <span class="ef-s">"xkcd"</span>
                         <span class="ef-b">:image-data-fun</span> #'+org-xkcd-image-fn
                         <span class="ef-b">:follow</span> #'+org-xkcd-open-fn
                         <span class="ef-b">:export</span> #'+org-xkcd-export
                         <span class="ef-b">:complete</span> #'+org-xkcd-complete)

(<span class="ef-k">defun</span> <span class="ef-f">+org-xkcd-open-fn</span> (link)
  (+org-xkcd-image-fn nil link nil))

(<span class="ef-k">defun</span> <span class="ef-f">+org-xkcd-image-fn</span> (protocol link description)
  <span class="ef-d">"Get image data for xkcd num LINK"</span>
  (<span class="ef-k">let*</span> ((xkcd-info (+xkcd-fetch-info (string-to-number link)))
         (img (plist-get xkcd-info <span class="ef-b">:img</span>))
         (alt (plist-get xkcd-info <span class="ef-b">:alt</span>)))
    (message alt)
    (+org-image-file-data-fn protocol (xkcd-download img (string-to-number link)) description)))

(<span class="ef-k">defun</span> <span class="ef-f">+org-xkcd-export</span> (num desc backend _com)
  <span class="ef-d">"Convert xkcd to html/LaTeX form"</span>
  (<span class="ef-k">let*</span> ((xkcd-info (+xkcd-fetch-info (string-to-number num)))
         (img (plist-get xkcd-info <span class="ef-b">:img</span>))
         (alt (plist-get xkcd-info <span class="ef-b">:alt</span>))
         (title (plist-get xkcd-info <span class="ef-b">:title</span>))
         (file (xkcd-download img (string-to-number num))))
    (<span class="ef-k">cond</span> ((org-export-derived-backend-p backend 'html)
           (format <span class="ef-s">"&lt;img class='</span><span style="color: #b751b6;">invertible</span><span class="ef-s">' src='</span><span style="color: #b751b6;">%s</span><span class="ef-s">' title=\"%s\" alt='</span><span style="color: #b751b6;">%s</span><span class="ef-s">'&gt;"</span> img (subst-char-in-string ?\" ?<span class="ef-wr">â</span> alt) title))
          ((org-export-derived-backend-p backend 'latex)
           (format <span class="ef-s">"\\begin{figure}[!htb]
  \\centering
  \\includegraphics[scale=0.4]{%s}%s
\\end{figure}"</span> file (<span class="ef-k">if</span> (equal desc (format <span class="ef-s">"xkcd:%s"</span> num)) <span class="ef-s">""</span>
                      (format <span class="ef-s">"\n  \\caption*{\\label{xkcd:%s} %s}"</span>
                              num
                              (<span class="ef-k">or</span> desc
                                  (format <span class="ef-s">"\\textbf{%s} %s"</span> title alt))))))
          (t (format <span class="ef-s">"https://xkcd.com/%s"</span> num)))))

(<span class="ef-k">defun</span> <span class="ef-f">+org-xkcd-complete</span> (<span class="ef-t">&amp;optional</span> arg)
  <span class="ef-d">"Complete xkcd using `</span><span style="color: #b751b6; text-decoration: italic;">+xkcd-stored-info</span><span class="ef-d">'"</span>
  (format <span class="ef-s">"xkcd:%d"</span> (+xkcd-select)))

(org-link-set-parameters <span class="ef-s">"yt"</span> <span class="ef-b">:export</span> #'+org-export-yt)
(<span class="ef-k">defun</span> <span class="ef-f">+org-export-yt</span> (path desc backend _com)
  (<span class="ef-k">cond</span> ((org-export-derived-backend-p backend 'html)
         (format <span class="ef-s">"&lt;iframe width='</span><span style="color: #b751b6;">440</span><span class="ef-s">' \
height='</span><span style="color: #b751b6;">335</span><span class="ef-s">' \
src='</span><span style="color: #b751b6;">https://www.youtube.com/embed/%s</span><span class="ef-s">' \
frameborder='</span><span style="color: #b751b6;">0</span><span class="ef-s">' \
allowfullscreen&gt;%s&lt;/iframe&gt;"</span> path (<span class="ef-k">or</span> <span class="ef-s">""</span> desc)))
        ((org-export-derived-backend-p backend 'latex)
         (format <span class="ef-s">"\\href{https://youtu.be/%s}{%s}"</span> path (<span class="ef-k">or</span> desc <span class="ef-s">"youtube"</span>)))
        (t (format <span class="ef-s">"https://youtu.be/%s"</span> path))))

(<span class="ef-k">defadvice!</span> shut-up-org-problematic-hooks (orig-fn <span class="ef-t">&amp;rest</span> args)
  <span class="ef-b">:around</span> #'org-fancy-priorities-mode
  (<span class="ef-k">ignore-errors</span> (apply orig-fn args)))

(<span class="ef-k">provide</span> '<span class="ef-o">config-org-behaviour</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Org Citation
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-ref-to-org-cite</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-cite-csl-activate/enable</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: org-citation"</span> config)
(use-package! oc-csl-activate
  <span class="ef-b">:after</span> oc
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> org-cite-csl-activate-use-document-style t)
  (<span class="ef-k">defun</span> <span class="ef-f">+org-cite-csl-activate/enable</span> ()
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">setq</span> org-cite-activate-processor 'csl-activate)
    (<span class="ef-k">add-hook!</span> 'org-mode-hook '((<span class="ef-k">lambda</span> () (cursor-sensor-mode 1)) org-cite-csl-activate-render-all))
    (<span class="ef-k">defadvice!</span> +org-cite-csl-activate-render-all-silent (orig-fn)
      <span class="ef-b">:around</span> #'org-cite-csl-activate-render-all
      (<span class="ef-k">with-silent-modifications</span> (funcall orig-fn)))
    (<span class="ef-k">when</span> (eq major-mode 'org-mode)
      (<span class="ef-k">with-silent-modifications</span>
        (<span class="ef-k">save-excursion</span>
          (goto-char (point-min))
          (org-cite-activate (point-max)))
        (org-cite-csl-activate-render-all)))
    (fmakunbound #'+org-cite-csl-activate/enable)))

(<span class="ef-k">after!</span> citar
  (<span class="ef-k">setq</span> org-cite-global-bibliography
        (<span class="ef-k">let</span> ((libfile-search-names '(<span class="ef-s">"library.json"</span> <span class="ef-s">"Library.json"</span> <span class="ef-s">"library.bib"</span> <span class="ef-s">"Library.bib"</span>))
              (libfile-dir <span class="ef-s">"~/Zotero"</span>)
              paths)
          (<span class="ef-k">dolist</span> (libfile libfile-search-names)
            (<span class="ef-k">when</span> (<span class="ef-k">and</span> (not paths)
                       (file-exists-p (expand-file-name libfile libfile-dir)))
              (<span class="ef-k">setq</span> paths (list (expand-file-name libfile libfile-dir)))))
          paths)
        citar-bibliography org-cite-global-bibliography
        citar-symbols
        `((file ,(nerd-icons-faicon <span class="ef-s">"nf-fa-file_o"</span> <span class="ef-b">:face</span> 'nerd-icons-green <span class="ef-b">:v-adjust</span> -0.1) . <span class="ef-s">" "</span>)
          (note ,(nerd-icons-octicon <span class="ef-s">"nf-oct-note"</span> <span class="ef-b">:face</span> 'nerd-icons-blue <span class="ef-b">:v-adjust</span> -0.3) . <span class="ef-s">" "</span>)
          (link ,(nerd-icons-octicon <span class="ef-s">"nf-oct-link"</span> <span class="ef-b">:face</span> 'nerd-icons-orange <span class="ef-b">:v-adjust</span> 0.01) . <span class="ef-s">" "</span>))))

(<span class="ef-k">after!</span> oc-csl
  (<span class="ef-k">setq</span> org-cite-csl-styles-dir <span class="ef-s">"~/Zotero/styles"</span>))

(<span class="ef-k">after!</span> oc
  (<span class="ef-k">setq</span> org-cite-export-processors '((t csl))))

(map! <span class="ef-b">:after</span> org
      <span class="ef-b">:map</span> org-mode-map
      <span class="ef-b">:localleader</span>
      <span class="ef-b">:desc</span> <span class="ef-s">"Insert citation"</span> <span class="ef-s">"@"</span> #'org-cite-insert)

(<span class="ef-k">after!</span> oc
  (<span class="ef-k">defun</span> <span class="ef-f">org-ref-to-org-cite</span> ()
    <span class="ef-d">"Attempt to convert org-ref citations to org-cite syntax."</span>
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">let*</span> ((cite-conversions '((<span class="ef-s">"cite"</span> . <span class="ef-s">"//b"</span>) (<span class="ef-s">"Cite"</span> . <span class="ef-s">"//bc"</span>)
                               (<span class="ef-s">"nocite"</span> . <span class="ef-s">"/n"</span>)
                               (<span class="ef-s">"citep"</span> . <span class="ef-s">""</span>) (<span class="ef-s">"citep*"</span> . <span class="ef-s">"//f"</span>)
                               (<span class="ef-s">"parencite"</span> . <span class="ef-s">""</span>) (<span class="ef-s">"Parencite"</span> . <span class="ef-s">"//c"</span>)
                               (<span class="ef-s">"citeauthor"</span> . <span class="ef-s">"/a/f"</span>) (<span class="ef-s">"citeauthor*"</span> . <span class="ef-s">"/a"</span>)
                               (<span class="ef-s">"citeyear"</span> . <span class="ef-s">"/na/b"</span>)
                               (<span class="ef-s">"Citep"</span> . <span class="ef-s">"//c"</span>) (<span class="ef-s">"Citealp"</span> . <span class="ef-s">"//bc"</span>)
                               (<span class="ef-s">"Citeauthor"</span> . <span class="ef-s">"/a/cf"</span>) (<span class="ef-s">"Citeauthor*"</span> . <span class="ef-s">"/a/c"</span>)
                               (<span class="ef-s">"autocite"</span> . <span class="ef-s">""</span>) (<span class="ef-s">"Autocite"</span> . <span class="ef-s">"//c"</span>)
                               (<span class="ef-s">"notecite"</span> . <span class="ef-s">"/l/b"</span>) (<span class="ef-s">"Notecite"</span> . <span class="ef-s">"/l/bc"</span>)
                               (<span class="ef-s">"pnotecite"</span> . <span class="ef-s">"/l"</span>) (<span class="ef-s">"Pnotecite"</span> . <span class="ef-s">"/l/bc"</span>)))
           (cite-regexp (<span class="ef-k">rx</span> (regexp (regexp-opt (mapcar #'car cite-conversions) t))
                            <span class="ef-s">":"</span> (group (+ (not (any <span class="ef-s">"\n 	,.)]}"</span>)))))))
      (<span class="ef-k">save-excursion</span>
        (goto-char (point-min))
        (<span class="ef-k">while</span> (re-search-forward cite-regexp nil t)
          (message (format <span class="ef-s">"[cite%s:@%s]"</span>
                                 (cdr (assoc (match-string 1) cite-conversions))
                                 (match-string 2)))
          (replace-match (format <span class="ef-s">"[cite%s:@%s]"</span>
                                 (cdr (assoc (match-string 1) cite-conversions))
                                 (match-string 2))))))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-org-citation</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Org Super Agenda
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-super-agenda"</span> config)
(use-package! org-super-agenda
  <span class="ef-b">:commands</span> org-super-agenda-mode)

(<span class="ef-k">after!</span> org-agenda
  (<span class="ef-k">let</span> ((inhibit-message t))
    (org-super-agenda-mode)))

(<span class="ef-k">setq</span> org-agenda-skip-scheduled-if-done t
      org-agenda-skip-deadline-if-done t
      org-agenda-include-deadlines t
      org-agenda-block-separator nil
      org-agenda-tags-column 100 <span class="ef-cd">;; </span><span class="ef-c">from testing this seems to be a good value
</span>      org-agenda-compact-blocks t)

(<span class="ef-k">setq</span> org-agenda-custom-commands
      '((<span class="ef-s">"o"</span> <span class="ef-s">"Overview"</span>
         ((agenda <span class="ef-s">""</span> ((org-agenda-span 'day)
                      (org-super-agenda-groups
                       '((<span class="ef-b">:name</span> <span class="ef-s">"Today"</span>
                          <span class="ef-b">:time-grid</span> t
                          <span class="ef-b">:date</span> today
                          <span class="ef-b">:todo</span> <span class="ef-s">"TODAY"</span>
                          <span class="ef-b">:scheduled</span> today
                          <span class="ef-b">:order</span> 1)))))
          (alltodo <span class="ef-s">""</span> ((org-agenda-overriding-header <span class="ef-s">""</span>)
                       (org-super-agenda-groups
                        '((<span class="ef-b">:name</span> <span class="ef-s">"Next to do"</span>
                           <span class="ef-b">:todo</span> <span class="ef-s">"NEXT"</span>
                           <span class="ef-b">:order</span> 1)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Important"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"Important"</span>
                           <span class="ef-b">:priority</span> <span class="ef-s">"A"</span>
                           <span class="ef-b">:order</span> 6)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Due Today"</span>
                           <span class="ef-b">:deadline</span> today
                           <span class="ef-b">:order</span> 2)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Due Soon"</span>
                           <span class="ef-b">:deadline</span> future
                           <span class="ef-b">:order</span> 8)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Overdue"</span>
                           <span class="ef-b">:deadline</span> past
                           <span class="ef-b">:face</span> error
                           <span class="ef-b">:order</span> 7)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Assignments"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"Assignment"</span>
                           <span class="ef-b">:order</span> 10)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Issues"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"Issue"</span>
                           <span class="ef-b">:order</span> 12)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Emacs"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"Emacs"</span>
                           <span class="ef-b">:order</span> 13)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Projects"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"Project"</span>
                           <span class="ef-b">:order</span> 14)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Research"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"Research"</span>
                           <span class="ef-b">:order</span> 15)
                          (<span class="ef-b">:name</span> <span class="ef-s">"To read"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"Read"</span>
                           <span class="ef-b">:order</span> 30)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Waiting"</span>
                           <span class="ef-b">:todo</span> <span class="ef-s">"WAITING"</span>
                           <span class="ef-b">:order</span> 20)
                          (<span class="ef-b">:name</span> <span class="ef-s">"University"</span>
                           <span class="ef-b">:tag</span> <span class="ef-s">"uni"</span>
                           <span class="ef-b">:order</span> 32)
                          (<span class="ef-b">:name</span> <span class="ef-s">"Trivial"</span>
                           <span class="ef-b">:priority&lt;=</span> <span class="ef-s">"E"</span>
                           <span class="ef-b">:tag</span> (<span class="ef-s">"Trivial"</span> <span class="ef-s">"Unimportant"</span>)
                           <span class="ef-b">:todo</span> (<span class="ef-s">"SOMEDAY"</span> )
                           <span class="ef-b">:order</span> 90)
                          (<span class="ef-b">:discard</span> (<span class="ef-b">:tag</span> (<span class="ef-s">"Chore"</span> <span class="ef-s">"Routine"</span> <span class="ef-s">"Daily"</span>)))))))))))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-super-agenda</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-roam
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"hook: pkg-org-roam"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'org-roam
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-roam"</span> load-hooks)
(<span class="ef-k">setq</span> org-roam-directory <span class="ef-s">"~/Desktop/TEC/Organisation/Roam/"</span>)

(<span class="ef-k">defadvice!</span> doom-modeline--buffer-file-name-roam-aware-a (orig-fun)
  <span class="ef-b">:around</span> #'doom-modeline-buffer-file-name <span class="ef-cd">; </span><span class="ef-c">takes no args
</span>  (<span class="ef-k">if</span> (string-match-p (regexp-quote org-roam-directory) (<span class="ef-k">or</span> buffer-file-name <span class="ef-s">""</span>))
      (replace-regexp-in-string
       <span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">^</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">.*/</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[0-9]\\{</span><span style="color: #6a1868;">4\\</span><span class="ef-s">}</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[0-9]\\{</span><span style="color: #6a1868;">2\\</span><span class="ef-s">}</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[0-9]\\{</span><span style="color: #6a1868;">2\\</span><span class="ef-s">}</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">[0-9]*-"</span>
       <span class="ef-s">"ð¢(\\1-\\2-\\3) "</span>
       (subst-char-in-string ?_ ?  buffer-file-name))
    (funcall orig-fun)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-roam</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-roam-ui
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-roam-ui-open</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-roam-ui"</span> config)
(use-package! websocket
  <span class="ef-b">:after</span> org-roam)

(use-package! org-roam-ui
  <span class="ef-b">:after</span> org-roam
  <span class="ef-b">:commands</span> org-roam-ui-open
  <span class="ef-b">:hook</span> (org-roam . org-roam-ui-mode)
  <span class="ef-b">:config</span>
  (<span class="ef-k">require</span> '<span class="ef-o">org-roam</span>) <span class="ef-cd">; </span><span class="ef-c">in case autoloaded
</span>  (<span class="ef-k">defun</span> <span class="ef-f">org-roam-ui-open</span> ()
    <span class="ef-d">"Ensure the server is active, then open the roam graph."</span>
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">unless</span> org-roam-ui-mode (org-roam-ui-mode 1))
    (browse-url-xdg-open (format <span class="ef-s">"http://localhost:%d"</span> org-roam-ui-port))))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-roam-ui</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Flycheck org-lint
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">flycheck-org-lint-customisations-form</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">flycheck-org-lint-babel-langs-form</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">flycheck-org-lint-variables-form</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: flycheck-org-lint"</span> set-hooks)
  (<span class="ef-k">after!</span> (<span class="ef-b">:and</span> org flycheck)
(confpkg-with-record '(<span class="ef-s">"load: flycheck-org-lint"</span> load-hooks)
(<span class="ef-k">defconst</span> <span class="ef-v">flycheck-org-lint-form</span>
  (flycheck-prepare-emacs-lisp-form
    (<span class="ef-k">require</span> '<span class="ef-o">org</span>)
    (<span class="ef-k">require</span> '<span class="ef-o">org-lint</span>)
    (<span class="ef-k">require</span> '<span class="ef-o">org-attach</span>)
    (<span class="ef-k">let</span> ((source (car command-line-args-left))
          (process-default-directory default-directory))
      (<span class="ef-k">with-temp-buffer</span>
        (insert-file-contents source 'visit)
        (<span class="ef-k">setq</span> buffer-file-name source)
        (<span class="ef-k">setq</span> default-directory process-default-directory)
        (<span class="ef-k">delay-mode-hooks</span> (org-mode))
        (<span class="ef-k">setq</span> delayed-mode-hooks nil)
        (<span class="ef-k">dolist</span> (err (org-lint))
          (<span class="ef-k">let</span> ((inf (cl-second err)))
            (princ (elt inf 0))
            (princ <span class="ef-s">": "</span>)
            (princ (elt inf 2))
            (terpri)))))))

(<span class="ef-k">defconst</span> <span class="ef-v">flycheck-org-lint-variables</span>
  '(org-directory
    org-id-locations
    org-id-locations-file
    org-attach-id-dir
    org-attach-use-inheritance
    org-attach-id-to-path-function-list
    org-link-parameters)
  <span class="ef-d">"Variables inherited by the org-lint subprocess."</span>)

(<span class="ef-k">defconst</span> <span class="ef-v">flycheck-org-lint-babel-langs</span>
  '(C C++ D LaTeX R TeX antlr ash asm asymptote autoconf awk bash bash-ts bash2 bat beamer c c++ c++-ts c-ts c-ts-base calc cfengine2 cfengine3 change-log clojure clojurescript cmake-ts common-lisp conf conf-colon conf-desktop conf-javaprop conf-ppd conf-space conf-toml conf-unix conf-windows conf-xdefaults cperl cpp csh csharp csharp-ts css css-base css-ts dash dcl delphi desktop ditaa dns doc-view--text-view dockerfile-ts doctex dot dsssl dtksh editorconfig-conf elisp elisp-byte-code elixir-ts emacs-lisp emacs-news emacs-news-view erts es eshell f90 fish forth fortran gdb-script gnuplot gnus-article-edit gnus-score go-mod-ts go-ts groovy haskell heex-ts help-fns--edit-value html html-ts icon idl idlwave indented-text itcsh java java-ts javascript jcsh js js-base js-json js-jsx js-ts jsh json-ts julia ksh ksh88 latex ld-script less-css lilypond lisp lisp-data lisp-interaction lua lua-ts m2 m4 mail makefile makefile-automake makefile-bsdmake makefile-gmake makefile-imake makefile-makepp matlab maxima mercury message meta-common metafont metapost mh-letter mh-show mhtml mixal mksh modula-2 nroff nxml oash objc ocaml octave opascal org outline paragraph-indent-text pascal pdksh perl php-ts pike plain-TeX plain-tex plantuml plstore posh posix processing prog prolog ps python python-base python-ts rc rpm rst ruby ruby-base ruby-ts rust-ts sass scheme screen scss sed sgml sh sh-base shell shell-script sieve simula slitex sql sqlite tcl tcsh tex texinfo text todo-edit toml toml-ts tsx-ts typescript-ts typescript-ts-base vera verilog vhdl wksh wsh xml yaml-ts zone zsh)
  <span class="ef-d">"Languages that org-babel should know of."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">flycheck-org-lint-variables-form</span> ()
  (<span class="ef-k">require</span> '<span class="ef-o">org-attach</span>)  <span class="ef-cd">; </span><span class="ef-c">Needed to make variables available
</span>  `(<span class="ef-k">progn</span>
     ,@(seq-map (<span class="ef-k">lambda</span> (opt) `(<span class="ef-k">setq-default</span> ,opt ',(symbol-value opt)))
                (seq-filter #'boundp flycheck-org-lint-variables))))

(<span class="ef-k">defun</span> <span class="ef-f">flycheck-org-lint-babel-langs-form</span> ()
  `(<span class="ef-k">progn</span>
     ,@(mapcar
        (<span class="ef-k">lambda</span> (lang)
          `(<span class="ef-k">defun</span> ,(intern (format <span class="ef-s">"org-babel-execute:%s"</span> lang)) (_body _params)
             <span class="ef-d">"Stub for org-lint."</span>))
        flycheck-org-lint-babel-langs)))

(eval <span class="ef-cd">; </span><span class="ef-c">To preveant eager macro expansion form loading flycheck early.
</span> '(flycheck-define-checker org-lint
   <span class="ef-d">"Org buffer checker using `</span><span style="color: #b751b6; text-decoration: italic;">org-lint</span><span class="ef-d">'."</span>
   <span class="ef-b">:command</span> (<span class="ef-s">"emacs"</span> (eval flycheck-emacs-args)
             <span class="ef-s">"--eval"</span> (eval (concat <span class="ef-s">"(add-to-list 'load-path \""</span>
                                    (file-name-directory (locate-library <span class="ef-s">"org"</span>))
                                    <span class="ef-s">"\")"</span>))
             <span class="ef-s">"--eval"</span> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-variables-form)))
             <span class="ef-s">"--eval"</span> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-customisations-form)))
             <span class="ef-s">"--eval"</span> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-babel-langs-form)))
             <span class="ef-s">"--eval"</span> (eval flycheck-org-lint-form)
             <span class="ef-s">"--"</span> source)
   <span class="ef-b">:error-patterns</span>
   ((<span class="ef-wr">error</span> line-start line <span class="ef-s">": "</span> (message) line-end))
   <span class="ef-b">:modes</span> org-mode))

(add-to-list 'flycheck-checkers 'org-lint)

(<span class="ef-k">defun</span> <span class="ef-f">flycheck-org-lint-customisations-form</span> ()
  `(<span class="ef-k">progn</span>
     (<span class="ef-k">require</span> '<span class="ef-o">ox</span>)
     (<span class="ef-k">cl-pushnew</span> '(<span class="ef-b">:latex-cover-page</span> nil <span class="ef-s">"coverpage"</span> nil)
                 (org-export-backend-options (org-export-get-backend 'latex)))
     (<span class="ef-k">cl-pushnew</span> '(<span class="ef-b">:latex-font-set</span> nil <span class="ef-s">"fontset"</span> nil)
                 (org-export-backend-options (org-export-get-backend 'latex)))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-flycheck-org-lint</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Org Visuals
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+org-plot-gnuplot-term-properties</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-plot-generate-theme</span><span class="ef-c">', `</span><span style="color: #b751b6;">+org-plot-term-size</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">locally-defer-font-lock</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: org-visuals"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'org
(confpkg-with-record '(<span class="ef-s">"load: org-visuals"</span> load-hooks)
(add-hook 'org-mode-hook #'+org-pretty-mode)

(custom-set-faces!
  '(outline-1 <span class="ef-b">:weight</span> extra-bold <span class="ef-b">:height</span> 1.25)
  '(outline-2 <span class="ef-b">:weight</span> bold <span class="ef-b">:height</span> 1.15)
  '(outline-3 <span class="ef-b">:weight</span> bold <span class="ef-b">:height</span> 1.12)
  '(outline-4 <span class="ef-b">:weight</span> semi-bold <span class="ef-b">:height</span> 1.09)
  '(outline-5 <span class="ef-b">:weight</span> semi-bold <span class="ef-b">:height</span> 1.06)
  '(outline-6 <span class="ef-b">:weight</span> semi-bold <span class="ef-b">:height</span> 1.03)
  '(outline-8 <span class="ef-b">:weight</span> semi-bold)
  '(outline-9 <span class="ef-b">:weight</span> semi-bold))

(custom-set-faces!
  '(org-document-title <span class="ef-b">:height</span> 1.2))

(<span class="ef-k">setq</span> org-agenda-deadline-faces
      '((1.001 . error)
        (1.0 . org-warning)
        (0.5 . org-upcoming-deadline)
        (0.0 . org-upcoming-distant-deadline)))

(<span class="ef-k">setq</span> org-fontify-quote-and-verse-blocks t)

(<span class="ef-k">defun</span> <span class="ef-f">locally-defer-font-lock</span> ()
  <span class="ef-d">"Set jit-lock defer and stealth, when buffer is over a certain size."</span>
  (<span class="ef-k">when</span> (&gt; (buffer-size) 50000)
    (<span class="ef-k">setq-local</span> jit-lock-defer-time 0.05
                jit-lock-stealth-time 1)))

(add-hook 'org-mode-hook #'locally-defer-font-lock)

(<span class="ef-k">defadvice!</span> +org-indent--reduced-text-prefixes ()
  <span class="ef-b">:after</span> #'org-indent--compute-prefixes
  (<span class="ef-k">setq</span> org-indent--text-line-prefixes
        (make-vector org-indent--deepest-level nil))
  (<span class="ef-k">when</span> (&gt; org-indent-indentation-per-level 0)
    (<span class="ef-k">dotimes</span> (n org-indent--deepest-level)
      (aset org-indent--text-line-prefixes
            n
            (org-add-props
                (concat (make-string (* n (1- org-indent-indentation-per-level))
                                     ?\s)
                        (<span class="ef-k">if</span> (&gt; n 0)
                             (char-to-string org-indent-boundary-char)
                          <span class="ef-s">"\u200b"</span>))
                nil 'face 'org-indent)))))

(<span class="ef-k">setq</span> org-inline-src-prettify-results '(<span class="ef-s">"â¨"</span> . <span class="ef-s">"â©"</span>))

(<span class="ef-k">setq</span> doom-themes-org-fontify-special-tags nil)

(<span class="ef-k">setq</span> org-ellipsis <span class="ef-s">" â¾ "</span>
      org-hide-leading-stars t
      org-priority-highest ?A
      org-priority-lowest ?E
      org-priority-faces
      '((?A . 'nerd-icons-red)
        (?B . 'nerd-icons-orange)
        (?C . 'nerd-icons-yellow)
        (?D . 'nerd-icons-green)
        (?E . 'nerd-icons-blue)))

(<span class="ef-k">appendq!</span> +ligatures-extra-symbols
          (list <span class="ef-b">:list_property</span> <span class="ef-s">"â·"</span>
                <span class="ef-b">:em_dash</span>       <span class="ef-s">"â"</span>
                <span class="ef-b">:ellipses</span>      <span class="ef-s">"â¦"</span>
                <span class="ef-b">:arrow_right</span>   <span class="ef-s">"â"</span>
                <span class="ef-b">:arrow_left</span>    <span class="ef-s">"â"</span>
                <span class="ef-b">:arrow_lr</span>      <span class="ef-s">"â"</span>
                <span class="ef-b">:properties</span>    <span class="ef-s">"â"</span>
                <span class="ef-b">:end</span>           <span class="ef-s">"â"</span>
                <span class="ef-b">:priority_a</span>    #(<span class="ef-s">"â"</span> 0 1 (face nerd-icons-red))
                <span class="ef-b">:priority_b</span>    #(<span class="ef-s">"â¬"</span> 0 1 (face nerd-icons-orange))
                <span class="ef-b">:priority_c</span>    #(<span class="ef-s">"â "</span> 0 1 (face nerd-icons-yellow))
                <span class="ef-b">:priority_d</span>    #(<span class="ef-s">"â¬"</span> 0 1 (face nerd-icons-green))
                <span class="ef-b">:priority_e</span>    #(<span class="ef-s">"â"</span> 0 1 (face nerd-icons-blue))))

(<span class="ef-k">defadvice!</span> +org-init-appearance-h--no-ligatures-a ()
  <span class="ef-b">:after</span> #'+org-init-appearance-h
  (set-ligatures! 'org-mode nil)
  (set-ligatures! 'org-mode
    <span class="ef-b">:list_property</span> <span class="ef-s">"::"</span>
    <span class="ef-b">:em_dash</span>       <span class="ef-s">"---"</span>
    <span class="ef-b">:ellipsis</span>      <span class="ef-s">"..."</span>
    <span class="ef-b">:arrow_right</span>   <span class="ef-s">"-&gt;"</span>
    <span class="ef-b">:arrow_left</span>    <span class="ef-s">"&lt;-"</span>
    <span class="ef-b">:arrow_lr</span>      <span class="ef-s">"&lt;-&gt;"</span>
    <span class="ef-b">:properties</span>    <span class="ef-s">":PROPERTIES:"</span>
    <span class="ef-b">:end</span>           <span class="ef-s">":END:"</span>
    <span class="ef-b">:priority_a</span>    <span class="ef-s">"[#A]"</span>
    <span class="ef-b">:priority_b</span>    <span class="ef-s">"[#B]"</span>
    <span class="ef-b">:priority_c</span>    <span class="ef-s">"[#C]"</span>
    <span class="ef-b">:priority_d</span>    <span class="ef-s">"[#D]"</span>
    <span class="ef-b">:priority_e</span>    <span class="ef-s">"[#E]"</span>))

<span class="ef-cd">;; </span><span class="ef-c">(package! org-pretty-tags :pin "5c7521651b35ae9a7d3add4a66ae8cc176ae1c76")
</span>
<span class="ef-cd">;; </span><span class="ef-c">(use-package org-pretty-tags
</span><span class="ef-cd">;; </span><span class="ef-c">:config
</span><span class="ef-cd">;;  </span><span class="ef-c">(setq org-pretty-tags-surrogate-strings
</span><span class="ef-cd">;;        </span><span class="ef-c">`(("uni"        . ,(all-the-icons-faicon   "graduation-cap" :face 'all-the-icons-purple  :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("ucc"        . ,(all-the-icons-material "computer"       :face 'all-the-icons-silver  :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("assignment" . ,(all-the-icons-material "library_books"  :face 'all-the-icons-orange  :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("test"       . ,(all-the-icons-material "timer"          :face 'all-the-icons-red     :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("lecture"    . ,(all-the-icons-fileicon "keynote"        :face 'all-the-icons-orange  :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("email"      . ,(all-the-icons-faicon   "envelope"       :face 'all-the-icons-blue    :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("read"       . ,(all-the-icons-octicon  "book"           :face 'all-the-icons-lblue   :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("article"    . ,(all-the-icons-octicon  "file-text"      :face 'all-the-icons-yellow  :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("web"        . ,(all-the-icons-faicon   "globe"          :face 'all-the-icons-green   :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("info"       . ,(all-the-icons-faicon   "info-circle"    :face 'all-the-icons-blue    :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("issue"      . ,(all-the-icons-faicon   "bug"            :face 'all-the-icons-red     :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("someday"    . ,(all-the-icons-faicon   "calendar-o"     :face 'all-the-icons-cyan    :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("idea"       . ,(all-the-icons-octicon  "light-bulb"     :face 'all-the-icons-yellow  :v-adjust 0.01))
</span><span class="ef-cd">;;          </span><span class="ef-c">("emacs"      . ,(all-the-icons-fileicon "emacs"          :face 'all-the-icons-lpurple :v-adjust 0.01))))
</span><span class="ef-cd">;;  </span><span class="ef-c">(org-pretty-tags-global-mode))
</span>
(<span class="ef-k">setq</span> org-highlight-latex-and-related '(latex script entities))

(<span class="ef-k">require</span> '<span class="ef-o">org-src</span>)
(add-to-list 'org-src-block-faces '(<span class="ef-s">"latex"</span> (<span class="ef-b">:inherit</span> default <span class="ef-b">:extend</span> t)))

(add-hook 'org-mode-hook #'org-latex-preview-auto-mode)

(<span class="ef-k">setq</span> org-latex-preview-preamble
      (concat
       <span class="ef-s">"\\documentclass{article}
[DEFAULT-PACKAGES]
[PACKAGES]
\\usepackage{xcolor}"</span>
       <span class="ef-s">"\n% Custom font\n\\usepackage{arev}\n\n"</span>
       <span class="ef-s">"%% Maths-related packages
% More maths environments, commands, and symbols.
\\usepackage{amsmath, amssymb}
% Slanted fractions with \\sfrac{a}{b}, in text and maths.
\\usepackage{xfrac}
% Visually cancel expressions with \\cancel{value} and \\cancelto{expression}{value}
\\usepackage[makeroom]{cancel}
% Improvements on amsmath and utilities for mathematical typesetting
\\usepackage{mathtools}

% Deliminators
\\DeclarePairedDelimiter{\\abs}{\\lvert}{\\rvert}
\\DeclarePairedDelimiter{\\norm}{\\lVert}{\\rVert}

\\DeclarePairedDelimiter{\\ceil}{\\lceil}{\\rceil}
\\DeclarePairedDelimiter{\\floor}{\\lfloor}{\\rfloor}
\\DeclarePairedDelimiter{\\round}{\\lfloor}{\\rceil}

\\newcommand{\\RR}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{R}}{\\mathbb{R}^{#1}}}} % Real numbers
\\newcommand{\\NN}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{N}}{\\mathbb{N}^{#1}}}} % Natural numbers
\\newcommand{\\ZZ}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{Z}}{\\mathbb{Z}^{#1}}}} % Integer numbers
\\newcommand{\\QQ}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{Q}}{\\mathbb{Q}^{#1}}}} % Rational numbers
\\newcommand{\\CC}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{C}}{\\mathbb{C}^{#1}}}} % Complex numbers

% Easy derivatives
\\ProvideDocumentCommand\\dv{o m g}{%
  \\IfNoValueTF{#3}{%
    \\dv[#1]{}{#2}}{%
    \\IfNoValueTF{#1}{%
      \\frac{\\dd #2}{\\dd #3}%
    }{\\frac{\\dd[#1] #2}{\\dd {#3}^{#1}}}}}
% Easy partial derivatives
\\ExplSyntaxOn
\\ProvideDocumentCommand\\pdv{o m g}{%
  \\IfNoValueTF{#3}{\\pdv[#1]{}{#2}}%
  {\\ifnum\\clist_count:n{#3}&lt;2
    \\IfValueTF{#1}{\\frac{\\partial^{#1} #2}{\\partial {#3}^{#1}}}%
    {\\frac{\\partial #2}{\\partial #3}}
    \\else
    \\frac{\\IfValueTF{#1}{\\partial^{#1}}{\\partial^{\\clist_count:n{#3}}}#2}%
    {\\clist_map_inline:nn{#3}{\\partial ##1 \\,}\\!}
    \\fi}}
\\ExplSyntaxOff

% Laplacian
\\DeclareMathOperator{\\Lap}{\\mathcal{L}}

% Statistics
\\DeclareMathOperator{\\Var}{Var} % varience
\\DeclareMathOperator{\\Cov}{Cov} % covarience
\\newcommand{\\EE}{\\ensuremath{\\mathbb{E}}} % expected value
\\DeclareMathOperator{\\E}{E} % expected value

% I prefer the slanted \\leq/\\geq
\\let\\barleq\\leq % Save them in case they're every wanted
\\let\\bargeq\\geq
\\renewcommand{\\leq}{\\leqslant}
\\renewcommand{\\geq}{\\geqslant}

% Redefine the matrix environment to allow for alignment
% via an optional argument, and use r as the default.
\\makeatletter
\\renewcommand*\\env@matrix[1][r]{\\hskip -\\arraycolsep%
    \\let\\@ifnextchar\\new@ifnextchar
    \\array{*\\c@MaxMatrixCols #1}}
\\makeatother

% Slanted roman \"d\" for derivatives
\\ifcsname pdfoutput\\endcsname
  \\ifnum\\pdfoutput&gt;0 % PDF
    \\newsavebox\\diffdbox{}
    \\newcommand{\\slantedromand}{{\\mathpalette\\makesl{d}}}
    \\newcommand{\\makesl}[2]{%
      \\begingroup
      \\sbox{\\diffdbox}{$\\mathsurround=0pt#1\\mathrm{#2}$}%
      \\pdfsave%
      \\pdfsetmatrix{1 0 0.2 1}%
      \\rlap{\\usebox{\\diffdbox}}%
      \\pdfrestore%
      \\hskip\\wd\\diffdbox%
      \\endgroup}
  \\else % DVI
    \\newcommand{\\slantedromand}{d} % fallback
  \\fi
\\else % Also DVI
  \\newcommand{\\slantedromand}{d} % fallback
\\fi

% Derivative d^n, nicely spaced
\\makeatletter
\\newcommand{\\dd}[1][]{\\mathop{}\\!%
  \\expandafter\\ifx\\expandafter&amp;\\detokenize{#1}&amp;% \\ifstrempty from etoolbox
    \\slantedromand\\@ifnextchar^{\\hspace{0.2ex}}{\\hspace{0.1ex}}
  \\else
    \\slantedromand\\hspace{0.2ex}^{#1}
  \\fi}
\\makeatother

\\NewCommandCopy{\\daccent}{\\d}
\\renewcommand{\\d}{\\ifmmode\\dd\\else\\daccent\\fi}"</span>))

<span class="ef-cd">;; </span><span class="ef-c">Calibrated based on the TeX font and org-buffer font.
</span>(plist-put org-format-latex-options <span class="ef-b">:zoom</span> 0.93)

(<span class="ef-k">defvar</span> <span class="ef-v">+org-plot-term-size</span> '(1050 . 650)
  <span class="ef-d">"The size of the GNUPlot terminal, in the form (WIDTH . HEIGHT)."</span>)

(<span class="ef-k">after!</span> org-plot
  (<span class="ef-k">defun</span> <span class="ef-f">+org-plot-generate-theme</span> (_type)
    <span class="ef-d">"Use the current Doom theme colours to generate a GnuPlot preamble."</span>
    (format <span class="ef-s">"
fgt = \"textcolor rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">'\" # foreground text
fgat = \"textcolor rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">'\" # foreground alt text
fgl = \"linecolor rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">'\" # foreground line
fgal = \"linecolor rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">'\" # foreground alt line

# foreground colors
set border lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">'
# change text colors of  tics
set xtics @fgt
set ytics @fgt
# change text colors of labels
set title @fgt
set xlabel @fgt
set ylabel @fgt
# change a text color of key
set key @fgt

# line styles
set linetype 1 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # red
set linetype 2 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # blue
set linetype 3 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # green
set linetype 4 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # magenta
set linetype 5 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # orange
set linetype 6 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # yellow
set linetype 7 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # teal
set linetype 8 lw 2 lc rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' # violet

# border styles
set tics out nomirror
set border 3

# palette
set palette maxcolors 8
set palette defined ( 0 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">',\
1 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">',\
2 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">',\
3 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">',\
4 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">',\
5 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">',\
6 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">',\
7 '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' )
"</span>
            (doom-color 'fg)
            (doom-color 'fg-alt)
            (doom-color 'fg)
            (doom-color 'fg-alt)
            (doom-color 'fg)
            <span class="ef-cd">;; </span><span class="ef-c">colours
</span>            (doom-color 'red)
            (doom-color 'blue)
            (doom-color 'green)
            (doom-color 'magenta)
            (doom-color 'orange)
            (doom-color 'yellow)
            (doom-color 'teal)
            (doom-color 'violet)
            <span class="ef-cd">;; </span><span class="ef-c">duplicated
</span>            (doom-color 'red)
            (doom-color 'blue)
            (doom-color 'green)
            (doom-color 'magenta)
            (doom-color 'orange)
            (doom-color 'yellow)
            (doom-color 'teal)
            (doom-color 'violet)))

  (<span class="ef-k">defun</span> <span class="ef-f">+org-plot-gnuplot-term-properties</span> (_type)
    (format <span class="ef-s">"background rgb '</span><span style="color: #b751b6;">%s</span><span class="ef-s">' size %s,%s"</span>
            (doom-color 'bg) (car +org-plot-term-size) (cdr +org-plot-term-size)))

  (<span class="ef-k">setq</span> org-plot/gnuplot-script-preamble #'+org-plot-generate-theme)
  (<span class="ef-k">setq</span> org-plot/gnuplot-term-extra #'+org-plot-gnuplot-term-properties))

(<span class="ef-k">provide</span> '<span class="ef-o">config-org-visuals</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Org exports
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+org-export-babel-mask-org-config</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-mode--fontlock-only-mode</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-export-remove-zero-width-space</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">unpackaged/org-export-new-named-reference</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">unpackaged/org-export-get-reference</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-reference-contraction</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-reference-contraction-truncate-words</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-reference-contraction-joining-char</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-reference-contraction-stripped-words</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-reference-contraction-max-length</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-reference-contraction-max-words</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-format-headline-acronymised</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-html-format-headline-acronymised</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-export-filter-text-acronym</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: org-exports"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'ox
(confpkg-with-record '(<span class="ef-s">"load: org-exports"</span> load-hooks)
(<span class="ef-k">setq</span> org-export-headline-levels 5) <span class="ef-cd">; </span><span class="ef-c">I like nesting
</span>
(<span class="ef-k">require</span> '<span class="ef-o">ox-extra</span>)
(ox-extras-activate '(ignore-headlines))

(<span class="ef-k">setq</span> org-export-creator-string
      (format <span class="ef-s">"Emacs %s (Org mode %sâ%s)"</span> emacs-version (org-release) (org-git-version)))

(<span class="ef-k">defun</span> <span class="ef-f">org-export-filter-text-acronym</span> (text backend _info)
  <span class="ef-d">"Wrap suspected acronyms in acronyms-specific formatting.
Treat sequences of 2+ capital letters (optionally succeeded by \"s\") as an acronym.
Ignore if preceeded by \";\" (for manual prevention) or \"\\\" (for LaTeX commands).

TODO abstract backend implementations."</span>
  (<span class="ef-k">let</span> ((base-backend
         (<span class="ef-k">cond</span>
          ((org-export-derived-backend-p backend 'latex) 'latex)
          <span class="ef-cd">;; </span><span class="ef-c">Markdown is derived from HTML, but we don't want to format it
</span>          ((org-export-derived-backend-p backend 'md) nil)
          ((org-export-derived-backend-p backend 'html) 'html)))
        (case-fold-search nil))
    (<span class="ef-k">when</span> base-backend
      (replace-regexp-in-string
       <span class="ef-s">"[;\\\\]?\\b[A-Z][A-Z]+s?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">A-Za-z]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\b</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span>
       (<span class="ef-k">lambda</span> (all-caps-str)
         (<span class="ef-k">cond</span> ((equal (aref all-caps-str 0) ?\\) all-caps-str)                <span class="ef-cd">; </span><span class="ef-c">don't format LaTeX commands
</span>               ((equal (aref all-caps-str 0) ?\;) (substring all-caps-str 1))  <span class="ef-cd">; </span><span class="ef-c">just remove not-acronym indicator char ";"
</span>               (t (<span class="ef-k">let*</span> ((final-char (<span class="ef-k">if</span> (string-match-p <span class="ef-s">"[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">A-Za-z]"</span> (substring all-caps-str -1 (length all-caps-str)))
                                         (substring all-caps-str -1 (length all-caps-str))
                                       nil)) <span class="ef-cd">; </span><span class="ef-c">needed to re-insert the [</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-c">A-Za-z] at the end
</span>                         (trailing-s (equal (aref all-caps-str (- (length all-caps-str) (<span class="ef-k">if</span> final-char 2 1))) ?s))
                         (acr (<span class="ef-k">if</span> final-char
                                  (substring all-caps-str 0 (<span class="ef-k">if</span> trailing-s -2 -1))
                                (substring all-caps-str 0 (+ (<span class="ef-k">if</span> trailing-s -1 (length all-caps-str)))))))
                    (<span class="ef-k">pcase</span> base-backend
                      ('latex (concat <span class="ef-s">"\\acr{"</span> (downcase acr) <span class="ef-s">"}"</span> (<span class="ef-k">when</span> trailing-s <span class="ef-s">"\\acrs{}"</span>) final-char))
                      ('html (concat <span class="ef-s">"&lt;span class='</span><span style="color: #b751b6;">acr</span><span class="ef-s">'&gt;"</span> acr <span class="ef-s">"&lt;/span&gt;"</span> (<span class="ef-k">when</span> trailing-s <span class="ef-s">"&lt;small&gt;s&lt;/small&gt;"</span>) final-char)))))))
       text t t))))

(add-to-list 'org-export-filter-plain-text-functions
             #'org-export-filter-text-acronym)

<span class="ef-cd">;; </span><span class="ef-c">We won't use `</span><span style="color: #b751b6;">org-export-filter-headline-functions</span><span class="ef-c">' because it
</span><span class="ef-cd">;; </span><span class="ef-c">passes (and formats) the entire section contents. That's no good.
</span>
(<span class="ef-k">defun</span> <span class="ef-f">org-html-format-headline-acronymised</span> (todo todo-type priority text tags info)
  <span class="ef-d">"Like `</span><span style="color: #b751b6; text-decoration: italic;">org-html-format-headline-default-function</span><span class="ef-d">', but with acronym formatting."</span>
  (org-html-format-headline-default-function
   todo todo-type priority (org-export-filter-text-acronym text 'html info) tags info))
(<span class="ef-k">setq</span> org-html-format-headline-function #'org-html-format-headline-acronymised)

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-format-headline-acronymised</span> (todo todo-type priority text tags info)
  <span class="ef-d">"Like `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-format-headline-default-function</span><span class="ef-d">', but with acronym formatting."</span>
  (org-latex-format-headline-default-function
   todo todo-type priority (org-export-filter-text-acronym text 'latex info) tags info))
(<span class="ef-k">setq</span> org-latex-format-headline-function #'org-latex-format-headline-acronymised)

(<span class="ef-k">defvar</span> <span class="ef-v">org-reference-contraction-max-words</span> 3
  <span class="ef-d">"Maximum number of words in a reference reference."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-reference-contraction-max-length</span> 35
  <span class="ef-d">"Maximum length of resulting reference reference, including joining characters."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-reference-contraction-stripped-words</span>
  '(<span class="ef-s">"the"</span> <span class="ef-s">"on"</span> <span class="ef-s">"in"</span> <span class="ef-s">"off"</span> <span class="ef-s">"a"</span> <span class="ef-s">"for"</span> <span class="ef-s">"by"</span> <span class="ef-s">"of"</span> <span class="ef-s">"and"</span> <span class="ef-s">"is"</span> <span class="ef-s">"to"</span> <span class="ef-s">"as"</span>)
  <span class="ef-d">"Superfluous words to be removed from a reference."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-reference-contraction-joining-char</span> <span class="ef-s">"-"</span>
  <span class="ef-d">"Character used to join words in the reference reference."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">org-reference-contraction-truncate-words</span> (words)
  <span class="ef-d">"Using `</span><span style="color: #b751b6; text-decoration: italic;">org-reference-contraction-max-length</span><span class="ef-d">' as the total character '</span><span style="color: #b751b6; text-decoration: italic;">budget</span><span class="ef-d">' for the WORDS
and truncate individual words to conform to this budget.

To arrive at a budget that accounts for words undershooting their requisite average length,
the number of characters in the budget freed by short words is distributed among the words
exceeding the average length.  This adjusts the per-word budget to be the maximum feasable for
this particular situation, rather than the universal maximum average.

This budget-adjusted per-word maximum length is given by the mathematical expression below:

max length = \\floor{ \\frac{total length - chars for seperators - \\sum_{word \\leq average length} length(word) }{num(words) &gt; average length} }"</span>
  <span class="ef-cd">;; </span><span class="ef-c">trucate each word to a max word length determined by
</span>  <span class="ef-cd">;;</span>
  (<span class="ef-k">let*</span> ((total-length-budget (- org-reference-contraction-max-length  <span class="ef-cd">; </span><span class="ef-c">how many non-separator chars we can use
</span>                                 (1- (length words))))
         (word-length-budget (/ total-length-budget                      <span class="ef-cd">; </span><span class="ef-c">max length of each word to keep within budget
</span>                                org-reference-contraction-max-words))
         (num-overlong (-count (<span class="ef-k">lambda</span> (word)                            <span class="ef-cd">; </span><span class="ef-c">how many words exceed that budget
</span>                                 (&gt; (length word) word-length-budget))
                               words))
         (total-short-length (-sum (mapcar (<span class="ef-k">lambda</span> (word)                <span class="ef-cd">; </span><span class="ef-c">total length of words under that budget
</span>                                             (<span class="ef-k">if</span> (&lt;= (length word) word-length-budget)
                                                 (length word) 0))
                                           words)))
         (max-length (/ (- total-length-budget total-short-length)       <span class="ef-cd">; </span><span class="ef-c">max(max-length) that we can have to fit within the budget
</span>                        num-overlong)))
    (mapcar (<span class="ef-k">lambda</span> (word)
              (<span class="ef-k">if</span> (&lt;= (length word) max-length)
                  word
                (substring word 0 max-length)))
            words)))

(<span class="ef-k">defun</span> <span class="ef-f">org-reference-contraction</span> (reference-string)
  <span class="ef-d">"Give a contracted form of REFERENCE-STRING that is only contains alphanumeric characters.
Strips '</span><span style="color: #b751b6; text-decoration: italic;">joining</span><span class="ef-d">' words present in `</span><span style="color: #b751b6; text-decoration: italic;">org-reference-contraction-stripped-words</span><span class="ef-d">',
and then limits the result to the first `</span><span style="color: #b751b6; text-decoration: italic;">org-reference-contraction-max-words</span><span class="ef-d">' words.
If the total length is &gt; `</span><span style="color: #b751b6; text-decoration: italic;">org-reference-contraction-max-length</span><span class="ef-d">' then individual words are
truncated to fit within the limit using `</span><span style="color: #b751b6; text-decoration: italic;">org-reference-contraction-truncate-words</span><span class="ef-d">'."</span>
  (<span class="ef-k">let</span> ((reference-words
         (cl-remove-if-not
          (<span class="ef-k">lambda</span> (word)
            (not (member word org-reference-contraction-stripped-words)))
          (<span class="ef-k">let</span> ((str reference-string))
            (<span class="ef-k">setq</span> str (downcase str))
            (<span class="ef-k">setq</span> str (replace-regexp-in-string <span class="ef-s">"\\[\\[[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">]]+\\]\\[</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">]]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">\\]\\]"</span> <span class="ef-s">"\\1"</span> str)) <span class="ef-cd">; </span><span class="ef-c">get description from org-link
</span>            (<span class="ef-k">setq</span> str (replace-regexp-in-string <span class="ef-s">"[-/ ]+"</span> <span class="ef-s">" "</span> str)) <span class="ef-cd">; </span><span class="ef-c">replace seperator-type chars with space
</span>            (<span class="ef-k">setq</span> str (puny-encode-string str))
            (<span class="ef-k">setq</span> str (replace-regexp-in-string <span class="ef-s">"^xn--</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.*?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s"> ?-?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[a-z0-9]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">$"</span> <span class="ef-s">"\\2 \\1"</span> str)) <span class="ef-cd">; </span><span class="ef-c">rearrange punycode
</span>            (<span class="ef-k">setq</span> str (replace-regexp-in-string <span class="ef-s">"[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">A-Za-z0-9 ]"</span> <span class="ef-s">""</span> str)) <span class="ef-cd">; </span><span class="ef-c">strip chars which need %-encoding in a uri
</span>            (split-string str <span class="ef-s">" +"</span>)))))
    (<span class="ef-k">when</span> (&gt; (length reference-words)
             org-reference-contraction-max-words)
      (<span class="ef-k">setq</span> reference-words
            (cl-subseq reference-words 0 org-reference-contraction-max-words)))

    (<span class="ef-k">when</span> (&gt; (apply #'+ (1- (length reference-words))
                    (mapcar #'length reference-words))
             org-reference-contraction-max-length)
      (<span class="ef-k">setq</span> reference-words (org-reference-contraction-truncate-words reference-words)))

    (string-join reference-words org-reference-contraction-joining-char)))

(<span class="ef-k">define-minor-mode</span> <span class="ef-f">unpackaged/org-export-html-with-useful-ids-mode</span>
  <span class="ef-d">"Attempt to export Org as HTML with useful link IDs.
Instead of random IDs like \"#orga1b2c3\", use heading titles,
made unique when necessary."</span>
  <span class="ef-b">:global</span> t
  (<span class="ef-k">if</span> unpackaged/org-export-html-with-useful-ids-mode
      (advice-add #'org-export-get-reference <span class="ef-b">:override</span> #'unpackaged/org-export-get-reference)
    (advice-remove #'org-export-get-reference #'unpackaged/org-export-get-reference)))
(unpackaged/org-export-html-with-useful-ids-mode 1) <span class="ef-cd">; </span><span class="ef-c">ensure enabled, and advice run
</span>
(<span class="ef-k">defun</span> <span class="ef-f">unpackaged/org-export-get-reference</span> (datum info)
  <span class="ef-d">"Like `</span><span style="color: #b751b6; text-decoration: italic;">org-export-get-reference</span><span class="ef-d">', except uses heading titles instead of random numbers."</span>
  (<span class="ef-k">let</span> ((cache (plist-get info <span class="ef-b">:internal-references</span>)))
    (<span class="ef-k">or</span> (car (rassq datum cache))
        (<span class="ef-k">let*</span> ((crossrefs (plist-get info <span class="ef-b">:crossrefs</span>))
               (cells (org-export-search-cells datum))
               <span class="ef-cd">;; </span><span class="ef-c">Preserve any pre-existing association between
</span>               <span class="ef-cd">;; </span><span class="ef-c">a search cell and a reference, i.e., when some
</span>               <span class="ef-cd">;; </span><span class="ef-c">previously published document referenced a location
</span>               <span class="ef-cd">;; </span><span class="ef-c">within current file (see
</span>               <span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-publish-resolve-external-link</span><span class="ef-c">').
</span>               <span class="ef-cd">;;</span>
               <span class="ef-cd">;; </span><span class="ef-c">However, there is no guarantee that search cells are
</span>               <span class="ef-cd">;; </span><span class="ef-c">unique, e.g., there might be duplicate custom ID or
</span>               <span class="ef-cd">;; </span><span class="ef-c">two headings with the same title in the file.
</span>               <span class="ef-cd">;;</span>
               <span class="ef-cd">;; </span><span class="ef-c">As a consequence, before re-using any reference to
</span>               <span class="ef-cd">;; </span><span class="ef-c">an element or object, we check that it doesn't refer
</span>               <span class="ef-cd">;; </span><span class="ef-c">to a previous element or object.
</span>               (new (<span class="ef-k">or</span> (cl-some
                         (<span class="ef-k">lambda</span> (cell)
                           (<span class="ef-k">let</span> ((stored (cdr (assoc cell crossrefs))))
                             (<span class="ef-k">when</span> stored
                               (<span class="ef-k">let</span> ((old (org-export-format-reference stored)))
                                 (<span class="ef-k">and</span> (not (assoc old cache)) stored)))))
                         cells)
                        (<span class="ef-k">when</span> (org-element-property <span class="ef-b">:raw-value</span> datum)
                          <span class="ef-cd">;; </span><span class="ef-c">Heading with a title
</span>                          (unpackaged/org-export-new-named-reference datum cache))
                        (<span class="ef-k">when</span> (member (car datum) '(src-block table example fixed-width property-drawer))
                          <span class="ef-cd">;; </span><span class="ef-c">Nameable elements
</span>                          (unpackaged/org-export-new-named-reference datum cache))
                        <span class="ef-cd">;; </span><span class="ef-c">NOTE: This probably breaks some Org Export
</span>                        <span class="ef-cd">;; </span><span class="ef-c">feature, but if it does what I need, fine.
</span>                        (org-export-format-reference
                         (org-export-new-reference cache))))
               (reference-string new))
          <span class="ef-cd">;; </span><span class="ef-c">Cache contains both data already associated to
</span>          <span class="ef-cd">;; </span><span class="ef-c">a reference and in-use internal references, so as to make
</span>          <span class="ef-cd">;; </span><span class="ef-c">unique references.
</span>          (<span class="ef-k">dolist</span> (cell cells) (<span class="ef-k">push</span> (cons cell new) cache))
          <span class="ef-cd">;; </span><span class="ef-c">Retain a direct association between reference string and
</span>          <span class="ef-cd">;; </span><span class="ef-c">DATUM since (1) not every object or element can be given
</span>          <span class="ef-cd">;; </span><span class="ef-c">a search cell (2) it permits quick lookup.
</span>          (<span class="ef-k">push</span> (cons reference-string datum) cache)
          (plist-put info <span class="ef-b">:internal-references</span> cache)
          reference-string))))

(<span class="ef-k">defun</span> <span class="ef-f">unpackaged/org-export-new-named-reference</span> (datum cache)
  <span class="ef-d">"Return new reference for DATUM that is unique in CACHE."</span>
  (<span class="ef-k">cl-macrolet</span> ((inc-suffixf (place)
                  `(<span class="ef-k">progn</span>
                     (string-match (<span class="ef-k">rx</span> bos
                                       (minimal-match (group (1+ anything)))
                                       (optional <span class="ef-s">"--"</span> (group (1+ digit)))
                                       eos)
                                   ,place)
                     <span class="ef-cd">;; </span><span class="ef-c">HACK: `</span><span style="color: #b751b6;">s1</span><span class="ef-c">' instead of a gensym.
</span>                     (<span class="ef-k">let*</span> ((s1 (match-string 1 ,place))
                            (suffix-1 (match-string 2 ,place))
                            (suffix (<span class="ef-k">if</span> suffix-1 (string-to-number suffix-1) 0)))
                       (<span class="ef-k">setf</span> ,place (format <span class="ef-s">"%s--%s"</span> s1 (1+ suffix)))))))
    (<span class="ef-k">let*</span> ((headline-p (eq (car datum) 'headline))
           (title (<span class="ef-k">if</span> headline-p
                      (org-element-property <span class="ef-b">:raw-value</span> datum)
                    (<span class="ef-k">or</span> (org-element-property <span class="ef-b">:name</span> datum)
                        (concat (org-element-property <span class="ef-b">:raw-value</span>
                                                      (org-element-property <span class="ef-b">:parent</span>
                                                                            (org-element-property <span class="ef-b">:parent</span> datum)))))))
           <span class="ef-cd">;; </span><span class="ef-c">get ascii-only form of title without needing percent-encoding
</span>           (ref (concat (org-reference-contraction (substring-no-properties title))
                        (<span class="ef-k">unless</span> (<span class="ef-k">or</span> headline-p (org-element-property <span class="ef-b">:name</span> datum))
                          (concat <span class="ef-s">","</span>
                                  (<span class="ef-k">pcase</span> (car datum)
                                    ('src-block <span class="ef-s">"code"</span>)
                                    ('example <span class="ef-s">"example"</span>)
                                    ('fixed-width <span class="ef-s">"mono"</span>)
                                    ('property-drawer <span class="ef-s">"properties"</span>)
                                    (_ (symbol-name (car datum))))
                                  <span class="ef-s">"--1"</span>))))
           (parent (<span class="ef-k">when</span> headline-p (org-element-property <span class="ef-b">:parent</span> datum))))
      (<span class="ef-k">while</span> (member ref (mapcar #'car cache))
        <span class="ef-cd">;; </span><span class="ef-c">Title not unique: make it so.
</span>        (<span class="ef-k">if</span> parent
            <span class="ef-cd">;; </span><span class="ef-c">Append ancestor title.
</span>            (<span class="ef-k">setf</span> title (concat (org-element-property <span class="ef-b">:raw-value</span> parent)
                                <span class="ef-s">"--"</span> title)
                  <span class="ef-cd">;; </span><span class="ef-c">get ascii-only form of title without needing percent-encoding
</span>                  ref (org-reference-contraction (substring-no-properties title))
                  parent (<span class="ef-k">when</span> headline-p (org-element-property <span class="ef-b">:parent</span> parent)))
          <span class="ef-cd">;; </span><span class="ef-c">No more ancestors: add and increment a number.
</span>          (inc-suffixf ref)))
      ref)))

(add-hook 'org-load-hook #'unpackaged/org-export-html-with-useful-ids-mode)

(<span class="ef-k">defadvice!</span> org-export-format-reference-a (reference)
  <span class="ef-d">"Format REFERENCE into a string.

REFERENCE is a either a number or a string representing a reference,
as returned by `</span><span style="color: #b751b6; text-decoration: italic;">org-export-new-reference</span><span class="ef-d">'."</span>
  <span class="ef-b">:override</span> #'org-export-format-reference
  (<span class="ef-k">if</span> (stringp reference) reference (format <span class="ef-s">"org%07x"</span> reference)))

(<span class="ef-k">defun</span> <span class="ef-f">+org-export-remove-zero-width-space</span> (text _backend _info)
  <span class="ef-d">"Remove zero width spaces from TEXT."</span>
  (<span class="ef-k">unless</span> (org-export-derived-backend-p 'org)
    (replace-regexp-in-string <span class="ef-s">"\u200B"</span> <span class="ef-s">""</span> text)))

(add-to-list 'org-export-filter-final-output-functions #'+org-export-remove-zero-width-space t)

(<span class="ef-k">defun</span> <span class="ef-f">+org-mode--fontlock-only-mode</span> ()
  <span class="ef-d">"Just apply org-mode's font-lock once."</span>
  (<span class="ef-k">let</span> (org-mode-hook
        org-hide-leading-stars
        org-hide-emphasis-markers)
    (org-set-font-lock-defaults)
    (font-lock-ensure))
  (<span class="ef-k">setq-local</span> major-mode #'fundamental-mode))

(<span class="ef-k">defun</span> <span class="ef-f">+org-export-babel-mask-org-config</span> (_backend)
  <span class="ef-d">"Use `</span><span style="color: #b751b6; text-decoration: italic;">+org-mode--fontlock-only-mode</span><span class="ef-d">' instead of `</span><span style="color: #b751b6; text-decoration: italic;">org-mode</span><span class="ef-d">'."</span>
  (<span class="ef-k">setq-local</span> org-src-lang-modes
              (append org-src-lang-modes
                      (list (cons <span class="ef-s">"org"</span> #'+org-mode--fontlock-only)))))

(add-hook 'org-export-before-processing-hook #'+org-export-babel-mask-org-config)

(<span class="ef-k">provide</span> '<span class="ef-o">config-org-exports</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">ox-html
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-url-unfurl-metadata</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-url-fancy-export</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-export-html-headline-anchor</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-html-block-collapsable</span><span class="ef-c">', `</span><span style="color: #b751b6;">mode-name-to-lang-name</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-html-export-collapsed</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-html-reload-fancy-style</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-html-meta-tags-fancy</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-html-meta-tags-opengraph-image</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: ox-html"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'ox-html
(confpkg-with-record '(<span class="ef-s">"load: ox-html"</span> load-hooks)
(<span class="ef-k">define-minor-mode</span> <span class="ef-f">org-fancy-html-export-mode</span>
  <span class="ef-d">"Toggle my fabulous org export tweaks. While this mode itself does a little bit,
the vast majority of the change in behaviour comes from switch statements in:
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-html-template-fancier</span><span class="ef-d">'
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-html--build-meta-info-extended</span><span class="ef-d">'
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-html-src-block-collapsable</span><span class="ef-d">'
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-html-block-collapsable</span><span class="ef-d">'
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-html-table-wrapped</span><span class="ef-d">'
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-html--format-toc-headline-colapseable</span><span class="ef-d">'
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-html--toc-text-stripped-leaves</span><span class="ef-d">'
 - `</span><span style="color: #b751b6; text-decoration: italic;">org-export-html-headline-anchor</span><span class="ef-d">'"</span>
  <span class="ef-b">:global</span> t
  <span class="ef-b">:init-value</span> t
  (<span class="ef-k">if</span> org-fancy-html-export-mode
      (<span class="ef-k">setq</span> org-html-style-default org-html-style-fancy
            org-html-meta-tags #'org-html-meta-tags-fancy
            org-html-checkbox-type 'html-span)
    (<span class="ef-k">setq</span> org-html-style-default org-html-style-plain
          org-html-meta-tags #'org-html-meta-tags-default
          org-html-checkbox-type 'html)))

(<span class="ef-k">defadvice!</span> org-html-template-fancier (orig-fn contents info)
  <span class="ef-d">"Return complete document string after HTML conversion.
CONTENTS is the transcoded contents string.  INFO is a plist
holding export options. Adds a few extra things to the body
compared to the default implementation."</span>
  <span class="ef-b">:around</span> #'org-html-template
  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (not org-fancy-html-export-mode) (<span class="ef-k">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn contents info)
    (concat
     (<span class="ef-k">when</span> (<span class="ef-k">and</span> (not (org-html-html5-p info)) (org-html-xhtml-p info))
       (<span class="ef-k">let*</span> ((xml-declaration (plist-get info <span class="ef-b">:html-xml-declaration</span>))
              (decl (<span class="ef-k">or</span> (<span class="ef-k">and</span> (stringp xml-declaration) xml-declaration)
                        (cdr (assoc (plist-get info <span class="ef-b">:html-extension</span>)
                                    xml-declaration))
                        (cdr (assoc <span class="ef-s">"html"</span> xml-declaration))
                        <span class="ef-s">""</span>)))
         (<span class="ef-k">when</span> (not (<span class="ef-k">or</span> (not decl) (string= <span class="ef-s">""</span> decl)))
           (format <span class="ef-s">"%s\n"</span>
                   (format decl
                           (<span class="ef-k">or</span> (<span class="ef-k">and</span> org-html-coding-system
                                    (fboundp 'coding-system-get)
                                    (coding-system-get org-html-coding-system 'mime-charset))
                               <span class="ef-s">"iso-8859-1"</span>))))))
     (org-html-doctype info)
     <span class="ef-s">"\n"</span>
     (concat <span class="ef-s">"&lt;html"</span>
             (<span class="ef-k">cond</span> ((org-html-xhtml-p info)
                    (format
                     <span class="ef-s">" xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"%s\" xml:lang=\"%s\""</span>
                     (plist-get info <span class="ef-b">:language</span>) (plist-get info <span class="ef-b">:language</span>)))
                   ((org-html-html5-p info)
                    (format <span class="ef-s">" lang=\"%s\""</span> (plist-get info <span class="ef-b">:language</span>))))
             <span class="ef-s">"&gt;\n"</span>)
     <span class="ef-s">"&lt;head&gt;\n"</span>
     (org-html--build-meta-info info)
     (org-html--build-head info)
     (org-html--build-mathjax-config info)
     <span class="ef-s">"&lt;/head&gt;\n"</span>
     <span class="ef-s">"&lt;body&gt;\n&lt;input type='</span><span style="color: #b751b6;">checkbox</span><span class="ef-s">' id='</span><span style="color: #b751b6;">theme-switch</span><span class="ef-s">'&gt;&lt;div id='</span><span style="color: #b751b6;">page</span><span class="ef-s">'&gt;&lt;label id='</span><span style="color: #b751b6;">switch-label</span><span class="ef-s">' for='</span><span style="color: #b751b6;">theme-switch</span><span class="ef-s">'&gt;&lt;/label&gt;"</span>
     (<span class="ef-k">let</span> ((link-up (org-trim (plist-get info <span class="ef-b">:html-link-up</span>)))
           (link-home (org-trim (plist-get info <span class="ef-b">:html-link-home</span>))))
       (<span class="ef-k">unless</span> (<span class="ef-k">and</span> (string= link-up <span class="ef-s">""</span>) (string= link-home <span class="ef-s">""</span>))
         (format (plist-get info <span class="ef-b">:html-home/up-format</span>)
                 (<span class="ef-k">or</span> link-up link-home)
                 (<span class="ef-k">or</span> link-home link-up))))
     <span class="ef-cd">;; </span><span class="ef-c">Preamble.
</span>     (org-html--build-pre/postamble 'preamble info)
     <span class="ef-cd">;; </span><span class="ef-c">Document contents.
</span>     (<span class="ef-k">let</span> ((div (assq 'content (plist-get info <span class="ef-b">:html-divs</span>))))
       (format <span class="ef-s">"&lt;%s id=\"%s\"&gt;\n"</span> (nth 1 div) (nth 2 div)))
     <span class="ef-cd">;; </span><span class="ef-c">Document title.
</span>     (<span class="ef-k">when</span> (plist-get info <span class="ef-b">:with-title</span>)
       (<span class="ef-k">let</span> ((title (<span class="ef-k">and</span> (plist-get info <span class="ef-b">:with-title</span>)
                         (plist-get info <span class="ef-b">:title</span>)))
             (subtitle (plist-get info <span class="ef-b">:subtitle</span>))
             (html5-fancy (org-html--html5-fancy-p info)))
         (<span class="ef-k">when</span> title
           (format
            (<span class="ef-k">if</span> html5-fancy
                <span class="ef-s">"&lt;header class=\"page-header\"&gt;%s\n&lt;h1 class=\"title\"&gt;%s&lt;/h1&gt;\n%s&lt;/header&gt;"</span>
              <span class="ef-s">"&lt;h1 class=\"title\"&gt;%s%s&lt;/h1&gt;\n"</span>)
            (<span class="ef-k">if</span> (<span class="ef-k">or</span> (plist-get info <span class="ef-b">:with-date</span>)
                    (plist-get info <span class="ef-b">:with-author</span>))
                (concat <span class="ef-s">"&lt;div class=\"page-meta\"&gt;"</span>
                        (<span class="ef-k">when</span> (plist-get info <span class="ef-b">:with-date</span>)
                          (org-export-data (plist-get info <span class="ef-b">:date</span>) info))
                        (<span class="ef-k">when</span> (<span class="ef-k">and</span> (plist-get info <span class="ef-b">:with-date</span>) (plist-get info <span class="ef-b">:with-author</span>)) <span class="ef-s">", "</span>)
                        (<span class="ef-k">when</span> (plist-get info <span class="ef-b">:with-author</span>)
                          (org-export-data (plist-get info <span class="ef-b">:author</span>) info))
                        <span class="ef-s">"&lt;/div&gt;\n"</span>)
              <span class="ef-s">""</span>)
            (org-export-data title info)
            (<span class="ef-k">if</span> subtitle
                (format
                 (<span class="ef-k">if</span> html5-fancy
                     <span class="ef-s">"&lt;p class=\"subtitle\" role=\"doc-subtitle\"&gt;%s&lt;/p&gt;\n"</span>
                   (concat <span class="ef-s">"\n"</span> (org-html-close-tag <span class="ef-s">"br"</span> nil info) <span class="ef-s">"\n"</span>
                           <span class="ef-s">"&lt;span class=\"subtitle\"&gt;%s&lt;/span&gt;\n"</span>))
                 (org-export-data subtitle info))
              <span class="ef-s">""</span>)))))
     contents
     (format <span class="ef-s">"&lt;/%s&gt;\n"</span> (nth 1 (assq 'content (plist-get info <span class="ef-b">:html-divs</span>))))
     <span class="ef-cd">;; </span><span class="ef-c">Postamble.
</span>     (org-html--build-pre/postamble 'postamble info)
     <span class="ef-cd">;; </span><span class="ef-c">Possibly use the Klipse library live code blocks.
</span>     (<span class="ef-k">when</span> (plist-get info <span class="ef-b">:html-klipsify-src</span>)
       (concat <span class="ef-s">"&lt;script&gt;"</span> (plist-get info <span class="ef-b">:html-klipse-selection-script</span>)
               <span class="ef-s">"&lt;/script&gt;&lt;script src=\""</span>
               org-html-klipse-js
               <span class="ef-s">"\"&gt;&lt;/script&gt;&lt;link rel=\"stylesheet\" type=\"text/css\" href=\""</span>
               org-html-klipse-css <span class="ef-s">"\"/&gt;"</span>))
     <span class="ef-cd">;; </span><span class="ef-c">Closing document.
</span>     <span class="ef-s">"&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;"</span>)))

(<span class="ef-k">defadvice!</span> org-html-toc-linked (depth info <span class="ef-t">&amp;optional</span> scope)
  <span class="ef-d">"Build a table of contents.

Just like `</span><span style="color: #b751b6; text-decoration: italic;">org-html-toc</span><span class="ef-d">', except the header is a link to \"#\".

DEPTH is an integer specifying the depth of the table.  INFO is
a plist used as a communication channel.  Optional argument SCOPE
is an element defining the scope of the table.  Return the table
of contents as a string, or nil if it is empty."</span>
  <span class="ef-b">:override</span> #'org-html-toc
  (<span class="ef-k">let</span> ((toc-entries
         (mapcar (<span class="ef-k">lambda</span> (headline)
                   (cons (org-html--format-toc-headline headline info)
                         (org-export-get-relative-level headline info)))
                 (org-export-collect-headlines info depth scope))))
    (<span class="ef-k">when</span> toc-entries
      (<span class="ef-k">let</span> ((toc (concat <span class="ef-s">"&lt;div id=\"text-table-of-contents\"&gt;"</span>
                         (org-html--toc-text toc-entries)
                         <span class="ef-s">"&lt;/div&gt;\n"</span>)))
        (<span class="ef-k">if</span> scope toc
          (<span class="ef-k">let</span> ((outer-tag (<span class="ef-k">if</span> (org-html--html5-fancy-p info)
                               <span class="ef-s">"nav"</span>
                             <span class="ef-s">"div"</span>)))
            (concat (format <span class="ef-s">"&lt;%s id=\"table-of-contents\"&gt;\n"</span> outer-tag)
                    (<span class="ef-k">let</span> ((top-level (plist-get info <span class="ef-b">:html-toplevel-hlevel</span>)))
                      (format <span class="ef-s">"&lt;h%d&gt;&lt;a href=\"#\" style=\"color:inherit; text-decoration: none;\"&gt;%s&lt;/a&gt;&lt;/h%d&gt;\n"</span>
                              top-level
                              (org-html--translate <span class="ef-s">"Table of Contents"</span> info)
                              top-level))
                    toc
                    (format <span class="ef-s">"&lt;/%s&gt;\n"</span> outer-tag))))))))

(<span class="ef-k">defvar</span> <span class="ef-v">org-html-meta-tags-opengraph-image</span>
  '(<span class="ef-b">:image</span> <span class="ef-s">"https://tecosaur.com/resources/org/nib.png"</span>
    <span class="ef-b">:type</span> <span class="ef-s">"image/png"</span>
    <span class="ef-b">:width</span> <span class="ef-s">"200"</span>
    <span class="ef-b">:height</span> <span class="ef-s">"200"</span>
    <span class="ef-b">:alt</span> <span class="ef-s">"Green fountain pen nib"</span>)
  <span class="ef-d">"Plist of og:image:PROP properties and their value, for use in `</span><span style="color: #b751b6; text-decoration: italic;">org-html-meta-tags-fancy</span><span class="ef-d">'."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">org-html-meta-tags-fancy</span> (info)
  <span class="ef-d">"Use the INFO plist to construct the meta tags, as described in `</span><span style="color: #b751b6; text-decoration: italic;">org-html-meta-tags</span><span class="ef-d">'."</span>
  (<span class="ef-k">let*</span> ((title (org-html-plain-text
                 (org-element-interpret-data (plist-get info <span class="ef-b">:title</span>)) info))
         (author (<span class="ef-k">and</span> (plist-get info <span class="ef-b">:with-author</span>)
                      (<span class="ef-k">let</span> ((auth (plist-get info <span class="ef-b">:author</span>)))
                        <span class="ef-cd">;; </span><span class="ef-c">Return raw Org syntax.
</span>                        (<span class="ef-k">and</span> auth (org-html-plain-text
                                   (org-element-interpret-data auth) info)))))
         (author-first-last
          (<span class="ef-k">and</span> (not (org-string-nw-p author))
               (<span class="ef-k">save-match-data</span>
                 (<span class="ef-k">if</span> (string-match <span class="ef-s">"\\`</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.+?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s"> +</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.+?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">\\'"</span> author)
                     (cons (match-string 1 author)
                           (match-string 2 author))
                   (cons author nil))))))
    (append
     (list
      (<span class="ef-k">when</span> (org-string-nw-p author)
        (list <span class="ef-s">"name"</span> <span class="ef-s">"author"</span> author))
      (<span class="ef-k">when</span> (org-string-nw-p (plist-get info <span class="ef-b">:description</span>))
        (list <span class="ef-s">"name"</span> <span class="ef-s">"description"</span>
              (plist-get info <span class="ef-b">:description</span>)))
      '(<span class="ef-s">"name"</span> <span class="ef-s">"generator"</span> <span class="ef-s">"org mode"</span>)
      '(<span class="ef-s">"name"</span> <span class="ef-s">"theme-color"</span> <span class="ef-s">"#77aa99"</span>)
      '(<span class="ef-s">"property"</span> <span class="ef-s">"og:type"</span> <span class="ef-s">"article"</span>)
      (list <span class="ef-s">"property"</span> <span class="ef-s">"og:title"</span> title)
      (<span class="ef-k">let</span> ((subtitle (org-export-data (plist-get info <span class="ef-b">:subtitle</span>) info)))
        (<span class="ef-k">when</span> (org-string-nw-p subtitle)
          (list <span class="ef-s">"property"</span> <span class="ef-s">"og:description"</span> subtitle))))
     (<span class="ef-k">when</span> org-html-meta-tags-opengraph-image
       (list (list <span class="ef-s">"property"</span> <span class="ef-s">"og:image"</span> (plist-get org-html-meta-tags-opengraph-image <span class="ef-b">:image</span>))
             (list <span class="ef-s">"property"</span> <span class="ef-s">"og:image:type"</span> (plist-get org-html-meta-tags-opengraph-image <span class="ef-b">:type</span>))
             (list <span class="ef-s">"property"</span> <span class="ef-s">"og:image:width"</span> (plist-get org-html-meta-tags-opengraph-image <span class="ef-b">:width</span>))
             (list <span class="ef-s">"property"</span> <span class="ef-s">"og:image:height"</span> (plist-get org-html-meta-tags-opengraph-image <span class="ef-b">:height</span>))
             (list <span class="ef-s">"property"</span> <span class="ef-s">"og:image:alt"</span> (plist-get org-html-meta-tags-opengraph-image <span class="ef-b">:alt</span>))))
     (list
      (<span class="ef-k">when</span> (car author-first-last)
        (list <span class="ef-s">"property"</span> <span class="ef-s">"og:article:author:first_name"</span> (car author-first-last)))
      (<span class="ef-k">when</span> (cdr author-first-last)
        (list <span class="ef-s">"property"</span> <span class="ef-s">"og:article:author:last_name"</span> (cdr author-first-last)))
      (list <span class="ef-s">"property"</span> <span class="ef-s">"og:article:published_time"</span>
            (format-time-string
             <span class="ef-s">"%FT%T%z"</span>
             (<span class="ef-k">or</span>
              (<span class="ef-k">when-let</span> ((date-str (cadar (org-collect-keywords '(<span class="ef-s">"DATE"</span>)))))
                (<span class="ef-k">unless</span> (string= date-str (format-time-string <span class="ef-s">"%F"</span>))
                  (<span class="ef-k">ignore-errors</span> (encode-time (org-parse-time-string date-str)))))
              (<span class="ef-k">if</span> buffer-file-name
                  (file-attribute-modification-time (file-attributes buffer-file-name))
                (current-time)))))
      (<span class="ef-k">when</span> buffer-file-name
        (list <span class="ef-s">"property"</span> <span class="ef-s">"og:article:modified_time"</span>
              (format-time-string <span class="ef-s">"%FT%T%z"</span> (file-attribute-modification-time (file-attributes buffer-file-name)))))))))

(<span class="ef-k">unless</span> (functionp #'org-html-meta-tags-default)
  (<span class="ef-k">defalias</span> '<span class="ef-f">org-html-meta-tags-default</span> #'ignore))
(<span class="ef-k">setq</span> org-html-meta-tags #'org-html-meta-tags-fancy)

(<span class="ef-k">setq</span> org-html-style-plain org-html-style-default
      org-html-htmlize-output-type 'css
      org-html-doctype <span class="ef-s">"html5"</span>
      org-html-html5-fancy t)

(<span class="ef-k">defun</span> <span class="ef-f">org-html-reload-fancy-style</span> ()
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">setq</span> org-html-style-fancy
        (<span class="ef-k">with-temp-buffer</span>
          (insert-file-contents (expand-file-name <span class="ef-s">"misc/org-export-header.html"</span> doom-user-dir))
          (goto-char (point-max))
          (insert <span class="ef-s">"&lt;script&gt;\n"</span>)
          (insert-file-contents (expand-file-name <span class="ef-s">"misc/org-css/main.js"</span> doom-user-dir))
          (goto-char (point-max))
          (insert <span class="ef-s">"&lt;/script&gt;\n&lt;style&gt;\n"</span>)
          (insert-file-contents (expand-file-name <span class="ef-s">"misc/org-css/main.min.css"</span> doom-user-dir))
          (goto-char (point-max))
          (insert <span class="ef-s">"&lt;/style&gt;"</span>)
          (buffer-string)))
  (<span class="ef-k">when</span> org-fancy-html-export-mode
    (<span class="ef-k">setq</span> org-html-style-default org-html-style-fancy)))
(org-html-reload-fancy-style)

(<span class="ef-k">defvar</span> <span class="ef-v">org-html-export-collapsed</span> nil)
(eval '(cl-pushnew '(<span class="ef-b">:collapsed</span> <span class="ef-s">"COLLAPSED"</span> <span class="ef-s">"collapsed"</span> org-html-export-collapsed t)
                   (org-export-backend-options (org-export-get-backend 'html))))
(add-to-list 'org-default-properties <span class="ef-s">"EXPORT_COLLAPSED"</span>)

(<span class="ef-k">defadvice!</span> org-html-src-block-collapsable (orig-fn src-block contents info)
  <span class="ef-d">"Wrap the usual &lt;pre&gt; block in a &lt;details&gt;"</span>
  <span class="ef-b">:around</span> #'org-html-src-block
  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (not org-fancy-html-export-mode) (<span class="ef-k">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn src-block contents info)
    (<span class="ef-k">let*</span> ((properties (cadr src-block))
           (lang (mode-name-to-lang-name
                  (plist-get properties <span class="ef-b">:language</span>)))
           (name (plist-get properties <span class="ef-b">:name</span>))
           (ref (org-export-get-reference src-block info))
           (collapsed-p (member (<span class="ef-k">or</span> (org-export-read-attribute <span class="ef-b">:attr_html</span> src-block <span class="ef-b">:collapsed</span>)
                                    (plist-get info <span class="ef-b">:collapsed</span>))
                                '(<span class="ef-s">"y"</span> <span class="ef-s">"yes"</span> <span class="ef-s">"t"</span> t <span class="ef-s">"true"</span> <span class="ef-s">"all"</span>))))
      (format
       <span class="ef-s">"&lt;details id='</span><span style="color: #b751b6;">%s</span><span class="ef-s">' class='</span><span style="color: #b751b6;">code</span><span class="ef-s">'%s&gt;&lt;summary%s&gt;%s&lt;/summary&gt;
&lt;div class='</span><span style="color: #b751b6;">gutter</span><span class="ef-s">'&gt;
&lt;a href='#%s'&gt;#&lt;/a&gt;
&lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;â&lt;/button&gt;\
&lt;/div&gt;
%s
&lt;/details&gt;"</span>
       ref
       (<span class="ef-k">if</span> collapsed-p <span class="ef-s">""</span> <span class="ef-s">" open"</span>)
       (<span class="ef-k">if</span> name <span class="ef-s">" class='</span><span style="color: #b751b6;">named</span><span class="ef-s">'"</span> <span class="ef-s">""</span>)
       (concat
        (<span class="ef-k">when</span> name (concat <span class="ef-s">"&lt;span class=\"name\"&gt;"</span> name <span class="ef-s">"&lt;/span&gt;"</span>))
        <span class="ef-s">"&lt;span class=\"lang\"&gt;"</span> lang <span class="ef-s">"&lt;/span&gt;"</span>)
       ref
       (<span class="ef-k">if</span> name
           (replace-regexp-in-string (format <span class="ef-s">"&lt;pre</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s"> class=\"[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">\"]+\"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">? id=\"%s\"&gt;"</span> ref) <span class="ef-s">"&lt;pre\\1&gt;"</span>
                                     (funcall orig-fn src-block contents info))
         (funcall orig-fn src-block contents info))))))

(<span class="ef-k">defun</span> <span class="ef-f">mode-name-to-lang-name</span> (mode)
  (<span class="ef-k">or</span> (cadr (assoc mode
                   '((<span class="ef-s">"asymptote"</span> <span class="ef-s">"Asymptote"</span>)
                     (<span class="ef-s">"awk"</span> <span class="ef-s">"Awk"</span>)
                     (<span class="ef-s">"C"</span> <span class="ef-s">"C"</span>)
                     (<span class="ef-s">"clojure"</span> <span class="ef-s">"Clojure"</span>)
                     (<span class="ef-s">"css"</span> <span class="ef-s">"CSS"</span>)
                     (<span class="ef-s">"D"</span> <span class="ef-s">"D"</span>)
                     (<span class="ef-s">"ditaa"</span> <span class="ef-s">"ditaa"</span>)
                     (<span class="ef-s">"dot"</span> <span class="ef-s">"Graphviz"</span>)
                     (<span class="ef-s">"calc"</span> <span class="ef-s">"Emacs Calc"</span>)
                     (<span class="ef-s">"emacs-lisp"</span> <span class="ef-s">"Emacs Lisp"</span>)
                     (<span class="ef-s">"fortran"</span> <span class="ef-s">"Fortran"</span>)
                     (<span class="ef-s">"gnuplot"</span> <span class="ef-s">"gnuplot"</span>)
                     (<span class="ef-s">"haskell"</span> <span class="ef-s">"Haskell"</span>)
                     (<span class="ef-s">"hledger"</span> <span class="ef-s">"hledger"</span>)
                     (<span class="ef-s">"java"</span> <span class="ef-s">"Java"</span>)
                     (<span class="ef-s">"js"</span> <span class="ef-s">"Javascript"</span>)
                     (<span class="ef-s">"latex"</span> <span class="ef-s">"LaTeX"</span>)
                     (<span class="ef-s">"ledger"</span> <span class="ef-s">"Ledger"</span>)
                     (<span class="ef-s">"lisp"</span> <span class="ef-s">"Lisp"</span>)
                     (<span class="ef-s">"lilypond"</span> <span class="ef-s">"Lilypond"</span>)
                     (<span class="ef-s">"lua"</span> <span class="ef-s">"Lua"</span>)
                     (<span class="ef-s">"matlab"</span> <span class="ef-s">"MATLAB"</span>)
                     (<span class="ef-s">"mscgen"</span> <span class="ef-s">"Mscgen"</span>)
                     (<span class="ef-s">"ocaml"</span> <span class="ef-s">"Objective Caml"</span>)
                     (<span class="ef-s">"octave"</span> <span class="ef-s">"Octave"</span>)
                     (<span class="ef-s">"org"</span> <span class="ef-s">"Org mode"</span>)
                     (<span class="ef-s">"oz"</span> <span class="ef-s">"OZ"</span>)
                     (<span class="ef-s">"plantuml"</span> <span class="ef-s">"Plantuml"</span>)
                     (<span class="ef-s">"processing"</span> <span class="ef-s">"Processing.js"</span>)
                     (<span class="ef-s">"python"</span> <span class="ef-s">"Python"</span>)
                     (<span class="ef-s">"R"</span> <span class="ef-s">"R"</span>)
                     (<span class="ef-s">"ruby"</span> <span class="ef-s">"Ruby"</span>)
                     (<span class="ef-s">"sass"</span> <span class="ef-s">"Sass"</span>)
                     (<span class="ef-s">"scheme"</span> <span class="ef-s">"Scheme"</span>)
                     (<span class="ef-s">"screen"</span> <span class="ef-s">"Gnu Screen"</span>)
                     (<span class="ef-s">"sed"</span> <span class="ef-s">"Sed"</span>)
                     (<span class="ef-s">"sh"</span> <span class="ef-s">"shell"</span>)
                     (<span class="ef-s">"sql"</span> <span class="ef-s">"SQL"</span>)
                     (<span class="ef-s">"sqlite"</span> <span class="ef-s">"SQLite"</span>)
                     (<span class="ef-s">"forth"</span> <span class="ef-s">"Forth"</span>)
                     (<span class="ef-s">"io"</span> <span class="ef-s">"IO"</span>)
                     (<span class="ef-s">"J"</span> <span class="ef-s">"J"</span>)
                     (<span class="ef-s">"makefile"</span> <span class="ef-s">"Makefile"</span>)
                     (<span class="ef-s">"maxima"</span> <span class="ef-s">"Maxima"</span>)
                     (<span class="ef-s">"perl"</span> <span class="ef-s">"Perl"</span>)
                     (<span class="ef-s">"picolisp"</span> <span class="ef-s">"Pico Lisp"</span>)
                     (<span class="ef-s">"scala"</span> <span class="ef-s">"Scala"</span>)
                     (<span class="ef-s">"shell"</span> <span class="ef-s">"Shell Script"</span>)
                     (<span class="ef-s">"ebnf2ps"</span> <span class="ef-s">"ebfn2ps"</span>)
                     (<span class="ef-s">"cpp"</span> <span class="ef-s">"C++"</span>)
                     (<span class="ef-s">"abc"</span> <span class="ef-s">"ABC"</span>)
                     (<span class="ef-s">"coq"</span> <span class="ef-s">"Coq"</span>)
                     (<span class="ef-s">"groovy"</span> <span class="ef-s">"Groovy"</span>)
                     (<span class="ef-s">"bash"</span> <span class="ef-s">"bash"</span>)
                     (<span class="ef-s">"csh"</span> <span class="ef-s">"csh"</span>)
                     (<span class="ef-s">"ash"</span> <span class="ef-s">"ash"</span>)
                     (<span class="ef-s">"dash"</span> <span class="ef-s">"dash"</span>)
                     (<span class="ef-s">"ksh"</span> <span class="ef-s">"ksh"</span>)
                     (<span class="ef-s">"mksh"</span> <span class="ef-s">"mksh"</span>)
                     (<span class="ef-s">"posh"</span> <span class="ef-s">"posh"</span>)
                     (<span class="ef-s">"ada"</span> <span class="ef-s">"Ada"</span>)
                     (<span class="ef-s">"asm"</span> <span class="ef-s">"Assembler"</span>)
                     (<span class="ef-s">"caml"</span> <span class="ef-s">"Caml"</span>)
                     (<span class="ef-s">"delphi"</span> <span class="ef-s">"Delphi"</span>)
                     (<span class="ef-s">"html"</span> <span class="ef-s">"HTML"</span>)
                     (<span class="ef-s">"idl"</span> <span class="ef-s">"IDL"</span>)
                     (<span class="ef-s">"mercury"</span> <span class="ef-s">"Mercury"</span>)
                     (<span class="ef-s">"metapost"</span> <span class="ef-s">"MetaPost"</span>)
                     (<span class="ef-s">"modula-2"</span> <span class="ef-s">"Modula-2"</span>)
                     (<span class="ef-s">"pascal"</span> <span class="ef-s">"Pascal"</span>)
                     (<span class="ef-s">"ps"</span> <span class="ef-s">"PostScript"</span>)
                     (<span class="ef-s">"prolog"</span> <span class="ef-s">"Prolog"</span>)
                     (<span class="ef-s">"simula"</span> <span class="ef-s">"Simula"</span>)
                     (<span class="ef-s">"tcl"</span> <span class="ef-s">"tcl"</span>)
                     (<span class="ef-s">"tex"</span> <span class="ef-s">"LaTeX"</span>)
                     (<span class="ef-s">"plain-tex"</span> <span class="ef-s">"TeX"</span>)
                     (<span class="ef-s">"verilog"</span> <span class="ef-s">"Verilog"</span>)
                     (<span class="ef-s">"vhdl"</span> <span class="ef-s">"VHDL"</span>)
                     (<span class="ef-s">"xml"</span> <span class="ef-s">"XML"</span>)
                     (<span class="ef-s">"nxml"</span> <span class="ef-s">"XML"</span>)
                     (<span class="ef-s">"conf"</span> <span class="ef-s">"Configuration File"</span>))))
      mode))

(<span class="ef-k">defun</span> <span class="ef-f">org-html-block-collapsable</span> (orig-fn block contents info)
  <span class="ef-d">"Wrap the usual block in a &lt;details&gt;"</span>
  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (not org-fancy-html-export-mode) (<span class="ef-k">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn block contents info)
    (<span class="ef-k">let</span> ((ref (org-export-get-reference block info))
          (type (<span class="ef-k">pcase</span> (car block)
                  ('property-drawer <span class="ef-s">"Properties"</span>)))
          (collapsed-default (<span class="ef-k">pcase</span> (car block)
                               ('property-drawer t)
                               (_ nil)))
          (collapsed-value (org-export-read-attribute <span class="ef-b">:attr_html</span> block <span class="ef-b">:collapsed</span>))
          (collapsed-p (<span class="ef-k">or</span> (member (org-export-read-attribute <span class="ef-b">:attr_html</span> block <span class="ef-b">:collapsed</span>)
                                   '(<span class="ef-s">"y"</span> <span class="ef-s">"yes"</span> <span class="ef-s">"t"</span> t <span class="ef-s">"true"</span>))
                           (member (plist-get info <span class="ef-b">:collapsed</span>) '(<span class="ef-s">"all"</span>)))))
      (format
       <span class="ef-s">"&lt;details id='</span><span style="color: #b751b6;">%s</span><span class="ef-s">' class='</span><span style="color: #b751b6;">code</span><span class="ef-s">'%s&gt;
&lt;summary%s&gt;%s&lt;/summary&gt;
&lt;div class='</span><span style="color: #b751b6;">gutter</span><span class="ef-s">'&gt;\
&lt;a href='#%s'&gt;#&lt;/a&gt;
&lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;â&lt;/button&gt;\
&lt;/div&gt;
%s\n
&lt;/details&gt;"</span>
       ref
       (<span class="ef-k">if</span> (<span class="ef-k">or</span> collapsed-p collapsed-default) <span class="ef-s">""</span> <span class="ef-s">" open"</span>)
       (<span class="ef-k">if</span> type <span class="ef-s">" class='</span><span style="color: #b751b6;">named</span><span class="ef-s">'"</span> <span class="ef-s">""</span>)
       (<span class="ef-k">if</span> type (format <span class="ef-s">"&lt;span class='</span><span style="color: #b751b6;">type</span><span class="ef-s">'&gt;%s&lt;/span&gt;"</span> type) <span class="ef-s">""</span>)
       ref
       (funcall orig-fn block contents info)))))

(advice-add 'org-html-example-block   <span class="ef-b">:around</span> #'org-html-block-collapsable)
(advice-add 'org-html-fixed-width     <span class="ef-b">:around</span> #'org-html-block-collapsable)
(advice-add 'org-html-property-drawer <span class="ef-b">:around</span> #'org-html-block-collapsable)

(autoload #'highlight-numbers--turn-on <span class="ef-s">"highlight-numbers"</span>)
(add-hook 'htmlize-before-hook #'highlight-numbers--turn-on)

(<span class="ef-k">defadvice!</span> org-html-table-wrapped (orig-fn table contents info)
  <span class="ef-d">"Wrap the usual &lt;table&gt; in a &lt;div&gt;"</span>
  <span class="ef-b">:around</span> #'org-html-table
  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (not org-fancy-html-export-mode) (<span class="ef-k">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn table contents info)
    (<span class="ef-k">let*</span> ((name (plist-get (cadr table) <span class="ef-b">:name</span>))
           (ref (org-export-get-reference table info)))
      (format <span class="ef-s">"&lt;div id='</span><span style="color: #b751b6;">%s</span><span class="ef-s">' class='</span><span style="color: #b751b6;">table</span><span class="ef-s">'&gt;
&lt;div class='</span><span style="color: #b751b6;">gutter</span><span class="ef-s">'&gt;&lt;a href='#%s'&gt;#&lt;/a&gt;&lt;/div&gt;
&lt;div class='</span><span style="color: #b751b6;">tabular</span><span class="ef-s">'&gt;
%s
&lt;/div&gt;\
&lt;/div&gt;"</span>
              ref ref
              (<span class="ef-k">if</span> name
                  (replace-regexp-in-string (format <span class="ef-s">"&lt;table id=\"%s\""</span> ref) <span class="ef-s">"&lt;table"</span>
                                            (funcall orig-fn table contents info))
                (funcall orig-fn table contents info))))))

(<span class="ef-k">defadvice!</span> org-html--format-toc-headline-colapseable (orig-fn headline info)
  <span class="ef-d">"Add a label and checkbox to `</span><span style="color: #b751b6; text-decoration: italic;">org-html--format-toc-headline</span><span class="ef-d">'s usual output,
to allow the TOC to be a collapseable tree."</span>
  <span class="ef-b">:around</span> #'org-html--format-toc-headline
  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (not org-fancy-html-export-mode) (<span class="ef-k">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn headline info)
    (<span class="ef-k">let</span> ((id (<span class="ef-k">or</span> (org-element-property <span class="ef-b">:CUSTOM_ID</span> headline)
                  (org-export-get-reference headline info))))
      (format <span class="ef-s">"&lt;input type='</span><span style="color: #b751b6;">checkbox</span><span class="ef-s">' id='</span><span style="color: #b751b6;">toc--%s</span><span class="ef-s">'/&gt;&lt;label for='</span><span style="color: #b751b6;">toc--%s</span><span class="ef-s">'&gt;%s&lt;/label&gt;"</span>
              id id (funcall orig-fn headline info)))))

(<span class="ef-k">defadvice!</span> org-html--toc-text-stripped-leaves (orig-fn toc-entries)
  <span class="ef-d">"Remove label"</span>
  <span class="ef-b">:around</span> #'org-html--toc-text
  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (not org-fancy-html-export-mode) (<span class="ef-k">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn toc-entries)
    (replace-regexp-in-string <span class="ef-s">"&lt;input [</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">&gt;]+&gt;&lt;label [</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">&gt;]+&gt;</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.+?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">&lt;/label&gt;&lt;/li&gt;"</span> <span class="ef-s">"\\1&lt;/li&gt;"</span>
                              (funcall orig-fn toc-entries))))

(<span class="ef-k">setq</span> org-html-text-markup-alist
      '((bold . <span class="ef-s">"&lt;b&gt;%s&lt;/b&gt;"</span>)
        (code . <span class="ef-s">"&lt;code&gt;%s&lt;/code&gt;"</span>)
        (italic . <span class="ef-s">"&lt;i&gt;%s&lt;/i&gt;"</span>)
        (strike-through . <span class="ef-s">"&lt;del&gt;%s&lt;/del&gt;"</span>)
        (underline . <span class="ef-s">"&lt;span class=\"underline\"&gt;%s&lt;/span&gt;"</span>)
        (verbatim . <span class="ef-s">"&lt;kbd&gt;%s&lt;/kbd&gt;"</span>)))

(<span class="ef-k">appendq!</span> org-html-checkbox-types
          '((html-span
             (on . <span class="ef-s">"&lt;span class='</span><span style="color: #b751b6;">checkbox</span><span class="ef-s">'&gt;&lt;/span&gt;"</span>)
             (off . <span class="ef-s">"&lt;span class='</span><span style="color: #b751b6;">checkbox</span><span class="ef-s">'&gt;&lt;/span&gt;"</span>)
             (trans . <span class="ef-s">"&lt;span class='</span><span style="color: #b751b6;">checkbox</span><span class="ef-s">'&gt;&lt;/span&gt;"</span>))))
(<span class="ef-k">setq</span> org-html-checkbox-type 'html-span)

(<span class="ef-k">pushnew!</span> org-html-special-string-regexps
          '(<span class="ef-s">"-&amp;gt;"</span> . <span class="ef-s">"&amp;#8594;"</span>)
          '(<span class="ef-s">"&amp;lt;-"</span> . <span class="ef-s">"&amp;#8592;"</span>))

(<span class="ef-k">defun</span> <span class="ef-f">org-export-html-headline-anchor</span> (text backend info)
  (<span class="ef-k">when</span> (<span class="ef-k">and</span> (org-export-derived-backend-p backend 'html)
             (not (org-export-derived-backend-p backend 're-reveal))
             org-fancy-html-export-mode)
    (<span class="ef-k">unless</span> (<span class="ef-k">bound-and-true-p</span> org-msg-export-in-progress)
      (replace-regexp-in-string
       <span class="ef-s">"&lt;h</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[0-9]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s"> id=\"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[a-z0-9-]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">\"&gt;</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">.*[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s"> ]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">&lt;\\/h[0-9]&gt;"</span> <span class="ef-cd">; </span><span class="ef-c">this is quite restrictive, but due to `</span><span style="color: #b751b6;">org-reference-contraction</span><span class="ef-c">' I can do this
</span>       <span class="ef-s">"&lt;h\\1 id=\"\\2\"&gt;\\3&lt;a aria-hidden=\"true\" href=\"#\\2\"&gt;#&lt;/a&gt; &lt;/h\\1&gt;"</span>
       text))))

(add-to-list 'org-export-filter-headline-functions
             'org-export-html-headline-anchor)

(org-link-set-parameters <span class="ef-s">"Https"</span>
                         <span class="ef-b">:follow</span> (<span class="ef-k">lambda</span> (url arg) (browse-url (concat <span class="ef-s">"https:"</span> url) arg))
                         <span class="ef-b">:export</span> #'org-url-fancy-export)

(<span class="ef-k">defun</span> <span class="ef-f">org-url-fancy-export</span> (url _desc backend)
  (<span class="ef-k">let</span> ((metadata (org-url-unfurl-metadata (concat <span class="ef-s">"https:"</span> url))))
    (<span class="ef-k">cond</span>
     ((org-export-derived-backend-p backend 'html)
      (concat
       <span class="ef-s">"&lt;div class=\"link-preview\"&gt;"</span>
       (format <span class="ef-s">"&lt;a href=\"%s\"&gt;"</span> (concat <span class="ef-s">"https:"</span> url))
       (<span class="ef-k">when</span> (plist-get metadata <span class="ef-b">:image</span>)
         (format <span class="ef-s">"&lt;img src=\"%s\"/&gt;"</span> (plist-get metadata <span class="ef-b">:image</span>)))
       <span class="ef-s">"&lt;small&gt;"</span>
       (replace-regexp-in-string <span class="ef-s">"//</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">www\\.</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">/?.*"</span> <span class="ef-s">"\\1"</span> url)
       <span class="ef-s">"&lt;/small&gt;&lt;p&gt;"</span>
       (<span class="ef-k">when</span> (plist-get metadata <span class="ef-b">:title</span>)
         (concat <span class="ef-s">"&lt;b&gt;"</span> (org-html-encode-plain-text (plist-get metadata <span class="ef-b">:title</span>)) <span class="ef-s">"&lt;/b&gt;&lt;/br&gt;"</span>))
       (<span class="ef-k">when</span> (plist-get metadata <span class="ef-b">:description</span>)
         (org-html-encode-plain-text (plist-get metadata <span class="ef-b">:description</span>)))
       <span class="ef-s">"&lt;/p&gt;&lt;/a&gt;&lt;/div&gt;"</span>))
     (t url))))

(<span class="ef-k">setq</span> org-url-unfurl-metadata--cache nil)
(<span class="ef-k">defun</span> <span class="ef-f">org-url-unfurl-metadata</span> (url)
  (cdr (<span class="ef-k">or</span> (assoc url org-url-unfurl-metadata--cache)
           (car (<span class="ef-k">push</span>
                 (cons
                  url
                  (<span class="ef-k">let*</span> ((head-data
                          (cl-remove-if-not
                           #'listp
                           (cdaddr
                            (<span class="ef-k">with-current-buffer</span>
                                (<span class="ef-k">progn</span> (message <span class="ef-s">"Fetching metadata from %s"</span> url)
                                       (<span class="ef-k">if</span> (executable-find <span class="ef-s">"curl"</span>)
                                           (<span class="ef-k">with-current-buffer</span> (generate-new-buffer <span class="ef-s">" *curl*"</span>)
                                             (call-process <span class="ef-s">"curl"</span> nil t nil <span class="ef-s">"--max-time"</span> <span class="ef-s">"5"</span> <span class="ef-s">"-sSL"</span> url)
                                             (current-buffer))
                                         (url-retrieve-synchronously url t t 5)))
                              (goto-char (point-min))
                              (delete-region (point-min) (- (search-forward <span class="ef-s">"&lt;head"</span>) 6))
                              (delete-region (search-forward <span class="ef-s">"&lt;/head&gt;"</span>) (point-max))
                              (goto-char (point-min))
                              (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"&lt;script[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">\u2800]+?&lt;/script&gt;"</span> nil t)
                                (replace-match <span class="ef-s">""</span>))
                              (goto-char (point-min))
                              (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"&lt;style[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">\u2800]+?&lt;/style&gt;"</span> nil t)
                                (replace-match <span class="ef-s">""</span>))
                              (libxml-parse-html-region (point-min) (point-max))))))
                         (meta (delq nil
                                     (mapcar
                                      (<span class="ef-k">lambda</span> (tag)
                                        (<span class="ef-k">when</span> (eq 'meta (car tag))
                                          (cons (<span class="ef-k">or</span> (cdr (assoc 'name (cadr tag)))
                                                    (cdr (assoc 'property (cadr tag))))
                                                (cdr (assoc 'content (cadr tag))))))
                                      head-data))))
                    (<span class="ef-k">let</span> ((title (<span class="ef-k">or</span> (cdr (assoc <span class="ef-s">"og:title"</span> meta))
                                     (cdr (assoc <span class="ef-s">"twitter:title"</span> meta))
                                     (nth 2 (assq 'title head-data))))
                          (description (<span class="ef-k">or</span> (cdr (assoc <span class="ef-s">"og:description"</span> meta))
                                           (cdr (assoc <span class="ef-s">"twitter:description"</span> meta))
                                           (cdr (assoc <span class="ef-s">"description"</span> meta))))
                          (image (<span class="ef-k">or</span> (cdr (assoc <span class="ef-s">"og:image"</span> meta))
                                     (cdr (assoc <span class="ef-s">"twitter:image"</span> meta)))))
                      (<span class="ef-k">when</span> image
                        (<span class="ef-k">setq</span> image (replace-regexp-in-string
                                     <span class="ef-s">"^/"</span> (concat <span class="ef-s">"https://"</span> (replace-regexp-in-string <span class="ef-s">"//</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">/]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">/?.*"</span> <span class="ef-s">"\\1"</span> url) <span class="ef-s">"/"</span>)
                                     (replace-regexp-in-string
                                      <span class="ef-s">"^//"</span> <span class="ef-s">"https://"</span>
                                      image))))
                      (list <span class="ef-b">:title</span> title <span class="ef-b">:description</span> description <span class="ef-b">:image</span> image))))
                 org-url-unfurl-metadata--cache)))))

<span class="ef-cd">;; </span><span class="ef-c">(setq-default org-html-with-latex `dvisvgm)
</span>
(setcdr (assoc 'path org-html-mathjax-options)
        (list <span class="ef-s">"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"</span>))

(<span class="ef-k">setq</span> org-html-mathjax-template
  <span class="ef-s">"&lt;script&gt;
  window.MathJax = {
    loader: {
      load: ['[tex]/mathtools'],
    },
    tex: {
      ams: {
        multlineWidth: '</span><span style="color: #b751b6;">%MULTLINEWIDTH</span><span class="ef-s">'
      },
      tags: '</span><span style="color: #b751b6;">%TAGS</span><span class="ef-s">',
      tagSide: '</span><span style="color: #b751b6;">%TAGSIDE</span><span class="ef-s">',
      tagIndent: '</span><span style="color: #b751b6;">%TAGINDENT</span><span class="ef-s">',
      packages: {'[+]': ['</span><span style="color: #b751b6;">mathtools</span><span class="ef-s">']},
      macros: {
        RR: ['\\\\ifstrempty{#1}{\\\\mathbb{R}}{\\\\mathbb{R}^{#1}}', 1, ''],
        NN: ['\\\\ifstrempty{#1}{\\\\mathbb{N}}{\\\\mathbb{N}^{#1}}', 1, ''],
        ZZ: ['\\\\ifstrempty{#1}{\\\\mathbb{Z}}{\\\\mathbb{Z}^{#1}}', 1, ''],
        QQ: ['\\\\ifstrempty{#1}{\\\\mathbb{Q}}{\\\\mathbb{Q}^{#1}}', 1, ''],
        CC: ['\\\\ifstrempty{#1}{\\\\mathbb{C}}{\\\\mathbb{C}^{#1}}', 1, ''],
        EE: '</span><span style="color: #b751b6;">\\\\mathbb{E}</span><span class="ef-s">',
        Lap: '</span><span style="color: #b751b6;">\\\\operatorname{\\\\mathcal{L}}</span><span class="ef-s">',
        Var: '</span><span style="color: #b751b6;">\\\\operatorname{Var}</span><span class="ef-s">',
        Cor: '</span><span style="color: #b751b6;">\\\\operatorname{Cor}</span><span class="ef-s">',
        E: '</span><span style="color: #b751b6;">\\\\operatorname{E}</span><span class="ef-s">',
      },
      mathtools: {
        pairedDelimiters: {
          abs: ['</span><span style="color: #b751b6;">\\\\lvert</span><span class="ef-s">', '</span><span style="color: #b751b6;">\\\\rvert</span><span class="ef-s">'],
          norm: ['</span><span style="color: #b751b6;">\\\\lVert</span><span class="ef-s">', '</span><span style="color: #b751b6;">\\\\rVert</span><span class="ef-s">'],
          ceil: ['</span><span style="color: #b751b6;">\\\\lceil</span><span class="ef-s">', '</span><span style="color: #b751b6;">\\\\rceil</span><span class="ef-s">'],
          floor: ['</span><span style="color: #b751b6;">\\\\lfloor</span><span class="ef-s">', '</span><span style="color: #b751b6;">\\\\rfloor</span><span class="ef-s">'],
          round: ['</span><span style="color: #b751b6;">\\\\lfloor</span><span class="ef-s">', '</span><span style="color: #b751b6;">\\\\rceil</span><span class="ef-s">'],
        }
      }
    },
    chtml: {
      scale: %SCALE,
      displayAlign: '</span><span style="color: #b751b6;">%ALIGN</span><span class="ef-s">',
      displayIndent: '</span><span style="color: #b751b6;">%INDENT</span><span class="ef-s">'
    },
    svg: {
      scale: %SCALE,
      displayAlign: '</span><span style="color: #b751b6;">%ALIGN</span><span class="ef-s">',
      displayIndent: '</span><span style="color: #b751b6;">%INDENT</span><span class="ef-s">'
    },
    output: {
      font: '</span><span style="color: #b751b6;">%FONT</span><span class="ef-s">',
      displayOverflow: '</span><span style="color: #b751b6;">%OVERFLOW</span><span class="ef-s">'
    }
  };
&lt;/script&gt;

&lt;script
  id=\"MathJax-script\"
  async
  src=\"%PATH\"&gt;
&lt;/script&gt;"</span>)

(<span class="ef-k">provide</span> '<span class="ef-o">config-ox-html</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">ox-latex
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">+org-warn-about-missing-latex-packages</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">check-for-latex-packages</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-convert-extra-special-strings</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-extra-special-string-regexps</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-latex-correct-latin-abbreviation-spaces</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-latex-abbreviations</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-latex-non-ascii-char-substitutions</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-latex-replace-non-ascii-chars</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-pdflatex-inputenc-encoded-chars</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-julia-mono-fontspec</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-condensed-lists</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-condense-lists</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-cover-page-p</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-cover-page-maketitle</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-subtitle-coverpage-format</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-cover-page-wordcount-threshold</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-cover-page</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-fontsets</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-fontset</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-fontset-entry</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-default-fontset</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-par-sep</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-italic-quotes</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-use-microtype</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-embed-files</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-embed-extra-files</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-box-preamble</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-checkbox-preamble</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-caption-preamble</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-embed-files-preamble</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-maths-preamble</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">+org-export-latex-fancy-item-checkboxes</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: ox-latex"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'ox-latex
(confpkg-with-record '(<span class="ef-s">"load: ox-latex"</span> load-hooks)
<span class="ef-cd">;; </span><span class="ef-c">org-latex-compilers = ("pdflatex" "xelatex" "lualatex"), which are the possible values for %latex
</span>(<span class="ef-k">setq</span> org-latex-pdf-process '(<span class="ef-s">"LC_ALL=en_US.UTF-8 latexmk -f -pdf -%latex -shell-escape -interaction=nonstopmode -output-directory=%o %f"</span>))

(<span class="ef-k">defun</span> <span class="ef-f">+org-export-latex-fancy-item-checkboxes</span> (text backend info)
  (<span class="ef-k">when</span> (org-export-derived-backend-p backend 'latex)
    (replace-regexp-in-string
     <span class="ef-s">"\\\\item\\[{$\\\\</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">\\w+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">$}\\]"</span>
     (<span class="ef-k">lambda</span> (fullmatch)
       (concat <span class="ef-s">"\\\\item["</span> (<span class="ef-k">pcase</span> (substring fullmatch 9 -3) <span class="ef-cd">; </span><span class="ef-c">content of capture group
</span>                             (<span class="ef-s">"square"</span>   <span class="ef-s">"\\\\checkboxUnchecked"</span>)
                             (<span class="ef-s">"boxminus"</span> <span class="ef-s">"\\\\checkboxTransitive"</span>)
                             (<span class="ef-s">"boxtimes"</span> <span class="ef-s">"\\\\checkboxChecked"</span>)
                             (_ (substring fullmatch 9 -3))) <span style="color: #986801;">"]"</span><span class="ef-wr">))</span>
     text)))

(add-to-list 'org-export-filter-item-functions
             '+org-export-latex-fancy-item-checkboxes)

(<span class="ef-k">after!</span> ox-latex
  (<span class="ef-k">let*</span> ((article-sections '((<span class="ef-s">"\\section{%s}"</span> . <span class="ef-s">"\\section*{%s}"</span>)
                             (<span class="ef-s">"\\subsection{%s}"</span> . <span class="ef-s">"\\subsection*{%s}"</span>)
                             (<span class="ef-s">"\\subsubsection{%s}"</span> . <span class="ef-s">"\\subsubsection*{%s}"</span>)
                             (<span class="ef-s">"\\paragraph{%s}"</span> . <span class="ef-s">"\\paragraph*{%s}"</span>)
                             (<span class="ef-s">"\\subparagraph{%s}"</span> . <span class="ef-s">"\\subparagraph*{%s}"</span>)))
         (book-sections (append '((<span class="ef-s">"\\chapter{%s}"</span> . <span class="ef-s">"\\chapter*{%s}"</span>))
                                article-sections))
         (hanging-secnum-preamble <span class="ef-s">"\\renewcommand\\sectionformat{\\llap{\\thesection\\autodot\\enskip}}
\\renewcommand\\subsectionformat{\\llap{\\thesubsection\\autodot\\enskip}}
\\renewcommand\\subsubsectionformat{\\llap{\\thesubsubsection\\autodot\\enskip}}"</span>)
         (big-chap-preamble <span class="ef-s">"\\RedeclareSectionCommand[afterindent=false, beforeskip=0pt, afterskip=0pt, innerskip=0pt]{chapter}
\\setkomafont{chapter}{\\normalfont\\Huge}
\\renewcommand*{\\chapterheadstartvskip}{\\vspace*{0\\baselineskip}}
\\renewcommand*{\\chapterheadendvskip}{\\vspace*{0\\baselineskip}}
\\renewcommand*{\\chapterformat}{%
  \\fontsize{60}{30}\\selectfont\\rlap{\\hspace{6pt}\\thechapter}}
\\renewcommand*\\chapterlinesformat[3]{%
  \\parbox[b]{\\dimexpr\\textwidth-0.5em\\relax}{%
    \\raggedleft{{\\large\\scshape\\bfseries\\chapapp}\\vspace{-0.5ex}\\par\\Huge#3}}%
    \\hfill\\makebox[0pt][l]{#2}}"</span>))
    (setcdr (assoc <span class="ef-s">"article"</span> org-latex-classes)
            `(,(concat <span class="ef-s">"\\documentclass{scrartcl}"</span> hanging-secnum-preamble)
              ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="ef-s">"report"</span> ,(concat <span class="ef-s">"\\documentclass{scrartcl}"</span> hanging-secnum-preamble)
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="ef-s">"book"</span> ,(concat <span class="ef-s">"\\documentclass[twoside=false]{scrbook}"</span>
                                   big-chap-preamble hanging-secnum-preamble)
                   ,@book-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="ef-s">"blank"</span> <span class="ef-s">"[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span>
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="ef-s">"bmc-article"</span> <span class="ef-s">"\\documentclass[article,code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span>
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="ef-s">"bmc"</span> <span class="ef-s">"\\documentclass[code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span>
                   ,@book-sections))))

(<span class="ef-k">setq</span> org-latex-tables-booktabs t
      org-latex-hyperref-template
      <span class="ef-s">"\\providecolor{url}{HTML}{0077bb}
\\providecolor{link}{HTML}{882255}
\\providecolor{cite}{HTML}{999933}
\\hypersetup{
  pdfauthor={%a},
  pdftitle={%t},
  pdfkeywords={%k},
  pdfsubject={%d},
  pdfcreator={%c},
  pdflang={%L},
  breaklinks=true,
  colorlinks=true,
  linkcolor=link,
  urlcolor=url,
  citecolor=cite
}
\\urlstyle{same}"</span>
      org-latex-reference-command <span class="ef-s">"\\cref{%s}"</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-maths-preamble</span>
  <span class="ef-s">"%% Maths-related packages
% More maths environments, commands, and symbols.
\\usepackage{amsmath, amssymb}
% Slanted fractions with \\sfrac{a}{b}, in text and maths.
\\usepackage{xfrac}
% Visually cancel expressions with \\cancel{value} and \\cancelto{expression}{value}
\\usepackage[makeroom]{cancel}
% Improvements on amsmath and utilities for mathematical typesetting
\\usepackage{mathtools}

% Deliminators
\\DeclarePairedDelimiter{\\abs}{\\lvert}{\\rvert}
\\DeclarePairedDelimiter{\\norm}{\\lVert}{\\rVert}

\\DeclarePairedDelimiter{\\ceil}{\\lceil}{\\rceil}
\\DeclarePairedDelimiter{\\floor}{\\lfloor}{\\rfloor}
\\DeclarePairedDelimiter{\\round}{\\lfloor}{\\rceil}

\\newcommand{\\RR}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{R}}{\\mathbb{R}^{#1}}}} % Real numbers
\\newcommand{\\NN}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{N}}{\\mathbb{N}^{#1}}}} % Natural numbers
\\newcommand{\\ZZ}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{Z}}{\\mathbb{Z}^{#1}}}} % Integer numbers
\\newcommand{\\QQ}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{Q}}{\\mathbb{Q}^{#1}}}} % Rational numbers
\\newcommand{\\CC}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{C}}{\\mathbb{C}^{#1}}}} % Complex numbers

% Easy derivatives
\\ProvideDocumentCommand\\dv{o m g}{%
  \\IfNoValueTF{#3}{%
    \\dv[#1]{}{#2}}{%
    \\IfNoValueTF{#1}{%
      \\frac{\\dd #2}{\\dd #3}%
    }{\\frac{\\dd[#1] #2}{\\dd {#3}^{#1}}}}}
% Easy partial derivatives
\\ExplSyntaxOn
\\ProvideDocumentCommand\\pdv{o m g}{%
  \\IfNoValueTF{#3}{\\pdv[#1]{}{#2}}%
  {\\ifnum\\clist_count:n{#3}&lt;2
    \\IfValueTF{#1}{\\frac{\\partial^{#1} #2}{\\partial {#3}^{#1}}}%
    {\\frac{\\partial #2}{\\partial #3}}
    \\else
    \\frac{\\IfValueTF{#1}{\\partial^{#1}}{\\partial^{\\clist_count:n{#3}}}#2}%
    {\\clist_map_inline:nn{#3}{\\partial ##1 \\,}\\!}
    \\fi}}
\\ExplSyntaxOff

% Laplacian
\\DeclareMathOperator{\\Lap}{\\mathcal{L}}

% Statistics
\\DeclareMathOperator{\\Var}{Var} % varience
\\DeclareMathOperator{\\Cov}{Cov} % covarience
\\newcommand{\\EE}{\\ensuremath{\\mathbb{E}}} % expected value
\\DeclareMathOperator{\\E}{E} % expected value

% I prefer the slanted \\leq/\\geq
\\let\\barleq\\leq % Save them in case they're every wanted
\\let\\bargeq\\geq
\\renewcommand{\\leq}{\\leqslant}
\\renewcommand{\\geq}{\\geqslant}

% Redefine the matrix environment to allow for alignment
% via an optional argument, and use r as the default.
\\makeatletter
\\renewcommand*\\env@matrix[1][r]{\\hskip -\\arraycolsep%
    \\let\\@ifnextchar\\new@ifnextchar
    \\array{*\\c@MaxMatrixCols #1}}
\\makeatother

% Slanted roman \"d\" for derivatives
\\ifcsname pdfoutput\\endcsname
  \\ifnum\\pdfoutput&gt;0 % PDF
    \\newsavebox\\diffdbox{}
    \\newcommand{\\slantedromand}{{\\mathpalette\\makesl{d}}}
    \\newcommand{\\makesl}[2]{%
      \\begingroup
      \\sbox{\\diffdbox}{$\\mathsurround=0pt#1\\mathrm{#2}$}%
      \\pdfsave%
      \\pdfsetmatrix{1 0 0.2 1}%
      \\rlap{\\usebox{\\diffdbox}}%
      \\pdfrestore%
      \\hskip\\wd\\diffdbox%
      \\endgroup}
  \\else % DVI
    \\newcommand{\\slantedromand}{d} % fallback
  \\fi
\\else % Also DVI
  \\newcommand{\\slantedromand}{d} % fallback
\\fi

% Derivative d^n, nicely spaced
\\makeatletter
\\newcommand{\\dd}[1][]{\\mathop{}\\!%
  \\expandafter\\ifx\\expandafter&amp;\\detokenize{#1}&amp;% \\ifstrempty from etoolbox
    \\slantedromand\\@ifnextchar^{\\hspace{0.2ex}}{\\hspace{0.1ex}}
  \\else
    \\slantedromand\\hspace{0.2ex}^{#1}
  \\fi}
\\makeatother

\\NewCommandCopy{\\daccent}{\\d}
\\renewcommand{\\d}{\\ifmmode\\dd\\else\\daccent\\fi}"</span>
  <span class="ef-d">"Preamble that sets up a bunch of mathematical conveniences."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-embed-files-preamble</span>
  nil
  <span class="ef-d">"Preamble that embeds files within the pdf."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-caption-preamble</span>
  <span class="ef-s">"\\usepackage{subcaption}
\\usepackage[hypcap=true]{caption}
\\setkomafont{caption}{\\sffamily\\small}
\\setkomafont{captionlabel}{\\upshape\\bfseries}
\\captionsetup{justification=raggedright,singlelinecheck=true}
\\usepackage{capt-of} % required by Org"</span>
  <span class="ef-d">"Preamble that improves captions."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-checkbox-preamble</span>
  <span class="ef-s">"\\newcommand{\\checkboxUnchecked}{$\\square$}
\\newcommand{\\checkboxTransitive}{\\rlap{\\raisebox{-0.1ex}{\\hspace{0.35ex}\\Large\\textbf -}}$\\square$}
\\newcommand{\\checkboxChecked}{\\rlap{\\raisebox{0.2ex}{\\hspace{0.35ex}\\scriptsize \\ding{52}}}$\\square$}"</span>
  <span class="ef-d">"Preamble that improves checkboxes."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-box-preamble</span>
  <span class="ef-s">"\\ExplSyntaxOn
\\NewCoffin\\SBXBaseline
\\NewCoffin\\SBXHeader
\\NewCoffin\\SBXContent
\\NewCoffin\\SBXSideRule
\\newbox\\SBXSplitBox
\\cs_new_protected:Nn \\simplebox_start:nnn {
  % #1 ding, #3 name, #4 label
  \\vcoffin_set:Nnn \\SBXHeader { \\linewidth - 1em } {
  \\noindent\\textcolor{#2}{#1}~\\textcolor{#2}{\\textbf{#3}}}
  \\vcoffin_set:Nnw \\SBXContent { \\linewidth - 1.5em }
}
\\cs_new_protected:Nn \\simplebox_split_content:n {
  % #1 name
  \\setbox\\SBXSplitBox = \\vbox:n { \\vbox_unpack_drop:N \\SBXContent }
  \\dim_set:Nn \\l_tmpa_dim { \\dim_eval:n { \\dim_min:nn { \\pagegoal } { \\textheight } - \\pagetotal - 2\\baselineskip } }
  \\setbox0 = \\vsplit\\SBXSplitBox to \\l_tmpa_dim
  \\vcoffin_set:Nnn \\SBXContent { \\CoffinWidth \\SBXContent } { \\box0 %
    \\vspace{-1.7\\baselineskip}
    \\noindent\\textcolor{#1}{\\textbf{\\ldots }}
    \\vspace*{-0.3\\baselineskip}}
}
\\cs_new_protected:Nn \\simplebox_split_refill:nnnn {
  % #1 ding, #2 ding offset, #3 name, #4 label
  \\simplebox_start:nnn {#1} {#3} {#4,\\space{}\\emph{continued}}
  \\vspace*{-0.2\\baselineskip}
  \\vbox_unpack_drop:N \\SBXSplitBox
  \\vcoffin_set_end:
}
\\cs_new_protected:Nn \\simplebox_typeset:nn {
    % #1 name, #2 ding offset
    \\vcoffin_set:Nnn \\SBXBaseline {0pt} {\\vbox{}}
    \\SetHorizontalCoffin\\SBXSideRule{\\color{#1}\\rule{1pt}{\\dim_eval:n { \\CoffinTotalHeight\\SBXContent + \\baselineskip }}}
    \\JoinCoffins*\\SBXContent[l,t]\\SBXSideRule[l,t](\\dim_eval:n {#2 - 1em}, \\dim_eval:n{\\baselineskip - 0.5em})
    \\JoinCoffins*\\SBXContent[l,t]\\SBXHeader[l,B](-1em, 0.5\\baselineskip)
    \\JoinCoffins*\\SBXBaseline[l,T]\\SBXContent[l,T]
    \\vspace{-0.5\\baselineskip}
    \\noindent\\TypesetCoffin\\SBXBaseline(\\dim_eval:n { 1em - #2 + 1pt }, 0pt)
    \\vspace*{\\CoffinTotalHeight\\SBXContent}
    \\vspace{-0.08em} % Why on earth is this needed for baseline alignment!?
}
\\cs_new_protected:Nn \\simplebox_typeset_breakable:nnnn {
    % #1 ding, #2 ding offset, #3 name, #4 label
    \\dim_set:Nn \\l_tmpa_dim {\\dim_eval:n { \\CoffinTotalHeight\\SBXContent + \\baselineskip }}
    \\dim_set:Nn \\l_tmpb_dim { \\dim_eval:n { \\dim_min:nn { \\pagegoal } { \\textheight } - \\pagetotal - \\baselineskip } }
    \\dim_compare:nNnTF {\\l_tmpa_dim} &gt; {\\l_tmpb_dim} {
      \\simplebox_split_content:n {#3}
      \\simplebox_typeset:nn {#3} {#2}
      \\newpage
      \\simplebox_split_refill:nnnn {#1} {#2} {#3} {#4}
      \\simplebox_typeset_breakable:nnnn {#1} {#2} {#3} {#4}
    }{
      \\simplebox_typeset:nn {#3} {#2}
    }
}
\\NewDocumentCommand{\\defsimplebox}{O{\\ding{117}} O{0.35em} O{#1} O{#2} m m m}{
  % #1 ding, #2 ding offset, #3 alt-ding, #4 alt-ding offset,
  % #5 name, #6 colour, #7 default label
  \\definecolor{#5}{HTML}{#6}
  \\NewDocumentEnvironment{#5}{ O{#7} }{
    \\simplebox_start:nnn {#1} {#5} {##1}
  }{
    \\vcoffin_set_end:
    \\simplebox_typeset_breakable:nnnn {#3} {#4} {#5} {##1}
  }
}
\\ExplSyntaxOff"</span>
  <span class="ef-d">"Preamble that provides a macro for custom boxes."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-embed-extra-files</span> ()
  <span class="ef-d">"Return a string that uses embedfile to embed all tangled files."</span>
  (mapconcat
   (<span class="ef-k">lambda</span> (file-desc)
     (format <span class="ef-s">"\\IfFileExists{%1$s}{\\embedfile[desc=%2$s]{%1$s}}{}"</span>
             (<span class="ef-k">thread-last</span> (car file-desc)
                          (replace-regexp-in-string <span class="ef-s">"\\\\"</span> <span class="ef-s">"\\\\\\\\"</span>)
                          (replace-regexp-in-string <span class="ef-s">"~"</span> <span class="ef-s">"\\\\string~"</span>))
             (cdr file-desc)))
   (append
    (<span class="ef-k">let</span> (tangle-fspecs) <span class="ef-cd">; </span><span class="ef-c">All files being tangled to.
</span>      (org-element-cache-map
       (<span class="ef-k">lambda</span> (src)
         (<span class="ef-k">when</span> (<span class="ef-k">and</span> (not (org-in-commented-heading-p nil src))
                    (not (org-in-archived-heading-p nil src)))
           (<span class="ef-k">when-let</span> ((lang (org-element-property <span class="ef-b">:language</span> src))
                      (params
                       (apply
                        #'org-babel-merge-params
                        (append
                         (<span class="ef-k">org-with-point-at</span> (org-element-property <span class="ef-b">:begin</span> src)
                           (org-babel-params-from-properties lang t))
                         (mapcar
                          (<span class="ef-k">lambda</span> (h)
                            (org-babel-parse-header-arguments h t))
                          (cons (org-element-property <span class="ef-b">:parameters</span> src)
                                (org-element-property <span class="ef-b">:header</span> src))))))
                      (tangle-value
                       (<span class="ef-k">pcase</span> (alist-get <span class="ef-b">:tangle</span> params)
                         ((<span class="ef-k">and</span> (pred stringp) (pred (string-match-p <span class="ef-s">"^(.*)$"</span>)) expr)
                          (eval (read expr)))
                         (val val)))
                      (tangle-file
                       (<span class="ef-k">pcase</span> tangle-value
                         ((<span class="ef-k">or</span> <span class="ef-s">"no"</span> (guard (member (alist-get <span class="ef-b">:export-embed</span> params) '(<span class="ef-s">"no"</span> <span class="ef-s">"nil"</span>))))
                          nil)
                         (<span class="ef-s">"yes"</span>
                          (file-name-with-extension
                           (file-name-nondirectory (buffer-file-name))
                           (<span class="ef-k">or</span> (alist-get lang org-babel-tangle-lang-exts nil nil #'equal)
                               lang)))
                         (val val))))
             (<span class="ef-k">unless</span> (assoc tangle-file tangle-fspecs)
               (<span class="ef-k">push</span>
                (cons tangle-file (format <span class="ef-s">"Tangled %s file"</span> lang))
                tangle-fspecs)))))
       <span class="ef-b">:granularity</span> 'element
       <span class="ef-b">:restrict-elements</span> '(src-block))
      (nreverse tangle-fspecs))
    (<span class="ef-k">let</span> (extra-files)
      (<span class="ef-k">save-excursion</span>
        (goto-char (point-min))
        (<span class="ef-k">while</span> (re-search-forward <span class="ef-s">"^[ \t]*#\\+embed:"</span> nil t)
          (<span class="ef-k">let*</span> ((file-desc (split-string (org-element-property <span class="ef-b">:value</span> (org-element-at-point)) <span class="ef-s">" :desc</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">ription</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">? "</span>)))
            (<span class="ef-k">push</span> (cons (car file-desc) (<span class="ef-k">or</span> (cdr file-desc) <span class="ef-s">"Extra file"</span>)) extra-files))))
      (nreverse extra-files)))
   <span class="ef-s">"\n"</span>))

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-embed-files</span> t
  <span class="ef-d">"Embed the source .org, .tex, and any tangled files."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-use-microtype</span> t
  <span class="ef-d">"Use the microtype pakage."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-italic-quotes</span> t
  <span class="ef-d">"Make \"quote\" environments italic."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-par-sep</span> t
  <span class="ef-d">"Vertically seperate paragraphs, and remove indentation."</span>)

(<span class="ef-k">org-export-update-features</span> 'latex
  ((image caption)
   <span class="ef-b">:condition</span> <span class="ef-s">"\\[\\[xkcd:"</span>))

(<span class="ef-k">org-export-update-features</span> 'latex
  (maths
   <span class="ef-b">:snippet</span> org-latex-maths-preamble
   <span class="ef-b">:order</span> 0.2)
  (cleveref
   <span class="ef-b">:condition</span> <span class="ef-s">"cref:</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\cref{</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\[\\[[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">\\]+\n?[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">\\]\\]\\]"</span>
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage[capitalize]{cleveref}
% Fix for cleveref in order to work with long range of pages
% See https://tex.stackexchange.com/a/620066
\\makeatletter
\\newcommand*{\\@setcpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{cref}{#3}}
\\newcommand*{\\@setCpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{Cref}{#3}}
\\newcommand*{\\@setlabelcpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{labelcref}{#3}}
\\makeatother"</span>
   <span class="ef-b">:order</span> 1)
  (caption
   <span class="ef-b">:snippet</span> org-latex-caption-preamble
   <span class="ef-b">:order</span> 2.1)
  (microtype
   <span class="ef-b">:condition</span> org-latex-use-microtype
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000]{microtype}"</span>
   <span class="ef-b">:order</span> 0.1)
  (embed-files
   <span class="ef-b">:condition</span> org-latex-embed-files
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage[include]{embedall}"</span>
   <span class="ef-b">:order</span> 70)
  (embed-source
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> embed-files
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\IfFileExists{./\\jobname.org}{\\embedfile[desc=Primary source file]{\\jobname.org}}{}
\\IfFileExists{./\\jobname.tex}{\\embedfile[desc=The (generated) LaTeX source file]{\\jobname.tex}}{}"</span>
   <span class="ef-b">:no-precompile</span> t
   <span class="ef-b">:after</span> embed-files
   <span class="ef-b">:order</span> 80)
  (embed-tangled
   <span class="ef-b">:condition</span> (<span class="ef-k">and</span> org-latex-embed-files
                   <span class="ef-s">"^[ \t]*#\\+embed</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">^[ \t]*#\\+begin_src</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">^[ \t]*#\\+BEGIN_SRC"</span>)
   <span class="ef-b">:requires</span> embed-files
   <span class="ef-b">:snippet</span> (org-latex-embed-extra-files)
   <span class="ef-b">:no-precompile</span> t
   <span class="ef-b">:after</span> (embed-source embed-files)
   <span class="ef-b">:order</span> 80)
  (acronym
   <span class="ef-b">:condition</span> <span class="ef-s">"[;\\\\]?\\b[A-Z][A-Z]+s?[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">A-Za-z]"</span>
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\newcommand{\\acr}[1]{\\protect\\textls*[110]{\\scshape #1}}\n\\newcommand{\\acrs}{\\protect\\scalebox{.91}[.84]{\\hspace{0.15ex}s}}"</span>
   <span class="ef-b">:order</span> 0.4)
  (box-drawing
   <span class="ef-b">:condition</span> <span class="ef-s">"[\u2500-\u259F]"</span>
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage{pmboxdraw}"</span>
   <span class="ef-b">:order</span> 0.05)
  (italic-quotes
   <span class="ef-b">:condition</span> (<span class="ef-k">and</span> org-latex-italic-quotes <span class="ef-s">"^[ \t]*#\\+begin_quote</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\\\begin{quote}"</span>)
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\renewcommand{\\quote}{\\list{}{\\rightmargin\\leftmargin}\\item\\relax\\em}\n"</span>
   <span class="ef-b">:order</span> 0.5)
  (par-sep
   <span class="ef-b">:condition</span> org-latex-par-sep
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\setlength{\\parskip}{\\baselineskip}\n\\setlength{\\parindent}{0pt}"</span>
   <span class="ef-b">:order</span> 0.5)
  (.pifont
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage{pifont}"</span>)
  (.xcoffins
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage{xcoffins}"</span>)
  (checkbox
   <span class="ef-b">:condition</span> <span class="ef-s">"^[ \t]*</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">[-+*]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">[0-9]+[.)]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">[A-Za-z]+[.)]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s"> \\[[ -X]\\]"</span>
   <span class="ef-b">:requires</span> .pifont
   <span class="ef-b">:snippet</span> (concat (<span class="ef-k">unless</span> (memq 'maths features)
                      <span class="ef-s">"\\usepackage{amssymb} % provides \\square"</span>)
                    org-latex-checkbox-preamble)
   <span class="ef-b">:after</span> .pifont)
  (.fancy-box
   <span class="ef-b">:requires</span> (.pifont .xcoffins)
   <span class="ef-b">:snippet</span> org-latex-box-preamble
   <span class="ef-b">:after</span> (.pifont .xcoffins))
  (box-warning
   <span class="ef-b">:condition</span> <span class="ef-s">"^[ \t]*#\\+begin_warning</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\\\begin{warning}"</span>
   <span class="ef-b">:requires</span> .fancy-box
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\defsimplebox{warning}{e66100}{Warning}"</span>
   <span class="ef-b">:after</span> .fancy-box)
  (box-info
   <span class="ef-b">:condition</span> <span class="ef-s">"^[ \t]*#\\+begin_info</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\\\begin{info}"</span>
   <span class="ef-b">:requires</span> .fancy-box
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\defsimplebox{info}{3584e4}{Information}"</span>
   <span class="ef-b">:after</span> .fancy-box)
  (box-notes
   <span class="ef-b">:condition</span> <span class="ef-s">"^[ \t]*#\\+begin_notes</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\\\begin{notes}"</span>
   <span class="ef-b">:requires</span> .fancy-box
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\defsimplebox{notes}{26a269}{Notes}"</span>
   <span class="ef-b">:after</span> .fancy-box)
  (box-success
   <span class="ef-b">:condition</span> <span class="ef-s">"^[ \t]*#\\+begin_success</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\\\begin{success}"</span>
   <span class="ef-b">:requires</span> .fancy-box
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\defsimplebox{success}{26a269}{\\vspace{-\\baselineskip}}"</span>
   <span class="ef-b">:after</span> .fancy-box)
  (box-error
   <span class="ef-b">:condition</span> <span class="ef-s">"^[ \t]*#\\+begin_error</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">\\\\begin{error}"</span>
   <span class="ef-b">:requires</span> .fancy-box
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\defsimplebox{error}{c01c28}{Important}"</span>
   <span class="ef-b">:after</span> .fancy-box)
  (hanging-section-numbers
   <span class="ef-b">:condition</span>
   (<span class="ef-k">let</span> ((latex-class
          (assoc (plist-get info <span class="ef-b">:latex-class</span>) (plist-get info <span class="ef-b">:latex-classes</span>))))
     (<span class="ef-k">and</span> (cadr latex-class)
          (string-match-p <span class="ef-s">"\\`\\\\documentclass</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(?:</span><span class="ef-s">\\[</span><span style="color: #b751b6;">.*\\</span><span class="ef-s">]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">?{scr"</span> (cadr latex-class))
          (not (string-match-p <span class="ef-s">"[[,]twocolumn[],]"</span> (<span class="ef-k">or</span> (plist-get info <span class="ef-b">:latex-class-options</span>) <span class="ef-s">""</span>)))))
   <span class="ef-b">:snippet</span>
   <span class="ef-s">"\\renewcommand\\sectionformat{\\llap{\\thesection\\autodot\\enskip}}
\\renewcommand\\subsectionformat{\\llap{\\thesubsection\\autodot\\enskip}}
\\renewcommand\\subsubsectionformat{\\llap{\\thesubsubsection\\autodot\\enskip}}"</span>)
  (toc-hidelinks
   <span class="ef-b">:condition</span>
   (<span class="ef-k">or</span> (plist-get info <span class="ef-b">:with-toc</span>)
       (<span class="ef-k">save-excursion</span>
         (goto-char (point-min))
         (re-search-forward <span class="ef-s">"\\tableofcontents"</span> nil t)))
   <span class="ef-b">:snippet</span> <span class="ef-s">"%% hide links styles in toc
\\NewCommandCopy{\\oldtoc}{\\tableofcontents}
\\renewcommand{\\tableofcontents}{\\begingroup\\hypersetup{hidelinks}\\oldtoc\\endgroup}"</span>))

(<span class="ef-k">setq</span> org-latex-packages-alist
      '((<span class="ef-s">""</span> <span class="ef-s">"xcolor"</span> t)))

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-default-fontset</span> 'alegreya
  <span class="ef-d">"Fontset from `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-fontsets</span><span class="ef-d">' to use by default.
As cm (computer modern) is TeX's default, that causes nothing
to be added to the document.

If \"nil\" no custom fonts will ever be used."</span>)

(eval '(cl-pushnew '(<span class="ef-b">:latex-font-set</span> nil <span class="ef-s">"fontset"</span> org-latex-default-fontset)
                   (org-export-backend-options (org-export-get-backend 'latex))))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-fontset-entry</span> ()
  <span class="ef-d">"Get the fontset spec of the current file.
Has format \"name\" or \"name-style\" where '</span><span style="color: #b751b6; text-decoration: italic;">name</span><span class="ef-d">' is one of
the cars in `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-fontsets</span><span class="ef-d">'."</span>
  (<span class="ef-k">let</span> ((fontset-spec
         (symbol-name
          (<span class="ef-k">or</span> (car (delq nil
                         (mapcar
                          (<span class="ef-k">lambda</span> (opt-line)
                            (plist-get (org-export--parse-option-keyword opt-line 'latex)
                                       <span class="ef-b">:latex-font-set</span>))
                          (cdar (org-collect-keywords '(<span class="ef-s">"OPTIONS"</span>))))))
              org-latex-default-fontset))))
    (cons (intern (car (split-string fontset-spec <span class="ef-s">"-"</span>)))
          (<span class="ef-k">when</span> (cadr (split-string fontset-spec <span class="ef-s">"-"</span>))
            (intern (concat <span class="ef-s">":"</span> (cadr (split-string fontset-spec <span class="ef-s">"-"</span>))))))))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-fontset</span> (<span class="ef-t">&amp;rest</span> desired-styles)
  <span class="ef-d">"Generate a LaTeX preamble snippet which applies the current fontset for DESIRED-STYLES."</span>
  (<span class="ef-k">let*</span> ((fontset-spec (org-latex-fontset-entry))
         (fontset (alist-get (car fontset-spec) org-latex-fontsets)))
    (<span class="ef-k">if</span> fontset
        (string-trim
         (concat
          (mapconcat
           (<span class="ef-k">lambda</span> (style)
             (<span class="ef-k">when</span> (plist-get fontset style)
               (concat (plist-get fontset style) <span class="ef-s">"\n"</span>)))
           desired-styles
           <span class="ef-s">""</span>)
          (<span class="ef-k">when</span> (memq (cdr fontset-spec) desired-styles)
            (<span class="ef-k">pcase</span> (cdr fontset-spec)
              (<span class="ef-b">:serif</span> <span class="ef-s">"\\renewcommand{\\familydefault}{\\rmdefault}\n"</span>)
              (<span class="ef-b">:sans</span> <span class="ef-s">"\\renewcommand{\\familydefault}{\\sfdefault}\n"</span>)
              (<span class="ef-b">:mono</span> <span class="ef-s">"\\renewcommand{\\familydefault}{\\ttdefault}\n"</span>)))))
      (<span class="ef-wr">error</span> <span class="ef-s">"Font-set %s is not provided in org-latex-fontsets"</span> (car fontset-spec)))))

(<span class="ef-k">org-export-update-features</span> 'latex
  (custom-font
   <span class="ef-b">:condition</span> org-latex-default-fontset
   <span class="ef-b">:snippet</span> (org-latex-fontset <span class="ef-b">:serif</span> <span class="ef-b">:sans</span> <span class="ef-b">:mono</span>)
   <span class="ef-b">:order</span> 0)
  (custom-maths-font
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> (custom-font maths)
   <span class="ef-b">:snippet</span> (org-latex-fontset <span class="ef-b">:maths</span>)
   <span class="ef-b">:after</span> (custom-font maths)
   <span class="ef-b">:order</span> 0))

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-fontsets</span>
  '((cm nil) <span class="ef-cd">; </span><span class="ef-c">computer modern
</span>    (## nil) <span class="ef-cd">; </span><span class="ef-c">no font set
</span>    (alegreya
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage[osf]{Alegreya}"</span>
     <span class="ef-b">:sans</span> <span class="ef-s">"\\usepackage{AlegreyaSans}"</span>
     <span class="ef-b">:mono</span> <span class="ef-s">"\\usepackage[scale=0.88]{sourcecodepro}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\let\\Bbbk\\relax\n\\usepackage[varbb]{newpxmath}"</span>)
    (biolinum
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage[osf]{libertineRoman}"</span>
     <span class="ef-b">:sans</span> <span class="ef-s">"\\usepackage[sfdefault,osf]{biolinum}"</span>
     <span class="ef-b">:mono</span> <span class="ef-s">"\\usepackage[scale=0.88]{sourcecodepro}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\usepackage[libertine,varvw]{newtxmath}"</span>)
    (fira
     <span class="ef-b">:sans</span> <span class="ef-s">"\\usepackage[sfdefault,scale=0.85]{FiraSans}"</span>
     <span class="ef-b">:mono</span> <span class="ef-s">"\\usepackage[scale=0.80]{FiraMono}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\usepackage{newtxsf} % change to firamath in future?"</span>)
    (kp
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage{kpfonts}"</span>)
    (newpx
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage{newpxtext}"</span>
     <span class="ef-b">:sans</span> <span class="ef-s">"\\usepackage{gillius}"</span>
     <span class="ef-b">:mono</span> <span class="ef-s">"\\usepackage[scale=0.9]{sourcecodepro}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\let\\Bbbk\\relax\n\\usepackage[varbb]{newpxmath}"</span>)
    (noto
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage[osf]{noto-serif}"</span>
     <span class="ef-b">:sans</span> <span class="ef-s">"\\usepackage[osf]{noto-sans}"</span>
     <span class="ef-b">:mono</span> <span class="ef-s">"\\usepackage[scale=0.96]{noto-mono}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\usepackage{notomath}"</span>)
    (plex
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage{plex-serif}"</span>
     <span class="ef-b">:sans</span> <span class="ef-s">"\\usepackage{plex-sans}"</span>
     <span class="ef-b">:mono</span> <span class="ef-s">"\\usepackage[scale=0.95]{plex-mono}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\usepackage{newtxmath}"</span>) <span class="ef-cd">; </span><span class="ef-c">may be plex-based in future
</span>    (source
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage[osf,semibold]{sourceserifpro}"</span>
     <span class="ef-b">:sans</span> <span class="ef-s">"\\usepackage[osf,semibold]{sourcesanspro}"</span>
     <span class="ef-b">:mono</span> <span class="ef-s">"\\usepackage[scale=0.92]{sourcecodepro}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\usepackage{newtxmath}"</span>) <span class="ef-cd">; </span><span class="ef-c">may be sourceserifpro-based in future
</span>    (times
     <span class="ef-b">:serif</span> <span class="ef-s">"\\usepackage{newtxtext}"</span>
     <span class="ef-b">:maths</span> <span class="ef-s">"\\usepackage{newtxmath}"</span>))
  <span class="ef-d">"Alist of fontset specifications.
Each car is the name of the fontset (which cannot include \"-\").

Each cdr is a plist with (optional) keys :serif, :sans, :mono, and :maths.
A key's value is a LaTeX snippet which loads such a font."</span>)

(<span class="ef-k">org-export-update-features</span> 'latex
  (alegreya-typeface
   <span class="ef-b">:condition</span> (string= (car (org-latex-fontset-entry)) <span class="ef-s">"alegreya"</span>)
   <span class="ef-b">:snippet</span> nil)
  (alegreya-tabular-figures
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> (alegreya-typeface table)
   <span class="ef-b">:snippet</span> <span class="ef-s">"\
\\makeatletter
% tabular lining figures in tables
\\renewcommand{\\tabular}{\\AlegreyaTLF\\let\\@halignto\\@empty\\@tabular}
\\makeatother"</span>
   <span class="ef-b">:after</span> custom-font
   <span class="ef-b">:order</span> 0.5))

(<span class="ef-k">org-export-update-features</span> 'latex
  (alegreya-latex-symbol
    <span class="ef-b">:condition</span> <span class="ef-s">"LaTeX"</span>
    <span class="ef-b">:when</span> alegreya-typeface
    <span class="ef-b">:snippet</span> <span class="ef-s">"\
\\makeatletter
% Kerning around the A needs adjusting
\\DeclareRobustCommand{\\LaTeX}{L\\kern-.24em%
        {\\sbox\\z@ T%
         \\vbox to\\ht\\z@{\\hbox{\\check@mathfonts
                              \\fontsize\\sf@size\\z@
                              \\math@fontsfalse\\selectfont
                              A}%
                        \\vss}%
        }%
        \\kern-.10em%
        \\TeX}
\\makeatother"</span>
    <span class="ef-b">:after</span> alegreya-typeface
    <span class="ef-b">:order</span> 0.5))

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-cover-page</span> 'auto
  <span class="ef-d">"When t, use a cover page by default.
When auto, use a cover page when the document's wordcount exceeds
`</span><span style="color: #b751b6; text-decoration: italic;">org-latex-cover-page-wordcount-threshold</span><span class="ef-d">'.

Set with #+option: coverpage:{yes,auto,no} in org buffers."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-cover-page-wordcount-threshold</span> 5000
  <span class="ef-d">"Document word count at which a cover page will be used automatically.
This condition is applied when cover page option is set to auto."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-subtitle-coverpage-format</span> <span class="ef-s">"\\\\\\bigskip\n\\LARGE\\mdseries\\itshape\\color{black!80} %s\\par"</span>
  <span class="ef-d">"Variant of `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-subtitle-format</span><span class="ef-d">' to use with the cover page."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-cover-page-maketitle</span>
  <span class="ef-s">"\\usepackage{tikz}
\\usetikzlibrary{shapes.geometric}
\\usetikzlibrary{calc}

\\newsavebox\\orgicon
\\begin{lrbox}{\\orgicon}
  \\begin{tikzpicture}[y=0.80pt, x=0.80pt, inner sep=0pt, outer sep=0pt]
    \\path[fill=black!6] (16.15,24.00) .. controls (15.58,24.00) and (13.99,20.69) .. (12.77,18.06)arc(215.55:180.20:2.19) .. controls (12.33,19.91) and (11.27,19.09) .. (11.43,18.05) .. controls (11.36,18.09) and (10.17,17.83) .. (10.17,17.82) .. controls (9.94,18.75) and (9.37,19.44) .. (9.02,18.39) .. controls (8.32,16.72) and (8.14,15.40) .. (9.13,13.80) .. controls (8.22,9.74) and (2.18,7.75) .. (2.81,4.47) .. controls (2.99,4.47) and (4.45,0.99) .. (9.15,2.41) .. controls (14.71,3.99) and (17.77,0.30) .. (18.13,0.04) .. controls (18.65,-0.49) and (16.78,4.61) .. (12.83,6.90) .. controls (10.49,8.18) and (11.96,10.38) .. (12.12,11.15) .. controls (12.12,11.15) and (14.00,9.84) .. (15.36,11.85) .. controls (16.58,11.53) and (17.40,12.07) .. (18.46,11.69) .. controls (19.10,11.41) and (21.79,11.58) .. (20.79,13.08) .. controls (20.79,13.08) and (21.71,13.90) .. (21.80,13.99) .. controls (21.97,14.75) and (21.59,14.91) .. (21.47,15.12) .. controls (21.44,15.60) and (21.04,15.79) .. (20.55,15.44) .. controls (19.45,15.64) and (18.36,15.55) .. (17.83,15.59) .. controls (16.65,15.76) and (15.67,16.38) .. (15.67,16.38) .. controls (15.40,17.19) and (14.82,17.01) .. (14.09,17.32) .. controls (14.70,18.69) and (14.76,19.32) .. (15.50,21.32) .. controls (15.76,22.37) and (16.54,24.00) .. (16.15,24.00) -- cycle(7.83,16.74) .. controls (6.83,15.71) and (5.72,15.70) .. (4.05,15.42) .. controls (2.75,15.19) and (0.39,12.97) .. (0.02,10.68) .. controls (-0.02,10.07) and (-0.06,8.50) .. (0.45,7.18) .. controls (0.94,6.05) and (1.27,5.45) .. (2.29,4.85) .. controls (1.41,8.02) and (7.59,10.18) .. (8.55,13.80) -- (8.55,13.80) .. controls (7.73,15.00) and (7.80,15.64) .. (7.83,16.74) -- cycle;
  \\end{tikzpicture}
\\end{lrbox}

\\makeatletter
\\g@addto@macro\\tableofcontents{\\clearpage}
\\renewcommand\\maketitle{
  \\thispagestyle{empty}
  \\hyphenpenalty=10000 % hyphens look bad in titles
  \\renewcommand{\\baselinestretch}{1.1}
  \\NewCommandCopy{\\oldtoday}{\\today}
  \\renewcommand{\\today}{\\LARGE\\number\\year\\\\\\large%
    \\ifcase \\month \\or Jan\\or Feb\\or Mar\\or Apr\\or May \\or Jun\\or Jul\\or Aug\\or Sep\\or Oct\\or Nov\\or Dec\\fi
    ~\\number\\day}
  \\begin{tikzpicture}[remember picture,overlay]
    %% Background Polygons %%
    \\foreach \\i in {2.5,...,22} % bottom left
    {\\node[rounded corners,black!3.5,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.west)+(2.5,-4.2)$) {} ;}
    \\foreach \\i in {0.5,...,22} % top left
    {\\node[rounded corners,black!5,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.north west)+(2.5,2)$) {} ;}
    \\node[rounded corners,fill=black!4,regular polygon,regular polygon sides=6, minimum size=5.5 cm,ultra thick] at ($(current page.north west)+(2.5,2)$) {};
    \\foreach \\i in {0.5,...,24} % top right
    {\\node[rounded corners,black!2,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.north east)+(0,-8.5)$) {} ;}
    \\node[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2.5 cm,ultra thick] at ($(current page.north east)+(0,-8.5)$) {};
    \\foreach \\i in {21,...,3} % bottom right
    {\\node[black!3,rounded corners,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.south east)+(-1.5,0.75)$) {} ;}
    \\node[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2 cm,ultra thick] at ($(current page.south east)+(-1.5,0.75)$) {};
    \\node[align=center, scale=1.4] at ($(current page.south east)+(-1.5,0.75)$) {\\usebox\\orgicon};
    %% Text %%
    \\node[left, align=right, black, text width=0.8\\paperwidth, minimum height=3cm, rounded corners,font=\\Huge\\bfseries] at ($(current page.north east)+(-2,-8.5)$)
    {\\@title};
    \\node[left, align=right, black, text width=0.8\\paperwidth, minimum height=2cm, rounded corners, font=\\Large] at ($(current page.north east)+(-2,-11.8)$)
    {\\scshape \\@author};
    \\renewcommand{\\baselinestretch}{0.75}
    \\node[align=center,rounded corners,fill=black!3,text=black,regular polygon,regular polygon sides=6, minimum size=2.5 cm,inner sep=0, font=\\Large\\bfseries ] at ($(current page.west)+(2.5,-4.2)$)
    {\\@date};
  \\end{tikzpicture}
  \\let\\today\\oldtoday
  \\clearpage}
\\makeatother"</span>
  <span class="ef-d">"LaTeX preamble snippet that sets \\maketitle to produce a cover page."</span>)

(eval '(cl-pushnew '(<span class="ef-b">:latex-cover-page</span> nil <span class="ef-s">"coverpage"</span> org-latex-cover-page)
                   (org-export-backend-options (org-export-get-backend 'latex))))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-cover-page-p</span> ()
  <span class="ef-d">"Whether a cover page should be used when exporting this Org file."</span>
  (<span class="ef-k">pcase</span> (<span class="ef-k">or</span> (car
              (delq nil
                    (mapcar
                     (<span class="ef-k">lambda</span> (opt-line)
                       (plist-get (org-export--parse-option-keyword opt-line 'latex) <span class="ef-b">:latex-cover-page</span>))
                     (cdar (org-collect-keywords '(<span class="ef-s">"OPTIONS"</span>))))))
             org-latex-cover-page)
    ((<span class="ef-k">or</span> 't 'yes) t)
    ('auto (<span class="ef-k">when</span> (&gt; (count-words (point-min) (point-max)) org-latex-cover-page-wordcount-threshold) t))
    (_ nil)))

(<span class="ef-k">defadvice!</span> org-latex-set-coverpage-subtitle-format-a (contents info)
  <span class="ef-d">"Set the subtitle format when a cover page is being used."</span>
  <span class="ef-b">:before</span> #'org-latex-template
  (<span class="ef-k">when</span> (org-latex-cover-page-p)
    (<span class="ef-k">setf</span> info (plist-put info <span class="ef-b">:latex-subtitle-format</span> org-latex-subtitle-coverpage-format))))

(<span class="ef-k">org-export-update-features</span> 'latex
  (cover-page
   <span class="ef-b">:condition</span> (org-latex-cover-page-p)
   <span class="ef-b">:snippet</span> org-latex-cover-page-maketitle
   <span class="ef-b">:order</span> 9))

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-condense-lists</span> t
  <span class="ef-d">"Reduce the space between list items."</span>)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-condensed-lists</span>
  <span class="ef-s">"\\newcommand{\\setuplistspacing}{\\setlength{\\itemsep}{-0.5ex}\\setlength{\\parskip}{1.5ex}\\setlength{\\parsep}{0pt}}
\\let\\olditem\\itemize\\renewcommand{\\itemize}{\\olditem\\setuplistspacing}
\\let\\oldenum\\enumerate\\renewcommand{\\enumerate}{\\oldenum\\setuplistspacing}
\\let\\olddesc\\description\\renewcommand{\\description}{\\olddesc\\setuplistspacing}"</span>
  <span class="ef-d">"LaTeX preamble snippet that reduces the space between list items."</span>)

(<span class="ef-k">org-export-update-features</span> 'latex
  (condensed-lists
   <span class="ef-b">:condition</span> (<span class="ef-k">and</span> org-latex-condense-lists <span class="ef-s">"^[ \t]*[-+]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">^[ \t]*[1Aa][.)] "</span>)
   <span class="ef-b">:snippet</span> org-latex-condensed-lists
   <span class="ef-b">:order</span> 0.7))

(use-package! engrave-faces-latex
  <span class="ef-b">:after</span> ox-latex)

(<span class="ef-k">setq</span> org-latex-listings 'engraved
      org-latex-engraved-theme 'doom-one-light)

(<span class="ef-k">org-export-update-features</span> 'latex
  (no-protrusion-in-code
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> (microtype engraved-code)
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\ifcsname Code\\endcsname\n  \\let\\oldcode\\Code\\renewcommand{\\Code}{\\microtypesetup{protrusion=false}\\oldcode}\n\\fi"</span>
   <span class="ef-b">:after</span> (engraved-code microtype)))

(<span class="ef-k">defadvice!</span> org-latex-example-block-engraved (orig-fn example-block contents info)
  <span class="ef-d">"Like `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-example-block</span><span class="ef-d">', but supporting an engraved backend"</span>
  <span class="ef-b">:around</span> #'org-latex-example-block
  (<span class="ef-k">let</span> ((output-block (funcall orig-fn example-block contents info)))
    (<span class="ef-k">if</span> (eq 'engraved (plist-get info <span class="ef-b">:latex-listings</span>))
        (format <span class="ef-s">"\\begin{Code}[alt]\n%s\n\\end{Code}"</span> output-block)
      output-block)))

(<span class="ef-k">defadvice!</span> org-latex-pick-compiler (_contents info)
  <span class="ef-b">:before</span> #'org-latex-template
  <span class="ef-b">:before</span> #'org-beamer-template
  (<span class="ef-k">when</span> (<span class="ef-k">and</span> (memq 'code (plist-get info <span class="ef-b">:features</span>))
             (memq 'julia-code (plist-get info <span class="ef-b">:features</span>))
             (<span class="ef-k">save-excursion</span>
               (goto-char (point-min))
               (re-search-forward <span class="ef-s">"[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">\x00-\x7F\u200b]"</span> nil t)))
    (<span class="ef-k">setf</span> info (plist-put
                (<span class="ef-k">if</span> (member #'+org-latex-replace-non-ascii-chars (plist-get info <span class="ef-b">:filter-final-output</span>))
                    (plist-put info <span class="ef-b">:filter-final-output</span>
                               (delq #'+org-latex-replace-non-ascii-chars (plist-get info <span class="ef-b">:filter-final-output</span>)))
                  info)
                <span class="ef-b">:latex-compiler</span> <span class="ef-s">"lualatex"</span>))))

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-julia-mono-fontspec</span>
  <span class="ef-s">"\\ifcsname directlua\\endcsname
  \\usepackage{fontspec}
  \\newfontfamily\\JuliaMono{JuliaMono-Regular.ttf}[Path=/usr/share/fonts/truetype/, Extension=.ttf]
  \\newfontface\\JuliaMonoRegular{JuliaMono-Regular}
  \\setmonofont{JuliaMonoRegular}[Contextuals=Alternate, Scale=MatchLowercase]
\\fi"</span>
  <span class="ef-d">"LaTeX preamble snippet that sets LuaLaTeX's fontspec to use Julia Mono."</span>)

(<span class="ef-k">org-export-update-features</span> 'latex
  (julia-code
   <span class="ef-b">:condition</span> <span class="ef-s">"^[ \t]*#\\+begin_src julia</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">^[ \t]*#\\+BEGIN_SRC julia</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">src_julia"</span>
   <span class="ef-b">:when</span> code
   <span class="ef-b">:snippet</span> org-latex-julia-mono-fontspec
   <span class="ef-b">:after</span> custom-font
   <span class="ef-b">:order</span> 0)
  (microtype-lualatex
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> (microtype julia-code)
   <span class="ef-b">:prevents</span> microtype
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage[activate={true,nocompatibility},final,tracking=true,factor=2000]{microtype}\n"</span>
   <span class="ef-b">:order</span> 0.1)
  (custom-font-no-mono
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> julia-code
   <span class="ef-b">:prevents</span> custom-font
   <span class="ef-b">:snippet</span> (org-latex-fontset <span class="ef-b">:serif</span> <span class="ef-b">:sans</span>)
   <span class="ef-b">:order</span> 0))

(<span class="ef-k">defvar</span> <span class="ef-v">+org-pdflatex-inputenc-encoded-chars</span>
  <span class="ef-s">"[[:ascii:]\u00A0-\u01F0\u0218-\u021BÈ²È³È·ËËËËËËË\u0400-\u04FFá¸á¸áº\u200B\u200C\u2010-\u201Eâ â¡â¢â¦â°â±â¹âºâ»â½ââââ¡â¤â¦â©â«â¬â±âââââ â¢â¦â§â®âââââ©âªâ¢â£â¦â¯âªâ¨â©á¸ á¸¡\uFB00-\uFB06\u2500-\u259F]"</span>)

(<span class="ef-k">defun</span> <span class="ef-f">+org-latex-replace-non-ascii-chars</span> (text backend info)
  <span class="ef-d">"Replace non-ascii chars with \\char\"XYZ forms."</span>
  (<span class="ef-k">when</span> (<span class="ef-k">and</span> (org-export-derived-backend-p backend 'latex)
             (string= (plist-get info <span class="ef-b">:latex-compiler</span>) <span class="ef-s">"pdflatex"</span>))
    (<span class="ef-k">let</span> (case-replace)
      (replace-regexp-in-string <span class="ef-s">"[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">[:ascii:]]"</span>
                                (<span class="ef-k">lambda</span> (nonascii)
                                  (<span class="ef-k">if</span> (<span class="ef-k">or</span> (string-match-p +org-pdflatex-inputenc-encoded-chars nonascii)
                                          (string-match-p org-latex-emoji--rx nonascii))
                                      nonascii
                                    (<span class="ef-k">or</span> (cdr (assoc nonascii +org-latex-non-ascii-char-substitutions))
                                        <span class="ef-s">"Â¿"</span>)))
                                text))))

(add-to-list 'org-export-filter-plain-text-functions #'+org-latex-replace-non-ascii-chars t)

(<span class="ef-k">defvar</span> <span class="ef-v">+org-latex-non-ascii-char-substitutions</span>
   '((<span class="ef-s">"É"</span> . <span class="ef-s">"\\\\(\\\\alpha\\\\)"</span>)
     (<span class="ef-s">"Î²"</span> . <span class="ef-s">"\\\\(\\\\beta\\\\)"</span>)
     (<span class="ef-s">"Î³"</span> . <span class="ef-s">"\\\\(\\\\gamma\\\\)"</span>)
     (<span class="ef-s">"Î´"</span> . <span class="ef-s">"\\\\(\\\\delta\\\\)"</span>)
     (<span class="ef-s">"Îµ"</span> . <span class="ef-s">"\\\\(\\\\epsilon\\\\)"</span>)
     (<span class="ef-s">"Ïµ"</span> . <span class="ef-s">"\\\\(\\\\varepsilon\\\\)"</span>)
     (<span class="ef-s">"Î¶"</span> . <span class="ef-s">"\\\\(\\\\zeta\\\\)"</span>)
     (<span class="ef-s">"Î·"</span> . <span class="ef-s">"\\\\(\\\\eta\\\\)"</span>)
     (<span class="ef-s">"Î¸"</span> . <span class="ef-s">"\\\\(\\\\theta\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\vartheta\\\\)"</span>)
     (<span class="ef-s">"Î¹"</span> . <span class="ef-s">"\\\\(\\\\iota\\\\)"</span>)
     (<span class="ef-s">"Îº"</span> . <span class="ef-s">"\\\\(\\\\kappa\\\\)"</span>)
     (<span class="ef-s">"Î»"</span> . <span class="ef-s">"\\\\(\\\\lambda\\\\)"</span>)
     (<span class="ef-s">"Î¼"</span> . <span class="ef-s">"\\\\(\\\\mu\\\\)"</span>)
     (<span class="ef-s">"Î½"</span> . <span class="ef-s">"\\\\(\\\\nu\\\\)"</span>)
     (<span class="ef-s">"Î¾"</span> . <span class="ef-s">"\\\\(\\\\xi\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\pi\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\varpi\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\rho\\\\)"</span>)
     (<span class="ef-s">"Ï±"</span> . <span class="ef-s">"\\\\(\\\\varrho\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\sigma\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\varsigma\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\tau\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\upsilon\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\phi\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\varphi\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\psi\\\\)"</span>)
     (<span class="ef-s">"Ï"</span> . <span class="ef-s">"\\\\(\\\\omega\\\\)"</span>)
     (<span class="ef-s">"Î"</span> . <span class="ef-s">"\\\\(\\\\Gamma\\\\)"</span>)
     (<span class="ef-s">"Î"</span> . <span class="ef-s">"\\\\(\\\\Delta\\\\)"</span>)
     (<span class="ef-s">"Î"</span> . <span class="ef-s">"\\\\(\\\\Theta\\\\)"</span>)
     (<span class="ef-s">"Î"</span> . <span class="ef-s">"\\\\(\\\\Lambda\\\\)"</span>)
     (<span class="ef-s">"Î"</span> . <span class="ef-s">"\\\\(\\\\Xi\\\\)"</span>)
     (<span class="ef-s">"Î "</span> . <span class="ef-s">"\\\\(\\\\Pi\\\\)"</span>)
     (<span class="ef-s">"Î£"</span> . <span class="ef-s">"\\\\(\\\\Sigma\\\\)"</span>)
     (<span class="ef-s">"Î¥"</span> . <span class="ef-s">"\\\\(\\\\Upsilon\\\\)"</span>)
     (<span class="ef-s">"Î¦"</span> . <span class="ef-s">"\\\\(\\\\Phi\\\\)"</span>)
     (<span class="ef-s">"Î¨"</span> . <span class="ef-s">"\\\\(\\\\Psi\\\\)"</span>)
     (<span class="ef-s">"Î©"</span> . <span class="ef-s">"\\\\(\\\\Omega\\\\)"</span>)
     (<span class="ef-s">"×"</span> . <span class="ef-s">"\\\\(\\\\aleph\\\\)"</span>)
     (<span class="ef-s">"×"</span> . <span class="ef-s">"\\\\(\\\\beth\\\\)"</span>)
     (<span class="ef-s">"×"</span> . <span class="ef-s">"\\\\(\\\\daleth\\\\)"</span>)
     (<span class="ef-s">"×"</span> . <span class="ef-s">"\\\\(\\\\gimel\\\\)"</span>)))

(<span class="ef-k">defvar</span> <span class="ef-v">+org-latex-abbreviations</span>
  '(<span class="ef-cd">;; </span><span class="ef-c">Latin
</span>    <span class="ef-s">"cf."</span> <span class="ef-s">"e.g."</span> <span class="ef-s">"etc."</span> <span class="ef-s">"et al."</span> <span class="ef-s">"i.e."</span> <span class="ef-s">"v."</span> <span class="ef-s">"vs."</span> <span class="ef-s">"viz."</span> <span class="ef-s">"n.b."</span>
    <span class="ef-cd">;; </span><span class="ef-c">Corperate
</span>    <span class="ef-s">"inc."</span> <span class="ef-s">"govt."</span> <span class="ef-s">"ltd."</span> <span class="ef-s">"pty."</span> <span class="ef-s">"dept."</span>
    <span class="ef-cd">;; </span><span class="ef-c">Temporal
</span>    <span class="ef-s">"est."</span> <span class="ef-s">"c."</span>
    <span class="ef-cd">;; </span><span class="ef-c">Honorifics
</span>    <span class="ef-s">"Prof."</span> <span class="ef-s">"Dr."</span> <span class="ef-s">"Mr."</span> <span class="ef-s">"Mrs."</span> <span class="ef-s">"Ms."</span> <span class="ef-s">"Miss."</span> <span class="ef-s">"Sr."</span> <span class="ef-s">"Jr."</span>
    <span class="ef-cd">;; </span><span class="ef-c">Components of a work
</span>    <span class="ef-s">"ed."</span> <span class="ef-s">"vol."</span> <span class="ef-s">"sec."</span> <span class="ef-s">"chap."</span> <span class="ef-s">"pt."</span> <span class="ef-s">"pp."</span> <span class="ef-s">"op."</span> <span class="ef-s">"no."</span>
    <span class="ef-cd">;; </span><span class="ef-c">Common usage
</span>    <span class="ef-s">"approx."</span> <span class="ef-s">"misc."</span> <span class="ef-s">"min."</span> <span class="ef-s">"max."</span>)
  <span class="ef-d">"A list of abbreviations that should be spaced correctly when exporting to LaTeX."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">+org-latex-correct-latin-abbreviation-spaces</span> (text backend _info)
  <span class="ef-d">"Normalise spaces after Latin abbreviations."</span>
  (<span class="ef-k">when</span> (org-export-derived-backend-p backend 'latex)
    (replace-regexp-in-string (<span class="ef-k">rx</span> (group (<span class="ef-k">or</span> line-start space)
                                         (regexp (regexp-opt-group +org-latex-abbreviations)))
                                  (<span class="ef-k">or</span> line-end space))
                              <span class="ef-s">"\\1\\\\ "</span>
                              text)))

(add-to-list 'org-export-filter-paragraph-functions #'+org-latex-correct-latin-abbreviation-spaces t)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-extra-special-string-regexps</span>
  '((<span class="ef-s">"&lt;-&gt;"</span> . <span class="ef-s">"\\\\(\\\\leftrightarrow{}\\\\)"</span>)
    (<span class="ef-s">"-&gt;"</span> . <span class="ef-s">"\\\\textrightarrow{}"</span>)
    (<span class="ef-s">"&lt;-"</span> . <span class="ef-s">"\\\\textleftarrow{}"</span>)))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-convert-extra-special-strings</span> (string)
  <span class="ef-d">"Convert special characters in STRING to LaTeX."</span>
  (<span class="ef-k">dolist</span> (a org-latex-extra-special-string-regexps string)
    (<span class="ef-k">let</span> ((re (car a))
          (rpl (cdr a)))
      (<span class="ef-k">setq</span> string (replace-regexp-in-string re rpl string t)))))

(<span class="ef-k">defadvice!</span> org-latex-plain-text-extra-special-a (orig-fn text info)
  <span class="ef-d">"Make `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-plain-text</span><span class="ef-d">' handle some extra special strings."</span>
  <span class="ef-b">:around</span> #'org-latex-plain-text
  (<span class="ef-k">let</span> ((output (funcall orig-fn text info)))
    (<span class="ef-k">when</span> (plist-get info <span class="ef-b">:with-special-strings</span>)
      (<span class="ef-k">setq</span> output (org-latex-convert-extra-special-strings output)))
    output))

(<span class="ef-k">setq</span> org-latex-text-markup-alist
      '((bold . <span class="ef-s">"\\textbf{%s}"</span>)
        (code . protectedtexttt)
        (italic . <span class="ef-s">"\\emph{%s}"</span>)
        (strike-through . <span class="ef-s">"\\sout{%s}"</span>)
        (underline . <span class="ef-s">"\\uline{%s}"</span>)
        (verbatim . verb)))

(<span class="ef-k">setq</span> org-required-latex-packages
      '(<span class="ef-s">"adjustbox"</span> <span class="ef-s">"accsupp"</span> <span class="ef-s">"amsmath"</span> <span class="ef-s">"booktabs"</span> <span class="ef-s">"cancel"</span> <span class="ef-s">"capt-of"</span>
	<span class="ef-s">"caption"</span> <span class="ef-s">"cleveref"</span> <span class="ef-s">"embedall"</span> <span class="ef-s">"etoolbox"</span> <span class="ef-s">"float"</span> <span class="ef-s">"fontenc"</span>
	<span class="ef-s">"fvextra"</span> <span class="ef-s">"graphicx"</span> <span class="ef-s">"hanging"</span> <span class="ef-s">"hyperref"</span> <span class="ef-s">"inputenc"</span>
	<span class="ef-s">"longtable"</span> <span class="ef-s">"mathalpha"</span> <span class="ef-s">"mathtools"</span> <span class="ef-s">"microtype"</span> <span class="ef-s">"pdfx"</span>
	<span class="ef-s">"pifont"</span> <span class="ef-s">"pmboxdraw"</span> <span class="ef-s">"preview"</span> <span class="ef-s">"scrbase"</span> <span class="ef-s">"scrextend"</span> <span class="ef-s">"siunitx"</span>
	<span class="ef-s">"soul"</span> <span class="ef-s">"subcaption"</span> <span class="ef-s">"svg"</span> <span class="ef-s">"tcolorbox"</span> <span class="ef-s">"textcomp"</span> <span class="ef-s">"tikz"</span>
	<span class="ef-s">"transparent"</span> <span class="ef-s">"xcoffins"</span> <span class="ef-s">"xcolor"</span> <span class="ef-s">"xparse"</span> <span class="ef-s">"Alegreya"</span> <span class="ef-s">"arev"</span>
	<span class="ef-s">"arevmath"</span> <span class="ef-s">"biolinum"</span> <span class="ef-s">"FiraMono"</span> <span class="ef-s">"FiraSans"</span> <span class="ef-s">"fourier"</span>
	<span class="ef-s">"gillius"</span> <span class="ef-s">"kpfonts"</span> <span class="ef-s">"libertine"</span> <span class="ef-s">"newpxmath"</span> <span class="ef-s">"newpxtext"</span>
	<span class="ef-s">"newtxmath"</span> <span class="ef-s">"newtxtext"</span> <span class="ef-s">"newtxsf"</span> <span class="ef-s">"noto"</span> <span class="ef-s">"notomath"</span>
	<span class="ef-s">"plex-mono"</span> <span class="ef-s">"plex-sans"</span> <span class="ef-s">"plex-serif"</span> <span class="ef-s">"sourcecodepro"</span>
	<span class="ef-s">"sourcesanspro"</span> <span class="ef-s">"sourceserifpro"</span>))
(<span class="ef-k">defun</span> <span class="ef-f">check-for-latex-packages</span> (packages)
  (delq nil
	(mapcar
	 (<span class="ef-k">lambda</span> (package)
	   (<span class="ef-k">unless</span>
	       (= 0
		  (call-process <span class="ef-s">"kpsewhich"</span> nil nil nil
				(concat package <span class="ef-s">".sty"</span>)))
	     package))
	 packages)))
(<span class="ef-k">defun</span> <span class="ef-f">+org-warn-about-missing-latex-packages</span> (<span class="ef-t">&amp;rest</span> _)
  (message <span class="ef-s">"Checking for missing LaTeX packages..."</span>) (sleep-for 0.4)
  (<span class="ef-k">if-let</span>
      (missing-pkgs
       (check-for-latex-packages org-required-latex-packages))
      (message <span class="ef-s">"%s You are missing the following LaTeX packages: %s."</span>
	       (propertize <span class="ef-s">"Warning!"</span> 'face '(bold warning))
	       (mapconcat
		(<span class="ef-k">lambda</span> (pkg)
		  (propertize pkg 'face 'font-lock-variable-name-face))
		missing-pkgs <span class="ef-s">", "</span>))
    (message
     <span class="ef-s">"%s You have all the required LaTeX packages. Run %s to make this message go away."</span>
     (propertize <span class="ef-s">"Success!"</span> 'face '(bold success))
     (propertize <span class="ef-s">"doom sync"</span> 'face 'font-lock-keyword-face))
    (advice-remove 'org-latex-export-to-pdf
		   #'+org-warn-about-missing-latex-packages))
  (sleep-for 1))
(advice-add 'org-latex-export-to-pdf <span class="ef-b">:before</span>
	    #'+org-warn-about-missing-latex-packages)


(<span class="ef-k">provide</span> '<span class="ef-o">config-ox-latex</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">ox-latex-emoji
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-latex-emoji-install--convert</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-emoji-install--install</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-emoji-install--download</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-emoji-install</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-emoji-setup</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-emoji-fill-preamble</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-emoji-declaration</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-emoji-utf16</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-emoji-preamble</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-latex-emoji-sets</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-latex-emoji--rx</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: ox-latex-emoji"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'ox-latex
(confpkg-with-record '(<span class="ef-s">"load: ox-latex-emoji"</span> load-hooks)
(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-emoji--rx</span>
  (<span class="ef-k">let</span> (emojis)
    (map-char-table
     (<span class="ef-k">lambda</span> (char set)
       (<span class="ef-k">when</span> (eq set 'emoji)
         (<span class="ef-k">push</span> (copy-tree char) emojis)))
     char-script-table)
    (rx-to-string `(any ,@emojis)))
  <span class="ef-d">"A regexp to find all emoji-script characters."</span>)

(<span class="ef-k">defconst</span> <span class="ef-v">org-latex-emoji-base-dir</span>
  (expand-file-name <span class="ef-s">"emojis/"</span> doom-cache-dir)
  <span class="ef-d">"Directory where emojis should be saved and look for."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-emoji-sets</span>
  '((<span class="ef-s">"twemoji"</span> <span class="ef-b">:url</span> <span class="ef-s">"https://github.com/jdecked/twemoji/archive/refs/tags/v15.1.0.zip"</span>
     <span class="ef-b">:folder</span> <span class="ef-s">"twemoji-15.1.0/assets/svg"</span> <span class="ef-b">:height</span> <span class="ef-s">"1.8ex"</span> <span class="ef-b">:offset</span> <span class="ef-s">"-0.3ex"</span>)
    (<span class="ef-s">"twemoji-bw"</span> <span class="ef-b">:url</span> <span class="ef-s">"https://github.com/youdly/twemoji-color-font/archive/refs/heads/v11-release.zip"</span>
     <span class="ef-b">:folder</span> <span class="ef-s">"twemoji-color-font-11-release/assets/builds/svg-bw"</span> <span class="ef-b">:height</span> <span class="ef-s">"1.8ex"</span> <span class="ef-b">:offset</span> <span class="ef-s">"-0.3ex"</span>)
    (<span class="ef-s">"openmoji"</span> <span class="ef-b">:url</span> <span class="ef-s">"https://github.com/hfg-gmuend/openmoji/releases/latest/download/openmoji-svg-color.zip"</span>
     <span class="ef-b">:height</span> <span class="ef-s">"2.2ex"</span> <span class="ef-b">:offset</span> <span class="ef-s">"-0.45ex"</span>)
    (<span class="ef-s">"openmoji-bw"</span> <span class="ef-b">:url</span> <span class="ef-s">"https://github.com/hfg-gmuend/openmoji/releases/latest/download/openmoji-svg-black.zip"</span>
     <span class="ef-b">:height</span> <span class="ef-s">"2.2ex"</span> <span class="ef-b">:offset</span> <span class="ef-s">"-0.45ex"</span>)
    (<span class="ef-s">"emojione"</span> <span class="ef-b">:url</span> <span class="ef-s">"https://github.com/joypixels/emojione/archive/refs/tags/v2.2.7.zip"</span>
     <span class="ef-b">:folder</span> <span class="ef-s">"emojione-2.2.7/assets/svg"</span>) <span class="ef-cd">; </span><span class="ef-c">Warning, poor coverage
</span>    (<span class="ef-s">"noto"</span> <span class="ef-b">:url</span> <span class="ef-s">"https://github.com/googlefonts/noto-emoji/archive/refs/tags/v2.038.zip"</span>
     <span class="ef-b">:folder</span> <span class="ef-s">"noto-emoji-2.038/svg"</span> <span class="ef-b">:file-regexp</span> <span class="ef-s">"^emoji_u</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[0-9a-f_]+</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span>
     <span class="ef-b">:height</span> <span class="ef-s">"2.0ex"</span> <span class="ef-b">:offset</span> <span class="ef-s">"-0.3ex"</span>))
  <span class="ef-d">"An alist of plistst of emoji sets.
Specified with the minimal form:
  (\"SET-NAME\" :url \"URL\")
The following optional parameters are supported:
  :folder (defaults to \"\")
  The folder within the archive where the emojis exist.
  :file-regexp (defaults to nil)
  Pattern with the emoji code point as the first capture group.
  :height (defaults to \"1.8ex\")
  Height of the emojis to be used.
  :offset (defaults to \"-0.3ex\")
  Baseline offset of the emojis."</span>)

(<span class="ef-k">defconst</span> <span class="ef-v">org-latex-emoji-keyword</span>
  <span class="ef-s">"LATEX_EMOJI_SET"</span>
  <span class="ef-d">"Keyword used to set the emoji set from `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-emoji-sets</span><span class="ef-d">'."</span>)

(<span class="ef-k">defvar</span> <span class="ef-v">org-latex-emoji-preamble</span> <span class="ef-s">"\\usepackage{accsupp}
% The transparent package is also needed, but will be loaded later.
\\newsavebox\\emojibox

\\NewDocumentCommand\\DeclareEmoji{m m}{% UTF-8 codepoint, UTF-16 codepoint
  \\DeclareUnicodeCharacter{#1}{%
    \\sbox\\emojibox{\\raisebox{OFFSET}{%
        \\includegraphics[height=HEIGHT]{EMOJI-FOLDER/#1}}}%
    \\usebox\\emojibox
    \\llap{%
      \\resizebox{\\wd\\emojibox}{\\height}{%
        \\BeginAccSupp{method=hex,unicode,ActualText=#2}%
        \\texttransparent{0}{X}%
        \\EndAccSupp{}}}}}"</span>
  <span class="ef-d">"LaTeX preamble snippet that will allow for emojis to be declared.
Contains the string \"EMOJI-FOLDER\" which should be replaced with
the path to the emoji folder."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-utf16</span> (char)
  <span class="ef-d">"Return the pair of UTF-16 surrogates that represent CHAR."</span>
  (list
   (+ #xD7C0 (ash char -10))
   (+ #xDC00 (logand char #x03FF))))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-declaration</span> (char)
  <span class="ef-d">"Construct the LaTeX command declaring CHAR as an emoji."</span>
  (format <span class="ef-s">"\\DeclareEmoji{%X}{%s} %% %s"</span>
          char
          (<span class="ef-k">if</span> (&lt; char #xFFFF)
              (format <span class="ef-s">"%X"</span> char)
            (apply #'format <span class="ef-s">"%X%X"</span> (org-latex-emoji-utf16 char)))
          (capitalize (get-char-code-property char 'name))))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-fill-preamble</span> (emoji-folder <span class="ef-t">&amp;optional</span> height offset svg-p)
  <span class="ef-d">"Fill in `</span><span style="color: #b751b6; text-decoration: italic;">org-latex-emoji-preamble</span><span class="ef-d">' with EMOJI-FOLDER, HEIGHT, and OFFSET.
If SVG-P is set \"includegraphics\" will be replaced with \"includesvg\"."</span>
  (<span class="ef-k">let*</span> (case-fold-search
         (filled-preamble
          (replace-regexp-in-string
           <span class="ef-s">"HEIGHT"</span>
           (<span class="ef-k">or</span> height <span class="ef-s">"1.8ex"</span>)
           (replace-regexp-in-string
            <span class="ef-s">"OFFSET"</span>
            (<span class="ef-k">or</span> offset <span class="ef-s">"-0.3ex"</span>)
            (replace-regexp-in-string
             <span class="ef-s">"EMOJI-FOLDER"</span>
             (directory-file-name
              (<span class="ef-k">if</span> (getenv <span class="ef-s">"HOME"</span>)
                  (replace-regexp-in-string
                   (regexp-quote (getenv <span class="ef-s">"HOME"</span>))
                   <span class="ef-s">"\\string~"</span>
                   emoji-folder t t)
                emoji-folder))
             org-latex-emoji-preamble t t)
            t t)
           t t)))
    (<span class="ef-k">if</span> svg-p
        (replace-regexp-in-string
         <span class="ef-s">"includegraphics"</span> <span class="ef-s">"includesvg"</span>
         filled-preamble t t)
      filled-preamble)))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-setup</span> (<span class="ef-t">&amp;optional</span> info)
  <span class="ef-d">"Construct a preamble snippet to set up emojis based on INFO."</span>
  (<span class="ef-k">let*</span> ((emoji-set
          (<span class="ef-k">or</span> (org-element-map
                  (plist-get info <span class="ef-b">:parse-tree</span>)
                  'keyword
                (<span class="ef-k">lambda</span> (keyword)
                  (<span class="ef-k">and</span> (string= (org-element-property <span class="ef-b">:key</span> keyword)
                                org-latex-emoji-keyword)
                       (org-element-property <span class="ef-b">:value</span> keyword)))
                info t)
              (caar org-latex-emoji-sets)))
         (emoji-spec (cdr (assoc emoji-set org-latex-emoji-sets)))
         (emoji-folder
          (expand-file-name emoji-set org-latex-emoji-base-dir))
         (emoji-svg-only
          (<span class="ef-k">and</span> (file-exists-p emoji-folder)
               (not (cl-some
                     (<span class="ef-k">lambda</span> (path)
                       (not (string= (file-name-extension path) <span class="ef-s">"svg"</span>)))
                     (directory-files emoji-folder nil <span class="ef-s">"\\....$"</span>))))))
    (<span class="ef-k">cond</span>
     ((not emoji-spec)
      (<span class="ef-wr">error</span> <span class="ef-s">"Emoji set `</span><span style="color: #b751b6;">%s</span><span class="ef-s">' is unknown. Try one of: %s"</span> emoji-set
             (string-join (mapcar #'car org-latex-emoji-sets) <span class="ef-s">", "</span>)))
     ((not (file-exists-p emoji-folder))
      (<span class="ef-k">if</span> (<span class="ef-k">and</span> (not noninteractive)
               (yes-or-no-p (format <span class="ef-s">"Emoji set `</span><span style="color: #b751b6;">%s</span><span class="ef-s">' is not installed, would you like to install it?"</span> emoji-set)))
          (org-latex-emoji-install
           emoji-set
           (<span class="ef-k">or</span> (executable-find <span class="ef-s">"cairosvg"</span>) (executable-find <span class="ef-s">"inkscape"</span>)))
        (<span class="ef-wr">error</span> <span class="ef-s">"Emoji set `</span><span style="color: #b751b6;">%s</span><span class="ef-s">' is not installed"</span> emoji-set))))
    (org-latex-emoji-fill-preamble
     emoji-folder (plist-get emoji-spec <span class="ef-b">:height</span>)
     (plist-get emoji-spec <span class="ef-b">:offset</span>) emoji-svg-only)))

(<span class="ef-k">org-export-update-features</span> 'latex
  (emoji-setup <span class="ef-cd">; </span><span class="ef-c">The precompilable bit
</span>   <span class="ef-b">:condition</span> (<span class="ef-k">save-excursion</span>
                (goto-char (point-min))
                (re-search-forward org-latex-emoji--rx nil t))
   <span class="ef-b">:requires</span> (image pkg-transparent)
   <span class="ef-b">:snippet</span> org-latex-emoji-setup
   <span class="ef-b">:order</span> 3)
  (pkg-transparent <span class="ef-cd">; </span><span class="ef-c">Part of emoji setup, but non-precompilable.
</span>   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage{transparent}"</span>
   <span class="ef-b">:order</span> 84)
  (emoji-declarations
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> emoji-setup
   <span class="ef-b">:snippet</span>
   (mapconcat
    #'org-latex-emoji-declaration
    (<span class="ef-k">let</span> (unicode-cars)
      (<span class="ef-k">save-excursion</span>
        (goto-char (point-min))
        (<span class="ef-k">while</span> (re-search-forward org-latex-emoji--rx nil t)
          (<span class="ef-k">push</span> (aref (match-string 0) 0) unicode-cars)))
      (cl-delete-duplicates unicode-cars))
    <span class="ef-s">"\n"</span>)
   <span class="ef-b">:order</span> 85))

(<span class="ef-k">org-export-update-features</span> 'latex
  (emoji-lualatex-hack
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:when</span> (emoji julia-code) <span class="ef-cd">; </span><span class="ef-c">LuaLaTeX is used with julia-code.
</span>   <span class="ef-b">:snippet</span>
   <span class="ef-s">"\\usepackage{newunicodechar}
\\newcommand{\\DeclareUnicodeCharacter}[2]{%
    \\begingroup\\lccode`|=\\string\"#1\\relax
    \\lowercase{\\endgroup\\newunicodechar{|}}{#2}}"</span>
   <span class="ef-b">:before</span> emoji))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-install</span> (set <span class="ef-t">&amp;optional</span> convert)
  <span class="ef-d">"Dowload, convert, and install emojis for use with LaTeX."</span>
  (<span class="ef-k">interactive</span>
   (list (completing-read <span class="ef-s">"Emoji set to install: "</span>
                          (mapcar
                           (<span class="ef-k">lambda</span> (set-spec)
                             (<span class="ef-k">if</span> (file-exists-p (expand-file-name (car set-spec) org-latex-emoji-base-dir))
                                 (propertize (car set-spec) 'face 'font-lock-doc-face)
                               (car set-spec)))
                           org-latex-emoji-sets)
                          nil t)
         (<span class="ef-k">if</span> (<span class="ef-k">or</span> (executable-find <span class="ef-s">"cairosvg"</span>) (executable-find <span class="ef-s">"inkscape"</span>))
             (yes-or-no-p <span class="ef-s">"Would you like to create .pdf forms of the Emojis (strongly recommended)?"</span>)
           (message <span class="ef-s">"Install `</span><span style="color: #b751b6;">cairosvg</span><span class="ef-s">' (recommended) or `</span><span style="color: #b751b6;">inkscape</span><span class="ef-s">' to convert to PDF forms"</span>)
           nil)))
  (<span class="ef-k">let</span> ((emoji-folder (expand-file-name set org-latex-emoji-base-dir)))
    (<span class="ef-k">when</span> (<span class="ef-k">or</span> (not (file-exists-p emoji-folder))
              (<span class="ef-k">and</span> (not noninteractive)
                   (yes-or-no-p <span class="ef-s">"Emoji folder already present, would you like to re-download?"</span>)
                   (<span class="ef-k">progn</span> (delete-directory emoji-folder t) t)))
      (<span class="ef-k">let*</span> ((spec (cdr (assoc set org-latex-emoji-sets)))
             (dir (org-latex-emoji-install--download set (plist-get spec <span class="ef-b">:url</span>)))
             (svg-dir (expand-file-name (<span class="ef-k">or</span> (plist-get spec <span class="ef-b">:folder</span>) <span class="ef-s">""</span>) dir)))
        (org-latex-emoji-install--install
         set svg-dir (plist-get spec <span class="ef-b">:file-regexp</span>))))
    (<span class="ef-k">when</span> convert
      (org-latex-emoji-install--convert (file-name-as-directory emoji-folder))))
  (message <span class="ef-s">"Emojis set `</span><span style="color: #b751b6;">%s</span><span class="ef-s">' installed."</span> set))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-install--download</span> (name url)
  <span class="ef-d">"Download the emoji archive URL for the set NAME."</span>
  (<span class="ef-k">let*</span> ((dest-folder (make-temp-file (format <span class="ef-s">"%s-"</span> name) t)))
    (message <span class="ef-s">"Downloading %s..."</span> name)
    (<span class="ef-k">let</span> ((default-directory dest-folder))
      (call-process <span class="ef-s">"curl"</span> nil nil nil <span class="ef-s">"-sL"</span> url <span class="ef-s">"--output"</span> <span class="ef-s">"emojis.zip"</span>)
      (message <span class="ef-s">"Unzipping"</span>)
      (call-process <span class="ef-s">"unzip"</span> nil nil nil <span class="ef-s">"emojis.zip"</span>)
      dest-folder)))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-install--install</span> (name dir <span class="ef-t">&amp;optional</span> filename-regexp)
  <span class="ef-d">"Install the emoji files in DIR to the NAME set folder.
If a FILENAME-REGEXP, only files matching this regexp will be moved,
and they will be renamed to the first capture group of the regexp."</span>
  (message <span class="ef-s">"Installing %s emojis into emoji directory"</span> name)
  (<span class="ef-k">let</span> ((images (append (directory-files dir t <span class="ef-s">".*.svg"</span>)
                        (directory-files dir t <span class="ef-s">".*.pdf"</span>)))
        (emoji-dir (file-name-as-directory
                    (expand-file-name name org-latex-emoji-base-dir))))
    (<span class="ef-k">unless</span> (file-exists-p emoji-dir)
      (make-directory emoji-dir t))
    (mapc
     (<span class="ef-k">lambda</span> (image)
       (<span class="ef-k">if</span> filename-regexp
           (<span class="ef-k">when</span> (string-match filename-regexp (file-name-nondirectory image))
             (rename-file image
                          (expand-file-name
                           (file-name-with-extension
                            (upcase (match-string 1 (file-name-nondirectory image)))
                            (file-name-extension image))
                           emoji-dir)
                          t))
         (rename-file image
                      (expand-file-name
                       (file-name-with-extension
                        (upcase (file-name-nondirectory image))
                        (file-name-extension image))
                       emoji-dir)
                      t)))
     images)
    (message <span class="ef-s">"%d emojis installed"</span> (length images))))

(<span class="ef-k">defun</span> <span class="ef-f">org-latex-emoji-install--convert</span> (dir)
  <span class="ef-d">"Convert all .svg files in DIR to .pdf forms.
Uses cairosvg if possible, falling back to inkscape."</span>
  (<span class="ef-k">let</span> ((default-directory dir))
    (<span class="ef-k">if</span> (executable-find <span class="ef-s">"cairosvg"</span>) <span class="ef-cd">; </span><span class="ef-c">cairo's PDFs are ~10% smaller
</span>        (<span class="ef-k">let*</span> ((images (directory-files dir nil <span class="ef-s">".*.svg"</span>))
               (num-images (length images))
               (index 0)
               (max-threads (1- (string-to-number (shell-command-to-string <span class="ef-s">"nproc"</span>))))
               (threads 0))
          (<span class="ef-k">while</span> (&lt; index num-images)
            (<span class="ef-k">setf</span> threads (1+ threads))
            (<span class="ef-k">let</span> (message-log-max)
              (message <span class="ef-s">"Converting emoji %d/%d (%s)"</span> (1+ index) num-images (nth index images)))
            (make-process <span class="ef-b">:name</span> <span class="ef-s">"cairosvg"</span>
                          <span class="ef-b">:command</span> (list <span class="ef-s">"cairosvg"</span> (nth index images) <span class="ef-s">"-o"</span> (concat (file-name-sans-extension (nth index images)) <span class="ef-s">".pdf"</span>))
                          <span class="ef-b">:sentinel</span> (<span class="ef-k">lambda</span> (proc msg)
                                      (<span class="ef-k">when</span> (memq (process-status proc) '(exit signal))
                                        (<span class="ef-k">setf</span> threads (1- threads)))))
            (<span class="ef-k">setq</span> index (1+ index))
            (<span class="ef-k">while</span> (&gt; threads max-threads)
              (sleep-for 0.01)))
          (<span class="ef-k">while</span> (&gt; threads 0)
            (sleep-for 0.01)))
      (message <span class="ef-s">"Cairosvg not found. Proceeding with inkscape as a fallback."</span>)
      (shell-command <span class="ef-s">"inkscape --batch-process --export-type='</span><span style="color: #b751b6;">pdf</span><span class="ef-s">' *.svg"</span>))
    (message <span class="ef-s">"Finished conversion!"</span>)))

(<span class="ef-k">provide</span> '<span class="ef-o">ox-latex-emoji</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg ox-chameleon
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-ox-chameleon"</span> config)
(use-package! ox-chameleon
  <span class="ef-b">:after</span> ox)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-ox-chameleon</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">ox-beamer
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-beamer-metropolis-tweaks</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">org-beamer-p</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: ox-beamer"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'ox-beamer
(confpkg-with-record '(<span class="ef-s">"load: ox-beamer"</span> load-hooks)
(<span class="ef-k">setq</span> org-beamer-theme <span class="ef-s">"[progressbar=foot]metropolis"</span>)

(<span class="ef-k">defun</span> <span class="ef-f">org-beamer-p</span> (info)
  (eq 'beamer (<span class="ef-k">and</span> (plist-get info <span class="ef-b">:back-end</span>)
                   (org-export-backend-name (plist-get info <span class="ef-b">:back-end</span>)))))

(<span class="ef-k">org-export-update-features</span> 'beamer
  (beamer-setup
   <span class="ef-b">:condition</span> t
   <span class="ef-b">:requires</span> .missing-koma
   <span class="ef-b">:prevents</span> (italic-quotes condensed-lists cover-page)))

(<span class="ef-k">org-export-update-features</span> 'latex
  (.missing-koma
   <span class="ef-b">:snippet</span> <span class="ef-s">"\\usepackage{scrextend}"</span>
   <span class="ef-b">:order</span> 2))

(<span class="ef-k">defvar</span> <span class="ef-v">org-beamer-metropolis-tweaks</span>
  <span class="ef-s">"\\NewCommandCopy{\\moldusetheme}{\\usetheme}
\\renewcommand*{\\usetheme}[2][]{\\moldusetheme[#1]{#2}
  \\setbeamertemplate{items}{$\\bullet$}
  \\setbeamerfont{block title}{size=\\normalsize, series=\\bfseries\\parbox{0pt}{\\rule{0pt}{4ex}}}}

\\makeatletter
\\newcommand{\\setmetropolislinewidth}{
  \\setlength{\\metropolis@progressinheadfoot@linewidth}{1.2px}}
\\makeatother

\\usepackage{etoolbox}
\\AtEndPreamble{\\setmetropolislinewidth}"</span>
  <span class="ef-d">"LaTeX preamble snippet that tweaks the Beamer metropolis theme styling."</span>)

(<span class="ef-k">org-export-update-features</span> 'beamer
  (beamer-metropolis
   <span class="ef-b">:condition</span> (string-match-p <span class="ef-s">"metropolis$"</span> (plist-get info <span class="ef-b">:beamer-theme</span>))
   <span class="ef-b">:snippet</span> org-beamer-metropolis-tweaks
   <span class="ef-b">:order</span> 3))

(<span class="ef-k">setq</span> org-beamer-frame-level 2)

(<span class="ef-k">provide</span> '<span class="ef-o">config-ox-beamer</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg org-re-reveal
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"hook: pkg-org-re-reveal"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'org-re-reveal
(confpkg-with-record '(<span class="ef-s">"load: pkg-org-re-reveal"</span> load-hooks)
(<span class="ef-k">setq</span> org-re-reveal-theme <span class="ef-s">"white"</span>
      org-re-reveal-transition <span class="ef-s">"slide"</span>
      org-re-reveal-plugins '(markdown notes math search zoom))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-org-re-reveal</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">ox-ascii
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-ascii-convert-latex</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: ox-ascii"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'ox-ascii
(confpkg-with-record '(<span class="ef-s">"load: ox-ascii"</span> load-hooks)
(<span class="ef-k">setq</span> org-ascii-charset 'utf-8)

(<span class="ef-k">when</span> (executable-find <span class="ef-s">"latex2text"</span>)
  (<span class="ef-k">after!</span> ox-ascii
    (<span class="ef-k">defvar</span> <span class="ef-v">org-ascii-convert-latex</span> t
      <span class="ef-d">"Use latex2text to convert LaTeX elements to unicode."</span>)

    (<span class="ef-k">defadvice!</span> org-ascii-latex-environment-unicode-a (latex-environment _contents info)
      <span class="ef-d">"Transcode a LATEX-ENVIRONMENT element from Org to ASCII, converting to unicode.
CONTENTS is nil.  INFO is a plist holding contextual
information."</span>
      <span class="ef-b">:override</span> #'org-ascii-latex-environment
      (<span class="ef-k">when</span> (plist-get info <span class="ef-b">:with-latex</span>)
        (org-ascii--justify-element
         (org-remove-indentation
          (<span class="ef-k">let*</span> ((latex (org-element-property <span class="ef-b">:value</span> latex-environment))
                 (unicode (<span class="ef-k">and</span> (eq (plist-get info <span class="ef-b">:ascii-charset</span>) 'utf-8)
                               org-ascii-convert-latex
                               (doom-call-process <span class="ef-s">"latex2text"</span> <span class="ef-s">"-q"</span> <span class="ef-s">"--code"</span> latex))))
            (<span class="ef-k">if</span> (= (car unicode) 0) <span class="ef-cd">; </span><span class="ef-c">utf-8 set, and sucessfully ran latex2text
</span>                (cdr unicode) latex)))
         latex-environment info)))

    (<span class="ef-k">defadvice!</span> org-ascii-latex-fragment-unicode-a (latex-fragment _contents info)
      <span class="ef-d">"Transcode a LATEX-FRAGMENT object from Org to ASCII, converting to unicode.
CONTENTS is nil.  INFO is a plist holding contextual
information."</span>
      <span class="ef-b">:override</span> #'org-ascii-latex-fragment
      (<span class="ef-k">when</span> (plist-get info <span class="ef-b">:with-latex</span>)
        (<span class="ef-k">let*</span> ((latex (org-element-property <span class="ef-b">:value</span> latex-fragment))
               (unicode (<span class="ef-k">and</span> (eq (plist-get info <span class="ef-b">:ascii-charset</span>) 'utf-8)
                             org-ascii-convert-latex
                             (doom-call-process <span class="ef-s">"latex2text"</span> <span class="ef-s">"-q"</span> <span class="ef-s">"--code"</span> latex))))
          (<span class="ef-k">if</span> (<span class="ef-k">and</span> unicode (= (car unicode) 0)) <span class="ef-cd">; </span><span class="ef-c">utf-8 set, and sucessfully ran latex2text
</span>              (cdr unicode) latex))))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-ox-ascii</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">ox-md
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-utf8-entity</span><span class="ef-c">', `</span><span style="color: #b751b6;">org-md-latex-environment</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">and `</span><span style="color: #b751b6;">org-md-latex-fragment</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"hook: ox-md"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'ox-md
(confpkg-with-record '(<span class="ef-s">"load: ox-md"</span> load-hooks)
(<span class="ef-k">defadvice!</span> org-md-plain-text-unicode-a (orig-fn text info)
  <span class="ef-d">"Locally rebind `</span><span style="color: #b751b6; text-decoration: italic;">org-html-special-string-regexps</span><span class="ef-d">'"</span>
  <span class="ef-b">:around</span> #'org-md-plain-text
  (<span class="ef-k">let</span> ((org-html-special-string-regexps
         '((<span class="ef-s">"\\\\-"</span> . <span class="ef-s">"-"</span>)
           (<span class="ef-s">"---</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">-]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">$</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> . <span class="ef-s">"â\\1"</span>)
           (<span class="ef-s">"--</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[</span><span style="color: #4078f2; font-weight: 700;">^</span><span class="ef-s">-]</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">|</span><span class="ef-s">$</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> . <span class="ef-s">"â\\1"</span>)
           (<span class="ef-s">"\\.\\.\\."</span> . <span class="ef-s">"â¦"</span>)
           (<span class="ef-s">"&lt;-&gt;"</span> . <span class="ef-s">"â·"</span>)
           (<span class="ef-s">"-&gt;"</span> . <span class="ef-s">"â"</span>)
           (<span class="ef-s">"&lt;-"</span> . <span class="ef-s">"â"</span>))))
    (funcall orig-fn text (plist-put info <span class="ef-b">:with-smart-quotes</span> nil))))

(<span class="ef-k">after!</span> ox-md
  (<span class="ef-k">defun</span> <span class="ef-f">org-md-latex-fragment</span> (latex-fragment _contents info)
    <span class="ef-d">"Transcode a LATEX-FRAGMENT object from Org to Markdown."</span>
    (<span class="ef-k">let</span> ((frag (org-element-property <span class="ef-b">:value</span> latex-fragment)))
      (<span class="ef-k">cond</span>
       ((string-match-p <span class="ef-s">"^\\\\("</span> frag)
        (concat <span class="ef-s">"$"</span> (substring frag 2 -2) <span class="ef-s">"$"</span>))
       ((string-match-p <span class="ef-s">"^\\\\\\["</span> frag)
        (concat <span class="ef-s">"$$"</span> (substring frag 2 -2) <span class="ef-s">"$$"</span>))
       (t (message <span class="ef-s">"unrecognised fragment: %s"</span> frag)
          frag))))

  (<span class="ef-k">defun</span> <span class="ef-f">org-md-latex-environment</span> (latex-environment contents info)
    <span class="ef-d">"Transcode a LATEX-ENVIRONMENT object from Org to Markdown."</span>
    (concat <span class="ef-s">"$$\n"</span>
            (org-html-latex-environment latex-environment contents info)
            <span class="ef-s">"$$\n"</span>))

  (<span class="ef-k">defun</span> <span class="ef-f">org-utf8-entity</span> (entity _contents _info)
    <span class="ef-d">"Transcode an ENTITY object from Org to utf-8.
CONTENTS are the definition itself.  INFO is a plist holding
contextual information."</span>
    (org-element-property <span class="ef-b">:utf-8</span> entity))

  <span class="ef-cd">;; </span><span class="ef-c">We can't let this be immediately parsed and evaluated,
</span>  <span class="ef-cd">;; </span><span class="ef-c">because eager macro-expansion tries to call as-of-yet
</span>  <span class="ef-cd">;; </span><span class="ef-c">undefined functions.
</span>  <span class="ef-cd">;; </span><span class="ef-c">NOTE in the near future this shouldn't be required
</span>  (eval
   '(dolist (extra-transcoder
             '((latex-fragment . org-md-latex-fragment)
               (latex-environment . org-md-latex-environment)
               (entity . org-utf8-entity)))
      (<span class="ef-k">unless</span> (member extra-transcoder (org-export-backend-transcoders
                                        (org-export-get-backend 'md)))
        (<span class="ef-k">push</span> extra-transcoder (org-export-backend-transcoders
                                (org-export-get-backend 'md)))))))

(<span class="ef-k">provide</span> '<span class="ef-o">config-ox-md</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg ox-gfm
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-ox-gfm"</span> config)
(use-package! ox-gfm
  <span class="ef-b">:after</span> ox)

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-ox-gfm</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Org Babel
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">org-babel-auto-async-languages</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: org-babel"</span> config)
(<span class="ef-k">add-transient-hook!</span> #'org-babel-execute-src-block
  (<span class="ef-k">require</span> '<span class="ef-o">ob-async</span>))

(<span class="ef-k">defvar</span> <span class="ef-v">org-babel-auto-async-languages</span> '()
  <span class="ef-d">"Babel languages which should be executed asyncronously by default."</span>)

(<span class="ef-k">defadvice!</span> org-babel-get-src-block-info-eager-async-a (orig-fn <span class="ef-t">&amp;optional</span> light datum)
  <span class="ef-d">"Eagarly add an :async parameter to the src information, unless it seems problematic.
This only acts o languages in `</span><span style="color: #b751b6; text-decoration: italic;">org-babel-auto-async-languages</span><span class="ef-d">'.
Not added when either:
+ session is not \"none\"
+ :sync is set"</span>
  <span class="ef-b">:around</span> #'org-babel-get-src-block-info
  (<span class="ef-k">let</span> ((result (funcall orig-fn light datum)))
    (<span class="ef-k">when</span> (<span class="ef-k">and</span> (string= <span class="ef-s">"none"</span> (cdr (assoc <span class="ef-b">:session</span> (caddr result))))
               (member (car result) org-babel-auto-async-languages)
               (not (assoc <span class="ef-b">:async</span> (caddr result))) <span class="ef-cd">; </span><span class="ef-c">don't duplicate
</span>               (not (assoc <span class="ef-b">:sync</span> (caddr result))))
      (<span class="ef-k">push</span> '(<span class="ef-b">:async</span>) (caddr result)))
    result))

(<span class="ef-k">provide</span> '<span class="ef-o">config-org-babel</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Org ESS
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: org-ess"</span> config)
(<span class="ef-k">setq</span> ess-eval-visibly 'nowait)

(<span class="ef-k">setq</span> ess-R-font-lock-keywords
      '((ess-R-fl-keyword:keywords . t)
        (ess-R-fl-keyword:constants . t)
        (ess-R-fl-keyword:modifiers . t)
        (ess-R-fl-keyword:fun-defs . t)
        (ess-R-fl-keyword:assign-ops . t)
        (ess-R-fl-keyword:%op% . t)
        (ess-fl-keyword:fun-calls . t)
        (ess-fl-keyword:numbers . t)
        (ess-fl-keyword:operators . t)
        (ess-fl-keyword:delimiters . t)
        (ess-fl-keyword:= . t)
        (ess-R-fl-keyword:F&amp;T . t)))

(<span class="ef-k">after!</span> org
  (add-to-list '+org-babel-mode-alist '(jags . ess-jags)))

(<span class="ef-k">provide</span> '<span class="ef-o">config-org-ess</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">LaTeX
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">unimportant-latex-face</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">TeX-string-single-token-p</span><span class="ef-c">', `</span><span style="color: #b751b6;">TeX-fold-parenthesize-as-necessary</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">string-offset-apply-roman-char-exceptions</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">string-offset-roman-char-exceptions</span><span class="ef-c">', `</span><span style="color: #b751b6;">string-offset-roman-chars</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">tec/tex-delim-yas-expand</span><span class="ef-c">', `</span><span style="color: #b751b6;">tec/tex-next-char-smart-close-delim</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">tec/tex-close-delim-from-char</span><span class="ef-c">', `</span><span style="color: #b751b6;">tec/tex-open-delim-from-char</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">tec/get-open-delim-char</span><span class="ef-c">', `</span><span style="color: #b751b6;">tec/tex-delim-dot-second</span><span class="ef-c">',
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">tec/tex-last-delim-char</span><span class="ef-c">', `</span><span style="color: #b751b6;">tec/yas-latex-preamble-if</span><span class="ef-c">', and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">tec/yas-latex-get-class-choice</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: latex"</span> config)
(<span class="ef-k">setq</span> TeX-save-query nil
      TeX-show-compilation t
      TeX-command-extra-options <span class="ef-s">"-shell-escape"</span>)
(<span class="ef-k">after!</span> latex
  (add-to-list 'TeX-command-list '(<span class="ef-s">"XeLaTeX"</span> <span class="ef-s">"%`xelatex%(mode)%' %t"</span> TeX-run-TeX nil t)))

(<span class="ef-k">setq</span> +latex-viewers '(pdf-tools evince zathura okular skim sumatrapdf))

(<span class="ef-k">setq</span> tec/yas-latex-template-preamble <span class="ef-s">"
\\usepackage[pdfa,unicode=true,hidelinks]{hyperref}

\\usepackage[dvipsnames,svgnames,table,hyperref]{xcolor}
\\renewcommand{\\UrlFont}{\\ttfamily\\small}

\\usepackage[a-2b]{pdfx} % why not be archival

\\usepackage[T1]{fontenc}
\\usepackage[osf]{newpxtext}  % Palatino
\\usepackage{gillius}
\\usepackage[scale=0.9]{sourcecodepro}

\\usepackage{mathtools}
\\usepackage{amssymb}
\\let\\Bbbk\\relax
\\usepackage[varbb]{newpxmath}

\\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000]{microtype}
% microtype makes text look nicer

\\usepackage{graphicx} % include graphics

\\usepackage{booktabs} % nice table rules
"</span>)

(<span class="ef-k">defun</span> <span class="ef-f">tec/yas-latex-get-class-choice</span> ()
  <span class="ef-d">"Prompt user for LaTeX class choice"</span>
  (<span class="ef-k">setq</span> tec/yas-latex-class-choice (completing-read <span class="ef-s">"Select document class: "</span> '(<span class="ef-s">"article"</span> <span class="ef-s">"scrartcl"</span> <span class="ef-s">"bmc"</span>))))

(<span class="ef-k">defun</span> <span class="ef-f">tec/yas-latex-preamble-if</span> ()
  <span class="ef-d">"Based on class choice prompt for insertion of default preamble"</span>
  (<span class="ef-k">if</span> (equal tec/yas-latex-class-choice <span class="ef-s">"bmc"</span>) 'nil
    (eq (read-char-choice <span class="ef-s">"Include default preamble? [Type y/n]"</span> '(?y ?n)) ?y)))

(<span class="ef-k">after!</span> tex
  (<span class="ef-k">defvar</span> <span class="ef-v">tec/tex-last-delim-char</span> nil
    <span class="ef-d">"Last open delim expanded in a tex document"</span>)
  (<span class="ef-k">defvar</span> <span class="ef-v">tec/tex-delim-dot-second</span> t
    <span class="ef-d">"When the `</span><span style="color: #b751b6; text-decoration: italic;">tec/tex-last-delim-char</span><span class="ef-d">' is . a second character (this) is prompted for"</span>)
  (<span class="ef-k">defun</span> <span class="ef-f">tec/get-open-delim-char</span> ()
    <span class="ef-d">"Exclusivly read next char to tec/tex-last-delim-char"</span>
    (<span class="ef-k">setq</span> tec/tex-delim-dot-second nil)
    (<span class="ef-k">setq</span> tec/tex-last-delim-char (read-char-exclusive <span class="ef-s">"Opening deliminator, recognises: 9 ( [ { &lt; | ."</span>))
    (<span class="ef-k">when</span> (eql ?. tec/tex-last-delim-char)
      (<span class="ef-k">setq</span> tec/tex-delim-dot-second (read-char-exclusive <span class="ef-s">"Other deliminator, recognises: 0 9 (  ) [ ] { } &lt; &gt; |"</span>))))
  (<span class="ef-k">defun</span> <span class="ef-f">tec/tex-open-delim-from-char</span> (<span class="ef-t">&amp;optional</span> open-char)
    <span class="ef-d">"Find the associated opening delim as string"</span>
    (<span class="ef-k">unless</span> open-char (<span class="ef-k">setq</span> open-char (<span class="ef-k">if</span> (eql ?. tec/tex-last-delim-char)
                                          tec/tex-delim-dot-second
                                        tec/tex-last-delim-char)))
    (<span class="ef-k">pcase</span> open-char
      (?\( <span class="ef-s">"("</span>)
      (?9  <span class="ef-s">"("</span>)
      (?\[ <span class="ef-s">"["</span>)
      (?\{ <span class="ef-s">"\\{"</span>)
      (?&lt;  <span class="ef-s">"&lt;"</span>)
      (?|  (<span class="ef-k">if</span> tec/tex-delim-dot-second <span class="ef-s">"."</span> <span class="ef-s">"|"</span>))
      (_   <span class="ef-s">"."</span>)))
  (<span class="ef-k">defun</span> <span class="ef-f">tec/tex-close-delim-from-char</span> (<span class="ef-t">&amp;optional</span> open-char)
    <span class="ef-d">"Find the associated closing delim as string"</span>
    (<span class="ef-k">if</span> tec/tex-delim-dot-second
        (<span class="ef-k">pcase</span> tec/tex-delim-dot-second
          (?\) <span class="ef-s">")"</span>)
          (?0  <span class="ef-s">")"</span>)
          (?\] <span class="ef-s">"]"</span>)
          (?\} <span class="ef-s">"\\}"</span>)
          (?\&gt; <span class="ef-s">"&gt;"</span>)
          (?|  <span class="ef-s">"|"</span>)
          (_   <span class="ef-s">"."</span>))
      (<span class="ef-k">pcase</span> (<span class="ef-k">or</span> open-char tec/tex-last-delim-char)
        (?\( <span class="ef-s">")"</span>)
        (?9  <span class="ef-s">")"</span>)
        (?\[ <span class="ef-s">"]"</span>)
        (?\{ <span class="ef-s">"\\}"</span>)
        (?&lt;  <span class="ef-s">"&gt;"</span>)
        (?\) <span class="ef-s">")"</span>)
        (?0  <span class="ef-s">")"</span>)
        (?\] <span class="ef-s">"]"</span>)
        (?\} <span class="ef-s">"\\}"</span>)
        (?\&gt; <span class="ef-s">"&gt;"</span>)
        (?|  <span class="ef-s">"|"</span>)
        (_   <span class="ef-s">"."</span>))))
  (<span class="ef-k">defun</span> <span class="ef-f">tec/tex-next-char-smart-close-delim</span> (<span class="ef-t">&amp;optional</span> open-char)
    (<span class="ef-k">and</span> (<span class="ef-k">bound-and-true-p</span> smartparens-mode)
         (eql (char-after) (<span class="ef-k">pcase</span> (<span class="ef-k">or</span> open-char tec/tex-last-delim-char)
                             (?\( ?\))
                             (?\[ ?\])
                             (?{ ?})
                             (?&lt; ?&gt;)))))
  (<span class="ef-k">defun</span> <span class="ef-f">tec/tex-delim-yas-expand</span> (<span class="ef-t">&amp;optional</span> open-char)
    (yas-expand-snippet (yas-lookup-snippet <span class="ef-s">"_deliminators"</span> 'latex-mode) (point) (+ (point) (<span class="ef-k">if</span> (tec/tex-next-char-smart-close-delim open-char) 2 1)))))

(<span class="ef-k">after!</span> latex
  (setcar (assoc <span class="ef-s">"â"</span> LaTeX-fold-math-spec-list) <span class="ef-s">"â"</span>)) <span class="ef-cd">;; </span><span class="ef-c">make \star bigger
</span>
(<span class="ef-k">setq</span> TeX-fold-math-spec-list
      `(<span class="ef-cd">;; </span><span class="ef-c">missing/better symbols
</span>        (<span class="ef-s">"â¤"</span> (<span class="ef-s">"le"</span>))
        (<span class="ef-s">"â¥"</span> (<span class="ef-s">"ge"</span>))
        (<span class="ef-s">"â "</span> (<span class="ef-s">"ne"</span>))
        <span class="ef-cd">;; </span><span class="ef-c">convenience shorts -- these don't work nicely ATM
</span>        <span class="ef-cd">;; </span><span class="ef-c">("â¹" ("left"))
</span>        <span class="ef-cd">;; </span><span class="ef-c">("âº" ("right"))
</span>        <span class="ef-cd">;; </span><span class="ef-c">private macros
</span>        (<span class="ef-s">"â"</span> (<span class="ef-s">"RR"</span>))
        (<span class="ef-s">"â"</span> (<span class="ef-s">"NN"</span>))
        (<span class="ef-s">"â¤"</span> (<span class="ef-s">"ZZ"</span>))
        (<span class="ef-s">"â"</span> (<span class="ef-s">"QQ"</span>))
        (<span class="ef-s">"â"</span> (<span class="ef-s">"CC"</span>))
        (<span class="ef-s">"â"</span> (<span class="ef-s">"PP"</span>))
        (<span class="ef-s">"â"</span> (<span class="ef-s">"HH"</span>))
        (<span class="ef-s">"ð¼"</span> (<span class="ef-s">"EE"</span>))
        (<span class="ef-s">"ð"</span> (<span class="ef-s">"dd"</span>))
        <span class="ef-cd">;; </span><span class="ef-c">known commands
</span>        (<span class="ef-s">""</span> (<span class="ef-s">"phantom"</span>))
        (,(<span class="ef-k">lambda</span> (num den) (<span class="ef-k">if</span> (<span class="ef-k">and</span> (TeX-string-single-token-p num) (TeX-string-single-token-p den))
                                (concat num <span class="ef-s">"ï¼"</span> den)
                              (concat <span class="ef-s">"âª"</span> num <span class="ef-s">"ï¼"</span> den <span class="ef-s">"â«"</span>))) <span class="ef-wr">(</span><span style="color: #986801;">"frac"</span><span class="ef-wr">))</span>
        (,(<span class="ef-k">lambda</span> (arg) (concat <span class="ef-s">"â"</span> (TeX-fold-parenthesize-as-necessary arg))) (<span class="ef-s">"sqrt"</span>))
        (,(<span class="ef-k">lambda</span> (arg) (concat <span class="ef-s">"â­¡"</span> (TeX-fold-parenthesize-as-necessary arg))) (<span class="ef-s">"vec"</span>))
        (<span class="ef-s">"â</span><span style="color: #b751b6;">{1}</span><span class="ef-s">â"</span> (<span class="ef-s">"text"</span>))
        <span class="ef-cd">;; </span><span class="ef-c">private commands
</span>        (<span class="ef-s">"|{1}|"</span> (<span class="ef-s">"abs"</span>))
        (<span class="ef-s">"â{1}â"</span> (<span class="ef-s">"norm"</span>))
        (<span class="ef-s">"â{1}â"</span> (<span class="ef-s">"floor"</span>))
        (<span class="ef-s">"â{1}â"</span> (<span class="ef-s">"ceil"</span>))
        (<span class="ef-s">"â{1}â"</span> (<span class="ef-s">"round"</span>))
        (<span class="ef-s">"ð{1}/ð{2}"</span> (<span class="ef-s">"dv"</span>))
        (<span class="ef-s">"â{1}/â{2}"</span> (<span class="ef-s">"pdv"</span>))
        <span class="ef-cd">;; </span><span class="ef-c">fancification
</span>        (<span class="ef-s">"{1}"</span> (<span class="ef-s">"mathrm"</span>))
        (,(<span class="ef-k">lambda</span> (word) (string-offset-roman-chars 119743 word)) (<span class="ef-s">"mathbf"</span>))
        (,(<span class="ef-k">lambda</span> (word) (string-offset-roman-chars 119951 word)) (<span class="ef-s">"mathcal"</span>))
        (,(<span class="ef-k">lambda</span> (word) (string-offset-roman-chars 120003 word)) (<span class="ef-s">"mathfrak"</span>))
        (,(<span class="ef-k">lambda</span> (word) (string-offset-roman-chars 120055 word)) (<span class="ef-s">"mathbb"</span>))
        (,(<span class="ef-k">lambda</span> (word) (string-offset-roman-chars 120159 word)) (<span class="ef-s">"mathsf"</span>))
        (,(<span class="ef-k">lambda</span> (word) (string-offset-roman-chars 120367 word)) (<span class="ef-s">"mathtt"</span>))
        )
      TeX-fold-macro-spec-list
      '(
        <span class="ef-cd">;; </span><span class="ef-c">as the defaults
</span>        (<span class="ef-s">"[f]"</span> (<span class="ef-s">"footnote"</span> <span class="ef-s">"marginpar"</span>))
        (<span class="ef-s">"[c]"</span> (<span class="ef-s">"cite"</span>))
        (<span class="ef-s">"[l]"</span> (<span class="ef-s">"label"</span>))
        (<span class="ef-s">"[r]"</span> (<span class="ef-s">"ref"</span> <span class="ef-s">"pageref"</span> <span class="ef-s">"eqref"</span>))
        (<span class="ef-s">"[i]"</span> (<span class="ef-s">"index"</span> <span class="ef-s">"glossary"</span>))
        (<span class="ef-s">"..."</span> (<span class="ef-s">"dots"</span>))
        (<span class="ef-s">"{1}"</span> (<span class="ef-s">"emph"</span> <span class="ef-s">"textit"</span> <span class="ef-s">"textsl"</span> <span class="ef-s">"textmd"</span> <span class="ef-s">"textrm"</span> <span class="ef-s">"textsf"</span> <span class="ef-s">"texttt"</span>
                <span class="ef-s">"textbf"</span> <span class="ef-s">"textsc"</span> <span class="ef-s">"textup"</span>))
        <span class="ef-cd">;; </span><span class="ef-c">tweaked defaults
</span>        (<span class="ef-s">"Â©"</span> (<span class="ef-s">"copyright"</span>))
        (<span class="ef-s">"Â®"</span> (<span class="ef-s">"textregistered"</span>))
        (<span class="ef-s">"â¢"</span>  (<span class="ef-s">"texttrademark"</span>))
        (<span class="ef-s">"[1]:||âº"</span> (<span class="ef-s">"item"</span>))
        (<span class="ef-s">"â¡â¡â{1}"</span> (<span class="ef-s">"part"</span> <span class="ef-s">"part*"</span>))
        (<span class="ef-s">"â¡â{1}"</span> (<span class="ef-s">"chapter"</span> <span class="ef-s">"chapter*"</span>))
        (<span class="ef-s">"Â§â{1}"</span> (<span class="ef-s">"section"</span> <span class="ef-s">"section*"</span>))
        (<span class="ef-s">"Â§Â§â{1}"</span> (<span class="ef-s">"subsection"</span> <span class="ef-s">"subsection*"</span>))
        (<span class="ef-s">"Â§Â§Â§â{1}"</span> (<span class="ef-s">"subsubsection"</span> <span class="ef-s">"subsubsection*"</span>))
        (<span class="ef-s">"Â¶â{1}"</span> (<span class="ef-s">"paragraph"</span> <span class="ef-s">"paragraph*"</span>))
        (<span class="ef-s">"Â¶Â¶â{1}"</span> (<span class="ef-s">"subparagraph"</span> <span class="ef-s">"subparagraph*"</span>))
        <span class="ef-cd">;; </span><span class="ef-c">extra
</span>        (<span class="ef-s">"â¬â{1}"</span> (<span class="ef-s">"begin"</span>))
        (<span class="ef-s">"â¬â{1}"</span> (<span class="ef-s">"end"</span>))
        ))

(<span class="ef-k">defun</span> <span class="ef-f">string-offset-roman-chars</span> (offset word)
  <span class="ef-d">"Shift the codepoint of each character in WORD by OFFSET with an extra -6 shift if the letter is lowercase"</span>
  (apply 'string
         (mapcar (<span class="ef-k">lambda</span> (c)
                   (string-offset-apply-roman-char-exceptions
                    (+ (<span class="ef-k">if</span> (&gt;= c 97) (- c 6) c) offset)))
                 word)))

(<span class="ef-k">defvar</span> <span class="ef-v">string-offset-roman-char-exceptions</span>
  '(<span class="ef-cd">;; </span><span class="ef-c">lowercase serif
</span>    (119892 .  8462) <span class="ef-cd">; </span><span class="ef-c">â
</span>    <span class="ef-cd">;; </span><span class="ef-c">lowercase caligraphic
</span>    (119994 . 8495) <span class="ef-cd">; </span><span class="ef-c">â¯
</span>    (119996 . 8458) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120004 . 8500) <span class="ef-cd">; </span><span class="ef-c">â´
</span>    <span class="ef-cd">;; </span><span class="ef-c">caligraphic
</span>    (119965 . 8492) <span class="ef-cd">; </span><span class="ef-c">â¬
</span>    (119968 . 8496) <span class="ef-cd">; </span><span class="ef-c">â°
</span>    (119969 . 8497) <span class="ef-cd">; </span><span class="ef-c">â±
</span>    (119971 . 8459) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (119972 . 8464) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (119975 . 8466) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (119976 . 8499) <span class="ef-cd">; </span><span class="ef-c">â³
</span>    (119981 . 8475) <span class="ef-cd">; </span><span class="ef-c">â
</span>    <span class="ef-cd">;; </span><span class="ef-c">fraktur
</span>    (120070 . 8493) <span class="ef-cd">; </span><span class="ef-c">â­
</span>    (120075 . 8460) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120076 . 8465) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120085 . 8476) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120092 . 8488) <span class="ef-cd">; </span><span class="ef-c">â¨
</span>    <span class="ef-cd">;; </span><span class="ef-c">blackboard
</span>    (120122 . 8450) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120127 . 8461) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120133 . 8469) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120135 . 8473) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120136 . 8474) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120137 . 8477) <span class="ef-cd">; </span><span class="ef-c">â
</span>    (120145 . 8484) <span class="ef-cd">; </span><span class="ef-c">â¤
</span>    )
  <span class="ef-d">"An alist of deceptive codepoints, and then where the glyph actually resides."</span>)

(<span class="ef-k">defun</span> <span class="ef-f">string-offset-apply-roman-char-exceptions</span> (char)
  <span class="ef-d">"Sometimes the codepoint doesn't contain the char you expect.
Such special cases should be remapped to another value, as given in `</span><span style="color: #b751b6; text-decoration: italic;">string-offset-roman-char-exceptions</span><span class="ef-d">'."</span>
  (<span class="ef-k">if</span> (assoc char string-offset-roman-char-exceptions)
      (cdr (assoc char string-offset-roman-char-exceptions))
    char))

(<span class="ef-k">defun</span> <span class="ef-f">TeX-fold-parenthesize-as-necessary</span> (tokens <span class="ef-t">&amp;optional</span> suppress-left suppress-right)
  <span class="ef-d">"Add âª â« parenthesis as if multiple LaTeX tokens appear to be present"</span>
  (<span class="ef-k">if</span> (TeX-string-single-token-p tokens) tokens
    (concat (<span class="ef-k">if</span> suppress-left <span class="ef-s">""</span> <span class="ef-s">"âª"</span>)
            tokens
            (<span class="ef-k">if</span> suppress-right <span class="ef-s">""</span> <span class="ef-s">"â«"</span>))))

(<span class="ef-k">defun</span> <span class="ef-f">TeX-string-single-token-p</span> (teststring)
  <span class="ef-d">"Return t if TESTSTRING appears to be a single token, nil otherwise"</span>
  (<span class="ef-k">if</span> (string-match-p <span class="ef-s">"^\\\\?\\w+$"</span> teststring) t nil))

(<span class="ef-k">after!</span> tex
  (map!
   <span class="ef-b">:map</span> LaTeX-mode-map
   <span class="ef-b">:ei</span> [C-return] #'LaTeX-insert-item)
  (<span class="ef-k">setq</span> TeX-electric-math '(<span class="ef-s">"</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">"</span> . <span class="ef-s">""</span>)))

<span class="ef-cd">;; </span><span class="ef-c">Making \( \) less visible
</span>(<span class="ef-k">defface</span> <span class="ef-v">unimportant-latex-face</span>
  '((t <span class="ef-b">:inherit</span> font-lock-comment-face <span class="ef-b">:weight</span> extra-light))
  <span class="ef-d">"Face used to make \\(\\), \\[</span><span style="color: #b751b6; text-decoration: italic;">\\</span><span class="ef-d">] less visible."</span>
  <span class="ef-b">:group</span> 'LaTeX-math)

(font-lock-add-keywords
 'latex-mode
 `((<span class="ef-s">"\\\\[]()[]"</span> 0 'unimportant-latex-face prepend))
 'end)

<span class="ef-cd">;; </span><span class="ef-c">(font-lock-add-keywords
</span><span class="ef-cd">;;  </span><span class="ef-c">'latex-mode
</span><span class="ef-cd">;;  </span><span class="ef-c">'(("\\\\[[:word:]]+" 0 'font-lock-keyword-face prepend))
</span><span class="ef-cd">;;  </span><span class="ef-c">'end)
</span>
(<span class="ef-k">setq</span> preview-LaTeX-command '(<span class="ef-s">"%`%l \"\\nonstopmode\\nofiles\
\\PassOptionsToPackage{"</span> (<span class="ef-s">","</span> . preview-required-option-list) <span class="ef-s">"}{preview}\
\\AtBeginDocument{\\ifx\\ifPreview\\undefined"</span>
preview-default-preamble <span class="ef-s">"\\fi}\"%' \"\\detokenize{\" %t \"}\""</span>))

(<span class="ef-k">after!</span> cdlatex
  (<span class="ef-k">setq</span> cdlatex-env-alist
        '((<span class="ef-s">"bmatrix"</span> <span class="ef-s">"\\begin{bmatrix}\n?\n\\end{bmatrix}"</span> nil)
          (<span class="ef-s">"equation*"</span> <span class="ef-s">"\\begin{equation*}\n?\n\\end{equation*}"</span> nil)))
  (<span class="ef-k">setq</span> <span class="ef-cd">;; </span><span class="ef-c">cdlatex-math-symbol-prefix ?\; ;; doesn't work at the moment :(
</span>   cdlatex-math-symbol-alist
   '( <span class="ef-cd">;; </span><span class="ef-c">adding missing functions to 3rd level symbols
</span>     (?_    (<span class="ef-s">"\\downarrow"</span>  <span class="ef-s">""</span>           <span class="ef-s">"\\inf"</span>))
     (?2    (<span class="ef-s">"^2"</span>           <span class="ef-s">"\\sqrt{?}"</span>     <span class="ef-s">""</span>     ))
     (?3    (<span class="ef-s">"^3"</span>           <span class="ef-s">"\\sqrt[3]{?}"</span>  <span class="ef-s">""</span>     ))
     (?^    (<span class="ef-s">"\\uparrow"</span>    <span class="ef-s">""</span>           <span class="ef-s">"\\sup"</span>))
     (?k    (<span class="ef-s">"\\kappa"</span>      <span class="ef-s">""</span>           <span class="ef-s">"\\ker"</span>))
     (?m    (<span class="ef-s">"\\mu"</span>         <span class="ef-s">""</span>           <span class="ef-s">"\\lim"</span>))
     (?c    (<span class="ef-s">""</span>             <span class="ef-s">"\\circ"</span>     <span class="ef-s">"\\cos"</span>))
     (?d    (<span class="ef-s">"\\delta"</span>      <span class="ef-s">"\\partial"</span>  <span class="ef-s">"\\dim"</span>))
     (?D    (<span class="ef-s">"\\Delta"</span>      <span class="ef-s">"\\nabla"</span>    <span class="ef-s">"\\deg"</span>))
     <span class="ef-cd">;; </span><span class="ef-c">no idea why \Phi isnt on '</span><span style="color: #b751b6;">F</span><span class="ef-c">' in first place, \phi is on '</span><span style="color: #b751b6;">f</span><span class="ef-c">'.
</span>     (?F    (<span class="ef-s">"\\Phi"</span>))
     <span class="ef-cd">;; </span><span class="ef-c">now just convenience
</span>     (?.    (<span class="ef-s">"\\cdot"</span> <span class="ef-s">"\\dots"</span>))
     (?:    (<span class="ef-s">"\\vdots"</span> <span class="ef-s">"\\ddots"</span>))
     (?*    (<span class="ef-s">"\\times"</span> <span class="ef-s">"\\star"</span> <span class="ef-s">"\\ast"</span>)))
   cdlatex-math-modify-alist
   '( <span class="ef-cd">;; </span><span class="ef-c">my own stuff
</span>     (?B    <span class="ef-s">"\\mathbb"</span>        nil          t    nil  nil)
     (?a    <span class="ef-s">"\\abs"</span>           nil          t    nil  nil))))

(<span class="ef-k">after!</span> tex
  (add-to-list 'TeX-view-program-list '(<span class="ef-s">"Evince"</span> <span class="ef-s">"evince %o"</span>))
  (add-to-list 'TeX-view-program-selection '(output-pdf <span class="ef-s">"Evince"</span>)))

(<span class="ef-k">when</span> (&gt;= emacs-major-version 28)
  (add-hook 'latex-mode-hook #'TeX-latex-mode))

(<span class="ef-k">when</span> (<span class="ef-k">and</span> (= emacs-major-version 29) (= emacs-minor-version 4))
  (<span class="ef-k">after!</span> auctex <span class="ef-cd">; </span><span class="ef-c">See &lt;https://github.com/minad/vertico/discussions/475&gt;
</span>    (fmakunbound 'ConTeXt-mode)))

(<span class="ef-k">provide</span> '<span class="ef-o">config-latex</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg LAAS
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">laas-tex-fold-maybe</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-laas"</span> config)
(use-package! laas
  <span class="ef-b">:hook</span> (LaTeX-mode . laas-mode)
  <span class="ef-b">:config</span>
  (<span class="ef-k">defun</span> <span class="ef-f">laas-tex-fold-maybe</span> ()
    (<span class="ef-k">unless</span> (equal <span class="ef-s">"/"</span> aas-transient-snippet-key)
      (+latex-fold-last-macro-a)))
  (add-hook 'aas-post-snippet-expand-hook #'laas-tex-fold-maybe))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-laas</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">R lang
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: r-lang"</span> config)
(<span class="ef-k">after!</span> ess-r-mode
  (<span class="ef-k">appendq!</span> +ligatures-extra-symbols
            '(<span class="ef-b">:assign</span> <span class="ef-s">"âµ"</span>
              <span class="ef-b">:multiply</span> <span class="ef-s">"Ã"</span>))
  (set-ligatures! 'ess-r-mode
    <span class="ef-cd">;; </span><span class="ef-c">Functional
</span>    <span class="ef-b">:def</span> <span class="ef-s">"function"</span>
    <span class="ef-cd">;; </span><span class="ef-c">Types
</span>    <span class="ef-b">:null</span> <span class="ef-s">"NULL"</span>
    <span class="ef-b">:true</span> <span class="ef-s">"TRUE"</span>
    <span class="ef-b">:false</span> <span class="ef-s">"FALSE"</span>
    <span class="ef-b">:int</span> <span class="ef-s">"int"</span>
    <span class="ef-b">:floar</span> <span class="ef-s">"float"</span>
    <span class="ef-b">:bool</span> <span class="ef-s">"bool"</span>
    <span class="ef-cd">;; </span><span class="ef-c">Flow
</span>    <span class="ef-b">:not</span> <span class="ef-s">"!"</span>
    <span class="ef-b">:and</span> <span class="ef-s">"&amp;&amp;"</span> <span class="ef-b">:or</span> <span class="ef-s">"||"</span>
    <span class="ef-b">:for</span> <span class="ef-s">"for"</span>
    <span class="ef-b">:in</span> <span class="ef-s">"%in%"</span>
    <span class="ef-b">:return</span> <span class="ef-s">"return"</span>
    <span class="ef-cd">;; </span><span class="ef-c">Other
</span>    <span class="ef-b">:assign</span> <span class="ef-s">"&lt;-"</span>
    <span class="ef-b">:multiply</span> <span class="ef-s">"%*%"</span>))

(<span class="ef-k">provide</span> '<span class="ef-o">config-r-lang</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Julia
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"hook: julia"</span> set-hooks)
  (<span class="ef-k">with-eval-after-load</span> 'julia-mode
(confpkg-with-record '(<span class="ef-s">"load: julia"</span> load-hooks)
(add-to-list
 'julia-font-lock-keywords
 '(<span class="ef-s">"^julia&gt;"</span> 0 '(font-lock-string-face bold) prepend))

(add-hook 'julia-mode-hook #'rainbow-delimiters-mode-enable)
(<span class="ef-k">add-hook!</span> 'julia-mode-hook
  (<span class="ef-k">setq-local</span> lsp-enable-folding t
              lsp-folding-range-limit 100))

(<span class="ef-k">provide</span> '<span class="ef-o">config-julia</span>))))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">conf-data-toml
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: conf-data-toml"</span> config)
(use-package! conf-data-toml
  <span class="ef-b">:magic</span> (<span class="ef-s">"\\`data_config_version = [0-9]"</span> . conf-data-toml-mode))

(<span class="ef-k">provide</span> '<span class="ef-o">config-conf-data-toml</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg graphviz-dot-mode
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-graphviz-dot-mode"</span> config)
(use-package! graphviz-dot-mode
  <span class="ef-b">:commands</span> graphviz-dot-mode
  <span class="ef-b">:mode</span> (<span class="ef-s">"\\.dot\\'"</span> . graphviz-dot-mode)
  <span class="ef-b">:init</span>
  (<span class="ef-k">after!</span> org
    (setcdr (assoc <span class="ef-s">"dot"</span> org-src-lang-modes)
            'graphviz-dot)))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-graphviz-dot-mode</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">Markdown
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
(confpkg-with-record '(<span class="ef-s">"load: markdown"</span> config)
(<span class="ef-k">add-hook!</span> (gfm-mode markdown-mode) #'visual-line-mode #'turn-off-auto-fill)

(custom-set-faces!
  '(markdown-header-face-1 <span class="ef-b">:height</span> 1.25 <span class="ef-b">:weight</span> extra-bold <span class="ef-b">:inherit</span> markdown-header-face)
  '(markdown-header-face-2 <span class="ef-b">:height</span> 1.15 <span class="ef-b">:weight</span> bold       <span class="ef-b">:inherit</span> markdown-header-face)
  '(markdown-header-face-3 <span class="ef-b">:height</span> 1.08 <span class="ef-b">:weight</span> bold       <span class="ef-b">:inherit</span> markdown-header-face)
  '(markdown-header-face-4 <span class="ef-b">:height</span> 1.00 <span class="ef-b">:weight</span> bold       <span class="ef-b">:inherit</span> markdown-header-face)
  '(markdown-header-face-5 <span class="ef-b">:height</span> 0.90 <span class="ef-b">:weight</span> bold       <span class="ef-b">:inherit</span> markdown-header-face)
  '(markdown-header-face-6 <span class="ef-b">:height</span> 0.75 <span class="ef-b">:weight</span> extra-bold <span class="ef-b">:inherit</span> markdown-header-face))

(<span class="ef-k">provide</span> '<span class="ef-o">config-markdown</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">!Pkg Beancount
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">beancount-bal</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: pkg-beancount"</span> config)
(use-package! beancount
  <span class="ef-b">:mode</span> (<span class="ef-s">"\\.beancount\\'"</span> . beancount-mode)
  <span class="ef-b">:init</span>
  (<span class="ef-k">after!</span> nerd-icons
    (add-to-list 'nerd-icons-extension-icon-alist
                 '(<span class="ef-s">"beancount"</span> nerd-icons-faicon <span class="ef-s">"nf-fa-dollar"</span> <span class="ef-b">:face</span> nerd-icons-lblue))
    (add-to-list 'nerd-icons-mode-icon-alist
                 '(beancount-mode nerd-icons-faicon <span class="ef-s">"nf-fa-dollar"</span> <span class="ef-b">:face</span> nerd-icons-lblue)))
  <span class="ef-b">:config</span>
  (<span class="ef-k">setq</span> beancount-electric-currency t)
  (<span class="ef-k">defun</span> <span class="ef-f">beancount-bal</span> ()
    <span class="ef-d">"Run bean-report bal."</span>
    (<span class="ef-k">interactive</span>)
    (<span class="ef-k">let</span> ((compilation-read-command nil))
      (beancount--run <span class="ef-s">"bean-report"</span>
                      (file-relative-name buffer-file-name) <span class="ef-s">"bal"</span>)))
  (map! <span class="ef-b">:map</span> beancount-mode-map
        <span class="ef-b">:n</span> <span class="ef-s">"TAB"</span> #'beancount-align-to-previous-number
        <span class="ef-b">:i</span> <span class="ef-s">"RET"</span> (<span class="ef-k">cmd!</span> (newline-and-indent) (beancount-align-to-previous-number))))

(<span class="ef-k">provide</span> '<span class="ef-o">config--pkg-beancount</span>))

<span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span><span class="ef-cd">;;; </span><span class="ef-c">gimp-palette
</span><span class="ef-cd">;;</span><span class="ef-c">:------------------------
</span>
<span class="ef-cd">;; </span><span class="ef-c">This block defines `</span><span style="color: #b751b6;">gimp-palette-update-line</span><span class="ef-c">' and
</span><span class="ef-cd">;; </span><span class="ef-c">`</span><span style="color: #b751b6;">gimp-palette-update-region</span><span class="ef-c">'.
</span>
(confpkg-with-record '(<span class="ef-s">"load: gimp-palette"</span> config)
(<span class="ef-k">define-derived-mode</span> <span class="ef-f">gimp-palette-mode</span> fundamental-mode <span class="ef-s">"GIMP Palette"</span>
  <span class="ef-d">"A major mode for GIMP Palette (.gpl) files that keeps RGB and Hex colors in sync."</span>
  (<span class="ef-k">when</span> (<span class="ef-k">require</span> '<span class="ef-o">rainbow-mode</span>)
    (rainbow-mode 1))
  (<span class="ef-k">when</span> (<span class="ef-k">bound-and-true-p</span> hl-line-mode)
    (hl-line-mode -1))
  (add-hook 'after-change-functions #'gimp-palette-update-region nil t))

(<span class="ef-k">defun</span> <span class="ef-f">gimp-palette-update-region</span> (beg end <span class="ef-t">&amp;optional</span> _)
  <span class="ef-d">"Update each line between BEG and END with `</span><span style="color: #b751b6; text-decoration: italic;">gimp-palette-update-line</span><span class="ef-d">'.
If run interactively without a region set, the whole buffer is affected."</span>
  (<span class="ef-k">interactive</span>
   (<span class="ef-k">if</span> (region-active-p)
       (list (region-beginning) (region-end))
     (list (point-min) (point-max))))
  (<span class="ef-k">let</span> ((marker (prepare-change-group)))
    (<span class="ef-k">unwind-protect</span>
        (<span class="ef-k">save-excursion</span>
          (goto-char beg)
          (<span class="ef-k">while</span> (&lt; (point) end)
            (gimp-palette-update-line)
            (forward-line 1)))
      (undo-amalgamate-change-group marker))))

(<span class="ef-k">defun</span> <span class="ef-f">gimp-palette-update-line</span> ()
  <span class="ef-d">"Update the RGB and Hex colour codes on the current line.
Whichever `</span><span style="color: #b751b6; text-decoration: italic;">point</span><span class="ef-d">' is currently on is taken as the source of truth."</span>
  (<span class="ef-k">interactive</span>)
  (<span class="ef-k">let</span> ((column (current-column))
        (ipoint (point)))
    (beginning-of-line)
    (<span class="ef-k">when</span> (<span class="ef-k">and</span> (re-search-forward <span class="ef-s">"</span><span style="color: #a626a4;">\\=</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">[0-9 ]*</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">(</span><span class="ef-s">#[0-9A-Fa-f]\\{</span><span style="color: #6a1868;">6\\</span><span class="ef-s">}</span><span style="color: #4078f2; font-weight: 700;">\\</span><span style="color: #4078f2; font-weight: 700;">)</span><span class="ef-s">"</span> nil t)
               (&lt;= column (length (match-string 0))))
      (<span class="ef-k">cond</span>
       ((&gt;= column (length (match-string 1))) <span class="ef-cd">; </span><span class="ef-c">Point in #HEX
</span>        (<span class="ef-k">cl-destructuring-bind</span> (r g b) (color-name-to-rgb (match-string 2))
          (replace-match
           (format <span class="ef-s">"%3d %3d %3d "</span>
                   (round (* 255 r))
                   (round (* 255 g))
                   (round (* 255 b)))
           nil t nil 1)))
       ((string-match-p <span class="ef-s">"\\`[0-9]+ +[0-9]+ +[0-9]+\\'"</span> (match-string 1)) <span class="ef-cd">; </span><span class="ef-c">Valid R G B
</span>        (<span class="ef-k">cl-destructuring-bind</span> (r g b)
            (mapcar #'string-to-number
                    (<span class="ef-k">save-match-data</span>
                      (split-string (match-string 1) <span class="ef-s">" +"</span> t)))
          (replace-match
           (format <span class="ef-s">"%3d %3d %3d "</span> r g b)
           nil t nil 1)
          (replace-match
           (color-rgb-to-hex (/ r 255.0) (/ g 255.0) (/ b 255.0) 2)
           nil t nil 2)))))
    (goto-char ipoint)))

(add-to-list 'magic-mode-alist (cons <span class="ef-s">"\\`GIMP Palette\n"</span> #'gimp-palette-mode))

(<span class="ef-k">provide</span> '<span class="ef-o">config-gimp-palette</span>))

(confpkg-finish-record 'config)

<span class="ef-cd">;;; </span><span class="ef-c">config.el ends here</span>
</pre>
  <body>
</html>