<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>config.org.html</title>
    <style>
      body { background: #fafafa; color: #383a42; }
      pre {
        font-size: 1rem;
        max-width: min(100rem, 100%);
        width: max-content;
        white-space: pre-wrap;
        margin: auto; }
      .ef-D {
        color: #383a42; background-color: #fafafa; font-weight: 400; }
      .ef-vp {
         }
      .ef-h {
        color: #84888b; }
      .ef-sc {
        color: #50a14f; }
      .ef-w {
        color: #986801; }
      .ef-e {
        color: #e45649; }
      .ef-l {
        color: #4078f2; font-weight: 700; }
      .ef-lv {
        color: #8b008b; font-weight: 700; }
      .ef-hi {
        color: #f0f0f0; background-color: #4078f2; }
      .ef-c {
        color: #84888b; }
      .ef-cd {
        color: #84888b; }
      .ef-s {
        color: #50a14f; }
      .ef-d {
        color: #727578; text-decoration: italic; }
      .ef-m {
        color: #b751b6; }
      .ef-k {
        color: #e45649; }
      .ef-b {
        color: #a626a4; }
      .ef-f {
        color: #a626a4; }
      .ef-v {
        color: #6a1868; }
      .ef-t {
        color: #986801; }
      .ef-o {
        color: #b751b6; }
      .ef-wr {
        color: #986801; }
      .ef-nc {
        color: #4078f2; font-weight: 700; }
      .ef-pp {
        color: #4078f2; font-weight: 700; }
      .ef-rc {
        color: #4078f2; font-weight: 700; }
      .ef-rb {
        color: #4078f2; font-weight: 700; }
      .ef-ob {
        background-color: #e7e7e7; }
      .ef-obb {
        background-color: #e7e7e7; text-decoration: italic; }
      .ef-obe {
        background-color: #e7e7e7; text-decoration: italic; }
      .ef-Oa {
        color: #e45649; font-weight: nil; font-size: 1.25em }
      .ef-Ob {
        color: #da8548; font-weight: 700; font-size: 1.15em }
      .ef-Oc {
        color: #b751b6; font-weight: 700; font-size: 1.12em }
      .ef-Od {
        color: #6f99f5; font-weight: 600; font-size: 1.09em }
      .ef-Oe {
        color: #bc5cba; font-weight: 600; font-size: 1.06em }
      .ef-Of {
        color: #9fbbf8; font-weight: 600; font-size: 1.03em }
      .ef-Og {
        color: #d292d1; font-weight: 700; }
      .ef-Oh {
        color: #d8e4fc; font-weight: 600; }
      .ef-hn {
        color: #da8548; font-weight: 700; }
      .ef-hq {
        color: #4078f2; }
      .ef-hs {
        color: #986801; }
      .ef-rda {
        color: #4078f2; }
      .ef-rdb {
        color: #a626a4; }
      .ef-rdc {
        color: #50a14f; }
      .ef-rdd {
        color: #b751b6; }
      .ef-rde {
        color: #4db5bd; }
      .ef-rdf {
        color: #4078f2; }
      .ef-rdg {
        color: #a626a4; }
      .ef-rdh {
        color: #50a14f; }
      .ef-rdi {
        color: #b751b6; }
    </style>
  </head>
  <body>
<pre>
<span class="ef-c"># SPDX-FileCopyrightText: © 2020-2022 tecosaur &lt;contact@tecosaur.net&gt;</span>
<span class="ef-c"># SPDX-License-Identifier: MIT</span>
<span style="color: #84888b;">#+title:</span> <span style="font-weight: 700;">Doom Emacs Configuration
</span><span style="color: #84888b;">#+subtitle:</span> The Methods, Management, and Menagerie@@latex:\\@@ of Madness@@latex: --- in meticulous detail@@
<span style="color: #84888b;">#+author:</span> tecosaur
<span style="color: #84888b;">#+email:</span> contact@tecosaur.net
<span style="color: #84888b;">#+date:</span> @@html:&lt;!--@@{{{git-rev}}}@@html:--&gt;@@@@latex:\\\Large\bfseries@@ {{{modification-time(%Y-%m-%d, t)}}} @@latex:\\\normalsize\mdseries@@{{{modification-time(%H:%M, t)}}} @@latex:\acr{\lowercase{@@{{{timezone}}}@@latex:}}\iffalse@@, {{{git-rev}}}@@latex:\fi@@
<span style="color: #84888b;">#+macro: timezone (eval (substring (shell-command-to-string "date +%Z") 0 -1))</span>
<span style="color: #84888b;">#+macro: git-rev (eval (format "@@html:&lt;a href=\"https://code.tecosaur.net/tec/emacs-config/commit/%1$s\" style=\"text-decoration: none\"&gt;&lt;code style=\"padding: 0; color: var(--text-light); font-size: inherit; opacity: 0.7\"&gt;%1$s&lt;/code&gt;&lt;/a&gt;@@@@latex:\\href{https://code.tecosaur.net/tec/emacs-config/commit/%1$s}{\\normalsize\\texttt{%1$s}}@@" (substring (shell-command-to-string "git rev-parse --short HEAD") 0 -1)))</span>
<span style="color: #84888b;">#+html_head: &lt;link rel='shortcut icon' type='image/png' href='https://www.gnu.org/software/emacs/favicon.png'&gt;</span>
<span style="color: #84888b;">#+property: header-args:emacs-lisp</span>
<span style="color: #84888b;">#+property: header-args:elisp :results replace :exports code</span>
<span style="color: #84888b;">#+property: header-args:shell :tangle "setup.sh"</span>
<span style="color: #84888b;">#+property: header-args :tangle no :results silent :eval no-export</span>
<span style="color: #84888b;">#+embed: LICENCE :description MIT licence file</span>
<span style="color: #84888b;">#+options: coverpage:yes</span>
<span style="color: #84888b;">#+startup: fold</span>

<span style="color: #84888b;">#+latex_class: book</span>
<span style="color: #84888b;">#+latex_header_extra: \usepackage[autooneside=false,automark,headsepline]{scrlayer-scrpage}</span>
<span style="color: #84888b;">#+latex_header_extra: \clearpairofpagestyles \renewcommand*{\chaptermarkformat}{} \renewcommand*{\sectionmarkformat}{}</span>
<span style="color: #84888b;">#+latex_header_extra: \ihead{\upshape\scshape\leftmark} \chead{\Ifstr{\leftmark}{\rightmark}{}{\rightmark}} \ohead[\pagemark]{\pagemark}</span>
<span style="color: #84888b;">#+latex_engraved_theme: doom-one-light</span>

<span class="ef-obb">#+begin_export html
</span><span class="ef-ob">&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">a</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://code.tecosaur.net/tec/emacs-config/"</span>
   <span style="color: #6a1868; background-color: #e7e7e7;">style</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font-family: 'Open Sans'; background-image: none; color: inherit;
          text-decoration: none; position: relative; top: clamp(-26px, calc(1280px - 100vw), 0px); opacity: 0.7;"</span><span class="ef-ob">&gt;
  &lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">img</span> <span style="color: #6a1868; background-color: #e7e7e7;">src</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://git-scm.com/images/logos/downloads/Git-Icon-Black.svg"</span>
       <span style="color: #6a1868; background-color: #e7e7e7;">class</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"invertible"</span> <span style="color: #6a1868; background-color: #e7e7e7;">alt</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"Git"</span>
       <span style="color: #6a1868; background-color: #e7e7e7;">style</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"height: 1em; position: relative; top: 0.1em;"</span><span class="ef-ob">&gt;
  Repository&lt;/</span><span style="color: #a626a4; background-color: #e7e7e7;">a</span><span class="ef-ob">&gt;</span><span style="color: #6a1868; background-color: #e7e7e7;">&amp;ensp;</span><span class="ef-ob">
&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">a</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://liberapay.com/tec"</span>
   <span style="color: #6a1868; background-color: #e7e7e7;">style</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"position: relative;top: clamp(-22px, calc(1280px - 100vw), 0px);"</span><span class="ef-ob">&gt;
  &lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">img</span> <span style="color: #6a1868; background-color: #e7e7e7;">src</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://shields.io/badge/support%20my%20efforts-f6c915?logo=Liberapay&amp;style=flat&amp;logoColor=black"</span>
       <span style="color: #6a1868; background-color: #e7e7e7;">class</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"invertible"</span> <span style="color: #6a1868; background-color: #e7e7e7;">alt</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"Support my efforts"</span>
       <span style="color: #6a1868; background-color: #e7e7e7;">style</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"border-radius: 4px; opacity: 0.85;"</span><span class="ef-ob">&gt;&lt;/</span><span style="color: #a626a4; background-color: #e7e7e7;">a</span><span class="ef-ob">&gt;
</span><span class="ef-obe">#+end_export
</span>
<span class="ef-obb">#+begin_quote
</span>Let us change our traditional attitude to the construction of programs:
Instead of imagining that our main task is to instruct a computer what to do,
let us concentrate rather on explaining to human beings what we want a
computer to do. <span class="ef-c">@@</span><span style="font-weight: 700;">latex:</span>\mbox{<span class="ef-c">@@</span>--- Donald Knuth<span class="ef-c">@@</span><span style="font-weight: 700;">latex:</span>}<span class="ef-c">@@</span>
<span class="ef-obe">#+end_quote
</span>
<span style="color: #e45649; font-weight: nil; font-size: 1.25em">* Introduction</span>

Customising an editor can be very rewarding ... until you have to leave it.
For years I have been looking for ways to avoid this pain.
Then I discovered <span style="color: #4078f2; font-weight: 700;">[[https://github.com/cknadler/vim-anywhere][vim-anywhere]]</span>, and found that it had an Emacs companion,
<span style="color: #4078f2; font-weight: 700;">[[https://github.com/zachcurry/emacs-anywhere][emacs-anywhere]]</span>. To me, this looked most attractive.

Separately, online I have seen the following statement enough times I think it's a catchphrase
<span class="ef-obb">#+begin_quote
</span>Redditor 1: I just discovered this thing, isn't it cool. \\
Redditor 2: Oh, there's an Emacs mode for that.
<span class="ef-obe">#+end_quote
</span>
This was enough for me to install Emacs, but I soon learned there are <span style="color: #4078f2; font-weight: 700;">[[https://github.com/remacs/remacs#why-emacs][far more
compelling reasons]]</span> to keep using it.

I tried out the <span style="color: #84888b;">=spacemacs=</span> distribution a bit, but it wasn't quite to my liking.
Then I heard about <span style="color: #84888b;">=doom emacs=</span> and thought I may as well give that a try.
TLDR; it's great.

Now I've discovered the wonders of literate programming, and am becoming more
settled by the day. This is both my config, and a cautionary tale (just replace
"Linux" with "Emacs" in the comic below).

<span style="color: #4078f2; font-weight: 700;">[[xkcd:456]]</span>

<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Why Emacs?</span>

Emacs is <span style="color: #4078f2; font-weight: 700;">[[https://www.eigenbahn.com/2020/01/12/emacs-is-no-editor][not a text editor]]</span>, this is a common misnomer. It is far more apt to
describe Emacs as <span style="text-decoration: italic;">/a Lisp machine providing a generic user-centric text
manipulation environment/</span>. That's quite a mouthful.
In simpler terms one can think of Emacs as a platform for text-related
applications. It's a vague and generic definition because Emacs itself is
generic.

Good with text. How far does that go? A lot further than one initially thinks:
+ <span style="color: #4078f2; font-weight: 700;">[[https://orgmode.org/][Task planning]]</span>
+ <span style="color: #4078f2; font-weight: 700;">[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Dired.html][File management]]</span>
+ <span style="color: #4078f2; font-weight: 700;">[[https://github.com/akermu/emacs-libvterm][Terminal emulation]]</span>
+ <span style="color: #4078f2; font-weight: 700;">[[https://www.djcbsoftware.nl/code/mu/mu4e.html][Email client]]</span>
+ <span style="color: #4078f2; font-weight: 700;">[[https://www.gnu.org/software/tramp/][Remote server tool]]</span>
+ <span style="color: #4078f2; font-weight: 700;">[[https://magit.vc/][Git frontend]]</span>
+ Web <span style="color: #4078f2; font-weight: 700;">[[https://github.com/pashky/restclient.el][client]]</span>/<span style="color: #4078f2; font-weight: 700;">[[https://github.com/skeeto/emacs-web-server][server]]</span>
+ and more...

Ideally, one may use Emacs as <span style="text-decoration: italic;">/the/</span> interface to perform <span style="color: #84888b;">=input → transform →
output=</span> cycles, i.e. form a bridge between the human mind and information
manipulation.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** The enveloping editor</span>

Emacs allows one to do more in one place than any other application. Why is this
good?
+ Enables one to complete tasks with a consistent, standard set of keybindings,
  GUI and editing methods --- learn once, use everywhere
+ Reduced context-switching
+ Compressing the stages of a project --- a more centralised workflow can progress
  with greater ease
+ Integration between tasks previously relegated to different applications, but
  with a common subject --- e.g. linking to an email in a to-do list

Emacs can be thought of as a platform within which various elements of your
workflow may settle, with the potential for rich integrations between them --- a
<span style="text-decoration: italic;">/life/</span> IDE if you will.

Today, many aspects of daily computer usage are split between different
applications which act like islands, but this often doesn't mirror how we
<span style="text-decoration: italic;">/actually use/</span> our computers. Emacs, if one goes down the rabbit hole, can give
users the power to bridge this gap.

<span style="color: #84888b;">#+name: emacs-platform</span>
<span class="ef-obb">#+begin_src dot :cmd circo :file misc/emacs-platform.svg :exports none
</span><span class="ef-ob">digraph {
    graph [bgcolor="transparent"];
    node  [shape="underline" penwidth="2" style="rounded,filled" fillcolor="#efefef" color="#c9c9c9" fontcolor="#000000" fontname="overpass"];
    edge  [arrowhead=none color="#aaaaaa" penwidth="1.2"]
    // nodes
    "Task Managment" [color="#2ec27e"]
    "Email" [color="#1c71d8"]
    "Office suite" [color="#813d9c"]
    "Code editor" [color="#f5c211"]
    "Git client" [color="#e66100"]
    // "News feed" [color="#c01c28"]
    // "Personal Knowledge Base" [color="#986a44"]

    "Task Managment" -&gt; "Email"
    "Task Managment" -&gt; "Office suite"
    "Task Managment" -&gt; "Code editor"
    "Task Managment" -&gt; "Git client"
    // "Task Managment" -&gt; "News feed"
    // "Task Managment" -&gt; "Personal Knowledge Base"

    "Email" -&gt; "Office suite"
    "Email" -&gt; "Code editor"
    "Email" -&gt; "Git client"
    // "Email" -&gt; "Personal Knowledge Base"

    "Office suite" -&gt; "Code editor"
    "Office suite" -&gt; "Git client"
    // "Office suite" -&gt; "News feed"
    // "Office suite" -&gt; "Personal Knowledge Base"

    "Code editor" -&gt; "Git client"

    // "News feed" -&gt; "Personal Knowledge Base"
}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+caption:</span> <span class="ef-ob">Some sample workflow integrations that can be used within Emacs</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt Graph of possible Emacs task integrations :style max-width:min(24em,100%)</span>
<span style="color: #84888b;">#+attr_latex: :width 0.55\linewidth</span>
<span style="color: #4078f2; font-weight: 700;">[[file:misc/emacs-platform.svg]]</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Some notably unique features</span>

+ Recursive editing
+ Completely introspectable, with pervasive docstrings
+ Mutable environment, which can be incrementally modified
+ Functionality without applications
+ Client-server separation allows for a daemon, giving near-instant perceived
  startup time.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Issues</span>

+ Emacs has irritating quirks
+ Some aspects are showing their age (naming conventions, APIs)
+ Emacs is (<span style="color: #4078f2; font-weight: 700;">[[https://www.gnu.org/software/emacs/manual/html_node/elisp/Threads.html][mostly]]</span>) single-threaded, meaning that when something holds that
  thread up the whole application freezes
+ A few other nuisances

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Teach a man to fish...</span>

<span class="ef-obb">#+begin_quote
</span>Give a man a fish, and you feed him for a day. Teach a man to fish, and you feed
him for a lifetime. --- Anne Isabella
<span class="ef-obe">#+end_quote
</span>
Most popular editors have a simple and pretty <span style="color: #4078f2; font-weight: 700;">[[https://code.visualstudio.com/docs/getstarted/settings][settings interface]]</span>, filled with
check-boxes, selects, and the occasional text-box. This makes it easy for the
user to pick between common desirable behaviours. To me this is now like <span style="text-decoration: italic;">/giving
a man a fish/</span>.

What if you want one of those 'check-box' settings to be only on in certain
conditions? Some editors have workspace settings, but that requires you to
manually set the value for <span style="text-decoration: italic;">/every single instance/</span>. Urgh, <span style="color: #4078f2; font-weight: 700;">[[https://github.com/microsoft/vscode/issues/93153][what]]</span> <span style="color: #4078f2; font-weight: 700;">[[https://github.com/microsoft/vscode/issues/93628][a]]</span> <span style="color: #4078f2; font-weight: 700;">[[https://github.com/microsoft/vscode/issues/5595][pain]]</span>.

What if you could set the value of that 'check-box' setting to be the result of
an arbitrary expression evaluated for each file? This is where an editor like
Emacs comes in.
Configuration for Emacs isn't a list of settings in JSON etc. it's <span style="font-weight: 700;">*an executable
program which modifies the behaviour of the editor to suit your liking*</span>.
This is 'teaching a man to fish'.

Emacs is built in the same language you configure it in (Emacs <span style="color: #4078f2; font-weight: 700;">[[https://en.wikipedia.org/wiki/Lisp_(programming_language)][Lisp]]</span>, or <span style="color: #4078f2; font-weight: 700;">[[https://www.gnu.org/software/emacs/manual/html_node/eintr/][elisp]]</span>).
It comes with a broad array of useful functions for text-editing, and Doom adds
a few handy little convenience functions.

Want to add a keybinding to delete the previous line? It's as easy as
<span style="color: #84888b;">#+name: Keybinding to delete the previous line</span>
<span class="ef-obb">#+begin_src emacs-lisp :tangle no
</span><span class="ef-ob">(map! </span><span style="color: #50a14f; background-color: #e7e7e7;">"C-d"</span><span class="ef-ob">
      (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (previous-line)
            (kill-line)
            (forward-line)))
</span><span class="ef-obe">#+end_src
</span>
How about another example, say you want to be presented with a list of currently
open <span style="text-decoration: italic;">/buffers/</span> (think files, almost) when you split the window. It's as simple as
<span style="color: #84888b;">#+name: Prompt for buffer after split</span>
<span class="ef-obb">#+begin_src emacs-lisp :tangle no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> prompt-for-buffer (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> _)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> 'window-split (switch-to-buffer))
</span><span class="ef-obe">#+end_src
</span>
Want to test it out? You don't need to save and restart, you can just <span style="text-decoration: italic;">/evaluate
the expression/</span> within your current Emacs instance and try it immediately! This
editor is, after all, a Lisp interpreter.

Want to tweak the behaviour? Just re-evaluate your new version --- it's a
super-tight iteration loop.

<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Editor comparison</span>

<span style="color: #4078f2; font-weight: 700;">[[xkcd:378]]</span>

Over the years I have tried out (spent at least a year using as my primary
editor) the following applications
- Python IDLE
- Komodo Edit
- Brackets
- VSCode
- and now, Emacs

I have attempted to quantify aspects of my impressions of them below.

<span style="color: #84888b;">#+plot: transpose:yes type:radar min:0 max:4 ticks:4 file:"misc/editor-comparison.svg"</span>
| Editor      | Extensibility | Ecosystem | Ease of Use | Comfort | Completion | Performance |
|-------------+---------------+-----------+-------------+---------+------------+-------------|
| IDLE        |             1 |         1 |           3 |       1 |          1 |           2 |
| VSCode      |             3 |         3 |           4 |     3.5 |          4 |           3 |
| Brackets    |           2.5 |         2 |           3 |       3 |        2.5 |           2 |
| Emacs       |             4 |         4 |           2 |       4 |        3.5 |           3 |
| Komodo Edit |             2 |         1 |           3 |       2 |          2 |           2 |

<span style="color: #84888b;">#+attr_html: :class invertible :alt Radar chart comparing my thoughts on a few editors.</span>
<span style="color: #84888b;">#+attr_latex: :options inkscapelatex=false</span>
<span style="color: #4078f2; font-weight: 700;">[[file:misc/editor-comparison.svg]]</span>

<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Notes for the unwary adventurer</span>

If you like the look of this, that's marvellous, and I'm really happy that I've
made something which you may find interesting, however:
<span class="ef-obb">#+begin_warning
</span>This config is <span style="text-decoration: italic;">/insidious/</span>. Copying the whole thing blindly can easily lead to
undesired effects. I recommend copying chunks instead.
<span class="ef-obe">#+end_warning
</span>
If you are so bold as to wish to steal bits of my config (or if I upgrade and
wonder why things aren't working), here's a list of sections which rely on
external setup (i.e. outside of this config).

+ <span style="font-weight: 700;">dictionary ::</span> I've downloaded a custom <span style="color: #4078f2; font-weight: 700;">[[http://app.aspell.net/create][SCOWL]]</span> dictionary, which I use in <span style="color: #4078f2; font-weight: 700;">[[*Ispell][ispell]]</span>.
  If this causes issues, just delete the <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> ispell-dictionary ...)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>
  bit.

There are also a number of files I may tangle to <span style="text-decoration: italic;">/other than/</span>
<span style="color: #84888b;">={init,config,package}.el=</span>. The complete list (excluding confpkg generated files)
is as follows:

<span class="ef-obb">#+begin_src emacs-lisp :results value list replace :exports results :eval yes
</span><span class="ef-ob">(mapcar
 (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (path)
   (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"=%s="</span><span class="ef-ob">
           (replace-regexp-in-string
            (regexp-quote (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"HOME"</span><span class="ef-ob">)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"~"</span><span class="ef-ob">
            (expand-file-name path default-directory))))
 (sort
  (cl-remove-if
   (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (path)
     (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (member path '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"yes"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob">))
         (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"^/tmp"</span><span class="ef-ob"> path)))
   (cl-delete-duplicates
    (org-element-map (org-element-parse-buffer)
        'src-block
      (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (src)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((dest (alist-get </span><span style="color: #a626a4; background-color: #e7e7e7;">:tangle</span><span class="ef-ob">
                               (org-babel-parse-header-arguments
                                (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parameters</span><span class="ef-ob"> src) t))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (stringp dest) (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"^(if"</span><span class="ef-ob"> dest))
              (car (cl-set-difference
                    (mapcar #'eval (seq-drop (read dest) 2))
                    '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"yes"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob">)
                    </span><span style="color: #a626a4; background-color: #e7e7e7;">:test</span><span class="ef-ob"> #'equal))
            dest))))
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:test</span><span class="ef-ob"> #'equal))
  #'string&lt;))
</span><span class="ef-obe">#+end_src
</span>
Oh, did I mention that I started this config when I didn't know any <span style="color: #84888b;">=elisp=</span>, and
this whole thing is a hack job? If you can suggest any improvements, please do
so, no matter how much criticism you include I'll appreciate it :)

<span style="color: #4078f2; font-weight: 700;">[[xkcd:1513]]</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Extra Requirements</span>

The lovely <span style="color: #84888b;">~doom doctor~</span> is good at diagnosing most missing things, but here are a
few extras.
+ A <span style="color: #4078f2; font-weight: 700;">[[https://www.tug.org/texlive/][LaTeX Compiler]]</span> is required for the mathematics rendering performed in <span style="color: #4078f2; font-weight: 700;">[[#org][Org]]</span>,
  and by <span style="color: #4078f2; font-weight: 700;">[[*CalcTeX][CalcTeX]]</span>.
+ I use the <span style="color: #4078f2; font-weight: 700;">[[https://overpassfont.org/][Overpass]]</span> font as a go-to sans serif.
  It's used as my <span style="color: #84888b;">~doom-variable-pitch-font~</span> and in the graph generated
  by <span style="color: #4078f2; font-weight: 700;">[[*Roam][Roam]]</span>.
  I have chosen it because it possesses a few characteristics I consider
  desirable, namely:
  - A clean, and legible style. Highway-style fonts tend to be designed to be
    clear at a glance, and work well with a thicker weight, and this is inspired
    by <span style="text-decoration: italic;">/Highway Gothic/</span>.
  - It's slightly quirky. Look at the diagonal cut on stems for example.
    Helvetica is a masterful design, but I like a bit more pizzazz now and then.
+ A few LSP servers. Take a look at <span style="color: #4078f2; font-weight: 700;">[[file:init.el][init.el]]</span> to see which modules have the <span style="color: #84888b;">~+lsp~</span> flag.

<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Current Issues</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Magit push in daemon</span>

Quite often trying to push to a remote in the Emacs daemon produces as error like this:

<span class="ef-obb">#+begin_example
</span><span class="ef-ob">128 git … push -v origin refs/heads/master\:refs/heads/master
Pushing to git@github.com:tecosaur/emacs-config.git

fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
</span><span class="ef-obe">#+end_example
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Unread emails doesn't work across Emacs instances</span>

It would be nice if it did, so that I could have the Emacs-daemon hold the
active mu4e session, but still get that information. In this case I'd want to
change the action to open the Emacs daemon, but it should be possible.

This would probably involve hooking into the daemon's modeline update function
to write to a temporary file, and having a file watcher started in other Emacs
instances, in a similar manner to <span style="color: #4078f2; font-weight: 700;">[[*Rebuild mail index while using mu4e][Rebuild mail index while using mu4e]]</span>.

<span style="color: #e45649; font-weight: nil; font-size: 1.25em">* Rudimentary configuration</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Confpkg</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Motivation</span>

Previously, all of my configuration was directly tangled into <span style="color: #84888b;">=config.el=</span>. This
<span style="text-decoration: italic;">/almost/</span> satisfies my use. Occasionally though, I'd want to apply or extract a
<span style="text-decoration: italic;">/specific bit/</span> of my config in an elisp script, such as some of my Org-export
customisations. This is a hassle, either loading my entire config (of which 90%
simply complicates the state), or manually copying the relevant code in pieces,
one source block at a time (just a different kind of hassle). While I'd like to
think my config is "greater than the sum of its parts", much of it can be safely
clumped into self-contained packets of functionality.

One afternoon I thought "wouldn't it be nice if I could just load a few of those
self-contained chunks of my config", then I started thinking about how I could
have that <span style="text-decoration: italic;">/and/</span> <span style="color: #84888b;">=config.el=</span>. This is the result.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Design</span>

It's already natural to organise blocks of config under sections, and we can use
<span style="color: #84888b;">=:noweb-ref=</span> with a <span style="color: #84888b;">=header-args:emacs-lisp=</span> property to direct all child source
blocks into a single parent. We could have two parents, one tangling to
<span style="color: #84888b;">=subconf/config-X.el=</span> and the other to <span style="color: #84888b;">=config.el=</span>, however this will duplicate
any evaluations required to generate the content, which isn't great
(particularly for things which take a moment, like checking for LaTeX
packages). Instead we can <span style="text-decoration: italic;">/just/</span> write to the <span style="color: #84888b;">=subconf/*=</span> files and then at the
end of tangling extract their contents into <span style="color: #84888b;">=config.el=</span>.

<span class="ef-obb">#+begin_src dot :file misc/confpkg.svg :results file graphics
</span><span class="ef-ob">digraph {
    graph [bgcolor="transparent"];
    node  [shape="underline" penwidth="2" style="rounded,filled" fillcolor="#efefef" color="#c9c9c9" fontcolor="#000000" fontname="Alegreya Sans"];
    edge  [color="#aaaaaa" penwidth="1.2" fontname="Alegreya Sans"]
    rankdir="LR"
    "config.org" [color="#4db5bd"]
    "config.el" [color="#e69055"]
    node[color="#a991f1"]
    "subconf/config-magit.el"
    "subconf/config-org.el"
    "subconf/config-?.el"
    node[color="#51afef"]
    "config.org" -&gt; "Magit#src1" -&gt; "subconf/config-magit.el" -&gt; "config.el"
    "config.org" -&gt; "Magit#src2" -&gt; "subconf/config-magit.el"
    "config.org" -&gt; "Org#src1" -&gt; "subconf/config-org.el" -&gt; "config.el"
    "config.org" -&gt; "Org#src2" -&gt; "subconf/config-org.el"
    "config.org" -&gt; "Org#..." -&gt; "subconf/config-org.el"
    "config.org" -&gt; "(etc.)#..." -&gt; "subconf/config-?.el" -&gt; "config.el"
}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+caption:</span> <span class="ef-ob">Flow of code information from the literate config into the generated files.</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt DAG showing code block info go to config-*.el files then config.el</span>
<span style="color: #84888b;">#+attr_latex: :width 0.7\linewidth</span>
<span style="color: #84888b;">#+RESULTS:</span>
<span style="color: #4078f2; font-weight: 700;">[[file:misc/confpkg.svg]]</span>

To set this up within each section, instead of manually repeating a common form
we can generate the form and supply the relevant section properties via a babel
call keyword, like so:

<span class="ef-obb">#+begin_src org
</span><span class="ef-ob">,* Subject

,#+call: confpkg("subject")

,#+begin_src emacs-lisp
;; Code that configures the subject...
,#+end_src
</span><span class="ef-obe">#+end_src
</span>
This isn't entirely straightforward, but with some mild abuse of noweb and babel
we can make it work!

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Preparation</span>

This approach is built around <span style="color: #84888b;">=#+call=</span> invocations that affect the tangling.
Unfortunately for this use-case, babel call keywords are not executed on tangle.
Tangled noweb blocks <span style="text-decoration: italic;">/are/</span> however, and so we can fudge the behaviour we want by
tangling a noweb block to a temp file, with a noweb block that executes babel
calls in the buffer.

<span style="color: #84888b;">#+name: confpkg-prepare</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">condition-case</span><span class="ef-ob"> nil
    (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Intitialising confpkg"</span><span class="ef-ob">)
      &lt;&lt;bootstrap&gt;&gt;
      (</span><span style="color: #e45649; background-color: #e7e7e7;">org-fold-core-ignore-fragility-checks</span><span class="ef-ob">
        (</span><span style="color: #e45649; background-color: #e7e7e7;">org-babel-map-executables</span><span class="ef-ob"> nil
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq (org-element-type (org-element-context)) 'babel-call)
            (org-babel-lob-execute-maybe)))))
  (quit (revert-buffer t t t)))
</span><span class="ef-obe">#+end_src
</span>
See the <span style="color: #4078f2; font-weight: 700;">[[Bootstrap]]</span> section for an explanation of the <span style="color: #84888b;">=</span><span style="color: #84888b;">&lt;&lt;bootstrap&gt;&gt;</span><span style="color: #84888b;">=</span> noweb reference.

<span style="color: #84888b;">#+header: :tangle (expand-file-name (make-temp-name "emacs-org-babel-excuses/confpkg-prepare-") temporary-file-directory)</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :mkdirp yes :export-embed no
</span><span class="ef-ob">&lt;&lt;confpkg-prepare()&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Setup</span>

Before generating the template with babel, we want to keep track of:
+ How many config groups are created
+ Information about each config group

To do this we can simply create two variables. Due to temp-buffer shenanigans,
we'll have to use global variables here.

Then we need to set up the two final phases of this process:
+ Creating <span style="color: #84888b;">=config.el=</span>
+ Cleaning up the superfluous generated content

To trigger the final phases we'll add a hook to <span style="color: #84888b;">~org-babel-post-tangle-hook~</span>. Once
again, it would be preferred if this was done locally, but it needs to be
global. To avoid this causing headaches down the line we'll make sure when
implementing the hook function to have it remove itself from the hook when
executed.

<span style="color: #84888b;">#+name: confpkg-setup</span>
<span class="ef-obb">#+begin_src emacs-lisp :results silent :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> confpkg--num 0
      confpkg--list nil)

&lt;&lt;confpkg-dependency-analysis&gt;&gt;
&lt;&lt;confpkg-strip-package-statements&gt;&gt;
&lt;&lt;confpkg-create-config&gt;&gt;
(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-cleanup</span><span class="ef-ob"> ()
 &lt;&lt;confpkg-cleanup&gt;&gt;
  )
&lt;&lt;confpkg-finaliser&gt;&gt;

&lt;&lt;confpkg-clear-old-files&gt;&gt;

(add-hook 'org-babel-tangle-finished-hook #'confpkg-tangle-finalise)
</span><span class="ef-obe">#+end_src
</span>
To avoid generating cruft, it would also be good to get rid of old tangled
config files at the start.

<span style="color: #84888b;">#+name: confpkg-clear-old-files</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(make-directory </span><span style="color: #50a14f; background-color: #e7e7e7;">"subconf"</span><span class="ef-ob"> t)
(</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (conf-file (directory-files </span><span style="color: #50a14f; background-color: #e7e7e7;">"subconf"</span><span class="ef-ob"> t </span><span style="color: #50a14f; background-color: #e7e7e7;">"config-.*\\.el"</span><span class="ef-ob">))
  (delete-file conf-file))
</span><span class="ef-obe">#+end_src
</span>
Now to have this take effect, we can just use a babel call keyword. Thanks to
the preparation step this will be executed during tangling.

<span style="color: #84888b;">#+call: confpkg-setup[:results none]()</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Package generation</span>

Now we actually implement the <span style="color: #84888b;">=confpkg=</span> babel function. We could just direct the
output into the <span style="color: #84888b;">=subconf/config-X.el=</span> file without any extra steps, but why not be
a bit fancier and make it more like a package.

To do this, we'll have <span style="color: #84888b;">=confpkg=</span> load a template and then fill it in using
<span style="color: #84888b;">~format-spec~</span>. To make sure this is actually used, we'll call <span style="color: #84888b;">~org-set-property~</span> to
modify the parent heading, and register the config group with the variables we
created earlier.

<span style="color: #84888b;">#+name: confpkg</span>
<span class="ef-obb">#+begin_src elisp :var name="" needs="" after="" pre="" prefix="config-" via="copy" emacs-minimum="29.1" :results silent raw :noweb no-export
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Babel block for use with #+call
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Arguments:
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">- name, the name of the config sub-package
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">- needs, (when non-empty) required system executable(s)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">- after, required features as a string or vector of strings
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">- pre, a noweb reference to code that should be executed eagerly,
</span><span style="color: #84888b; background-color: #e7e7e7;">;;    </span><span style="color: #84888b; background-color: #e7e7e7;">and not deferred via after. The code is not included in the
</span><span style="color: #84888b; background-color: #e7e7e7;">;;    </span><span style="color: #84888b; background-color: #e7e7e7;">generated .el file and should only be used in dire situations.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">- prefix, the package prefix ("config-" by default)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">- via, how this configuration should be included in config.el,
</span><span style="color: #84888b; background-color: #e7e7e7;">;;    </span><span style="color: #84888b; background-color: #e7e7e7;">the current options are:
</span><span style="color: #84888b; background-color: #e7e7e7;">;;    </span><span style="color: #84888b; background-color: #e7e7e7;">+ "copy", copy the configuration lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;;    </span><span style="color: #84888b; background-color: #e7e7e7;">+ "require", insert a require statement
</span><span style="color: #84888b; background-color: #e7e7e7;">;;    </span><span style="color: #84888b; background-color: #e7e7e7;">+ "none", do not do anything to load this configuration.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;      </span><span style="color: #84888b; background-color: #e7e7e7;">This only makes sense when configuration is either being
</span><span style="color: #84888b; background-color: #e7e7e7;">;;      </span><span style="color: #84888b; background-color: #e7e7e7;">temporarily disabled or loaded indirectly/elsewhere.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">- emacs-minimum, the minimum emacs version ("29.1" by default)
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (string-empty-p needs)
          (cl-every #'executable-find (delq nil (split-string needs </span><span style="color: #50a14f; background-color: #e7e7e7;">","</span><span class="ef-ob">))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((name (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-empty-p name)
                   (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
                     (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (org-back-to-heading-or-point-min t)
                          (substring-no-properties
                           (org-element-interpret-data
                            (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob"> (org-element-at-point))))))
                 name))
         (after
          (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
           ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (stringp after) (string-empty-p after)) nil)
           ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (stringp after) (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">()]+\\'"</span><span class="ef-ob"> after))
            (intern after)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Single feature.
</span><span class="ef-ob">           ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (vectorp after) (cl-every #'stringp after))
            (nconc (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:and</span><span class="ef-ob">) (mapcar #'intern after)))
           (t nil)))
         (pre (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (string-empty-p pre)) pre))
         (confpkg-name
          (concat prefix (replace-regexp-in-string
                          </span><span style="color: #50a14f; background-color: #e7e7e7;">"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">a-z-]"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob"> (downcase name))))
         (confpkg-file (expand-file-name (concat confpkg-name </span><span style="color: #50a14f; background-color: #e7e7e7;">".el"</span><span class="ef-ob">)
                                         </span><span style="color: #50a14f; background-color: #e7e7e7;">"subconf"</span><span class="ef-ob">)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p confpkg-file)
      (make-empty-file confpkg-file t))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> confpkg--num)
    (org-set-property
     </span><span style="color: #50a14f; background-color: #e7e7e7;">"header-args:emacs-lisp"</span><span class="ef-ob">
     (format </span><span style="color: #50a14f; background-color: #e7e7e7;">":tangle no :noweb-ref %s :noweb-sep \"\\n\\n\""</span><span class="ef-ob"> confpkg-name))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob"> name
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:package</span><span class="ef-ob"> confpkg-name
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> confpkg-file
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> after
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:pre</span><span class="ef-ob"> pre
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:via</span><span class="ef-ob"> (intern via)
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:package-statements</span><span class="ef-ob"> nil)
          confpkg--list)
    (format-spec
     </span><span style="color: #50a14f; background-color: #e7e7e7;">"#+begin_src emacs-lisp :tangle %f :mkdirp yes :noweb no-export :noweb-ref none :comments no
&lt;&lt;confpkg-template&gt;&gt;
,#+end_src"</span><span class="ef-ob">
     `((?n . ,confpkg--num)
       (?p . ,confpkg-name)
       (?f . ,confpkg-file)
       (?e . ,emacs-minimum)
       (?Y . ,(format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%Y"</span><span class="ef-ob">))
       (?B . ,(format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%B"</span><span class="ef-ob">))
       (?m . ,(format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%m"</span><span class="ef-ob">))
       (?d . ,(format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%d"</span><span class="ef-ob">))
       (?M . ,(format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%M"</span><span class="ef-ob">))
       (?S . ,(format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%S"</span><span class="ef-ob">))))))
</span><span class="ef-obe">#+end_src
</span>
Now all that's needed is a template to be used.

<span style="color: #84888b;">#+name: confpkg-template</span>
<span class="ef-obb">#+begin_src emacs-lisp :eval no
</span><span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">%p.el --- Generated package (no.%n) from my config -*- lexical-binding: t; -*-
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Copyright (C) %Y TEC
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Author: TEC &lt;https://code.tecosaur.net/tec&gt;
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Maintainer: TEC &lt;contact@tecosaur.net&gt;
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Created: %B %d, %Y
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Modified: %B %d, %Y
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Version: %Y.%m.%d
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Homepage: https://code.tecosaur.net/tec/emacs-config
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Package-Requires: ((emacs \"%e\"))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">This file is not part of GNU Emacs.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">Commentary:
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">Generated package (no.%n) from my config.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">During generation, dependency on other aspects of my configuration and
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">packages is inferred via (regexp-based) static analysis.  While this seems
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">to do a good job, this method is imperfect.  This code likely depends on
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">utilities provided by Doom, and if you try to run it in isolation you may
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">discover the code makes more assumptions.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">That said, I've found pretty good results so far.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">Code:
</span><span class="ef-ob">
&lt;&lt;%p&gt;&gt;

(</span><span style="color: #e45649; background-color: #e7e7e7;">provide</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">%p</span><span class="ef-ob">)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">%p.el ends here
</span><span class="ef-obe">#+end_src
</span>
This currently makes the included content look much more package-like that in
truly is. However, I hope that some static analysis in future will allow for
dependency information to be collected and included.

Lastly, should there be an issue or interruption, it's possible that the
modifications from <span style="color: #84888b;">=#+call: confpkg=</span> may persist. If I've been good with my
committing, resolving this should be as simple as reverting unstaged changes.
So... back in reality, it would be nice to have a way to clean up <span style="color: #84888b;">=confpkg=</span>
residue.

<span style="color: #84888b;">#+name: confpkg-cleanup</span>
<span class="ef-obb">#+begin_src emacs-lisp :results none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">org-fold-core-ignore-fragility-checks</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">org-babel-map-executables</span><span class="ef-ob"> nil
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (eq (org-element-type (org-element-context)) 'babel-call)
               (equal (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:call</span><span class="ef-ob"> (org-element-context)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"confpkg"</span><span class="ef-ob">))
      (org-babel-remove-result)
      (org-entry-delete nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"header-args:emacs-lisp"</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Identify cross-package dependencies</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :noweb-ref confpkg-dependency-analysis
<span style="font-weight: 700;">:END:</span>

At a basic level, we can search for regexp expressions indicating the definition
of functions or variables and search for their usage.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg--rough-extract-definitions</span><span class="ef-ob"> (file)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
    (insert-file-contents file)
    (goto-char (point-min))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (symbols)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward
              (</span><span style="color: #e45649; background-color: #e7e7e7;">rx</span><span class="ef-ob"> line-start (* (any ?\s ?\t)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"("</span><span class="ef-ob">
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defun"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defmacro"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defsubst"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defgeneric"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defalias"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defvar"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defcustom"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"defface"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"deftheme"</span>
                      <span style="color: #50a14f; background-color: #e7e7e7;">"cl-defun"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cl-defmacro"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cl-defsubst"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cl-defmethod"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cl-defstruct"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cl-defgeneric"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cl-deftype"</span><span class="ef-ob">)
                  (+ (any ?\s ?\t))
                  (group (+ (any </span><span style="color: #50a14f; background-color: #e7e7e7;">"A-Z"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"a-z"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"0-9"</span><span class="ef-ob">
                                 ?+ ?- ?* ?/ ?_ ?~ ?! ?@ ?$ ?% ?^ ?&amp; ?= ?: ?&lt; ?&gt; ?{ ?})))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> blank ?\n))
              nil t)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (match-string 1) symbols))
      symbols)))
</span><span class="ef-obe">#+end_src
</span>
Continuing our rough regexp approach, we can construct a similar function to
look for uses of symbols.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg--rough-uses-p</span><span class="ef-ob"> (file symbols)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
    (insert-file-contents file)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((symbols (copy-sequence symbols)) uses-p)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> symbols
        (goto-char (point-min))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (re-search-forward (</span><span style="color: #e45649; background-color: #e7e7e7;">rx</span><span class="ef-ob"> word-start (literal (car symbols)) word-end) nil t)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> uses-p t symbols nil)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> symbols (cdr symbols))))
      uses-p)))
</span><span class="ef-obe">#+end_src
</span>
Now we can put these two functions together to annotate <span style="color: #84888b;">~confpkg--list~</span> with their
(confpkg) dependencies.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-annotate-list-dependencies</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (confpkg confpkg--list)
    (plist-put confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:defines</span><span class="ef-ob">
               (confpkg--rough-extract-definitions
                (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (confpkg confpkg--list)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((after (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob">))
          requires)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (other-confpkg confpkg--list)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (eq other-confpkg confpkg))
                   (confpkg--rough-uses-p (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">)
                                          (plist-get other-confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:defines</span><span class="ef-ob">)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (plist-get other-confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:package</span><span class="ef-ob">) requires)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> after (symbolp after))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> after requires))
      (plist-put confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> requires))))
</span><span class="ef-obe">#+end_src
</span>
Finally, we can use this information to edit the confpkg files to add the
necessary <span style="color: #84888b;">~require~</span> statements.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-write-dependencies</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (confpkg confpkg--list)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob">)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> buffer-file-name (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">))
        (insert-file-contents buffer-file-name)
        (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^;;; Code:\n"</span><span class="ef-ob">)
        (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (req (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob">))
          (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"(require '%s)\n"</span><span class="ef-ob"> req)))
        (write-region nil nil buffer-file-name)
        (set-buffer-modified-p nil)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Commenting out </span><span style="color: #84888b; font-weight: 700; font-size: 1.12em">~package!~</span><span style="color: #b751b6; font-weight: 700; font-size: 1.12em"> statements</span>

It's easy enough to set <span style="color: #84888b;">~package!~</span> statements to tangle to <span style="color: #84888b;">=packages.el=</span>, however
with our noweb ref approach they will <span style="text-decoration: italic;">/also/</span> go to the config files. This could be
viewed as a problem, but I actually think it's rather nice to have the package
information with the config. So, we can look for an immediate <span style="color: #84888b;">~package!~</span> statement
and simply comment it out. As a bonus, we can also then record which packages
are needed for each block of config.

<span style="color: #84888b;">#+name: confpkg-strip-package-statements</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-comment-out-package-statements</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (confpkg confpkg--list)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> buffer-file-name (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">))
      (insert-file-contents buffer-file-name)
      (goto-char (point-min))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^;;; Code:\n[[:space:]\n]*(</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">package!</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">unpin!</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">[[:space:]\n]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">[:space:]]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">\\b"</span><span class="ef-ob"> nil t)
        (plist-put confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:package-statements</span><span class="ef-ob">
                   (nconc (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:package-statements</span><span class="ef-ob">)
                          (list (match-string 2))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((start (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob"> (beginning-of-line) (point)))
               (end (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob"> (forward-sexp 1)
                           (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (looking-at </span><span style="color: #50a14f; background-color: #e7e7e7;">"[\t ]*;.*"</span><span class="ef-ob">)
                               (line-end-position)
                             (point))))
               (contents (buffer-substring start end))
               paste-start paste-end
               (comment-start </span><span style="color: #50a14f; background-color: #e7e7e7;">";"</span><span class="ef-ob">)
               (comment-padding </span><span style="color: #50a14f; background-color: #e7e7e7;">"   "</span><span class="ef-ob">)
               (comment-end </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
          (delete-region start (1+ end))
          (re-search-backward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^;;; Code:"</span><span class="ef-ob">)
          (beginning-of-line)
          (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">";;  Package statement:\n"</span><span class="ef-ob">)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> paste-start (point))
          (insert contents)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> paste-end (point))
          (insert  </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n;;\n"</span><span class="ef-ob">)
          (comment-region paste-start paste-end 2)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (buffer-modified-p)
        (write-region nil nil buffer-file-name)
        (set-buffer-modified-p nil)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Creating the config file</span>

After all the subconfig files have been tangled, we need to collect their
content and put them together into <span style="color: #84888b;">=config.el=</span>. For this, all that's needed is a
function to go through the registered config groups and put their content in a
tempbuffer. We can call this with the finalising step.

<span style="color: #84888b;">#+name: confpkg-create-config</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-create-config</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((revert-without-query '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"config\\.el"</span><span class="ef-ob">))
        (keywords (org-collect-keywords '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"AUTHOR"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"EMAIL"</span><span class="ef-ob">)))
        (original-buffer (current-buffer)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
      (insert
       (format </span><span style="color: #50a14f; background-color: #e7e7e7;">";;; config.el -*- lexical-binding: t; -*-

;; SPDX-FileCopyrightText: © 2020-%s %s &lt;%s&gt;
;; SPDX-License-Identifier: MIT

;; Generated at %s from the literate configuration.

(add-to-list 'load-path %S)\n"</span><span class="ef-ob">
               (format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%Y"</span><span class="ef-ob">)
               (cadr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"AUTHOR"</span><span class="ef-ob"> keywords))
               (cadr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"EMAIL"</span><span class="ef-ob"> keywords))
               (format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%FT%T%z"</span><span class="ef-ob">)
               (replace-regexp-in-string
                (regexp-quote (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"HOME"</span><span class="ef-ob">)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"~"</span><span class="ef-ob">
                (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"subconf/"</span><span class="ef-ob">))))
      (mapc
       (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (confpkg)
         (insert
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq 'none (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:via</span><span class="ef-ob">))
              (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n;;; %s intentionally omitted.\n"</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob">))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
              (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
               ((eq 'copy (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:via</span><span class="ef-ob">))
                (insert-file-contents (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">))
                (goto-char (point-min))
                (narrow-to-region
                 (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^;;; Code:\n+"</span><span class="ef-ob">)
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
                   (goto-char (point-max))
                   (re-search-backward (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">\n\t ][\n\t ]*\n[\t ]*(provide '%s)"</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:package</span><span class="ef-ob">)))
                   (match-end 0))))
               ((eq 'require (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:via</span><span class="ef-ob">))
                (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"(require '%s)\n"</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:package</span><span class="ef-ob">))))
               (t (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"(warn \"%s confpkg :via has unrecognised value: %S\" %S %S)"</span><span class="ef-ob">
                                  (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob">) (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:via</span><span class="ef-ob">)))))
              (goto-char (point-min))
              (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n;;:------------------------"</span>
                      <span style="color: #50a14f; background-color: #e7e7e7;">"\n;;; "</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob">)
                      </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n;;:------------------------\n\n"</span><span class="ef-ob">)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:defines</span><span class="ef-ob">)
                (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">";; This block defines "</span><span class="ef-ob">
                        (mapconcat
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (d) (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"`</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'"</span><span class="ef-ob"> d))
                         (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:defines</span><span class="ef-ob">)
                         </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">)
                        </span><span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob">)
                (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-backward </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">, ]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">, </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">, ]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">, </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">, ]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">.</span><span style="color: #a626a4; background-color: #e7e7e7;">\\=</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">
                                          (line-beginning-position) t)
                  (replace-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\1, \\2, and \\3."</span><span class="ef-ob">))
                (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-backward </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">, ]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">, </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">, ]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">.</span><span style="color: #a626a4; background-color: #e7e7e7;">\\=</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">
                                          (line-beginning-position) t)
                  (replace-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\1 and \\2."</span><span class="ef-ob">))
                (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n"</span><span class="ef-ob">)
                (forward-line -2)
                (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> comment-start </span><span style="color: #50a14f; background-color: #e7e7e7;">";"</span><span class="ef-ob">)
                (fill-comment-paragraph)
                (forward-paragraph 1)
                (forward-line 1))
              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (equal (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:package</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">"config-confpkg-timings"</span><span class="ef-ob">)
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
                    (goto-char (point-max))
                    (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n\
(confpkg-create-record 'doom-pre-config (float-time (time-subtract (current-time) before-init-time)))
(confpkg-start-record 'config)
(confpkg-create-record 'config-defered 0.0 'config)
(confpkg-create-record 'set-hooks 0.0 'config-defered)
(confpkg-create-record 'load-hooks 0.0 'config-defered)
(confpkg-create-record 'requires 0.0 'root)\n"</span><span class="ef-ob">))
                (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((after (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob">))
                      (pre (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:pre</span><span class="ef-ob">)
                                (org-babel-expand-noweb-references
                                 (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"emacs-lisp"</span><span class="ef-ob">
                                       (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;&lt;%s&gt;&gt;"</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:pre</span><span class="ef-ob">))
                                       '((</span><span style="color: #a626a4; background-color: #e7e7e7;">:noweb</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"yes"</span><span class="ef-ob">)
                                         (</span><span style="color: #a626a4; background-color: #e7e7e7;">:comments</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"none"</span><span class="ef-ob">)))
                                 original-buffer)))
                      (name (replace-regexp-in-string
                             </span><span style="color: #50a14f; background-color: #e7e7e7;">"config--?"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">
                             (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:package</span><span class="ef-ob">))))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> after
                      (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"(confpkg-with-record '%S\n"</span><span class="ef-ob">
                                      (list (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"hook: "</span><span class="ef-ob"> name) 'set-hooks))
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> pre
                                  (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">";; Begin pre\n"</span><span class="ef-ob"> pre </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n;; End pre\n"</span><span class="ef-ob">)
                                </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
                              (format (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (symbolp after) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">If single feature.
</span>                                          <span style="color: #50a14f; background-color: #e7e7e7;">"  (with-eval-after-load '%s\n"</span>
                                        <span style="color: #50a14f; background-color: #e7e7e7;">"  (after! %s\n"</span><span class="ef-ob">)
                                      after))
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> pre
                      (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n;; Begin pre (unnecesary since after is unused)\n"</span><span class="ef-ob">
                              pre
                              </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n;; End pre\n"</span><span class="ef-ob">)))
                  (insert
                   (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"(confpkg-with-record '%S\n"</span><span class="ef-ob">
                           (list (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"load: "</span><span class="ef-ob"> name)
                                 (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> after 'load-hooks 'config)))))
                (goto-char (point-max))
                (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">";"</span><span class="ef-ob"> (thing-at-point 'line))
                  (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
                (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">)
                (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get confpkg </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob">)
                  (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"))"</span><span class="ef-ob">))
                (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
              (buffer-string)))))
       (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((confpkg-timings </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Ensure timings is put first.
</span><span class="ef-ob">              (cl-some (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (p) (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (equal (plist-get p </span><span style="color: #a626a4; background-color: #e7e7e7;">:package</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">"config-confpkg-timings"</span><span class="ef-ob">) p))
                       confpkg--list)))
         (append (list confpkg-timings)
                 (nreverse (remove confpkg-timings confpkg--list)))))
      (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n(confpkg-finish-record 'config)\n\n;;; config.el ends here"</span><span class="ef-ob">)
      (write-region nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"config.el"</span><span class="ef-ob"> nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:silent</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
Applying lexical binding to the config file is good for a number of reasons,
among which it's (slightly) faster than dynamic binding (see <span style="color: #4078f2; font-weight: 700;">[[https://nullprogram.com/blog/2016/12/22/][this blog post]]</span> for
more info).

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Quieter output</span>

All the babel evaluation here ends up being quite noisy (along with a few other
things during tangle), let's see if we can change that.

<span style="color: #84888b;">#+name: confpkg-quieter-output</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> noninteractive
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (fboundp 'doom-shut-up-a)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">doom-shut-up-a</span><span class="ef-ob"> (fn </span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> args)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((standard-output #'ignore)
            (inhibit-message t))
        (apply fn args))))
  (advice-add 'org-babel-expand-body:emacs-lisp </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'doom-shut-up-a)
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Quiet some other annoying messages
</span><span class="ef-ob">  (advice-add 'sh-set-shell </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'doom-shut-up-a)
  (advice-add 'rng-what-schema </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'doom-shut-up-a)
  (advice-add 'python-indent-guess-indent-offset </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'doom-shut-up-a))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+call: confpkg-quieter-output()</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Reporting load time information</span>

<span style="color: #84888b;">#+call: confpkg("Confpkg timings")</span>

When generating the config we added a form to collect load-time information.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">confpkg-load-time-tree</span><span class="ef-ob"> (list (list 'root)))
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">confpkg-record-branch</span><span class="ef-ob"> (list 'root))
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">confpkg-record-num</span><span class="ef-ob"> 0)
</span><span class="ef-obe">#+end_src
</span>
It would be good to process <span style="color: #84888b;">~confpkg-load-times~</span> at the end to make it more
useful, and provide a function to display load time information from it. This is
to aid in identification of confpkgs that take particularly long to load, and
thus would benefit from some attention.

To extract the per-confpkg load times, we can just take the difference in
<span style="color: #84888b;">~(float-time)~</span> and exclude the first entry.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-create-record</span><span class="ef-ob"> (name elapsed </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> parent enclosing)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((parent (assoc (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> parent (car confpkg-record-branch))
                       confpkg-load-time-tree))
        (record (cons name (list (list 'self
                                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob"> (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s"</span><span class="ef-ob"> name)
                                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> confpkg-record-num)
                                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob"> elapsed
                                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:enclosing</span><span class="ef-ob"> enclosing)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> record confpkg-load-time-tree)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> record (cdr parent))
    record))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-start-record</span><span class="ef-ob"> (name </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> parent)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((record (confpkg-create-record name 0.0e+NaN parent t)))
    (plist-put (cdadr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:start</span><span class="ef-ob"> (float-time))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> name confpkg-record-branch)
    record))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-finish-record</span><span class="ef-ob"> (name)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((self-record (cdar (last (cdr (assoc name confpkg-load-time-tree))))))
    (plist-put self-record </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">
               (- (float-time) (plist-get self-record </span><span style="color: #a626a4; background-color: #e7e7e7;">:start</span><span class="ef-ob">) 0.0))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (equal (car confpkg-record-branch) name)
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Warning: Confpkg timing record expected to finish %S, instead found %S. %S"</span><span class="ef-ob">
               name (car confpkg-record-branch) confpkg-record-branch))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> confpkg-record-branch (cdr confpkg-record-branch))))
</span><span class="ef-obe">#+end_src
</span>
A convenience macro could be nice to have.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defmacro</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-with-record</span><span class="ef-ob"> (name </span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> body)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Create a time record around BODY.
The record must have a NAME."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">declare</span><span class="ef-ob"> (indent 1))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((name-val (make-symbol </span><span style="color: #50a14f; background-color: #e7e7e7;">"name-val"</span><span class="ef-ob">))
        (record-spec (make-symbol </span><span style="color: #50a14f; background-color: #e7e7e7;">"record-spec"</span><span class="ef-ob">)))
    `(</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((,name-val ,name)
            (,record-spec (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (consp ,name-val) ,name-val (list ,name-val))))
       (apply #'confpkg-start-record ,record-spec)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">unwind-protect</span><span class="ef-ob">
           (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob"> ,@body)
         (confpkg-finish-record (car ,record-spec))))))
</span><span class="ef-obe">#+end_src
</span>
It would also be nice to collect some other load-time-related information.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +require--log-timing-a (orig-fn feature </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> filename noerror)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'require
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">featurep</span> <span style="color: #b751b6; background-color: #e7e7e7;">feature</span><span class="ef-ob">)
          (eq feature 'cus-start) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">HACK Why!?!
</span><span class="ef-ob">          (assoc (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"require: %s"</span><span class="ef-ob"> feature) confpkg-load-time-tree))
      (funcall orig-fn feature filename noerror)
    (confpkg-with-record (list (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"require: %s"</span><span class="ef-ob"> feature)
                               (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (eq (car confpkg-record-branch) 'root)
                                    'requires))
      (funcall orig-fn feature filename noerror))))
</span><span class="ef-obe">#+end_src
</span>
At last, we'll go to some pains to make a nice result tabulation function.

I will readily admit that this function is absolutely horrible. I just spent an
evening adding to it till it worked then stopped touching it. Maybe in the
future I'll go back to it and try to clean up the implementation.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-timings-report</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> sort-p node)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Display a report on load-time information.
Supply SORT-P (or the universal argument) to sort the results.
NODE defaults to the root node."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">
   (list (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> current-prefix-arg t)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((buf (get-buffer-create </span><span style="color: #50a14f; background-color: #e7e7e7;">"*Confpkg Load Time Report*"</span><span class="ef-ob">))
        (depth 0)
        num-pad name-pad max-time max-total-time max-depth)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-labels</span><span class="ef-ob">
        ((sort-records-by-time
          (record)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((self (assoc 'self record)))
            (append (list self)
                    (sort (nreverse (remove self (cdr record)))
                          (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (a b)
                            (&gt; (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get (alist-get 'self a) </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob">) 0.0)
                               (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get (alist-get 'self b) </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob">) 0.0)))))))
         (print-record
          (record)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
           ((eq (car record) 'self)
            (insert
             (propertize
              (string-pad (number-to-string (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob">)) num-pad)
              'face 'font-lock-keyword-face)
             </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">
             (propertize
              (apply #'concat
                     (make-list (1- depth) </span><span style="color: #50a14f; background-color: #e7e7e7;">"• "</span><span class="ef-ob">))
              'face 'font-lock-comment-face)
             (string-pad (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s"</span><span class="ef-ob"> (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob">)) name-pad)
             (make-string (* (- max-depth depth) 2) ?\s)
             (propertize
              (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%.4fs"</span><span class="ef-ob"> (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">))
              'face
              (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">
                    (doom-blend 'orange 'green
                                (/ (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">) max-time))))
             (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">)
                    (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob">))
                 </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">
               (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"   (Σ="</span><span class="ef-ob">
                       (propertize
                        (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%.3fs"</span><span class="ef-ob"> (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob">))
                        'face
                        (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">
                              (doom-blend 'orange 'green
                                          (/ (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob">) max-total-time))))
                       </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">))
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
           (t
            (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> depth)
            (mapc
             #'print-record
             (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> sort-p
                 (sort-records-by-time record)
               (reverse (cdr record))))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-decf</span><span class="ef-ob"> depth))))
         (flatten-records
          (records)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq (car records) 'self)
              (list records)
            (mapcan
             #'flatten-records
             (reverse (cdr records)))))
         (tree-depth
          (records </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> depth)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq (car records) 'self)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> depth 0)
            (1+ (cl-reduce #'max (cdr records) </span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob"> #'tree-depth))))
         (mapreduceprop
          (list map reduce prop)
          (cl-reduce
           reduce list
           </span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob">
           (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (p) (funcall map (plist-get (cdr p) prop)))))
         (elaborate-timings
          (record)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq (car record) 'self)
              (plist-get (cdr record) </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((total (cl-reduce #'+ (cdr record)
                                    </span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob"> #'elaborate-timings))
                  (self (cdr (assoc 'self record))))
              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (plist-get self </span><span style="color: #a626a4; background-color: #e7e7e7;">:enclosing</span><span class="ef-ob">)
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">prog1</span><span class="ef-ob">
                      (plist-get self </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">)
                    (plist-put self </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob"> (plist-get self </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">))
                    (plist-put self </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">
                               (- (* 2 (plist-get self </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">)) total)))
                (plist-put self </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob"> total)
                total))))
         (elaborated-timings
          (record)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((record (copy-tree record)))
            (elaborate-timings record)
            record)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((tree
              (elaborated-timings
               (append '(root)
                       (copy-tree
                        (alist-get (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> node 'root)
                                   confpkg-load-time-tree
                                   nil nil #'equal))
                       '((self </span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob"> 0 </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob"> 0)))))
             (flat-records
              (cl-remove-if
               (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (rec) (= (plist-get (cdr rec) </span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob">) 0))
               (flatten-records tree))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> max-time (mapreduceprop flat-records #'identity #'max </span><span style="color: #a626a4; background-color: #e7e7e7;">:elapsed</span><span class="ef-ob">)
              max-total-time (mapreduceprop flat-records #'identity #'max </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob">)
              name-pad (mapreduceprop flat-records #'length #'max </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob">)
              num-pad (mapreduceprop flat-records
                                     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (n) (length (number-to-string n)))
                                     #'max </span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob">)
              max-depth (tree-depth tree))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> buf
          (erase-buffer)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> outline-regexp </span><span style="color: #50a14f; background-color: #e7e7e7;">"[0-9]+ *</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">• </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">*"</span><span class="ef-ob">)
          (outline-minor-mode 1)
          (use-local-map (make-sparse-keymap))
          (local-set-key </span><span style="color: #50a14f; background-color: #e7e7e7;">"TAB"</span><span class="ef-ob"> #'outline-toggle-children)
          (local-set-key </span><span style="color: #50a14f; background-color: #e7e7e7;">"\t"</span><span class="ef-ob"> #'outline-toggle-children)
          (local-set-key (kbd </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;backtab&gt;"</span><span class="ef-ob">) #'outline-show-subtree)
          (local-set-key (kbd </span><span style="color: #50a14f; background-color: #e7e7e7;">"C-&lt;iso-lefttab&gt;"</span><span class="ef-ob">)
                         (eval `(</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> current-prefix-arg
                                          (outline-show-all)
                                        (outline-hide-sublevels (+ ,num-pad 2))))))
          (insert
           (propertize
            (concat (string-pad </span><span style="color: #50a14f; background-color: #e7e7e7;">"#"</span><span class="ef-ob"> num-pad) </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">
                    (string-pad </span><span style="color: #50a14f; background-color: #e7e7e7;">"Confpkg"</span><span class="ef-ob">
                                (+ name-pad (* 2 max-depth) -3))
                    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">" Load Time (Σ=%.3fs)\n"</span><span class="ef-ob">
                            (plist-get (cdr (assoc 'self tree)) </span><span style="color: #a626a4; background-color: #e7e7e7;">:total</span><span class="ef-ob">)))
            'face '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> (tab-bar-tab bold) </span><span style="color: #a626a4; background-color: #e7e7e7;">:extend</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:underline</span><span class="ef-ob"> t)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (record (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> sort-p
                              (sort-records-by-time tree)
                            (reverse (cdr tree))))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (eq (car record) 'self)
              (print-record record)))
          (set-buffer-modified-p nil)
          (goto-char (point-min)))
        (pop-to-buffer buf)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Finalise</span>

At last, to clean up the content inserted by the babel calls we can just revert
the buffer. As long as <span style="color: #84888b;">~org-babel-pre-tangle-hook~</span> hasn't been modified,
<span style="color: #84888b;">~save-buffer~</span> will be run at the start of the tangle process and so reverting will
take us back to just before the tangle started.

Since this is <span style="text-decoration: italic;">/the/</span> function added as the post-tangle hook, we also need to remove
the function from the hook and call the <span style="color: #84888b;">=config.el=</span> creation function.

<span style="color: #84888b;">#+name: confpkg-finaliser</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">confpkg-tangle-finalise</span><span class="ef-ob"> ()
  (remove-hook 'org-babel-tangle-finished-hook #'confpkg-tangle-finalise)
  (revert-buffer t t t)
  (confpkg-comment-out-package-statements)
  (confpkg-annotate-list-dependencies)
  (confpkg-create-config)
  (confpkg-write-dependencies)
  (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Processed %s elisp files"</span><span class="ef-ob"> (length confpkg--list)))
</span><span class="ef-obe">#+end_src
</span>
Within <span style="color: #84888b;">~confpkg-tangle-finalise~</span> we carefully order each step so that
the most important steps go first, to minimise the impact should a particular
step fail.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Bootstrap</span>

This system makes use of some recent commits introduced to Org, such as <span style="color: #4078f2; font-weight: 700;">[[https://git.savannah.gnu.org/cgit/emacs/org-mode.git/commit/?id=cb8bf4a0d][this
noweb expansion bugfix]]</span> which will be included in Org 9.5.4. This is
problematic if using Emacs 28.2 or older, so to get around this we must go
through a bootstrap process.

<span style="color: #4078f2; font-weight: 700;">[[xkcd:1739]]</span>

To start with, we'll check if we are:
+ Running an Org version prior to 9.5.4
+ Running in a <span style="color: #84888b;">~noninteractive~</span> session
+ Using an Org that's not installed in the user directory
+ In a session with the symbol <span style="color: #84888b;">~exit!~</span> defined

<span style="color: #84888b;">#+name: bootstrap</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((required-org-version </span><span style="color: #50a14f; background-color: #e7e7e7;">"9.5.4"</span><span class="ef-ob">)
      (standard-output t))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (version&lt; (org-version) required-org-version)
             (not (string-match-p (regexp-quote (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"~"</span><span class="ef-ob">))
                                  (locate-library </span><span style="color: #50a14f; background-color: #e7e7e7;">"org"</span><span class="ef-ob">))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
     ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> noninteractive (fboundp 'exit!))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">warn</span><span class="ef-ob"> (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Detected conditions provoking a config bootstrap (Org %s)"</span><span class="ef-ob"> (org-version))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (start </span><span style="color: #50a14f; background-color: #e7e7e7;">"Initiating bootstrap..."</span><span class="ef-ob">))
      &lt;&lt;bootstrap-perform&gt;&gt;
      )
     (t (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Installed Org version %s is too old, %s is needed.\nRun \"doom sync\" to fix."</span><span class="ef-ob">
                 (org-version) required-org-version)))))
</span><span class="ef-obe">#+end_src
</span>
If these conditions are met, we can assume that the loaded Org version is
insufficient, and that it's likely a Emacs is currently running a command like
<span style="color: #84888b;">=doom sync=</span>, and so it makes sense to perform the 3-step bootstrap.
1. Temporarily rename <span style="color: #84888b;">=config.org=</span> to <span style="color: #84888b;">=config.original.org=</span>.
2. Create a new <span style="color: #84888b;">=config.org=</span> that when tangled results in Org being installed.
3. Swap back to the original <span style="color: #84888b;">=config.org=</span>, and re-sync.

<span style="color: #84888b;">#+name: bootstrap-perform</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (item </span><span style="color: #50a14f; background-color: #e7e7e7;">"Temporarily relocating config.org to config.original.org"</span><span class="ef-ob">))
(rename-file </span><span style="color: #50a14f; background-color: #e7e7e7;">"config.org"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"config.original.org"</span><span class="ef-ob"> t)
&lt;&lt;boostrap-create-transient-config&gt;&gt;
(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (item </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s"</span><span class="ef-ob">) (bold </span><span style="color: #50a14f; background-color: #e7e7e7;">"Re-running sync"</span><span class="ef-ob">))
(exit! </span><span style="color: #a626a4; background-color: #e7e7e7;">:restart</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Re-run =doom sync= with the transient config.
</span><span class="ef-obe">#+end_src
</span>
With the approach worked out, we just need to generate a snipped that will
create a new <span style="color: #84888b;">=config.org=</span> that when tangled:
+ Tangles our Org recipe to <span style="color: #84888b;">=packages.el=</span>
+ Swaps back to the original <span style="color: #84888b;">=config.org=</span>
+ Re-runs <span style="color: #84888b;">=doom sync=</span>

<span style="color: #84888b;">#+name: boostrap-create-transient-config</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (item </span><span style="color: #50a14f; background-color: #e7e7e7;">"Creating minimal init.el"</span><span class="ef-ob">))

(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((standard-output #'ignore))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
    (insert
     </span><span style="color: #50a14f; background-color: #e7e7e7;">";;; init.el -*- lexical-binding: t; -*-\n\n"</span><span class="ef-ob">
     (pp (</span><span style="color: #e45649; background-color: #e7e7e7;">quote</span><span class="ef-ob">
          &lt;&lt;bootstrap-init&gt;&gt;
          )))
    (write-region nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"init.el"</span><span class="ef-ob">)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (item </span><span style="color: #50a14f; background-color: #e7e7e7;">"Creating boostrap config.el"</span><span class="ef-ob">))

(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((standard-output #'ignore))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
    (insert
     (org-element-interpret-data
      (list
       '(keyword (</span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span> <span style="color: #50a14f; background-color: #e7e7e7;">"title"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:value</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Boostrap Stage 1 Config"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:post-blank</span><span class="ef-ob"> 1))
       `(src-block
         (</span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span> <span style="color: #50a14f; background-color: #e7e7e7;">"emacs-lisp"</span>
          <span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> ,(pp (</span><span style="color: #e45649; background-color: #e7e7e7;">quote</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
                               &lt;&lt;boostrap-transition&gt;&gt;
                               )))
          </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"bootstrap-transition"</span>
          <span style="color: #a626a4; background-color: #e7e7e7;">:post-blank</span><span class="ef-ob"> 1))
       `(src-block
         (</span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span> <span style="color: #50a14f; background-color: #e7e7e7;">"emacs-lisp"</span>
          <span style="color: #a626a4; background-color: #e7e7e7;">:parameters</span><span class="ef-ob">
          ,(concat </span><span style="color: #50a14f; background-color: #e7e7e7;">":noweb no-export "</span>
                   <span style="color: #50a14f; background-color: #e7e7e7;">":tangle (expand-file-name (make-temp-name \"emacs-org-babel-excuses/confpkg-prepare-\") temporary-file-directory) "</span>
                   <span style="color: #50a14f; background-color: #e7e7e7;">":mkdirp yes"</span><span class="ef-ob">)
          </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> ,(concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;&lt;"</span> <span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Split to avoid (prematurely) creating a noweb reference.
</span>                          <span style="color: #50a14f; background-color: #e7e7e7;">"bootstrap-transition()"</span>
                          <span style="color: #50a14f; background-color: #e7e7e7;">"&gt;&gt;\n"</span><span class="ef-ob">))))))
    (write-region nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"config.org"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
For the bootstrap we need a minimal <span style="color: #84888b;">=init.el=</span>, just the literate module should be
sufficient.

<span style="color: #84888b;">#+name: bootstrap-init</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">doom!</span> <span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob"> literate)
</span><span class="ef-obe">#+end_src
</span>
This <span style="color: #84888b;">=config.org=</span> simply provides an entry point for us to run elisp during
tangle. We just need to make use of it to install Org and re-sync the original
configuration.

<span style="color: #84888b;">#+name: boostrap-transition</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> standard-output t)

(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (start </span><span style="color: #50a14f; background-color: #e7e7e7;">"Starting second stage of the bootstrap."</span><span class="ef-ob">))
(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (item </span><span style="color: #50a14f; background-color: #e7e7e7;">"Creating minimal packages.el"</span><span class="ef-ob">))

(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((standard-output #'ignore))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
    (insert
     </span><span style="color: #50a14f; background-color: #e7e7e7;">";; -*- no-byte-compile: t; -*-\n\n"</span><span class="ef-ob">
     (pp (</span><span style="color: #e45649; background-color: #e7e7e7;">quote</span><span class="ef-ob">
          &lt;&lt;org-pkg-statement()&gt;&gt;
          )))
    (write-region nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"packages.el"</span><span class="ef-ob">)))

(doom-packages-install)

(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (item </span><span style="color: #50a14f; background-color: #e7e7e7;">"Switching back to original config.org"</span><span class="ef-ob">))
(rename-file </span><span style="color: #50a14f; background-color: #e7e7e7;">"config.original.org"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"config.org"</span><span class="ef-ob"> t)

(</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (item </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s"</span><span class="ef-ob">) (bold </span><span style="color: #50a14f; background-color: #e7e7e7;">"Re-running sync"</span><span class="ef-ob">))
(exit! </span><span style="color: #a626a4; background-color: #e7e7e7;">:restart</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
There we go, that should do the trick, so long as we call the <span style="color: #84888b;">=bootstrap=</span> block at
the start of the tangle process. This is done by calling <span style="color: #84888b;">=bootstrap=</span> within the
<span style="color: #4078f2; font-weight: 700;">[[Preparation][confpkg preparation]]</span> stage.

<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Personal Information</span>

<span style="color: #84888b;">#+call: confpkg()</span>

It's useful to have some basic personal information
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> user-full-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"TEC"</span><span class="ef-ob">
      user-mail-address </span><span style="color: #50a14f; background-color: #e7e7e7;">"contact@tecosaur.net"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>Apparently this is used by <span style="color: #84888b;">~GPG~</span>, and all sorts of other things.

Speaking of <span style="color: #84888b;">~GPG~</span>, I want to use <span style="color: #84888b;">=~/.authinfo.gpg=</span> instead of the default in
<span style="color: #84888b;">=~/.config/emacs=</span>. Why? Because my home directory is already cluttered, so this won't
make a difference, and I don't want to accidentally purge this file (I have done
<span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">shell</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">rm -rf~/.emac.d~ before</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>. I also want to cache as much as possible, as
my home machine is pretty safe, and my laptop is shutdown a lot.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> auth-sources '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.authinfo.gpg"</span><span class="ef-ob">)
      auth-source-cache-expiry nil) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">default is 7200 (2h)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Better defaults</span>

<span style="color: #84888b;">#+call: confpkg()</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Simple settings</span>

Inspired by a few sources of modified defaults (such as <span style="color: #4078f2; font-weight: 700;">[[https://github.com/angrybacon/dotemacs/blob/master/dotemacs.org#use-better-defaults][angrybacon/dotemacs]]</span>) and
my own experiences, I've ended up with a small set of tweaks on top of the
changes Doom makes:

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq-default</span><span class="ef-ob">
 delete-by-moving-to-trash t                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Delete files to trash
</span><span class="ef-ob"> window-combination-resize t                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">take new window space from all other windows (not just current)
</span><span class="ef-ob"> x-stretch-cursor t)                              </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Stretch cursor to the glyph width
</span><span class="ef-ob">
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> undo-limit 80000000                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Raise undo-limit to 80Mb
</span><span class="ef-ob">      evil-want-fine-undo t                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">By default while in insert all changes are one big blob. Be more granular
</span><span class="ef-ob">      auto-save-default t                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Nobody likes to loose work, I certainly don't
</span><span class="ef-ob">      truncate-string-ellipsis </span><span style="color: #50a14f; background-color: #e7e7e7;">"…"</span>                <span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Unicode ellispis are nicer than "...", and also save /precious/ space
</span><span class="ef-ob">      password-cache-expiry nil                   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">I can trust my computers ... can't I?
</span>      <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">scroll-preserve-screen-position 'always     ; Don't have `</span><span style="color: #b751b6; background-color: #e7e7e7;">point</span><span style="color: #84888b; background-color: #e7e7e7;">' jump around
</span><span class="ef-ob">      scroll-margin 2                             </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">It's nice to maintain a little margin
</span><span class="ef-ob">      display-time-default-load-average nil)      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">I don't think I've ever found this useful
</span><span class="ef-ob">
(display-time-mode 1)                             </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Enable time in the mode-line
</span><span class="ef-ob">(global-subword-mode 1)                           </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Iterate through CamelCase words
</span><span class="ef-obe">#+end_src
</span>
When using a device with a battery, it would be nice to display battery
 information. We can check for a battery during tangle via noweb, and only call
 <span style="color: #84888b;">~display-battery-mode~</span> when relevant. From a look at the various status functions
 in <span style="color: #84888b;">=battery.el=</span>, it seems like the <span style="color: #84888b;">~?L~</span> key is consistently <span style="color: #84888b;">=N/A=</span> when there is no
 battery, so we'll test on that.

<span style="color: #84888b;">#+name: battery-status-setup</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">battery</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> battery-status-function
         (not (equal (alist-get ?L (funcall battery-status-function))
                     </span><span style="color: #50a14f; background-color: #e7e7e7;">"N/A"</span><span class="ef-ob">)))
    (prin1-to-string `(display-battery-mode 1))
  </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Now with noweb we' use the result.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export 
</span><span class="ef-ob">&lt;&lt;battery-status-setup()&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Frame sizing</span>

It's nice to control the size of new frames, when launching Emacs that can be
done with <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">shell</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">emacs -geometry 160x48</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>. After the font size adjustment
during initialisation this works out to be <span style="color: #84888b;">~102x31~</span>.

Thanks to hotkeys, it's easy for me to expand a frame to half/full-screen, so it
makes sense to be conservative with the sizing of new frames.

Then, for creating new frames within the same Emacs instance, we'll just set the
default to be something roughly 80% of that size.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-to-list 'default-frame-alist '(height . 24))
(add-to-list 'default-frame-alist '(width . 80))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Auto-customisations</span>

By default changes made via a customisation interface are added to <span style="color: #84888b;">=init.el=</span>.
I prefer the idea of using a separate file for this. We just need to change a
setting, and load it if it exists.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq-default</span><span class="ef-ob"> custom-file (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">".custom.el"</span><span class="ef-ob"> doom-user-dir))
(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (file-exists-p custom-file)
  (load custom-file))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Windows</span>

I find it rather handy to be asked which buffer I want to see after splitting
the window. Let's make that happen.

First, we'll enter the new window
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> evil-vsplit-window-right t
      evil-split-window-below t)
</span><span class="ef-obe">#+end_src
</span>
Then, we'll pull up a buffer prompt.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> prompt-for-buffer (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> _)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> '(evil-window-split evil-window-vsplit)
  (consult-buffer))
</span><span class="ef-obe">#+end_src
</span>
Window rotation is nice, and can be found under <span style="color: #84888b;">=SPC w r=</span> and <span style="color: #84888b;">=SPC w R=</span>.
<span style="text-decoration: italic;">/Layout/</span> rotation is also nice though. Let's stash this under <span style="color: #84888b;">=SPC w SPC=</span>, inspired
by Tmux's use of <span style="color: #84888b;">=C-b SPC=</span> to rotate windows.

We could also do with adding the missing arrow-key variants of the window
navigation/swapping commands.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> evil-window-map
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"SPC"</span><span class="ef-ob"> #'rotate-layout
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Navigation
</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;left&gt;"</span><span class="ef-ob">     #'evil-window-left
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;down&gt;"</span><span class="ef-ob">     #'evil-window-down
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;up&gt;"</span><span class="ef-ob">       #'evil-window-up
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;right&gt;"</span><span class="ef-ob">    #'evil-window-right
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Swapping windows
</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"C-&lt;left&gt;"</span><span class="ef-ob">       #'+evil/window-move-left
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"C-&lt;down&gt;"</span><span class="ef-ob">       #'+evil/window-move-down
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"C-&lt;up&gt;"</span><span class="ef-ob">         #'+evil/window-move-up
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"C-&lt;right&gt;"</span><span class="ef-ob">      #'+evil/window-move-right)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Hippie expand</span>

Completing text based on other availible content is a great idea, and so <span style="color: #84888b;">~dabbrev~</span>
(dynamic abbreviations) is throughly useful. There's another similar tool that
Emacs comes with though, called <span style="color: #4078f2; font-weight: 700;">[[https://www.masteringemacs.org/article/text-expansion-hippie-expand][hippie expand]]</span>, which is just a bit nicer yet,
and can be used as a swap-in upgrade to <span style="color: #84888b;">~dabbrev~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(global-set-key [remap dabbrev-expand] #'hippie-expand)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Expansion prioritisation</span>

Hippie expand works by cycling through a series of expansion-generating
functions, listed in the variable <span style="color: #84888b;">~hippie-expand-try-functions-list~</span>.

By default, it completes (in order):
+ File names
+ Known abbreviations
+ Lists (i.e. bracketed regions)
+ Previous lines
+ Dabbrev (this buffer)
+ Dabbrev (all buffers)
+ Dabbrev (kill ring)
+ Known elisp symbols

I find that <span style="color: #84888b;">~try-expand-line~</span> completions often appear when I actually want a
dabbrev completion, so let's deprioritise it somewhat. If I actually want to try
for a line expansion, it's fairly easy to deliberately trigger it --- just
invoke <span style="color: #84888b;">~hippie-expand~</span> after typing a space and there will be no dabbrev
candidates.

Speaking of dabbrev, I do think of hippie-expand mostly as "a stangely named
dabbrev+", so let's prioritise the dabbrev-related expanders a bit. I'll also
toss in a nice non-default expansion generator as the first dabbrev candidate
function: <span style="color: #84888b;">~try-expand-dabbrev-visible~</span>.

There's another cool source of multi-word expansion (actually multi-line) that
isn't used by default, <span style="color: #84888b;">~try-expand-dabbrev-from-kill~</span>. I personally think this one
is quite neat, but don't want it to interfere with more common single-word
completions, and so will place it just above <span style="color: #84888b;">~try-expand-line~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> hippie-expand-try-functions-list
      '(try-expand-list
        try-expand-dabbrev-visible
        try-expand-dabbrev
        try-expand-all-abbrevs
        try-expand-dabbrev-all-buffers
        try-complete-file-name-partially
        try-complete-file-name
        try-expand-dabbrev-from-kill
        try-expand-whole-kill
        try-expand-line
        try-complete-lisp-symbol-partially
        try-complete-lisp-symbol))
</span><span class="ef-obe">#+end_src
</span>
Unfortunately there's one aspect of <span style="color: #84888b;">~try-expand-dabbrev-from-kill~</span> that I find
lets me down a bit, which is that it fails to complete when the killed text
starts with a newline and the current line does not. I'll see if I can do
something about this in the future.

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Suffix stripping</span>

I am occasionally annoyed by expansions that I make mid-line and cause a common
suffix in the completion to be repeated. For instance, say in an earlier line of
a file I have:

<span class="ef-obb">#+begin_example
</span><span class="ef-ob">func foo(int x, int y, int z)
</span><span class="ef-obe">#+end_example
</span>
where the <span style="color: #84888b;">=int y=</span> argument has just been added. I move to another function that
should have the same adjustment and invoke hippie-expand (at <span style="color: #84888b;">~|~</span>) to save me keystrokes:

<span class="ef-obb">#+begin_example
</span><span class="ef-ob">func bar(int x,| int z)
</span><span class="ef-obe">#+end_example
</span>
This invokes <span style="color: #84888b;">~try-expand-list~</span> and completes to

<span class="ef-obb">#+begin_example
</span><span class="ef-ob">func bar(int x, int y, int z) int z)
</span><span class="ef-obe">#+end_example
</span>
Clearly, that's not what I want! I suspect that we can make it "just work" the
vast majority of the time by looking to see if there's a suffix in the
completion that's also a prefix of the remainder of the line, and stripping it.
In our example, this would be <span style="color: #84888b;">=int z)=</span> which would turn the completed line into:

<span class="ef-obb">#+begin_example
</span><span class="ef-ob">func bar(int x, int y, int z)
</span><span class="ef-obe">#+end_example
</span>
Hippie-expand doesn't provide a good point to modify expansion behaviour like
this, however the insertion of the expansion is handled by the helper function
<span style="color: #84888b;">~he-substitute-strings~</span>, which we can advise to behave as we wish.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+he-subst-suffix-overlap</span><span class="ef-ob"> (ins rem)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"The longest suffix of the string INS that is a prefix of REM.
This is intended to be used when INS is a newly inserted string and REM is the
remainder of the line, to allow for handling potentially duplicated content."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((len (min (length ins) (length rem))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (&gt; len 0)
                (not (eq 't (compare-strings ins (- len) nil rem 0 len))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> len (1- len)))
    len))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+he-suffix-strip-a</span><span class="ef-ob"> (args)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Filter ARG list for `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">he-substitute-string</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', truncating duplicated suffix.
ARGS is the raw argument list (STRING &amp;optional TRANS-CASE)."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase-let*</span><span class="ef-ob"> ((`(,ins </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> ,trans-case) args)
               (rem (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
                      (goto-char (marker-position he-string-end))
                      (buffer-substring-no-properties
                       (point) (line-end-position))))
               (ov (+he-subst-suffix-overlap ins rem)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt;= ov 0)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> ins (substring ins 0 (- (length ins) ov))))
    (list ins trans-case)))

(advice-add #'he-substitute-string </span><span style="color: #a626a4; background-color: #e7e7e7;">:filter-args</span><span class="ef-ob"> #'+he-suffix-strip-a)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Buffer defaults</span>

I'd much rather have my new buffers in <span style="color: #84888b;">~org-mode~</span> than <span style="color: #84888b;">~fundamental-mode~</span>, hence
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(setq-default major-mode 'org-mode)
</span><span class="ef-obe">#+end_src
</span>For some reason this + the mixed pitch hook causes issues with hydra and so I'll
just need to resort to <span style="color: #84888b;">=SPC b o=</span> for now.

<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Doom configuration</span>

<span style="color: #84888b;">#+call: confpkg("Doom")</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Modules</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :tangle no
<span style="font-weight: 700;">:END:</span>

Doom has this lovely <span style="text-decoration: italic;">/modular configuration base/</span> that takes a lot of work out of
configuring Emacs. Each module (when enabled) can provide a list of packages to
install (on <span style="color: #84888b;">~doom sync~</span>) and configuration to be applied. The modules can also
have flags applied to tweak their behaviour.

<span style="color: #84888b;">#+name: init.el</span>
<span style="color: #84888b;">#+attr_html: :collapsed t</span>
<span class="ef-obb">#+begin_src emacs-lisp :tangle "init.el" :noweb no-export :noweb-ref none
</span><span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">init.el -*- lexical-binding: t; -*-
</span>
<span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">This file controls what Doom modules are enabled and what order they load in.
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Press '</span><span style="color: #b751b6; background-color: #e7e7e7;">K</span><span style="color: #84888b; background-color: #e7e7e7;">' on a module to view its documentation, and '</span><span style="color: #b751b6; background-color: #e7e7e7;">gd</span><span style="color: #84888b; background-color: #e7e7e7;">' to browse its directory.
</span><span class="ef-ob">
(</span><span style="color: #e45649; background-color: #e7e7e7;">doom!</span> <span style="color: #a626a4; background-color: #e7e7e7;">:input</span><span class="ef-ob">
       &lt;&lt;doom-input&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:completion</span><span class="ef-ob">
       &lt;&lt;doom-completion&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:ui</span><span class="ef-ob">
       &lt;&lt;doom-ui&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:editor</span><span class="ef-ob">
       &lt;&lt;doom-editor&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:emacs</span><span class="ef-ob">
       &lt;&lt;doom-emacs&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:term</span><span class="ef-ob">
       &lt;&lt;doom-term&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:checkers</span><span class="ef-ob">
       &lt;&lt;doom-checkers&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:tools</span><span class="ef-ob">
       &lt;&lt;doom-tools&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:os</span><span class="ef-ob">
       &lt;&lt;doom-os&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:lang</span><span class="ef-ob">
       &lt;&lt;doom-lang&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:email</span><span class="ef-ob">
       &lt;&lt;doom-email&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:app</span><span class="ef-ob">
       &lt;&lt;doom-app&gt;&gt;

       </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
       &lt;&lt;doom-config&gt;&gt;
       )
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Structure</span>

As you may have noticed by this point, this is a <span style="color: #4078f2; font-weight: 700;">[[https://en.wikipedia.org/wiki/Literate_programming][literate]]</span> configuration. Doom
has good support for this which we access though the <span style="color: #84888b;">~literate~</span> module.

While we're in the <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> section, we'll use Dooms nicer defaults,
along with the bindings and smartparens behaviour (the flags aren't documented,
but they exist).
<span style="color: #84888b;">#+name: doom-config</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">literate
(default +bindings +smartparens)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Interface</span>

There's a lot that can be done to enhance Emacs' capabilities.
I reckon enabling half the modules Doom provides should do it.

<span style="color: #84888b;">#+name: doom-completion</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">company                   ; the ultimate code completion backend
</span><span class="ef-ob">(corfu +orderless +dabbrev)  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">complete with cap(f), cape and a flying feather!
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">helm                       ; the *other* search engine for love and life
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">ido                        ; the other *other* search engine...
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(ivy                      ; a search engine for love and life
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">+icons                   ; ... icons are nice
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">+prescient)              ; ... I know what I want(ed)
</span><span class="ef-ob">(vertico +icons)             </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">the search engine of the future
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-ui</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">deft                       ; notational velocity for Emacs
</span><span class="ef-ob">doom                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">what makes DOOM look the way it does
</span><span class="ef-ob">doom-dashboard               </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">a nifty splash screen for Emacs
</span><span class="ef-ob">doom-quit                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">DOOM quit-message prompts when you quit Emacs
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(emoji +unicode)          ; 🙂
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">fill-column                ; a `</span><span style="color: #b751b6; background-color: #e7e7e7;">fill-column</span><span style="color: #84888b; background-color: #e7e7e7;">' indicator
</span><span class="ef-ob">hl-todo                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">hydra                      ; quick documentation for related commands
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">indent-guides              ; highlighted indent columns, notoriously slow
</span><span class="ef-ob">(ligatures +extra)           </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ligatures and symbols to make your code pretty again
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">minimap                    ; show a map of the code on the side
</span><span class="ef-ob">modeline                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">snazzy, Atom-inspired modeline, plus API
</span><span class="ef-ob">nav-flash                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">blink the current line after jumping
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">neotree                    ; a project drawer, like NERDTree for vim
</span><span class="ef-ob">ophints                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">highlight the region an operation acts on
</span><span class="ef-ob">(popup                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">tame sudden yet inevitable temporary windows
</span><span class="ef-ob"> +all                        </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">catch all popups that start with an asterix
</span><span class="ef-ob"> +defaults)                  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">default popup rules
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(tabs                      ; an tab bar for Emacs
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">+centaur-tabs)           ; ... with prettier tabs
</span><span class="ef-ob">treemacs                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">a project drawer, like neotree but cooler
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">unicode                    ; extended unicode support for various languages
</span><span class="ef-ob">(vc-gutter +pretty)          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">vcs diff in the fringe
</span><span class="ef-ob">vi-tilde-fringe              </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">fringe tildes to mark beyond EOB
</span><span class="ef-ob">(window-select +numbers)     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">visually switch windows
</span><span class="ef-ob">workspaces                   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">tab emulation, persistence &amp; separate workspaces
</span><span class="ef-ob">zen                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">distraction-free coding or writing
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-editor</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(evil +everywhere)           </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">come to the dark side, we have cookies
</span><span class="ef-ob">file-templates               </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">auto-snippets for empty files
</span><span class="ef-ob">fold                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">(nigh) universal code folding
</span><span class="ef-ob">(format)                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">automated prettiness
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">god                        ; run Emacs commands without modifier keys
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">lispy                      ; vim for lisp, for people who don't like vim
</span><span class="ef-ob">multiple-cursors             </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">editing in many places at once
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">objed                      ; text object editing for the innocent
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">parinfer                   ; turn lisp into python, sort of
</span><span class="ef-ob">rotate-text                  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">cycle region at point between text candidates
</span><span class="ef-ob">snippets                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">my elves. They type so I don't have to
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">word-wrap                  ; soft wrapping with language-aware indent
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-emacs</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(dired +icons)               </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">making dired pretty [functional]
</span><span class="ef-ob">electric                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">smarter, keyword-based electric-indent
</span><span class="ef-ob">(ibuffer +icons)             </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">interactive buffer management
</span><span class="ef-ob">undo                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">persistent, smarter undo for your inevitable mistakes
</span><span class="ef-ob">vc                           </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">version-control and Emacs, sitting in a tree
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-term</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">eshell                     ; the elisp shell that works everywhere
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">shell                      ; simple shell REPL for Emacs
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">term                       ; basic terminal emulator for Emacs
</span><span class="ef-ob">vterm                        </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">the best terminal emulation in Emacs
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-checkers</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">syntax                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">tasing you for every semicolon you forget
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">spell                     ; tasing you for misspelling mispelling
</span><span class="ef-ob">grammar                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">tasing grammar mistake every you make
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-tools</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">ansible                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">a crucible for infrastructure as code
</span><span class="ef-ob">biblio                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Writes a PhD for you (citation needed)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">collab                     ; buffers with friends
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">debugger                   ; FIXME stepping through code, to help you add bugs
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">direnv                     ; be direct about your environment
</span><span class="ef-ob">docker                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">port everything to containers
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">editorconfig               ; let someone else argue about tabs vs spaces
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">ein                        ; tame Jupyter notebooks with emacs
</span><span class="ef-ob">(eval +overlay)              </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">run code, run (also, repls)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">gist                       ; interacting with github gists
</span><span class="ef-ob">(lookup                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">helps you navigate your code and documentation
</span><span class="ef-ob"> +dictionary                 </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">dictionary/thesaurus is nice
</span><span class="ef-ob"> +docsets)                   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">...or in Dash docsets locally
</span><span class="ef-ob">lsp                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Language Server Protocol
</span><span class="ef-ob">(magit                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">a git porcelain for Emacs
</span><span class="ef-ob"> +forge)                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">interface with git forges
</span><span class="ef-ob">make                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">run make tasks from Emacs
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">pass                       ; password manager for nerds
</span><span class="ef-ob">pdf                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">pdf enhancements
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">prodigy                    ; FIXME managing external services &amp; code builders
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">terraform                  ; infrastructure as code
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">tmux                       ; an API for interacting with tmux
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">tree-sitter                ; syntax and parsing, sitting in a tree...
</span><span class="ef-ob">upload                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">map local to remote projects via ssh/ftp
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-os</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #a626a4; background-color: #e7e7e7;">:if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">featurep</span> <span style="color: #b751b6; background-color: #e7e7e7;">:system</span><span class="ef-ob"> 'macos) macos) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">improve compatibility with macOS
</span><span class="ef-ob">tty                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">improve the terminal Emacs experience
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Language support</span>

We can be rather liberal with enabling support for languages as the associated
packages/configuration are (usually) only loaded when first opening an
associated file.

<span style="color: #84888b;">#+name: doom-lang</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">agda                       ; types of types of types of types...
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">beancount                  ; mind the GAAP
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(cc +lsp)                  ; C &gt; C++ == 1
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">clojure                    ; java with a lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">common-lisp                ; if you've seen one lisp, you've seen them all
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">coq                        ; proofs-as-programs
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">crystal                    ; ruby at the speed of c
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">csharp                     ; unity, .NET, and mono shenanigans
</span><span class="ef-ob">data                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">config/data formats
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(dart +flutter)            ; paint ui and not much else
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">dhall                      ; JSON with FP sprinkles
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">elixir                     ; erlang done right
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">elm                        ; care for a cup of TEA?
</span><span class="ef-ob">emacs-lisp                   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">drown in parentheses
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">erlang                     ; an elegant language for a more civilized age
</span><span class="ef-ob">ess                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">emacs speaks statistics
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">faust                      ; dsp, but you get to keep your soul
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">fsharp                     ; ML stands for Microsoft's Language
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">fstar                      ; (dependent) types and (monadic) effects and Z3
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">gdscript                   ; the language you waited for
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(graphql +lsp)             ; Give queries a REST
</span><span class="ef-ob">(go +lsp)                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">the hipster dialect
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(haskell +lsp)             ; a language that's lazier than I am
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">hy                         ; readability of scheme w/ speed of python
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">idris                      ;
</span><span class="ef-ob">json                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">At least it ain't XML
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(java +lsp)                ; the poster child for carpal tunnel syndrome
</span><span class="ef-ob">(javascript +lsp)            </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">all(hope(abandon(ye(who(enter(here))))))
</span><span class="ef-ob">(julia +lsp)                 </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Python, R, and MATLAB in a blender
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">kotlin                     ; a better, slicker Java(Script)
</span><span class="ef-ob">(latex                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">writing papers in Emacs has never been so fun
</span><span class="ef-ob"> +latexmk                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">what else would you use?
</span><span class="ef-ob"> +cdlatex                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">quick maths symbols
</span><span class="ef-ob"> +fold)                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">fold the clutter away nicities
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">lean                       ; proof that mathematicians need help
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">factor                     ; for when scripts are stacked against you
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">ledger                     ; an accounting system in Emacs
</span><span class="ef-ob">lua                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">one-based indices? one-based indices
</span><span class="ef-ob">markdown                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">writing docs for people to ignore
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">nim                        ; python + lisp at the speed of c
</span><span class="ef-ob">nix                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">I hereby declare "nix geht mehr!"
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">ocaml                      ; an objective camel
</span><span class="ef-ob">(org                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">organize your plain life in plain text
</span><span class="ef-ob"> +dragndrop                  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">drag &amp; drop files/images into org buffers
</span> <span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">+hugo                     ; use Emacs for hugo blogging
</span><span class="ef-ob"> +noter                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">enhanced PDF notetaking
</span><span class="ef-ob"> +jupyter                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ipython/jupyter support for babel
</span><span class="ef-ob"> +pandoc                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">export-with-pandoc support
</span><span class="ef-ob"> +gnuplot                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">who doesn't like pretty pictures
</span> <span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">+pomodoro                 ; be fruitful with the tomato technique
</span><span class="ef-ob"> +present                    </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">using org-mode for presentations
</span><span class="ef-ob"> +roam2)                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">wander around notes
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">php                        ; perl's insecure younger brother
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">plantuml                   ; diagrams for confusing people more
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">purescript                 ; javascript, but functional
</span><span class="ef-ob">(python +lsp +pyright)       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">beautiful is better than ugly
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">qt                         ; the '</span><span style="color: #b751b6; background-color: #e7e7e7;">cutest</span><span style="color: #84888b; background-color: #e7e7e7;">' gui framework ever
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">racket                     ; a DSL for DSLs
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">raku                       ; the artist formerly known as perl6
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">rest                       ; Emacs as a REST client
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">rst                        ; ReST in peace
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(ruby +rails)              ; 1.step {|i| p "Ruby is #{i.even? ? '</span><span style="color: #b751b6; background-color: #e7e7e7;">love</span><span style="color: #84888b; background-color: #e7e7e7;">' : '</span><span style="color: #b751b6; background-color: #e7e7e7;">life</span><span style="color: #84888b; background-color: #e7e7e7;">'}"}
</span><span class="ef-ob">(rust +lsp)                  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Fe2O3.unwrap().unwrap().unwrap().unwrap()
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">scala                      ; java, but good
</span><span class="ef-ob">scheme                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">a fully conniving family of lisps
</span><span class="ef-ob">sh                           </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">she sells {ba,z,fi}sh shells on the C xor
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">sml                        ; no, the /other/ ML
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">solidity                   ; do you need a blockchain? No.
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">swift                      ; who asked for emoji variables?
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">terra                      ; Earth and Moon in alignment for performance.
</span><span class="ef-ob">web                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">the tubes
</span><span class="ef-ob">yaml                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">JSON, but readable
</span><span class="ef-ob">zig                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">C, but simpler
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Input</span>

<span style="color: #84888b;">#+name: doom-input</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">bidi                       ; (tfel ot) thgir etirw uoy gnipleh
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">chinese
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">japanese
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">layout                     ; auie,ctsrnm is the superior home row
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Everything in Emacs</span>

It's just too convenient being able to have everything in Emacs.
I couldn't resist the Email and Feed modules.

<span style="color: #84888b;">#+name: doom-email</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #a626a4; background-color: #e7e7e7;">:if</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"mu"</span><span class="ef-ob">) (mu4e +org))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">notmuch
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">(wanderlust +gmail)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: doom-app</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">calendar                   ; A dated approach to timetabling
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">emms                       ; Multimedia in Emacs is music to my ears
</span><span class="ef-ob">everywhere                   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">*leave* Emacs!? You must be joking.
</span><span class="ef-ob">irc                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">how neckbeards socialize
</span><span class="ef-ob">(rss +org)                   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">emacs as an RSS reader
</span><span style="color: #84888b; background-color: #e7e7e7;">;;</span><span style="color: #84888b; background-color: #e7e7e7;">twitter                    ; twitter client https://twitter.com/vnought
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Profiles</span>

Doom has support for multiple configuration profiles. For general usage, this
isn't a particularly useful feature, but for niche use cases it's fantastic.

<span class="ef-obb">#+begin_src emacs-lisp :tangle ~/.config/emacs/profiles.el :noweb-ref none
</span><span class="ef-ob">((orgdev (env (</span><span style="color: #50a14f; background-color: #e7e7e7;">"DOOMDIR"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.config/doom.orgdev"</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Org development profile</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :noweb-ref none
<span style="font-weight: 700;">:END:</span>

For development purposes, it's handy to have a more minimal config without my
many customisations and interacting packages. Let's go ahead and create a
near-minimal new config:

<span class="ef-obb">#+begin_src emacs-lisp :tangle ../doom.orgdev/init.el :mkdirp yes
</span><span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">init.el -*- lexical-binding: t; -*-
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">doom!</span> <span style="color: #a626a4; background-color: #e7e7e7;">:completion</span><span class="ef-ob"> vertico
       </span><span style="color: #a626a4; background-color: #e7e7e7;">:editor</span><span class="ef-ob"> evil
       </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob"> (default +bindings))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :tangle ../doom.orgdev/packages.el :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">unpin!</span><span class="ef-ob"> org) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">there be bugs
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :tangle ../doom.orgdev/config.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org</span><span class="ef-ob">)
(load-theme 'modus-operandi t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Visual Settings</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Font Face</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Setting fonts</span>

'Fira Code' is nice, and 'Overpass' makes for a nice sans companion. We just need to
fiddle with the font sizes a tad so that they visually match. Just for fun I'm
trying out JetBrains Mono though. So far I have mixed feelings on it, some
aspects are nice, but on others I prefer Fira.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-font (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"JetBrains Mono"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:size</span><span class="ef-ob"> 24)
      doom-big-font (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"JetBrains Mono"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:size</span><span class="ef-ob"> 36)
      doom-variable-pitch-font (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Overpass"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:size</span><span class="ef-ob"> 26)
      doom-symbol-font (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"JuliaMono"</span><span class="ef-ob">)
      doom-emoji-font (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Twitter Color Emoji"</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Just used by me
</span><span class="ef-ob">      doom-serif-font (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"IBM Plex Mono"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:size</span><span class="ef-ob"> 22 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> 'light))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt Screenshot of the fonts within Emacs.</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/font-face.png]]</span>

In addition to these fonts, Merriweather is used with <span style="color: #84888b;">=nov.el=</span>, and Alegreya as a
serifed proportional font used by <span style="color: #84888b;">=mixed-pitch-mode=</span> for <span style="color: #84888b;">=writeroom-mode=</span> with Org
files.

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Emojis</span>

Emacs (28+) has an <span style="color: #84888b;">~emoji~</span> script table. We're about to use it, but before doing
so we're going to excise a few characters that I actually want rendered as
using the symbol font (not as emojis).

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (char '(?⏩ ?⏪ ?❓))
  (set-char-table-range char-script-table char 'symbol))
</span><span class="ef-obe">#+end_src
</span>
To actually sort out emojis, all that's really needed here is to apply
<span style="color: #84888b;">=doom-emoji-font=</span>, which needs to be done <span style="text-decoration: italic;">/here/</span> because it's not <span style="text-decoration: italic;">/actually/</span> a Doom
font variable, but rather my own addition.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'after-setting-font-hook
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+emoji-set-font</span><span class="ef-ob"> ()
    (set-fontset-font t 'emoji doom-emoji-font nil 'prepend)))
</span><span class="ef-obe">#+end_src
</span>
We might as well also construct a regexp to make identifying emojis if buffers
more convenient.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+emoji-rx</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (emojis)
    (map-char-table
     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (char set)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq set 'emoji)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (copy-tree char) emojis)))
     char-script-table)
    (rx-to-string `(any ,@emojis)))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A regexp to find all emoji-script characters."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
For the sake of convenient insertion, we'll also register some emoji aliases
based on common usage.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> emoji-alternate-names
      '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"🙂"</span> <span style="color: #50a14f; background-color: #e7e7e7;">":)"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😄"</span> <span style="color: #50a14f; background-color: #e7e7e7;">":D"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😉"</span> <span style="color: #50a14f; background-color: #e7e7e7;">";)"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🙁"</span> <span style="color: #50a14f; background-color: #e7e7e7;">":("</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😆"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"laughing face"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"xD"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🤣"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ROFL face"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😢"</span> <span style="color: #50a14f; background-color: #e7e7e7;">":'("</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🥲"</span> <span style="color: #50a14f; background-color: #e7e7e7;">":')"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😮"</span> <span style="color: #50a14f; background-color: #e7e7e7;">":o"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😑"</span> <span style="color: #50a14f; background-color: #e7e7e7;">":|"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😎"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cool face"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🤪"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"goofy face"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🤥"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"pinnochio face"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"liar face"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😠"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&gt;:("</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😡"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"angry+ face"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🤬"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"swearing face"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🤢"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"sick face"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"😈"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"smiling imp"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"👿"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"frowning imp"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"❤️"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;3"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"🫡"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o7"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"👍"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"+1"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"👎"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-1"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"👈"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"left"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"👉"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"right"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"👆"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"up"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"💯"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"100"</span><span class="ef-ob">)
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"💸"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"flying money"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
Lastly, when using Emacs 28+ it would be nice to open the nice emoji dispatch
with the leader key as well as <span style="color: #84888b;">=C-x 8 e=</span>. Since <span style="color: #84888b;">=SPC e=</span> is unclaimed, let's just use
that until we have a better use for it (we could also split up the insertion and
querying commands in other parts of the map).

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt;= emacs-major-version 29)
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:leader</span><span class="ef-ob">
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:prefix</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emoji"</span><span class="ef-ob">)
         </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Search"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"s"</span><span class="ef-ob"> #'emoji-search
         </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Recent"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"r"</span><span class="ef-ob"> #'emoji-recent
         </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"List"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"l"</span><span class="ef-ob"> #'emoji-list
         </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Describe"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"d"</span><span class="ef-ob"> #'emoji-describe
         </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Insert"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"i"</span><span class="ef-ob"> #'emoji-insert
         </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Insert"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob"> #'emoji-insert)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Checking the system</span>

Because we care about how things look let's add a check to make sure we're told
if the system doesn't have any of those fonts. We can obtain a list of installed
fonts with either <span style="color: #84888b;">~(font-family-list)~</span> or with the <span style="color: #84888b;">~fc-list~</span> command.

<span style="color: #84888b;">#+name: detect-missing-fonts</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> required-fonts '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"JetBrains ?Mono.*"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Overpass"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"JuliaMono"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"IBM Plex Mono"</span>
                       <span style="color: #50a14f; background-color: #e7e7e7;">"Merriweather"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Alegreya"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Twitter Color Emoji"</span><span class="ef-ob">))

(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> available-fonts
      (delete-dups
       (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (font-family-list)
           (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"fc-list"</span><span class="ef-ob">)
                (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
                  (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"fc-list"</span><span class="ef-ob"> nil t nil </span><span style="color: #50a14f; background-color: #e7e7e7;">":"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"family"</span><span class="ef-ob">)
                  (split-string (buffer-string) </span><span style="color: #50a14f; background-color: #e7e7e7;">"[,\n]"</span><span class="ef-ob">))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> missing-fonts
      (delq nil (mapcar
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (font)
                   (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (delq nil (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (f)
                                               (string-match-p (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"^%s$"</span><span class="ef-ob"> font) f))
                                             available-fonts))
                     font))
                 required-fonts)))
</span><span class="ef-obe">#+end_src
</span>
We can then use this to create a <span style="color: #84888b;">=doctor=</span> check.

<span class="ef-obb">#+begin_src emacs-lisp :noweb yes :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (required-fonts available-fonts missing-fonts)
  &lt;&lt;detect-missing-fonts&gt;&gt;
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> available-fonts
      (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (font missing-fonts)
        (warn! (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Missing font: %s."</span><span class="ef-ob"> font)))
    (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Unable to check for missing fonts, is fc-list installed?"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
Furthermore, when fonts <span style="text-decoration: italic;">/are/</span> missing, it could be good to check the state of
affairs on startup.

<span style="color: #84888b;">#+name: warn-missing-fonts</span>
<span class="ef-obb">#+begin_src emacs-lisp :tangle no :noweb yes :noweb-ref none
</span><span class="ef-ob">&lt;&lt;detect-missing-fonts&gt;&gt;

(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> missing-fonts
    (pp-to-string
     `(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> noninteractive
        (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'doom-init-ui-hook
          (run-at-time nil nil
                       (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> ()
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (required-fonts available-fonts missing-fonts)
                           &lt;&lt;detect-missing-fonts&gt;&gt;
                           (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s missing the following fonts: %s"</span><span class="ef-ob">
                                    (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Warning!"</span><span class="ef-ob"> 'face '(bold warning))
                                    (mapconcat (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (font)
                                                 (propertize font 'face 'font-lock-variable-name-face))
                                               ',missing-fonts
                                               </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">)))
                         (sleep-for 0.5))))))
  </span><span style="color: #50a14f; background-color: #e7e7e7;">";; No missing fonts detected"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">&lt;&lt;warn-missing-fonts()&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
This way whenever fonts are missing, after Doom's UI has initialised, a warning
listing the missing fonts should appear for at least half a second.

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Theme</span>

The <span style="color: #84888b;">~doom-one~</span> theme is nice and all, but I find the <span style="color: #84888b;">~vibrant~</span> variant nicer. With
the light themes, I rather like <span style="color: #84888b;">~doom-tomorrow-day~</span>. I'd like to pick the default
from them based on the system theme. Thanks to the continued expansion of the
<span style="color: #84888b;">=xdg-desktop-portal=</span> protocols, we can read this from D-Bus on most systems.

<span style="color: #84888b;">#+name: default-theme</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((light-theme 'doom-tomorrow-day)
      (dark-theme 'doom-vibrant)
      (system-theme
       (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (memq system-type '(gnu gnu/linux gnu/kfreebsd))
                (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">dbus</span><span class="ef-ob"> nil t)
                (caar
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob">
                   (dbus-call-method
                    </span><span style="color: #a626a4; background-color: #e7e7e7;">:session</span>
                    <span style="color: #50a14f; background-color: #e7e7e7;">"org.freedesktop.portal.Desktop"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"/org/freedesktop/portal/desktop"</span>
                    <span style="color: #50a14f; background-color: #e7e7e7;">"org.freedesktop.portal.Settings"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Read"</span>
                    <span style="color: #50a14f; background-color: #e7e7e7;">"org.freedesktop.appearance"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"color-scheme"</span><span class="ef-ob">))))
           0)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> system-theme
    (1 dark-theme)
    (2 light-theme)
    (_ dark-theme)))
</span><span class="ef-obe">#+end_src
</span>
We'll use the appropriate theme as the default, but let's also accept the theme
as an environment variable <span style="color: #84888b;">=DOOM_THEME=</span> for fun.

<span class="ef-obb">#+begin_src emacs-lisp :noweb yes
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-theme </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Set according to the env var or system-dependent default
</span><span class="ef-ob">      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((env-theme (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"DOOM_THEME"</span><span class="ef-ob">)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> env-theme
            (intern env-theme) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Note: `</span><span style="color: #b751b6; background-color: #e7e7e7;">intern-soft</span><span style="color: #84888b; background-color: #e7e7e7;">' doesn't work here
</span><span class="ef-ob">          '&lt;&lt;default-theme()&gt;&gt;)))
</span><span class="ef-obe">#+end_src
</span>
Oh, and with the nice selection doom provides there's no reason for me to want
the defaults.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">delq!</span><span class="ef-ob"> t custom-theme-load-path)
</span><span class="ef-obe">#+end_src
</span>
While the theme environment variable is nice for flexibility, when starting
Emacs in a terminal it doesn't help us set the right sort of theme
automatically. However, we can check if we're in a terminal and pick a default
theme colour accordingly.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">declare-function</span><span class="ef-ob"> 'xterm-query </span><span style="color: #50a14f; background-color: #e7e7e7;">"xterm"</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">term-background-rgb</span><span class="ef-ob"> nil
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A RGB triple corresponding to the current terminal background, if known."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+interpret-term-bg</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Examine an OSC color query response, and set `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">term-background-rgb</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' accordingly."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((str </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
        chr)
    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">The reply should be: \e ] 11 ; rgb: NUMBER1 / NUMBER2 / NUMBER3 \e \\
</span><span class="ef-ob">    (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> chr (xterm--read-event-for-query)) (not (equal chr ?\\)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> str (concat str (string chr))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match
           </span><span style="color: #50a14f; background-color: #e7e7e7;">"rgb:</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[a-f0-9]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[a-f0-9]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[a-f0-9]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> str)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((r (string-to-number (match-string 1 str) 16))
            (g (string-to-number (match-string 2 str) 16))
            (b (string-to-number (match-string 3 str) 16)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> term-background-rgb (list r g b))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+doom-init-theme-termaware</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Update `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">doom-theme</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' if in a terminal, unless DOOM_THEME has been set."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (term-shade)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (display-graphic-p (selected-frame)))
               (not (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"DOOM_THEME"</span><span class="ef-ob">))
               (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">xterm</span><span class="ef-ob"> nil t))
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Querying terminal background color"</span><span class="ef-ob">)
      (xterm--query </span><span style="color: #50a14f; background-color: #e7e7e7;">"\e]11;?\e\\"</span><span class="ef-ob"> '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"\e]11;"</span><span class="ef-ob"> . +interpret-term-bg)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> term-background-rgb
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> term-shade (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt; (apply #'+ term-background-rgb) (* 0.6 3 65535))
                             'dark 'light))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> term-shade
          ('dark (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-theme 'doom-vibrant))
          ('light (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-theme 'doom-tomorrow-day)))))
    (doom-init-theme-h)))
</span><span class="ef-obe">#+end_src
</span>
Lastly, I had some issues with theme race conditions, which seem to be resolved
by moving <span style="color: #84888b;">=doom-init-theme-h=</span> around. Henrik attempted to help with this in May
2021 but we didn't manage to pin down the issue. It may be worth periodically
checking back and seeing if this is still needed. We might as well inject
<span style="color: #84888b;">~+doom-init-theme-termaware~</span> while we're at it.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(remove-hook 'window-setup-hook #'doom-init-theme-h)
(remove-hook 'after-init-hook   #'doom-init-theme-h)
(add-hook    'after-init-hook   #'+doom-init-theme-termaware 'append)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Line numbers</span>

Relative line numbers are fantastic for knowing how far away line numbers are,
then <span style="color: #84888b;">=ESC 12 &lt;UP&gt;=</span> gets you exactly where you think.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> display-line-numbers-type 'relative)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Some helper macros</span>

There are a few handy macros added by doom, namely
- <span style="color: #84888b;">~load!~</span> for loading external <span style="color: #84888b;">~.el~</span> files relative to this one
- <span style="color: #84888b;">~use-package!~</span> for configuring packages
- <span style="color: #84888b;">~add-load-path!~</span> for adding directories to the <span style="color: #84888b;">~load-path~</span> where <span style="color: #84888b;">~Emacs~</span> looks when
  you load packages with <span style="color: #84888b;">~require~</span> or <span style="color: #84888b;">~use-package~</span>
- <span style="color: #84888b;">~map!~</span> for binding new keys

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Allow babel execution in CLI actions</span>

In this config I sometimes generate code to include in my config.
This works nicely, but for it to work with <span style="color: #84888b;">=doom sync=</span> et. al. I need to make sure
that Org doesn't try to confirm that I want to allow evaluation (I do!).

Thankfully Doom supports <span style="color: #84888b;">=$DOOMDIR/cli.el=</span> file which is sourced every time a CLI
command is run, so we can just enable evaluation by setting
<span style="color: #84888b;">~org-confirm-babel-evaluate~</span> to <span style="color: #84888b;">~nil~</span> there.
While we're at it, we should silence <span style="color: #84888b;">~org-babel-execute-src-block~</span> to
avoid polluting the output.

<span class="ef-obb">#+begin_src emacs-lisp :tangle cli.el :noweb-ref none
</span><span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">cli.el -*- lexical-binding: t; -*-
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-confirm-babel-evaluate nil)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">doom-shut-up-a</span><span class="ef-ob"> (orig-fn </span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> args)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">quiet!</span><span class="ef-ob"> (apply orig-fn args)))

(advice-add 'org-babel-execute-src-block </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'doom-shut-up-a)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Elisp REPL</span>

I think an elisp REPL sounds like a fun idea, even if not a particularly useful
one 😛. We can do this by adding a new command in <span style="color: #84888b;">=cli.el=</span>.

<span class="ef-obb">#+begin_src emacs-lisp :tangle cli.el :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defcli!</span><span class="ef-ob"> repl ((in-rlwrap-p (</span><span style="color: #50a14f; background-color: #e7e7e7;">"--rl"</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">"For internal use only."</span><span class="ef-ob">))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Start an elisp REPL."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">core-start</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"rlwrap"</span><span class="ef-ob">) (not in-rlwrap-p))
    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">For autocomplete
</span><span class="ef-ob">    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> autocomplete-file </span><span style="color: #50a14f; background-color: #e7e7e7;">"/tmp/doom_elisp_repl_symbols"</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p autocomplete-file)
      (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\e[0;33mInitialising autocomplete list...\e[0m\n"</span><span class="ef-ob">)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
        (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-do-all-symbols</span><span class="ef-ob"> (s)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((sym (symbol-name s)))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`[[:ascii:]][[:ascii:]]+\\'"</span><span class="ef-ob"> sym)
              (insert sym </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))))
        (write-region nil nil autocomplete-file)))
    (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\e[F"</span><span class="ef-ob">)
    (exit! </span><span style="color: #50a14f; background-color: #e7e7e7;">"rlwrap"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-f"</span><span class="ef-ob"> autocomplete-file
           (concat doom-emacs-dir </span><span style="color: #50a14f; background-color: #e7e7e7;">"bin/doom"</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">"repl"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"--rl"</span><span class="ef-ob">))

  (doom-initialize-packages)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">engrave-faces-ansi</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> engrave-faces-ansi-color-mode '3-bit)

  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">For some reason (require 'parent-mode) doesn't work :(
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">parent-mode-list</span><span class="ef-ob"> (mode)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return a list of MODE and all its parent modes.

The returned list starts with the parent-most mode and ends with MODE."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((result ()))
      (parent-mode--worker mode (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (mode)
                                  (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> mode result)))
      result))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">parent-mode--worker</span><span class="ef-ob"> (mode func)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"For MODE and all its parent modes, call FUNC.

FUNC is first called for MODE, then for its parent, then for the parent's
parent, and so on.

MODE shall be a symbol referring to a function.
FUNC shall be a function taking one argument."</span><span class="ef-ob">
    (funcall func mode)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (not (fboundp mode))
      (</span><span style="color: #986801; background-color: #e7e7e7;">signal</span><span class="ef-ob"> 'void-function (list mode)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((modefunc (symbol-function mode)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (symbolp modefunc)
          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Hande all the modes that use (defalias 'foo-parent-mode (stuff)) as
</span>          <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">their parent
</span><span class="ef-ob">          (parent-mode--worker modefunc func)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((parentmode (get mode 'derived-mode-parent)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> parentmode
            (parent-mode--worker parentmode func))))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">provide</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">parent-mode</span><span class="ef-ob">)
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Some extra highlighting (needs parent-mode)
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">rainbow-delimiters</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">highlight-quoted</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">highlight-numbers</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> emacs-lisp-mode-hook '(rainbow-delimiters-mode
                               highlight-quoted-mode
                               highlight-numbers-mode))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Pretty print
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">pp-sexp</span><span class="ef-ob"> (sexp)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
      (cl-prettyprint sexp)
      (emacs-lisp-mode)
      (font-lock-ensure)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> (engrave-faces-ansi-buffer)
        (princ (string-trim (buffer-string)))
        (kill-buffer (current-buffer)))))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Now do the REPL
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">accumulated-input</span><span class="ef-ob"> nil)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> t
    (</span><span style="color: #e45649; background-color: #e7e7e7;">condition-case</span><span class="ef-ob"> nil
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((input (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> accumulated-input
                         (read-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\e[31m .\e[0m  "</span><span class="ef-ob">)
                       (read-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\e[31mλ:\e[0m "</span><span class="ef-ob">))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> input (concat accumulated-input
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> accumulated-input </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
                              input))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
           ((string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`[[:space:]]*\\'"</span><span class="ef-ob"> input)
            nil)
           ((string= input </span><span style="color: #50a14f; background-color: #e7e7e7;">"exit"</span><span class="ef-ob">)
            (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">) (kill-emacs 0))
           (t
            (</span><span style="color: #e45649; background-color: #e7e7e7;">condition-case</span><span class="ef-ob"> err
                (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((input-sexp (car (read-from-string input))))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> accumulated-input nil)
                  (pp-sexp (eval input-sexp))
                  (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
              </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Caused when sexp in unbalanced
</span><span class="ef-ob">              (end-of-file (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> accumulated-input input))
              (</span><span style="color: #986801; background-color: #e7e7e7;">error</span><span class="ef-ob">
               (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-destructuring-bind</span><span class="ef-ob"> (backtrace </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> type data . _)
                   (cons (doom-cli--backtrace) err)
                 (princ (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"\e[1;31mERROR:\e[0m "</span><span class="ef-ob"> (get type 'error-message)))
                 (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n       "</span><span class="ef-ob">)
                 (pp-sexp (cons type data))
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> backtrace
                   (</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span><span class="ef-ob"> (bold </span><span style="color: #50a14f; background-color: #e7e7e7;">"Backtrace:"</span><span class="ef-ob">))
                   (</span><span style="color: #e45649; background-color: #e7e7e7;">print-group!</span><span class="ef-ob">
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (frame (seq-take backtrace 10))
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span>
                       <span style="color: #50a14f; background-color: #e7e7e7;">"%0.74s"</span><span class="ef-ob"> (replace-regexp-in-string
                                 </span><span style="color: #50a14f; background-color: #e7e7e7;">"[\n\r]"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\n"</span><span class="ef-ob">
                                 (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%S"</span><span class="ef-ob"> frame))))))
                 (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)))))))
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">C-d causes an end-of-file error
</span><span class="ef-ob">      (end-of-file (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"exit\n"</span><span class="ef-ob">) (kill-emacs 0)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> accumulated-input (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Htmlize command</span>

Why not have a command to htmlize files? This is basically a little test of my
engrave-faces package because it somehow seems to work without a GUI, while the
htmlize package doesn't.

<span class="ef-obb">#+begin_src emacs-lisp :tangle cli.el :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defcli!</span><span class="ef-ob"> htmlize (file)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Export a FILE buffer to HTML."</span><span class="ef-ob">

  (</span><span style="color: #e45649; background-color: #e7e7e7;">print!</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Htmlizing %s"</span><span class="ef-ob"> file)

  (doom-initialize)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">highlight-numbers</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">highlight-quoted</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">rainbow-delimiters</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">engrave-faces-html</span><span class="ef-ob">)

  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Lighten org-mode
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string= </span><span style="color: #50a14f; background-color: #e7e7e7;">"org"</span><span class="ef-ob"> (file-name-extension file))
    (setcdr (assoc 'org after-load-alist) nil)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-load-hook nil)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-mode-hook nil)
    (add-hook 'engrave-faces-before-hook
              (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq major-mode 'org-mode)
                        (org-show-all)))))

  (engrave-faces-html-file file))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Org buffer creation</span>

Let's make creating an Org buffer just that little bit easier.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(evil-define-command +evil-buffer-org-new (_count file)
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Creates a new ORG buffer replacing the current window, optionally
   editing a certain FILE"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:repeat</span><span class="ef-ob"> nil
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span> <span style="color: #50a14f; background-color: #e7e7e7;">"P&lt;f&gt;"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> file
      (evil-edit file)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((buffer (generate-new-buffer </span><span style="color: #50a14f; background-color: #e7e7e7;">"*new org*"</span><span class="ef-ob">)))
      (set-window-buffer nil buffer)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> buffer
        (org-mode)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> doom-real-buffer-p t)))))

(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:leader</span><span class="ef-ob">
      (</span><span style="color: #a626a4; background-color: #e7e7e7;">:prefix</span> <span style="color: #50a14f; background-color: #e7e7e7;">"b"</span>
       <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"New empty Org buffer"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o"</span><span class="ef-ob"> #'+evil-buffer-org-new))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Dashboard</span>

<span style="color: #84888b;">#+call: confpkg()</span>

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** A fancy splash screen</span>

<span style="color: #84888b;">#+call: confpkg("fancy-splash", prefix="")</span>

Emacs can render an image as the splash screen, but I think we can do better
than just a completely static image. Since, SVG images in particular are
supported, we can use them as the basis for a fancier splash screen image setup
--- with themeable, resizing images.

With the effort I'm putting into this, it would be nice to have a good image,
and <span style="color: #4078f2; font-weight: 700;">[[https://github.com/MarioRicalde][@MarioRicalde]]</span> came up with a cracker! He's also provided me with a nice
Emacs-style <span style="text-decoration: italic;">/E/</span>. I was using the black-hole image, but when I stripped down the
splash screen to something more minimal I switched to just using the <span style="text-decoration: italic;">/E/</span>.

<span style="color: #84888b;">#+attr_latex: :width 0.2\linewidth</span>
<span style="color: #84888b;">#+attr_html: :style width:20% :alt Fancy Emacs "E"</span>
<span style="color: #4078f2; font-weight: 700;">[[file:misc/splash-images/emacs-e-template.svg]]</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">fancy-splash-image-directory</span><span class="ef-ob">
  (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"misc/splash-images/"</span><span class="ef-ob"> doom-user-dir)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Directory in which to look for splash image templates."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">fancy-splash-image-template</span><span class="ef-ob">
  (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"emacs-e-template.svg"</span><span class="ef-ob"> fancy-splash-image-directory)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Default template svg used for the splash image.
Colours are substituted as per `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">fancy-splash-template-colours</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Special named colours can be used as the basis for theming, with a simple
replacement system.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">fancy-splash-template-colours</span><span class="ef-ob">
  '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"#111112"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> default   </span><span style="color: #a626a4; background-color: #e7e7e7;">:attr</span> <span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#8b8c8d"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> shadow)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#eeeeef"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> default   </span><span style="color: #a626a4; background-color: #e7e7e7;">:attr</span> <span style="color: #a626a4; background-color: #e7e7e7;">:background</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#e66100"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> highlight </span><span style="color: #a626a4; background-color: #e7e7e7;">:attr</span> <span style="color: #a626a4; background-color: #e7e7e7;">:background</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#1c71d8"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> font-lock-keyword-face)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#f5c211"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> font-lock-type-face)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#813d9c"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> font-lock-constant-face)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#865e3c"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> font-lock-function-name-face)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#2ec27e"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> font-lock-string-face)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#c01c28"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> error)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#000001"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-black)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#ff0000"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-red)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#ff00ff"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-magenta)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#00ff00"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-green)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#ffff00"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-yellow)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#0000ff"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-blue)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#00ffff"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-cyan)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"#fffffe"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ansi-color-white))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Alist of colour-replacement plists.
Each plist is of the form (\"$placeholder\" :doom-color 'key :face 'face).
If the current theme is a doom theme :doom-color will be used,
otherwise the colour will be face foreground."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
If we want to make sure an image is themed, we can look for unrecognised hex
strings that are not greyscale (as greyscale can be expected in the form of a
transparent overlay).

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-check-buffer</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Check the current SVG buffer for bad colours."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq major-mode 'image-mode)
    (xml-mode))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">featurep</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">rainbow-mode</span><span class="ef-ob">)
             (not (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> rainbow-mode)))
    (rainbow-mode 1))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((colours (mapcar #'car fancy-splash-template-colours))
         (colourise-hex
          (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (hex)
            (propertize
             hex
             'face `((</span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">
                      ,(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt; 0.5
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-destructuring-bind</span><span class="ef-ob"> (r g b) (x-color-values hex)
                                </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Values taken from `</span><span style="color: #b751b6; background-color: #e7e7e7;">rainbow-color-luminance</span><span style="color: #84888b; background-color: #e7e7e7;">'
</span><span class="ef-ob">                                (/ (+ (* .2126 r) (* .7152 g) (* .0722 b))
                                   (* 256 255 1.0))))
                           </span><span style="color: #50a14f; background-color: #e7e7e7;">"white"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"black"</span><span class="ef-ob">)
                      (</span><span style="color: #a626a4; background-color: #e7e7e7;">:background</span><span class="ef-ob"> ,hex))))))
         (cn 96)
         (colour-menu-entries
          (mapcar
           (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (colour)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> cn)
             (cons cn
                   (cons
                    (substring-no-properties colour)
                    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">" (%s) %s %s"</span><span class="ef-ob">
                            (propertize (char-to-string cn)
                                        'face 'font-lock-keyword-face)
                            (funcall colourise-hex colour)
                            (propertize
                             (symbol-name
                              (plist-get
                               (cdr (assoc colour fancy-splash-template-colours))
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob">))
                             'face 'shadow)))))
           colours))
         (colour-menu-template
          (format
           </span><span style="color: #50a14f; background-color: #e7e7e7;">"Colour %%s is unexpected! Should this be one of the following?\n
%s
 %s to ignore
 %s to quit"</span><span class="ef-ob">
           (mapconcat
            #'cddr
            colour-menu-entries
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
           (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"SPC"</span><span class="ef-ob"> 'face 'font-lock-keyword-face)
           (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"ESC"</span><span class="ef-ob"> 'face 'font-lock-keyword-face)))
         (colour-menu-choice-keys
          (append (mapcar #'car colour-menu-entries)
                  (list ?\s)))
         (buf (get-buffer-create </span><span style="color: #50a14f; background-color: #e7e7e7;">"*fancy-splash-lint-colours-popup*"</span><span class="ef-ob">))
         (good-colour-p
          (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (colour)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (assoc colour fancy-splash-template-colours)
                </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Check if greyscale
</span><span class="ef-ob">                (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (= (length colour) 4)
                         (= (aref colour 1)   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">r
</span><span class="ef-ob">                            (aref colour 2)   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">g
</span><span class="ef-ob">                            (aref colour 3))) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">b
</span><span class="ef-ob">                    (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (= (length colour) 7)
                         (string= (substring colour 1 3)       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">rr =
</span><span class="ef-ob">                                  (substring colour 3 5))      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">gg
</span><span class="ef-ob">                         (string= (substring colour 3 5)       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">gg =
</span><span class="ef-ob">                                  (substring colour 5 7))))))) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">bb
</span><span class="ef-ob">         (prompt-to-replace
          (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (target)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> buf
              (erase-buffer)
              (insert (format colour-menu-template
                              (funcall colourise-hex target)))
              (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> cursor-type nil)
              (set-buffer-modified-p nil)
              (goto-char (point-min)))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">save-window-excursion</span><span class="ef-ob">
              (pop-to-buffer buf)
              (fit-window-to-buffer (get-buffer-window buf))
              (car (alist-get
                    (read-char-choice
                     (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Select replacement, %s-%s or SPC: "</span><span class="ef-ob">
                             (char-to-string (caar colour-menu-entries))
                             (char-to-string (caar (last colour-menu-entries))))
                     colour-menu-choice-keys)
                    colour-menu-entries))))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
      (goto-char (point-min))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"#[0-9A-Fa-f]\\{</span><span style="color: #6a1868; background-color: #e7e7e7;">6\\</span><span style="color: #50a14f; background-color: #e7e7e7;">}</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">#[0-9A-Fa-f]\\{</span><span style="color: #6a1868; background-color: #e7e7e7;">3\\</span><span style="color: #50a14f; background-color: #e7e7e7;">}"</span><span class="ef-ob"> nil t)
        (recenter)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((colour (match-string 0))
               (replacement (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (funcall good-colour-p colour))
                                 (funcall prompt-to-replace colour))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> replacement
            (replace-match replacement t t))))
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Done"</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
To make it easier to produce themeable images, we can also provide an Inkscape
colour palette.

<span class="ef-obb">#+begin_src text :tangle ~/.config/inkscape/palettes/Emacs Fancy Splash.gpl :mkdirp yes
</span><span class="ef-ob">GIMP Palette
Name: Emacs Fancy Splash Template
#
 17  17  18 #111112 Foreground
139 140 141 #8b8c8d Shadow
238 238 239 #eeeeef Background
230  97   0 #e66100 Colour 1 (Highlight)
 28 113 216 #1c71d8 Colour 2 (Keyword)
245 194  17 #f5c211 Colour 3 (Type)
129  61 156 #813d9c Colour 4 (Constant)
134  94  60 #865e3c Colour 5 (Function)
 46 194 126 #2ec27e Colour 6 (String)
192  28  40 #c01c28 Colour 7 (Error)
  0   0   1 #000001 Black
255   0   0 #ff0000 Red
255   0 255 #ff00ff Magenta
  0 255   0 #00ff00 Green
255 255   0 #ffff00 Yellow
  0   0 255 #0000ff Blue
  0 255 255 #00ffff Cyan
255 255 254 #fffffe White
</span><span class="ef-obe">#+end_src
</span>
Since we're going to be generating theme-specific versions of splash images, it
would be good to have a cache directory.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">fancy-splash-cache-dir</span><span class="ef-ob"> (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"theme-splashes/"</span><span class="ef-ob"> doom-cache-dir))
</span><span class="ef-obe">#+end_src
</span>
To set up dynamic resizing, we'll use a list specifying the image height at
various frame-height thresholds, with a few extra bells and whistles (such as
the ability to change image too).

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">fancy-splash-sizes</span><span class="ef-ob">
  `((</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 300 </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 50 </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (0 . 2))
    (</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 250 </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 42 </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (2 . 4))
    (</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 200 </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 35 </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (3 . 3))
    (</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 150 </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 28 </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (3 . 3))
    (</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 100 </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 20 </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (2 . 2))
    (</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 75  </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 15 </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (2 . 1))
    (</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 50  </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 10 </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (1 . 0))
    (</span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1   </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob"> 0  </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob"> (0 . 0)))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"List of plists specifying image sizing states.
Each plist should have the following properties:
- :height, the height of the image
- :min-height, the minimum `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">frame-height</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' for image
- :padding, a `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+doom-dashboard-banner-padding</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' (top . bottom) padding
  specification to apply
Optionally, each plist may set the following two properties:
- :template, a non-default template file
- :file, a file to use instead of template"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Now that's we've set up the customisation approach, we need to work out the
mechanics for actually implementing this. To start with, a basic utility
function to get the relevant file path.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-filename</span><span class="ef-ob"> (theme template height)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Get the file name for the splash image with THEME and of HEIGHT."</span><span class="ef-ob">
  (expand-file-name (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s-%s-%d.svg"</span><span class="ef-ob"> theme (file-name-base template) height) fancy-splash-cache-dir))
</span><span class="ef-obe">#+end_src
</span>
Now to go about actually generating the images. To adjust the sizing on demand,
we will offer two mechanisms:
1. A special <span style="color: #84888b;">=$height=</span> token which is replaced with the desired height
2. Recognition of <span style="color: #84888b;">=height=100=</span>, in which case <span style="color: #84888b;">=100=</span> will be replaced with the
   desired height and any <span style="color: #84888b;">=width=</span> property will be removed.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-generate-image</span><span class="ef-ob"> (template height)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Create a themed image from TEMPLATE of HEIGHT.
The theming is performed using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">fancy-splash-template-colours</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
and the current theme."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
    (insert-file-contents template)
    (goto-char (point-min))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"$height"</span><span class="ef-ob"> nil t)
        (replace-match (number-to-string height) t t)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"height=\"100</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">\\.0[0-9]*</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?\""</span><span class="ef-ob"> nil t)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
            (replace-match (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"height=\"%s\""</span><span class="ef-ob"> height) t t)
            (goto-char (point-min))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[ \t\n]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">width=\"[\\.0-9]+\"[ \t\n]*"</span><span class="ef-ob"> nil t)
              (replace-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\1"</span><span class="ef-ob">)))
        (</span><span style="color: #986801; background-color: #e7e7e7;">warn</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Warning! fancy splash template: neither $height nor height=100 not found in %s"</span><span class="ef-ob"> template)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (substitution fancy-splash-template-colours)
      (goto-char (point-min))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((replacement-colour
              (face-attribute (plist-get (cdr substitution) </span><span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob">)
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get (cdr substitution) </span><span style="color: #a626a4; background-color: #e7e7e7;">:attr</span><span class="ef-ob">) </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">)
                              nil 'default))
             (replacement-hex
              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-prefix-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"#"</span><span class="ef-ob"> replacement-colour)
                  replacement-colour
                (apply 'format </span><span style="color: #50a14f; background-color: #e7e7e7;">"#%02x%02x%02x"</span><span class="ef-ob">
                       (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (c) (ash c -8))
                               (color-values replacement-colour))))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (search-forward (car substitution) nil t)
          (replace-match replacement-hex nil nil))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p fancy-splash-cache-dir)
      (make-directory fancy-splash-cache-dir t))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((inhibit-message t))
      (write-region nil nil (fancy-splash-filename (car custom-enabled-themes) template height)))))
</span><span class="ef-obe">#+end_src
</span>
We may as well generate each theme's appropriate images in bunk.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-generate-all-images</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Perform `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">fancy-splash-generate-image</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' in bulk."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (size fancy-splash-sizes)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (plist-get size </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">)
      (fancy-splash-generate-image
       (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get size </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob">)
           fancy-splash-image-template)
       (plist-get size </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob">)))))
</span><span class="ef-obe">#+end_src
</span>
It would be nice to have a simple check function which will just generate the
set of relevant images if needed, and do nothing if they already exist.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-ensure-theme-images-exist</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> height)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Ensure that the relevant images exist.
Use the image of HEIGHT to check, defaulting to the height of the first
specification in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">fancy-splash-sizes</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'. If that file does not exist for
the current theme, `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">fancy-splash-generate-all-images</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' is called. "</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p
           (fancy-splash-filename
            (car custom-enabled-themes)
            fancy-splash-image-template
            (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> height (plist-get (car fancy-splash-sizes) </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob">))))
    (fancy-splash-generate-all-images)))
</span><span class="ef-obe">#+end_src
</span>
In case we switch out the images used (or something else goes wrong), it would
be good to have a convenient method to clear this cache.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-clear-cache</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> delete-files)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Clear all cached fancy splash images.
Optionally delete all cache files and regenerate the currently relevant set."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob"> (list t))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (size fancy-splash-sizes)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (plist-get size </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((image-file
             (fancy-splash-filename
              (car custom-enabled-themes)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get size </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob">)
                  fancy-splash-image-template)
              (plist-get size </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob">))))
        (image-flush (create-image image-file) t))))
  (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Fancy splash image cache cleared!"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> delete-files
    (delete-directory fancy-splash-cache-dir t)
    (fancy-splash-generate-all-images)
    (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Fancy splash images cache deleted!"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
In a similar way, it could be fun to allow for switching the template used. We
can support this by looking for files ending in <span style="color: #84888b;">=-template.svg=</span> and running
<span style="color: #84888b;">~image-flush~</span> via <span style="color: #84888b;">~fancy-splash-clear-cache~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-switch-template</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Switch the template used for the fancy splash image."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((new (completing-read
              </span><span style="color: #50a14f; background-color: #e7e7e7;">"Splash template: "</span><span class="ef-ob">
              (mapcar
               (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (template)
                 (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"-template\\.svg$"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> template))
               (directory-files fancy-splash-image-directory nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"-template\\.svg\\'"</span><span class="ef-ob">))
              nil t)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> fancy-splash-image-template
          (expand-file-name (concat new </span><span style="color: #50a14f; background-color: #e7e7e7;">"-template.svg"</span><span class="ef-ob">) fancy-splash-image-directory))
    (fancy-splash-clear-cache)
    (message </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Clear message from `</span><span style="color: #b751b6; background-color: #e7e7e7;">fancy-splash-clear-cache</span><span style="color: #84888b; background-color: #e7e7e7;">'.
</span><span class="ef-ob">    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> fancy-splash--last-size nil)
    (fancy-splash-apply-appropriate-image)))
</span><span class="ef-obe">#+end_src
</span>
Now we can ensure that the desired images exist, we need to work out which
particular one we want. This is really just a matter of comparing the frame
height to the set of presets.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-get-appropriate-size</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Find the firt `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">fancy-splash-sizes</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' with min-height of at least frame height."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((height (frame-height)))
    (cl-some (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (size) (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt;= height (plist-get size </span><span style="color: #a626a4; background-color: #e7e7e7;">:min-height</span><span class="ef-ob">)) size))
             fancy-splash-sizes)))
</span><span class="ef-obe">#+end_src
</span>
We now want to apply the appropriate image to the dashboard. At the same time,
we don't want to do so needlessly, so we may as well record the size and theme
to determine when a refresh is actually needed.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> fancy-splash--last-size nil)
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> fancy-splash--last-theme nil)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">fancy-splash-apply-appropriate-image</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> _)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Ensure the appropriate splash image is applied to the dashboard.
This function's signature is \"&amp;rest _\" to allow it to be used
in hooks that call functions with arguments."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((appropriate-size (fancy-splash-get-appropriate-size)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (equal appropriate-size fancy-splash--last-size)
                 (equal (car custom-enabled-themes) fancy-splash--last-theme))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (plist-get appropriate-size </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">)
        (fancy-splash-ensure-theme-images-exist (plist-get appropriate-size </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob">)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> fancy-splash-image
            (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get appropriate-size </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">)
                (fancy-splash-filename (car custom-enabled-themes)
                                       fancy-splash-image-template
                                       (plist-get appropriate-size </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob">)))
            +doom-dashboard-banner-padding (plist-get appropriate-size </span><span style="color: #a626a4; background-color: #e7e7e7;">:padding</span><span class="ef-ob">)
            fancy-splash--last-size appropriate-size
            fancy-splash--last-theme (car custom-enabled-themes))
      (+doom-dashboard-reload))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** ASCII banner</span>

If we're operating in a terminal (or <span style="color: #84888b;">=emacclient=</span>) we see an ASCII banner instead
of the graphical one. I'd also like to use something simple for this.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">doom-dashboard-draw-ascii-emacs-banner-fn</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((banner
          '(</span><span style="color: #50a14f; background-color: #e7e7e7;">",---.,-.-.,---.,---.,---."</span>
            <span style="color: #50a14f; background-color: #e7e7e7;">"|---'| | |,---||    `---."</span>
            <span style="color: #50a14f; background-color: #e7e7e7;">"`</span><span style="color: #b751b6; background-color: #e7e7e7;">---</span><span style="color: #50a14f; background-color: #e7e7e7;">'` ' '`---^`</span><span style="color: #b751b6; background-color: #e7e7e7;">---</span><span style="color: #50a14f; background-color: #e7e7e7;">'`</span><span style="color: #b751b6; background-color: #e7e7e7;">---</span><span style="color: #50a14f; background-color: #e7e7e7;">'"</span><span class="ef-ob">))
         (longest-line (apply #'max (mapcar #'length banner))))
    (put-text-property
     (point)
     (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (line banner (point))
       (insert (+doom-dashboard--center
                +doom-dashboard--width
                (concat
                 line (make-string (max 0 (- longest-line (length line)))
                                   32)))
               </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
     'face 'doom-dashboard-banner)))
</span><span class="ef-obe">#+end_src
</span>
Now we just need this as Doom's ASCII banner function.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (display-graphic-p) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">for some reason this messes up the graphical splash screen atm
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +doom-dashboard-ascii-banner-fn #'doom-dashboard-draw-ascii-emacs-banner-fn))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Splash phrases</span>

<span style="color: #84888b;">#+call: confpkg("splash-phrases", prefix="")</span>

Having an aesthetically pleasing image is all very well and good, but I'm aiming
for minimal, not clinical --- it would be good to inject some fun into the
dashboard. After trawling around the internet for a bit, I've found three
sources of fun phrases, namely:
+ a nonsense corporate jargon generator,
+ a selection of random developer excuses, and
+ a collection of fun but rather useless facts.

I used to have a fancy method that used web APIs for these and inserted an
invisible placeholder into the dashboard which was asynchronously replaced on
the result of (debounced) requests to the APIs. While that actually worked quite
well, I realised that it would be much better and simpler if I simply copied the
phrases sources to local files and did the random selection / generation in
elisp.

Let's start off by setting the local folder to put the phrase source files in.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">splash-phrase-source-folder</span><span class="ef-ob">
  (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"misc/splash-phrases"</span><span class="ef-ob"> doom-user-dir)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A folder of text files with a fun phrase on each line."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Now we want to support two "phrase systems"
1. A complete file of phrases, one phrase per line
2. A collection of phrase-components, put together to form a phrase

It would be good to specify/detect which of the two cases apply based on the
file name alone. I've done this by setting the simple check that if the file
name contains <span style="color: #84888b;">=-N-=</span> (where <span style="color: #84888b;">=N=</span> is some number) then it is taken as the <span style="color: #84888b;">=N=​</span>th phrase
component, with everything preceding the <span style="color: #84888b;">=-N-=</span> token taken as the collection
identifier, and everything after <span style="color: #84888b;">=-N-=</span> ignored.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">splash-phrase-sources</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((files (directory-files splash-phrase-source-folder nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.txt\\'"</span><span class="ef-ob">))
         (sets (delete-dups (mapcar
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (file)
                               (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">-[0-9]+-\\w+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?\\.txt"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> file))
                             files))))
    (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (sset)
              (cons sset
                    (delq nil (mapcar
                               (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (file)
                                 (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match-p (regexp-quote sset) file)
                                   file))
                               files))))
            sets))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A list of cons giving the phrase set name, and a list of files which contain phrase components."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Let's fix the phrase set in use, and pick a random phrase source on startup.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">splash-phrase-set</span><span class="ef-ob">
  (nth (random (length splash-phrase-sources)) (mapcar #'car splash-phrase-sources))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"The default phrase set. See `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">splash-phrase-sources</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
While having a random set of phrases is fantastic the vast majority of the time,
I expect that occasionally I'll feel in the mood to change the phrase set or
pick a particular one, so some functions for that would be nice.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">splash-phrase-set-random-set</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Set a new random splash phrase set."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> splash-phrase-set
        (nth (random (1- (length splash-phrase-sources)))
             (cl-set-difference (mapcar #'car splash-phrase-sources) (list splash-phrase-set))))
  (+doom-dashboard-reload t))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">splash-phrase-select-set</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Select a specific splash phrase set."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> splash-phrase-set (completing-read </span><span style="color: #50a14f; background-color: #e7e7e7;">"Phrase set: "</span><span class="ef-ob"> (mapcar #'car splash-phrase-sources)))
  (+doom-dashboard-reload t))
</span><span class="ef-obe">#+end_src
</span>
If we're going to be selecting phrases from a large list of lines, it could be
worth caching the list of lines.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">splash-phrase--cached-lines</span><span class="ef-ob"> nil)
</span><span class="ef-obe">#+end_src
</span>
Now let's write a function that will pick a random line from a file, using
<span style="color: #84888b;">~splash-phrase--cached-lines~</span> if possible.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">splash-phrase-get-from-file</span><span class="ef-ob"> (file)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Fetch a random line from FILE."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((lines (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr (assoc file splash-phrase--cached-lines))
                   (cdar (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (cons file
                                     (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
                                       (insert-file-contents (expand-file-name file splash-phrase-source-folder))
                                       (split-string (string-trim (buffer-string)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)))
                               splash-phrase--cached-lines)))))
    (nth (random (length lines)) lines)))
</span><span class="ef-obe">#+end_src
</span>
With this, we now have enough to generate random phrases on demand.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">splash-phrase</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> set)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Construct a splash phrase from SET. See `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">splash-phrase-sources</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
  (mapconcat
   #'splash-phrase-get-from-file
   (cdr (assoc (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> set splash-phrase-set) splash-phrase-sources))
   </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
I originally thought this might be enough, but some phrases are a tad long, and
this isn't exactly doom-dashboard appropriate. In such cases we need to split
lines, re-centre them, and add some whitespace. While we're at it, we may as
well make it that you can click on the phrase to replace it with new one.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">splash-phrase-dashboard-formatted</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Get a splash phrase, flow it over multiple lines as needed, and fontify it."</span><span class="ef-ob">
  (mapconcat
   (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (line)
     (+doom-dashboard--center
      +doom-dashboard--width
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
        (insert-text-button
         line
         'action
         (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (_) (+doom-dashboard-reload t))
         'face 'doom-dashboard-menu-title
         'mouse-face 'doom-dashboard-menu-title
         'help-echo </span><span style="color: #50a14f; background-color: #e7e7e7;">"Random phrase"</span><span class="ef-ob">
         'follow-link t)
        (buffer-string))))
   (split-string
    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
      (insert (splash-phrase))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> fill-column (min 70 (/ (* 2 (window-width)) 3)))
      (fill-region (point-min) (point-max))
      (buffer-string))
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
   </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Almost there now, this just needs some centreing and newlines.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">splash-phrase-dashboard-insert</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Insert the splash phrase surrounded by newlines."</span><span class="ef-ob">
  (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob"> (splash-phrase-dashboard-formatted) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Quick actions</span>

When using the dashboard, there are often a small number of actions I will take.
As the dashboard is it's own major mode, there is no need to suffer the tyranny
of unnecessary keystrokes --- we can simply bind common actions to a single key!

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+doom-dashboard-setup-modified-keymap</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +doom-dashboard-mode-map (make-sparse-keymap))
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> +doom-dashboard-mode-map
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Find file"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"f"</span><span class="ef-ob"> #'find-file
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Recent files"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"r"</span><span class="ef-ob"> #'consult-recent-file
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Config dir"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"C"</span><span class="ef-ob"> #'doom/open-private-config
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Open config.org"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"c"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (find-file (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"config.org"</span><span class="ef-ob"> doom-user-dir)))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Open org-mode root"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"O"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (find-file (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org/"</span><span class="ef-ob"> doom-user-dir)))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Open dotfile"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (doom-project-find-file </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.config/"</span><span class="ef-ob">))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Notes (roam)"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n"</span><span class="ef-ob"> #'org-roam-node-find
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Switch buffer"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"b"</span><span class="ef-ob"> #'+vertico/switch-workspace-buffer
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Switch buffers (all)"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"B"</span><span class="ef-ob"> #'consult-buffer
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"IBuffer"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"i"</span><span class="ef-ob"> #'ibuffer
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Previous buffer"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"p"</span><span class="ef-ob"> #'previous-buffer
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Set theme"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span><span class="ef-ob"> #'consult-theme
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Quit"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Q"</span><span class="ef-ob"> #'save-buffers-kill-terminal
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Show keybindings"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:ng</span> <span style="color: #50a14f; background-color: #e7e7e7;">"h"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (which-key-show-keymap '+doom-dashboard-mode-map))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">add-transient-hook!</span><span class="ef-ob"> #'+doom-dashboard-mode (+doom-dashboard-setup-modified-keymap))
(</span><span style="color: #e45649; background-color: #e7e7e7;">add-transient-hook!</span><span class="ef-ob"> #'+doom-dashboard-mode </span><span style="color: #a626a4; background-color: #e7e7e7;">:append</span><span class="ef-ob"> (+doom-dashboard-setup-modified-keymap))
(</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'doom-init-ui-hook </span><span style="color: #a626a4; background-color: #e7e7e7;">:append</span><span class="ef-ob"> (+doom-dashboard-setup-modified-keymap))
</span><span class="ef-obe">#+end_src
</span>
Unfortunately the show keybindings help doesn't currently work as intended, but
this is still quite nice overall.

Now that the dashboard is so convenient, I'll want to make it easier to get to.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:leader</span> <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Dashboard"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"d"</span><span class="ef-ob"> #'+doom-dashboard/open)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Putting it all together</span>

With the splash image and phrase generation worked out, we can almost put
together the desired dashboard from scratch, we just need to re-create the
benchmark information by itself.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+doom-dashboard-benchmark-line</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Insert the load time line."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> doom-init-time
    (insert
     </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n"</span><span class="ef-ob">
     (propertize
      (+doom-dashboard--center
       +doom-dashboard--width
       (doom-display-benchmark-h 'return))
      'face 'doom-dashboard-loaded))))
</span><span class="ef-obe">#+end_src
</span>
With <span style="color: #84888b;">~doom-display-benchmark-h~</span> displayed here, I don't see the need for it to be
shown in the minibuffer as well.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(remove-hook 'doom-after-init-hook #'doom-display-benchmark-h)
</span><span class="ef-obe">#+end_src
</span>
Now we can create the desired dashboard by setting <span style="color: #84888b;">~+doom-dashboard-functions~</span> to
just have:
+ The "widget banner" (splash image)
+ The benchmark line
+ A random phrase
This gets rid of two segments I'm not particularly interested in seeing
+ The shortmenu
+ The footer (github link)

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +doom-dashboard-functions
      (list #'doom-dashboard-widget-banner
            #'+doom-dashboard-benchmark-line
            #'splash-phrase-dashboard-insert))
</span><span class="ef-obe">#+end_src
</span>
At this point there are just a few minor tweaks I'd still like to make to the
dashboard.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+doom-dashboard-tweak</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> _)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> (get-buffer +doom-dashboard-name)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> line-spacing 0.2
                mode-line-format nil
                mode-name </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">
                evil-normal-state-cursor (list nil))))
</span><span class="ef-obe">#+end_src
</span>
Now we can just add this as a mode hook.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook '+doom-dashboard-mode-hook #'+doom-dashboard-tweak)
</span><span class="ef-obe">#+end_src
</span>
Unfortunately, the initialisation of <span style="color: #84888b;">=doom-modeline=</span> interferes with the set
<span style="color: #84888b;">~mode-line-format~</span> value. To get around this, we can re-apply
<span style="color: #84888b;">~+doom-dashboard-tweak~</span> as a slightly late init hook, after <span style="color: #84888b;">=doom-modeline=</span> has been
loaded.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook 'doom-after-init-hook #'+doom-dashboard-tweak 1)
</span><span class="ef-obe">#+end_src
</span>
Lastly, with the buffer name being shown in the frame title thanks to some <span style="color: #4078f2; font-weight: 700;">[[Window title][other
configuration]]</span>, we might as well display something a bit prettier than <span style="color: #84888b;">=*doom*=</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +doom-dashboard-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"► Doom"</span><span class="ef-ob">
      doom-fallback-buffer-name +doom-dashboard-name)
</span><span class="ef-obe">#+end_src
</span>
The end result is a minimal but rather nice splash screen.

<span style="color: #84888b;">#+attr_html: :class invertible :alt The splash screen, just loaded.</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/splash-screen.png]]</span>

To keep the splash image up to date, we just need to check it every time the
frame size or theme is changed.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook 'window-size-change-functions #'fancy-splash-apply-appropriate-image)
(add-hook 'doom-load-theme-hook #'fancy-splash-apply-appropriate-image)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Config doctor</span>

We can collect checks throughout this config and put them in a <span style="color: #84888b;">=doctor.el=</span> file
that will be run as part of <span style="color: #84888b;">=doom doctor=</span>. This will complement the <span style="color: #84888b;">=setup.sh=</span>
approach.

<span class="ef-obb">#+begin_src emacs-lisp :tangle doctor.el :noweb yes :noweb-ref none
</span><span style="color: #84888b; background-color: #e7e7e7;">;;; </span><span style="color: #84888b; background-color: #e7e7e7;">doctor.el -*- lexical-binding: t; no-byte-compile: t; -*-
</span><span class="ef-ob">
&lt;&lt;doctor&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Other things</span>

<span class="ef-c"># This stub for the shell setup scrip needs to appear before any</span>
<span class="ef-c"># other setup shell source blocks.</span>
<span class="ef-obb">#+begin_src shell :exports none :comments no :tangle-mode (identity #o755)
</span><span style="color: #84888b; background-color: #e7e7e7;">#</span><span style="color: #84888b; background-color: #e7e7e7;">!/usr/bin/env bash
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Editor interaction</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Mouse buttons</span>

<span style="color: #84888b;">#+call: confpkg("Better jumper mouse")</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span><span class="ef-ob"> [mouse-8] #'better-jumper-jump-backward
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span><span class="ef-ob"> [mouse-9] #'better-jumper-jump-forward)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Window title</span>

<span style="color: #84888b;">#+call: confpkg("Frame title")</span>

I'd like to have just the buffer name, then if applicable the project folder
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> frame-title-format
      '(</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:eval</span><span class="ef-ob">
         (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-match-p (regexp-quote (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-roam-directory) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\u0000"</span><span class="ef-ob">))
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> buffer-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
             (replace-regexp-in-string
              </span><span style="color: #50a14f; background-color: #e7e7e7;">".*/[0-9]*-?"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"☰ "</span><span class="ef-ob">
              (subst-char-in-string ?_ ?\s buffer-file-name))
           </span><span style="color: #50a14f; background-color: #e7e7e7;">"%b"</span><span class="ef-ob">))
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:eval</span><span class="ef-ob">
         (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((project-name (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">featurep</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">projectile</span><span class="ef-ob">) (projectile-project-name))))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (string= </span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob"> project-name)
             (format (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (buffer-modified-p)  </span><span style="color: #50a14f; background-color: #e7e7e7;">" ◉ %s"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"  ●  %s"</span><span class="ef-ob">) project-name))))))
</span><span class="ef-obe">#+end_src
</span>
For example when I open my config file it the window will be titled <span style="color: #84888b;">=config.org ●
doom=</span> then as soon as I make a change it will become <span style="color: #84888b;">=config.org ◉ doom=</span>.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Systemd daemon</span>

For running a systemd service for a Emacs server I have the following. <span style="color: #84888b;">=zsh -c=</span> is
used to ensure that <span style="color: #84888b;">=.zshenv=</span> is loaded.

<span style="color: #84888b;">#+name: emacsclient service</span>
<span class="ef-obb">#+begin_src systemd :tangle ~/.config/systemd/user/emacs.service :mkdirp yes
</span><span style="color: #986801; background-color: #e7e7e7;">[Unit]</span>
<span style="color: #e45649; background-color: #e7e7e7;">Description</span><span class="ef-ob">=Emacs server daemon
</span><span style="color: #e45649; background-color: #e7e7e7;">Documentation</span><span class="ef-ob">=info:emacs man:emacs(1) https://gnu.org/software/emacs/
</span><span style="color: #e45649; background-color: #e7e7e7;">Wants</span><span class="ef-ob">=gpg-agent.service

</span><span style="color: #986801; background-color: #e7e7e7;">[Service]</span>
<span style="color: #e45649; background-color: #e7e7e7;">Type</span><span class="ef-ob">=</span><span style="color: #a626a4; background-color: #e7e7e7;">forking</span>
<span style="color: #e45649; background-color: #e7e7e7;">ExecStart</span><span class="ef-ob">=zsh -c </span><span style="color: #50a14f; background-color: #e7e7e7;">'emacs --daemon &amp;&amp; emacsclient -c --eval "(delete-frame)"'</span>
<span style="color: #e45649; background-color: #e7e7e7;">ExecStop</span><span class="ef-ob">=/usr/bin/emacsclient --no-wait --eval </span><span style="color: #50a14f; background-color: #e7e7e7;">"(progn (setq kill-emacs-hook nil) (kill emacs))"</span>
<span style="color: #e45649; background-color: #e7e7e7;">Environment</span><span class="ef-ob">=COLORTERM=truecolor
</span><span style="color: #e45649; background-color: #e7e7e7;">Restart</span><span class="ef-ob">=</span><span style="color: #a626a4; background-color: #e7e7e7;">on-failure</span>

<span style="color: #986801; background-color: #e7e7e7;">[Install]</span>
<span style="color: #e45649; background-color: #e7e7e7;">WantedBy</span><span class="ef-ob">=default.target
</span><span class="ef-obe">#+end_src
</span>
which is then enabled by
<span class="ef-obb">#+begin_src shell :tangle (if (string= "enabled\n" (shell-command-to-string "systemctl --user is-enabled emacs.service")) "no" "setup.sh")
</span><span class="ef-ob">systemctl --user enable emacs.service
</span><span class="ef-obe">#+end_src
</span>
We can also add a <span style="color: #84888b;">=doctor=</span> warning should this not be enabled.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (string= </span><span style="color: #50a14f; background-color: #e7e7e7;">"enabled\n"</span><span class="ef-ob"> (shell-command-to-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"systemctl --user is-enabled emacs.service"</span><span class="ef-ob">))
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emacsclient service is not enabled."</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
For some reason if a frame isn't opened early in the initialisation process, the
daemon doesn't seem to like opening frames later --- hence the <span style="color: #84888b;">~&amp;&amp; emacsclient~</span>
part of the <span style="color: #84888b;">=ExecStart=</span> value.

It can now be nice to use this as a 'default app' for opening files. If we add
an appropriate desktop entry, and enable it in the desktop environment.

<span class="ef-obb">#+begin_src conf :tangle ~/.local/share/applications/emacs-client.desktop :mkdirp yes
</span><span class="ef-ob">[</span><span style="color: #986801; background-color: #e7e7e7;">Desktop Entry</span><span class="ef-ob">]
</span><span style="color: #6a1868; background-color: #e7e7e7;">Name</span><span class="ef-ob">=Emacs client
</span><span style="color: #6a1868; background-color: #e7e7e7;">GenericName</span><span class="ef-ob">=Text Editor
</span><span style="color: #6a1868; background-color: #e7e7e7;">Comment</span><span class="ef-ob">=A flexible platform for end-user applications
</span><span style="color: #6a1868; background-color: #e7e7e7;">MimeType</span><span class="ef-ob">=text/english;text/plain;text/x-makefile;text/x-c++hdr;text/x-c++src;text/x-chdr;text/x-csrc;text/x-java;text/x-moc;text/x-pascal;text/x-tcl;text/x-tex;application/x-shellscript;text/x-c;text/x-c++;
</span><span style="color: #6a1868; background-color: #e7e7e7;">Exec</span><span class="ef-ob">=emacsclient -create-frame --alternate-editor=</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> --no-wait %F
</span><span style="color: #6a1868; background-color: #e7e7e7;">Icon</span><span class="ef-ob">=emacs
</span><span style="color: #6a1868; background-color: #e7e7e7;">Type</span><span class="ef-ob">=Application
</span><span style="color: #6a1868; background-color: #e7e7e7;">Terminal</span><span class="ef-ob">=false
</span><span style="color: #6a1868; background-color: #e7e7e7;">Categories</span><span class="ef-ob">=TextEditor;Utility;
</span><span style="color: #6a1868; background-color: #e7e7e7;">StartupWMClass</span><span class="ef-ob">=Emacs
</span><span style="color: #6a1868; background-color: #e7e7e7;">Keywords</span><span class="ef-ob">=Text;Editor;
</span><span style="color: #6a1868; background-color: #e7e7e7;">X-KDE-StartupNotify</span><span class="ef-ob">=false
</span><span class="ef-obe">#+end_src
</span>
When the daemon is running, I almost always want to do a few particular things
with it, so I may as well eat the load time at startup. We also want to keep
<span style="color: #84888b;">=mu4e=</span> running.

It would be good to start the IRC client (<span style="color: #84888b;">=circe=</span>) too, but that seems to have
issues when started in a non-graphical session.

Lastly, while I'm not sure quite why it happens, but after a bit it seems that
new Emacsclient frames start on the <span style="color: #84888b;">=*scratch*=</span> buffer instead of the dashboard.
I prefer the dashboard, so let's ensure that's always switched to in new frames.

<span style="color: #84888b;">#+call: confpkg("Emacs daemon setup")</span>

<span style="color: #84888b;">#+name: daemon initialisation</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">greedily-do-daemon-setup</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">mu4e</span><span class="ef-ob"> nil t)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-confirm-quit t)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +mu4e-lock-greedy t)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +mu4e-lock-relaxed t)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (+mu4e-lock-available t)
      (mu4e--start)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">elfeed</span><span class="ef-ob"> nil t)
    (run-at-time nil (* 8 60 60) #'elfeed-update)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (daemonp)
  (add-hook 'emacs-startup-hook #'greedily-do-daemon-setup)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'server-after-make-frame-hook
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\*draft</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\*stdin</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">emacs-everywhere"</span><span class="ef-ob"> (buffer-name))
      (switch-to-buffer +doom-dashboard-name))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Emacs client wrapper</span>

I frequently want to make use of Emacs while in a terminal emulator. To make
this easier, I can construct a few handy aliases.

However, a little convenience script in <span style="color: #84888b;">=~/.local/bin=</span> can have the same effect,
be available beyond the specific shell I plop the alias in, then also allow me
to add a few bells and whistles --- namely:
+ Accepting stdin by putting it in a temporary file and immediately opening it.
+ Guessing that the <span style="color: #84888b;">=tty=</span> is a good idea when <span style="color: #84888b;">~$DISPLAY~</span> is unset (relevant with SSH
  sessions, among other things).
+ With a whiff of 24-bit colour support, sets <span style="color: #84888b;">~TERM~</span> variable to a <span style="color: #84888b;">=terminfo=</span> that
  (probably) announces 24-bit colour support.
+ Changes GUI <span style="color: #84888b;">=emacsclient=</span> instances to be non-blocking by default (<span style="color: #84888b;">~--no-wait~</span>),
  and instead take a flag to suppress this behaviour (<span style="color: #84888b;">~-w~</span>).

I would use <span style="color: #84888b;">=sh=</span>, but using arrays for argument manipulation is just too
convenient, so I'll raise the requirement to <span style="color: #84888b;">=bash=</span>. Since arrays are the only
'extra' compared to <span style="color: #84888b;">=sh=</span>, other shells like <span style="color: #84888b;">=ksh=</span> etc. should work too.

<span style="color: #84888b;">#+name: e</span>
<span class="ef-obb">#+begin_src shell :tangle ~/.local/bin/e :mkdirp yes :tangle-mode (identity #o755) :comments no
</span><span style="color: #84888b; background-color: #e7e7e7;">#</span><span style="color: #84888b; background-color: #e7e7e7;">!/usr/bin/env bash
</span><span style="color: #6a1868; background-color: #e7e7e7;">force_tty</span><span class="ef-ob">=false
</span><span style="color: #6a1868; background-color: #e7e7e7;">force_wait</span><span class="ef-ob">=false
</span><span style="color: #6a1868; background-color: #e7e7e7;">stdin_mode</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span>

<span style="color: #6a1868; background-color: #e7e7e7;">args</span><span class="ef-ob">=()

</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> :; </span><span style="color: #e45649; background-color: #e7e7e7;">do</span>
    <span style="color: #e45649; background-color: #e7e7e7;">case</span> <span style="color: #50a14f; background-color: #e7e7e7;">"$1"</span><span style="color: #e45649; background-color: #e7e7e7;"> in</span><span class="ef-ob">
        -t | -nw | --tty)
            </span><span style="color: #6a1868; background-color: #e7e7e7;">force_tty</span><span class="ef-ob">=true
            </span><span style="color: #a626a4; background-color: #e7e7e7;">shift</span><span class="ef-ob"> ;;
        -w | --wait)
            </span><span style="color: #6a1868; background-color: #e7e7e7;">force_wait</span><span class="ef-ob">=true
            </span><span style="color: #a626a4; background-color: #e7e7e7;">shift</span><span class="ef-ob"> ;;
        -m | --mode)
            </span><span style="color: #6a1868; background-color: #e7e7e7;">stdin_mode</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">" ($2-mode)"</span>
            <span style="color: #a626a4; background-color: #e7e7e7;">shift</span><span class="ef-ob"> 2 ;;
        -h | --help)
            </span><span style="color: #a626a4; background-color: #e7e7e7;">echo</span><span class="ef-ob"> -e </span><span style="color: #50a14f; background-color: #e7e7e7;">"\033[1mUsage: e [-t] [-m MODE] [OPTIONS] FILE [-]\033[0m

Emacs client convenience wrapper.

\033[1mOptions:\033[0m
\033[0;34m-h, --help\033[0m            Show this message
\033[0;34m-t, -nw, --tty\033[0m        Force terminal mode
\033[0;34m-w, --wait\033[0m            Don't supply \033[0;34m--no-wait\033[0m to graphical emacsclient
\033[0;34m-\033[0m                     Take \033[0;33mstdin\033[0m (when last argument)
\033[0;34m-m MODE, --mode MODE\033[0m  Mode to open \033[0;33mstdin\033[0m with

Run \033[0;32memacsclient --help\033[0m to see help for the emacsclient."</span>
            <span style="color: #e45649; background-color: #e7e7e7;">exit</span><span class="ef-ob"> 0 ;;
        --*=*)
            </span><span style="color: #a626a4; background-color: #e7e7e7;">set</span><span class="ef-ob"> -- </span><span style="color: #50a14f; background-color: #e7e7e7;">"$@"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"${1%%=*}"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"${1#*=}"</span>
            <span style="color: #a626a4; background-color: #e7e7e7;">shift</span><span class="ef-ob"> ;;
        ,*)
            </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> [ </span><span style="color: #50a14f; background-color: #e7e7e7;">"$#"</span><span class="ef-ob"> = 0 ]; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
                <span style="color: #e45649; background-color: #e7e7e7;">break</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">fi</span><span class="ef-ob">
            args+=(</span><span style="color: #50a14f; background-color: #e7e7e7;">"$1"</span><span class="ef-ob">)
            </span><span style="color: #a626a4; background-color: #e7e7e7;">shift</span><span class="ef-ob"> ;;
    </span><span style="color: #e45649; background-color: #e7e7e7;">esac</span>
<span style="color: #e45649; background-color: #e7e7e7;">done</span>

<span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> [ </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">!</span> <span style="color: #50a14f; background-color: #e7e7e7;">"${#args[*]}"</span><span class="ef-ob"> = 0 ] &amp;&amp; [ </span><span style="color: #50a14f; background-color: #e7e7e7;">"${args[-1]}"</span><span class="ef-ob"> = </span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob"> ]; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">unset</span> <span style="color: #50a14f; background-color: #e7e7e7;">'args[-1]'</span>
    <span style="color: #6a1868; background-color: #e7e7e7;">TMP</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$(mktemp /tmp/emacsstdin-XXX)"</span><span class="ef-ob">
    cat &gt; </span><span style="color: #50a14f; background-color: #e7e7e7;">"$TMP"</span><span class="ef-ob">
    args+=(--eval </span><span style="color: #50a14f; background-color: #e7e7e7;">"(let ((b (generate-new-buffer \"*stdin*\"))) (switch-to-buffer b) (insert-file-contents \"$TMP\") (delete-file \"$TMP\")${stdin_mode})"</span><span class="ef-ob">)
</span><span style="color: #e45649; background-color: #e7e7e7;">fi</span>

<span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> [ -z </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DISPLAY"</span><span class="ef-ob"> ] || $</span><span style="color: #6a1868; background-color: #e7e7e7;">force_tty</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
    <span style="color: #84888b; background-color: #e7e7e7;"># </span><span style="color: #84888b; background-color: #e7e7e7;">detect terminals with sneaky 24-bit support
</span>    <span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> { [ </span><span style="color: #50a14f; background-color: #e7e7e7;">"$COLORTERM"</span><span class="ef-ob"> = truecolor ] || [ </span><span style="color: #50a14f; background-color: #e7e7e7;">"$COLORTERM"</span><span class="ef-ob"> = 24bit ]; } </span><span style="color: #50a14f; background-color: #e7e7e7;">\</span><span class="ef-ob">
        &amp;&amp; [ </span><span style="color: #50a14f; background-color: #e7e7e7;">"$(tput colors 2&gt;/dev/null)"</span><span class="ef-ob"> -lt 257 ]; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
        <span style="color: #e45649; background-color: #e7e7e7;">if </span><span style="color: #a626a4; background-color: #e7e7e7;">echo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"$TERM"</span><span class="ef-ob"> | grep -q </span><span style="color: #50a14f; background-color: #e7e7e7;">"^\w\+-[0-9]"</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
            <span style="color: #6a1868; background-color: #e7e7e7;">termstub</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"${TERM%%-*}"</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">else</span>
            <span style="color: #6a1868; background-color: #e7e7e7;">termstub</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"${TERM#*-}"</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">fi</span>
        <span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> infocmp </span><span style="color: #50a14f; background-color: #e7e7e7;">"$termstub-direct"</span><span class="ef-ob"> &gt;/dev/null 2&gt;&amp;1; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
            <span style="color: #6a1868; background-color: #e7e7e7;">TERM</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$termstub-direct"</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">else</span>
            <span style="color: #6a1868; background-color: #e7e7e7;">TERM</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"xterm-direct"</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">fi</span> <span style="color: #84888b; background-color: #e7e7e7;"># </span><span style="color: #84888b; background-color: #e7e7e7;">should be fairly safe
</span>    <span style="color: #e45649; background-color: #e7e7e7;">fi</span><span class="ef-ob">
    emacsclient --tty -create-frame --alternate-editor=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$ALTERNATE_EDITOR"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"${args[@]}"</span>
<span style="color: #e45649; background-color: #e7e7e7;">else</span>
    <span style="color: #e45649; background-color: #e7e7e7;">if</span> <span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">!</span><span class="ef-ob"> $</span><span style="color: #6a1868; background-color: #e7e7e7;">force_wait</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span><span class="ef-ob">
        args+=(--no-wait); </span><span style="color: #e45649; background-color: #e7e7e7;">fi</span><span class="ef-ob">
    emacsclient -create-frame --alternate-editor=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$ALTERNATE_EDITOR"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"${args[@]}"</span>
<span style="color: #e45649; background-color: #e7e7e7;">fi</span>
<span class="ef-obe">#+end_src
</span>
Now, to set an alias to use <span style="color: #84888b;">=e=</span> with Magit, and then for maximum laziness we can
set aliases for the terminal-forced variants.
<span class="ef-obb">#+begin_src shell :tangle no
</span><span class="ef-ob">alias </span><span style="color: #6a1868; background-color: #e7e7e7;">m</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">'e --eval "(progn (magit-status) (delete-other-windows))"'</span><span class="ef-ob">
alias </span><span style="color: #6a1868; background-color: #e7e7e7;">mt</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"m -t"</span><span class="ef-ob">
alias </span><span style="color: #6a1868; background-color: #e7e7e7;">et</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"e -t"</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Prompt to run setup script</span>

<span style="color: #84888b;">#+call: confpkg("Setup script prompt")</span>

At various points in this config, content is conditionally tangled to
<span style="color: #84888b;">=./setup.sh=</span>. It's no good just putting content there if it isn't run though.
To help remind me to run it when needed, let's add a little prompt when there's
anything to be run.

<span style="color: #84888b;">#+name: run-setup</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (file-exists-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"setup.sh"</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-empty-p (string-trim (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob"> (insert-file-contents </span><span style="color: #50a14f; background-color: #e7e7e7;">"setup.sh"</span><span class="ef-ob">) (buffer-string)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"#!/usr/bin/env bash"</span><span class="ef-ob">))
        (message </span><span style="color: #50a14f; background-color: #e7e7e7;">";; Setup script is empty"</span><span class="ef-ob">)
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">";; Detected content in the setup script"</span><span class="ef-ob">)
      (pp-to-string
       `(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> noninteractive
          (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+config-run-setup</span><span class="ef-ob"> ()
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((setup-file (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"setup.sh"</span><span class="ef-ob"> doom-user-dir))
                       ((file-exists-p setup-file))
                       (setup-content (string-trim (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob"> (insert-file-contents setup-file) (buffer-string))
                                                   </span><span style="color: #50a14f; background-color: #e7e7e7;">"#!/usr/bin/env bash"</span><span class="ef-ob">))
                       ((not (string-empty-p setup-content)))
                       ((yes-or-no-p (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s The setup script has content. Check and run the script?"</span><span class="ef-ob">
                                             (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Warning!"</span><span class="ef-ob"> 'face '(bold warning))))))
              (find-file setup-file)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (yes-or-no-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"Would you like to run this script?"</span><span class="ef-ob">)
                (async-shell-command </span><span style="color: #50a14f; background-color: #e7e7e7;">"./setup.sh"</span><span class="ef-ob">))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'doom-init-ui-hook
            (run-at-time nil nil #'+config-run-setup)))))
  (message </span><span style="color: #50a14f; background-color: #e7e7e7;">";; setup.sh did not exist during tangle. Tangle again."</span><span class="ef-ob">)
  (pp-to-string
   `(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> noninteractive
      (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'doom-init-ui-hook #'+literate-tangle-async-h))))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">&lt;&lt;run-setup()&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Grabbing source block content as a string</span>

In a few places in this configuration, it is desirable to grab a source block's
content as a string. We can use a noweb <span style="color: #84888b;">=</span><span style="color: #84888b;">&lt;&lt;replacement&gt;&gt;</span><span style="color: #84888b;">=</span> form, however that
doesn't work with string escaping.

We can get around this by using noweb execution and write an name (unexported)
babel block that will grab the content of another named source block as a
string. Note that this does not currently expand nested noweb references.

<span style="color: #84888b;">#+name: grab</span>
<span class="ef-obb">#+begin_src emacs-lisp :var name="" pre="" post="" :noweb-ref none
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Babel block: grab(name &amp;optional pre post)
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">NAME is the name of the source block to grab.
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">PRE is a string to prepend to the content of the block.
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">POST is a string to append to the content of the block.
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">if-let</span><span class="ef-ob"> ((block-pos (org-babel-find-named-block name))
         (block (org-element-at-point block-pos)))
    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%S"</span><span class="ef-ob"> (concat pre (string-trim (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> block)) post))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">look for :noweb-ref matches
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (block-contents)
    (org-element-cache-map
     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (src)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (org-in-commented-heading-p nil src))
                  (not (org-in-archived-heading-p nil src))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((lang (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob"> src))
                         (params
                          (apply
                           #'org-babel-merge-params
                           (append
                            (</span><span style="color: #e45649; background-color: #e7e7e7;">org-with-point-at</span><span class="ef-ob"> (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:begin</span><span class="ef-ob"> src)
                              (org-babel-params-from-properties lang t))
                            (mapcar
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (h)
                               (org-babel-parse-header-arguments h t))
                             (cons (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parameters</span><span class="ef-ob"> src)
                                   (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:header</span><span class="ef-ob"> src))))))
                         (ref (alist-get </span><span style="color: #a626a4; background-color: #e7e7e7;">:noweb-ref</span><span class="ef-ob"> params)))
                    (equal ref name)))
         (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (org-babel--normalize-body src)
               block-contents)))
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:granularity</span><span class="ef-ob"> 'element
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:restrict-elements</span><span class="ef-ob"> '(src-block))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> block-contents
         (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%S"</span><span class="ef-ob">
                 (concat
                  pre
                  (mapconcat
                   #'identity
                   (nreverse block-contents)
                   </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n"</span><span class="ef-ob">)
                  post)))))
</span><span class="ef-obe">#+end_src
</span>
There we go, that's all it takes! This can be used via the form <span style="color: #84888b;">=</span><span style="color: #84888b;">&lt;&lt;grab("block-name")&gt;&gt;</span><span style="color: #84888b;">=</span>.

<span style="color: #e45649; font-weight: nil; font-size: 1.25em">* Packages</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Loading instructions</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :tangle no
<span style="font-weight: 700;">:END:</span>

This is where you install packages, by declaring them with the <span style="color: #84888b;">~package!~</span> macro in
<span style="color: #84888b;">=packages.el=</span>, then running <span style="color: #84888b;">~doom refresh~</span> on the command line.
This file shouldn't be byte compiled.
<span class="ef-obb">#+begin_src emacs-lisp :tangle "packages.el" :comments no
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">-*- no-byte-compile: t; -*-
</span><span class="ef-obe">#+end_src
</span>
You'll then need to restart Emacs for your changes to take effect! Or at least,
run <span style="color: #84888b;">=M-x doom/reload=</span>.

<span style="font-weight: 700;">*Warning*</span>: Don't disable core packages listed in <span style="color: #84888b;">=~/.config/emacs/core/packages.el=</span>.
Doom requires these, and disabling them may have terrible side effects.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Packages in MELPA/ELPA/emacsmirror</span>

To install <span style="color: #84888b;">~some-package~</span> from MELPA, ELPA or emacsmirror:
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> some-package)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Packages from git repositories</span>

To install a package directly from a particular repo, you'll need to specify
a <span style="color: #84888b;">~:recipe~</span>. You'll find documentation on what <span style="color: #84888b;">~:recipe~</span> accepts <span style="color: #4078f2; font-weight: 700;">[[https://github.com/raxod502/straight.el#the-recipe-format][here]]</span>:
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> another-package
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"username/repo"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
If the package you are trying to install does not contain a <span style="color: #84888b;">~PACKAGENAME.el~</span>
file, or is located in a subdirectory of the repo, you'll need to specify
<span style="color: #84888b;">~:files~</span> in the <span style="color: #84888b;">~:recipe~</span>:
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> this-package
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"username/repo"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"some-file.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"src/lisp/*.el"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Disabling built-in packages</span>

If you'd like to disable a package included with Doom, for whatever reason,
you can do so here with the <span style="color: #84888b;">~:disable~</span> property:
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> builtin-package </span><span style="color: #a626a4; background-color: #e7e7e7;">:disable</span><span class="ef-ob"> t)
</span><span class="ef-obe">#+end_src
</span>You can override the recipe of a built in package without having to specify
all the properties for <span style="color: #84888b;">~:recipe~</span>. These will inherit the rest of its recipe
from Doom or MELPA/ELPA/Emacsmirror:
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> builtin-package </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:nonrecursive</span><span class="ef-ob"> t))
(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> builtin-package-2 </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"myfork/package"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Specify a <span style="color: #84888b;">~:branch~</span> to install a package from a particular branch or tag.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> builtin-package </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:branch</span> <span style="color: #50a14f; background-color: #e7e7e7;">"develop"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Convenience</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Avy</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg avy")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:config default=</span> module.
<span class="ef-obe">#+end_quote
</span>

What a wonderful way to jump to buffer positions, and it uses the QWERTY
home-row for jumping. Very convenient ... except I'm using Colemak.

<span style="color: #84888b;">#+name: avy-colemak-setup</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> avy
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">home row priorities: 8 6 4 5 - - 1 2 3 7
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> avy-keys '(?n ?e ?i ?s ?t ?r ?i ?a)))
</span><span class="ef-obe">#+end_src
</span>
Now let's just have this included when an ErgoDox is found via <span style="color: #84888b;">=dmesg=</span>.

<span style="color: #84888b;">#+name: avy-detect-colemak</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-ref none :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= 0 (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"sh"</span><span class="ef-ob"> nil nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"-c"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"dmesg | grep -q '</span><span style="color: #b751b6; background-color: #e7e7e7;">ErgoDox</span><span style="color: #50a14f; background-color: #e7e7e7;">'"</span><span class="ef-ob">))
    (pp '&lt;&lt;avy-colemak-setup&gt;&gt;)
  </span><span style="color: #50a14f; background-color: #e7e7e7;">";; Avy: Colemak layout not detected (ErgoDox not mentioned in dmesg)."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">&lt;&lt;avy-detect-colemak()&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Rotate (window management)</span>

The <span style="color: #84888b;">=rotate=</span> package just adds the ability to rotate window layouts, but that
sounds nice to me.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> rotate </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"4e9ac3ff800880bd9b705794ef0f7c99d72900a6"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Emacs Everywhere</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg emacs-everywhere")</span>

The name says it all. It's loaded and set up (a bit) by <span style="color: #84888b;">=:app everywhere=</span>, however
as I develop this I want the unpinned version I have as a submodule.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> emacs-everywhere </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/emacs-everywhere"</span><span class="ef-ob">))
(</span><span style="color: #e45649; background-color: #e7e7e7;">unpin!</span><span class="ef-ob"> emacs-everywhere)
</span><span class="ef-obe">#+end_src
</span>
Additionally, I'm going to make some personal choices that aren't made in the
Doom module.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! emacs-everywhere
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:if</span><span class="ef-ob"> (daemonp)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">spell-fu</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> emacs-everywhere-major-mode-function #'org-mode
        emacs-everywhere-frame-name-format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Edit ∷ %s — %s"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> emacs-everywhere-raise-frame ()
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'emacs-everywhere-set-frame-name
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> emacs-everywhere-frame-name (format emacs-everywhere-frame-name-format
                                (emacs-everywhere-app-class emacs-everywhere-current-app)
                                (truncate-string-to-width
                                 (emacs-everywhere-app-title emacs-everywhere-current-app)
                                 45 nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"…"</span><span class="ef-ob">)))
    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">need to wait till frame refresh happen before really set
</span><span class="ef-ob">    (run-with-timer 0.1 nil #'emacs-everywhere-raise-frame-1))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">emacs-everywhere-raise-frame-1</span><span class="ef-ob"> ()
    (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"wmctrl"</span><span class="ef-ob"> nil nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"-a"</span><span class="ef-ob"> emacs-everywhere-frame-name)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Which-key</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg which-key")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:core packages=</span> module.
<span class="ef-obe">#+end_quote
</span>
Let's make this popup a bit faster
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> which-key-idle-delay 0.5) </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">I need the help, I really do
</span><span class="ef-obe">#+end_src
</span>
I also think that having <span style="color: #84888b;">=evil-=</span> appear in so many popups is a bit too verbose,
let's change that, and do a few other similar tweaks while we're at it.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> which-key-allow-multiple-replacements t)
(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> which-key
  (</span><span style="color: #e45649; background-color: #e7e7e7;">pushnew!</span><span class="ef-ob">
   which-key-replacement-alist
   '((</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`+?evil[-:]?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">a-</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.*</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">) . (nil . </span><span style="color: #50a14f; background-color: #e7e7e7;">"◂\\1"</span><span class="ef-ob">))
   '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`g s"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`evilem--?motion-</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.*</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">) . (nil . </span><span style="color: #50a14f; background-color: #e7e7e7;">"◃\\1"</span><span class="ef-ob">))
   ))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt Whichkey triggered on an evil motion</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/whichkey-evil.png]]</span>

<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Tools</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Abbrev</span>

<span style="color: #84888b;">#+call: confpkg()</span>

Abbrev mode is great, and something I make use of in multiple ways. As such, I
want it on by default.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq-default</span><span class="ef-ob"> abbrev-mode t)
</span><span class="ef-obe">#+end_src
</span>
Abbrev-mode can save and load abbreviations from an "abbrev file", which I'd
like to locate in my Doom config folder.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> abbrev-file-name (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"abbrev.el"</span><span class="ef-ob"> doom-user-dir))
</span><span class="ef-obe">#+end_src
</span>
I need to think more on how I want to manage abbrev changes in the current
session, but for now I'm going to be overly cautious and avoid any modifications
to the global abbrev file that I don't make myself.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> save-abbrevs nil)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Very large files</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg VLF")</span>

The <span style="text-decoration: italic;">/very large files/</span> mode loads large files in chunks, allowing one to open
ridiculously large files.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> vlf </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"emacs-straight/vlf"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"*.el"</span><span class="ef-ob">))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"d500f39672b35bf8551fdfafa892c551626c8d54"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
To make VLF available without delaying startup, we'll just load it in quiet moments.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(use-package! vlf-setup
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:defer-incrementally</span><span class="ef-ob"> vlf-tune vlf-base vlf-write
  vlf-search vlf-occur vlf-follow vlf-ediff vlf
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> vlf vlf-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">vlf-application</span><span class="ef-ob"> 'ask) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Avoid load-order issues
</span><span class="ef-ob">  &lt;&lt;vlf-largefile-prompt&gt;&gt;
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (advice-remove 'abort-if-file-too-large #'ad-Advice-abort-if-file-too-large)
  &lt;&lt;vlf-linenum-offset&gt;&gt;
  &lt;&lt;vlf-search-chunking&gt;&gt;)
</span><span class="ef-obe">#+end_src
</span>
Now, there are one or two tweaks worth applying to VLF. For starters, it goes to
the liberty of advising <span style="color: #84888b;">~abort-if-file-too-large~</span>, and in doing so removes the
option of opening files literally. I think that's a bit much, so we can remove
the advice and instead override <span style="color: #84888b;">~files--ask-user-about-large-file~</span> (the more
appropriate function, I think) as a simpler approach, just sacrificing the
original behaviour with <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> vlf-application 'always)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> (which I can't
imagine using anyway).

<span style="color: #84888b;">#+name: vlf-largefile-prompt</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +files--ask-about-large-file-vlf (size op-type filename offer-raw)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Like `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">files--ask-user-about-large-file</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', but with support for `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">vlf</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'files--ask-user-about-large-file
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq vlf-application 'dont-ask)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob"> (vlf filename) (</span><span style="color: #986801; background-color: #e7e7e7;">error</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((prompt (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"File %s is large (%s), really %s?"</span><span class="ef-ob">
                          (file-name-nondirectory filename)
                          (funcall byte-count-to-string-function size) op-type)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (not offer-raw)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (y-or-n-p prompt) nil 'abort)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((choice
               (car
                (read-multiple-choice
                 prompt '((?y </span><span style="color: #50a14f; background-color: #e7e7e7;">"yes"</span><span class="ef-ob">)
                          (?n </span><span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob">)
                          (?l </span><span style="color: #50a14f; background-color: #e7e7e7;">"literally"</span><span class="ef-ob">)
                          (?v </span><span style="color: #50a14f; background-color: #e7e7e7;">"vlf"</span><span class="ef-ob">))
                 (files--ask-user-about-large-file-help-text
                  op-type (funcall byte-count-to-string-function size))))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((eq choice ?y) nil)
                ((eq choice ?l) 'raw)
                ((eq choice ?v)
                 (vlf filename)
                 (</span><span style="color: #986801; background-color: #e7e7e7;">error</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
                (t 'abort)))))))
</span><span class="ef-obe">#+end_src
</span>
As you go from one chunk fetched by VLF to the next, the displayed line number
of the first line <span style="text-decoration: italic;">/in each chunk/</span> is unchanged. I think it's reasonable to hope
for an <span style="text-decoration: italic;">/overall/</span> line number, and by tracking chunk's cumulative line numbers we
can implement this behaviour fairly easily.

<span style="color: #84888b;">#+name: vlf-linenum-offset</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar-local</span> <span style="color: #6a1868; background-color: #e7e7e7;">+vlf-cumulative-linenum</span><span class="ef-ob"> '((0 . 0))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"An alist keeping track of the cumulative line number."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+vlf-update-linum</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Update the line number offset."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((linenum-offset (alist-get vlf-start-pos +vlf-cumulative-linenum)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> display-line-numbers-offset (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> linenum-offset 0))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> linenum-offset (not (assq vlf-end-pos +vlf-cumulative-linenum)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (cons vlf-end-pos (+ linenum-offset
                                 (count-lines (point-min) (point-max))))
            +vlf-cumulative-linenum))))

(add-hook 'vlf-after-chunk-update-hook #'+vlf-update-linum)

</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Since this only works with absolute line numbers, let's make sure we use them.
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'vlf-mode-hook (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> display-line-numbers t))
</span><span class="ef-obe">#+end_src
</span>
The other thing that doesn't work too well with VLF is searching with anything
other than <span style="color: #84888b;">=M-x occur=</span>. This is because trying to go to the next match at the end
of a chunk usually wraps the point to the beginning of the chunk, instead of
moving to the next chunk.

<span style="color: #84888b;">#+name: vlf-search-chunking</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+vlf-next-chunk-or-start</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= vlf-file-size vlf-end-pos)
      (vlf-jump-to-chunk 1)
    (vlf-next-batch 1))
  (goto-char (point-min)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+vlf-last-chunk-or-end</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= 0 vlf-start-pos)
      (vlf-end-of-file)
    (vlf-prev-batch 1))
  (goto-char (point-max)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+vlf-isearch-wrap</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> isearch-forward
      (+vlf-next-chunk-or-start)
    (+vlf-last-chunk-or-end)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'vlf-mode-hook (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> isearch-wrap-function #'+vlf-isearch-wrap))
</span><span class="ef-obe">#+end_src
</span>
Unfortunately, since evil-search doesn't have an analogue to
<span style="color: #84888b;">~isearch-wrap-function~</span>, we can't easily add support to it.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Eros</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Eros")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:tools eval=</span> module.
<span class="ef-obe">#+end_quote
</span>
This package enables the very nice inline evaluation with <span style="color: #84888b;">=gr=</span> and <span style="color: #84888b;">=gR=</span>. The prefix
could be slightly nicer though.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> eros-eval-result-prefix </span><span style="color: #50a14f; background-color: #e7e7e7;">"⟹ "</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">default =&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** EVIL</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg evil")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:editor evil=</span> module.
<span class="ef-obe">#+end_quote
</span>
When I want to make a substitution, I want it to be global more often than not
--- so let's make that the default.

Now, EVIL cares a fair bit about keeping compatibility with Vim's default
behaviour. I don't. There are some particular settings that I'd rather be
something else, so let's change them.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> evil
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> evil-ex-substitute-global t     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">I like my s/../.. to by global by default
</span><span class="ef-ob">        evil-move-cursor-back nil       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Don't move the block cursor when toggling insert mode
</span><span class="ef-ob">        evil-kill-on-visual-paste nil)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Don't put overwritten text in the kill ring
</span><span class="ef-obe">#+end_src
</span>
I don't use <span style="color: #84888b;">~evil-escape-mode~</span>, so I may as well turn it off, I've heard it
contributes a typing delay. I'm not sure it's much, but it is an extra
<span style="color: #84888b;">~pre-command-hook~</span> that I don't benefit from, so...
It seems that there's a dedicated package for this, so instead of just disabling
the mode on startup, let's prevent installation of the package.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> evil-escape </span><span style="color: #a626a4; background-color: #e7e7e7;">:disable</span><span class="ef-ob"> t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** GPTel</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg gptel")</span>

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> gptel </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"94bf19da93aee9a101429d7ecbfbb9c7c5b67216"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! gptel
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> gptel gptel-menu gptel-mode gptel-send
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((groq-backend
         (gptel-make-openai </span><span style="color: #50a14f; background-color: #e7e7e7;">"Groq"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:host</span> <span style="color: #50a14f; background-color: #e7e7e7;">"api.groq.com"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:endpoint</span> <span style="color: #50a14f; background-color: #e7e7e7;">"/openai/v1/chat/completions"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:stream</span><span class="ef-ob"> t
           </span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (secrets-get-secret </span><span style="color: #50a14f; background-color: #e7e7e7;">"Login"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"groq"</span><span class="ef-ob">)
                          (secrets-get-secret </span><span style="color: #50a14f; background-color: #e7e7e7;">"kdewallet"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"groq"</span><span class="ef-ob">)))
           </span><span style="color: #a626a4; background-color: #e7e7e7;">:models</span><span class="ef-ob"> '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"llama3-70b-8192"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"llama3-8b-8192"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"llama-3.1-70b-versatile"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"llama-3.1-8b-instant"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"llama-3.2-1b-preview"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"deepseek-r1-distill-llama-70b"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"mixtral-8x7b-32768"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"gemma-7b-it"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"gemma2-9b-it"</span><span class="ef-ob">)))
        (openai-backend
         (gptel-make-openai </span><span style="color: #50a14f; background-color: #e7e7e7;">"ChatGPT"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:host</span> <span style="color: #50a14f; background-color: #e7e7e7;">"api.openai.com"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:stream</span><span class="ef-ob"> t
           </span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (secrets-get-secret </span><span style="color: #50a14f; background-color: #e7e7e7;">"Login"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"openai"</span><span class="ef-ob">)
                          (secrets-get-secret </span><span style="color: #50a14f; background-color: #e7e7e7;">"kdewallet"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"openai"</span><span class="ef-ob">)))
           </span><span style="color: #a626a4; background-color: #e7e7e7;">:models</span><span class="ef-ob"> '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"gpt-4o"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"gpt-4o-mini"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"chatgpt-4o-latest"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"o1"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o1-mini"</span><span class="ef-ob">)))
        (anthropic-backend
         (gptel-make-anthropic </span><span style="color: #50a14f; background-color: #e7e7e7;">"Claude"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:stream</span><span class="ef-ob"> t
           </span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (secrets-get-secret </span><span style="color: #50a14f; background-color: #e7e7e7;">"Login"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"anthropic"</span><span class="ef-ob">)
                          (secrets-get-secret </span><span style="color: #50a14f; background-color: #e7e7e7;">"kdewallet"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"anthropic"</span><span class="ef-ob">)))
           </span><span style="color: #a626a4; background-color: #e7e7e7;">:models</span><span class="ef-ob"> '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"claude-3-5-sonnet-20240620"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"claude-3-sonnet-20240229"</span>
                     <span style="color: #50a14f; background-color: #e7e7e7;">"claude-3-haiku-20240307"</span><span class="ef-ob">)))
        (ollama-backend
         (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (ollama-models)
           (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"ollama"</span><span class="ef-ob">)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
               (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"ollama"</span><span class="ef-ob"> nil t nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"list"</span><span class="ef-ob">)
               (goto-char (point-min))
               (forward-line 1)
               (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (eobp)) (looking-at </span><span style="color: #50a14f; background-color: #e7e7e7;">"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;"> \t]+"</span><span class="ef-ob">))
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (match-string 0) ollama-models)
                 (forward-line 1)))
             (gptel-make-ollama </span><span style="color: #50a14f; background-color: #e7e7e7;">"Ollama"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:models</span><span class="ef-ob"> ollama-models </span><span style="color: #a626a4; background-color: #e7e7e7;">:stream</span><span class="ef-ob"> t)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-default</span><span class="ef-ob"> gptel-model </span><span style="color: #50a14f; background-color: #e7e7e7;">"llama-3.1-70b-versatile"</span><span class="ef-ob">
                  gptel-backend groq-backend))
  (delete (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"ChatGPT"</span><span class="ef-ob"> gptel--known-backends) gptel--known-backends)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> gptel-default-mode #'org-mode))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Headlice</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Headlice")</span>

Dealing with licenses and in particular license headers is frankly a bit of a
pain, and so I've written a package so that this just takes care of itself and I
don't have to think about it.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> headlice </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/headlice"</span>
                            <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:defaults</span> <span style="color: #50a14f; background-color: #e7e7e7;">"licenses"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"headers"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
The author of this package has set some pretty good defaults, but as usual there
are some specific personal preferences I'd like to apply, and then there's the
minor matter of hooking it into Emacs/Doom.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! headlice
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (prog-mode . headlice-auto-insert)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> headlice-preferred-license 'mpl
        headlice-use-spdx-headers t
        headlice-ignored-licenses '(gpl-3)
        headlice-user-email </span><span style="color: #50a14f; background-color: #e7e7e7;">"contact@tecosaur.net"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defalias</span><span class="ef-ob"> '</span><span style="color: #a626a4; background-color: #e7e7e7;">+file-templates/insert-license</span><span class="ef-ob"> #'headlice-create-license))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Consult</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Consult")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:completion vertico=</span> module.
<span class="ef-obe">#+end_quote
</span>
Since we're using <span style="color: #4078f2; font-weight: 700;">[[Marginalia]]</span> too, the separation between buffers and files is
already clear, and there's no need for a different face.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> consult
  (set-face-attribute 'consult-file nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> 'consult-buffer)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> (plist-get (alist-get 'perl consult-async-split-styles-alist) </span><span style="color: #a626a4; background-color: #e7e7e7;">:initial</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">";"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Magit</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Magit")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:tools magit=</span> module.
<span class="ef-obe">#+end_quote
</span>
<span style="color: #4078f2; font-weight: 700;">[[xkcd:1597]]</span>

Magit is great as-is, thanks for making such a lovely package <span style="color: #4078f2; font-weight: 700;">[[https://github.com/tarsius][Jonas]]</span>!

There's still a room for a little tweaking though...

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">&lt;&lt;magit-toplevel&gt;&gt;
(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> magit
  &lt;&lt;magit-tweaks&gt;&gt;)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Easier forge remotes</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :noweb-ref magit-tweaks
<span style="font-weight: 700;">:END:</span>

When creating a new project, I often want the remote to be to my personal Forgejo
instance. Let's make that a bit more streamlined by introducing a quick-entry
"default forge" option.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+magit-default-forge-remote</span> <span style="color: #50a14f; background-color: #e7e7e7;">"git@ssh.tecosaur.net:tec/%s.git"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Format string that fills out to a remote from the repo name.
Set to nil to disable this functionality."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
While we're at it, when creating a remote with the same name as my Github
username in a project where an HTTPS GitHub remote already exists, let's make
the pre-filled remote URL use ssh.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +magit-remote-add--streamline-forge-a (args)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Prompt to setup a remote using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+magit-default-forge-remote</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:filter-args</span><span class="ef-ob"> #'magit-remote-add
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">
   (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((default-name
          (subst-char-in-string
           ?\s ?-
           (file-name-nondirectory
            (directory-file-name
             (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (doom-project-root) default-directory))))))
     (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> +magit-default-forge-remote
              (not (magit-list-remotes))
              (eq (read-char-choice
                   (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Setup %s remote? [y/n]: "</span><span class="ef-ob">
                           (replace-regexp-in-string
                            </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">@]+@</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">https://</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">:/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">[:/].*\\'"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\1"</span><span class="ef-ob">
                            +magit-default-forge-remote))
                   '(?y ?n))
                  ?y)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((name (read-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"Name: "</span><span class="ef-ob"> default-name)))
                (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"origin"</span><span class="ef-ob"> (format +magit-default-forge-remote name)
                      (transient-args 'magit-remote))))
         (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((origin (magit-get </span><span style="color: #50a14f; background-color: #e7e7e7;">"remote.origin.url"</span><span class="ef-ob">))
               (remote (magit-read-string-ns </span><span style="color: #50a14f; background-color: #e7e7e7;">"Remote name"</span><span class="ef-ob">))
               (gh-user (magit-get </span><span style="color: #50a14f; background-color: #e7e7e7;">"github.user"</span><span class="ef-ob">)))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (equal remote gh-user)
                (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> origin
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob">
                     (string-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`https://github\\.com/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">\\.git\\'"</span><span class="ef-ob">
                                   origin)
                     (not (string= (match-string 1 origin) gh-user)))
                  t)
                (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> origin
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> origin
                          (replace-regexp-in-string
                           </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`https://github\\.com/"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"git@github.com:"</span><span class="ef-ob">
                           origin)
                        (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"git@github.com:%s/%s"</span><span class="ef-ob"> gh-user (read-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"GitHub repo Name: "</span><span class="ef-ob"> default-name)))))
           (list remote
                 (magit-read-url
                  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Remote url"</span><span class="ef-ob">
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> origin
                       (string-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">:/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">/[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">\\.git</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?\\'"</span><span class="ef-ob"> origin)
                       (replace-match remote t t origin 1)))
                 (transient-args 'magit-remote))))))
  args)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Commit message templates</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :noweb-ref magit-tweaks
<span style="font-weight: 700;">:END:</span>

One little thing I want to add is some per-project commit message templates.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref magit-toplevel
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+magit-project-commit-templates-alist</span><span class="ef-ob"> nil
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Alist of toplevel dirs and template hf strings/functions."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+magit-fill-in-commit-template</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Insert template from `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+magit-fill-in-commit-template</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' if applicable."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((template (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob"> (goto-char (point-min)) (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`\\s-*$"</span><span class="ef-ob"> (thing-at-point 'line)))
                            (cdr (assoc (file-name-base (directory-file-name (magit-toplevel)))
                                        +magit-project-commit-templates-alist)))))
    (goto-char (point-min))
    (insert (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (stringp template) template (funcall template)))
    (goto-char (point-min))
    (end-of-line)))
(add-hook 'git-commit-setup-hook #'+magit-fill-in-commit-template 90)
</span><span class="ef-obe">#+end_src
</span>
This is particularly useful when creating commits for Org, as they need to
follow <span style="color: #4078f2; font-weight: 700;">[[https://orgmode.org/worg/org-contribute.html#commit-messages][a certain format]]</span> and sometimes I forget elements (oops!).
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-commit-message-template</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Create a skeleton for an Org commit message based on the staged diff."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (change-data last-file file-changes temp-point)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
      (apply #'call-process magit-git-executable
             nil t nil
             (append
              magit-git-global-arguments
              (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"diff"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"--cached"</span><span class="ef-ob">)))
      (goto-char (point-min))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^@@</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">^\\+\\+\\+ b/"</span><span class="ef-ob"> nil t)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (looking-back </span><span style="color: #50a14f; background-color: #e7e7e7;">"^\\+\\+\\+ b/"</span><span class="ef-ob"> (line-beginning-position))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
              (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (list last-file file-changes) change-data)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> last-file (buffer-substring-no-properties (point) (line-end-position))
                    file-changes nil))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> temp-point (line-beginning-position))
          (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^\\+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">^-"</span><span class="ef-ob"> nil t)
          (end-of-line)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
           ((string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.el$"</span><span class="ef-ob"> last-file)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-backward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">[+-]? *</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">@@[ +-\\d,]+@@ </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">(</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">cl-</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">defun</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">defvar</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">defmacro</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">defcustom</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> temp-point t)
              (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">cl-</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">defun</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">defvar</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">defmacro</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">defcustom</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span> <span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">[:space:]\n]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> nil t)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (match-string 1) file-changes)))
           ((string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.org$"</span><span class="ef-ob"> last-file)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-backward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[+-]\\*+ </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">^@@[ +-\\d,]+@@ \\*+ "</span><span class="ef-ob"> temp-point t)
              (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"@@ \\*+ "</span><span class="ef-ob"> nil t)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (buffer-substring-no-properties (point) (line-end-position)) file-changes)))))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> file-changes (delete-dups file-changes))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (list last-file file-changes) change-data)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> change-data (delete '(nil nil) change-data))
    (concat
     (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= 1 (length change-data))
         (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"^.*/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">.[a-z]+$"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> (caar change-data))
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"?"</span><span class="ef-ob">)
     </span><span style="color: #50a14f; background-color: #e7e7e7;">": \n\n"</span><span class="ef-ob">
     (mapconcat
      (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (file-changes)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (cadr file-changes)
            (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"* %s (%s): "</span><span class="ef-ob">
                    (car file-changes)
                    (mapconcat #'identity (cadr file-changes) </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">))
          (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"* %s: "</span><span class="ef-ob"> (car file-changes))))
      change-data
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n"</span><span class="ef-ob">))))

(add-to-list '+magit-project-commit-templates-alist (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"org"</span><span class="ef-ob"> #'+org-commit-message-template))
</span><span class="ef-obe">#+end_src
</span>
This relies on two small entries in the git config files which improves the hunk
heading line selection for elisp and Org files.

<span class="ef-obb">#+begin_src gitconfig
</span><span class="ef-ob">[</span><span style="color: #986801; background-color: #e7e7e7;">diff</span> <span style="color: #a626a4; background-color: #e7e7e7;">"lisp"</span><span class="ef-ob">]
  </span><span style="color: #6a1868; background-color: #e7e7e7;">xfuncname</span><span class="ef-ob"> = </span><span style="color: #50a14f; background-color: #e7e7e7;">"^(((;;;+ )|\\(|([ \t]+\\(((cl-|el-patch-)?def(un|var|macro|method|custom)|gb/))).*)$"</span><span class="ef-ob">

[</span><span style="color: #986801; background-color: #e7e7e7;">diff</span> <span style="color: #a626a4; background-color: #e7e7e7;">"org"</span><span class="ef-ob">]
  </span><span style="color: #6a1868; background-color: #e7e7e7;">xfuncname</span><span class="ef-ob"> = </span><span style="color: #50a14f; background-color: #e7e7e7;">"^(\\*+ +.*)$"</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Magit delta</span>

<span style="color: #4078f2; font-weight: 700;">[[https://github.com/dandavison/delta/][Delta]]</span> is a git diff syntax highlighter written in rust. The author also wrote a
package to hook this into the Magit diff view (which don't get any syntax
highlighting by default). This requires the <span style="color: #84888b;">~delta~</span> binary. It's packaged on some
distributions, but most reliably installed through Rust's package manager cargo.

<span class="ef-obb">#+begin_src shell :eval no :tangle (if (or (not (executable-find "cargo")) (executable-find "delta")) "no" "setup.sh")
</span><span class="ef-ob">cargo install git-delta
</span><span class="ef-obe">#+end_src
</span>
Now we can make use of the package for this.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el :noweb-ref none
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(package! magit-delta :recipe (:host github :repo "dandavison/magit-delta") :pin "5fc7dbddcfacfe46d3fd876172ad02a9ab6ac616")
</span><span class="ef-obe">#+end_src
</span>
All that's left is to hook it into magit
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(magit-delta-mode +1)
</span><span class="ef-obe">#+end_src
</span>Unfortunately this currently seems to mess things up, which is something I'll
want to look into later.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** MPRIS</span>

It's nice to be able to interact with MPRIS players. This would just be a
dependency of <span style="color: #84888b;">=org-music=</span> or <span style="color: #84888b;">=doom-modeline-media-player=</span>, but I haven't made it
available on any an elisp archives. Thankfully most Emacs package managers make
using Git repository URLs pretty easy these days.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> mpris </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/mpris"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Smerge</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Smerge")</span>

For repeated operations, a hydra would be helpful. But I prefer transient.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">smerge-repeatedly</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Perform smerge actions again and again"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (smerge-mode 1)
  (smerge-transient))
(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> transient
  (transient-define-prefix smerge-transient ()
    [[</span><span style="color: #50a14f; background-color: #e7e7e7;">"Move"</span><span class="ef-ob">
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"n"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"next"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-next)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"p"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"previous"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-prev)) (smerge-repeatedly)))]
     [</span><span style="color: #50a14f; background-color: #e7e7e7;">"Keep"</span><span class="ef-ob">
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"b"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"base"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-keep-base)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"u"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"upper"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-keep-upper)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"l"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lower"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-keep-lower)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"a"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"all"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-keep-all)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"RET"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"current"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-keep-current)) (smerge-repeatedly)))]
     [</span><span style="color: #50a14f; background-color: #e7e7e7;">"Diff"</span><span class="ef-ob">
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"upper/base"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-diff-base-upper)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"="</span> <span style="color: #50a14f; background-color: #e7e7e7;">"upper/lower"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-diff-upper-lower)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"&gt;"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"base/lower"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-diff-base-lower)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"R"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"refine"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-refine)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"E"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ediff"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-ediff)) (smerge-repeatedly)))]
     [</span><span style="color: #50a14f; background-color: #e7e7e7;">"Other"</span><span class="ef-ob">
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"c"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"combine"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-combine-with-next)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"r"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"resolve"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-resolve)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"k"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"kill current"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (smerge-kill-current)) (smerge-repeatedly)))
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"quit"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">) (smerge-auto-leave)))]]))
</span><span class="ef-obe">#+end_src
</span><span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Corfu</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Corfu", after="corfu")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:completion corfu=</span> module.
<span class="ef-obe">#+end_quote
</span>
I like completion, but I don't like to feel spammed by it, so let's up the delay.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> corfu-auto-delay 0.5)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Projectile</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Projectile")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:core packages=</span> module.
<span class="ef-obe">#+end_quote
</span>
Looking at documentation via <span style="color: #84888b;">=SPC h f=</span> and <span style="color: #84888b;">=SPC h v=</span> and looking at the source can
add package src directories to projectile. This isn't desirable in my opinion.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> projectile-ignored-projects
      (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"/tmp"</span><span class="ef-ob"> (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"straight/repos"</span><span class="ef-ob"> doom-local-dir)))
(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">projectile-ignored-project-function</span><span class="ef-ob"> (filepath)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return t if FILEPATH is within any of `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">projectile-ignored-projects</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (p) (string-prefix-p p filepath)) projectile-ignored-projects)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Jinx</span>

<span style="color: #84888b;">#+call: confpkg()</span>

Minad's Jinx spell-checker looks pretty nifty. When Henrik and I (or someone
else) have some more bandwidth, I think it would be good to incorporate with
Doom.

In the meantime, let's use it here.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> jinx)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Configuration</span>

Jinx has some pretty lovely defaults out of the box, we'll just be making a few
tweaks.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! jinx
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:defer</span><span class="ef-ob"> t
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (add-hook 'doom-init-ui-hook #'global-jinx-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span>
  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Use my custom dictionary
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> jinx-languages </span><span style="color: #50a14f; background-color: #e7e7e7;">"en-custom"</span><span class="ef-ob">)
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Extra face(s) to ignore
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> 'org-inline-src-block
        (alist-get 'org-mode jinx-exclude-faces))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Take over the relevant bindings.
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> ispell
    (global-set-key [remap ispell-word] #'jinx-correct))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> evil-commands
    (global-set-key [remap evil-next-flyspell-error] #'jinx-next)
    (global-set-key [remap evil-prev-flyspell-error] #'jinx-previous))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">I prefer for `</span><span style="color: #b751b6; background-color: #e7e7e7;">point</span><span style="color: #84888b; background-color: #e7e7e7;">' to end up at the start of the word,
</span>  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">not just after the end.
</span><span class="ef-ob">  (advice-add 'jinx-next </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (_) (left-word))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Autocorrect</span>

<span style="color: #84888b;">#+call: confpkg()</span>

I used to have a small collection of configuration here, but then it grew
larger, and now it's a package.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> autocorrect </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/autocorrect"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
To integrate Jinx with the <span style="color: #84888b;">=autocorrect=</span> package, we need to tell it:
+ About corrections made with Jinx
+ How to tell if a word is spelled correctly with Jinx
+ When it's appropriate to make an autocorrection

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! autocorrect
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> jinx
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span>
  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Integrate with Jinx
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">autocorrect-jinx-record-correction</span><span class="ef-ob"> (overlay corrected)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Record that Jinx corrected the text in OVERLAY to CORRECTED."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((text
           (buffer-substring-no-properties
            (overlay-start overlay)
            (overlay-end overlay))))
      (autocorrect-record-correction text corrected)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">autocorrect-jinx-check-spelling</span><span class="ef-ob"> (word)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Check if WORD is valid."</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Mostly a copy of `</span><span style="color: #b751b6; background-color: #e7e7e7;">jinx--word-valid-p</span><span style="color: #84888b; background-color: #e7e7e7;">', just without the buffer substring.
</span>    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">It would have been nice if `</span><span style="color: #b751b6; background-color: #e7e7e7;">jinx--word-valid-p</span><span style="color: #84888b; background-color: #e7e7e7;">' implemented like this
</span>    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">with `</span><span style="color: #b751b6; background-color: #e7e7e7;">jinx--this-word-valid-p</span><span style="color: #84888b; background-color: #e7e7e7;">' (or similar) as the at-point variant.
</span><span class="ef-ob">    (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (member word jinx--session-words)
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Allow capitalized words
</span><span class="ef-ob">        (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`[[:upper:]][[:lower:]]+\\'"</span><span class="ef-ob"> word)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-loop</span><span class="ef-ob">
              for w in jinx--session-words
              thereis (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string-equal-ignore-case word w)
                           (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`[[:lower:]]+\\'"</span><span class="ef-ob"> w))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-loop</span><span class="ef-ob"> for dict in jinx--dicts
                 thereis (jinx--mod-check dict word))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">autocorrect-jinx-appropriate</span><span class="ef-ob"> (pos)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return non-nil if it is appropriate to spellcheck at POS according to jinx."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (jinx--face-ignored-p pos))
         (not (jinx--regexp-ignored-p pos))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> autocorrect-check-spelling-function #'autocorrect-jinx-check-spelling)
  (add-to-list 'autocorrect-predicates #'autocorrect-jinx-appropriate)
  (advice-add 'jinx--correct-replace </span><span style="color: #a626a4; background-color: #e7e7e7;">:before</span><span class="ef-ob"> #'autocorrect-jinx-record-correction)

  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Run setup
</span><span class="ef-ob">  (run-with-idle-timer 0.5 nil #'autocorrect-setup)

  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Make work with evil-mode
</span><span class="ef-ob">  (evil-collection-set-readonly-bindings 'autocorrect-list-mode-map)
  (evil-collection-define-key 'normal 'autocorrect-list-mode-map
    (kbd </span><span style="color: #50a14f; background-color: #e7e7e7;">"a"</span><span class="ef-ob">) #'autocorrect-create-correction
    (kbd </span><span style="color: #50a14f; background-color: #e7e7e7;">"x"</span><span class="ef-ob">) #'autocorrect-remove-correction
    (kbd </span><span style="color: #50a14f; background-color: #e7e7e7;">"i"</span><span class="ef-ob">) #'autocorrect-ignore-word))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Downloading dictionaries</span>

Let's get a nice big dictionary from <span style="color: #4078f2; font-weight: 700;">[[http://app.aspell.net/create][SCOWL Custom List/Dictionary Creator]]</span> with
the following configuration
- <span style="font-weight: 700;">size ::</span> 80 (huge)
- <span style="font-weight: 700;">spellings ::</span> British(-ise) and Australian
- <span style="font-weight: 700;">spelling variants level ::</span> 0
- <span style="font-weight: 700;">diacritics ::</span> keep
- <span style="font-weight: 700;">extra lists ::</span> hacker, roman numerals

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Hunspell</span>

<span class="ef-obb">#+begin_src shell :tangle (if (file-exists-p "~/.config/enchant/hunspell") "no" "setup.sh")
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> /tmp
</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> [ </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">!</span><span class="ef-ob"> -d hunspell-en-custom ]; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span><span class="ef-ob">
    curl -o </span><span style="color: #50a14f; background-color: #e7e7e7;">"hunspell-en-custom.zip"</span> <span style="color: #50a14f; background-color: #e7e7e7;">'http://app.aspell.net/create?max_size=80&amp;spelling=GBs&amp;spelling=AU&amp;max_variant=0&amp;diacritic=keep&amp;special=hacker&amp;special=roman-numerals&amp;encoding=utf-8&amp;format=inline&amp;download=hunspell'</span><span class="ef-ob">
    unzip </span><span style="color: #50a14f; background-color: #e7e7e7;">"hunspell-en-custom.zip"</span><span class="ef-ob"> -d hunspell-en-custom
</span><span style="color: #e45649; background-color: #e7e7e7;">fi</span>

<span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> hunspell-en-custom
</span><span style="color: #6a1868; background-color: #e7e7e7;">DESTDIR1</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$HOME/.local/share/hunspell"</span>
<span style="color: #6a1868; background-color: #e7e7e7;">DESTDIR2</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$HOME/.config/enchant/hunspell"</span><span class="ef-ob">
mkdir -p </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DESTDIR1"</span><span class="ef-ob">
mkdir -p </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DESTDIR2"</span><span class="ef-ob">
cp en-custom.{aff,dic} </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DESTDIR1"</span><span class="ef-ob">
cp en-custom.{aff,dic} </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DESTDIR2"</span>
<span class="ef-obe">#+end_src
</span>
We will also add an accompanying <span style="color: #84888b;">=doctor=</span> warning.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"hunspell"</span><span class="ef-ob">)
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find hunspell executable."</span><span class="ef-ob">))
(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.local/share/hunspell/en-custom.dic"</span><span class="ef-ob">)
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Custom hunspell dictionary is not present."</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Aspell</span>

<span class="ef-obb">#+begin_src shell :tangle (if (file-expand-wildcards "~/.config/enchant/aspell/en-custom.multi") "no" "setup.sh")
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> /tmp
</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> [ </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">!</span><span class="ef-ob"> -d aspell6-en-custom ]; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span><span class="ef-ob">
    curl -o </span><span style="color: #50a14f; background-color: #e7e7e7;">"aspell6-en-custom.tar.bz2"</span> <span style="color: #50a14f; background-color: #e7e7e7;">'http://app.aspell.net/create?max_size=80&amp;spelling=GBs&amp;spelling=AU&amp;max_variant=0&amp;diacritic=keep&amp;special=hacker&amp;special=roman-numerals&amp;encoding=utf-8&amp;format=inline&amp;download=aspell'</span><span class="ef-ob">
    tar -xjf </span><span style="color: #50a14f; background-color: #e7e7e7;">"aspell6-en-custom.tar.bz2"</span>
<span style="color: #e45649; background-color: #e7e7e7;">fi</span>

<span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> aspell6-en-custom
</span><span style="color: #6a1868; background-color: #e7e7e7;">DESTDIR</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$HOME/.config/enchant/"</span><span class="ef-ob"> ./configure
sed -i </span><span style="color: #50a14f; background-color: #e7e7e7;">'s/dictdir = .*/dictdir = "aspell"/'</span><span class="ef-ob"> Makefile
sed -i </span><span style="color: #50a14f; background-color: #e7e7e7;">'s/datadir = .*/datadir = "aspell"/'</span><span class="ef-ob"> Makefile
make &amp;&amp; make install
</span><span class="ef-obe">#+end_src
</span>
We will also add an accompanying <span style="color: #84888b;">=doctor=</span> warning.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"aspell"</span><span class="ef-ob">)
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find aspell executable."</span><span class="ef-ob">))
(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.config/enchant/aspell/en-custom.multi"</span><span class="ef-ob">)
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Custom aspell dictionary is not present."</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** TRAMP</span>

<span style="color: #84888b;">#+call: confpkg("TRAMP")</span>

Another lovely Emacs feature, TRAMP stands for <span style="text-decoration: italic;">/Transparent Remote Access,
Multiple Protocol/</span>. In brief, it's a lovely way to wander around outside your
local filesystem.

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Prompt recognition</span>

Unfortunately, when connecting to remote machines Tramp can be a wee pit picky
with the prompt format. Let's try to get Bash, and be a bit more permissive with
prompt recognition.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> tramp
  (setenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"SHELL"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"/bin/bash"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> tramp-shell-prompt-pattern </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">^</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\n</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\x0d</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">]#$%&gt;\n]*#?[]#$%&gt;] *</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">\e\\[[0-9;]*[a-zA-Z] *</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">*"</span><span class="ef-ob">)) </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">default + 
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Troubleshooting</span>

In case the remote shell is misbehaving, here are some things to try

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Zsh</span>

There are some escape code you don't want, let's make it behave more considerately.
<span class="ef-obb">#+begin_src shell :eval no :tangle no
</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> [[ </span><span style="color: #50a14f; background-color: #e7e7e7;">"$TERM"</span><span class="ef-ob"> == </span><span style="color: #50a14f; background-color: #e7e7e7;">"dumb"</span><span class="ef-ob"> ]]; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">unset</span><span class="ef-ob"> zle_bracketed_paste
    </span><span style="color: #a626a4; background-color: #e7e7e7;">unset</span><span class="ef-ob"> zle
    </span><span style="color: #6a1868; background-color: #e7e7e7;">PS1</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">'$ '</span>
    <span style="color: #e45649; background-color: #e7e7e7;">return</span>
<span style="color: #e45649; background-color: #e7e7e7;">fi</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Guix</span>

<span style="color: #4078f2; font-weight: 700;">[[https://guix.gnu.org/][Guix]]</span> puts some binaries that TRAMP looks for in unexpected locations.
That's no problem though, we just need to help TRAMP find them.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> tramp
  (</span><span style="color: #e45649; background-color: #e7e7e7;">appendq!</span><span class="ef-ob"> tramp-remote-path
            '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.guix-profile/bin"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"~/.guix-profile/sbin"</span>
              <span style="color: #50a14f; background-color: #e7e7e7;">"/run/current-system/profile/bin"</span>
              <span style="color: #50a14f; background-color: #e7e7e7;">"/run/current-system/profile/sbin"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Auto activating snippets</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg AAS")</span>

Sometimes pressing <span style="color: #84888b;">=TAB=</span> is just too much.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> aas </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ymarco/auto-activating-snippets"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ddc2b7a58a2234477006af348b30e970f73bc2c1"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! aas
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> aas-mode)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Screenshot</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Screenshot")</span>

This makes it a breeze to take lovely screenshots.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> screenshot </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/screenshot"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt Example screenshot.el screenshot</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/screenshot.png]]</span>

Some light configuring is all we need, so we can make use of the <span style="color: #4078f2; font-weight: 700;">[[https://github.com/Calinou/0x0][0x0]]</span> wrapper
file uploading script (which I've renamed to <span style="color: #84888b;">~upload~</span>).

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! screenshot
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:defer</span><span class="ef-ob"> t
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> screenshot-upload-fn </span><span style="color: #50a14f; background-color: #e7e7e7;">"upload %s 2&gt;/dev/null"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Etrace</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg etrace")</span>

The <span style="text-decoration: italic;">/Emacs Lisp Profiler/</span> (ELP) does a nice job recording information, but it
isn't the best for looking at results. <span style="color: #84888b;">=etrace=</span> converts ELP's results to the
"Chromium Catapult Trace Event Format". This means that the output of <span style="color: #84888b;">=etrace=</span> can
be loaded in something like the <span style="color: #4078f2; font-weight: 700;">[[https://www.speedscope.app/][speedscope]]</span> webapp for easier profile
investigation.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> etrace </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"aspiers/etrace"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"2291ccf2f2ccc80a6aac4664e8ede736ceb672b7"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! etrace
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> elp)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** YASnippet</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg YASnippet")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:editor snippets=</span> module.
<span class="ef-obe">#+end_quote
</span>
Nested snippets are good, so let's enable that.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> yas-triggers-in-field t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** String inflection</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg String Inflection")</span>

For when you want to change the case pattern for a symbol.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> string-inflection </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"617df25e91351feffe6aff4d9e4724733449d608"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! string-inflection
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> (string-inflection-all-cycle
             string-inflection-toggle
             string-inflection-camelcase
             string-inflection-lower-camelcase
             string-inflection-kebab-case
             string-inflection-underscore
             string-inflection-capital-underscore
             string-inflection-upcase)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:leader</span> <span style="color: #a626a4; background-color: #e7e7e7;">:prefix</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"c~"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"naming convention"</span><span class="ef-ob">)
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cycle"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"~"</span><span class="ef-ob"> #'string-inflection-all-cycle
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"toggle"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span><span class="ef-ob"> #'string-inflection-toggle
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"CamelCase"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"c"</span><span class="ef-ob"> #'string-inflection-camelcase
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"downCase"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"d"</span><span class="ef-ob"> #'string-inflection-lower-camelcase
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"kebab-case"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"k"</span><span class="ef-ob"> #'string-inflection-kebab-case
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"under_score"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"_"</span><span class="ef-ob"> #'string-inflection-underscore
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Upper_Score"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"u"</span><span class="ef-ob"> #'string-inflection-capital-underscore
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"UP_CASE"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"U"</span><span class="ef-ob"> #'string-inflection-upcase)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> evil
    (evil-define-operator evil-operator-string-inflection (beg end _type)
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"Define a new evil operator that cycles symbol casing."</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:move-point</span><span class="ef-ob"> nil
      (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;R&gt;"</span><span class="ef-ob">)
      (string-inflection-all-cycle)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> evil-repeat-info '([?g ?~])))
    (define-key evil-normal-state-map (kbd </span><span style="color: #50a14f; background-color: #e7e7e7;">"g~"</span><span class="ef-ob">) 'evil-operator-string-inflection)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Smart parentheses</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg SmartParens")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:core packages=</span> module.
<span class="ef-obe">#+end_quote
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(sp-local-pair
 '(org-mode)
 </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;&lt;"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&gt;&gt;"</span>
 <span style="color: #a626a4; background-color: #e7e7e7;">:actions</span><span class="ef-ob"> '(insert))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Visuals</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Info colours</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Info colors")</span>

This makes manual pages nicer to look at by adding variable pitch fontification
and colouring 🙂.

<span style="color: #84888b;">#+attr_html: :class invertible :style width:80% :alt Example info-colours page.</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/info-colours.png]]</span>

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> info-colors </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"2e237c301ba62f0e0286a27c1abe48c4c8441143"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
To use this we'll just hook it into <span style="color: #84888b;">=Info=</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! info-colors
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> (info-colors-fontify-node))

(add-hook 'Info-selection-hook 'info-colors-fontify-node)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt Example colourised info page</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/info-coloured.png]]</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Modus themes</span>

Proteolas did a lovely job with the Modus themes, so much so that they were
welcomed into Emacs 28. However, he is also rather attentive with updates, and
so I'd like to make sure we have a recent version.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> modus-themes </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"f3cd4d6983566dab0ef3bcddf812cfd565d00d08"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"3576d14f06f245c3111496bfb035bb0926f48089"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Spacemacs themes</span>

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> spacemacs-theme </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"a7c5dccb4a037ba1f090015fc8ffb9566c64e369"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Theme magic</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Theme magic")</span>

With all our fancy Emacs themes, my terminal is missing out!
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> theme-magic </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"844c4311bd26ebafd4b6a1d72ddcc65d87f074e3"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
This operates using <span style="color: #84888b;">=pywal=</span>, which is present in some repositories, but most
reliably installed with <span style="color: #84888b;">=pip=</span>.

<span class="ef-obb">#+begin_src shell :eval no :tangle (if (executable-find "wal") "no" "setup.sh")
</span><span class="ef-ob">sudo python3 -m pip install pywal
</span><span class="ef-obe">#+end_src
</span>
We can also add a <span style="color: #84888b;">=doctor=</span> check.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"wal"</span><span class="ef-ob">)
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find the pywal executable (wal), theme-magic will not function."</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Theme magic takes a look at a number of faces, the saturation levels, and colour
differences to try to cleverly pick eight colours to use. However, it uses the
same colours for the light variants, and doesn't always make the best picks.
Since we're using <span style="color: #84888b;">=doom-themes=</span>, our life is a little easier and we can use the
colour utilities from Doom themes to easily grab sensible colours and generate
lightened versions --- let's do that.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! theme-magic
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> theme-magic-from-emacs
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> theme-magic--auto-extract-16-doom-colors ()
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'theme-magic--auto-extract-16-colors
    (list
     (face-attribute 'default </span><span style="color: #a626a4; background-color: #e7e7e7;">:background</span><span class="ef-ob">)
     (doom-color 'error)
     (doom-color 'success)
     (doom-color 'type)
     (doom-color 'keywords)
     (doom-color 'constants)
     (doom-color 'functions)
     (face-attribute 'default </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">)
     (face-attribute 'shadow </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">)
     (doom-blend 'base8 'error 0.1)
     (doom-blend 'base8 'success 0.1)
     (doom-blend 'base8 'type 0.1)
     (doom-blend 'base8 'keywords 0.1)
     (doom-blend 'base8 'constants 0.1)
     (doom-blend 'base8 'functions 0.1)
     (face-attribute 'default </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Simple comment markup</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg simple-comment-markup")</span>

I find that every now and then I sprinkle a little markup in code comments. Of
course, this doesn't get fortified as it's ultimately meaningless ... but it
would be nice if it was, just slightly. Surprisingly, I couldn't find a package
for this, so I made one.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> simple-comment-markup </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/simple-comment-markup"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Let's use both basic Org markup and Markdown code backticks, to cover most
situations decently.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! simple-comment-markup
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (prog-mode . simple-comment-markup-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> simple-comment-markup-set '(org markdown-code)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Doom modeline</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Doom modeline", after="doom-modeline")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:ui modeline=</span> module.
<span class="ef-obe">#+end_quote
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Modified buffer colour</span>

The modeline is very nice and pretty, however I have a few niggles with the
defaults. For starters, by default <span style="color: #84888b;">~red~</span> text is used to indicate an unsaved file.
This makes me feel like something's gone <span style="text-decoration: italic;">/wrong/</span>, so let's tone that down to
orange.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(custom-set-faces!
  '(doom-modeline-buffer-modified </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span> <span style="color: #50a14f; background-color: #e7e7e7;">"orange"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Height</span>

The default size (<span style="color: #84888b;">=25=</span>) makes for a rather narrow mode line. To me, the modeline
feels a bit comfier if we give it a bit more space. I find <span style="color: #84888b;">=45=</span> adds roughly a
third of the line height as padding above and below.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-modeline-height 45)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** File encoding</span>

While we're modifying the modeline, when we have the default file encoding (<span style="color: #84888b;">=LF
UTF-8=</span>), it really isn't worth noting in the modeline. So, why not conditionally
hide it?

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">doom-modeline-conditional-buffer-encoding</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"We expect the encoding to be LF UTF-8, so only show the modeline when this is not the case"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> doom-modeline-buffer-encoding
              (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (memq (plist-get (coding-system-plist buffer-file-coding-system) </span><span style="color: #a626a4; background-color: #e7e7e7;">:category</span><span class="ef-ob">)
                                 '(coding-category-undecided coding-category-utf-8))
                           (not (memq (coding-system-eol-type buffer-file-coding-system) '(1 2))))
                t)))

(add-hook 'after-change-major-mode-hook #'doom-modeline-conditional-buffer-encoding)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Analogue clock</span>

Now that my code for an analogue clock icon has been upstreamed, all I do here
is adjust the size slightly 🙂.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-modeline-time-clock-size 0.65)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Media player</span>

Sometimes (particularly when reading a novel, with Emacs full-screened) it would
be nice to know what I'm listening to. We can put this information in the
modeline with my media player package.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> doom-modeline-media-player
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/doom-modeline-media-player"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
To enable the lazy loading, we make <span style="color: #84888b;">=doom-modeline=</span> aware of the segment function
in <span style="color: #84888b;">~:init~</span>, and the segment function itself is autoloaded.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! doom-modeline-media-player
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:defer</span><span class="ef-ob"> t
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> doom-modeline
    (add-to-list 'doom-modeline-fn-alist
                 (cons 'media-player #'doom-modeline-segment--media-player)))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+single-fullscreen-window-p</span><span class="ef-ob"> ()
    (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (memq (frame-parameter nil 'fullscreen) '(fullscreen fullboth))
         (not (consp (car (window-tree))))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-modeline-media-player #'+single-fullscreen-window-p
        doom-modeline-media-player-playback-indication 'dim))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** PDF modeline</span>

I think the PDF modeline could do with tweaking. I raised <span style="color: #4078f2; font-weight: 700;">[[https://github.com/seagle0128/doom-modeline/pull/425][an issue]]</span> on this,
however the response was basically "put your preferences in your personal
config, the current default is sensible" --- so here we are.

First up I'm going to want a segment for just the buffer file name, and a PDF
icon. Then we'll redefine two functions used to generate the modeline.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(doom-modeline-def-segment buffer-name
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Display the current buffer's name, without any other information."</span><span class="ef-ob">
  (concat
   (doom-modeline-spc)
   (doom-modeline--buffer-name)))

(doom-modeline-def-segment pdf-icon
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"PDF icon from nerd-icons."</span><span class="ef-ob">
  (concat
   (doom-modeline-icon sucicon </span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-seti-pdf"</span><span class="ef-ob"> nil nil
   (doom-modeline-spc)
                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (doom-modeline--active)
                                 'nerd-icons-red
                               'mode-line-inactive)
                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob"> 0.02)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">doom-modeline-update-pdf-pages</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Update PDF pages."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-modeline--pdf-pages
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((current-page-str (number-to-string (eval `(pdf-view-current-page))))
              (total-page-str (number-to-string (pdf-cache-number-of-pages))))
          (concat
           (propertize
            (concat (make-string (- (length total-page-str) (length current-page-str)) ? )
                    </span><span style="color: #50a14f; background-color: #e7e7e7;">" P"</span><span class="ef-ob"> current-page-str)
            'face 'mode-line)
           (propertize (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"/"</span><span class="ef-ob"> total-page-str) 'face 'doom-modeline-buffer-minor-mode)))))

(doom-modeline-def-segment pdf-pages
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Display PDF pages."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (doom-modeline--active) doom-modeline--pdf-pages
    (propertize doom-modeline--pdf-pages 'face 'mode-line-inactive)))

(doom-modeline-def-modeline 'pdf
  '(bar window-number pdf-pages pdf-icon buffer-name)
  '(media-player misc-info matches major-mode process vcs))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Keycast</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Keycast")</span>

For some reason, I find myself demoing Emacs every now and then. Showing what
keyboard stuff I'm doing on-screen seems helpful. While <span style="color: #4078f2; font-weight: 700;">[[https://gitlab.com/screenkey/screenkey][screenkey]]</span> does exist,
having something that doesn't cover up screen content is nice.

<span style="color: #84888b;">#+attr_html: :class invertible :alt Screenshot of Keycast-mode in action</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/keycast.png]]</span>

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> keycast </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"53514c3dc3dfb7d4c3a65898b0b3edb69b6536c2"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Let's just make sure this is lazy-loaded appropriately.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! keycast
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> keycast-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">define-minor-mode</span> <span style="color: #a626a4; background-color: #e7e7e7;">keycast-mode</span>
    <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Show current command and its key binding in the mode line."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:global</span><span class="ef-ob"> t
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> keycast-mode
        (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
          (add-hook 'pre-command-hook 'keycast--update t)
          (add-to-list 'global-mode-string '(</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> mode-line-keycast </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">)))
      (remove-hook 'pre-command-hook 'keycast--update)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> global-mode-string (remove '(</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> mode-line-keycast </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">) global-mode-string))))
  (custom-set-faces!
    '(keycast-command </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> doom-modeline-debug
                      </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 0.9)
    '(keycast-key </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> custom-modified
                  </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.1
                  </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> bold)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Screencast</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Screencast")</span>

In a similar manner to <span style="color: #4078f2; font-weight: 700;">[[Keycast]]</span>, <span style="color: #4078f2; font-weight: 700;">[[https://gitlab.com/ambrevar/emacs-gif-screencast][gif-screencast]]</span> may come in handy.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> gif-screencast </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"6798656d3d3107d16e30cc26bc3928b00e50c1ca"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
We can lazy load this using the start/stop commands.

I initially installed <span style="color: #84888b;">~scrot~</span> for this, since it was the default capture program.
However it raised <span style="color: #84888b;">~glib error: Saving to file ... failed~</span> each time it was run.
Google didn't reveal any easy fixed, so I switched to <span style="color: #4078f2; font-weight: 700;">[[https://github.com/naelstrof/maim][maim]]</span>. We now need to pass
it the window ID. This doesn't change throughout the lifetime of an Emacs
instance, so as long as a single window is used <span style="color: #84888b;">~xdotool getactivewindow~</span> will
give a satisfactory result.

It seems that when new colours appear, that tends to make <span style="color: #84888b;">~gifsicle~</span> introduce
artefacts. To avoid this we pre-populate the colour map using the current doom
theme.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! gif-screencast
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> gif-screencast-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> gif-screencast-mode-map
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:g</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;f8&gt;"</span><span class="ef-ob"> #'gif-screencast-toggle-pause
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:g</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;f9&gt;"</span><span class="ef-ob"> #'gif-screencast-stop)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> gif-screencast-program </span><span style="color: #50a14f; background-color: #e7e7e7;">"maim"</span><span class="ef-ob">
        gif-screencast-args `(</span><span style="color: #50a14f; background-color: #e7e7e7;">"--quality"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"3"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-i"</span><span class="ef-ob"> ,(string-trim-right
                                                     (shell-command-to-string
                                                      </span><span style="color: #50a14f; background-color: #e7e7e7;">"xdotool getactivewindow"</span><span class="ef-ob">)))
        gif-screencast-optimize-args '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"--batch"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"--optimize=3"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"--usecolormap=/tmp/doom-color-theme"</span><span class="ef-ob">))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">gif-screencast-write-colormap</span><span class="ef-ob"> ()
    (write-region
     (replace-regexp-in-string
      </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n+"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">
      (mapconcat (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (c) (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (listp (cdr c))
                            (cadr c))) </span><span style="color: #986801; background-color: #e7e7e7;">doom-themes--colors </span><span style="color: #986801; background-color: #e7e7e7;">"\n"</span><span style="color: #986801; background-color: #e7e7e7;">))</span><span class="ef-ob">
     nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"/tmp/doom-color-theme"</span><span class="ef-ob">))
  (gif-screencast-write-colormap)
  (add-hook 'doom-load-theme-hook #'gif-screencast-write-colormap))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Mixed pitch</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg mixed pitch")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:ui zen=</span> module.
<span class="ef-obe">#+end_quote
</span>
We'd like to use mixed pitch in certain modes. If we simply add a hook, when
directly opening a file with (a new) Emacs <span style="color: #84888b;">=mixed-pitch-mode=</span> runs before UI
initialisation, which is problematic. To resolve this, we create a hook that
runs after UI initialisation and both
+ conditionally enables <span style="color: #84888b;">=mixed-pitch-mode=</span>
+ sets up the mixed pitch hooks

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">mixed-pitch-modes</span><span class="ef-ob"> '(org-mode LaTeX-mode markdown-mode gfm-mode Info-mode)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Modes that `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mixed-pitch-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' should be enabled in, but only after UI initialisation."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">init-mixed-pitch-h</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Hook `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mixed-pitch-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' into each mode in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mixed-pitch-modes</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.
Also immediately enables `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mixed-pitch-modes</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' if currently in one of the modes."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (memq major-mode mixed-pitch-modes)
    (mixed-pitch-mode 1))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (hook mixed-pitch-modes)
    (add-hook (intern (concat (symbol-name hook) </span><span style="color: #50a14f; background-color: #e7e7e7;">"-hook"</span><span class="ef-ob">)) #'mixed-pitch-mode)))
(add-hook 'doom-init-ui-hook #'init-mixed-pitch-h)
</span><span class="ef-obe">#+end_src
</span>
As mixed pitch uses the variable <span style="color: #84888b;">=mixed-pitch-face=</span>, we can create a new function
to apply mixed pitch with a serif face instead of the default (see the
subsequent face definition). This was created for writeroom mode.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(autoload #'mixed-pitch-serif-mode </span><span style="color: #50a14f; background-color: #e7e7e7;">"mixed-pitch"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Change the default face of the current buffer to a serifed variable pitch, while keeping some faces fixed pitch."</span><span class="ef-ob"> t)

(</span><span style="color: #e45649; background-color: #e7e7e7;">setq!</span><span class="ef-ob"> variable-pitch-serif-font (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Alegreya"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:size</span><span class="ef-ob"> 27))

(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> mixed-pitch
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mixed-pitch-set-height t)
  (set-face-attribute 'variable-pitch-serif nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:font</span><span class="ef-ob"> variable-pitch-serif-font)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">mixed-pitch-serif-mode</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> arg)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Change the default face of the current buffer to a serifed variable pitch, while keeping some faces fixed pitch."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((mixed-pitch-face 'variable-pitch-serif))
      (mixed-pitch-mode (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> arg 'toggle)))))
</span><span class="ef-obe">#+end_src
</span>
Now, as Harfbuzz is currently used in Emacs, we'll be missing out on the
following Alegreya ligatures:
<span class="ef-obb">#+begin_center
</span>ff <span style="text-decoration: italic;">/ff/</span> ffi <span style="text-decoration: italic;">/ffi/</span> ffj <span style="text-decoration: italic;">/ffj/</span> ffl <span style="text-decoration: italic;">/ffl/</span>
fft <span style="text-decoration: italic;">/fft/</span> fi <span style="text-decoration: italic;">/fi/</span> fj <span style="text-decoration: italic;">/fj/</span> ft <span style="text-decoration: italic;">/ft/</span>
Th <span style="text-decoration: italic;">/Th/</span>
<span class="ef-obe">#+end_center
</span>
Thankfully, it isn't to hard to add these to the <span style="color: #84888b;">~composition-function-table~</span>.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(set-char-table-range composition-function-table ?f '([</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">ff?[fijlt]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> 0 font-shape-gstring]))
(set-char-table-range composition-function-table ?T '([</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">Th</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> 0 font-shape-gstring]))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Variable pitch serif font</span>

<span style="color: #84888b;">#+call: confpkg()</span>

It would be nice if we were able to make use of a serif version of the
<span style="color: #84888b;">=variable-pitch=</span> face. Since this doesn't already exist, let's create it.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defface</span> <span style="color: #6a1868; background-color: #e7e7e7;">variable-pitch-serif</span><span class="ef-ob">
    '((t (</span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"serif"</span><span class="ef-ob">)))
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A variable-pitch face with serifs."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:group</span><span class="ef-ob"> 'basic-faces)
</span><span class="ef-obe">#+end_src
</span>
For ease of use, let's also set up an easy way of setting the <span style="color: #84888b;">~:font~</span> attribute.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defcustom</span> <span style="color: #6a1868; background-color: #e7e7e7;">variable-pitch-serif-font</span><span class="ef-ob"> (font-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"serif"</span><span class="ef-ob">)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"The font face used for `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">variable-pitch-serif</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:group</span><span class="ef-ob"> 'basic-faces
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> '(restricted-sexp </span><span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"font-spec"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:match-alternatives</span><span class="ef-ob"> (fontp))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:set</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (symbol value)
         (set-face-attribute 'variable-pitch-serif nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:font</span><span class="ef-ob"> value)
         (set-default-toplevel-value symbol value)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Marginalia</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Marginalia")</span>

<span class="ef-obb">#+begin_quote
</span>Part of the <span style="color: #84888b;">=:completion vertico=</span> module.
<span class="ef-obe">#+end_quote
</span>
Marginalia is nice, but the file metadata annotations are a little too plain.
Specifically, I have these gripes
+ File attributes would be nicer if coloured
+ I don't care about the user/group information if the user/group is me
+ When a file time is recent, a relative age (e.g. <span style="color: #84888b;">=2h ago=</span>) is more useful than
  the date
+ An indication of file fatness would be nice

Thanks to the <span style="color: #84888b;">~marginalia-annotator-registry~</span>, we don't have to advise, we can
just add a new <span style="color: #84888b;">=file=</span> annotator.

Another small thing is the face used for docstrings. At the moment it's <span style="color: #84888b;">=(italic
shadow)=</span>, but I don't like that.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> marginalia
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> marginalia-censor-variables nil)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +marginalia--anotate-local-file-colorful (cand)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Just a more colourful version of `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">marginalia--anotate-local-file</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'marginalia--annotate-local-file
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> (attrs (file-attributes (substitute-in-file-name
                                       (marginalia--full-candidate cand))
                                      'integer))
      (marginalia--fields
       ((marginalia--file-owner attrs)
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:width</span><span class="ef-ob"> 12 </span><span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> 'marginalia-file-owner)
       ((marginalia--file-modes attrs))
       ((+marginalia-file-size-colorful (file-attribute-size attrs))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:width</span><span class="ef-ob"> 7)
       ((+marginalia--time-colorful (file-attribute-modification-time attrs))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:width</span><span class="ef-ob"> 12))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+marginalia--time-colorful</span><span class="ef-ob"> (time)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((seconds (float-time (time-subtract (current-time) time)))
           (color (doom-blend
                   (face-attribute 'marginalia-date </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob"> nil t)
                   (face-attribute 'marginalia-documentation </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob"> nil t)
                   (/ 1.0 (log (+ 3 (/ (+ 1 seconds) 345600.0)))))))
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">1 - log(3 + 1/(days + 1)) % grey
</span><span class="ef-ob">      (propertize (marginalia--time time) 'face (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob"> color))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+marginalia-file-size-colorful</span><span class="ef-ob"> (size)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((size-index (/ (log (+ 1 size)) 7.0))
           (color (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt; size-index 10000000) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">10m
</span><span class="ef-ob">                      (doom-blend 'orange 'green size-index)
                    (doom-blend 'red 'orange (- size-index 1)))))
      (propertize (file-size-human-readable size) 'face (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob"> color)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Centaur Tabs</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Centaur Tabs")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:ui tabs=</span> module.
<span class="ef-obe">#+end_quote
</span>
We want to make the tabs a nice, comfy size (<span style="color: #84888b;">~36~</span>), with icons. The modifier
marker is nice, but the particular default Unicode one causes a lag spike, so
let's just switch to an <span style="color: #84888b;">~o~</span>, which still looks decent but doesn't cause any
issues.
An 'active-bar' is nice, so let's have one of those. If we have it <span style="color: #84888b;">~under~</span> needs us to
turn on <span style="color: #84888b;">~x-underline-at-decent~</span> though. For some reason this didn't seem to work
inside the <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> ... )</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> block ¯\_(ツ)_/¯.
Then let's change the font to a sans serif, but the default one doesn't fit too
well somehow, so let's switch to 'P22 Underground Book'; it looks much nicer.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> centaur-tabs
  (centaur-tabs-mode -1)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> centaur-tabs-height 36
        centaur-tabs-set-icons t
        centaur-tabs-modified-marker </span><span style="color: #50a14f; background-color: #e7e7e7;">"o"</span><span class="ef-ob">
        centaur-tabs-close-button </span><span style="color: #50a14f; background-color: #e7e7e7;">"×"</span><span class="ef-ob">
        centaur-tabs-set-bar 'above
        centaur-tabs-gray-out-icons 'buffer)
  (centaur-tabs-change-fonts </span><span style="color: #50a14f; background-color: #e7e7e7;">"P22 Underground Book"</span><span class="ef-ob"> 160))
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(setq x-underline-at-descent-line t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Nerd Icons</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Nerd Icons")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:core packages=</span> module.
<span class="ef-obe">#+end_quote
</span>
<span style="color: #84888b;">=nerd-icons=</span> does a generally great job giving file names icons. One minor
niggle I have is that when <span style="text-decoration: italic;">/I/</span> open a <span style="color: #84888b;">=.m=</span> file, it's much more likely to be Matlab
than Objective-C. As such, it'll be switching the icon associated with <span style="color: #84888b;">=.m=</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> nerd-icons
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((matlab-icon (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"matlab"</span><span class="ef-ob"> nerd-icons-extension-icon-alist)))
    (setcdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"m"</span><span class="ef-ob"> nerd-icons-extension-icon-alist)
            (cdr matlab-icon))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Prettier page breaks</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg page break lines")</span>

In some files, <span style="color: #84888b;">=^L=</span> appears as a page break character. This isn't that visually
appealing, and Steve Purcell has been nice enough to make a package to display
these as horizontal rules.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> page-break-lines </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"purcell/page-break-lines"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"982571749c8fe2b5e2997dd043003a1b9fe87b38"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
We can go from "better" to "where has this been all my life?" by now making page
navigation easy with some simple keybindings lifted from <span style="color: #4078f2; font-weight: 700;">[[http://xahlee.info/emacs/emacs/modernization_formfeed.html][Xah Lee]]</span>'s post on the
form feed. Making <span style="color: #84888b;">~forward-page~</span> and <span style="color: #84888b;">~backward-page~</span> work with Evil mode also takes
a little tweaking, so we might as well do that too while we're at it.

We can also make the displayed horizontal rule communicate more useful
information by making it the same as the fill column. While this could be
accomplished by just <span style="color: #84888b;">=setq=​</span>ing the rule width to the default <span style="color: #84888b;">~fill-column~</span> value,
it would be better for it to always match the local buffer value. This may be
accomplished with advise, but it's a bit cleaner (and even simpler) to just turn
the width variable into an alias for <span style="color: #84888b;">~fill-column~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! page-break-lines
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (prog-mode . page-break-lines-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (autoload 'turn-on-page-break-lines-mode </span><span style="color: #50a14f; background-color: #e7e7e7;">"page-break-lines"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvaralias</span><span class="ef-ob"> '</span><span style="color: #6a1868; background-color: #e7e7e7;">page-break-lines-max-width</span><span class="ef-ob"> 'fill-column)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+evil-forward-page</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Call `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">forward-page</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', such that it works as intended with evil-mode."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq (char-after (point)) ?\^L)
      (forward-char 1))
    (forward-page))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+evil-backward-page</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Call `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">backward-page</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', such that it works as intended with evil-mode."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq (char-after (point)) ?\^L)
      (backward-char 1))
    (backward-page))
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:prefix</span> <span style="color: #50a14f; background-color: #e7e7e7;">"g"</span>
        <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Prev page break"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:nv</span> <span style="color: #50a14f; background-color: #e7e7e7;">"["</span><span class="ef-ob"> #'+evil-backward-page
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Next page break"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:nv</span> <span style="color: #50a14f; background-color: #e7e7e7;">"]"</span><span class="ef-ob"> #'+evil-forward-page)
  (map! </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;C-M-prior&gt;"</span><span class="ef-ob"> #'+evil-backward-page
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;C-M-next&gt;"</span><span class="ef-ob"> #'+evil-forward-page))
</span><span class="ef-obe">#+end_src
</span>
With this setup, I find form-feeds to be a really convenient addition to my
coding workflow. Despite generally poor adoption, they are the only
language-independent form that "just works". While you could also use specially
crafted comment forms and a more complex setup, it's not as though the form-feed
is being used for anything else --- it's free real estate! 😉

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Writeroom</span>

<span style="color: #84888b;">#+call: confpkg("Writeroom")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:ui zen=</span> module.
<span class="ef-obe">#+end_quote
</span>
For starters, I think Doom is a bit over-zealous when zooming in
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +zen-text-scale 0.8)
</span><span class="ef-obe">#+end_src
</span>
Then, when using Org it would be nice to make a number of other aesthetic
tweaks. Namely:
+ Use a serifed variable-pitch font
+ Hiding headline leading stars
+ Using fleurons as headline bullets
+ Hiding line numbers
+ Removing outline indentation
+ Centring the text

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+zen-serif-p</span><span class="ef-ob"> t
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Whether to use a serifed font with `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mixed-pitch-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+zen-org-starhide</span><span class="ef-ob"> t
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"The value `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-modern-hide-stars</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' is set to."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> writeroom-mode
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar-local</span> <span style="color: #6a1868; background-color: #e7e7e7;">+zen--original-org-indent-mode-p</span><span class="ef-ob"> nil)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar-local</span> <span style="color: #6a1868; background-color: #e7e7e7;">+zen--original-mixed-pitch-mode-p</span><span class="ef-ob"> nil)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+zen-enable-mixed-pitch-mode-h</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Enable `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mixed-pitch-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' when in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+zen-mixed-pitch-modes</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (apply #'derived-mode-p +zen-mixed-pitch-modes)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> writeroom-mode
          (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +zen--original-mixed-pitch-mode-p mixed-pitch-mode)
            (funcall (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> +zen-serif-p #'mixed-pitch-serif-mode #'mixed-pitch-mode) 1))
        (funcall #'mixed-pitch-mode (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> +zen--original-mixed-pitch-mode-p 1 -1)))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+zen-prose-org-h</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Reformat the current Org buffer appearance for prose."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq major-mode 'org-mode)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> display-line-numbers nil
            visual-fill-column-width 60
            org-adapt-indentation nil)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">featurep</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org-modern</span><span class="ef-ob">)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> org-modern-star '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"🙘"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"🙙"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"🙚"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"🙛"</span><span class="ef-ob">)
                    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">org-modern-star '("🙐" "🙑" "🙒" "🙓" "🙔" "🙕" "🙖" "🙗")
</span><span class="ef-ob">                    org-modern-hide-stars +zen-org-starhide)
        (org-modern-mode -1)
        (org-modern-mode 1))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob">
       +zen--original-org-indent-mode-p org-indent-mode)
      (org-indent-mode -1)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+zen-nonprose-org-h</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Reverse the effect of `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+zen-prose-org</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq major-mode 'org-mode)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-modern-mode)
        (org-modern-mode -1)
        (org-modern-mode 1))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> +zen--original-org-indent-mode-p (org-indent-mode 1))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">pushnew!</span><span class="ef-ob"> writeroom--local-variables
            'display-line-numbers
            'visual-fill-column-width
            'org-adapt-indentation
            'org-modern-mode
            'org-modern-star
            'org-modern-hide-stars)
  (add-hook 'writeroom-mode-enable-hook #'+zen-prose-org-h)
  (add-hook 'writeroom-mode-disable-hook #'+zen-nonprose-org-h))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt Writeroom applied to an Org file</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/writeroom-and-org.png]]</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Treemacs</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg treemacs")</span>

<span class="ef-obb">#+begin_quote
</span>From the <span style="color: #84888b;">=:ui treemacs=</span> module.
<span class="ef-obe">#+end_quote
</span>
Quite often there are superfluous files I'm not that interested in. There's no
good reason for them to take up space. Let's add a mechanism to ignore them.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> treemacs
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">treemacs-file-ignore-extensions</span><span class="ef-ob"> '()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"File extension which `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treemacs-ignore-filter</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' will ensure are ignored"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">treemacs-file-ignore-globs</span><span class="ef-ob"> '()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Globs which will are transformed to `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treemacs-file-ignore-regexps</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' which `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treemacs-ignore-filter</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' will ensure are ignored"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">treemacs-file-ignore-regexps</span><span class="ef-ob"> '()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"RegExps to be tested to ignore files, generated from `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treeemacs-file-ignore-globs</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">treemacs-file-ignore-generate-regexps</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Generate `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treemacs-file-ignore-regexps</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' from `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treemacs-file-ignore-globs</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> treemacs-file-ignore-regexps (mapcar 'dired-glob-regexp treemacs-file-ignore-globs)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (equal treemacs-file-ignore-globs '()) nil (treemacs-file-ignore-generate-regexps))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">treemacs-ignore-filter</span><span class="ef-ob"> (file full-path)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Ignore files specified by `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treemacs-file-ignore-extensions</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', and `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">treemacs-file-ignore-regexps</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (member (file-name-extension file) treemacs-file-ignore-extensions)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((ignore-file nil))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (regexp treemacs-file-ignore-regexps ignore-file)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> ignore-file (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> ignore-file (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-match-p regexp full-path) t nil)))))))
  (add-to-list 'treemacs-ignored-file-predicates #'treemacs-ignore-filter))
</span><span class="ef-obe">#+end_src
</span>
Now, we just identify the files in question.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> treemacs-file-ignore-extensions
      '(</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX
</span>        <span style="color: #50a14f; background-color: #e7e7e7;">"aux"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"ptc"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"fdb_latexmk"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"fls"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"synctex.gz"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"toc"</span>
        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX - glossary
</span>        <span style="color: #50a14f; background-color: #e7e7e7;">"glg"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"glo"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"gls"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"glsdefs"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"ist"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"acn"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"acr"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"alg"</span>
        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX - pgfplots
</span>        <span style="color: #50a14f; background-color: #e7e7e7;">"mw"</span>
        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX - pdfx
</span>        <span style="color: #50a14f; background-color: #e7e7e7;">"pdfa.xmpi"</span><span class="ef-ob">
        ))
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> treemacs-file-ignore-globs
      '(</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX
</span>        <span style="color: #50a14f; background-color: #e7e7e7;">"*/_minted-*"</span>
        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">AucTeX
</span>        <span style="color: #50a14f; background-color: #e7e7e7;">"*/.auctex-auto"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"*/_region_.log"</span>
        <span style="color: #50a14f; background-color: #e7e7e7;">"*/_region_.tex"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Visual fill column</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg visual-fill-column", after="visual-fill-column")</span>

This is already loaded by Doom, but it needs a patch applied for Emacs 29. I've
emailed this to the maintainer, hopefully Joost will take a look at it.

<span class="ef-obb">#+begin_example
</span><span class="ef-ob">Account for remapping in window width calculation

The window width calculation in
`visual-fill-column--window-max-text-width' uses `window-width' with the
active window as the sole argument. As of Emacs 29, this returns the
width of the window using the default face, even if the default face has
been remapped in the window: causing incorrect results when the window
is remapped.

Emacs 29 also introduces a special second argument value, `remap'
which (as we want) uses the remapped face, if applicable. This corrects
the width calculation. However, margin calculations are still done in
terms of the non-remapped default face, and so a conversion factor needs
to be applied when considering margins.
</span><span class="ef-obe">#+end_example
</span>
That's the problem/fix, I'll just overwrite the two functions in question with
the fixed versions for now.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+visual-fill-column--window-max-text-width--fixed</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> window)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return the maximum possible text width of WINDOW.
The maximum possible text width is the width of the current text
area plus the margins, but excluding the fringes, scroll bar, and
right divider.  WINDOW defaults to the selected window.  The
return value is scaled to account for `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">text-scale-mode-amount</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
and `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">text-scale-mode-step</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> window (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> window (selected-window)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((margins (window-margins window))
         (buffer (window-buffer window))
         (scale (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> visual-fill-column-adjust-for-text-scale
                         (boundp 'text-scale-mode-step)
                         (boundp 'text-scale-mode-amount))
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> buffer
                      (expt text-scale-mode-step
                            text-scale-mode-amount))
                  1.0))
         (remap-scale
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&gt;= emacs-major-version 29)
              (/ (window-width window 'remap) (float (window-width window)))
            1.0)))
    (truncate (/ (+ (window-width window (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (&gt;= emacs-major-version 29) 'remap))
                    (* (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (car margins) 0) remap-scale)
                    (* (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr margins) 0) remap-scale))
                 (float scale)))))

(advice-add 'visual-fill-column--window-max-text-width
            </span><span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'+visual-fill-column--window-max-text-width--fixed)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+visual-fill-column--set-margins--fixed</span><span class="ef-ob"> (window)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Set window margins for WINDOW."</span>
  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Calculate left &amp; right margins.
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((total-width (visual-fill-column--window-max-text-width window))
         (remap-scale
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&gt;= emacs-major-version 29)
              (/ (window-width window 'remap) (float (window-width window)))
            1.0))
         (width (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> visual-fill-column-width
                    fill-column))
         (margins (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt; (- total-width width) 0) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">margins must be &gt;= 0
</span><span class="ef-ob">                      0
                    (round (/ (- total-width width) remap-scale))))
         (left (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> visual-fill-column-center-text
                   (/ margins 2)
                 0))
         (right (- margins left)))

    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> visual-fill-column-extra-text-width
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((add-width (visual-fill-column--add-extra-width left right visual-fill-column-extra-text-width)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> left (car add-width)
                right (cdr add-width))))

    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">put an explicitly R2L buffer on the right side of the window
</span><span class="ef-ob">    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (eq bidi-paragraph-direction 'right-to-left)
               (= left 0))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> left right)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> right 0))

    (set-window-margins window left right)))

(advice-add 'visual-fill-column--set-margins
            </span><span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'+visual-fill-column--set-margins--fixed)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Frivolities</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** xkcd</span>

<span style="color: #84888b;">#+call: confpkg("XKCD")</span>

XKCD comics are fun.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> xkcd </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"80011da2e7def8f65233d4e0d790ca60d287081d"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
We want to set this up so it loads nicely in <span style="color: #4078f2; font-weight: 700;">[[*Extra links][Extra links]]</span>.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! xkcd
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> (xkcd-get-json
             xkcd-download xkcd-get
             </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">now for funcs from my extension of this pkg
</span><span class="ef-ob">             +xkcd-find-and-copy +xkcd-find-and-view
             +xkcd-fetch-info +xkcd-select)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> xkcd-cache-dir (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"xkcd/"</span><span class="ef-ob"> doom-cache-dir)
        xkcd-cache-latest (concat xkcd-cache-dir </span><span style="color: #50a14f; background-color: #e7e7e7;">"latest"</span><span class="ef-ob">))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p xkcd-cache-dir)
    (make-directory xkcd-cache-dir))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> evil-snipe
    (add-to-list 'evil-snipe-disabled-modes 'xkcd-mode))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:general</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:states</span><span class="ef-ob"> 'normal
            </span><span style="color: #a626a4; background-color: #e7e7e7;">:keymaps</span><span class="ef-ob"> 'xkcd-mode-map
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;right&gt;"</span><span class="ef-ob"> #'xkcd-next
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"n"</span><span class="ef-ob">       #'xkcd-next </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">evil-ish
</span>            <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;left&gt;"</span><span class="ef-ob">  #'xkcd-prev
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"N"</span><span class="ef-ob">       #'xkcd-prev </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">evil-ish
</span>            <span style="color: #50a14f; background-color: #e7e7e7;">"r"</span><span class="ef-ob">       #'xkcd-rand
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"a"</span><span class="ef-ob">       #'xkcd-rand </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">because image-rotate can interfere
</span>            <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span><span class="ef-ob">       #'xkcd-alt-text
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob">       #'xkcd-kill-buffer
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"o"</span><span class="ef-ob">       #'xkcd-open-browser
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob">       #'xkcd-open-explanation-browser
            </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">extras
</span>            <span style="color: #50a14f; background-color: #e7e7e7;">"s"</span><span class="ef-ob">       #'+xkcd-find-and-view
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"/"</span><span class="ef-ob">       #'+xkcd-find-and-view
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"y"</span><span class="ef-ob">       #'+xkcd-copy))
</span><span class="ef-obe">#+end_src
</span>
Let's also extend the functionality a whole bunch.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> xkcd
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">emacsql-sqlite</span><span class="ef-ob">)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-select</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Prompt the user for an xkcd using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">completing-read</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' and `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+xkcd-select-format</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'. Return the xkcd number or nil"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> (prompt-lines
           (-dummy (maphash (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (key xkcd-info)
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (+xkcd-select-format xkcd-info) prompt-lines))
                            +xkcd-stored-info))
           (num (completing-read (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"xkcd (%s): "</span><span class="ef-ob"> xkcd-latest) prompt-lines)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (equal </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> num) xkcd-latest
        (string-to-number (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">.*"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\1"</span><span class="ef-ob"> num)))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-select-format</span><span class="ef-ob"> (xkcd-info)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Creates each completing-read line from an xkcd info plist. Must start with the xkcd number"</span><span class="ef-ob">
    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%-4s  %-30s %s"</span><span class="ef-ob">
            (propertize (number-to-string (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob">))
                        'face 'counsel-key-binding)
            (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">)
            (propertize (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:alt</span><span class="ef-ob">)
                        'face '(variable-pitch font-lock-comment-face))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-fetch-info</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> num)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Fetch the parsed json info for comic NUM. Fetches latest when omitted or 0"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">xkcd</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not num) (= num 0))
      (+xkcd-check-latest)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> num xkcd-latest))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((res (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (gethash num +xkcd-stored-info)
                   (puthash num (+xkcd-db-read num) +xkcd-stored-info))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> res
        (+xkcd-db-write
         (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((url (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://xkcd.com/%d/info.0.json"</span><span class="ef-ob"> num))
                (json-assoc
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (gethash num +xkcd-stored-info)
                     (gethash num +xkcd-stored-info)
                   (json-read-from-string (xkcd-get-json url num)))))
           json-assoc))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> res (+xkcd-db-read num)))
      res))

  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">since we've done this, we may as well go one little step further
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-find-and-copy</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Prompt for an xkcd using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+xkcd-select</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' and copy url to clipboard"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (+xkcd-copy (+xkcd-select)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-copy</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> num)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Copy a url to xkcd NUM to the clipboard"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span> <span style="color: #50a14f; background-color: #e7e7e7;">"i"</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((num (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> num xkcd-cur)))
      (gui-select-text (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://xkcd.com/%d"</span><span class="ef-ob"> num))
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"xkcd.com/%d copied to clipboard"</span><span class="ef-ob"> num)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-find-and-view</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Prompt for an xkcd using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+xkcd-select</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' and view it"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (xkcd-get (+xkcd-select))
    (switch-to-buffer </span><span style="color: #50a14f; background-color: #e7e7e7;">"*xkcd*"</span><span class="ef-ob">))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+xkcd-latest-max-age</span><span class="ef-ob"> (* 60 60) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">1 hour
</span>    <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Time after which xkcd-latest should be refreshed, in seconds"</span><span class="ef-ob">)

  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">initialise `</span><span style="color: #b751b6; background-color: #e7e7e7;">xkcd-latest</span><span style="color: #84888b; background-color: #e7e7e7;">' and `</span><span style="color: #b751b6; background-color: #e7e7e7;">+xkcd-stored-info</span><span style="color: #84888b; background-color: #e7e7e7;">' with latest xkcd
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">add-transient-hook!</span><span class="ef-ob"> '+xkcd-select
    (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">xkcd</span><span class="ef-ob">)
    (+xkcd-fetch-info xkcd-latest)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +xkcd-stored-info (+xkcd-db-read-all)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">add-transient-hook!</span><span class="ef-ob"> '+xkcd-fetch-info
    (xkcd-update-latest))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-check-latest</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Use value in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">xkcd-cache-latest</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' as long as it isn't older thabn `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+xkcd-latest-max-age</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (file-exists-p xkcd-cache-latest)
                 (&lt; (- (time-to-seconds (current-time))
                       (time-to-seconds (file-attribute-modification-time (file-attributes xkcd-cache-latest))))
                    +xkcd-latest-max-age))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((out (xkcd-get-json </span><span style="color: #50a14f; background-color: #e7e7e7;">"http://xkcd.com/info.0.json"</span><span class="ef-ob"> 0))
             (json-assoc (json-read-from-string out))
             (latest (cdr (assoc 'num json-assoc))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (/= xkcd-latest latest)
          (+xkcd-db-write json-assoc)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> (find-file xkcd-cache-latest)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> xkcd-latest latest)
            (erase-buffer)
            (insert (number-to-string latest))
            (save-buffer)
            (kill-buffer (current-buffer)))))
      (shell-command (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"touch %s"</span><span class="ef-ob"> xkcd-cache-latest))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+xkcd-stored-info</span><span class="ef-ob"> (make-hash-table </span><span style="color: #a626a4; background-color: #e7e7e7;">:test</span><span class="ef-ob"> 'eql)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Basic info on downloaded xkcds, in the form of a hashtable"</span><span class="ef-ob">)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> xkcd-get-json--and-cache (url </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> num)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Fetch the Json coming from URL.
If the file NUM.json exists, use it instead.
If NUM is 0, always download from URL.
The return value is a string."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'xkcd-get-json
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((file (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s%d.json"</span><span class="ef-ob"> xkcd-cache-dir num))
           (cached (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (file-exists-p file) (not (eq num 0))))
           (out (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> cached
                                         (find-file file)
                                       (url-retrieve-synchronously url))
                  (goto-char (point-min))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> cached (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^$"</span><span class="ef-ob">))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">prog1</span><span class="ef-ob">
                      (buffer-substring-no-properties (point) (point-max))
                    (kill-buffer (current-buffer))))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> cached (eq num 0))
        (xkcd-cache-json num out))
      out))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +xkcd-get (num)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Get the xkcd number NUM."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> 'xkcd-get
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span> <span style="color: #50a14f; background-color: #e7e7e7;">"nEnter comic number: "</span><span class="ef-ob">)
    (xkcd-update-latest)
    (get-buffer-create </span><span style="color: #50a14f; background-color: #e7e7e7;">"*xkcd*"</span><span class="ef-ob">)
    (switch-to-buffer </span><span style="color: #50a14f; background-color: #e7e7e7;">"*xkcd*"</span><span class="ef-ob">)
    (xkcd-mode)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (buffer-read-only)
      (erase-buffer)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> xkcd-cur num)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((xkcd-data (+xkcd-fetch-info num))
             (num (plist-get xkcd-data </span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob">))
             (img (plist-get xkcd-data </span><span style="color: #a626a4; background-color: #e7e7e7;">:img</span><span class="ef-ob">))
             (safe-title (plist-get xkcd-data </span><span style="color: #a626a4; background-color: #e7e7e7;">:safe-title</span><span class="ef-ob">))
             (alt (plist-get xkcd-data </span><span style="color: #a626a4; background-color: #e7e7e7;">:alt</span><span class="ef-ob">))
             title file)
        (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Getting comic..."</span><span class="ef-ob">)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> file (xkcd-download img num))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> title (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%d: %s"</span><span class="ef-ob"> num safe-title))
        (insert (propertize title
                            'face 'outline-1))
        (center-line)
        (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
        (xkcd-insert-image file num)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq xkcd-cur 0)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> xkcd-cur num))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> xkcd-alt alt)
        (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s"</span><span class="ef-ob"> title))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defconst</span> <span style="color: #6a1868; background-color: #e7e7e7;">+xkcd-db--sqlite-available-p</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-demoted-errors</span> <span style="color: #50a14f; background-color: #e7e7e7;">"+org-xkcd initialization: %S"</span><span class="ef-ob">
      (emacsql-sqlite-ensure-binary)
      t))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+xkcd-db--connection</span><span class="ef-ob"> (make-hash-table </span><span style="color: #a626a4; background-color: #e7e7e7;">:test</span><span class="ef-ob"> #'equal)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Database connection to +org-xkcd database."</span><span class="ef-ob">)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db--get</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return the sqlite db file."</span><span class="ef-ob">
    (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"xkcd.db"</span><span class="ef-ob"> xkcd-cache-dir))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db--get-connection</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return the database connection, if any."</span><span class="ef-ob">
    (gethash (file-truename xkcd-cache-dir)
             +xkcd-db--connection))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defconst</span> <span style="color: #6a1868; background-color: #e7e7e7;">+xkcd-db--table-schema</span><span class="ef-ob">
    '((xkcds
       [(num integer </span><span style="color: #a626a4; background-color: #e7e7e7;">:unique</span> <span style="color: #a626a4; background-color: #e7e7e7;">:primary-key</span><span class="ef-ob">)
        (year        </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (month       </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (link        </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (news        </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (safe_title  </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (title       </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (transcript  </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (alt         </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)
        (img         </span><span style="color: #a626a4; background-color: #e7e7e7;">:not-null</span><span class="ef-ob">)])))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db--init</span><span class="ef-ob"> (db)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Initialize database DB with the correct schema and user version."</span><span class="ef-ob">
    (emacsql-with-transaction db
      (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase-dolist</span><span class="ef-ob"> (`(,table . ,schema) +xkcd-db--table-schema)
        (emacsql db [</span><span style="color: #a626a4; background-color: #e7e7e7;">:create-table</span><span class="ef-ob"> $i1 $S2] table schema))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Entrypoint to the +org-xkcd sqlite database.
Initializes and stores the database, and the database connection.
Performs a database upgrade when required."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (+xkcd-db--get-connection)
                 (emacsql-live-p (+xkcd-db--get-connection)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((db-file (+xkcd-db--get))
             (init-db (not (file-exists-p db-file))))
        (make-directory (file-name-directory db-file) t)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((conn (emacsql-sqlite db-file)))
          (set-process-query-on-exit-flag (emacsql-process conn) nil)
          (puthash (file-truename xkcd-cache-dir)
                   conn
                   +xkcd-db--connection)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> init-db
            (+xkcd-db--init conn)))))
    (+xkcd-db--get-connection))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db-query</span><span class="ef-ob"> (sql </span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> args)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Run SQL query on +org-xkcd database with ARGS.
SQL can be either the emacsql vector representation, or a string."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob">  (stringp sql)
        (emacsql (+xkcd-db) (apply #'format sql args))
      (apply #'emacsql (+xkcd-db) sql args)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db-read</span><span class="ef-ob"> (num)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((res
                (car (+xkcd-db-query [</span><span style="color: #a626a4; background-color: #e7e7e7;">:select</span><span class="ef-ob"> * </span><span style="color: #a626a4; background-color: #e7e7e7;">:from</span><span class="ef-ob"> xkcds
                                      </span><span style="color: #a626a4; background-color: #e7e7e7;">:where</span><span class="ef-ob"> (= num $s1)]
                                     num
                                     </span><span style="color: #a626a4; background-color: #e7e7e7;">:limit</span><span class="ef-ob"> 1))))
      (+xkcd-db-list-to-plist res)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db-read-all</span><span class="ef-ob"> ()
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((xkcd-table (make-hash-table </span><span style="color: #a626a4; background-color: #e7e7e7;">:test</span><span class="ef-ob"> 'eql </span><span style="color: #a626a4; background-color: #e7e7e7;">:size</span><span class="ef-ob"> 4000)))
      (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (xkcd-info-list)
                (puthash (car xkcd-info-list) (+xkcd-db-list-to-plist xkcd-info-list) xkcd-table))
              (+xkcd-db-query [</span><span style="color: #a626a4; background-color: #e7e7e7;">:select</span><span class="ef-ob"> * </span><span style="color: #a626a4; background-color: #e7e7e7;">:from</span><span class="ef-ob"> xkcds]))
      xkcd-table))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db-list-to-plist</span><span class="ef-ob"> (xkcd-datalist)
    `(</span><span style="color: #a626a4; background-color: #e7e7e7;">:num</span><span class="ef-ob"> ,(nth 0 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:year</span><span class="ef-ob"> ,(nth 1 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:month</span><span class="ef-ob"> ,(nth 2 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:link</span><span class="ef-ob"> ,(nth 3 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:news</span><span class="ef-ob"> ,(nth 4 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:safe-title</span><span class="ef-ob"> ,(nth 5 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob"> ,(nth 6 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:transcript</span><span class="ef-ob"> ,(nth 7 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:alt</span><span class="ef-ob"> ,(nth 8 xkcd-datalist)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:img</span><span class="ef-ob"> ,(nth 9 xkcd-datalist)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+xkcd-db-write</span><span class="ef-ob"> (data)
    (+xkcd-db-query [</span><span style="color: #a626a4; background-color: #e7e7e7;">:insert-into</span><span class="ef-ob"> xkcds
                     </span><span style="color: #a626a4; background-color: #e7e7e7;">:values</span><span class="ef-ob"> $v1]
                    (list (vector
                           (cdr (assoc 'num        data))
                           (cdr (assoc 'year       data))
                           (cdr (assoc 'month      data))
                           (cdr (assoc 'link       data))
                           (cdr (assoc 'news       data))
                           (cdr (assoc 'safe_title data))
                           (cdr (assoc 'title      data))
                           (cdr (assoc 'transcript data))
                           (cdr (assoc 'alt        data))
                           (cdr (assoc 'img        data))
                           )))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Selectric</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Selectric")</span>

Every so often, you want everyone else to <span style="text-decoration: italic;">/know/</span> that you're typing, or just to
amuse oneself. Introducing: typewriter sounds!
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> selectric-mode </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"1840de71f7414b7cd6ce425747c8e26a413233aa"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! selectic-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> selectic-mode)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Wttrin</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Wttrin")</span>

Hey, let's get the weather in here while we're at it.
Unfortunately this seems slightly unmaintained (<span style="color: #4078f2; font-weight: 700;">[[https://github.com/bcbcarl/emacs-wttrin/pulls][few open bugfix PRs]]</span>) so let's
roll our <span style="color: #4078f2; font-weight: 700;">[[file:lisp/wttrin/wttrin.el][own version]]</span>.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> wttrin </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/wttrin"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! wttrin
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> wttrin)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Spray</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Spray")</span>

Why not flash words on the screen. Why not --- hey, it could be fun.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> spray </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"74d9dcfa2e8b38f96a43de9ab0eb13364300cb46"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"emacsmirror/spray"</span><span class="ef-ob">)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">sr.ht can be flaky
</span><span class="ef-obe">#+end_src
</span>
It would be nice if Spray's default speed suited me better, and the keybindings
worked in evil mode. Let's do that and make the display slightly nicer while
we're at it.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! spray
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> spray-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> spray-wpm 600
        spray-height 800)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">spray-mode-hide-cursor</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Hide or unhide the cursor as is appropriate."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> spray-mode
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> spray--last-evil-cursor-state evil-normal-state-cursor
                    evil-normal-state-cursor '(nil))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> evil-normal-state-cursor spray--last-evil-cursor-state)))
  (add-hook 'spray-mode-hook #'spray-mode-hide-cursor)
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> spray-mode-map
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;return&gt;"</span><span class="ef-ob"> #'spray-start/stop
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"f"</span><span class="ef-ob"> #'spray-faster
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"s"</span><span class="ef-ob"> #'spray-slower
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"t"</span><span class="ef-ob"> #'spray-time
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;right&gt;"</span><span class="ef-ob"> #'spray-forward-word
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"h"</span><span class="ef-ob"> #'spray-forward-word
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;left&gt;"</span><span class="ef-ob"> #'spray-backward-word
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"l"</span><span class="ef-ob"> #'spray-backward-word
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob"> #'spray-quit))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Elcord</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Elcord")</span>

What's even the point of using Emacs unless you're constantly telling everyone
about it?
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> elcord </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"deeb22f84378b382f09e78f1718bc4c39a3582b8"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! elcord
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> elcord-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> elcord-use-major-mode-as-main-icon t))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** File types</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Systemd</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Systemd")</span>

For editing systemd unit files
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> systemd </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"8742607120fbc440821acbc351fda1e8e68a8806"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! systemd
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:defer</span><span class="ef-ob"> t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #e45649; font-weight: nil; font-size: 1.25em">* Applications</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Ebooks</span>

<span style="color: #84888b;">#+call: confpkg()</span>

<span style="color: #4078f2; font-weight: 700;">[[xkcd:548]]</span>

For managing my ebooks, I'll hook into the well-established ebook library
manager <span style="color: #4078f2; font-weight: 700;">[[https://calibre-ebook.com/][calibre]]</span>. A number of Emacs clients for this exist, but this seems like a
good option.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> calibredb </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"7d33947462c77f9e87e8078fa7b7b398feeef0f7"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Then for reading them, the only currently viable options seems to be <span style="color: #4078f2; font-weight: 700;">[[https://depp.brause.cc/nov.el/][nov.el]]</span>.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> nov </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"b37d9380752e541db3f4b947c219ca54d50ca273"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Together these should give me a rather good experience reading ebooks.

<span style="color: #84888b;">=calibredb=</span> lets us use calibre through Emacs, because who wouldn't want to use
something through Emacs?
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! calibredb
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> calibredb
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calibredb-root-dir </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.local/share/calibre-library"</span><span class="ef-ob">
        calibredb-db-dir (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"metadata.db"</span><span class="ef-ob"> calibredb-root-dir))
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> calibredb-show-mode-map
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"?"</span><span class="ef-ob"> #'calibredb-entry-dispatch
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o"</span><span class="ef-ob"> #'calibredb-find-file
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"O"</span><span class="ef-ob"> #'calibredb-find-file-other-frame
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"V"</span><span class="ef-ob"> #'calibredb-open-file-with-default-tool
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"s"</span><span class="ef-ob"> #'calibredb-set-metadata-dispatch
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob"> #'calibredb-export-dispatch
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob"> #'calibredb-entry-quit
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob"> #'calibredb-open-dired
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span><span class="ef-ob"> [tab] #'calibredb-toggle-view-at-point
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-t"</span><span class="ef-ob"> #'calibredb-set-metadata--tags
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-a"</span><span class="ef-ob"> #'calibredb-set-metadata--author_sort
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-A"</span><span class="ef-ob"> #'calibredb-set-metadata--authors
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-T"</span><span class="ef-ob"> #'calibredb-set-metadata--title
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-c"</span><span class="ef-ob"> #'calibredb-set-metadata--comments)
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> calibredb-search-mode-map
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span><span class="ef-ob"> [mouse-3] #'calibredb-search-mouse
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"RET"</span><span class="ef-ob"> #'calibredb-find-file
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"?"</span><span class="ef-ob"> #'calibredb-dispatch
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"a"</span><span class="ef-ob"> #'calibredb-add
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"A"</span><span class="ef-ob"> #'calibredb-add-dir
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"c"</span><span class="ef-ob"> #'calibredb-clone
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"d"</span><span class="ef-ob"> #'calibredb-remove
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"D"</span><span class="ef-ob"> #'calibredb-remove-marked-items
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"j"</span><span class="ef-ob"> #'calibredb-next-entry
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"k"</span><span class="ef-ob"> #'calibredb-previous-entry
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"l"</span><span class="ef-ob"> #'calibredb-virtual-library-list
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"L"</span><span class="ef-ob"> #'calibredb-library-list
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n"</span><span class="ef-ob"> #'calibredb-virtual-library-next
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"N"</span><span class="ef-ob"> #'calibredb-library-next
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"p"</span><span class="ef-ob"> #'calibredb-virtual-library-previous
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"P"</span><span class="ef-ob"> #'calibredb-library-previous
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"s"</span><span class="ef-ob"> #'calibredb-set-metadata-dispatch
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"S"</span><span class="ef-ob"> #'calibredb-switch-library
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o"</span><span class="ef-ob"> #'calibredb-find-file
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"O"</span><span class="ef-ob"> #'calibredb-find-file-other-frame
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"v"</span><span class="ef-ob"> #'calibredb-view
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"V"</span><span class="ef-ob"> #'calibredb-open-file-with-default-tool
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob"> #'calibredb-open-dired
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"b"</span><span class="ef-ob"> #'calibredb-catalog-bib-dispatch
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob"> #'calibredb-export-dispatch
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"r"</span><span class="ef-ob"> #'calibredb-search-refresh-and-clear-filter
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"R"</span><span class="ef-ob"> #'calibredb-search-clear-filter
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob"> #'calibredb-search-quit
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"m"</span><span class="ef-ob"> #'calibredb-mark-and-forward
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"f"</span><span class="ef-ob"> #'calibredb-toggle-favorite-at-point
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"x"</span><span class="ef-ob"> #'calibredb-toggle-archive-at-point
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"h"</span><span class="ef-ob"> #'calibredb-toggle-highlight-at-point
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"u"</span><span class="ef-ob"> #'calibredb-unmark-and-forward
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"i"</span><span class="ef-ob"> #'calibredb-edit-annotation
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"DEL"</span><span class="ef-ob"> #'calibredb-unmark-and-backward
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span><span class="ef-ob"> [backtab] #'calibredb-toggle-view
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span><span class="ef-ob"> [tab] #'calibredb-toggle-view-at-point
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-n"</span><span class="ef-ob"> #'calibredb-show-next-entry
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-p"</span><span class="ef-ob"> #'calibredb-show-previous-entry
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"/"</span><span class="ef-ob"> #'calibredb-search-live-filter
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-t"</span><span class="ef-ob"> #'calibredb-set-metadata--tags
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-a"</span><span class="ef-ob"> #'calibredb-set-metadata--author_sort
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-A"</span><span class="ef-ob"> #'calibredb-set-metadata--authors
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-T"</span><span class="ef-ob"> #'calibredb-set-metadata--title
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:ne</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-c"</span><span class="ef-ob"> #'calibredb-set-metadata--comments))
</span><span class="ef-obe">#+end_src
</span>
Then, to actually read the ebooks we use <span style="color: #84888b;">=nov=</span>.

<span style="color: #84888b;">#+attr_html: :class invertible :alt Excerpt of the GNU Emacs manual viewed through nov.el</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/nov.png]]</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! nov
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:mode</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.epub\\'"</span><span class="ef-ob"> . nov-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> nov-mode-map
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"RET"</span><span class="ef-ob"> #'nov-scroll-up)

  (advice-add 'nov-render-title </span><span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'ignore)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+nov-mode-setup</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Tweak nov-mode to our liking."</span><span class="ef-ob">
    (face-remap-add-relative 'variable-pitch
                             </span><span style="color: #a626a4; background-color: #e7e7e7;">:family</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Merriweather"</span>
                             <span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.4
                             </span><span style="color: #a626a4; background-color: #e7e7e7;">:width</span><span class="ef-ob"> 'semi-expanded)
    (face-remap-add-relative 'default </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.3)
    (variable-pitch-mode 1)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> line-spacing 0.2
                next-screen-context-lines 4
                shr-use-colors nil)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">visual-fill-column</span><span class="ef-ob"> nil t)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> visual-fill-column-center-text t
                  visual-fill-column-width 64
                  nov-text-width 106)
      (visual-fill-column-mode 1))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">featurep</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">hl-line-mode</span><span class="ef-ob">)
      (hl-line-mode -1))
    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Re-render with new display settings
</span><span class="ef-ob">    (nov-render-document)
    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Look up words with the dictionary.
</span><span class="ef-ob">    (add-to-list '+lookup-definition-functions #'+lookup/dictionary-definition))

  (add-hook 'nov-mode-hook #'+nov-mode-setup))
</span><span class="ef-obe">#+end_src
</span>
To enhance the reading experience, we can create a nice minimal modeline, with
just the basic bare minimum, information about the book/chapter, and possibly
currently playing media.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> doom-modeline
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">doom-modeline-nov-title-max-length</span><span class="ef-ob"> 40)
  (doom-modeline-def-segment nov-author
    (propertize
     (cdr (assoc 'creator nov-metadata))
     'face (doom-modeline-face 'doom-modeline-project-parent-dir)))
  (doom-modeline-def-segment nov-title
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((title (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr (assoc 'title nov-metadata)) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt;= (length title) doom-modeline-nov-title-max-length)
          (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob"> title)
        (propertize
         (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob"> (truncate-string-to-width title doom-modeline-nov-title-max-length nil nil t))
         'help-echo title))))
  (doom-modeline-def-segment nov-current-page
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((words (count-words (point-min) (point-max))))
      (propertize
       (format </span><span style="color: #50a14f; background-color: #e7e7e7;">" %d/%d"</span><span class="ef-ob">
               (1+ nov-documents-index)
               (length nov-documents))
       'face (doom-modeline-face 'doom-modeline-info)
       'help-echo (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= words 1) </span><span style="color: #50a14f; background-color: #e7e7e7;">"1 word in this chapter"</span><span class="ef-ob">
                    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s words in this chapter"</span><span class="ef-ob"> words)))))
  (doom-modeline-def-segment scroll-percentage-subtle
    (concat
     (doom-modeline-spc)
     (propertize (format-mode-line '(</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> doom-modeline-percent-position </span><span style="color: #50a14f; background-color: #e7e7e7;">"%%"</span><span class="ef-ob">))
                 'face (doom-modeline-face 'shadow)
                 'help-echo </span><span style="color: #50a14f; background-color: #e7e7e7;">"Buffer percentage"</span><span class="ef-ob">)))

  (doom-modeline-def-modeline 'nov
    '(workspace-name window-number nov-author nov-title nov-current-page scroll-percentage-subtle)
    '(media-player misc-info major-mode time))

  (add-to-list 'doom-modeline-mode-alist '(nov-mode . nov)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Calculator</span>

<span style="color: #84888b;">#+call: confpkg()</span>

Emacs includes the venerable <span style="color: #84888b;">=calc=</span>, which is a pretty impressive RPN (Reverse
Polish Notation) calculator. However, we can do a bit to improve the experience.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** CalcTeX</span>

Everybody knows that mathematical expressions look best with LaTeX, so <span style="color: #84888b;">=calc=</span>'s
ability to create LaTeX representations of its expressions provides a lovely
opportunity which is taken advantage of in the CalcTeX package.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> calctex </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"johnbcoughlin/calctex"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"calctex/*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"calctex-contrib/*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"org-calctex/*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"vendor"</span><span class="ef-ob">))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"67a2e76847a9ea9eff1f8e4eb37607f84b380ebb"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt Demonstration of calc, prettified by calctex.</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/calc-with-calctex.png]]</span>

We'd like to use CalcTeX too, so let's set that up, and fix some glaring
inadequacies --- why on earth would you commit a hard-coded path to an executable
that <span style="text-decoration: italic;">/only works on your local machine/</span>, consequently breaking the package for
everyone else!?

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! calctex
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> calctex-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (add-hook 'calc-mode-hook #'calctex-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calctex-additional-latex-packages </span><span style="color: #50a14f; background-color: #e7e7e7;">"
\\usepackage[usenames]{xcolor}
\\usepackage{soul}
\\usepackage{adjustbox}
\\usepackage{amsmath}
\\usepackage{amssymb}
\\usepackage{siunitx}
\\usepackage{cancel}
\\usepackage{mathtools}
\\usepackage{mathalpha}
\\usepackage{xparse}
\\usepackage{arevmath}"</span><span class="ef-ob">
        calctex-additional-latex-macros
        (concat calctex-additional-latex-macros
                </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\\let\\evalto\\Rightarrow"</span><span class="ef-ob">))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> no-messaging-a (orig-fn </span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> args)
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'calctex-default-dispatching-render-process
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((inhibit-message t) message-log-max)
      (apply orig-fn args)))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Fix hardcoded dvichop path (whyyyyyyy)
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((vendor-folder (concat (file-truename doom-local-dir)
                               </span><span style="color: #50a14f; background-color: #e7e7e7;">"straight/"</span><span class="ef-ob">
                               (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"build-%s"</span><span class="ef-ob"> emacs-version)
                               </span><span style="color: #50a14f; background-color: #e7e7e7;">"/calctex/vendor/"</span><span class="ef-ob">)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calctex-dvichop-sty (concat vendor-folder </span><span style="color: #50a14f; background-color: #e7e7e7;">"texd/dvichop"</span><span class="ef-ob">)
          calctex-dvichop-bin (concat vendor-folder </span><span style="color: #50a14f; background-color: #e7e7e7;">"texd/dvichop"</span><span class="ef-ob">)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p calctex-dvichop-bin)
    (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"CalcTeX: Building dvichop binary"</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((default-directory (file-name-directory calctex-dvichop-bin)))
      (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"make"</span><span class="ef-ob"> nil nil nil))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Defaults</span>

Any sane person prefers radians and exact values.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calc-angle-mode 'rad  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">radians are rad
</span><span class="ef-ob">      calc-symbolic-mode t) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">keeps expressions like \sqrt{2} irrational for as long as possible
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Embedded calc</span>

Embedded calc is a lovely feature which let's us use calc to operate on LaTeX
maths expressions. The standard keybinding is a bit janky however (<span style="color: #84888b;">=C-x * e=</span>), so
we'll add a localleader-based alternative.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> calc-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> calc
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Embedded calc (toggle)"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob"> #'calc-embedded)
(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Embedded calc (toggle)"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"E"</span><span class="ef-ob"> #'calc-embedded)
(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> latex-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> latex
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Embedded calc (toggle)"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob"> #'calc-embedded)
</span><span class="ef-obe">#+end_src
</span>
Unfortunately this operates without the (rather informative) calculator and
trail buffers, but we can advice it that we would rather like those in a side
panel.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">calc-embedded-trail-window</span><span class="ef-ob"> nil)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">calc-embedded-calculator-window</span><span class="ef-ob"> nil)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> calc-embedded-with-side-pannel (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> _)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'calc-do-embedded
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> calc-embedded-trail-window
    (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob">
      (delete-window calc-embedded-trail-window))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calc-embedded-trail-window nil))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> calc-embedded-calculator-window
    (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob">
      (delete-window calc-embedded-calculator-window))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calc-embedded-calculator-window nil))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> calc-embedded-info
             (&gt; (* (window-width) (window-height)) 1200))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((main-window (selected-window))
          (vertical-p (&gt; (window-width) 80)))
      (select-window
       (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calc-embedded-trail-window
             (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> vertical-p
                 (split-window-horizontally (- (max 30 (/ (window-width) 3))))
               (split-window-vertically (- (max 8 (/ (window-height) 4)))))))
      (switch-to-buffer </span><span style="color: #50a14f; background-color: #e7e7e7;">"*Calc Trail*"</span><span class="ef-ob">)
      (select-window
       (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> calc-embedded-calculator-window
             (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> vertical-p
                 (split-window-vertically -6)
               (split-window-horizontally (- (/ (window-width) 2))))))
      (switch-to-buffer </span><span style="color: #50a14f; background-color: #e7e7e7;">"*Calculator*"</span><span class="ef-ob">)
      (select-window main-window))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Newsfeed</span>

<span style="color: #84888b;">#+call: confpkg()</span>

RSS feeds are still a thing. Why not make use of them with <span style="color: #84888b;">=elfeed=</span>.
I really like what <span style="color: #4078f2; font-weight: 700;">[[https://github.com/fuxialexander/doom-emacs-private-xfu/tree/master/modules/app/rss][fuxialexander]]</span> has going on, but I don't think I need a custom
module. Let's just try to patch on the main things I like the look of.

<span style="color: #84888b;">#+attr_html: :class invertible :alt Example elfeed entry</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/elfeed.png]]</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Keybindings</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> elfeed-search-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> elfeed-search
      [remap kill-this-buffer] </span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob">
      [remap kill-buffer] </span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:n</span><span class="ef-ob"> doom-leader-key nil
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob"> #'+rss/quit
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e"</span><span class="ef-ob"> #'elfeed-update
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"r"</span><span class="ef-ob"> #'elfeed-search-untag-all-unread
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"u"</span><span class="ef-ob"> #'elfeed-search-tag-all-unread
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"s"</span><span class="ef-ob"> #'elfeed-search-live-filter
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"RET"</span><span class="ef-ob"> #'elfeed-search-show-entry
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"p"</span><span class="ef-ob"> #'elfeed-show-pdf
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"+"</span><span class="ef-ob"> #'elfeed-search-tag-all
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob"> #'elfeed-search-untag-all
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"S"</span><span class="ef-ob"> #'elfeed-search-set-filter
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"b"</span><span class="ef-ob"> #'elfeed-search-browse-url
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"y"</span><span class="ef-ob"> #'elfeed-search-yank)
(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> elfeed-show-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> elfeed-show
      [remap kill-this-buffer] </span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob">
      [remap kill-buffer] </span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:n</span><span class="ef-ob"> doom-leader-key nil
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob"> #'+rss/delete-pane
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o"</span><span class="ef-ob"> #'ace-link-elfeed
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"RET"</span><span class="ef-ob"> #'org-ref-elfeed-add
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n"</span><span class="ef-ob"> #'elfeed-show-next
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"N"</span><span class="ef-ob"> #'elfeed-show-prev
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"p"</span><span class="ef-ob"> #'elfeed-show-pdf
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"+"</span><span class="ef-ob"> #'elfeed-show-tag
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob"> #'elfeed-show-untag
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"s"</span><span class="ef-ob"> #'elfeed-show-new-live-search
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nm</span> <span style="color: #50a14f; background-color: #e7e7e7;">"y"</span><span class="ef-ob"> #'elfeed-show-yank)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Usability enhancements</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> elfeed-search
  (set-evil-initial-state! 'elfeed-search-mode 'normal))
(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> elfeed-show-mode
  (set-evil-initial-state! 'elfeed-show-mode   'normal))

(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> evil-snipe
  (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> 'elfeed-show-mode   evil-snipe-disabled-modes)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> 'elfeed-search-mode evil-snipe-disabled-modes))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Visual enhancements</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> elfeed

  (elfeed-org)
  (use-package! elfeed-link)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> elfeed-search-filter </span><span style="color: #50a14f; background-color: #e7e7e7;">"@1-week-ago +unread"</span><span class="ef-ob">
        elfeed-search-print-entry-function '+rss/elfeed-search-print-entry
        elfeed-search-title-min-width 80
        elfeed-show-entry-switch #'pop-to-buffer
        elfeed-show-entry-delete #'+rss/delete-pane
        elfeed-show-refresh-function #'+rss/elfeed-show-refresh--better-style
        shr-max-image-proportion 0.6)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'elfeed-show-mode-hook (hide-mode-line-mode 1))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'elfeed-search-update-hook #'hide-mode-line-mode)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defface</span> <span style="color: #6a1868; background-color: #e7e7e7;">elfeed-show-title-face</span><span class="ef-ob"> '((t (</span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> ultrabold </span><span style="color: #a626a4; background-color: #e7e7e7;">:slant</span><span class="ef-ob"> italic </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.5)))
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"title face in elfeed show buffer"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:group</span><span class="ef-ob"> 'elfeed)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defface</span> <span style="color: #6a1868; background-color: #e7e7e7;">elfeed-show-author-face</span><span class="ef-ob"> `((t (</span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> light)))
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"title face in elfeed show buffer"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:group</span><span class="ef-ob"> 'elfeed)
  (set-face-attribute 'elfeed-search-title-face nil
                      </span><span style="color: #a626a4; background-color: #e7e7e7;">:foreground</span><span class="ef-ob"> 'nil
                      </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> 'light)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +rss-elfeed-wrap-h-nicer ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Enhances an elfeed entry's readability by wrapping it to a width of
`</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">fill-column</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' and centering it with `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">visual-fill-column-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'+rss-elfeed-wrap-h
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> truncate-lines nil
                shr-width 120
                visual-fill-column-center-text t
                default-text-properties '(line-height 1.1))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((inhibit-read-only t)
          (inhibit-modification-hooks t))
      (visual-fill-column-mode)
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(setq-local shr-current-font '(:family "Merriweather" :height 1.2))
</span><span class="ef-ob">      (set-buffer-modified-p nil)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+rss/elfeed-search-print-entry</span><span class="ef-ob"> (entry)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Print ENTRY to the buffer."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((elfeed-goodies/tag-column-width 40)
           (elfeed-goodies/feed-source-column-width 30)
           (title (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (elfeed-meta entry </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">) (elfeed-entry-title entry) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
           (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
           (feed (elfeed-entry-feed entry))
           (feed-title
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> feed
              (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (elfeed-meta feed </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">) (elfeed-feed-title feed))))
           (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
           (tags-str (concat (mapconcat 'identity tags </span><span style="color: #50a14f; background-color: #e7e7e7;">","</span><span class="ef-ob">)))
           (title-width (- (window-width) elfeed-goodies/feed-source-column-width
                           elfeed-goodies/tag-column-width 4))

           (tag-column (elfeed-format-column
                        tags-str (elfeed-clamp (length tags-str)
                                               elfeed-goodies/tag-column-width
                                               elfeed-goodies/tag-column-width)
                        </span><span style="color: #a626a4; background-color: #e7e7e7;">:left</span><span class="ef-ob">))
           (feed-column (elfeed-format-column
                         feed-title (elfeed-clamp elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width)
                         </span><span style="color: #a626a4; background-color: #e7e7e7;">:left</span><span class="ef-ob">)))

      (insert (propertize feed-column 'face 'elfeed-search-feed-face) </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">)
      (insert (propertize tag-column 'face 'elfeed-search-tag-face) </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">)
      (insert (propertize title 'face title-faces 'kbd-help title))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> line-spacing 0.2)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+rss/elfeed-show-refresh--better-style</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Update the buffer to match the selected entry, using a mail-style."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((inhibit-read-only t)
           (title (elfeed-entry-title elfeed-show-entry))
           (date (seconds-to-time (elfeed-entry-date elfeed-show-entry)))
           (author (elfeed-meta elfeed-show-entry </span><span style="color: #a626a4; background-color: #e7e7e7;">:author</span><span class="ef-ob">))
           (link (elfeed-entry-link elfeed-show-entry))
           (tags (elfeed-entry-tags elfeed-show-entry))
           (tagsstr (mapconcat #'symbol-name tags </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">))
           (nicedate (format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%a, %e %b %Y %T %Z"</span><span class="ef-ob"> date))
           (content (elfeed-deref (elfeed-entry-content elfeed-show-entry)))
           (type (elfeed-entry-content-type elfeed-show-entry))
           (feed (elfeed-entry-feed elfeed-show-entry))
           (feed-title (elfeed-feed-title feed))
           (base (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> feed (elfeed-compute-base (elfeed-feed-url feed)))))
      (erase-buffer)
      (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
      (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s\n\n"</span><span class="ef-ob"> (propertize title 'face 'elfeed-show-title-face)))
      (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s\t"</span><span class="ef-ob"> (propertize feed-title 'face 'elfeed-search-feed-face)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> author elfeed-show-entry-author)
        (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s\n"</span><span class="ef-ob"> (propertize author 'face 'elfeed-show-author-face))))
      (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s\n\n"</span><span class="ef-ob"> (propertize nicedate 'face 'elfeed-log-date-face)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> tags
        (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s\n"</span><span class="ef-ob">
                        (propertize tagsstr 'face 'elfeed-search-tag-face))))
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(insert (propertize "Link: " 'face 'message-header-name))
</span>      <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(elfeed-insert-link link link)
</span>      <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(insert "\n")
</span><span class="ef-ob">      (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-loop</span><span class="ef-ob"> for enclosure in (elfeed-entry-enclosures elfeed-show-entry)
               do (insert (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Enclosure: "</span><span class="ef-ob"> 'face 'message-header-name))
               do (elfeed-insert-link (car enclosure))
               do (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
      (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> content
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq type 'html)
              (elfeed-insert-html content base)
            (insert content))
        (insert (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"(empty)\n"</span><span class="ef-ob"> 'face 'italic)))
      (goto-char (point-min))))

  )
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Functionality enhancements</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> elfeed-show
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">url</span><span class="ef-ob">)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">elfeed-pdf-dir</span><span class="ef-ob">
    (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"pdfs/"</span><span class="ef-ob">
                      (file-name-directory (directory-file-name elfeed-enclosure-default-dir))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">elfeed-link-pdfs</span><span class="ef-ob">
    '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://www.jstatsoft.org/index.php/jss/article/view/v0</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://www.jstatsoft.org/index.php/jss/article/view/v0\\1/v\\1.pdf"</span><span class="ef-ob">)
      (</span><span style="color: #50a14f; background-color: #e7e7e7;">"http://arxiv.org/abs/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://arxiv.org/pdf/\\1.pdf"</span><span class="ef-ob">))
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"List of alists of the form (REGEX-FOR-LINK . FORM-FOR-PDF)"</span><span class="ef-ob">)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">elfeed-show-pdf</span><span class="ef-ob"> (entry)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">
     (list (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> elfeed-show-entry (elfeed-search-selected </span><span style="color: #a626a4; background-color: #e7e7e7;">:ignore-region</span><span class="ef-ob">))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((link (elfeed-entry-link entry))
          (feed-name (plist-get (elfeed-feed-meta (elfeed-entry-feed entry)) </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">))
          (title (elfeed-entry-title entry))
          (file-view-function
           (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (f)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> elfeed-show-entry
               (elfeed-kill-buffer))
             (pop-to-buffer (find-file-noselect f))))
          pdf)

      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((file (expand-file-name
                   (concat (subst-char-in-string ?/ ?, title) </span><span style="color: #50a14f; background-color: #e7e7e7;">".pdf"</span><span class="ef-ob">)
                   (expand-file-name (subst-char-in-string ?/ ?, feed-name)
                                     elfeed-pdf-dir))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (file-exists-p file)
            (funcall file-view-function file)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (link-pdf elfeed-link-pdfs)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string-match-p (car link-pdf) link)
                       (not pdf))
              (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> pdf (replace-regexp-in-string (car link-pdf) (cdr link-pdf) link))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (not pdf)
              (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"No associated PDF for entry"</span><span class="ef-ob">)
            (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Fetching %s"</span><span class="ef-ob"> pdf)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p (file-name-directory file))
              (make-directory (file-name-directory file) t))
            (url-copy-file pdf file)
            (funcall file-view-function file))))))

  )
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Dictionary</span>

<span style="color: #84888b;">#+call: confpkg(needs="sdcv")</span>

Doom already loads <span style="color: #84888b;">=define-word=</span>, and provides it's own definition service using
<span style="color: #4078f2; font-weight: 700;">[[https://github.com/gromnitsky/wordnut][wordnut]]</span>. However, using an offline dictionary possess a few compelling
advantages, namely:
+ speed
+ integration of multiple dictionaries
<span style="color: #4078f2; font-weight: 700;">[[http://goldendict.org/][GoldenDict]]</span> seems like the best option currently available, but lacks a CLI.
Hence, we'll fall back to <span style="color: #4078f2; font-weight: 700;">[[https://dushistov.github.io/sdcv/][sdcv]]</span> (a CLI version of StarDict) for now.
To interface with this, we'll use a my <span style="color: #84888b;">=lexic=</span> package.

<span style="color: #84888b;">#+attr_html: :class invertible :alt Screenshot of the lexic-mode view of "literate"</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/lexic.png]]</span>

<span class="ef-obb">#+begin_src emacs-lisp :tangle (if (executable-find "sdcv") "packages.el" "no")
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> lexic </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/lexic"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Given that a request for a CLI is the <span style="color: #4078f2; font-weight: 700;">[[https://github.com/goldendict/goldendict/issues/37][most upvoted issue]]</span> on GitHub for
GoldenDict, it's likely we'll be able to switch from <span style="color: #84888b;">~sdcv~</span> to that in the future.

Since GoldenDict supports StarDict files, I expect this will be a relatively
painless switch.

We start off by loading <span style="color: #84888b;">=lexic=</span>, then we'll integrate it into pre-existing
definition functionality (like <span style="color: #84888b;">~+lookup/dictionary-definition~</span>).
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! lexic
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> lexic-search lexic-list-dictionary
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> lexic-mode-map
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob"> #'lexic-return-from-lexic
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:nv</span> <span style="color: #50a14f; background-color: #e7e7e7;">"RET"</span><span class="ef-ob"> #'lexic-search-word-at-point
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"a"</span><span class="ef-ob"> #'outline-show-all
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"h"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (outline-hide-sublevels 3))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o"</span><span class="ef-ob"> #'lexic-toggle-entry
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n"</span><span class="ef-ob"> #'lexic-next-entry
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"N"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (lexic-next-entry t))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"p"</span><span class="ef-ob"> #'lexic-previous-entry
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"P"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (lexic-previous-entry t))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"E"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (lexic-return-from-lexic) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">expand
</span><span class="ef-ob">                     (switch-to-buffer (lexic-get-buffer)))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (lexic-return-from-lexic) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">minimise
</span><span class="ef-ob">                     (lexic-goto-lexic))
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"C-p"</span><span class="ef-ob"> #'lexic-search-history-backwards
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"C-n"</span><span class="ef-ob"> #'lexic-search-history-forwards
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"/"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (call-interactively #'lexic-search))))
</span><span class="ef-obe">#+end_src
</span>
Now let's use this instead of wordnet.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +lookup/dictionary-definition-lexic (identifier </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> arg)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Look up the definition of the word at point (or selection) using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">lexic-search</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'+lookup/dictionary-definition
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">
   (list (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (doom-thing-at-point-or-region 'word)
             (read-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"Look up in dictionary: "</span><span class="ef-ob">))
         current-prefix-arg))
  (lexic-search identifier nil nil t))
</span><span class="ef-obe">#+end_src
</span>
Lastly, I want to make sure I have some dictionaries set up. I've put a tarball
of dictionaries online which we can download if none seem to be present on the
system.
<span class="ef-obb">#+begin_src shell :tangle (if (and (executable-find "sdcv") (not (file-exists-p (concat (or (getenv "STARDICT_DATA_DIR") (concat (or "~/.local/share" (getenv "XDG_DATA_HOME")) "/stardict")) "/dic")))) "setup.sh" "no")
</span><span style="color: #6a1868; background-color: #e7e7e7;">DIC_FOLDER</span><span class="ef-ob">=${</span><span style="color: #6a1868; background-color: #e7e7e7;">STARDICT_DATA_DIR</span><span class="ef-ob">:-${</span><span style="color: #6a1868; background-color: #e7e7e7;">XDG_DATA_HOME</span><span class="ef-ob">:-$</span><span style="color: #6a1868; background-color: #e7e7e7;">HOME</span><span class="ef-ob">/.local/share}/stardict}/dic
</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> [ </span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">!</span><span class="ef-ob"> -d </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DIC_FOLDER"</span><span class="ef-ob"> ]; </span><span style="color: #e45649; background-color: #e7e7e7;">then</span>
    <span style="color: #6a1868; background-color: #e7e7e7;">TMP</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"$(mktemp -d /tmp/dict-XXX)"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">cd</span> <span style="color: #50a14f; background-color: #e7e7e7;">"$TMP"</span><span class="ef-ob">
    curl -A </span><span style="color: #50a14f; background-color: #e7e7e7;">"Mozilla/4.0"</span><span class="ef-ob"> -o </span><span style="color: #50a14f; background-color: #e7e7e7;">"stardict.tar.gz"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/config/stardict.tar.gz"</span><span class="ef-ob">
    tar -xf </span><span style="color: #50a14f; background-color: #e7e7e7;">"stardict.tar.gz"</span><span class="ef-ob">
    rm </span><span style="color: #50a14f; background-color: #e7e7e7;">"stardict.tar.gz"</span><span class="ef-ob">
    mkdir -p </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DIC_FOLDER"</span><span class="ef-ob">
    mv * </span><span style="color: #50a14f; background-color: #e7e7e7;">"$DIC_FOLDER"</span>
<span style="color: #e45649; background-color: #e7e7e7;">fi</span>
<span class="ef-obe">#+end_src
</span>
We can also add a <span style="color: #84888b;">=doctor=</span> dictionary check.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"sdcv"</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((dict-root (concat (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"STARDICT_DATA_DIR"</span><span class="ef-ob">)
                                 (concat (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span> <span style="color: #50a14f; background-color: #e7e7e7;">"~/.local/share"</span><span class="ef-ob">
                                             (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"XDG_DATA_HOME"</span><span class="ef-ob">))
                                         </span><span style="color: #50a14f; background-color: #e7e7e7;">"/stardict"</span><span class="ef-ob">))
                             </span><span style="color: #50a14f; background-color: #e7e7e7;">"/dic"</span><span class="ef-ob">))
          (dicts '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"webster"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"synonyms"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"etymology"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"en-to-latin"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"hitchcock"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"elements"</span><span class="ef-ob">)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (file-exists-p dict-root)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (dict dicts)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p (file-name-concat dict-root dict))
              (warn! (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Absent sdcv dictionary: %s."</span><span class="ef-ob"> dict))))
        (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find any stcv dictionaries, lexic will not function"</span><span class="ef-ob">)))
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find sdcv executable, lexic will be disabled"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Mail</span>

<span style="color: #84888b;">#+call: confpkg(after="mu4e", via="require", pre="org-msg-accent")</span>

<span style="color: #4078f2; font-weight: 700;">[[xkcd:1467]]</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Fetching</span>

The contenders for this seem to be:
+ <span style="color: #4078f2; font-weight: 700;">[[https://www.offlineimap.org/][OfflineIMAP]]</span> (<span style="color: #4078f2; font-weight: 700;">[[https://wiki.archlinux.org/index.php/OfflineIMAP][ArchWiki page]]</span>)
+ <span style="color: #4078f2; font-weight: 700;">[[http://isync.sourceforge.net/mbsync.html][isync/mbsync]]</span> (<span style="color: #4078f2; font-weight: 700;">[[https://wiki.archlinux.org/index.php/isync][ArchWiki page]]</span>)

From perusing r/emacs the prevailing opinion seems to be that
+ isync is faster
+ isync works more reliably
So let's use that.

The config was straightforward, and is located at <span style="color: #4078f2; font-weight: 700;">[[file:~/.mbsyncrc][~/.mbsyncrc]]</span>.
I'm currently successfully connecting to: Gmail, office365mail, and dovecot.
I'm also shoving passwords in my <span style="color: #4078f2; font-weight: 700;">[[file:~/.authinfo.gpg][authinfo.gpg]]</span> and fetching them using <span style="color: #84888b;">~PassCmd~</span>:
<span class="ef-obb">#+begin_src shell :tangle no :eval no
</span><span class="ef-ob">gpg2 -q --for-your-eyes-only --no-tty -d ~/.authinfo.gpg | awk </span><span style="color: #50a14f; background-color: #e7e7e7;">'/machine IMAP_SERCER login EMAIL_ADDR/ {print $NF}'</span>
<span class="ef-obe">#+end_src
</span>
We can run <span style="color: #84888b;">~mbsync -a~</span> in a systemd service file or something, but we can do
better than that. <span style="color: #4078f2; font-weight: 700;">[[https://github.com/vsemyonoff/easymail#usage][vsemyonoff/easymail]]</span> seems like the sort of thing we want, but
is written for <span style="color: #84888b;">=notmuch=</span> unfortunately. We can still use it for inspiration though.
Using <span style="color: #4078f2; font-weight: 700;">[[https://gitlab.com/shackra/goimapnotify][goimapnotify]]</span> we should be able to sync just after new
mail. Unfortunately this means <span style="text-decoration: italic;">/yet another/</span> config file :(

We install with
<span class="ef-obb">#+begin_src shell :eval no :tangle (if (and (executable-find "mu") (not (executable-find "goimapnotify"))) "setup.sh" "no")
</span><span class="ef-ob">go get -u gitlab.com/shackra/goimapnotify
ln -s ~/.local/share/go/bin/goimapnotify ~/.local/bin/
</span><span class="ef-obe">#+end_src
</span>
Here's the general plan:
1. Use <span style="color: #84888b;">~goimapnotify~</span> to monitor mailboxes
   This needs it's own set of configs, and <span style="color: #84888b;">=systemd=</span> services, which is a pain. We
   remove this pain by writing a python script (found below) to setup these
   config files, and systemd services by parsing the  <span style="color: #4078f2; font-weight: 700;">[[file:~/.mbsyncrc][~/.mbsyncrc]]</span> file.
2. On new mail, call <span style="color: #84888b;">~mbsync --pull --new ACCOUNT:BOX~</span>
   We try to be as specific as possible, so <span style="color: #84888b;">~mbsync~</span> returns as soon as possible,
   and we can <span style="text-decoration: italic;">/get those emails as soon as possible/</span>.
3. Try to call <span style="color: #84888b;">~mu index --lazy-fetch~</span>.
   This fails if mu4e is already open (due to a write lock on the database), so
   in that case we just <span style="color: #84888b;">~touch~</span> a tmp file (<span style="color: #84888b;">=/tmp/mu_reindex_now=</span>).
4. Separately, we set up Emacs to check for the existance of
   <span style="color: #84888b;">=/tmp/mu_reindex_now=</span> once a second while mu4e is
   running, and (after deleting the file) call <span style="color: #84888b;">~mu4e-update-index~</span>.

We can add a <span style="color: #84888b;">=doctor=</span> check for these external dependencies.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (file-exists-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.mail"</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">We care about mail when the mail folder exists
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"mu"</span><span class="ef-ob">)
    (error! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find mail dependency mu."</span><span class="ef-ob">))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"mbsync"</span><span class="ef-ob">)
    (error! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find mail dependency mbsync."</span><span class="ef-ob">))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"msmtp"</span><span class="ef-ob">)
    (error! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find mail dependency msmtp."</span><span class="ef-ob">))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"goimapnotify"</span><span class="ef-ob">)
    (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find mail helper goimapnotify, mail syncs will be slower."</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
Let's start off by handling the elisp side of things

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Rebuild mail index while using mu4e</span>

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref mu4e-conf
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">mu4e-reindex-request-file</span> <span style="color: #50a14f; background-color: #e7e7e7;">"/tmp/mu_reindex_now"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Location of the reindex request, signaled by existance"</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">mu4e-reindex-request-min-seperation</span><span class="ef-ob"> 5.0
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Don't refresh again until this many second have elapsed.
Prevents a series of redisplays from being called (when set to an appropriate value)"</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">mu4e-reindex-request--file-watcher</span><span class="ef-ob"> nil)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">mu4e-reindex-request--file-just-deleted</span><span class="ef-ob"> nil)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">mu4e-reindex-request--last-time</span><span class="ef-ob"> 0)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">mu4e-reindex-request--add-watcher</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-reindex-request--file-just-deleted nil)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-reindex-request--file-watcher
        (file-notify-add-watch mu4e-reindex-request-file
                               '(change)
                               #'mu4e-file-reindex-request)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> mu4e-stop-watching-for-reindex-request ()
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'mu4e--server-kill
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> mu4e-reindex-request--file-watcher
      (file-notify-rm-watch mu4e-reindex-request--file-watcher)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> mu4e-watch-for-reindex-request ()
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'mu4e--server-start
  (mu4e-stop-watching-for-reindex-request)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (file-exists-p mu4e-reindex-request-file)
    (delete-file mu4e-reindex-request-file))
  (mu4e-reindex-request--add-watcher))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">mu4e-file-reindex-request</span><span class="ef-ob"> (event)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Act based on the existance of `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mu4e-reindex-request-file</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> mu4e-reindex-request--file-just-deleted
      (mu4e-reindex-request--add-watcher)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (equal (nth 1 event) 'created)
      (delete-file mu4e-reindex-request-file)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-reindex-request--file-just-deleted t)
      (mu4e-reindex-maybe t))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">mu4e-reindex-maybe</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> new-request)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Run `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mu4e--server-index</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' if it's been more than
`</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mu4e-reindex-request-min-seperation</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'seconds since the last request,"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((time-since-last-request (- (float-time)
                                    mu4e-reindex-request--last-time)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> new-request
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-reindex-request--last-time (float-time)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&gt; time-since-last-request mu4e-reindex-request-min-seperation)
        (mu4e--server-index nil t)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> new-request
        (run-at-time (* 1.1 mu4e-reindex-request-min-seperation) nil
                     #'mu4e-reindex-maybe)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Config transcoding &amp; service management</span>

As long as the <span style="color: #84888b;">=mbsyncrc=</span> file exists, this is as easy as running

<span class="ef-obb">#+begin_src shell :tangle (if (and (executable-find "goimapnotify") (not (file-exists-p "~/.config/imapnotify"))) "setup.sh" "no")
</span><span class="ef-ob">~/.config/doom/misc/mbsync-imapnotify.py
</span><span class="ef-obe">#+end_src
</span>
Let's also add a <span style="color: #84888b;">=doctor=</span> check for this.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"goimapnotify"</span><span class="ef-ob">)
           (not (file-exists-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.config/imapnotify"</span><span class="ef-ob">)))
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"goimapnotify is installed but not configured."</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
When run without flags this will perform the following actions
+ Read, and parse <span style="color: #4078f2; font-weight: 700;">[[file:~/.mbsyncrc][~/.mbsyncrc]]</span>, specifically recognising the following properties
  - <span style="color: #84888b;">~IMAPAccount~</span>
  - <span style="color: #84888b;">~Host~</span>
  - <span style="color: #84888b;">~Port~</span>
  - <span style="color: #84888b;">~User~</span>
  - <span style="color: #84888b;">~Password~</span>
  - <span style="color: #84888b;">~PassCmd~</span>
  - <span style="color: #84888b;">~Patterns~</span>
+ Call <span style="color: #84888b;">~mbsync --list ACCOUNT~</span>, and filter results according to <span style="color: #84888b;">~Patterns~</span>
+ Construct a imapnotify config for each account, with the following hooks
  - <span style="font-weight: 700;">onNewMail ::</span> <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">shell</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">mbsync --pull ACCOUNT:MAILBOX</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>
  - <span style="font-weight: 700;">onNewMailPost ::</span> <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">shell</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> mu index --lazy-check; </span><span style="color: #e45649; background-color: #e7e7e7;">then </span><span style="color: #a626a4; background-color: #e7e7e7;">test</span><span class="ef-ob"> -f /tmp/mu_reindex_now &amp;&amp; rm /tmp/mu_reindex_now; </span><span style="color: #e45649; background-color: #e7e7e7;">else</span><span class="ef-ob"> touch /tmp/mu_reindex_now; </span><span style="color: #e45649; background-color: #e7e7e7;">fi</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>
+ Compare accounts list to previous accounts, enable/disable the relevant
  systemd services, called with the <span style="color: #84888b;">~--now~</span> flag (start/stop services as well)

This script also supports the following flags
+ <span style="color: #84888b;">~--status~</span> to get the status of the relevant systemd services supports <span style="color: #84888b;">=active=</span>,
  <span style="color: #84888b;">=failing=</span>, and <span style="color: #84888b;">=disabled=</span>
+ <span style="color: #84888b;">~--enable~</span> to enable all relevant systemd services
+ <span style="color: #84888b;">~--disable~</span> to disable all relevant systemd services
<span class="ef-obb">#+begin_src python :tangle misc/mbsync-imapnotify.py :shebang "#!/usr/bin/env python3"
</span><span style="color: #e45649; background-color: #e7e7e7;">from</span><span class="ef-ob"> pathlib </span><span style="color: #e45649; background-color: #e7e7e7;">import</span><span class="ef-ob"> Path
</span><span style="color: #e45649; background-color: #e7e7e7;">import</span><span class="ef-ob"> json
</span><span style="color: #e45649; background-color: #e7e7e7;">import</span><span class="ef-ob"> re
</span><span style="color: #e45649; background-color: #e7e7e7;">import</span><span class="ef-ob"> shutil
</span><span style="color: #e45649; background-color: #e7e7e7;">import</span><span class="ef-ob"> subprocess
</span><span style="color: #e45649; background-color: #e7e7e7;">import</span><span class="ef-ob"> sys
</span><span style="color: #e45649; background-color: #e7e7e7;">import</span><span class="ef-ob"> fnmatch

</span><span style="color: #6a1868; background-color: #e7e7e7;">mbsyncFile</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> Path(</span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.mbsyncrc"</span><span class="ef-ob">).expanduser()

</span><span style="color: #6a1868; background-color: #e7e7e7;">imapnotifyConfigFolder</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> Path(</span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.config/imapnotify/"</span><span class="ef-ob">).expanduser()
imapnotifyConfigFolder.mkdir(exist_ok</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">)
</span><span style="color: #6a1868; background-color: #e7e7e7;">imapnotifyConfigFilename</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span> <span style="color: #50a14f; background-color: #e7e7e7;">"notify.conf"</span>

<span style="color: #6a1868; background-color: #e7e7e7;">imapnotifyDefault</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> {
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"host"</span><span class="ef-ob">: </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">,
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"port"</span><span class="ef-ob">: 993,
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"tls"</span><span class="ef-ob">: </span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">,
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"tlsOptions"</span><span class="ef-ob">: {</span><span style="color: #50a14f; background-color: #e7e7e7;">"rejectUnauthorized"</span><span class="ef-ob">: </span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">},
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"onNewMail"</span><span class="ef-ob">: </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">,
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"onNewMailPost"</span><span class="ef-ob">: </span><span style="color: #50a14f; background-color: #e7e7e7;">"if mu index --lazy-check; then test -f /tmp/mu_reindex_now &amp;&amp; rm /tmp/mu_reindex_now; else touch /tmp/mu_reindex_now; fi"</span><span class="ef-ob">,
}


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">stripQuotes</span><span class="ef-ob">(string):
    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> string[0] </span><span style="color: #84888b; background-color: #e7e7e7;">==</span> <span style="color: #50a14f; background-color: #e7e7e7;">'"'</span> <span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> string[</span><span style="color: #84888b; background-color: #e7e7e7;">-</span><span class="ef-ob">1] </span><span style="color: #84888b; background-color: #e7e7e7;">==</span> <span style="color: #50a14f; background-color: #e7e7e7;">'"'</span><span class="ef-ob">:
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span><span class="ef-ob"> string[1:</span><span style="color: #84888b; background-color: #e7e7e7;">-</span><span class="ef-ob">1].replace(</span><span style="color: #50a14f; background-color: #e7e7e7;">'</span><span style="color: #b751b6; background-color: #e7e7e7;">\\</span><span style="color: #50a14f; background-color: #e7e7e7;">"'</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">'"'</span><span class="ef-ob">)


</span><span style="color: #6a1868; background-color: #e7e7e7;">mbsyncInotifyMapping</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> {
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"Host"</span><span class="ef-ob">: (</span><span style="color: #a626a4; background-color: #e7e7e7;">str</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"host"</span><span class="ef-ob">),
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"Port"</span><span class="ef-ob">: (</span><span style="color: #a626a4; background-color: #e7e7e7;">int</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"port"</span><span class="ef-ob">),
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"User"</span><span class="ef-ob">: (</span><span style="color: #a626a4; background-color: #e7e7e7;">str</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"username"</span><span class="ef-ob">),
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"Password"</span><span class="ef-ob">: (</span><span style="color: #a626a4; background-color: #e7e7e7;">str</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"password"</span><span class="ef-ob">),
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"PassCmd"</span><span class="ef-ob">: (stripQuotes, </span><span style="color: #50a14f; background-color: #e7e7e7;">"passwordCmd"</span><span class="ef-ob">),
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"Patterns"</span><span class="ef-ob">: (</span><span style="color: #a626a4; background-color: #e7e7e7;">str</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"_patterns"</span><span class="ef-ob">),
}

</span><span style="color: #6a1868; background-color: #e7e7e7;">oldAccounts</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> [d.name </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> d </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> imapnotifyConfigFolder.iterdir() </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> d.is_dir()]

</span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccount</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span>
<span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> {}

</span><span style="color: #6a1868; background-color: #e7e7e7;">successfulAdditions</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> []


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">processLine</span><span class="ef-ob">(line):
    </span><span style="color: #6a1868; background-color: #e7e7e7;">newAcc</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> re.</span><span style="color: #e45649; background-color: #e7e7e7;">match</span><span class="ef-ob">(r</span><span style="color: #50a14f; background-color: #e7e7e7;">"^IMAPAccount ([^#]+)"</span><span class="ef-ob">, line)

    </span><span style="color: #6a1868; background-color: #e7e7e7;">linecontent</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> re.sub(r</span><span style="color: #50a14f; background-color: #e7e7e7;">"(^|[^\\])#.*"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">, line).split(</span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">, 1)
    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span> <span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(linecontent) </span><span style="color: #84888b; background-color: #e7e7e7;">!=</span><span class="ef-ob"> 2:
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span>

    <span style="color: #6a1868; background-color: #e7e7e7;">parameter</span><span class="ef-ob">, </span><span style="color: #6a1868; background-color: #e7e7e7;">value</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> linecontent

    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> parameter </span><span style="color: #84888b; background-color: #e7e7e7;">==</span> <span style="color: #50a14f; background-color: #e7e7e7;">"IMAPAccount"</span><span class="ef-ob">:
        </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> currentAccountNumber </span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span><span class="ef-ob"> 0:
            finaliseAccount()
        newAccount(value)
    </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> parameter </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> mbsyncInotifyMapping.keys():
        </span><span style="color: #6a1868; background-color: #e7e7e7;">parser</span><span class="ef-ob">, </span><span style="color: #6a1868; background-color: #e7e7e7;">key</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> mbsyncInotifyMapping[parameter]
        </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span><span class="ef-ob">[key] </span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> parser(value)
    </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> parameter </span><span style="color: #84888b; background-color: #e7e7e7;">==</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Channel"</span><span class="ef-ob">:
        </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span><span class="ef-ob">[</span><span style="color: #50a14f; background-color: #e7e7e7;">"onNewMail"</span><span class="ef-ob">] </span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> f</span><span style="color: #50a14f; background-color: #e7e7e7;">"mbsync --pull --new </span><span class="ef-ob">{value}</span><span style="color: #50a14f; background-color: #e7e7e7;">:'%s'"</span>


<span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">newAccount</span><span class="ef-ob">(name):
    </span><span style="color: #e45649; background-color: #e7e7e7;">global</span><span class="ef-ob"> currentAccountNumber
    </span><span style="color: #e45649; background-color: #e7e7e7;">global</span><span class="ef-ob"> currentAccount
    </span><span style="color: #e45649; background-color: #e7e7e7;">global</span><span class="ef-ob"> currentAccountData
    </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountNumber</span> <span style="color: #84888b; background-color: #e7e7e7;">+=</span><span class="ef-ob"> 1
    </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccount</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> name
    </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> {}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\n\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;32m</span><span class="ef-ob">{currentAccountNumber}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;32m - </span><span class="ef-ob">{name}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">accountToFoldername</span><span class="ef-ob">(name):
    </span><span style="color: #e45649; background-color: #e7e7e7;">return</span><span class="ef-ob"> re.sub(r</span><span style="color: #50a14f; background-color: #e7e7e7;">"[^A-Za-z0-9]"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">, name)


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">finaliseAccount</span><span class="ef-ob">():
    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> currentAccountNumber </span><span style="color: #84888b; background-color: #e7e7e7;">==</span><span class="ef-ob"> 0:
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span>

    <span style="color: #e45649; background-color: #e7e7e7;">global</span><span class="ef-ob"> currentAccountData
    </span><span style="color: #e45649; background-color: #e7e7e7;">try</span><span class="ef-ob">:
        </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span><span class="ef-ob">[</span><span style="color: #50a14f; background-color: #e7e7e7;">"boxes"</span><span class="ef-ob">] </span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> getMailBoxes(currentAccount)
    </span><span style="color: #e45649; background-color: #e7e7e7;">except</span><span class="ef-ob"> subprocess.CalledProcessError </span><span style="color: #e45649; background-color: #e7e7e7;">as</span><span class="ef-ob"> e:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(
            f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31mError:</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;31m failed to fetch mailboxes (skipping): "</span>
            <span style="color: #84888b; background-color: #e7e7e7;">+</span><span class="ef-ob"> f</span><span style="color: #50a14f; background-color: #e7e7e7;">"`</span><span class="ef-ob">{' '.join(e.cmd)}</span><span style="color: #50a14f; background-color: #e7e7e7;">' returned code </span><span class="ef-ob">{e.returncode}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">
        )
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span>
    <span style="color: #e45649; background-color: #e7e7e7;">except</span><span class="ef-ob"> subprocess.TimeoutExpired </span><span style="color: #e45649; background-color: #e7e7e7;">as</span><span class="ef-ob"> e:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(
            f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31mError:</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;31m failed to fetch mailboxes (skipping): "</span>
            <span style="color: #84888b; background-color: #e7e7e7;">+</span><span class="ef-ob"> f</span><span style="color: #50a14f; background-color: #e7e7e7;">"`</span><span class="ef-ob">{' '.join(e.cmd)}</span><span style="color: #50a14f; background-color: #e7e7e7;">' timed out after </span><span class="ef-ob">{e.timeout:.2f}</span><span style="color: #50a14f; background-color: #e7e7e7;"> seconds</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">
        )
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span>

    <span style="color: #e45649; background-color: #e7e7e7;">if</span> <span style="color: #50a14f; background-color: #e7e7e7;">"_patterns"</span> <span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> currentAccountData:
        </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span><span class="ef-ob">[</span><span style="color: #50a14f; background-color: #e7e7e7;">"boxes"</span><span class="ef-ob">] </span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> applyPatternFilter(
            currentAccountData[</span><span style="color: #50a14f; background-color: #e7e7e7;">"_patterns"</span><span class="ef-ob">], currentAccountData[</span><span style="color: #50a14f; background-color: #e7e7e7;">"boxes"</span><span class="ef-ob">]
        )

    </span><span style="color: #84888b; background-color: #e7e7e7;"># </span><span style="color: #84888b; background-color: #e7e7e7;">strip not-to-be-exported data
</span>    <span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> {
        k: currentAccountData[k] </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> k </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> currentAccountData </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> k[0] </span><span style="color: #84888b; background-color: #e7e7e7;">!=</span> <span style="color: #50a14f; background-color: #e7e7e7;">"_"</span><span class="ef-ob">
    }

    </span><span style="color: #6a1868; background-color: #e7e7e7;">parametersSet</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> currentAccountData.keys()
    </span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountData</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> {</span><span style="color: #84888b; background-color: #e7e7e7;">**</span><span class="ef-ob">imapnotifyDefault, </span><span style="color: #84888b; background-color: #e7e7e7;">**</span><span class="ef-ob">currentAccountData}
    </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> key, val </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> currentAccountData.items():
        </span><span style="color: #6a1868; background-color: #e7e7e7;">valColor</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span> <span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;33m"</span> <span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> key </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> parametersSet </span><span style="color: #e45649; background-color: #e7e7e7;">else</span> <span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span>
        <span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"  </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;37m</span><span class="ef-ob">{key:</span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span class="ef-ob">13}</span> <span class="ef-ob">{valColor}{val}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)

    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (
            </span><span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(currentAccountData[</span><span style="color: #50a14f; background-color: #e7e7e7;">"boxes"</span><span class="ef-ob">]) </span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span><span class="ef-ob"> 15
            </span><span style="color: #e45649; background-color: #e7e7e7;">and</span> <span style="color: #50a14f; background-color: #e7e7e7;">"@gmail.com"</span> <span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> currentAccountData[</span><span style="color: #50a14f; background-color: #e7e7e7;">"username"</span><span class="ef-ob">]
    ):
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"  </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31mWarning:</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;31m Gmail raises an error when more than"</span>
            <span style="color: #84888b; background-color: #e7e7e7;">+</span> <span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31m15</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;31m simultanious connections are attempted."</span>
            <span style="color: #84888b; background-color: #e7e7e7;">+</span> <span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\n</span><span style="color: #50a14f; background-color: #e7e7e7;">           You are attempting to monitor "</span>
            <span style="color: #84888b; background-color: #e7e7e7;">+</span><span class="ef-ob"> f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31m</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(currentAccountData['boxes'])}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;31m mailboxes.</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">
        )

    </span><span style="color: #6a1868; background-color: #e7e7e7;">configFile</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> (
        imapnotifyConfigFolder
        </span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span class="ef-ob"> accountToFoldername(currentAccount)
        </span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span class="ef-ob"> imapnotifyConfigFilename
    )
    configFile.parent.mkdir(exist_ok</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">)

    json.dump(currentAccountData, </span><span style="color: #a626a4; background-color: #e7e7e7;">open</span><span class="ef-ob">(configFile, </span><span style="color: #50a14f; background-color: #e7e7e7;">"w"</span><span class="ef-ob">), indent</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob">2)
    </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">" </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;35mConfig generated and saved to </span><span class="ef-ob">{configFile}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)

    </span><span style="color: #e45649; background-color: #e7e7e7;">global</span><span class="ef-ob"> successfulAdditions
    successfulAdditions.append(accountToFoldername(currentAccount))


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">getMailBoxes</span><span class="ef-ob">(account):
    </span><span style="color: #6a1868; background-color: #e7e7e7;">boxes</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> subprocess.run(
        [</span><span style="color: #50a14f; background-color: #e7e7e7;">"mbsync"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--list"</span><span class="ef-ob">, account], check</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">, stdout</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob">subprocess.PIPE, timeout</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob">10.0
    )
    </span><span style="color: #e45649; background-color: #e7e7e7;">return</span><span class="ef-ob"> boxes.stdout.decode(</span><span style="color: #50a14f; background-color: #e7e7e7;">"utf-8"</span><span class="ef-ob">).strip().split(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\n</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">)


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">applyPatternFilter</span><span class="ef-ob">(pattern, mailboxes):
    </span><span style="color: #6a1868; background-color: #e7e7e7;">patternRegexs</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> getPatternRegexes(pattern)
    </span><span style="color: #e45649; background-color: #e7e7e7;">return</span><span class="ef-ob"> [m </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> m </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> mailboxes </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> testPatternRegexs(patternRegexs, m)]


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">getPatternRegexes</span><span class="ef-ob">(pattern):
    </span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">addGlob</span><span class="ef-ob">(b):
        blobs.append(b.replace(</span><span style="color: #50a14f; background-color: #e7e7e7;">'</span><span style="color: #b751b6; background-color: #e7e7e7;">\\</span><span style="color: #50a14f; background-color: #e7e7e7;">"'</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">'"'</span><span class="ef-ob">))
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span>

    <span style="color: #6a1868; background-color: #e7e7e7;">blobs</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> []
    </span><span style="color: #6a1868; background-color: #e7e7e7;">pattern</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> re.sub(r</span><span style="color: #50a14f; background-color: #e7e7e7;">' ?"([^"]+)"'</span><span class="ef-ob">, </span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> m: addGlob(m.groups()[0]), pattern)
    blobs.extend(pattern.split(</span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">))
    </span><span style="color: #6a1868; background-color: #e7e7e7;">blobs</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> [
        (</span><span style="color: #84888b; background-color: #e7e7e7;">-</span><span class="ef-ob">1, fnmatch.translate(b[1::])) </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> b[0] </span><span style="color: #84888b; background-color: #e7e7e7;">==</span> <span style="color: #50a14f; background-color: #e7e7e7;">"!"</span> <span style="color: #e45649; background-color: #e7e7e7;">else</span><span class="ef-ob"> (1, fnmatch.translate(b))
        </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> b </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> blobs
    ]
    </span><span style="color: #e45649; background-color: #e7e7e7;">return</span><span class="ef-ob"> blobs


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">testPatternRegexs</span><span class="ef-ob">(regexCond, </span><span style="color: #e45649; background-color: #e7e7e7;">case</span><span class="ef-ob">):
    </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> factor, regex </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> regexCond:
        </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> factor </span><span style="color: #84888b; background-color: #e7e7e7;">*</span> <span style="color: #a626a4; background-color: #e7e7e7;">bool</span><span class="ef-ob">(re.</span><span style="color: #e45649; background-color: #e7e7e7;">match</span><span class="ef-ob">(regex, </span><span style="color: #e45649; background-color: #e7e7e7;">case</span><span class="ef-ob">)) </span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span class="ef-ob"> 0:
            </span><span style="color: #e45649; background-color: #e7e7e7;">return</span> <span style="color: #b751b6; background-color: #e7e7e7;">False</span>
    <span style="color: #e45649; background-color: #e7e7e7;">return</span> <span style="color: #b751b6; background-color: #e7e7e7;">True</span>


<span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">processSystemdServices</span><span class="ef-ob">():
    </span><span style="color: #6a1868; background-color: #e7e7e7;">keptAccounts</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> [acc </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> acc </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> successfulAdditions </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> acc </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> oldAccounts]
    </span><span style="color: #6a1868; background-color: #e7e7e7;">freshAccounts</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> [acc </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> acc </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> successfulAdditions </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> acc </span><span style="color: #e45649; background-color: #e7e7e7;">not</span> <span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> oldAccounts]
    </span><span style="color: #6a1868; background-color: #e7e7e7;">staleAccounts</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> [acc </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> acc </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> oldAccounts </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> acc </span><span style="color: #e45649; background-color: #e7e7e7;">not</span> <span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> successfulAdditions]

    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> keptAccounts:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;34m</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(keptAccounts)}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;34m kept accounts:</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        restartAccountSystemdServices(keptAccounts)

    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> freshAccounts:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;32m</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(freshAccounts)}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;32m new accounts:</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        enableAccountSystemdServices(freshAccounts)
    </span><span style="color: #e45649; background-color: #e7e7e7;">else</span><span class="ef-ob">:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;32mNo new accounts.</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)

    </span><span style="color: #6a1868; background-color: #e7e7e7;">notActuallyEnabledAccounts</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> [
        acc </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> acc </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> successfulAdditions </span><span style="color: #e45649; background-color: #e7e7e7;">if</span> <span style="color: #e45649; background-color: #e7e7e7;">not</span><span class="ef-ob"> getAccountServiceState(acc)[</span><span style="color: #50a14f; background-color: #e7e7e7;">"enabled"</span><span class="ef-ob">]
    ]
    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> notActuallyEnabledAccounts:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(
            f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;32m</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(notActuallyEnabledAccounts)}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;32m accounts need re-enabling:</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">
        )
        enableAccountSystemdServices(notActuallyEnabledAccounts)

    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> staleAccounts:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;33m</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(staleAccounts)}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;33m removed accounts:</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        disableAccountSystemdServices(staleAccounts)
    </span><span style="color: #e45649; background-color: #e7e7e7;">else</span><span class="ef-ob">:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;33mNo removed accounts.</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">enableAccountSystemdServices</span><span class="ef-ob">(accounts):
    </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> account </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> accounts:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">" </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;32m - </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;37m</span><span class="ef-ob">{account:</span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span class="ef-ob">18}</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">, end</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">, flush</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> setSystemdServiceState(
                </span><span style="color: #50a14f; background-color: #e7e7e7;">"enable"</span><span class="ef-ob">, f</span><span style="color: #50a14f; background-color: #e7e7e7;">"goimapnotify@</span><span class="ef-ob">{accountToFoldername(account)}</span><span style="color: #50a14f; background-color: #e7e7e7;">.service"</span><span class="ef-ob">
        ):
            </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;32m enabled"</span><span class="ef-ob">)


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">disableAccountSystemdServices</span><span class="ef-ob">(accounts):
    </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> account </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> accounts:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">" </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;33m - </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;37m</span><span class="ef-ob">{account:</span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span class="ef-ob">18}</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">, end</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">, flush</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> setSystemdServiceState(
                </span><span style="color: #50a14f; background-color: #e7e7e7;">"disable"</span><span class="ef-ob">, f</span><span style="color: #50a14f; background-color: #e7e7e7;">"goimapnotify@</span><span class="ef-ob">{accountToFoldername(account)}</span><span style="color: #50a14f; background-color: #e7e7e7;">.service"</span><span class="ef-ob">
        ):
            </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;33m disabled"</span><span class="ef-ob">)


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">restartAccountSystemdServices</span><span class="ef-ob">(accounts):
    </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> account </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> accounts:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">" </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;34m - </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;37m</span><span class="ef-ob">{account:</span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span class="ef-ob">18}</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">, end</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">, flush</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> setSystemdServiceState(
                </span><span style="color: #50a14f; background-color: #e7e7e7;">"restart"</span><span class="ef-ob">, f</span><span style="color: #50a14f; background-color: #e7e7e7;">"goimapnotify@</span><span class="ef-ob">{accountToFoldername(account)}</span><span style="color: #50a14f; background-color: #e7e7e7;">.service"</span><span class="ef-ob">
        ):
            </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;34m restarted"</span><span class="ef-ob">)


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">setSystemdServiceState</span><span class="ef-ob">(state, service):
    </span><span style="color: #e45649; background-color: #e7e7e7;">try</span><span class="ef-ob">:
        </span><span style="color: #6a1868; background-color: #e7e7e7;">enabler</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> subprocess.run(
            [</span><span style="color: #50a14f; background-color: #e7e7e7;">"systemctl"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--user"</span><span class="ef-ob">, state, service, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--now"</span><span class="ef-ob">],
            check</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">,
            stderr</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob">subprocess.DEVNULL,
            timeout</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob">5.0,
        )
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span> <span style="color: #b751b6; background-color: #e7e7e7;">True</span>
    <span style="color: #e45649; background-color: #e7e7e7;">except</span><span class="ef-ob"> subprocess.CalledProcessError </span><span style="color: #e45649; background-color: #e7e7e7;">as</span><span class="ef-ob"> e:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(
            f</span><span style="color: #50a14f; background-color: #e7e7e7;">" </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31mfailed</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;31m to </span><span class="ef-ob">{state}</span><span style="color: #50a14f; background-color: #e7e7e7;">, `</span><span class="ef-ob">{' '.join(e.cmd)}</span><span style="color: #50a14f; background-color: #e7e7e7;">'"</span>
            <span style="color: #84888b; background-color: #e7e7e7;">+</span><span class="ef-ob"> f</span><span style="color: #50a14f; background-color: #e7e7e7;">"returned code </span><span class="ef-ob">{e.returncode}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">
        )
    </span><span style="color: #e45649; background-color: #e7e7e7;">except</span><span class="ef-ob"> subprocess.TimeoutExpired </span><span style="color: #e45649; background-color: #e7e7e7;">as</span><span class="ef-ob"> e:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">" </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31mtimed out after </span><span class="ef-ob">{e.timeout:.2f}</span><span style="color: #50a14f; background-color: #e7e7e7;"> seconds</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">return</span> <span style="color: #b751b6; background-color: #e7e7e7;">False</span>


<span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">getAccountServiceState</span><span class="ef-ob">(account):
    </span><span style="color: #e45649; background-color: #e7e7e7;">return</span><span class="ef-ob"> {
        state: </span><span style="color: #a626a4; background-color: #e7e7e7;">bool</span><span class="ef-ob">(
            1
            </span><span style="color: #84888b; background-color: #e7e7e7;">-</span><span class="ef-ob"> subprocess.run(
                [
                    </span><span style="color: #50a14f; background-color: #e7e7e7;">"systemctl"</span><span class="ef-ob">,
                    </span><span style="color: #50a14f; background-color: #e7e7e7;">"--user"</span><span class="ef-ob">,
                    f</span><span style="color: #50a14f; background-color: #e7e7e7;">"is-</span><span class="ef-ob">{state}</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">,
                    </span><span style="color: #50a14f; background-color: #e7e7e7;">"--quiet"</span><span class="ef-ob">,
                    f</span><span style="color: #50a14f; background-color: #e7e7e7;">"goimapnotify@</span><span class="ef-ob">{accountToFoldername(account)}</span><span style="color: #50a14f; background-color: #e7e7e7;">.service"</span><span class="ef-ob">,
                ],
                stderr</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob">subprocess.DEVNULL,
            ).returncode
        )
        </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> state </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"enabled"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"active"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"failing"</span><span class="ef-ob">)
    }


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">getAccountServiceStates</span><span class="ef-ob">(accounts):
    </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> account </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> accounts:
        </span><span style="color: #6a1868; background-color: #e7e7e7;">enabled</span><span class="ef-ob">, </span><span style="color: #6a1868; background-color: #e7e7e7;">active</span><span class="ef-ob">, </span><span style="color: #6a1868; background-color: #e7e7e7;">failing</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> getAccountServiceState(account).values()
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"  - </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;37m</span><span class="ef-ob">{account:</span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span class="ef-ob">18}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m "</span><span class="ef-ob">, end</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">, flush</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">True</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">if</span> <span style="color: #e45649; background-color: #e7e7e7;">not</span><span class="ef-ob"> enabled:
            </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;33mdisabled</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> active:
            </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;32mactive</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> failing:
            </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;31mfailing</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        </span><span style="color: #e45649; background-color: #e7e7e7;">else</span><span class="ef-ob">:
            </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;35min an unrecognised state</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)


</span><span style="color: #e45649; background-color: #e7e7e7;">if</span> <span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(sys.argv) </span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span><span class="ef-ob"> 1:
    </span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> sys.argv[1]   </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> [</span><span style="color: #50a14f; background-color: #e7e7e7;">"-e"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--enable"</span><span class="ef-ob">]:
        enableAccountSystemdServices(oldAccounts)
        </span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob">()
    </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> sys.argv[1] </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> [</span><span style="color: #50a14f; background-color: #e7e7e7;">"-d"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--disable"</span><span class="ef-ob">]:
        disableAccountSystemdServices(oldAccounts)
        </span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob">()
    </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> sys.argv[1] </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> [</span><span style="color: #50a14f; background-color: #e7e7e7;">"-r"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--restart"</span><span class="ef-ob">]:
        restartAccountSystemdServices(oldAccounts)
        </span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob">()
    </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> sys.argv[1] </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> [</span><span style="color: #50a14f; background-color: #e7e7e7;">"-s"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--status"</span><span class="ef-ob">]:
        getAccountServiceStates(oldAccounts)
        </span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob">()
    </span><span style="color: #e45649; background-color: #e7e7e7;">elif</span><span class="ef-ob"> sys.argv[1] </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> [</span><span style="color: #50a14f; background-color: #e7e7e7;">"-h"</span><span class="ef-ob">, </span><span style="color: #50a14f; background-color: #e7e7e7;">"--help"</span><span class="ef-ob">]:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"""</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;37mMbsync to IMAP Notify config generator.</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m

Usage: mbsync-imapnotify [options]

Options:
    -e, --enable       enable all services
    -d, --disable      disable all services
    -r, --restart      restart all services
    -s, --status       fetch the status for all services
    -h, --help         show this help
"""</span><span class="ef-ob">, end</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #50a14f; background-color: #e7e7e7;">''</span><span class="ef-ob">)
        </span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob">()
    </span><span style="color: #e45649; background-color: #e7e7e7;">else</span><span class="ef-ob">:
        </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;31mFlag </span><span class="ef-ob">{sys.argv[1]}</span><span style="color: #50a14f; background-color: #e7e7e7;"> not recognised, try --help</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)
        </span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob">()


</span><span style="color: #6a1868; background-color: #e7e7e7;">mbsyncData</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span> <span style="color: #a626a4; background-color: #e7e7e7;">open</span><span class="ef-ob">(mbsyncFile, </span><span style="color: #50a14f; background-color: #e7e7e7;">"r"</span><span class="ef-ob">).read()

</span><span style="color: #6a1868; background-color: #e7e7e7;">currentAccountNumber</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span><span class="ef-ob"> 0

</span><span style="color: #6a1868; background-color: #e7e7e7;">totalAccounts</span> <span style="color: #84888b; background-color: #e7e7e7;">=</span> <span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(re.findall(r</span><span style="color: #50a14f; background-color: #e7e7e7;">"^IMAPAccount"</span><span class="ef-ob">, mbsyncData, re.M))


</span><span style="color: #e45649; background-color: #e7e7e7;">def</span> <span style="color: #a626a4; background-color: #e7e7e7;">main</span><span class="ef-ob">():
    </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;34m:: MbSync to Go IMAP notify config file creator ::</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)

    shutil.rmtree(imapnotifyConfigFolder)
    imapnotifyConfigFolder.mkdir(exist_ok</span><span style="color: #84888b; background-color: #e7e7e7;">=</span><span style="color: #b751b6; background-color: #e7e7e7;">False</span><span class="ef-ob">)
    </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;30mImap Notify config dir purged</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)

    </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(f</span><span style="color: #50a14f; background-color: #e7e7e7;">"Identified </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;32m</span><span class="ef-ob">{totalAccounts}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;32m accounts.</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m"</span><span class="ef-ob">)

    </span><span style="color: #e45649; background-color: #e7e7e7;">for</span><span class="ef-ob"> line </span><span style="color: #e45649; background-color: #e7e7e7;">in</span><span class="ef-ob"> mbsyncData.split(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\n</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">):
        processLine(line)

    finaliseAccount()

    </span><span style="color: #a626a4; background-color: #e7e7e7;">print</span><span class="ef-ob">(
        f</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #b751b6; background-color: #e7e7e7;">\n</span><span style="color: #50a14f; background-color: #e7e7e7;">Config files generated for </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;36m</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">len</span><span class="ef-ob">(successfulAdditions)}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;36m"</span>
        <span style="color: #84888b; background-color: #e7e7e7;">+</span><span class="ef-ob"> f</span><span style="color: #50a14f; background-color: #e7e7e7;">" out of </span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[1;36m</span><span class="ef-ob">{totalAccounts}</span><span style="color: #b751b6; background-color: #e7e7e7;">\033</span><span style="color: #50a14f; background-color: #e7e7e7;">[0;37m accounts.</span><span style="color: #b751b6; background-color: #e7e7e7;">\n</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">
    )

    processSystemdServices()


</span><span style="color: #e45649; background-color: #e7e7e7;">if</span> <span style="color: #a626a4; background-color: #e7e7e7;">__name__</span> <span style="color: #84888b; background-color: #e7e7e7;">==</span> <span style="color: #50a14f; background-color: #e7e7e7;">"__main__"</span><span class="ef-ob">:
    main()
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Systemd</span>

We then have a service file to run <span style="color: #84888b;">~goimapnotify~</span> on all of these generated config files.
We'll use a template service file so we can enable a unit per-account.
<span class="ef-obb">#+begin_src systemd :tangle ~/.config/systemd/user/goimapnotify@.service
</span><span style="color: #986801; background-color: #e7e7e7;">[Unit]</span>
<span style="color: #e45649; background-color: #e7e7e7;">Description</span><span class="ef-ob">=IMAP notifier using IDLE, golang version.
</span><span style="color: #e45649; background-color: #e7e7e7;">ConditionPathExists</span><span class="ef-ob">=</span><span style="color: #b751b6; background-color: #e7e7e7;">%h</span><span class="ef-ob">/.config/imapnotify/</span><span style="color: #b751b6; background-color: #e7e7e7;">%I</span><span class="ef-ob">/notify.conf
</span><span style="color: #e45649; background-color: #e7e7e7;">After</span><span class="ef-ob">=network.target
</span><span style="color: #e45649; background-color: #e7e7e7;">Wants</span><span class="ef-ob">=gpg-agent.service

</span><span style="color: #986801; background-color: #e7e7e7;">[Service]</span>
<span style="color: #e45649; background-color: #e7e7e7;">ExecStart</span><span class="ef-ob">=</span><span style="color: #b751b6; background-color: #e7e7e7;">%h</span><span class="ef-ob">/.local/bin/goimapnotify -conf </span><span style="color: #b751b6; background-color: #e7e7e7;">%h</span><span class="ef-ob">/.config/imapnotify/</span><span style="color: #b751b6; background-color: #e7e7e7;">%I</span><span class="ef-ob">/notify.conf
</span><span style="color: #e45649; background-color: #e7e7e7;">Restart</span><span class="ef-ob">=</span><span style="color: #a626a4; background-color: #e7e7e7;">always</span>
<span style="color: #e45649; background-color: #e7e7e7;">RestartSec</span><span class="ef-ob">=30

</span><span style="color: #986801; background-color: #e7e7e7;">[Install]</span>
<span style="color: #e45649; background-color: #e7e7e7;">WantedBy</span><span class="ef-ob">=default.target
</span><span class="ef-obe">#+end_src
</span>
Enabling the service is actually taken care of by that python script.

From one or two small tests, this can bring the delay down to as low as five
seconds, which I'm quite happy with.

This works well for fetching new mail, but we also want to propagate other
changes (e.g. marking mail as read), and make sure we're up to date at the
start, so for that I'll do the 'normal' thing and run <span style="color: #84888b;">~mbsync -all~</span> every so often
--- let's say five minutes.

We can accomplish this via a systemd timer, and service file.
<span class="ef-obb">#+begin_src systemd :tangle (if (executable-find "mbsync") "~/.config/systemd/user/mbsync.timer" "no")
</span><span style="color: #986801; background-color: #e7e7e7;">[Unit]</span>
<span style="color: #e45649; background-color: #e7e7e7;">Description</span><span class="ef-ob">=call mbsync on all accounts every 5 minutes
</span><span style="color: #e45649; background-color: #e7e7e7;">ConditionPathExists</span><span class="ef-ob">=</span><span style="color: #b751b6; background-color: #e7e7e7;">%h</span><span class="ef-ob">/.mbsyncrc

</span><span style="color: #986801; background-color: #e7e7e7;">[Timer]</span>
<span style="color: #e45649; background-color: #e7e7e7;">OnBootSec</span><span class="ef-ob">=5m
</span><span style="color: #e45649; background-color: #e7e7e7;">OnUnitInactiveSec</span><span class="ef-ob">=5m

</span><span style="color: #986801; background-color: #e7e7e7;">[Install]</span>
<span style="color: #e45649; background-color: #e7e7e7;">WantedBy</span><span class="ef-ob">=default.target
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src systemd :tangle (if (executable-find "mbsync") "~/.config/systemd/user/mbsync.service" "no")
</span><span style="color: #986801; background-color: #e7e7e7;">[Unit]</span>
<span style="color: #e45649; background-color: #e7e7e7;">Description</span><span class="ef-ob">=mbsync service, sync all mail
</span><span style="color: #e45649; background-color: #e7e7e7;">Documentation</span><span class="ef-ob">=man:mbsync(1)
</span><span style="color: #e45649; background-color: #e7e7e7;">ConditionPathExists</span><span class="ef-ob">=</span><span style="color: #b751b6; background-color: #e7e7e7;">%h</span><span class="ef-ob">/.mbsyncrc
</span><span style="color: #e45649; background-color: #e7e7e7;">Wants</span><span class="ef-ob">=gpg-agent.service

</span><span style="color: #986801; background-color: #e7e7e7;">[Service]</span>
<span style="color: #e45649; background-color: #e7e7e7;">Type</span><span class="ef-ob">=</span><span style="color: #a626a4; background-color: #e7e7e7;">oneshot</span>
<span style="color: #e45649; background-color: #e7e7e7;">ExecStart</span><span class="ef-ob">=/usr/bin/mbsync -c </span><span style="color: #b751b6; background-color: #e7e7e7;">%h</span><span class="ef-ob">/.mbsyncrc --all

</span><span style="color: #986801; background-color: #e7e7e7;">[Install]</span>
<span style="color: #e45649; background-color: #e7e7e7;">WantedBy</span><span class="ef-ob">=mail.target
</span><span class="ef-obe">#+end_src
</span>
Enabling (and starting) this is as simple as

<span class="ef-obb">#+begin_src shell :tangle (if (or (not (executable-find "mbsync")) (string= "enabled\n" (shell-command-to-string "systemctl --user is-enabled mbsync.timer"))) "no" "setup.sh")
</span><span class="ef-ob">systemctl --user enable mbsync.timer --now
</span><span class="ef-obe">#+end_src
</span>
We can also add a <span style="color: #84888b;">=doctor=</span> check for the timer state.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"mbsync"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (string= </span><span style="color: #50a14f; background-color: #e7e7e7;">"enabled\n"</span><span class="ef-ob"> (shell-command-to-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"systemctl --user is-enabled mbsync.timer"</span><span class="ef-ob">))
    (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"The mbsync timer is not enabled."</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Indexing/Searching</span>

This is performed by <span style="color: #4078f2; font-weight: 700;">[[https://www.djcbsoftware.nl/code/mu/][Mu]]</span>. This is a tool for finding emails stored in the <span style="color: #4078f2; font-weight: 700;">[[http://en.wikipedia.org/wiki/Maildir][Maildir]]</span> format.
According to the homepage, it's main features are
+ Fast indexing
+ Good searching
+ Support for encrypted and signed messages
+ Rich CLI tooling
+ accent/case normalisation
+ strong integration with email clients

Unfortunately <span style="color: #84888b;">~mu~</span> is not currently packaged from me. Oh well, I guess I'm
building it from source then. I needed to install these packages
+ <span style="color: #84888b;">=gmime-devel=</span>
+ <span style="color: #84888b;">=xapian-core-devel=</span>

<span style="color: #84888b;">#+name: Install mu from source</span>
<span class="ef-obb">#+begin_src shell :eval no :tangle (if (and (file-directory-p "~/.mail") (not (executable-find "mu"))) "setup.sh" "no")
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> ~/.local/lib/
git clone https://github.com/djcb/mu.git
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> ./mu
./autogen.sh
make
sudo make install
</span><span class="ef-obe">#+end_src
</span>
To check how my version compares to the latest published:

<span class="ef-obb">#+begin_src shell :tangle no
</span><span class="ef-ob">curl --silent </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://api.github.com/repos/djcb/mu/releases/latest"</span><span class="ef-ob"> | grep </span><span style="color: #50a14f; background-color: #e7e7e7;">'"tag_name":'</span><span class="ef-ob"> | sed -E </span><span style="color: #50a14f; background-color: #e7e7e7;">'s/.*"([^"]+)".*/\1/'</span><span class="ef-ob">
mu --version | head -n 1 | sed </span><span style="color: #50a14f; background-color: #e7e7e7;">'s/.* version //'</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+results:</span>
| 1.4.6 |
| 1.4.6 |

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Sending</span>

<span style="color: #4078f2; font-weight: 700;">[[https://www.nongnu.org/smtpmail/][SmtpMail]]</span> seems to be the 'default' starting point, but that's not packaged for
me. <span style="color: #4078f2; font-weight: 700;">[[https://marlam.de/msmtp/][msmtp]]</span> is however, so I'll give that a shot. Reading around a bit (googling
"msmtp vs sendmail" for example) almost every comparison mentioned seems to
suggest msmtp to be a better choice. I have seen the following points raised
+ <span style="color: #84888b;">~sendmail~</span> has several vulnerabilities
+ <span style="color: #84888b;">~sendmail~</span> is tedious to configure
+ <span style="color: #84888b;">~ssmtp~</span> is no longer maintained
+ <span style="color: #84888b;">~msmtp~</span> is a maintained alternative to <span style="color: #84888b;">~ssmtp~</span>
+ <span style="color: #84888b;">~msmtp~</span> is easier to configure

The config file is <span style="color: #4078f2; font-weight: 700;">[[file:~/.config/msmtp/config][~/.config/msmtp/config]]</span>.

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** System hackery</span>

Unfortunately, I seem to have run into a <span style="color: #4078f2; font-weight: 700;">[[https://bugs.archlinux.org/task/44994][bug]]</span> present in my packaged version, so
we'll just install the latest from source.

For full use of the <span style="color: #84888b;">~auth~</span> options, I need <span style="color: #84888b;">=GNU SASL=</span>, which isn't packaged for me.
I don't think I want it, but in case I do, I'll need to do this.
<span style="color: #84888b;">#+name: Install gsasl from source</span>
<span class="ef-obb">#+begin_src shell :eval no :tangle (if (and (executable-find "mu") (not (executable-find "msmtp"))) "setup.sh" "no")
</span><span style="color: #a626a4; background-color: #e7e7e7;">export</span> <span style="color: #6a1868; background-color: #e7e7e7;">GSASL_VERSION</span><span class="ef-ob">=1.8.1
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> ~/.local/lib/
curl </span><span style="color: #50a14f; background-color: #e7e7e7;">"ftp://ftp.gnu.org/gnu/gsasl/libgsasl-$GSASL_VERSION.tar.gz"</span><span class="ef-ob"> | tar xz
curl </span><span style="color: #50a14f; background-color: #e7e7e7;">"ftp://ftp.gnu.org/gnu/gsasl/gsasl-$GSASL_VERSION.tar.gz"</span><span class="ef-ob"> | tar xz
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span> <span style="color: #50a14f; background-color: #e7e7e7;">"./libgsasl-$GSASL_VERSION"</span><span class="ef-ob">
./configure
make
sudo make install
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> ..
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span> <span style="color: #50a14f; background-color: #e7e7e7;">"./gsasl-$VERSION"</span><span class="ef-ob">
./configure
make
sudo make install
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> ..
</span><span class="ef-obe">#+end_src
</span>
Now actually compile <span style="color: #84888b;">~msmtp~</span>.
<span style="color: #84888b;">#+name: Install msmtp from source</span>
<span class="ef-obb">#+begin_src shell :eval no :tangle (if (and (executable-find "mu") (not (executable-find "msmtp"))) "setup.sh" "no")
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> ~/.local/lib/
git clone https://github.com/marlam/msmtp-mirror.git ./msmtp
</span><span style="color: #a626a4; background-color: #e7e7e7;">cd</span><span class="ef-ob"> ./msmtp
libtoolize --force
aclocal
autoheader
automake --force-missing --add-missing
autoconf
</span><span style="color: #84888b; background-color: #e7e7e7;"># </span><span style="color: #84888b; background-color: #e7e7e7;">if using GSASL
</span><span style="color: #84888b; background-color: #e7e7e7;"># </span><span style="color: #84888b; background-color: #e7e7e7;">PKG_CONFIG_PATH=/usr/local/lib/pkgconfig ./configure --with-libgsasl
</span><span class="ef-ob">./configure
make
sudo make install
</span><span class="ef-obe">#+end_src
</span>
If using <span style="color: #84888b;">=GSASL=</span> (from earlier) we need to make ensure that the dynamic library in
in the library path. We can do by adding an executable with the same name
earlier on in my <span style="color: #84888b;">~$PATH~</span>.
<span class="ef-obb">#+begin_src sh :tangle no :shebang "#!/bin/sh"
</span><span style="color: #6a1868; background-color: #e7e7e7;">LD_LIBRARY_PATH</span><span class="ef-ob">=/usr/local/lib exec /usr/local/bin/msmtp </span><span style="color: #50a14f; background-color: #e7e7e7;">"$@"</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Mu4e</span>

Webmail clients are nice and all, but I still don't believe that SPAs in my
browser can replaced desktop apps ... sorry Gmail. I'm also liking google less
and less.

Mailspring is a decent desktop client, quite lightweight for electron
(apparently the backend is in <span style="color: #84888b;">=C=</span>, which probably helps), however I miss Emacs
stuff.

While <span style="color: #84888b;">=Notmuch=</span> seems very promising, and I've heard good things about it, it
doesn't seem to make any changes to the emails themselves. All data is stored in
Notmuch's database. While this is a very interesting model, occasionally I need
to pull up an email on say my phone, and so not I want the tagging/folders etc.
to be applied to the mail itself --- not stored in a database.

On the other hand <span style="color: #84888b;">=Mu4e=</span> is also talked about a lot in positive terms, and seems
to possess a similarly strong feature set --- and modifies the mail itself (I.e.
information is accessible without the database). <span style="color: #84888b;">=Mu4e=</span> also seems to have a large
user base, which tends to correlate with better support and attention.

If I install mu4e from source, I need to add the <span style="color: #84888b;">=/usr/local/=</span> loadpath so Mu4e
has a chance of loading. Alternatively, I may need to add the <span style="color: #84888b;">=/usr/share/=</span> path.

<span style="color: #84888b;">#+name: add-mu4e-load-path</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
 ((cl-some (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (path) (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"mu4e"</span><span class="ef-ob"> path)) load-path) nil)
 ((file-directory-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"/usr/local/share/emacs/site-lisp/mu4e"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">quote</span><span class="ef-ob"> (add-to-list 'load-path </span><span style="color: #50a14f; background-color: #e7e7e7;">"/usr/local/share/emacs/site-lisp/mu4e"</span><span class="ef-ob">)))
 ((file-directory-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"/usr/share/emacs/site-lisp/mu4e"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">quote</span><span class="ef-ob"> (add-to-list 'load-path </span><span style="color: #50a14f; background-color: #e7e7e7;">"/usr/share/emacs/site-lisp/mu4e"</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
Let's also just shove all the Elisp code here in an <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> ...)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> block.
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">&lt;&lt;mu4e-conf&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Viewing Mail</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :noweb-ref mu4e-conf
<span style="font-weight: 700;">:END:</span>

There seem to be some advantages with using Gnus' article view (such as inline
images), and judging from <span style="color: #4078f2; font-weight: 700;">[[https://github.com/djcb/mu/pull/1442#issuecomment-591695814][djcb/mu!1442 (comment)]]</span> this seems to be the 'way of
the future' for mu4e.

There are some nerd-icons font related issues, so we need to redefine the
fancy chars, and make sure they get the correct width.

To account for the increase width of each flag character, and make perform a
few more visual tweaks, we'll tweak the headers a bit
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-headers-fields
      '((</span><span style="color: #a626a4; background-color: #e7e7e7;">:flags</span><span class="ef-ob"> . 6)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:account-stripe</span><span class="ef-ob"> . 2)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:from-or-to</span><span class="ef-ob"> . 25)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:folder</span><span class="ef-ob"> . 10)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:recipnum</span><span class="ef-ob"> . 2)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:subject</span><span class="ef-ob"> . 80)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:human-date</span><span class="ef-ob"> . 8))
      +mu4e-min-header-frame-width 142
      mu4e-headers-date-format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%d/%m/%y"</span><span class="ef-ob">
      mu4e-headers-time-format </span><span style="color: #50a14f; background-color: #e7e7e7;">"⧖ %H:%M"</span><span class="ef-ob">
      mu4e-headers-results-limit 1000
      mu4e-index-cleanup t)

(add-to-list 'mu4e-bookmarks
             '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Yesterday's messages"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:query</span> <span style="color: #50a14f; background-color: #e7e7e7;">"date:2d..1d"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob"> ?y) t)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+mu4e-header--folder-colors</span><span class="ef-ob"> nil)
(</span><span style="color: #e45649; background-color: #e7e7e7;">appendq!</span><span class="ef-ob"> mu4e-header-info-custom
          '((</span><span style="color: #a626a4; background-color: #e7e7e7;">:folder</span><span class="ef-ob"> .
             (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Folder"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:shortname</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Folder"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:help</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Lowest level folder"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:function</span><span class="ef-ob">
              (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (msg)
                (+mu4e-colorize-str
                 (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`.*/"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> (mu4e-message-field msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:maildir</span><span class="ef-ob">))
                 '+mu4e-header--folder-colors))))))
</span><span class="ef-obe">#+end_src
</span>
Among the flags mu4e displays is the "personal address" flag, for messages sent
<span style="text-decoration: italic;">/to/</span> me (as opposed to mailing-list-y emails where I am not an explicit
recipient). Unfortunately, this doesn't play well with my wildcard email
addresses, so let's fix this with advise.

<span class="ef-obb"> #+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +mu4e-personal-address-p--*-a (orig-fn addr)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'mu4e-personal-address-p
  (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (stringp addr)
           (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"@</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[a-z]+\\.</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?tecosaur\\.net$"</span><span class="ef-ob"> addr))
      (funcall orig-fn addr)))
</span><span class="ef-obe"> #+end_src
</span>
We'll also use a nicer alert icon
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-alert-icon </span><span style="color: #50a14f; background-color: #e7e7e7;">"/usr/share/icons/Papirus/64x64/apps/evolution.svg"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
And save ourselves from the awful <span style="color: #84888b;">=mu4e-thread-fold-face=</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(custom-set-faces!
  '(mu4e-thread-fold-face </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> default))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Sending Mail</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :noweb-ref mu4e-conf
<span style="font-weight: 700;">:END:</span>

Let's send emails too.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> sendmail-program </span><span style="color: #50a14f; background-color: #e7e7e7;">"/usr/bin/msmtp"</span><span class="ef-ob">
      send-mail-function #'smtpmail-send-it
      message-sendmail-f-is-evil t
      message-sendmail-extra-arguments '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"--read-envelope-from"</span><span class="ef-ob">)</span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">, "--read-recipients")
</span><span class="ef-ob">      message-send-mail-function #'message-send-mail-with-sendmail)
</span><span class="ef-obe">#+end_src
</span>
It's also nice to avoid accidentally sending emails with the wrong account. If
we can send from the address in the <span style="color: #84888b;">~To~</span> field, let's do that. Opening a prompt
otherwise also seems sensible.

We can register Emacs as a potential email client with a desktop file. We could
put an <span style="color: #84888b;">=emacsclient ...=</span> entry in the <span style="color: #84888b;">=Exec=</span> field, but I've found this a bit dodgy.
Instead let's package the <span style="color: #84888b;">=emacslient=</span> behaviour in a little executable
<span style="color: #84888b;">=~/.local/bin/emacsmail=</span>.

<span class="ef-obb">#+begin_src shell :tangle ~/.local/bin/emacsmail :shebang "#!/usr/bin/env sh" :mkdirp yes :tangle-mode (identity #o755) :comments no
</span><span class="ef-ob">emacsclient -create-frame --alternate-editor=</span><span style="color: #50a14f; background-color: #e7e7e7;">''</span><span class="ef-ob"> --no-wait --eval </span><span style="color: #50a14f; background-color: #e7e7e7;">\</span>
<span style="color: #50a14f; background-color: #e7e7e7;">"(progn (x-focus-frame nil) (mu4e-compose-from-mailto \"$1\" t))"</span>
<span class="ef-obe">#+end_src
</span>
Now we can just call that in a desktop file.

<span class="ef-obb">#+begin_src conf :tangle ~/.local/share/applications/emacsmail.desktop :mkdirp yes
</span><span class="ef-ob">[</span><span style="color: #986801; background-color: #e7e7e7;">Desktop Entry</span><span class="ef-ob">]
</span><span style="color: #6a1868; background-color: #e7e7e7;">Name</span><span class="ef-ob">=Mu4e
</span><span style="color: #6a1868; background-color: #e7e7e7;">GenericName</span><span class="ef-ob">=Compose a new message with Mu4e in Emacs
</span><span style="color: #6a1868; background-color: #e7e7e7;">Comment</span><span class="ef-ob">=Open mu4e compose window
</span><span style="color: #6a1868; background-color: #e7e7e7;">MimeType</span><span class="ef-ob">=x-scheme-handler/mailto;
</span><span style="color: #6a1868; background-color: #e7e7e7;">Exec</span><span class="ef-ob">=emacsmail %u
</span><span style="color: #6a1868; background-color: #e7e7e7;">Icon</span><span class="ef-ob">=emacs
</span><span style="color: #6a1868; background-color: #e7e7e7;">Type</span><span class="ef-ob">=Application
</span><span style="color: #6a1868; background-color: #e7e7e7;">Terminal</span><span class="ef-ob">=false
</span><span style="color: #6a1868; background-color: #e7e7e7;">Categories</span><span class="ef-ob">=Network;Email;
</span><span style="color: #6a1868; background-color: #e7e7e7;">StartupWMClass</span><span class="ef-ob">=Emacs
</span><span class="ef-obe">#+end_src
</span>
To register this, just call

<span class="ef-obb">#+begin_src shell :tangle (if (or (not (executable-find "mu")) (string= (shell-command-to-string "xdg-mime query default x-scheme-handler/mailto") "emacsmail.desktop\n")) "no" "setup.sh")
</span><span class="ef-ob">update-desktop-database ~/.local/share/applications
</span><span class="ef-obe">#+end_src
</span>
We can see if this is necessary with a <span style="color: #84888b;">=doctor=</span> check.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"mu"</span><span class="ef-ob">)
           (not (string= (shell-command-to-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"xdg-mime query default x-scheme-handler/mailto"</span><span class="ef-ob">)
                         </span><span style="color: #50a14f; background-color: #e7e7e7;">"emacsmail.desktop\n"</span><span class="ef-ob">)))
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emacs is not registered as a mailto handler."</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
We also want to define <span style="color: #84888b;">~mu4e-compose-from-mailto~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">mu4e-compose-from-mailto</span><span class="ef-ob"> (mailto-string </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> quit-frame-after)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">mu4e</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> mu4e--server-props (mu4e t) (sleep-for 0.1))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((mailto (message-parse-mailto-url mailto-string))
         (to (cadr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"to"</span><span class="ef-ob"> mailto)))
         (subject (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cadr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"subject"</span><span class="ef-ob"> mailto)) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
         (body (cadr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"body"</span><span class="ef-ob"> mailto)))
         (headers (-filter (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (spec) (not (-contains-p '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"to"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"subject"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"body"</span><span class="ef-ob">) (car spec)))) mailto)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((mu4e-main (get-buffer mu4e-main-buffer-name)))
      (switch-to-buffer mu4e-main))
    (mu4e~compose-mail to subject headers)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> body
      (goto-char (point-min))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq major-mode 'org-msg-edit-mode)
          (org-msg-goto-body)
        (mu4e-compose-goto-bottom))
      (insert body))
    (goto-char (point-min))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((null to) (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"To: "</span><span class="ef-ob">))
          ((string= </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> subject) (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"Subject: "</span><span class="ef-ob">))
          (t (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq major-mode 'org-msg-edit-mode)
                 (org-msg-goto-body)
               (mu4e-compose-goto-bottom))))
    (font-lock-ensure)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> evil-normal-state-minor-mode
      (evil-append 1))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> quit-frame-after
      (add-hook 'kill-buffer-hook
                `(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> ()
                   (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq (selected-frame) ,(selected-frame))
                     (delete-frame)))))))
</span><span class="ef-obe">#+end_src
</span>
It would also be nice to change the name pre-filled in <span style="color: #84888b;">=From:=</span> when drafting.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">mu4e-from-name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Timothy"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Name used in \"From:\" template."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> mu4e~draft-from-construct-renamed (orig-fn)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Wrap `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">mu4e~draft-from-construct-renamed</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' to change the name."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'mu4e~draft-from-construct
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((user-full-name mu4e-from-name))
    (funcall orig-fn)))
</span><span class="ef-obe">#+end_src
</span>
We can also use this a signature,
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> message-signature mu4e-from-name)
</span><span class="ef-obe">#+end_src
</span>
I've got a few extra addresses I'd like <span style="color: #84888b;">~+mu4e-set-from-address-h~</span> to be aware of.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-update-personal-addresses</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((primary-address
         (car (cl-remove-if-not
               (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (a) (eq (mod (apply #'* (cl-coerce a 'list)) 600) 0))
               (mu4e-personal-addresses)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +mu4e-personal-addresses
          (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> primary-address
               (append (mu4e-personal-addresses)
                       (mapcar
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (subalias)
                          (concat subalias </span><span style="color: #50a14f; background-color: #e7e7e7;">"@"</span><span class="ef-ob">
                                  (subst-char-in-string ?@ ?. primary-address)))
                        '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"orgmode"</span><span class="ef-ob">))
                       (mapcar
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (alias)
                          (replace-regexp-in-string
                           </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.*</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">@"</span><span class="ef-ob"> alias primary-address t t 1))
                        '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"contact"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"timothy"</span><span class="ef-ob">)))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">add-transient-hook!</span><span class="ef-ob"> 'mu4e-compose-pre-hook
  (+mu4e-update-personal-addresses))
</span><span class="ef-obe">#+end_src
</span>
We also want to use any <span style="color: #84888b;">=@tecosaur.net=</span> address as an automatic from address.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +mu4e-set-from-adress-h-personal-a (orig-fn)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'+mu4e-set-from-address-h
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((msg-addrs
          (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> mu4e-compose-parent-message
               (delq nil
                     (mapcar
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (adr) (plist-get adr </span><span style="color: #a626a4; background-color: #e7e7e7;">:email</span><span class="ef-ob">))
                      (append (mu4e-message-field mu4e-compose-parent-message </span><span style="color: #a626a4; background-color: #e7e7e7;">:to</span><span class="ef-ob">)
                              (mu4e-message-field mu4e-compose-parent-message </span><span style="color: #a626a4; background-color: #e7e7e7;">:cc</span><span class="ef-ob">)
                              (mu4e-message-field mu4e-compose-parent-message </span><span style="color: #a626a4; background-color: #e7e7e7;">:from</span><span class="ef-ob">))))))
         (personal-addrs
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> mu4e-contexts +mu4e-personal-addresses)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (&gt; (length +mu4e-personal-addresses) 1)
                   +mu4e-personal-addresses)
            (mu4e-personal-addresses)))
         (personal-domain-addr
          (cl-some
           (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (email)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"@</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">tec\\.</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?tecosaur\\.net&gt;?$"</span><span class="ef-ob">
                                  email)
                  email))
           msg-addrs)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> personal-domain-addr
             (not (cl-intersection msg-addrs personal-addrs </span><span style="color: #a626a4; background-color: #e7e7e7;">:test</span><span class="ef-ob"> #'equal)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> user-mail-address personal-domain-addr)
      (funcall orig-fn))))
</span><span class="ef-obe">#+end_src
</span>
Speaking of, it would be good to put emails sent from <span style="color: #84888b;">=@tecosaur.net=</span> in the
account-specific sent directory, not the catch-all.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-account-sent-folder</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> msg)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((from (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> msg
                  (plist-get (car (plist-get msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:from</span><span class="ef-ob">)) </span><span style="color: #a626a4; background-color: #e7e7e7;">:email</span><span class="ef-ob">)
                (</span><span style="color: #e45649; background-color: #e7e7e7;">save-restriction</span><span class="ef-ob">
                  (mail-narrow-to-head)
                  (mail-fetch-field </span><span style="color: #50a14f; background-color: #e7e7e7;">"from"</span><span class="ef-ob">)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> from (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"@tecosaur\\.net&gt;?\\'"</span><span class="ef-ob"> from))
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"/tecosaur-net/Sent"</span>
      <span style="color: #50a14f; background-color: #e7e7e7;">"/sent"</span><span class="ef-ob">)))
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-sent-folder #'+mu4e-account-sent-folder)
</span><span class="ef-obe">#+end_src
</span>
When composing an email, I think it would make more sense to start off in <span style="color: #84888b;">=insert=</span>
mode than <span style="color: #84888b;">=normal=</span> mode, which can be accomplished via a compose hook.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-evil-enter-insert-mode</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> evil-state) 'normal)
    (call-interactively #'evil-append)))

(add-hook 'mu4e-compose-mode-hook #'+mu4e-evil-enter-insert-mode 90)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Working with the Org mailing list</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:emacs-lisp:</span> :noweb-ref mu4e-conf
<span style="font-weight: 700;">:END:</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Adding </span><span style="color: #84888b; font-weight: 600; font-size: 1.06em">=X-Woof=</span><span style="color: #bc5cba; font-weight: 600; font-size: 1.06em"> headers</span>

I'm fairly active on the Org mailing list (ML). The Org ML has a linked
bug/patch tracker, <span style="color: #4078f2; font-weight: 700;">https://updates.orgmode.org/</span> managed by <span style="color: #4078f2; font-weight: 700;">[[https://github.com/bzg/woof][Woof]]</span>. However, I feel
like I spend too much time looking up what the appropriate headers are for
updating the status of bugs and patches. What I need, is some sort of convenient
tool. Let's write one.

First, a function that asks what I want to do and returns the appropriate <span style="color: #84888b;">=X-Woof=</span>
header.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-get-woof-header</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (read-char
          (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\
%s
  %s Declare %s Applied %s Aborted
%s
  %s Confirm %s Fixed
%s
  %s Request %s Resolved

%s remove X-Woof header"</span><span class="ef-ob">
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Patch"</span><span class="ef-ob"> 'face 'outline-3)
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"p"</span><span class="ef-ob"> 'face '(bold consult-key))
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"a"</span><span class="ef-ob"> 'face '(bold consult-key))
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"c"</span><span class="ef-ob"> 'face '(bold consult-key))
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Bug"</span><span class="ef-ob"> 'face 'outline-3)
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"b"</span><span class="ef-ob"> 'face '(bold consult-key))
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"f"</span><span class="ef-ob"> 'face '(bold consult-key))
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Help"</span><span class="ef-ob"> 'face 'outline-3)
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"h"</span><span class="ef-ob"> 'face '(bold consult-key))
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"r"</span><span class="ef-ob"> 'face '(bold consult-key))
                  (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"x"</span><span class="ef-ob"> 'face '(bold error))))
    (?p </span><span style="color: #50a14f; background-color: #e7e7e7;">"X-Woof-Patch: confirmed"</span><span class="ef-ob">)
    (?a </span><span style="color: #50a14f; background-color: #e7e7e7;">"X-Woof-Patch: applied"</span><span class="ef-ob">)
    (?c </span><span style="color: #50a14f; background-color: #e7e7e7;">"X-Woof-Patch: cancelled"</span><span class="ef-ob">)
    (?b </span><span style="color: #50a14f; background-color: #e7e7e7;">"X-Woof-Bug: confirmed"</span><span class="ef-ob">)
    (?f </span><span style="color: #50a14f; background-color: #e7e7e7;">"X-Woof-Bug: fixed"</span><span class="ef-ob">)
    (?h </span><span style="color: #50a14f; background-color: #e7e7e7;">"X-Woof-Help: confirmed"</span><span class="ef-ob">)
    (?r </span><span style="color: #50a14f; background-color: #e7e7e7;">"X-Woof-Help: cancelled"</span><span class="ef-ob">)
    (?x 'delete)))
</span><span class="ef-obe">#+end_src
</span>
Now we just need a function which will add such a header to a buffer
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-insert-woof-header</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Insert an X-Woof header into the current message."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((header (+mu4e-get-woof-header)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
      (goto-char (point-min))
      (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"--text follows this line--"</span><span class="ef-ob">)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (eq header 'delete)
        (beginning-of-line)
        (insert header </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
        (forward-line -1))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-backward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^X-Woof-"</span><span class="ef-ob"> nil t)
        (kill-whole-line)))))

(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> mu4e-compose-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Insert X-Woof Header"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"w"</span><span class="ef-ob"> #'+mu4e-insert-woof-header)

(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-msg-edit-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org-msg
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Insert X-Woof Header"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"w"</span><span class="ef-ob"> #'+mu4e-insert-woof-header)
</span><span class="ef-obe">#+end_src
</span>
Lovely! That should make adding these headers a breeze.

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Patch workflow</span>

Testing patches from the ML is currently more hassle than it needs to be. Let's
change that.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> mu4e
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-ml-target-dir</span><span class="ef-ob">
    (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org/"</span><span class="ef-ob"> doom-user-dir))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-ml-max-age</span><span class="ef-ob"> 600
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Maximum permissible age in seconds."</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-ml--cache-timestamp</span><span class="ef-ob"> 0)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-ml--cache</span><span class="ef-ob"> nil)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">define-minor-mode</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-ml-patchy-mood-mode</span>
    <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Apply patches to Org in bulk."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:global</span><span class="ef-ob"> t
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((action (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"apply patch to org"</span><span class="ef-ob"> #'+org-ml-apply-patch)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> +org-ml-patchy-mood-mode
          (add-to-list 'mu4e-view-actions action)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-view-actions (delete action mu4e-view-actions)))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-ml-apply-patch</span><span class="ef-ob"> (msg)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Apply the patch in the current message to Org."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> msg (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> msg (mu4e-message-at-point)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> (get-buffer-create </span><span style="color: #50a14f; background-color: #e7e7e7;">"*Shell: Org apply patches*"</span><span class="ef-ob">)
      (erase-buffer)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((default-directory +org-ml-target-dir)
             (exit-code (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"git"</span><span class="ef-ob"> nil t nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"am"</span><span class="ef-ob"> (mu4e-message-field msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:path</span><span class="ef-ob">))))
        (magit-refresh)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (not (= 0 exit-code))
          (+popup/buffer)))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-ml-current-patches</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Get the currently open patches, as a list of alists.
Entries of the form (subject . id)."</span><span class="ef-ob">
    (delq nil
          (mapcar
           (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (entry)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (plist-get entry </span><span style="color: #a626a4; background-color: #e7e7e7;">:fixed</span><span class="ef-ob">)
               (cons
                (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%-8s  %s"</span><span class="ef-ob">
                        (propertize
                         (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"T.*"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">
                                                   (plist-get entry </span><span style="color: #a626a4; background-color: #e7e7e7;">:date</span><span class="ef-ob">))
                         'face 'font-lock-doc-face)
                        (propertize
                         (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\[</span><span style="color: #b751b6; background-color: #e7e7e7;">PATCH\\</span><span style="color: #50a14f; background-color: #e7e7e7;">] ?"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">
                                                   (plist-get entry </span><span style="color: #a626a4; background-color: #e7e7e7;">:summary</span><span class="ef-ob">))
                         'face 'font-lock-keyword-face))
                (plist-get entry </span><span style="color: #a626a4; background-color: #e7e7e7;">:id</span><span class="ef-ob">))))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> (url-retrieve-synchronously </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://updates.orgmode.org/data/patches"</span><span class="ef-ob">)
             (goto-char url-http-end-of-headers)
             (json-parse-buffer </span><span style="color: #a626a4; background-color: #e7e7e7;">:object-type</span><span class="ef-ob"> 'plist)))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-ml-select-patch-thread</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Find and apply a proposed Org patch."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((current-workspace (+workspace-current))
           (patches (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not +org-ml--cache)
                                (&gt; (- (float-time) +org-ml--cache-timestamp)
                                   +org-ml-max-age))
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +org-ml--cache (+org-ml-current-patches)
                              +org-ml--cache-timestamp (float-time)))
                      +org-ml--cache))
           (msg-id (cdr (assoc (completing-read
                                </span><span style="color: #50a14f; background-color: #e7e7e7;">"Thread: "</span><span class="ef-ob"> (mapcar #'car patches))
                               patches))))
      (+workspace-switch +mu4e-workspace-name)
      (mu4e-view-message-with-message-id msg-id)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> +org-ml-patchy-mood-mode
        (add-to-list 'mu4e-view-actions
                     (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"apply patch to org"</span><span class="ef-ob"> #'+org-ml-transient-mu4e-action)))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-ml-transient-mu4e-action</span><span class="ef-ob"> (msg)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> mu4e-view-actions
          (delete (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"apply patch to org"</span><span class="ef-ob"> #'+org-ml-transient-mu4e-action)
                  mu4e-view-actions))
    (+workspace/other)
    (magit-status +org-ml-target-dir)
    (+org-ml-apply-patch msg)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Mail list archive links</span>

The other thing which it's good to be easily able to do is grab a link to the
current message on <span style="color: #4078f2; font-weight: 700;">https://list.orgmode.org</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> mu4e
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-ml-message-link</span><span class="ef-ob"> (msg)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Copy the link to MSG on the mailing list archives."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((list-addr (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (mu4e-message-field msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:list</span><span class="ef-ob">)
                          (</span><span style="color: #e45649; background-color: #e7e7e7;">thread-last</span><span class="ef-ob"> (append (mu4e-message-field-raw msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:list-post</span><span class="ef-ob">)
                                               (mu4e-message-field msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:to</span><span class="ef-ob">)
                                               (mu4e-message-field msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:cc</span><span class="ef-ob">))
                                       (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (e) (plist-get e </span><span style="color: #a626a4; background-color: #e7e7e7;">:email</span><span class="ef-ob">)))
                                       (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (addr)
                                                 (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"emacs.*@gnu\\.org$"</span><span class="ef-ob"> addr)
                                                   (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"@"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob"> addr))))
                                       (delq nil)
                                       (car))))
           (msg-url
            (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> list-addr
              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"emacs-orgmode.gnu.org"</span><span class="ef-ob">
               (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://list.orgmode.org/%s"</span><span class="ef-ob"> (mu4e-message-field msg </span><span style="color: #a626a4; background-color: #e7e7e7;">:message-id</span><span class="ef-ob">)))
              (_ (</span><span style="color: #986801; background-color: #e7e7e7;">user-error</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Mailing list %s not supported"</span><span class="ef-ob"> list-addr)))))
      (gui-select-text msg-url)
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Link %s copied to clipboard"</span><span class="ef-ob">
               (propertize msg-url 'face '((</span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> normal </span><span style="color: #a626a4; background-color: #e7e7e7;">:underline</span><span class="ef-ob"> nil) link)))
      msg-url))

  (add-to-list 'mu4e-view-actions (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"link to message ML"</span><span class="ef-ob"> #'+mu4e-ml-message-link) t))
</span><span class="ef-obe">#+end_src
</span>
In a similar manner, when clicking on such a link (say when someone uses a link
to the archive to refer to an earlier email) I'd much rather look at it in mu4e.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+browse-url-orgmode-ml</span><span class="ef-ob"> (url </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> _)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Open an orgmode list url using notmuch."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((id (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (string-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"^https?://orgmode\\.org/list/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> url)
                     (string-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"^https?://list\\.orgmode\\.org/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> url))
                 (match-string 1 url))))
    (mu4e-view-message-with-message-id id)))

(add-to-list 'browse-url-handlers (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"^https?://orgmode\\.org/list"</span><span class="ef-ob"> #'+browse-url-orgmode-ml))
(add-to-list 'browse-url-handlers (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"^https?://list\\.orgmode\\.org/"</span><span class="ef-ob"> #'+browse-url-orgmode-ml))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Setup when composing a new email</span>

Thanks to having a dedicated address for my interactions with the Org ML, and
Doom's <span style="color: #84888b;">~+mu4e-set-from-address-h~</span>, we can tell at the end of compose setup whether
I'm composing an email to the Org ML and then do a little setup for convenience,
namely:
+ Pre-fill the <span style="color: #84888b;">=To=</span> address
+ Ensure that <span style="color: #84888b;">=org-msg=</span> is set up to send plaintext only
+ Set <span style="color: #84888b;">~default-directory~</span> to my local Org repository (where patch files are
  generated)
+ Move <span style="color: #84888b;">~(point)~</span> to the <span style="color: #84888b;">=Subject:=</span> line
+ Use a special Org-ML-specific signature

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-compose-org-ml-setup</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`orgmode@"</span><span class="ef-ob"> user-mail-address)
    (goto-char (point-min))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">save-restriction</span><span class="ef-ob">
      (mail-narrow-to-head)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-empty-p (mail-fetch-field </span><span style="color: #50a14f; background-color: #e7e7e7;">"to"</span><span class="ef-ob">))
        (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^To: .*$"</span><span class="ef-ob">)
        (replace-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"To: emacs-orgmode@gnu.org"</span><span class="ef-ob">)
        (advice-add 'message-goto-to </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'+mu4e-goto-subject-not-to-once)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> org-msg-mode
               (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^:alternatives: (</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">utf-8 html</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">)"</span><span class="ef-ob"> nil t))
      (replace-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"utf-8"</span><span class="ef-ob"> t t nil 1))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> org-msg-mode
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((final-elem (org-element-at-point (point-max))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (equal (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> final-elem) </span><span style="color: #50a14f; background-color: #e7e7e7;">"signature"</span><span class="ef-ob">)
            (goto-char (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:contents-begin</span><span class="ef-ob"> final-elem))
            (delete-region (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:contents-begin</span><span class="ef-ob"> final-elem)
                           (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:contents-end</span><span class="ef-ob"> final-elem))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> org-msg-signature
                        (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n#+begin_signature\n%s\n#+end_signature"</span><span class="ef-ob">
                                (cdr +mu4e-org-ml-signature)))
            (insert (cdr +mu4e-org-ml-signature) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)))
      (goto-char (point-max))
      (insert (car +mu4e-org-ml-signature)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> default-directory
          (file-name-concat doom-user-dir </span><span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org/"</span><span class="ef-ob">))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+mu4e-goto-subject-not-to-once</span><span class="ef-ob"> ()
  (message-goto-subject)
  (advice-remove 'message-goto-to #'+mu4e-goto-subject-not-to-once))
</span><span class="ef-obe">#+end_src
</span>
Now let's set up that signature.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+mu4e-org-ml-signature</span><span class="ef-ob">
  (cons
   </span><span style="color: #50a14f; background-color: #e7e7e7;">"All the best,
Timothy

-- \
Timothy (‘</span><span style="color: #b751b6; background-color: #e7e7e7;">tecosaur</span><span style="color: #50a14f; background-color: #e7e7e7;">’/‘</span><span style="color: #b751b6; background-color: #e7e7e7;">TEC</span><span style="color: #50a14f; background-color: #e7e7e7;">’), Org mode contributor.
Learn more about Org mode at &lt;https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
"</span>
   <span style="color: #50a14f; background-color: #e7e7e7;">"All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b&gt;@@

-\u200b- \\\\
Timothy (‘</span><span style="color: #b751b6; background-color: #e7e7e7;">tecosaur</span><span style="color: #50a14f; background-color: #e7e7e7;">’/‘</span><span style="color: #b751b6; background-color: #e7e7e7;">TEC</span><span style="color: #50a14f; background-color: #e7e7e7;">’), Org mode contributor.\\\\
Learn more about Org mode at https://orgmode.org/.\\\\
Support Org development at https://liberapay.com/org-mode,\\\\
or support my work at https://liberapay.com/tec."</span><span class="ef-ob">)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Plain and Org version of the org-ml specific signature."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Now to make this take effect, we can just add it a bit later on in
<span style="color: #84888b;">~mu4e-compose-mode-hook~</span> (after <span style="color: #84888b;">~org-msg-post-setup~</span>) by setting a hook depth of 1.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook 'mu4e-compose-mode-hook #'+mu4e-compose-org-ml-setup 1)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Org Msg</span>

Doom does a fantastic stuff with the defaults with this, so we only make a few
minor tweaks. First, some stylistic things:

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-msg-greeting-fmt </span><span style="color: #50a14f; background-color: #e7e7e7;">"\nHi%s,\n\n"</span><span class="ef-ob">
      org-msg-signature </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n#+begin_signature\nAll the best,\\\\\n@@html:&lt;b&gt;@@Timothy@@html:&lt;/b&gt;@@\n#+end_signature"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
We also want to set the accent colour used in the Doom <span style="color: #84888b;">=mu4e=</span> module's
construction of the default org-msg style.

<span class="ef-c"># Noweb ref set to enable use with confpkg pre.</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref org-msg-accent
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +org-msg-accent-color </span><span style="color: #50a14f; background-color: #e7e7e7;">"#1a5fb4"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Now, it would be nice to easily jump to and between the ends of the message
body, so let's make a function for this.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-msg-goto-body</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> end)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Go to either the beginning or the end of the body.
END can be the symbol top, bottom, or nil to toggle."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((initial-pos (point)))
    (org-msg-goto-body)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (eq end 'top)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (memq initial-pos </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Already at bottom
</span><span class="ef-ob">                             (list (point) (1- (point))))
                       (&lt;= initial-pos </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Above message body
</span><span class="ef-ob">                           (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
                             (message-goto-body)
                             (point))))
                   (not (eq end 'bottom))))
      (message-goto-body)
      (re-search-forward
       (format (regexp-quote org-msg-greeting-fmt) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">%s is unaffected.
</span><span class="ef-ob">               (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;"> "</span><span class="ef-ob"> (regexp-quote (org-msg-get-to-name)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?"</span><span class="ef-ob">))))))
</span><span class="ef-obe">#+end_src
</span>
We can replace the evil binding of <span style="color: #84888b;">=mu4e-compose-goto-bottom=</span> with this function.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-msg-edit-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org-msg
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"G"</span><span class="ef-ob"> #'+org-msg-goto-body)
</span><span class="ef-obe">#+end_src
</span>
It would also be good to call this when replying to a message. This has to be
implemented as advice as the compose hooks are run before <span style="color: #84888b;">~mu4e~compose-handler~</span>
moves the point with <span style="color: #84888b;">~message-goto-&lt;location&gt;~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-msg-goto-body-when-replying</span><span class="ef-ob"> (compose-type </span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> _)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Call `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+org-msg-goto-body</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' when the current message is a reply."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> org-msg-edit-mode (eq compose-type 'reply))
    (+org-msg-goto-body)))

(advice-add 'mu4e~compose-handler </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'+org-msg-goto-body-when-replying)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #e45649; font-weight: nil; font-size: 1.25em">* Language configuration</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** General</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** File Templates</span>

<span style="color: #84888b;">#+call: confpkg()</span>

For some file types, we overwrite defaults in the <span style="color: #4078f2; font-weight: 700;">[[file:./snippets][snippets]]</span> directory, others
need to have a template assigned.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(set-file-template! </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.tex$"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:trigger</span> <span style="color: #50a14f; background-color: #e7e7e7;">"__"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:mode</span><span class="ef-ob"> 'latex-mode)
(set-file-template! </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.org$"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:trigger</span> <span style="color: #50a14f; background-color: #e7e7e7;">"__"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:mode</span><span class="ef-ob"> 'org-mode)
(set-file-template! </span><span style="color: #50a14f; background-color: #e7e7e7;">"/LICEN[CS]E$"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:trigger</span><span class="ef-ob"> '+file-templates/insert-license)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Plaintext</span>

<span style="color: #84888b;">#+call: confpkg()</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Ansi colours</span>

It's nice to see ANSI colour codes displayed, however we don't want to disrupt
ANSI codes in Org src blocks.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> text-mode
  (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'text-mode-hook
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (derived-mode-p 'org-mode)
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Apply ANSI color codes
</span><span class="ef-ob">      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-silent-modifications</span><span class="ef-ob">
        (ansi-color-apply-on-region (point-min) (point-max) t)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Margin without line numbers</span>

Display-wise, somehow I don't mind code buffers without any margin on the left,
but it feels a bit off with text buffers once the padding provided by line
numbers is stripped away.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+text-mode-left-margin-width</span><span class="ef-ob"> 1
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"The `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">left-margin-width</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' to be used in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">text-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' buffers."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+setup-text-mode-left-margin</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (derived-mode-p 'text-mode)
             (not (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> visual-fill-column-mode)
                       visual-fill-column-center-text))
             (eq (current-buffer) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Check current buffer is active.
</span><span class="ef-ob">                 (window-buffer (frame-selected-window))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> left-margin-width (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> display-line-numbers
                                0 +text-mode-left-margin-width))
    (set-window-buffer (get-buffer-window (current-buffer))
                       (current-buffer))))

</span><span class="ef-obe">#+end_src
</span>
Now we just need to hook this up to all the events which could either indicate a
change in the conditions or require the setup to be re-applied.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook 'window-configuration-change-hook #'+setup-text-mode-left-margin)
(add-hook 'display-line-numbers-mode-hook #'+setup-text-mode-left-margin)
(add-hook 'text-mode-hook #'+setup-text-mode-left-margin)
</span><span class="ef-obe">#+end_src
</span>
There's one little niggle with Doom, as <span style="color: #84888b;">~doom/toggle-line-numbers~</span> doesn't run
<span style="color: #84888b;">~display-line-numbers-mode-hook~</span>, so some advice is needed.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +doom/toggle-line-numbers--call-hook-a ()
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'doom/toggle-line-numbers
  (run-hooks 'display-line-numbers-mode-hook))
</span><span class="ef-obe">#+end_src
</span>
Lastly, I think I actually like this enough that I'll go ahead and remove line
numbers in text mode.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(remove-hook 'text-mode-hook #'display-line-numbers-mode)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Org</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:CUSTOM_ID:</span> org
<span style="font-weight: 700;">:END:</span>

<span style="font-weight: 700;">:intro:</span>
I really like org mode, I've given some thought to why, and below is the result.

<span style="color: #84888b;">#+attr_latex: :align *{8}{p{0.105\linewidth}} :font \small</span>
<span style="color: #84888b;">#+plot: transpose:yes type:radar min:0 max:4 file:"misc/document-format-comparison.svg"</span>
| Format            | Fine-grained control | Initial ease of use | Syntax simplicity | Editor Support | Integrations | Ease-of-referencing | Versatility |
|-------------------+----------------------+---------------------+-------------------+----------------+--------------+---------------------+-------------|
| Word              |                    2 |                   4 |                 4 |              2 |            3 |                   2 |           2 |
| LaTeX             |                    4 |                   1 |                 1 |              3 |            2 |                   4 |           3 |
| Org Mode          |                    4 |                   2 |               3.5 |              1 |            4 |                   4 |           4 |
| Markdown          |                    1 |                   3 |                 3 |              4 |            3 |                   3 |           1 |
| Markdown + Pandoc |                  2.5 |                 2.5 |               2.5 |              3 |            3 |                   3 |           2 |

<span style="color: #84888b;">#+attr_html: :class invertible :alt Radar chart comparing my opinions of document formats.</span>
<span style="color: #84888b;">#+attr_latex: :options inkscapelatex=false</span>
<span style="color: #4078f2; font-weight: 700;">[[file:misc/document-format-comparison.svg]]</span>

Beyond the elegance in the markup language, tremendously rich integrations with
Emacs allow for some fantastic <span style="color: #4078f2; font-weight: 700;">[[https://orgmode.org/features.html][features]]</span>, such as what seems to be the best
support for <span style="color: #4078f2; font-weight: 700;">[[https://en.wikipedia.org/wiki/Literate_programming][literate programming]]</span> of any currently available technology.

<span style="color: #84888b;">#+name: Literate programming workflow</span>
<span style="color: #84888b;">#+attr_html: :style line-height:1.13;</span>
<span class="ef-obb">#+begin_example
</span><span class="ef-ob">      ╭─╴Code╶─╮            ╭─╴Raw Code╶─▶ Computer
Ideas╺┥        ┝━▶ Org Mode╺┥
      ╰─╴Text╶─╯            ╰─╴Document╶─▶ People
</span><span class="ef-obe">#+end_example
</span>
An <span style="color: #84888b;">=.org=</span> file can contain blocks of code (with <span style="color: #4078f2; font-weight: 700;">[[https://en.wikipedia.org/wiki/Noweb][noweb]]</span> templating support), which
can be <span style="color: #4078f2; font-weight: 700;">[[https://orgmode.org/manual/Extracting-Source-Code.html][tangled]]</span> to dedicated source code files, and <span style="color: #4078f2; font-weight: 700;">[[https://orgmode.org/manual/Extracting-Source-Code.html][woven]]</span> into a document
(report, documentation, presentation, etc.) through various (<span style="text-decoration: italic;">/extensible/</span>) methods.
These source blocks may even create images or other content to be included in
the document, or generate source code.

<span style="color: #84888b;">#+name: Example Org Flowchart</span>
<span style="color: #84888b;">#+attr_html: :style line-height:1.13;</span>
<span class="ef-obb">#+begin_example
</span><span class="ef-ob">                   ╭───────────────────────────────────▶ .pdf ⎫
                  pdfLaTeX ▶╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╮                 ⎪
                   ╿     ╿                  ┊                 ⎪
                   │     ┊                  ┊                 ⎪
                 .tex    ┊                  ┊                 ⎪
                   ╿     ┊                  ┊                 ⎪
                ╭──┴╌╌╮  ┊                  ┊ style.scss      ⎬ Weaving
graphc.png ─╮   │  embedded TeX             ┊      ╽          ⎪ (Documents)
image.jpeg ─┤ filters   ╿                   ┊    .css         ⎪
            ╎     ╿     ┊                   ┊     ▾╎          ⎪
figure.png╶─╧─▶ PROJECT.ORG ▶───╴filters╶───╧──────╪──▶ .html ⎪
     ╿           ╿┊ ║ │ ╰╌╌╌▷╌╌ embedded html ▶╌╌╌╌╯          ⎪
     ├╌╌╌╌╌╌╌▷╌╌╌╯┊ ║ │                                       ⎪
    result╶╌╌╌╌╌╮ ┊ ║ ├──────╴filters╶────────────────▶ .txt  ⎪
     ┊▴         ┊ ┊ ║ │                                       ⎪
    execution   ┊ ┊ ║ ╰──────╴filters╶────────────────▶ .md   ⎭
     ┊▴         ┊ ┊ ║
    code blocks◀╯ ┊ ╟─────────────────────────────────▶ .c    ⎫
     ╰╌╌╌╌◁╌╌╌╌╌╌╌╯ ╟─────────────────────────────────▶ .sh   ⎬ Tangling
                    ╟─────────────────────────────────▶ .hs   ⎪ (Code)
                    ╙─────────────────────────────────▶ .el   ⎭
</span><span class="ef-obe">#+end_example
</span><span style="font-weight: 700;">:end:</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** System config</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Mime types</span>

Org mode isn't recognised as it's own mime type by default, but that can easily
be changed with the following file. For system-wide changes try
<span style="color: #84888b;">~/usr/share/mime/packages/org.xml~</span>.
<span class="ef-obb">#+begin_src xml :tangle ~/.local/share/mime/packages/org.xml :mkdirp yes :comments no
</span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">mime-info</span> <span style="color: #a626a4; background-color: #e7e7e7;">xmlns</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">'http://www.freedesktop.org/standards/shared-mime-info'</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span>
  <span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">mime-type</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"text/org"</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span>
    <span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">comment</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span><span style="color: #84888b; background-color: #e7e7e7;">Emacs Org-mode File</span><span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span style="color: #a626a4; background-color: #e7e7e7;">comment</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span>
    <span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">glob</span> <span style="color: #6a1868; background-color: #e7e7e7;">pattern</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"*.org"</span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span>
    <span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">alias</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"text/org"</span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span>
  <span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span style="color: #a626a4; background-color: #e7e7e7;">mime-type</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span>
<span style="color: #84888b; background-color: #e7e7e7;">&lt;</span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span style="color: #a626a4; background-color: #e7e7e7;">mime-info</span><span style="color: #84888b; background-color: #e7e7e7;">&gt;</span>
<span class="ef-obe">#+end_src
</span>What's nice is that Papirus <span style="color: #4078f2; font-weight: 700;">[[https://github.com/PapirusDevelopmentTeam/papirus-icon-theme/commit/a10fb7f2423d5e30b9c4477416ccdc93c4f3849d][now]]</span> has an icon for <span style="color: #84888b;">=text/org=</span>.
One simply needs to refresh their mime database
<span class="ef-obb">#+begin_src shell :tangle (if (string= (shell-command-to-string "xdg-mime query default text/org") "") "setup.sh" "no")
</span><span class="ef-ob">update-mime-database ~/.local/share/mime
</span><span class="ef-obe">#+end_src
</span>Then set Emacs as the default editor
<span class="ef-obb">#+begin_src shell :tangle (if (string= (shell-command-to-string "xdg-mime query default text/org") "emacs-client.desktop\n") "no" "setup.sh")
</span><span class="ef-ob">xdg-mime default emacs.desktop text/org
</span><span class="ef-obe">#+end_src
</span>
Once again, we will add <span style="color: #84888b;">=doctor=</span> checks around this.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string= (shell-command-to-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"xdg-mime query default text/org"</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"text/org is not a registered mime type."</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (string= (shell-command-to-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"xdg-mime query default text/org"</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">"emacs-client.desktop\n"</span><span class="ef-ob">)
    (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emacs(client) is not set up as the text/org handler."</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Git diffs</span>

Protesilaos wrote a <span style="color: #4078f2; font-weight: 700;">[[https://protesilaos.com/codelog/2021-01-26-git-diff-hunk-elisp-org/][very helpful article]]</span> in which he explains how to change the
git diff chunk heading to something more useful than just the immediate line
above the hunk --- like the parent heading.

This can be achieved by first adding a new diff mode to git in <span style="color: #84888b;">=~/.config/git/attributes=</span>
<span class="ef-obb">#+begin_src gitattributes
</span><span class="ef-ob">,</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">.org</span>   <span style="color: #6a1868; background-color: #e7e7e7;">diff</span><span class="ef-ob">=org
</span><span class="ef-obe">#+end_src
</span>
Then adding a regex for it to <span style="color: #84888b;">=~/.config/git/config=</span>
<span class="ef-obb">#+begin_src gitconfig
</span><span class="ef-ob">[</span><span style="color: #986801; background-color: #e7e7e7;">diff</span> <span style="color: #a626a4; background-color: #e7e7e7;">"org"</span><span class="ef-ob">]
  </span><span style="color: #6a1868; background-color: #e7e7e7;">xfuncname</span><span class="ef-ob"> = </span><span style="color: #50a14f; background-color: #e7e7e7;">"^(\\*+ +.*)$"</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Packages</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Org itself</span>

There are actually three possible package statements I may want to use for Org.

If I'm on a machine where I can push changes, I want to be able to develop Org.
I can check this by checking the content of the SSH key <span style="color: #84888b;">=~/.ssh/id_ed25519.pub=</span>.
1. If this key exists and there isn't a repo at
   <span style="color: #84888b;">=$doom-user-dir/lisp/org=</span> with the right remote, we should
   install it as such.
2. If the key exists and repo are both set up, the package should just be ignored.
3. If the key does not exist, the Org's <span style="color: #84888b;">~HEAD~</span> should just be used

To account for this situation properly, we need a short script to determine the
correct package statement needed.

<span style="color: #84888b;">#+name: org-pkg-statement</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">doom</span><span class="ef-ob"> (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"lisp/doom.el"</span><span class="ef-ob">
                                     (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> doom-emacs-dir)
                                         user-emacs-directory)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-local-dir
          (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">".local/"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> doom-emacs-dir)
                                          user-emacs-directory))))
(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((dev-key-p (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (file-exists-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.ssh/id_ed25519.pub"</span><span class="ef-ob">)
                      (= 0 (shell-command </span><span style="color: #50a14f; background-color: #e7e7e7;">"cat ~/.ssh/id_ed25519.pub | grep -q AAAAC3NzaC1lZDI1NTE5AAAAIOZZqcJOLdN+QFHKyW8ST2zz750+8TdvO9IT5geXpQVt"</span><span class="ef-ob">))))
      (recipe-common '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:defaults</span> <span style="color: #50a14f; background-color: #e7e7e7;">"etc"</span><span class="ef-ob">)
                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:build</span><span class="ef-ob"> t
                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:pre-build</span><span class="ef-ob">
                       (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-file</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org-version.el"</span><span class="ef-ob">
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">lisp-mnt</span><span class="ef-ob">)
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((version </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(lm-version "lisp/org.el")
</span><span class="ef-ob">                                (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
                                  (insert-file-contents </span><span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org.el"</span><span class="ef-ob">)
                                  (lm-header </span><span style="color: #50a14f; background-color: #e7e7e7;">"version"</span><span class="ef-ob">)))
                               (git-version (string-trim
                                             (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
                                               (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"git"</span><span class="ef-ob"> nil t nil
                                                             </span><span style="color: #50a14f; background-color: #e7e7e7;">"rev-parse"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"--short"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"HEAD"</span><span class="ef-ob">)
                                               (buffer-string)))))
                           (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"(defun org-release () \"The release version of Org.\" %S)\n"</span><span class="ef-ob">
                                           version)
                                   (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"(defun org-git-version () \"The truncate git commit hash of Org mode.\" %S)\n"</span><span class="ef-ob">
                                           git-version)
                                   </span><span style="color: #50a14f; background-color: #e7e7e7;">"(provide 'org-version)\n"</span><span class="ef-ob">))))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
    (insert
     (pp `(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org
            </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (,@(</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> dev-key-p
                           (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"tec@git.savannah.gnu.org:/srv/git/emacs/org-mode.git"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org"</span>
                                 <span style="color: #a626a4; background-color: #e7e7e7;">:fork</span><span class="ef-ob"> (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"git@ssh.tecosaur.net:tec/org-mode.git"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:branch</span> <span style="color: #50a14f; background-color: #e7e7e7;">"dev"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:remote</span> <span style="color: #50a14f; background-color: #e7e7e7;">"tecosaur"</span><span class="ef-ob">))
                         (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://code.tecosaur.net/mirrors/org-mode.git"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:remote</span> <span style="color: #50a14f; background-color: #e7e7e7;">"mirror"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:fork</span><span class="ef-ob"> (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> nil </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://code.tecosaur.net/tec/org-mode.git"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:branch</span> <span style="color: #50a14f; background-color: #e7e7e7;">"dev"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:remote</span> <span style="color: #50a14f; background-color: #e7e7e7;">"tecosaur"</span><span class="ef-ob">)))
                     ,@recipe-common)
            </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span><span class="ef-ob"> nil)))
    (untabify (point-min) (point-max))
    (buffer-string)))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el :noweb no-export
</span><span class="ef-ob">&lt;&lt;org-pkg-statement()&gt;&gt;
(</span><span style="color: #e45649; background-color: #e7e7e7;">unpin!</span><span class="ef-ob"> org) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">there be bugs
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-contrib
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">The `</span><span style="color: #b751b6; background-color: #e7e7e7;">sr.ht</span><span style="color: #84888b; background-color: #e7e7e7;">' repo has been a bit flaky as of late.
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"emacsmirror/org-contrib"</span>
           <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"lisp/*.el"</span><span class="ef-ob">))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"8d14a600a2069ffc494edfc9a12b8e5fc8840bf1"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Visuals</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Org Modern</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-modern")</span>

Fontifying <span style="color: #84888b;">=org-mode=</span> buffers to be as pretty as possible is of paramount importance,
and Minad's lovely <span style="color: #84888b;">=org-modern=</span> goes a long way in this regard.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-modern </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"a58534475b4312b0920aa9d3824272470c8e3500"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
...with a touch of configuration...

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-modern
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (org-mode . org-modern-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-modern-star '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"◉"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"○"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"✸"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"✿"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"✤"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"✜"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"◆"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"▶"</span><span class="ef-ob">)
        org-modern-table-vertical 1
        org-modern-table-horizontal 0.2
        org-modern-list '((43 . </span><span style="color: #50a14f; background-color: #e7e7e7;">"➤"</span><span class="ef-ob">)
                          (45 . </span><span style="color: #50a14f; background-color: #e7e7e7;">"–"</span><span class="ef-ob">)
                          (42 . </span><span style="color: #50a14f; background-color: #e7e7e7;">"•"</span><span class="ef-ob">))
        org-modern-todo-faces
        '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"TODO"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> org-todo)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"PROJ"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-project)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"STRT"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-active)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[-]"</span>  <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-active)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"HOLD"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-onhold)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"WAIT"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-onhold)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[?]"</span>  <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-onhold)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"KILL"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-cancel)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"NO"</span>   <span style="color: #a626a4; background-color: #e7e7e7;">:inverse-video</span><span class="ef-ob"> t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> +org-todo-cancel))
        org-modern-footnote
        (cons nil (cadr org-script-display))
        org-modern-block-fringe nil
        org-modern-block-name
        '((t . t)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"src"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"»"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"«"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"example"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"»–"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"–«"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"quote"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"❝"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"❞"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"export"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"⏩"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"⏪"</span><span class="ef-ob">))
        org-modern-progress nil
        org-modern-priority nil
        org-modern-horizontal-rule (make-string 36 ?─)
        org-modern-keyword
        '((t . t)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"title"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"𝙏"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"subtitle"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"𝙩"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"author"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"𝘼"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"email"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"date"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"𝘿"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"󰠳"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"options"</span><span class="ef-ob"> . #(</span><span style="color: #50a14f; background-color: #e7e7e7;">"󰘵"</span><span class="ef-ob"> 0 1 (display (height 0.75))))
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"startup"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⏻"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"macro"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"𝓜"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"bind"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"󰌷"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"bibliography"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"print_bibliography"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"󰌱"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"cite_export"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⮭"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"print_glossary"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"󰌱ᴬᶻ"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"glossary_sources"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"󰒻"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"include"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⇤"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"setupfile"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⇚"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"html_head"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🅷"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"html"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🅗"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex_class"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🄻"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex_class_options"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🄻󰒓"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex_header"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🅻"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex_header_extra"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🅻⁺"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🅛"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"beamer_theme"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🄱"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"beamer_color_theme"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🄱󰏘"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"beamer_font_theme"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🄱𝐀"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"beamer_header"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🅱"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"beamer"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🅑"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"attr_latex"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🄛"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"attr_html"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🄗"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"attr_org"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⒪"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"call"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"󰜎"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"name"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⁍"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"header"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"›"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"caption"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"☰"</span><span class="ef-ob">)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"results"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"🠶"</span><span class="ef-ob">)))
  (custom-set-faces! '(org-modern-statistics </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> org-checkbox-statistics-todo)))
</span><span class="ef-obe">#+end_src
</span>
Since <span style="color: #84888b;">=org-modern=</span>'s tag face supplants Org's tag face, we need to adjust the
spell-check face ignore list

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> spell-fu
  (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-pushnew</span><span class="ef-ob"> 'org-modern-tag (alist-get 'org-mode +spell-excluded-faces-alist)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Emphasis markers</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-appear")</span>

While <span style="color: #84888b;">~org-hide-emphasis-markers~</span> is very nice, it can sometimes make edits which
occur at the border a bit more fiddley. We can improve this situation without
sacrificing visual amenities with the <span style="color: #84888b;">=org-appear=</span> package.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-appear </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"awth13/org-appear"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"32ee50f8fdfa449bbc235617549c1bccb503cb09"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-appear
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (org-mode . org-appear-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-appear-autoemphasis t
        org-appear-autosubmarkers t
        org-appear-autolinks nil)
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">for proper first-time setup, `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-appear--set-elements</span><span style="color: #84888b; background-color: #e7e7e7;">'
</span>  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">needs to be run after other hooks have acted.
</span><span class="ef-ob">  (run-at-time nil nil #'org-appear--set-elements))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Heading structure</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-ol-tree")</span>

Speaking of headlines, a nice package for viewing and managing the heading
structure has come to my attention.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-ol-tree </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Townk/org-ol-tree"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"207c748aa5fea8626be619e8c55bdb1c16118c25"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
We'll bind this to <span style="color: #84888b;">=O=</span> on the org-mode localleader, and manually apply a <span style="color: #4078f2; font-weight: 700;">[[https://github.com/Townk/org-ol-tree/pull/13][PR
recognising the pgtk window system]]</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-ol-tree
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> org-ol-tree
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-ol-tree-ui-icon-set
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (display-graphic-p)
                 (fboundp 'all-the-icons-material))
            'all-the-icons
          'unicode))
  (org-ol-tree-ui--update-icon-set))

(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Outline"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"O"</span><span class="ef-ob"> #'org-ol-tree)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Extra functionality</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Julia support</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg ob-julia")</span>

<span style="color: #84888b;">=ob-julia=</span> is currently a bit borked, but there's an effort to improve this.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> ob-julia </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/ob-julia"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"julia"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! ob-julia
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> org-babel-execute:julia
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-babel-julia-command-arguments
        `(</span><span style="color: #50a14f; background-color: #e7e7e7;">"--sysimage"</span><span class="ef-ob">
          ,(</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((img </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.local/lib/julia.so"</span><span class="ef-ob">)
                      (exists? (file-exists-p img)))
             (expand-file-name img))
          </span><span style="color: #50a14f; background-color: #e7e7e7;">"--threads"</span><span class="ef-ob">
          ,(number-to-string (- (doom-system-cpus) 2))
          </span><span style="color: #50a14f; background-color: #e7e7e7;">"--banner=no"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** HTTP requests</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg ob-http")</span>

I like the idea of being able to make HTTP requests with Babel.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> ob-http </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"b1428ea2a63bcb510e7382a1bf5fe82b19c104a7"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! ob-http
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> org-babel-execute:http)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** RSS feeds</span>

I need this for blog publishing. It used to be bundled with Org, but now it's
pretty much abandoned.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> ox-rss </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"d2964eca3614f84db85b498d065862a1e341868d"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Transclusion</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-transclusion")</span>

There's a really cool package in development to <span style="text-decoration: italic;">/transclude/</span> Org document content.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-transclusion </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"nobiot/org-transclusion"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e9728b0b14b5c2e5d3b68af98f772ed99e136b48"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-transclusion
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> org-transclusion-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-mode-map
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;f12&gt;"</span><span class="ef-ob"> #'org-transclusion-mode))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Heading graph</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-graph-view")</span>

Came across this and ... it's cool
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-graph-view </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"alphapapa/org-graph-view"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"172157aee1131ea59f0bd724a10abfdbccbd860e"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Cooking recipes</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-chef")</span>

I <span style="font-weight: 700;">*need*</span> this in my life. It take a URL to a recipe from a common site, and
inserts an org-ified version at point. Isn't that just great.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-chef </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"1710b54441ed744dcdfb125d08fb88cfaf452f10"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Loading after org seems a bit premature. Let's just load it when we try to use
it, either by command or in a capture template.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-chef
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> (org-chef-insert-recipe org-chef-get-recipe-from-url))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Importing with Pandoc</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-pandoc-import")</span>

Sometimes I'm given non-org files, that's very sad. Luckily Pandoc offers a way
to make that right again, and this package makes that even easier to do.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-pandoc-import </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob">
  (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org-pandoc-import"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"filters"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"preprocessors"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-pandoc-import
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Glossaries and more</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-glossary")</span>

For glossary-type entries, there's a nice package for this I'm developing.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-glossary </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org-glossary"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Other than hooking this to <span style="color: #84888b;">=org-mode=</span>, we also want to set a collection root and
improve the LaTeX usage references with <span style="color: #84888b;">=cleveref=</span>'s <span style="color: #84888b;">~\labelcpageref~</span> command.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-glossary
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (org-mode . org-glossary-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-glossary-collection-root </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/.config/doom/misc/glossaries/"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-glossary--latex-cdef</span><span class="ef-ob"> (backend info term-entry form </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> ref-index plural-p capitalized-p extra-parameters)
    (org-glossary--export-template
     (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (plist-get term-entry </span><span style="color: #a626a4; background-color: #e7e7e7;">:uses</span><span class="ef-ob">)
         </span><span style="color: #50a14f; background-color: #e7e7e7;">"*%d*\\emsp{}%v\\ensp{}@@latex:\\labelcpageref{@@%b@@latex:}@@\n"</span>
       <span style="color: #50a14f; background-color: #e7e7e7;">"*%d*\\emsp{}%v\n"</span><span class="ef-ob">)
     backend info term-entry ref-index
     plural-p capitalized-p extra-parameters))
  (org-glossary-set-export-spec
   'latex t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:backref</span> <span style="color: #50a14f; background-color: #e7e7e7;">"gls-%K-use-%r"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:backref-seperator</span> <span style="color: #50a14f; background-color: #e7e7e7;">","</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:definition-structure</span><span class="ef-ob"> #'+org-glossary--latex-cdef))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Document comparison</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg orgdiff")</span>

It's quite nice to compare Org files, and the richest way to compare content is
probably <span style="color: #84888b;">=latexdiff=</span>. There are a few annoying steps involved here, and so I've
written a package to streamline the process.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> orgdiff </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/orgdiff"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
The only little annoyance is the fact that <span style="color: #84888b;">=latexdiff=</span> uses <span style="color: #84888b;">~#FF0000~</span> and <span style="color: #84888b;">~#0000FF~</span> as
the red/blue change indication colours. We can make this a bit nicer by
post-processing the <span style="color: #84888b;">=latexdiff=</span> result.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! orgdiff
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:defer</span><span class="ef-ob"> t
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+orgdiff-nicer-change-colours</span><span class="ef-ob"> ()
    (goto-char (point-min))
    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Set red/blue based on whether chameleon is being used
</span><span class="ef-ob">    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"%% make document follow Emacs theme"</span><span class="ef-ob"> nil t)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> red  (substring (doom-blend 'red 'fg 0.8) 1)
              blue (substring (doom-blend 'blue 'teal 0.6) 1))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> red  </span><span style="color: #50a14f; background-color: #e7e7e7;">"c82829"</span><span class="ef-ob">
            blue </span><span style="color: #50a14f; background-color: #e7e7e7;">"00618a"</span><span class="ef-ob">))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"%DIF PREAMBLE EXTENSION ADDED BY LATEXDIFF"</span><span class="ef-ob"> nil t)
               (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\RequirePackage{color}"</span><span class="ef-ob"> nil t))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"definecolor{red}{rgb}{1,0,0}"</span><span class="ef-ob"> (cdr (bounds-of-thing-at-point 'line)) t)
        (replace-match (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"definecolor{red}{HTML}{%s}"</span><span class="ef-ob"> red)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"definecolor{blue}{rgb}{0,0,1}"</span><span class="ef-ob"> (cdr (bounds-of-thing-at-point 'line)) t)
        (replace-match (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"definecolor{blue}{HTML}{%s}"</span><span class="ef-ob"> blue)))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> orgdiff-latexdiff-args '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"--append-safecmd=acr,acrs"</span><span class="ef-ob">))
  (add-to-list 'orgdiff-latexdiff-postprocess-hooks #'+orgdiff-nicer-change-colours))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Org music</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-music")</span>

It's nice to be able to link to music
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-music </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/org-music"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-music
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-music-mpris-player </span><span style="color: #50a14f; background-color: #e7e7e7;">"Lollypop"</span><span class="ef-ob">
        org-music-track-search-method 'beets
        org-music-beets-db </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/Music/library.db"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Behaviour</span>

<span style="color: #84888b;">#+call: confpkg("Org Behaviour", after="org")</span>

<span style="color: #4078f2; font-weight: 700;">[[xkcd:1319]]</span>

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Tweaking defaults</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-directory (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"org"</span><span class="ef-ob"> (xdg-data-home)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Let's put files here.
</span><span class="ef-ob">      org-agenda-files (list org-directory)                  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Seems like the obvious place.
</span><span class="ef-ob">      org-use-property-inheritance t                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">It's convenient to have properties inherited.
</span><span class="ef-ob">      org-log-done 'time                                     </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Having the time a item is done sounds convenient.
</span><span class="ef-ob">      org-list-allow-alphabetical t                          </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Have a. A. a) A) list bullets.
</span><span class="ef-ob">      org-catch-invisible-edits 'smart                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Try not to accidently do weird stuff in invisible regions.
</span><span class="ef-ob">      org-export-with-sub-superscripts '{}                   </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Don't treat lone _ / ^ as sub/superscripts, require _{} / ^{}.
</span><span class="ef-ob">      org-export-allow-bind-keywords t                       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Bind keywords can be handy
</span><span class="ef-ob">      org-image-actual-width '(0.9))                         </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Make the in-buffer display closer to the exported result..
</span><span class="ef-obe">#+end_src
</span>I also like the <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">:comments</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> header-argument, so let's make that a
default.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-babel-default-header-args
      '((</span><span style="color: #a626a4; background-color: #e7e7e7;">:session</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"none"</span><span class="ef-ob">)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:results</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"replace"</span><span class="ef-ob">)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:exports</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"code"</span><span class="ef-ob">)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:cache</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob">)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:noweb</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob">)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:hlines</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob">)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:tangle</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob">)
        (</span><span style="color: #a626a4; background-color: #e7e7e7;">:comments</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"link"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
By default, <span style="color: #84888b;">~visual-line-mode~</span> is turned <span style="color: #84888b;">=on=</span>, and <span style="color: #84888b;">~auto-fill-mode~</span> <span style="color: #84888b;">=off=</span> by a hook.
However this messes with tables in Org-mode, and other plaintext files (e.g.
markdown, \LaTeX) so I'll turn it off for this, and manually enable it for more
specific modes as desired.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(remove-hook 'text-mode-hook #'visual-line-mode)
(add-hook 'text-mode-hook #'auto-fill-mode)
</span><span class="ef-obe">#+end_src
</span>
There also seem to be a few keybindings which use <span style="color: #84888b;">=hjkl=</span>, but miss arrow key equivalents.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> evil-org-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> evil-org
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"g &lt;up&gt;"</span><span class="ef-ob"> #'org-backward-heading-same-level
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"g &lt;down&gt;"</span><span class="ef-ob"> #'org-forward-heading-same-level
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"g &lt;left&gt;"</span><span class="ef-ob"> #'org-up-element
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"g &lt;right&gt;"</span><span class="ef-ob"> #'org-down-element)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Extra functionality</span>

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** The utility of zero-width spaces</span>

Occasionally in Org you run into annoyances where you want to have two seperate
blocks right together without a space. For example, to <span style="font-weight: 700;">*emp​h*​</span>asise part of a word,
or put a currency symbol immediately before an inline source block.
There is a solution to this, it just sounds slightly hacky --- zero width spaces.
Because this is Emacs, we can make this feel much less hacky by making a minor
addition to the Org key map 🙂.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:nie</span> <span style="color: #50a14f; background-color: #e7e7e7;">"M-SPC M-SPC"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\u200B"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
We then want to stop the space from being included in exports, which is done <span style="color: #4078f2; font-weight: 700;">[[*Strip zero width spaces][here]]</span>.

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** List bullet sequence</span>

I think it makes sense to have list bullets change with depth
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-list-demote-modify-bullet '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"+"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"+"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"*"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"+"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"1."</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"a."</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Easier file links</span>

While <span style="color: #84888b;">~org-insert-link~</span> is all very well and good, a large portion of the time I
want to insert a file, and so it would be good to have a way to skip straight to
that and avoid the description prompt. Looking at <span style="color: #84888b;">~org-link-parameters~</span>, we can
see that the <span style="color: #84888b;">="file"=</span> link type uses the completion function
<span style="color: #84888b;">~org-link-complete-file~</span>, so let's use that to make a little file-link inserting
function.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-insert-file-link</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Insert a file link.  At the prompt, enter the filename."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (org-insert-link nil (org-link-complete-file)))
</span><span class="ef-obe">#+end_src
</span>
Now we'll just add that under the Org mode link localleader for convenience.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #50a14f; background-color: #e7e7e7;">"l f"</span><span class="ef-ob"> #'+org-insert-file-link)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Citation</span>

<span style="color: #84888b;">#+call: confpkg("Org Citation")</span>

<span class="ef-obb">#+begin_quote
</span>Extending the <span style="color: #84888b;">=:tools biblio=</span> module.
<span class="ef-obe">#+end_quote
</span>
References in Org are fairly easy now, thanks to <span style="color: #84888b;">=org-cite=</span>. The <span style="color: #84888b;">=:tools biblio=</span>
module gives a fairly decent basic setup, but it would be nice to take it a bit
further. This mostly consists of tweaking settings, but there is one extra
package I'll grab for prettier in-buffer citations.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-cite-csl-activate </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"andras-simonyi/org-cite-csl-activate"</span><span class="ef-ob">) </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ccadbdcdfd1b4cb0cea132324cc1912e0f1900b6"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
In particular, by setting <span style="color: #84888b;">~org-cite-csl-activate-use-document-style~</span>, we can have
the in-buffer displayed citations be the same as the exported form. Isn't that lovely!

Unfortunately, there's currently a potential for undesirable buffer
modifications, so we'll put all the activation code behind a function we can
call when we want it.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! oc-csl-activate
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> oc
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-cite-csl-activate-use-document-style t)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-cite-csl-activate/enable</span><span class="ef-ob"> ()
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-cite-activate-processor 'csl-activate)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'org-mode-hook '((</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (cursor-sensor-mode 1)) org-cite-csl-activate-render-all))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +org-cite-csl-activate-render-all-silent (orig-fn)
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-cite-csl-activate-render-all
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-silent-modifications</span><span class="ef-ob"> (funcall orig-fn)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq major-mode 'org-mode)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-silent-modifications</span><span class="ef-ob">
        (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
          (goto-char (point-min))
          (org-cite-activate (point-max)))
        (org-cite-csl-activate-render-all)))
    (fmakunbound #'+org-cite-csl-activate/enable)))
</span><span class="ef-obe">#+end_src
</span>
Now that <span style="color: #84888b;">=oc-csl-activate=</span> is set up, let's go ahead and customise some of the
packages already loaded. For starters, we can make use of the my Zotero files
with <span style="color: #84888b;">=citar=</span>, and make the symbols a bit prettier.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> citar
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-cite-global-bibliography
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((libfile-search-names '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"library.json"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Library.json"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"library.bib"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Library.bib"</span><span class="ef-ob">))
              (libfile-dir </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/Zotero"</span><span class="ef-ob">)
              paths)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (libfile libfile-search-names)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not paths)
                       (file-exists-p (expand-file-name libfile libfile-dir)))
              (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> paths (list (expand-file-name libfile libfile-dir)))))
          paths)
        citar-bibliography org-cite-global-bibliography
        citar-symbols
        `((file ,(nerd-icons-faicon </span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-file_o"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> 'nerd-icons-green </span><span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob"> -0.1) . </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">)
          (note ,(nerd-icons-octicon </span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-note"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> 'nerd-icons-blue </span><span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob"> -0.3) . </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">)
          (link ,(nerd-icons-octicon </span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-link"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> 'nerd-icons-orange </span><span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob"> 0.01) . </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
We can also make the Zotero CSL styles available to use.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> oc-csl
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-cite-csl-styles-dir </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/Zotero/styles"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Since CSL works so nicely everywhere, we might as well use it as the default
citation export processor for everything.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> oc
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-cite-export-processors '((t csl))))
</span><span class="ef-obe">#+end_src
</span>
Then, for convenience we'll cap things off by putting the citation command under
Org's localleader.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Insert citation"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"@"</span><span class="ef-ob"> #'org-cite-insert)
</span><span class="ef-obe">#+end_src
</span>
Lastly, just in case I come across any old citations of mine, I think it would
be nice to have a function to convert <span style="color: #84888b;">=org-ref=</span> citations to <span style="color: #84888b;">=org-cite=</span> forms.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> oc
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-ref-to-org-cite</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Attempt to convert org-ref citations to org-cite syntax."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((cite-conversions '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"cite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"//b"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Cite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"//bc"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nocite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/n"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"citep"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"citep*"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"//f"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"parencite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Parencite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"//c"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"citeauthor"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/a/f"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"citeauthor*"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/a"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"citeyear"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/na/b"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Citep"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"//c"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Citealp"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"//bc"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Citeauthor"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/a/cf"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Citeauthor*"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/a/c"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"autocite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Autocite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"//c"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"notecite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/l/b"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Notecite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/l/bc"</span><span class="ef-ob">)
                               (</span><span style="color: #50a14f; background-color: #e7e7e7;">"pnotecite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/l"</span><span class="ef-ob">) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Pnotecite"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"/l/bc"</span><span class="ef-ob">)))
           (cite-regexp (</span><span style="color: #e45649; background-color: #e7e7e7;">rx</span><span class="ef-ob"> (regexp (regexp-opt (mapcar #'car cite-conversions) t))
                            </span><span style="color: #50a14f; background-color: #e7e7e7;">":"</span><span class="ef-ob"> (group (+ (not (any </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n 	,.)]}"</span><span class="ef-ob">)))))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
        (goto-char (point-min))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward cite-regexp nil t)
          (message (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"[cite%s:@%s]"</span><span class="ef-ob">
                                 (cdr (assoc (match-string 1) cite-conversions))
                                 (match-string 2)))
          (replace-match (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"[cite%s:@%s]"</span><span class="ef-ob">
                                 (cdr (assoc (match-string 1) cite-conversions))
                                 (match-string 2))))))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** cdlatex environments</span>

I prefer <span style="color: #84888b;">=auto-activating-snippets=</span> to <span style="color: #84888b;">=cdlatex=</span>, but do like
<span style="color: #84888b;">~org-cdlatex-environment-indent~</span> (bound to <span style="color: #84888b;">=C-c }=</span>). I almost always want to edit
them afterwards though, so let's make that happen by default.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +org-edit-latex-env-after-insert-a (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> _)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'org-cdlatex-environment-indent
  (org-edit-latex-environment))
</span><span class="ef-obe">#+end_src
</span>
At some point in the future it could be good to investigate <span style="color: #4078f2; font-weight: 700;">[[https://scripter.co/splitting-an-org-block-into-two/][splitting org blocks]]</span>.
Likewise <span style="color: #4078f2; font-weight: 700;">[[https://archive.casouri.cat/note/2020/insert-math-symbol-in-emacs/][this]]</span> looks good for symbols.

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** LSP support in </span><span style="color: #84888b; font-weight: 600; font-size: 1.06em">~src~</span><span style="color: #bc5cba; font-weight: 600; font-size: 1.06em"> blocks</span>

Now, by default, LSPs don't really function at all in <span style="color: #84888b;">~src~</span> blocks.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">cl-defmacro</span> <span style="color: #a626a4; background-color: #e7e7e7;">lsp-org-babel-enable</span><span class="ef-ob"> (lang)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Support LANG in org source code block."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> centaur-lsp 'lsp-mode)
  (</span><span style="color: #986801; background-color: #e7e7e7;">cl-check-type</span><span class="ef-ob"> lang string)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((edit-pre (intern (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"org-babel-edit-prep:%s"</span><span class="ef-ob"> lang)))
         (intern-pre (intern (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"lsp--%s"</span><span class="ef-ob"> (symbol-name edit-pre)))))
    `(</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
       (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span><span class="ef-ob"> ,intern-pre (info)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((file-name (</span><span style="color: #e45649; background-color: #e7e7e7;">-&gt;&gt;</span><span class="ef-ob"> info caddr (alist-get </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob">))))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> file-name
             (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> file-name (make-temp-file </span><span style="color: #50a14f; background-color: #e7e7e7;">"babel-lsp-"</span><span class="ef-ob">)))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> buffer-file-name file-name)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Enable lsp-mode in the buffer of org source block (%s)."</span><span class="ef-ob">
                    (upcase ,lang)))
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (fboundp ',edit-pre)
           (advice-add ',edit-pre </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> ',intern-pre)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
           (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span><span class="ef-ob"> ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Prepare local buffer environment for org source block (%s)."</span><span class="ef-ob">
                        (upcase ,lang))))))))
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-babel-lang-list</span><span class="ef-ob">
  '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"go"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"python"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ipython"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"bash"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"sh"</span><span class="ef-ob">))
(</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** View exported file</span>

<span style="color: #84888b;">='localeader v=</span> has no pre-existing binding, so I may as well use it with the same
functionality as in LaTeX. Let's try viewing possible output files with this.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> org-mode-map
      </span><span style="color: #a626a4; background-color: #e7e7e7;">:localleader</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"View exported file"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"v"</span><span class="ef-ob"> #'org-view-output-file)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-view-output-file</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> org-file-path)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Visit buffer open on the first output file (if any) found, using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-view-output-file-extensions</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((org-file-path (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> org-file-path (buffer-file-name) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
         (dir (file-name-directory org-file-path))
         (basename (file-name-base org-file-path))
         (output-file nil))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (ext org-view-output-file-extensions)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> output-file
        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (file-exists-p
               (concat dir basename </span><span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob"> ext))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> output-file (concat dir basename </span><span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob"> ext)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> output-file
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (member (file-name-extension output-file) org-view-external-file-extensions)
            (browse-url-xdg-open output-file)
          (pop-to-buffer (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (find-buffer-visiting output-file)
                             (find-file-noselect output-file))))
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"No exported file found"</span><span class="ef-ob">))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-view-output-file-extensions</span><span class="ef-ob"> '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"pdf"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"md"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"rst"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"txt"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"tex"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"html"</span><span class="ef-ob">)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Search for output files with these extensions, in order, viewing the first that matches"</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-view-external-file-extensions</span><span class="ef-ob"> '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"html"</span><span class="ef-ob">)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"File formats that should be opened externally."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Super agenda</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Org Super Agenda")</span>

The agenda is nice, but a souped up version is nicer.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-super-agenda </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"fb20ad9c8a9705aa05d40751682beae2d094e0fe"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! org-super-agenda
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> org-super-agenda-mode)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> org-agenda
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((inhibit-message t))
    (org-super-agenda-mode)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-agenda-skip-scheduled-if-done t
      org-agenda-skip-deadline-if-done t
      org-agenda-include-deadlines t
      org-agenda-block-separator nil
      org-agenda-tags-column 100 </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">from testing this seems to be a good value
</span><span class="ef-ob">      org-agenda-compact-blocks t)

(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-agenda-custom-commands
      '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"o"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Overview"</span><span class="ef-ob">
         ((agenda </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> ((org-agenda-span 'day)
                      (org-super-agenda-groups
                       '((</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Today"</span>
                          <span style="color: #a626a4; background-color: #e7e7e7;">:time-grid</span><span class="ef-ob"> t
                          </span><span style="color: #a626a4; background-color: #e7e7e7;">:date</span><span class="ef-ob"> today
                          </span><span style="color: #a626a4; background-color: #e7e7e7;">:todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"TODAY"</span>
                          <span style="color: #a626a4; background-color: #e7e7e7;">:scheduled</span><span class="ef-ob"> today
                          </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 1)))))
          (alltodo </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> ((org-agenda-overriding-header </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
                       (org-super-agenda-groups
                        '((</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Next to do"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"NEXT"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 1)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Important"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Important"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:priority</span> <span style="color: #50a14f; background-color: #e7e7e7;">"A"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 6)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Due Today"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:deadline</span><span class="ef-ob"> today
                           </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 2)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Due Soon"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:deadline</span><span class="ef-ob"> future
                           </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 8)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Overdue"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:deadline</span><span class="ef-ob"> past
                           </span><span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> error
                           </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 7)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Assignments"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Assignment"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 10)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Issues"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Issue"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 12)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Emacs"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Emacs"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 13)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Projects"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Project"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 14)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Research"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Research"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 15)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"To read"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Read"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 30)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Waiting"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"WAITING"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 20)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"University"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span> <span style="color: #50a14f; background-color: #e7e7e7;">"uni"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 32)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Trivial"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:priority&lt;=</span> <span style="color: #50a14f; background-color: #e7e7e7;">"E"</span>
                           <span style="color: #a626a4; background-color: #e7e7e7;">:tag</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Trivial"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Unimportant"</span><span class="ef-ob">)
                           </span><span style="color: #a626a4; background-color: #e7e7e7;">:todo</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"SOMEDAY"</span><span class="ef-ob"> )
                           </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 90)
                          (</span><span style="color: #a626a4; background-color: #e7e7e7;">:discard</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:tag</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Chore"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Routine"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Daily"</span><span class="ef-ob">)))))))))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Capture</span>

Let's setup some org-capture templates, and make them visually nice to access.

<span style="color: #84888b;">#+attr_html: :class invertible :alt My org-capture dialouge.</span>
<span style="color: #4078f2; font-weight: 700;">[[https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/org-capture.png]]</span>

<span style="color: #84888b;">~doct~</span> (Declarative Org Capture Templates) seems to be a nicer way to
set up org-capture.
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> doct
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"progfolio/doct"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"5cab660dab653ad88c07b0493360252f6ed1d898"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! doct
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> doct)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> org-capture
  &lt;&lt;prettify-capture&gt;&gt;

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+doct-icon-declaration-to-icon</span><span class="ef-ob"> (declaration)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Convert :icon declaration to icon"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((name (</span><span style="color: #e45649; background-color: #e7e7e7;">pop</span><span class="ef-ob"> declaration))
          (set  (intern (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"nerd-icons-"</span><span class="ef-ob"> (plist-get declaration </span><span style="color: #a626a4; background-color: #e7e7e7;">:set</span><span class="ef-ob">))))
          (face (intern (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"nerd-icons-"</span><span class="ef-ob"> (plist-get declaration </span><span style="color: #a626a4; background-color: #e7e7e7;">:color</span><span class="ef-ob">))))
          (v-adjust (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get declaration </span><span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob">) 0.01)))
      (apply set `(,name </span><span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> ,face </span><span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob"> ,v-adjust))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+doct-iconify-capture-templates</span><span class="ef-ob"> (groups)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Add declaration's :icon to each template group in GROUPS."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((templates (doct-flatten-lists-in groups)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doct-templates (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (template)
                                     (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let*</span><span class="ef-ob"> ((props (nthcdr (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= (length template) 4) 2 5) template))
                                                 (spec (plist-get (plist-get props </span><span style="color: #a626a4; background-color: #e7e7e7;">:doct</span><span class="ef-ob">) </span><span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob">)))
                                       (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> (nth 1 template) (concat (+doct-icon-declaration-to-icon spec)
                                                                      </span><span style="color: #50a14f; background-color: #e7e7e7;">"\t"</span><span class="ef-ob">
                                                                      (nth 1 template))))
                                     template)
                                   templates))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doct-after-conversion-functions '(+doct-iconify-capture-templates))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-capture-recipies</span>  <span style="color: #50a14f; background-color: #e7e7e7;">"~/Desktop/TEC/Organisation/recipies.org"</span><span class="ef-ob">)

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">set-org-capture-templates</span><span class="ef-ob"> ()
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-capture-templates
          (doct `((</span><span style="color: #50a14f; background-color: #e7e7e7;">"Personal todo"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-checklist"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"octicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"green"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-todo-file
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> t
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:headline</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Inbox"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> entry
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"* TODO %?"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%i %a"</span><span class="ef-ob">))
                  (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Personal note"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-sticky_note_o"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"green"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-todo-file
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> t
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:headline</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Inbox"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> entry
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"* %?"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%i %a"</span><span class="ef-ob">))
                  (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Email"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-envelope"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"blue"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-todo-file
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> t
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:headline</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Inbox"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> entry
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"* TODO %^{type|reply to|contact} %\\3 %? :email:"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"Send an email %^{urgancy|soon|ASAP|anon|at some point|eventually} to %^{recipiant}"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"about %^{topic}"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%U %i %a"</span><span class="ef-ob">))
                  (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Interesting"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"i"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-eye"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lcyan"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-todo-file
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> t
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:headline</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Interesting"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> entry
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"* [ ] %{desc}%? :%{i-type}:"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%i %a"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:children</span><span class="ef-ob"> ((</span><span style="color: #50a14f; background-color: #e7e7e7;">"Webpage"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"w"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-globe"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"green"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%(org-cliplink-capture) "</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:i-type</span> <span style="color: #50a14f; background-color: #e7e7e7;">"read:web"</span><span class="ef-ob">)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Article"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"a"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-file_text_o"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"yellow"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:i-type</span> <span style="color: #50a14f; background-color: #e7e7e7;">"read:reaserch"</span><span class="ef-ob">)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\tRecipie"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"r"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-spoon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"dorange"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-recipies
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:headline</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Unsorted"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:template</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%(org-chef-get-recipe-from-url)"</span><span class="ef-ob">)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Information"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"i"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-info_circle"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"blue"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:i-type</span> <span style="color: #50a14f; background-color: #e7e7e7;">"read:info"</span><span class="ef-ob">)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Idea"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"I"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-md-chart_bubble"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"mdicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"silver"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:desc</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:i-type</span> <span style="color: #50a14f; background-color: #e7e7e7;">"idea"</span><span class="ef-ob">)))
                  (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Tasks"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"k"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-inbox"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"octicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"yellow"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-todo-file
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> t
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:headline</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Tasks"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> entry
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"* TODO %? %^G%{extra}"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%i %a"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:children</span><span class="ef-ob"> ((</span><span style="color: #50a14f; background-color: #e7e7e7;">"General Task"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"k"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-inbox"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"octicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"yellow"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:extra</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Task with deadline"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"d"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-md-timer"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"mdicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"orange"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob"> -0.1)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:extra</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\nDEADLINE: %^{Deadline:}t"</span><span class="ef-ob">)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Scheduled Task"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"s"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-calendar"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"octicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"orange"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:extra</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\nSCHEDULED: %^{Start time:}t"</span><span class="ef-ob">)))
                  (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Project"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"p"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-repo"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"octicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"silver"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> t
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> entry
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:headline</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Inbox"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"* %{time-or-todo} %?"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%i"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%a"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:file</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:custom</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:time-or-todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:children</span><span class="ef-ob"> ((</span><span style="color: #50a14f; background-color: #e7e7e7;">"Project-local todo"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-checklist"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"octicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"green"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:time-or-todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"TODO"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-project-todo-file)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Project-local note"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-sticky_note"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"yellow"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:time-or-todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%U"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-project-notes-file)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Project-local changelog"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"c"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:icon</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-list"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:set</span> <span style="color: #50a14f; background-color: #e7e7e7;">"faicon"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:color</span> <span style="color: #50a14f; background-color: #e7e7e7;">"blue"</span><span class="ef-ob">)
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:time-or-todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%U"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:heading</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Unreleased"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-project-changelog-file)))
                  (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\tCentralised project templates"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"o"</span>
                   <span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob"> entry
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> t
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:template</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"* %{time-or-todo} %?"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%i"</span>
                              <span style="color: #50a14f; background-color: #e7e7e7;">"%a"</span><span class="ef-ob">)
                   </span><span style="color: #a626a4; background-color: #e7e7e7;">:children</span><span class="ef-ob"> ((</span><span style="color: #50a14f; background-color: #e7e7e7;">"Project todo"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:prepend</span><span class="ef-ob"> nil
                               </span><span style="color: #a626a4; background-color: #e7e7e7;">:time-or-todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"TODO"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:heading</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Tasks"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-central-project-todo-file)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Project note"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:time-or-todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%U"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:heading</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Notes"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-central-project-notes-file)
                              (</span><span style="color: #50a14f; background-color: #e7e7e7;">"Project changelog"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:keys</span> <span style="color: #50a14f; background-color: #e7e7e7;">"c"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:time-or-todo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%U"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:heading</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Unreleased"</span>
                               <span style="color: #a626a4; background-color: #e7e7e7;">:file</span><span class="ef-ob"> +org-capture-central-project-changelog-file)))))))

  (set-org-capture-templates)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (display-graphic-p)
    (add-hook 'server-after-make-frame-hook
              (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-capture-reinitialise-hook</span><span class="ef-ob"> ()
                (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (display-graphic-p)
                  (set-org-capture-templates)
                  (remove-hook 'server-after-make-frame-hook
                               #'org-capture-reinitialise-hook))))))
</span><span class="ef-obe">#+end_src
</span>It would also be nice to improve how the capture dialogue looks
<span style="color: #84888b;">#+name: prettify-capture</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-capture-select-template-prettier</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> keys)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Select a capture template, in a prettier way than default
Lisp programs can force the template by setting KEYS to a string."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((org-capture-templates
         (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (org-contextualize-keys
              (org-capture-upgrade-templates org-capture-templates)
              org-capture-templates-contexts)
             '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"t"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Task"</span><span class="ef-ob"> entry (file+headline </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Tasks"</span><span class="ef-ob">)
                </span><span style="color: #50a14f; background-color: #e7e7e7;">"* TODO %?\n  %u\n  %a"</span><span class="ef-ob">)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> keys
        (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (assoc keys org-capture-templates)
            (</span><span style="color: #986801; background-color: #e7e7e7;">error</span> <span style="color: #50a14f; background-color: #e7e7e7;">"No capture template referred to by \"%s\" keys"</span><span class="ef-ob"> keys))
      (org-mks org-capture-templates
               </span><span style="color: #50a14f; background-color: #e7e7e7;">"Select a capture template\n━━━━━━━━━━━━━━━━━━━━━━━━━"</span>
               <span style="color: #50a14f; background-color: #e7e7e7;">"Template key: "</span><span class="ef-ob">
               `((</span><span style="color: #50a14f; background-color: #e7e7e7;">"q"</span><span class="ef-ob"> ,(concat (nerd-icons-octicon </span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-oct-stop"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> 'nerd-icons-red </span><span style="color: #a626a4; background-color: #e7e7e7;">:v-adjust</span><span class="ef-ob"> 0.01) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\tAbort"</span><span class="ef-ob">)))))))
(advice-add 'org-capture-select-template </span><span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'org-capture-select-template-prettier)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-mks-pretty</span><span class="ef-ob"> (table title </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> prompt specials)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Select a member of an alist with multiple keys. Prettified.

TABLE is the alist which should contain entries where the car is a string.
There should be two types of entries.

1. prefix descriptions like (\"a\" \"Description\")
   This indicates that `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">a</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' is a prefix key for multi-letter selection, and
   that there are entries following with keys like \"ab\", \"ax\"…

2. Select-able members must have more than two elements, with the first
   being the string of keys that lead to selecting it, and the second a
   short description string of the item.

The command will then make a temporary buffer listing all entries
that can be selected with a single key, and all the single key
prefixes.  When you press the key for a single-letter entry, it is selected.
When you press a prefix key, the commands (and maybe further prefixes)
under this key will be shown and offered for selection.

TITLE will be placed over the selection in the temporary buffer,
PROMPT will be used when prompting for a key.  SPECIALS is an
alist with (\"key\" \"description\") entries.  When one of these
is selected, only the bare key is returned."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">save-window-excursion</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((inhibit-quit t)
          (buffer (org-switch-to-buffer-other-window </span><span style="color: #50a14f; background-color: #e7e7e7;">"*Org Select*"</span><span class="ef-ob">))
          (prompt (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> prompt </span><span style="color: #50a14f; background-color: #e7e7e7;">"Select: "</span><span class="ef-ob">))
          case-fold-search
          current)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unwind-protect</span><span class="ef-ob">
          (</span><span style="color: #e45649; background-color: #e7e7e7;">catch</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob">
            (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> t
              (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> evil-normal-state-cursor (list nil))
              (erase-buffer)
              (insert title </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n"</span><span class="ef-ob">)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((des-keys nil)
                    (allowed-keys '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"\C-g"</span><span class="ef-ob">))
                    (tab-alternatives '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"\s"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\t"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\r"</span><span class="ef-ob">))
                    (cursor-type nil))
                </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Populate allowed keys and descriptions keys
</span>                <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">available with CURRENT selector.
</span><span class="ef-ob">                (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((re (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`%s</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">\\'"</span><span class="ef-ob">
                                  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> current (regexp-quote current) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)))
                      (prefix (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> current (concat current </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (entry table)
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> entry
                      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Description.
</span><span class="ef-ob">                      (`(,(</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> key (pred (string-match re))) ,desc)
                       (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((k (match-string 1 key)))
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> k des-keys)
                         </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Keys ending in tab, space or RET are equivalent.
</span><span class="ef-ob">                         (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (member k tab-alternatives)
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\t"</span><span class="ef-ob"> allowed-keys)
                           (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> k allowed-keys))
                         (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"›"</span><span class="ef-ob"> 'face 'font-lock-comment-face) </span><span style="color: #50a14f; background-color: #e7e7e7;">"  "</span><span class="ef-ob"> desc </span><span style="color: #50a14f; background-color: #e7e7e7;">"…"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)))
                      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Usable entry.
</span><span class="ef-ob">                      (`(,(</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> key (pred (string-match re))) ,desc . ,_)
                       (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((k (match-string 1 key)))
                         (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) </span><span style="color: #50a14f; background-color: #e7e7e7;">"   "</span><span class="ef-ob"> desc </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> k allowed-keys)))
                      (_ nil))))
                </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Insert special entries, if any.
</span><span class="ef-ob">                (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> specials
                  (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"─────────────────────────\n"</span><span class="ef-ob">)
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase-dolist</span><span class="ef-ob"> (`(,key ,description) specials)
                    (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s   %s\n"</span><span class="ef-ob"> (propertize key 'face '(bold nerd-icons-red)) description))
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> key allowed-keys)))
                </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Display UI and let user select an entry or
</span>                <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">a sub-level prefix.
</span><span class="ef-ob">                (goto-char (point-min))
                (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (pos-visible-in-window-p (point-max))
                  (org-fit-window-to-buffer))
                (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((pressed (org--mks-read-key allowed-keys
                                                  prompt
                                                  (not (pos-visible-in-window-p (1- (point-max)))))))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> current (concat current pressed))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
                   ((equal pressed </span><span style="color: #50a14f; background-color: #e7e7e7;">"\C-g"</span><span class="ef-ob">) (</span><span style="color: #986801; background-color: #e7e7e7;">user-error</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Abort"</span><span class="ef-ob">))
                   </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Selection is a prefix: open a new menu.
</span><span class="ef-ob">                   ((member pressed des-keys))
                   </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Selection matches an association: return it.
</span><span class="ef-ob">                   ((</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((entry (assoc current table)))
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> entry (</span><span style="color: #e45649; background-color: #e7e7e7;">throw</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob"> entry))))
                   </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Selection matches a special entry: return the
</span>                   <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">selection prefix.
</span><span class="ef-ob">                   ((assoc current specials) (</span><span style="color: #e45649; background-color: #e7e7e7;">throw</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">exit</span><span class="ef-ob"> current))
                   (t (</span><span style="color: #986801; background-color: #e7e7e7;">error</span> <span style="color: #50a14f; background-color: #e7e7e7;">"No entry available"</span><span class="ef-ob">)))))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> buffer (kill-buffer buffer))))))
(advice-add 'org-mks </span><span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'org-mks-pretty)
</span><span class="ef-obe">#+end_src
</span>The <span style="color: #4078f2; font-weight: 700;">[[file:~/.config/emacs/bin/org-capture][org-capture bin]]</span> is rather nice, but I'd be nicer with a smaller frame, and
no modeline.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> (alist-get 'height +org-capture-frame-parameters) 15)
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(alist-get 'name +org-capture-frame-parameters) "❖ Capture") ;; ATM hardcoded in other places, so changing breaks stuff
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +org-capture-fn
      (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> ()
        (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
        (set-window-parameter nil 'mode-line-format 'none)
        (org-capture)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Roam</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-roam", after="org-roam")</span>

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Basic settings</span>

I'll just set this to be within <span style="color: #84888b;">=Organisation=</span> folder for now, in the future it
could be worth seeing if I could hook this up to a <span style="color: #4078f2; font-weight: 700;">[[https://nextcloud.com/][Nextcloud]]</span> instance.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-roam-directory </span><span style="color: #50a14f; background-color: #e7e7e7;">"~/Desktop/TEC/Organisation/Roam/"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
That said, if the directory doesn't exist we likely don't want to be using roam.
Since we don't want to trigger errors (which will happen as soon as roam tries
to initialise), let's not load roam.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none :tangle (if (file-exists-p "~/Desktop/TEC/Organisation/Roam/") "no" "packages.el")
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-roam </span><span style="color: #a626a4; background-color: #e7e7e7;">:disable</span><span class="ef-ob"> t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Modeline file name</span>

All those numbers! It's messy. Let's adjust this in a similar way that I have in
the <span style="color: #4078f2; font-weight: 700;">[[*Window title][Window title]]</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> doom-modeline--buffer-file-name-roam-aware-a (orig-fun)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'doom-modeline-buffer-file-name </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">takes no args
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-match-p (regexp-quote org-roam-directory) (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> buffer-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
      (replace-regexp-in-string
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">^</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">.*/</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9]\\{</span><span style="color: #6a1868; background-color: #e7e7e7;">4\\</span><span style="color: #50a14f; background-color: #e7e7e7;">}</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9]\\{</span><span style="color: #6a1868; background-color: #e7e7e7;">2\\</span><span style="color: #50a14f; background-color: #e7e7e7;">}</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9]\\{</span><span style="color: #6a1868; background-color: #e7e7e7;">2\\</span><span style="color: #50a14f; background-color: #e7e7e7;">}</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9]*-"</span>
       <span style="color: #50a14f; background-color: #e7e7e7;">"🢔(\\1-\\2-\\3) "</span><span class="ef-ob">
       (subst-char-in-string ?_ ?  buffer-file-name))
    (funcall orig-fun)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Graph view</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-roam-ui")</span>

Org-roam is nice by itself, but there are so <span style="text-decoration: italic;">/extra/</span> nice packages which integrate
with it.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> org-roam-ui </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"org-roam/org-roam-ui"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"out"</span><span class="ef-ob">)) </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"5ac74960231db0bf7783c2ba7a19a60f582e91ab"</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> websocket </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"40c208eaab99999d7c1e4bea883648da24c03be3"</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">dependency of `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-roam-ui</span><span style="color: #84888b; background-color: #e7e7e7;">'
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! websocket
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org-roam)

(use-package! org-roam-ui
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> org-roam
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> org-roam-ui-open
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (org-roam . org-roam-ui-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org-roam</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">in case autoloaded
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-roam-ui-open</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Ensure the server is active, then open the roam graph."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> org-roam-ui-mode (org-roam-ui-mode 1))
    (browse-url-xdg-open (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"http://localhost:%d"</span><span class="ef-ob"> org-roam-ui-port))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Nicer </span><span style="color: #84888b; font-weight: 600; font-size: 1.09em">~org-return~</span>

Once again, from <span style="color: #4078f2; font-weight: 700;">[[https://github.com/alphapapa/unpackaged.el#org-return-dwim][unpackaged.el]]</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">unpackaged/org-element-descendant-of</span><span class="ef-ob"> (type element)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return non-nil if ELEMENT is a descendant of TYPE.
TYPE should be an element type, like `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">item</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' or `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">paragraph</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.
ELEMENT should be a list like that returned by `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-element-context</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">MAYBE: Use `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-element-lineage</span><span style="color: #84888b; background-color: #e7e7e7;">'.
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let*</span><span class="ef-ob"> ((parent (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parent</span><span class="ef-ob"> element)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (eq type (car parent))
        (unpackaged/org-element-descendant-of type parent))))

</span><span style="color: #84888b; background-color: #e7e7e7;">;;;</span><span style="color: #84888b; background-color: #e7e7e7;">###</span><span style="color: #986801; background-color: #e7e7e7;">autoload</span>
<span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">unpackaged/org-return-dwim</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> default)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A helpful replacement for `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-return-indent</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.  With prefix, call `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-return-indent</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.

On headings, move point to position after entry content.  In
lists, insert a new item or end the list, with checkbox if
appropriate.  In tables, insert a new row or end the table."</span>
  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Inspired by John Kitchin: http://kitchingroup.cheme.cmu.edu/blog/2017/04/09/A-better-return-in-org-mode/
</span><span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span> <span style="color: #50a14f; background-color: #e7e7e7;">"P"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> default
      (org-return t)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span>
     <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Act depending on context around point.
</span>
     <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">NOTE: I prefer RET to not follow links, but by uncommenting this block, links will be
</span>     <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">followed.
</span>
     <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">((eq 'link (car (org-element-context)))
</span>     <span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">;; Link: Open it.
</span>     <span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">(org-open-at-point-global))
</span><span class="ef-ob">
     ((org-at-heading-p)
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Heading: Move to position after entry content.
</span>      <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">NOTE: This is probably the most interesting feature of this function.
</span><span class="ef-ob">      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((heading-start (org-entry-beginning-position)))
        (goto-char (org-entry-end-position))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (org-at-heading-p)
                    (= heading-start (org-entry-beginning-position)))
               </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Entry ends on its heading; add newline after
</span><span class="ef-ob">               (end-of-line)
               (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n\n"</span><span class="ef-ob">))
              (t
               </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Entry ends after its heading; back up
</span><span class="ef-ob">               (forward-line -1)
               (end-of-line)
               (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-at-heading-p)
                 </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">At the same heading
</span><span class="ef-ob">                 (forward-line)
                 (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
                 (forward-line -1))
               (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (not (looking-back </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">[[:blank:]]?\n</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">\\{</span><span style="color: #6a1868; background-color: #e7e7e7;">3\\</span><span style="color: #50a14f; background-color: #e7e7e7;">}"</span><span class="ef-ob"> nil))
                 (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
               (forward-line -1)))))

     ((org-at-item-checkbox-p)
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Checkbox: Insert new item with checkbox.
</span><span class="ef-ob">      (org-insert-todo-heading nil))

     ((org-in-item-p)
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Plain list.  Yes, this gets a little complicated...
</span><span class="ef-ob">      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((context (org-element-context)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (eq 'plain-list (car context))  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">First item in list
</span><span class="ef-ob">                (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (eq 'item (car context))
                     (not (eq (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:contents-begin</span><span class="ef-ob"> context)
                              (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:contents-end</span><span class="ef-ob"> context))))
                (unpackaged/org-element-descendant-of 'item context))  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Element in list item, e.g. a link
</span>            <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Non-empty item: Add new item.
</span><span class="ef-ob">            (org-insert-item)
          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Empty item: Close the list.
</span>          <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">TODO: Do this with org functions rather than operating on the text. Can't seem to find the right function.
</span><span class="ef-ob">          (delete-region (line-beginning-position) (line-end-position))
          (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))))

     ((</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (fboundp 'org-inlinetask-in-task-p)
        (org-inlinetask-in-task-p))
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Inline task: Don't insert a new heading.
</span><span class="ef-ob">      (org-return t))

     ((org-at-table-p)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
               (beginning-of-line)
               </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">See `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-table-next-field</span><span style="color: #84888b; background-color: #e7e7e7;">'.
</span><span class="ef-ob">               (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-loop</span><span class="ef-ob"> with end = (line-end-position)
                        for cell = (org-element-table-cell-parser)
                        always (equal (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:contents-begin</span><span class="ef-ob"> cell)
                                      (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:contents-end</span><span class="ef-ob"> cell))
                        while (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"|"</span><span class="ef-ob"> end t)))
             </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Empty row: end the table.
</span><span class="ef-ob">             (delete-region (line-beginning-position) (line-end-position))
             (org-return t))
            (t
             </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Non-empty row: call `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-return-indent</span><span style="color: #84888b; background-color: #e7e7e7;">'.
</span><span class="ef-ob">             (org-return t))))
     (t
      </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">All other cases: call `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-return-indent</span><span style="color: #84888b; background-color: #e7e7e7;">'.
</span><span class="ef-ob">      (org-return t)))))

(map!
 </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> evil-org
 </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> evil-org-mode-map
 </span><span style="color: #a626a4; background-color: #e7e7e7;">:i</span><span class="ef-ob"> [return] #'unpackaged/org-return-dwim)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Snippet Helpers</span>

I often want to set <span style="color: #84888b;">=src-block=</span> headers, and it's a pain to
+ type them out
+ remember what the accepted values are
+ oh, and specifying the same language again and again

We can solve this in three steps
+ having one-letter snippets, conditioned on <span style="color: #84888b;">~(point)~</span> being within a src header
+ creating a nice prompt showing accepted values and the current default
+ pre-filling the <span style="color: #84888b;">=src-block=</span> language with the last language used

For header args, the keys I'll use are
+ <span style="color: #84888b;">=r=</span> for <span style="color: #84888b;">=:results=</span>
+ <span style="color: #84888b;">=e=</span> for <span style="color: #84888b;">=:exports=</span>
+ <span style="color: #84888b;">=v=</span> for <span style="color: #84888b;">=:eval=</span>
+ <span style="color: #84888b;">=s=</span> for <span style="color: #84888b;">=:session=</span>
+ <span style="color: #84888b;">=d=</span> for <span style="color: #84888b;">=:dir=</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+yas/org-src-header-p</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Determine whether `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">point</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' is within a src-block header or header-args."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (org-element-type (org-element-context))
    ('src-block (&lt; (point) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">before code part of the src-block
</span><span class="ef-ob">                   (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob"> (goto-char (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:begin</span><span class="ef-ob"> (org-element-context)))
                                   (forward-line 1)
                                   (point))))
    ('inline-src-block (&lt; (point) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">before code part of the inline-src-block
</span><span class="ef-ob">                          (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob"> (goto-char (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:begin</span><span class="ef-ob"> (org-element-context)))
                                          (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"]{"</span><span class="ef-ob">)
                                          (point))))
    ('keyword (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"^header-args"</span><span class="ef-ob"> (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> (org-element-context))))))
</span><span class="ef-obe">#+end_src
</span>
Now let's write a function we can reference in yasnippets to produce a nice
interactive way to specify header args.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+yas/org-prompt-header-arg</span><span class="ef-ob"> (arg question values)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Prompt the user to set ARG header property to one of VALUES with QUESTION.
The default value is identified and indicated. If either default is selected,
or no selection is made: nil is returned."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((src-block-p (not (looking-back </span><span style="color: #50a14f; background-color: #e7e7e7;">"^#\\+property:[ \t]+header-args:.*"</span><span class="ef-ob"> (line-beginning-position))))
         (default
           (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob">
            (cdr (assoc arg
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> src-block-p
                            (nth 2 (org-babel-get-src-block-info t))
                          (org-babel-merge-params
                           org-babel-default-header-args
                           (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((lang-headers
                                  (intern (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"org-babel-default-header-args:"</span><span class="ef-ob">
                                                  (+yas/org-src-lang)))))
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (boundp lang-headers) (eval lang-headers t)))))))
            </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
         default-value)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> values (mapcar
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (value)
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-match-p (regexp-quote value) default)
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> default-value
                              (concat value </span><span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob">
                                      (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"(default)"</span><span class="ef-ob"> 'face 'font-lock-doc-face)))
                      value))
                  values))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((selection (consult--read values </span><span style="color: #a626a4; background-color: #e7e7e7;">:prompt</span><span class="ef-ob"> question </span><span style="color: #a626a4; background-color: #e7e7e7;">:default</span><span class="ef-ob"> default-value)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"(default)$"</span><span class="ef-ob"> selection)
                  (string= </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> selection))
        selection))))
</span><span class="ef-obe">#+end_src
</span>
Finally, we fetch the language information for new source blocks.

Since we're getting this info, we might as well go a step further and also
provide the ability to determine the most popular language in the buffer that
doesn't have any <span style="color: #84888b;">=header-args=</span> set for it (with <span style="color: #84888b;">=#+properties=</span>).

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+yas/org-src-lang</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Try to find the current language of the src/header at `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">point</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.
Return nil otherwise."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((context (org-element-context)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (org-element-type context)
      ('src-block (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob"> context))
      ('inline-src-block (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob"> context))
      ('keyword (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"^header-args:</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;"> ]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> context))
                  (match-string 1 (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> context)))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+yas/org-last-src-lang</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return the language of the last src-block, if it exists."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
    (beginning-of-line)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (re-search-backward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_src"</span><span class="ef-ob"> nil t)
      (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob"> (org-element-context)))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+yas/org-most-common-no-property-lang</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Find the lang with the most source blocks that has no global header-args, else nil."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (src-langs header-langs)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
      (goto-char (point-min))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_src"</span><span class="ef-ob"> nil t)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (+yas/org-src-lang) src-langs))
      (goto-char (point-min))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+property: +header-args"</span><span class="ef-ob"> nil t)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (+yas/org-src-lang) header-langs)))

    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> src-langs
          (mapcar #'car
                  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">sort alist by frequency (desc.)
</span><span class="ef-ob">                  (sort
                   </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">generate alist with form (value . frequency)
</span><span class="ef-ob">                   (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-loop</span><span class="ef-ob"> for (n . m) in (seq-group-by #'identity src-langs)
                            collect (cons n (length m)))
                   (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (a b) (&gt; (cdr a) (cdr b))))))

    (car (cl-set-difference src-langs header-langs </span><span style="color: #a626a4; background-color: #e7e7e7;">:test</span><span class="ef-ob"> #'string=))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Translate capital keywords (old) to lower case (new)</span>

Everyone used to use <span style="color: #84888b;">~#+CAPITAL~</span> keywords. Then people realised that <span style="color: #84888b;">~#+lowercase~</span>
is actually both marginally easier and visually nicer, so now the capital
version is just used in the manual.
<span class="ef-obb">#+begin_quote
</span>Org is standardized on lower case. Uppercase is used in the manual as a poor
man's bold, and supported for historical reasons. --- <span style="color: #4078f2; font-weight: 700;">[[https://orgmode.org/list/87tuuw3n15.fsf@nicolasgoaziou.fr][Nicolas Goaziou on the Org ML]]</span>
<span class="ef-obe">#+end_quote
</span>
To avoid sometimes having to choose between the hassle out of updating old
documents and using mixed syntax, I'll whip up a basic transcode-y function.
It likely misses some edge cases, but should mostly work.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-syntax-convert-keyword-case-to-lower</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Convert all #+KEYWORDS to #+keywords."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
    (goto-char (point-min))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((count 0)
          (case-fold-search nil))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+[A-Z_]+"</span><span class="ef-ob"> nil t)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"RESULTS"</span><span class="ef-ob"> (match-string 0))
          (replace-match (downcase (match-string 0)) t)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> count (1+ count))))
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Replaced %d occurances"</span><span class="ef-ob"> count))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Extra links</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** xkcd</span>

Because xkcd is cool, let's make it as easy and fun as possible to insert them.
Saving seconds adds up after all! (but only so much)

<span style="color: #4078f2; font-weight: 700;">[[xkcd:1205]]</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(org-link-set-parameters </span><span style="color: #50a14f; background-color: #e7e7e7;">"xkcd"</span>
                         <span style="color: #a626a4; background-color: #e7e7e7;">:image-data-fun</span><span class="ef-ob"> #'+org-xkcd-image-fn
                         </span><span style="color: #a626a4; background-color: #e7e7e7;">:follow</span><span class="ef-ob"> #'+org-xkcd-open-fn
                         </span><span style="color: #a626a4; background-color: #e7e7e7;">:export</span><span class="ef-ob"> #'+org-xkcd-export
                         </span><span style="color: #a626a4; background-color: #e7e7e7;">:complete</span><span class="ef-ob"> #'+org-xkcd-complete)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-xkcd-open-fn</span><span class="ef-ob"> (link)
  (+org-xkcd-image-fn nil link nil))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-xkcd-image-fn</span><span class="ef-ob"> (protocol link description)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Get image data for xkcd num LINK"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((xkcd-info (+xkcd-fetch-info (string-to-number link)))
         (img (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:img</span><span class="ef-ob">))
         (alt (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:alt</span><span class="ef-ob">)))
    (message alt)
    (+org-image-file-data-fn protocol (xkcd-download img (string-to-number link)) description)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-xkcd-export</span><span class="ef-ob"> (num desc backend _com)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Convert xkcd to html/LaTeX form"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((xkcd-info (+xkcd-fetch-info (string-to-number num)))
         (img (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:img</span><span class="ef-ob">))
         (alt (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:alt</span><span class="ef-ob">))
         (title (plist-get xkcd-info </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">))
         (file (xkcd-download img (string-to-number num))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((org-export-derived-backend-p backend 'html)
           (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;img class='</span><span style="color: #b751b6; background-color: #e7e7e7;">invertible</span><span style="color: #50a14f; background-color: #e7e7e7;">' src='</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' title=\"%s\" alt='</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;"</span><span class="ef-ob"> img (subst-char-in-string ?\" ?</span><span style="color: #986801; background-color: #e7e7e7;">“</span><span class="ef-ob"> alt) title))
          ((org-export-derived-backend-p backend 'latex)
           (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\begin{figure}[!htb]
  \\centering
  \\includegraphics[scale=0.4]{%s}%s
\\end{figure}"</span><span class="ef-ob"> file (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (equal desc (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"xkcd:%s"</span><span class="ef-ob"> num)) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">
                      (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n  \\caption*{\\label{xkcd:%s} %s}"</span><span class="ef-ob">
                              num
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> desc
                                  (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\textbf{%s} %s"</span><span class="ef-ob"> title alt))))))
          (t (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://xkcd.com/%s"</span><span class="ef-ob"> num)))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-xkcd-complete</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> arg)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Complete xkcd using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+xkcd-stored-info</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span><span class="ef-ob">
  (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"xkcd:%d"</span><span class="ef-ob"> (+xkcd-select)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** YouTube</span>

The <span style="color: #84888b;">~</span><span style="color: #84888b; font-weight: 700;">[[yt:...]]</span><span style="color: #84888b;">~</span> links preview nicely, but don't export nicely. Thankfully, we can
fix that.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(org-link-set-parameters </span><span style="color: #50a14f; background-color: #e7e7e7;">"yt"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:export</span><span class="ef-ob"> #'+org-export-yt)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-export-yt</span><span class="ef-ob"> (path desc backend _com)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((org-export-derived-backend-p backend 'html)
         (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;iframe width='</span><span style="color: #b751b6; background-color: #e7e7e7;">440</span><span style="color: #50a14f; background-color: #e7e7e7;">' \
height='</span><span style="color: #b751b6; background-color: #e7e7e7;">335</span><span style="color: #50a14f; background-color: #e7e7e7;">' \
src='</span><span style="color: #b751b6; background-color: #e7e7e7;">https://www.youtube.com/embed/%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' \
frameborder='</span><span style="color: #b751b6; background-color: #e7e7e7;">0</span><span style="color: #50a14f; background-color: #e7e7e7;">' \
allowfullscreen&gt;%s&lt;/iframe&gt;"</span><span class="ef-ob"> path (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> desc)))
        ((org-export-derived-backend-p backend 'latex)
         (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\href{https://youtu.be/%s}{%s}"</span><span class="ef-ob"> path (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> desc </span><span style="color: #50a14f; background-color: #e7e7e7;">"youtube"</span><span class="ef-ob">)))
        (t (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://youtu.be/%s"</span><span class="ef-ob"> path))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Fix problematic hooks</span>

When one of the <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">org-mode-hook</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> functions errors, it halts the hook
execution. This is problematic, and there are two hooks in particular which
cause issues. Let's make their failure less eventful.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> shut-up-org-problematic-hooks (orig-fn </span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> args)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-fancy-priorities-mode
  (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (apply orig-fn args)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Flycheck with org-lint</span>

<span style="color: #84888b;">#+call: confpkg("Flycheck org-lint", after=["org" "flycheck"])</span>

Org may be simple, but that doesn't mean there's no such thing as malformed Org.
Thankfully, malformed Org is a much less annoying affair than malformed zipped
XML (looks at DOCX/ODT...), particularly because there's a rather helpful little
tool called <span style="color: #84888b;">~org-lint~</span> bundled with Org that can tell you about your mistakes.

<span style="color: #4078f2; font-weight: 700;">[[xkcd:2109]]</span>

Flycheck doesn't currently support Org, and there's aren't any packages to do so
☹. However, in an issue on <span style="color: #84888b;">~org-lint~</span> there is <span style="color: #4078f2; font-weight: 700;">[[https://github.com/flycheck/flycheck/issues/1757#issuecomment-759546940][some code]]</span> which apparently works.
Surely this is what the clipboard was invented for? With that said, let's
regurgitate the code, cross our fingers, and hope it works.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defconst</span> <span style="color: #6a1868; background-color: #e7e7e7;">flycheck-org-lint-form</span><span class="ef-ob">
  (flycheck-prepare-emacs-lisp-form
    (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org-lint</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org-attach</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((source (car command-line-args-left))
          (process-default-directory default-directory))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
        (insert-file-contents source 'visit)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> buffer-file-name source)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> default-directory process-default-directory)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">delay-mode-hooks</span><span class="ef-ob"> (org-mode))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> delayed-mode-hooks nil)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (err (org-lint))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((inf (cl-second err)))
            (princ (elt inf 0))
            (princ </span><span style="color: #50a14f; background-color: #e7e7e7;">": "</span><span class="ef-ob">)
            (princ (elt inf 2))
            (terpri)))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defconst</span> <span style="color: #6a1868; background-color: #e7e7e7;">flycheck-org-lint-variables</span><span class="ef-ob">
  '(org-directory
    org-id-locations
    org-id-locations-file
    org-attach-id-dir
    org-attach-use-inheritance
    org-attach-id-to-path-function-list
    org-link-parameters)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Variables inherited by the org-lint subprocess."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defconst</span> <span style="color: #6a1868; background-color: #e7e7e7;">flycheck-org-lint-babel-langs</span><span class="ef-ob">
  '&lt;&lt;org-babel-list-langs()&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Languages that org-babel should know of."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">flycheck-org-lint-variables-form</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org-attach</span><span class="ef-ob">)  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Needed to make variables available
</span><span class="ef-ob">  `(</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
     ,@(seq-map (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (opt) `(</span><span style="color: #e45649; background-color: #e7e7e7;">setq-default</span><span class="ef-ob"> ,opt ',(symbol-value opt)))
                (seq-filter #'boundp flycheck-org-lint-variables))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">flycheck-org-lint-babel-langs-form</span><span class="ef-ob"> ()
  `(</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
     ,@(mapcar
        (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (lang)
          `(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span><span class="ef-ob"> ,(intern (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"org-babel-execute:%s"</span><span class="ef-ob"> lang)) (_body _params)
             </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Stub for org-lint."</span><span class="ef-ob">))
        flycheck-org-lint-babel-langs)))

(eval </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">To preveant eager macro expansion form loading flycheck early.
</span><span class="ef-ob"> '(flycheck-define-checker org-lint
   </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Org buffer checker using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-lint</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:command</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"emacs"</span><span class="ef-ob"> (eval flycheck-emacs-args)
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"--eval"</span><span class="ef-ob"> (eval (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"(add-to-list 'load-path \""</span><span class="ef-ob">
                                    (file-name-directory (locate-library </span><span style="color: #50a14f; background-color: #e7e7e7;">"org"</span><span class="ef-ob">))
                                    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\")"</span><span class="ef-ob">))
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"--eval"</span><span class="ef-ob"> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-variables-form)))
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"--eval"</span><span class="ef-ob"> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-customisations-form)))
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"--eval"</span><span class="ef-ob"> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-babel-langs-form)))
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"--eval"</span><span class="ef-ob"> (eval flycheck-org-lint-form)
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"--"</span><span class="ef-ob"> source)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:error-patterns</span><span class="ef-ob">
   ((</span><span style="color: #986801; background-color: #e7e7e7;">error</span><span class="ef-ob"> line-start line </span><span style="color: #50a14f; background-color: #e7e7e7;">": "</span><span class="ef-ob"> (message) line-end))
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:modes</span><span class="ef-ob"> org-mode))
</span><span class="ef-obe">#+end_src
</span>
Turns out it almost works. Running <span style="color: #84888b;">=M-x flycheck-verify-setup=</span> after running that
snippet produces the following:
<span class="ef-obb">#+begin_example
</span><span class="ef-ob">The following syntax checkers are not registered:
  - org-lint
Try adding these syntax checkers to `flycheck-checkers'.
</span><span class="ef-obe">#+end_example
</span>
Well that's very nice and helpful. We'll just do that 🙂.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-to-list 'flycheck-checkers 'org-lint)
</span><span class="ef-obe">#+end_src
</span>
It was missing custom link types, but that's easily fixed just by adding
<span style="color: #84888b;">~org-link-parameters~</span> to <span style="color: #84888b;">~flycheck-org-lint-variables~</span>.

One remaining little annoyance is that it reports extra <span style="color: #84888b;">=#+options=</span> that I've
added to Org as errors. So we need to tell <span style="color: #84888b;">~org-lint~</span> about them without having it
load my whole config. Code duplication isn't great, but at least this isn't
much.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">flycheck-org-lint-customisations-form</span><span class="ef-ob"> ()
  `(</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
     (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">ox</span><span class="ef-ob">)
     (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-pushnew</span><span class="ef-ob"> '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-cover-page</span><span class="ef-ob"> nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"coverpage"</span><span class="ef-ob"> nil)
                 (org-export-backend-options (org-export-get-backend 'latex)))
     (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-pushnew</span><span class="ef-ob"> '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-font-set</span><span class="ef-ob"> nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"fontset"</span><span class="ef-ob"> nil)
                 (org-export-backend-options (org-export-get-backend 'latex)))))
</span><span class="ef-obe">#+end_src
</span>
A larger annoyance is that org-lint doesn't actually know what languages
org-babel should recognise, with Doom's lazy loading system. Since the list of
languages should really only change when packages are added/removed, we might as
well statically determine a list of all org-babel languages at configuration
generation time.

<span style="color: #84888b;">#+name: org-babel-list-langs</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (langs)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (dir load-path)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (file-directory-p dir)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (file (directory-files dir t </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.elc?$"</span><span class="ef-ob">))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((basename (file-name-base file)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-prefix-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"ob-"</span><span class="ef-ob"> basename)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob">
              (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> (intern basename) file t)))))))
  (mapatoms
   (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (symb)
     (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (functionp symb)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((name (symbol-name symb)))
         (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((fn (symbol-function symb)))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (symbolp fn)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> symb (symbol-function symb)
                   fn (symbol-function symb)))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string-suffix-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"-mode"</span><span class="ef-ob"> name)
                      (autoloadp fn))
             (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (autoload-do-load fn))))
         (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
          ((string-prefix-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"org-babel-execute:"</span><span class="ef-ob"> name)
           (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"^org-babel-execute:"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> name)
                 langs))
          ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string-suffix-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"-mode"</span><span class="ef-ob"> name)
                (provided-mode-derived-p
                 symb 'prog-mode 'text-mode 'conf-mode))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"-mode$"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> name)
                 langs))))))
   obarray)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (mode-mapping org-src-lang-modes)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (car mode-mapping) langs))
  (mapcar #'intern
          (sort (delete-dups langs) #'string&lt;)))
</span><span class="ef-obe">#+end_src
</span>
This increases the tangle time by about 10--20%, but I think it's worth it to be
extra thorough. If this really becomes a pain, we can always think about doing
some sort of cache file based on the load-path/packages installed.

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Visuals</span>

<span style="color: #84888b;">#+call: confpkg("Org Visuals", after="org")</span>

Here I try to do two things: improve the styling of the various documents, via
font changes etc, and also propagate colours from the current theme.

<span style="color: #4078f2; font-weight: 700;">[[xkcd:1882]]</span>

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Font Display</span>

Mixed pitch is great. As is <span style="color: #84888b;">~+org-pretty-mode~</span>, let's use them.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook 'org-mode-hook #'+org-pretty-mode)
</span><span class="ef-obe">#+end_src
</span>
Let's make headings a bit bigger
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(custom-set-faces!
  '(outline-1 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> extra-bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.25)
  '(outline-2 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.15)
  '(outline-3 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.12)
  '(outline-4 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> semi-bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.09)
  '(outline-5 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> semi-bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.06)
  '(outline-6 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> semi-bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.03)
  '(outline-8 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> semi-bold)
  '(outline-9 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> semi-bold))
</span><span class="ef-obe">#+end_src
</span>
And the same with the title.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(custom-set-faces!
  '(org-document-title </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.2))
</span><span class="ef-obe">#+end_src
</span>
It seems reasonable to have deadlines in the error face when they're passed.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-agenda-deadline-faces
      '((1.001 . error)
        (1.0 . org-warning)
        (0.5 . org-upcoming-deadline)
        (0.0 . org-upcoming-distant-deadline)))
</span><span class="ef-obe">#+end_src
</span>
We can then have quote blocks stand out a bit more by making them <span style="text-decoration: italic;">/italic/</span>.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-fontify-quote-and-verse-blocks t)
</span><span class="ef-obe">#+end_src
</span>
Org files can be rather nice to look at, particularly with some of the
customisations here. This comes at a cost however, expensive font-lock.
Feeling like you're typing through molasses in large files is no fun, but there
is a way I can defer font-locking when typing to make the experience more
responsive.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">locally-defer-font-lock</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Set jit-lock defer and stealth, when buffer is over a certain size."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt; (buffer-size) 50000)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> jit-lock-defer-time 0.05
                jit-lock-stealth-time 1)))

(add-hook 'org-mode-hook #'locally-defer-font-lock)
</span><span class="ef-obe">#+end_src
</span>Apparently this causes issues with some people, but I haven't noticed anything
problematic beyond the expected slight delay in some fontification, so until I
do I'll use the above.

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Reduced text indent</span>

Thanks to the various bits and bobs of setup we have here, the non-heading lines
tend to appear over-indented in <span style="color: #84888b;">~org-indent-mode~</span>. We can adjust this by modifying
the generated text prefixes.

There's another issue we can have when using mixed-pitch mode, where the line
height is set by the indent prefix displayed with the fixed-pitch font. This
means that on 0-indent lines the line spacing can be different, which doesn't
look very good. We can also solve this problem by modifying the generated text
prefixes to but a fixed-pitch zero width space at the start of 0-indent lines
instead of nothing.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +org-indent--reduced-text-prefixes ()
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'org-indent--compute-prefixes
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-indent--text-line-prefixes
        (make-vector org-indent--deepest-level nil))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt; org-indent-indentation-per-level 0)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">dotimes</span><span class="ef-ob"> (n org-indent--deepest-level)
      (aset org-indent--text-line-prefixes
            n
            (org-add-props
                (concat (make-string (* n (1- org-indent-indentation-per-level))
                                     ?\s)
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&gt; n 0)
                             (char-to-string org-indent-boundary-char)
                          </span><span style="color: #50a14f; background-color: #e7e7e7;">"\u200b"</span><span class="ef-ob">))
                nil 'face 'org-indent)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Fontifying inline src blocks</span>

Org does lovely things with <span style="color: #84888b;">=#+begin_src=</span> blocks, like using font-lock for
language's major-mode behind the scenes and pulling out the lovely colourful
results. By contrast, inline <span style="color: #84888b;">=src_=</span> blocks are somewhat neglected.

I am not the first person to feel this way, thankfully others have <span style="color: #4078f2; font-weight: 700;">[[https://stackoverflow.com/questions/20309842/how-to-syntax-highlight-for-org-mode-inline-source-code-src-lang/28059832][taken to
stackexchange]]</span> to voice their desire for inline src fontification. I was going to
steal their work, but unfortunately they didn't perform <span style="text-decoration: italic;">/true/</span> source code
fontification, but simply applied the <span style="color: #84888b;">=org-code=</span> face to the content.

We can do better than that, and we shall! Using <span style="color: #84888b;">~org-src-font-lock-fontify-block~</span>
we can apply language-appropriate syntax highlighting. Then, continuing on to
<span style="color: #84888b;">=</span><span style="color: #84888b;">{{{results(...)}}}</span><span style="color: #84888b;">=</span> , it can have the <span style="color: #84888b;">=org-block=</span> face applied to match, and then
the value-surrounding constructs hidden by mimicking the behaviour of
<span style="color: #84888b;">~prettify-symbols-mode~</span>.

<span class="ef-obb">#+begin_warning
</span>This currently only highlights a single inline src block per line.
I have no idea why it stops, but I'd rather it didn't.
If you have any idea what's going on or how to fix this <span style="text-decoration: italic;">/please/</span> get in touch.
<span class="ef-obe">#+end_warning
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-inline-src-prettify-results '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"⟨"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⟩"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Doom theme's extra fontification is more problematic than helpful.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> doom-themes-org-fontify-special-tags nil)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Symbols</span>

It's also nice to change the character used for collapsed items (by default <span style="color: #84888b;">~…~</span>),
I think <span style="color: #84888b;">~▾~</span> is better for indicating 'collapsed section'.
and add an extra <span style="color: #84888b;">~org-bullet~</span> to the default list of four.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-ellipsis </span><span style="color: #50a14f; background-color: #e7e7e7;">" ▾ "</span><span class="ef-ob">
      org-hide-leading-stars t
      org-priority-highest ?A
      org-priority-lowest ?E
      org-priority-faces
      '((?A . 'nerd-icons-red)
        (?B . 'nerd-icons-orange)
        (?C . 'nerd-icons-yellow)
        (?D . 'nerd-icons-green)
        (?E . 'nerd-icons-blue)))
</span><span class="ef-obe">#+end_src
</span>
It's also nice to make use of the <span style="color: #84888b;">=prettify-symbols-mode=</span> for a few Org syntactic
tokens which we'd like to prettify that aren't covered by <span style="color: #84888b;">=org-modern=</span> or any
other settings.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">appendq!</span><span class="ef-ob"> +ligatures-extra-symbols
          (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:list_property</span> <span style="color: #50a14f; background-color: #e7e7e7;">"∷"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:em_dash</span>       <span style="color: #50a14f; background-color: #e7e7e7;">"—"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:ellipses</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"…"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:arrow_right</span>   <span style="color: #50a14f; background-color: #e7e7e7;">"→"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:arrow_left</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"←"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:arrow_lr</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"↔"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:properties</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"⚙"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:end</span>           <span style="color: #50a14f; background-color: #e7e7e7;">"∎"</span>
                <span style="color: #a626a4; background-color: #e7e7e7;">:priority_a</span><span class="ef-ob">    #(</span><span style="color: #50a14f; background-color: #e7e7e7;">"⚑"</span><span class="ef-ob"> 0 1 (face nerd-icons-red))
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:priority_b</span><span class="ef-ob">    #(</span><span style="color: #50a14f; background-color: #e7e7e7;">"⬆"</span><span class="ef-ob"> 0 1 (face nerd-icons-orange))
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:priority_c</span><span class="ef-ob">    #(</span><span style="color: #50a14f; background-color: #e7e7e7;">"■"</span><span class="ef-ob"> 0 1 (face nerd-icons-yellow))
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:priority_d</span><span class="ef-ob">    #(</span><span style="color: #50a14f; background-color: #e7e7e7;">"⬇"</span><span class="ef-ob"> 0 1 (face nerd-icons-green))
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:priority_e</span><span class="ef-ob">    #(</span><span style="color: #50a14f; background-color: #e7e7e7;">"❓"</span><span class="ef-ob"> 0 1 (face nerd-icons-blue))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> +org-init-appearance-h--no-ligatures-a ()
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> #'+org-init-appearance-h
  (set-ligatures! 'org-mode nil)
  (set-ligatures! 'org-mode
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:list_property</span> <span style="color: #50a14f; background-color: #e7e7e7;">"::"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:em_dash</span>       <span style="color: #50a14f; background-color: #e7e7e7;">"---"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:ellipsis</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"..."</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:arrow_right</span>   <span style="color: #50a14f; background-color: #e7e7e7;">"-&gt;"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:arrow_left</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;-"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:arrow_lr</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;-&gt;"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:properties</span>    <span style="color: #50a14f; background-color: #e7e7e7;">":PROPERTIES:"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:end</span>           <span style="color: #50a14f; background-color: #e7e7e7;">":END:"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:priority_a</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"[#A]"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:priority_b</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"[#B]"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:priority_c</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"[#C]"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:priority_d</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"[#D]"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:priority_e</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"[#E]"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
While we're at it we may as well make tags prettier as well 🙂
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(package! org-pretty-tags :pin "5c7521651b35ae9a7d3add4a66ae8cc176ae1c76")
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(use-package org-pretty-tags
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">:config
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">(setq org-pretty-tags-surrogate-strings
</span><span style="color: #84888b; background-color: #e7e7e7;">;;        </span><span style="color: #84888b; background-color: #e7e7e7;">`(("uni"        . ,(all-the-icons-faicon   "graduation-cap" :face 'all-the-icons-purple  :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("ucc"        . ,(all-the-icons-material "computer"       :face 'all-the-icons-silver  :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("assignment" . ,(all-the-icons-material "library_books"  :face 'all-the-icons-orange  :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("test"       . ,(all-the-icons-material "timer"          :face 'all-the-icons-red     :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("lecture"    . ,(all-the-icons-fileicon "keynote"        :face 'all-the-icons-orange  :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("email"      . ,(all-the-icons-faicon   "envelope"       :face 'all-the-icons-blue    :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("read"       . ,(all-the-icons-octicon  "book"           :face 'all-the-icons-lblue   :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("article"    . ,(all-the-icons-octicon  "file-text"      :face 'all-the-icons-yellow  :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("web"        . ,(all-the-icons-faicon   "globe"          :face 'all-the-icons-green   :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("info"       . ,(all-the-icons-faicon   "info-circle"    :face 'all-the-icons-blue    :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("issue"      . ,(all-the-icons-faicon   "bug"            :face 'all-the-icons-red     :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("someday"    . ,(all-the-icons-faicon   "calendar-o"     :face 'all-the-icons-cyan    :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("idea"       . ,(all-the-icons-octicon  "light-bulb"     :face 'all-the-icons-yellow  :v-adjust 0.01))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;          </span><span style="color: #84888b; background-color: #e7e7e7;">("emacs"      . ,(all-the-icons-fileicon "emacs"          :face 'all-the-icons-lpurple :v-adjust 0.01))))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">(org-pretty-tags-global-mode))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** LaTeX Fragments</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Prettier highlighting</span>

First off, we want those fragments to look good.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-highlight-latex-and-related '(latex script entities))
</span><span class="ef-obe">#+end_src
</span>
However, by using <span style="color: #84888b;">=native=</span> highlighting the <span style="color: #84888b;">=org-block=</span> face is added, and that
doesn't look too great --- particularly when the fragments are previewed.

Ideally <span style="color: #84888b;">~org-src-font-lock-fontify-block~</span> wouldn't add the <span style="color: #84888b;">=org-block=</span> face, but we
can avoid advising that entire function by just adding another face with
<span style="color: #84888b;">=:inherit default=</span> which will override the background colour.

Inspecting <span style="color: #84888b;">~org-do-latex-and-related~</span> shows that <span style="color: #84888b;">="latex"=</span> is the language argument
passed, and so we can override the background as discussed above.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">org-src</span><span class="ef-ob">)
(add-to-list 'org-src-block-faces '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex"</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> default </span><span style="color: #a626a4; background-color: #e7e7e7;">:extend</span><span class="ef-ob"> t)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Automatic previewing</span>

It would be nice if fragments could automatically be previewed after being
typed, and the overlays automatically showed and hidden when moving the point in
and out of the LaTeX fragments.

Thankfully, all we need to do to make this happen is use <span style="color: #84888b;">~org-latex-preview-auto-mode~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook 'org-mode-hook #'org-latex-preview-auto-mode)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Prettier rendering</span>

It's nice to customise the look of LaTeX fragments so they fit better in the
text --- like this \(\sqrt{\beta^2+3}-\sum_{\phi=1}^\infty \frac{x^\phi-1}{\Gamma(a)}\).

The default snippet preamble basically just sets the margins and text size, with
templates to be filled in by <span style="color: #84888b;">~org-latex-default-packages-alist~</span> and
<span style="color: #84888b;">=#+latex_header:=</span> entries (but not <span style="color: #84888b;">=#+latex_header_extra:=</span>).

<span style="color: #84888b;">#+name: latex-default-snippet-preamble</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\documentclass</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">article</span><span class="ef-ob">}
[</span><span style="color: #6a1868; background-color: #e7e7e7;">DEFAULT-PACKAGES</span><span class="ef-ob">]
[PACKAGES]
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">xcolor</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
To this, we make two additions:
+ Selection of a maths font that fits better with displayed text.
+ My collection <span style="color: #4078f2; font-weight: 700;">[[*Maths notation conveniences][mathematical notation conveniences]]</span>.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-latex-preview-preamble
      (concat
       &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-default-snippet-preamble"</span><span class="ef-ob">)&gt;&gt;
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n% Custom font\n\\usepackage{arev}\n\n"</span><span class="ef-ob">
       &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-maths-conveniences"</span><span class="ef-ob">)&gt;&gt;))
</span><span class="ef-obe">#+end_src
</span>
Since we can, instead of making the background colour match the <span style="color: #84888b;">=default=</span> face,
let's make it transparent.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Calibrated based on the TeX font and org-buffer font.
</span><span class="ef-ob">(plist-put org-format-latex-options </span><span style="color: #a626a4; background-color: #e7e7e7;">:zoom</span><span class="ef-ob"> 0.93)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Rendering speed tests</span>

We can either render from a <span style="color: #84888b;">~dvi~</span> or <span style="color: #84888b;">~pdf~</span> file, so let's benchmark <span style="color: #84888b;">~latex~</span> and
<span style="color: #84888b;">~pdflatex~</span>.
| <span style="color: #84888b;">~latex~</span> time | <span style="color: #84888b;">~pdflatex~</span> time |
|------------+---------------|
| 135 \pm 2 ms | 215 \pm 3 ms    |

On the rendering side, there are two <span style="color: #84888b;">~.dvi~</span>-to-image converters which I am
interested in: <span style="color: #84888b;">~dvipng~</span> and <span style="color: #84888b;">~dvisvgm~</span>.

Using the above latex expression and benchmarking lead to the following results:
| <span style="color: #84888b;">~dvipng~</span> time | <span style="color: #84888b;">~dvisvgm~</span> time | <span style="color: #84888b;">~pdf2svg~</span> time |
|-------------+--------------+--------------|
| 89 \pm 2 ms   | 178 \pm 2 ms   | 12 \pm 2 ms    |

Now let's combine this to see what's best
| Tool chain         | Total time | Resulting file size |
|--------------------+------------+---------------------|
| <span style="color: #84888b;">~latex~</span> + <span style="color: #84888b;">~dvipng~</span>     | 226 \pm 2 ms | 7 KiB               |
| <span style="color: #84888b;">~latex~</span> + <span style="color: #84888b;">~dvisvgm~</span>    | 392 \pm 4 ms | 8 KiB               |
| <span style="color: #84888b;">~pdflatex~</span> + <span style="color: #84888b;">~pdf2svg~</span> | 230 \pm 2 ms | 16 KiB              |

So, let's use <span style="color: #84888b;">~dvipng~</span> for previewing LaTeX fragments in-Emacs, but <span style="color: #84888b;">~dvisvgm~</span> for <span style="color: #4078f2; font-weight: 700;">[[LaTeX Rendering]]</span>.

<span class="ef-obb">#+begin_warning
</span>Unfortunately, it seems that SVG sizing is annoying ATM, so let's actually not do this right now.
<span class="ef-obe">#+end_warning
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Org Plot</span>

We can use some of the variables in <span style="color: #84888b;">=org-plot=</span> to use the current doom theme
colours.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-plot-term-size</span><span class="ef-ob"> '(1050 . 650)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"The size of the GNUPlot terminal, in the form (WIDTH . HEIGHT)."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> org-plot
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-plot-generate-theme</span><span class="ef-ob"> (_type)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Use the current Doom theme colours to generate a GnuPlot preamble."</span><span class="ef-ob">
    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"
fgt = \"textcolor rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'\" # foreground text
fgat = \"textcolor rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'\" # foreground alt text
fgl = \"linecolor rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'\" # foreground line
fgal = \"linecolor rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'\" # foreground alt line

# foreground colors
set border lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'
# change text colors of  tics
set xtics @fgt
set ytics @fgt
# change text colors of labels
set title @fgt
set xlabel @fgt
set ylabel @fgt
# change a text color of key
set key @fgt

# line styles
set linetype 1 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # red
set linetype 2 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # blue
set linetype 3 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # green
set linetype 4 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # magenta
set linetype 5 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # orange
set linetype 6 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # yellow
set linetype 7 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # teal
set linetype 8 lw 2 lc rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' # violet

# border styles
set tics out nomirror
set border 3

# palette
set palette maxcolors 8
set palette defined ( 0 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">',\
1 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">',\
2 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">',\
3 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">',\
4 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">',\
5 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">',\
6 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">',\
7 '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' )
"</span><span class="ef-ob">
            (doom-color 'fg)
            (doom-color 'fg-alt)
            (doom-color 'fg)
            (doom-color 'fg-alt)
            (doom-color 'fg)
            </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">colours
</span><span class="ef-ob">            (doom-color 'red)
            (doom-color 'blue)
            (doom-color 'green)
            (doom-color 'magenta)
            (doom-color 'orange)
            (doom-color 'yellow)
            (doom-color 'teal)
            (doom-color 'violet)
            </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">duplicated
</span><span class="ef-ob">            (doom-color 'red)
            (doom-color 'blue)
            (doom-color 'green)
            (doom-color 'magenta)
            (doom-color 'orange)
            (doom-color 'yellow)
            (doom-color 'teal)
            (doom-color 'violet)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-plot-gnuplot-term-properties</span><span class="ef-ob"> (_type)
    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"background rgb '</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' size %s,%s"</span><span class="ef-ob">
            (doom-color 'bg) (car +org-plot-term-size) (cdr +org-plot-term-size)))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-plot/gnuplot-script-preamble #'+org-plot-generate-theme)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-plot/gnuplot-term-extra #'+org-plot-gnuplot-term-properties))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Exporting</span>

<span style="color: #84888b;">#+call: confpkg("Org exports", after="ox")</span>

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** General settings</span>

By default Org only exports the first three levels of headings as ... headings.
This is rather unfortunate as my documents frequently stray far beyond three
levels of depth. The two main formats I care about exporting to are LaTeX and
HTML. When using an <span style="color: #84888b;">=article=</span> class, LaTeX headlines go from <span style="color: #84888b;">=\section=</span>,
<span style="color: #84888b;">=\subsection=</span>, <span style="color: #84888b;">=\subsubsection=</span>, and <span style="color: #84888b;">=\paragraph=</span> to <span style="color: #84888b;">=\subgraph=</span> --- <span style="text-decoration: italic;">/five/</span> levels.
HTML5 has six levels of headings (<span style="color: #84888b;">=&lt;h1&gt;=</span> to <span style="color: #84888b;">=&lt;h6&gt;=</span>), but first level Org headings
get exported as <span style="color: #84888b;">=&lt;h2&gt;=</span> elements --- leaving <span style="text-decoration: italic;">/five/</span> usable levels.

As such, it would seem to make sense to recognise the first <span style="text-decoration: italic;">/five/</span> levels of Org
headings when exporting.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-export-headline-levels 5) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">I like nesting
</span><span class="ef-obe">#+end_src
</span>
I'm also going to make use of an item in <span style="color: #84888b;">=ox-extra=</span> so that I can add an <span style="color: #84888b;">=:ignore:=</span>
tag to headings for the content to be kept, but the heading itself ignored
(unlike <span style="color: #84888b;">=:noexport:=</span> which ignored both heading and content). This is useful when
I want to use headings to provide a structure for writing that doesn't appear in
the final documents.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">ox-extra</span><span class="ef-ob">)
(ox-extras-activate '(ignore-headlines))
</span><span class="ef-obe">#+end_src
</span>
Since I (roughly) track Org <span style="color: #84888b;">~HEAD~</span>, it makes sense to include the git version in
the creator string.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-export-creator-string
      (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emacs %s (Org mode %s–%s)"</span><span class="ef-ob"> emacs-version (org-release) (org-git-version)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Acronym formatting</span>

I like automatically using spaced small caps for acronyms. For strings I want to
be unaffected let's use <span style="color: #84888b;">~;~</span> as a prefix to prevent the transformation --- i.e.
<span style="color: #84888b;">~;JFK~</span> (as one would want for two-letter geographic locations and names).

This has to be implemented on a per-format basis, currently HTML and LaTeX
exports are supported.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-export-filter-text-acronym</span><span class="ef-ob"> (text backend _info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Wrap suspected acronyms in acronyms-specific formatting.
Treat sequences of 2+ capital letters (optionally succeeded by \"s\") as an acronym.
Ignore if preceeded by \";\" (for manual prevention) or \"\\\" (for LaTeX commands).

TODO abstract backend implementations."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((base-backend
         (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
          ((org-export-derived-backend-p backend 'latex) 'latex)
          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Markdown is derived from HTML, but we don't want to format it
</span><span class="ef-ob">          ((org-export-derived-backend-p backend 'md) nil)
          ((org-export-derived-backend-p backend 'html) 'html)))
        (case-fold-search nil))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> base-backend
      (replace-regexp-in-string
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"[;\\\\]?\\b[A-Z][A-Z]+s?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">A-Za-z]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\b</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob">
       (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (all-caps-str)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((equal (aref all-caps-str 0) ?\\) all-caps-str)                </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">don't format LaTeX commands
</span><span class="ef-ob">               ((equal (aref all-caps-str 0) ?\;) (substring all-caps-str 1))  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">just remove not-acronym indicator char ";"
</span><span class="ef-ob">               (t (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((final-char (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">A-Za-z]"</span><span class="ef-ob"> (substring all-caps-str -1 (length all-caps-str)))
                                         (substring all-caps-str -1 (length all-caps-str))
                                       nil)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">needed to re-insert the [</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #84888b; background-color: #e7e7e7;">A-Za-z] at the end
</span><span class="ef-ob">                         (trailing-s (equal (aref all-caps-str (- (length all-caps-str) (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> final-char 2 1))) ?s))
                         (acr (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> final-char
                                  (substring all-caps-str 0 (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> trailing-s -2 -1))
                                (substring all-caps-str 0 (+ (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> trailing-s -1 (length all-caps-str)))))))
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> base-backend
                      ('latex (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\acr{"</span><span class="ef-ob"> (downcase acr) </span><span style="color: #50a14f; background-color: #e7e7e7;">"}"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> trailing-s </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\acrs{}"</span><span class="ef-ob">) final-char))
                      ('html (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class='</span><span style="color: #b751b6; background-color: #e7e7e7;">acr</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;"</span><span class="ef-ob"> acr </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/span&gt;"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> trailing-s </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;small&gt;s&lt;/small&gt;"</span><span class="ef-ob">) final-char)))))))
       text t t))))

(add-to-list 'org-export-filter-plain-text-functions
             #'org-export-filter-text-acronym)

</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">We won't use `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-export-filter-headline-functions</span><span style="color: #84888b; background-color: #e7e7e7;">' because it
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">passes (and formats) the entire section contents. That's no good.
</span><span class="ef-ob">
(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-html-format-headline-acronymised</span><span class="ef-ob"> (todo todo-type priority text tags info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Like `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-format-headline-default-function</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', but with acronym formatting."</span><span class="ef-ob">
  (org-html-format-headline-default-function
   todo todo-type priority (org-export-filter-text-acronym text 'html info) tags info))
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-format-headline-function #'org-html-format-headline-acronymised)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-format-headline-acronymised</span><span class="ef-ob"> (todo todo-type priority text tags info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Like `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-format-headline-default-function</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', but with acronym formatting."</span><span class="ef-ob">
  (org-latex-format-headline-default-function
   todo todo-type priority (org-export-filter-text-acronym text 'latex info) tags info))
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-latex-format-headline-function #'org-latex-format-headline-acronymised)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Nicer generated heading IDs</span>

Thanks to alphapapa's <span style="color: #4078f2; font-weight: 700;">[[https://github.com/alphapapa/unpackaged.el#export-to-html-with-useful-anchors][unpackaged.el]]</span>.

By default, Org generated heading IDs like <span style="color: #84888b;">=#org80fc2a5=</span> which ... works, but has
two issues
+ It's completely uninformative, I have no idea what's being referenced
+ If I export the same file, everything will change.
  Now, while without hardcoded values it's impossible to set references in
  stone, it would be nice for there to be a decent chance of staying the same.

Both of these issues can be addressed by generating IDs like
<span style="color: #84888b;">=#language-configuration=</span>, which is what I'll do here.

It's worth noting that alphapapa's use of <span style="color: #84888b;">~url-hexify-string~</span> seemed to cause me
some issues. Replacing that in <span style="color: #84888b;">~a53899~</span> resolved this for me. To go one step
further, I create a function for producing nice short links, like an inferior
version of <span style="color: #84888b;">~reftex-label~</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-reference-contraction-max-words</span><span class="ef-ob"> 3
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Maximum number of words in a reference reference."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-reference-contraction-max-length</span><span class="ef-ob"> 35
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Maximum length of resulting reference reference, including joining characters."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-reference-contraction-stripped-words</span><span class="ef-ob">
  '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"the"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"on"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"in"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"off"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"a"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"for"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"by"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"of"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"and"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"is"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"to"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"as"</span><span class="ef-ob">)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Superfluous words to be removed from a reference."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-reference-contraction-joining-char</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Character used to join words in the reference reference."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-reference-contraction-truncate-words</span><span class="ef-ob"> (words)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-reference-contraction-max-length</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' as the total character '</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">budget</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' for the WORDS
and truncate individual words to conform to this budget.

To arrive at a budget that accounts for words undershooting their requisite average length,
the number of characters in the budget freed by short words is distributed among the words
exceeding the average length.  This adjusts the per-word budget to be the maximum feasable for
this particular situation, rather than the universal maximum average.

This budget-adjusted per-word maximum length is given by the mathematical expression below:

max length = \\floor{ \\frac{total length - chars for seperators - \\sum_{word \\leq average length} length(word) }{num(words) &gt; average length} }"</span>
  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">trucate each word to a max word length determined by
</span>  <span style="color: #84888b; background-color: #e7e7e7;">;;</span>
<span class="ef-ob">  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((total-length-budget (- org-reference-contraction-max-length  </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">how many non-separator chars we can use
</span><span class="ef-ob">                                 (1- (length words))))
         (word-length-budget (/ total-length-budget                      </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">max length of each word to keep within budget
</span><span class="ef-ob">                                org-reference-contraction-max-words))
         (num-overlong (-count (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word)                            </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">how many words exceed that budget
</span><span class="ef-ob">                                 (&gt; (length word) word-length-budget))
                               words))
         (total-short-length (-sum (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word)                </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">total length of words under that budget
</span><span class="ef-ob">                                             (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt;= (length word) word-length-budget)
                                                 (length word) 0))
                                           words)))
         (max-length (/ (- total-length-budget total-short-length)       </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">max(max-length) that we can have to fit within the budget
</span><span class="ef-ob">                        num-overlong)))
    (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word)
              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt;= (length word) max-length)
                  word
                (substring word 0 max-length)))
            words)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-reference-contraction</span><span class="ef-ob"> (reference-string)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Give a contracted form of REFERENCE-STRING that is only contains alphanumeric characters.
Strips '</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">joining</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' words present in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-reference-contraction-stripped-words</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">',
and then limits the result to the first `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-reference-contraction-max-words</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' words.
If the total length is &gt; `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-reference-contraction-max-length</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' then individual words are
truncated to fit within the limit using `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-reference-contraction-truncate-words</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((reference-words
         (cl-remove-if-not
          (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word)
            (not (member word org-reference-contraction-stripped-words)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((str reference-string))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> str (downcase str))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> str (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\[\\[[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">]]+\\]\\[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">]]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">\\]\\]"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\1"</span><span class="ef-ob"> str)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">get description from org-link
</span><span class="ef-ob">            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> str (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"[-/ ]+"</span> <span style="color: #50a14f; background-color: #e7e7e7;">" "</span><span class="ef-ob"> str)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">replace seperator-type chars with space
</span><span class="ef-ob">            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> str (puny-encode-string str))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> str (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"^xn--</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.*?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;"> ?-?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[a-z0-9]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">$"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\2 \\1"</span><span class="ef-ob"> str)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">rearrange punycode
</span><span class="ef-ob">            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> str (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">A-Za-z0-9 ]"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> str)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">strip chars which need %-encoding in a uri
</span><span class="ef-ob">            (split-string str </span><span style="color: #50a14f; background-color: #e7e7e7;">" +"</span><span class="ef-ob">)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt; (length reference-words)
             org-reference-contraction-max-words)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> reference-words
            (cl-subseq reference-words 0 org-reference-contraction-max-words)))

    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt; (apply #'+ (1- (length reference-words))
                    (mapcar #'length reference-words))
             org-reference-contraction-max-length)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> reference-words (org-reference-contraction-truncate-words reference-words)))

    (string-join reference-words org-reference-contraction-joining-char)))
</span><span class="ef-obe">#+end_src
</span>
Now here's alphapapa's subtly tweaked mode.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">define-minor-mode</span> <span style="color: #a626a4; background-color: #e7e7e7;">unpackaged/org-export-html-with-useful-ids-mode</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Attempt to export Org as HTML with useful link IDs.
Instead of random IDs like \"#orga1b2c3\", use heading titles,
made unique when necessary."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:global</span><span class="ef-ob"> t
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> unpackaged/org-export-html-with-useful-ids-mode
      (advice-add #'org-export-get-reference </span><span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'unpackaged/org-export-get-reference)
    (advice-remove #'org-export-get-reference #'unpackaged/org-export-get-reference)))
(unpackaged/org-export-html-with-useful-ids-mode 1) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ensure enabled, and advice run
</span><span class="ef-ob">
(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">unpackaged/org-export-get-reference</span><span class="ef-ob"> (datum info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Like `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-export-get-reference</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', except uses heading titles instead of random numbers."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((cache (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:internal-references</span><span class="ef-ob">)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (car (rassq datum cache))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((crossrefs (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:crossrefs</span><span class="ef-ob">))
               (cells (org-export-search-cells datum))
               </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Preserve any pre-existing association between
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">a search cell and a reference, i.e., when some
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">previously published document referenced a location
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">within current file (see
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">`</span><span style="color: #b751b6; background-color: #e7e7e7;">org-publish-resolve-external-link</span><span style="color: #84888b; background-color: #e7e7e7;">').
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;;</span>
               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">However, there is no guarantee that search cells are
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">unique, e.g., there might be duplicate custom ID or
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">two headings with the same title in the file.
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;;</span>
               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">As a consequence, before re-using any reference to
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">an element or object, we check that it doesn't refer
</span>               <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">to a previous element or object.
</span><span class="ef-ob">               (new (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cl-some
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (cell)
                           (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((stored (cdr (assoc cell crossrefs))))
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> stored
                               (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((old (org-export-format-reference stored)))
                                 (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (assoc old cache)) stored)))))
                         cells)
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:raw-value</span><span class="ef-ob"> datum)
                          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Heading with a title
</span><span class="ef-ob">                          (unpackaged/org-export-new-named-reference datum cache))
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (member (car datum) '(src-block table example fixed-width property-drawer))
                          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Nameable elements
</span><span class="ef-ob">                          (unpackaged/org-export-new-named-reference datum cache))
                        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">NOTE: This probably breaks some Org Export
</span>                        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">feature, but if it does what I need, fine.
</span><span class="ef-ob">                        (org-export-format-reference
                         (org-export-new-reference cache))))
               (reference-string new))
          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Cache contains both data already associated to
</span>          <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">a reference and in-use internal references, so as to make
</span>          <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">unique references.
</span><span class="ef-ob">          (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (cell cells) (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (cons cell new) cache))
          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Retain a direct association between reference string and
</span>          <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">DATUM since (1) not every object or element can be given
</span>          <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">a search cell (2) it permits quick lookup.
</span><span class="ef-ob">          (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (cons reference-string datum) cache)
          (plist-put info </span><span style="color: #a626a4; background-color: #e7e7e7;">:internal-references</span><span class="ef-ob"> cache)
          reference-string))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">unpackaged/org-export-new-named-reference</span><span class="ef-ob"> (datum cache)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return new reference for DATUM that is unique in CACHE."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-macrolet</span><span class="ef-ob"> ((inc-suffixf (place)
                  `(</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob">
                     (string-match (</span><span style="color: #e45649; background-color: #e7e7e7;">rx</span><span class="ef-ob"> bos
                                       (minimal-match (group (1+ anything)))
                                       (optional </span><span style="color: #50a14f; background-color: #e7e7e7;">"--"</span><span class="ef-ob"> (group (1+ digit)))
                                       eos)
                                   ,place)
                     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">HACK: `</span><span style="color: #b751b6; background-color: #e7e7e7;">s1</span><span style="color: #84888b; background-color: #e7e7e7;">' instead of a gensym.
</span><span class="ef-ob">                     (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((s1 (match-string 1 ,place))
                            (suffix-1 (match-string 2 ,place))
                            (suffix (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> suffix-1 (string-to-number suffix-1) 0)))
                       (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> ,place (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s--%s"</span><span class="ef-ob"> s1 (1+ suffix)))))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((headline-p (eq (car datum) 'headline))
           (title (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> headline-p
                      (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:raw-value</span><span class="ef-ob"> datum)
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob"> datum)
                        (concat (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:raw-value</span><span class="ef-ob">
                                                      (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parent</span><span class="ef-ob">
                                                                            (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parent</span><span class="ef-ob"> datum)))))))
           </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">get ascii-only form of title without needing percent-encoding
</span><span class="ef-ob">           (ref (concat (org-reference-contraction (substring-no-properties title))
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> headline-p (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob"> datum))
                          (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">","</span><span class="ef-ob">
                                  (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (car datum)
                                    ('src-block </span><span style="color: #50a14f; background-color: #e7e7e7;">"code"</span><span class="ef-ob">)
                                    ('example </span><span style="color: #50a14f; background-color: #e7e7e7;">"example"</span><span class="ef-ob">)
                                    ('fixed-width </span><span style="color: #50a14f; background-color: #e7e7e7;">"mono"</span><span class="ef-ob">)
                                    ('property-drawer </span><span style="color: #50a14f; background-color: #e7e7e7;">"properties"</span><span class="ef-ob">)
                                    (_ (symbol-name (car datum))))
                                  </span><span style="color: #50a14f; background-color: #e7e7e7;">"--1"</span><span class="ef-ob">))))
           (parent (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> headline-p (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parent</span><span class="ef-ob"> datum))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (member ref (mapcar #'car cache))
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Title not unique: make it so.
</span><span class="ef-ob">        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> parent
            </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Append ancestor title.
</span><span class="ef-ob">            (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> title (concat (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:raw-value</span><span class="ef-ob"> parent)
                                </span><span style="color: #50a14f; background-color: #e7e7e7;">"--"</span><span class="ef-ob"> title)
                  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">get ascii-only form of title without needing percent-encoding
</span><span class="ef-ob">                  ref (org-reference-contraction (substring-no-properties title))
                  parent (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> headline-p (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parent</span><span class="ef-ob"> parent)))
          </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">No more ancestors: add and increment a number.
</span><span class="ef-ob">          (inc-suffixf ref)))
      ref)))

(add-hook 'org-load-hook #'unpackaged/org-export-html-with-useful-ids-mode)
</span><span class="ef-obe">#+end_src
</span>We also need to redefine <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(org-export-format-reference)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> as it now may
be passed a string as well as a number.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-export-format-reference-a (reference)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Format REFERENCE into a string.

REFERENCE is a either a number or a string representing a reference,
as returned by `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-export-new-reference</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'org-export-format-reference
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (stringp reference) reference (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"org%07x"</span><span class="ef-ob"> reference)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Strip zero width spaces</span>

Zero width spaces are handy as a semantic separator, but not something we want
passed through to the exports.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-export-remove-zero-width-space</span><span class="ef-ob"> (text _backend _info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Remove zero width spaces from TEXT."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (org-export-derived-backend-p 'org)
    (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\u200B"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> text)))

(add-to-list 'org-export-filter-final-output-functions #'+org-export-remove-zero-width-space t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Exporting Org code</span>

With all our Org config and hooks, exporting an Org code block when using
a font-lock based method can produce undesirable results. To address this, we
can tweak <span style="color: #84888b;">~+org-babel-mode-alist~</span> when exporting.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-mode--fontlock-only-mode</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Just apply org-mode's font-lock once."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (org-mode-hook
        org-hide-leading-stars
        org-hide-emphasis-markers)
    (org-set-font-lock-defaults)
    (font-lock-ensure))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> major-mode #'fundamental-mode))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-export-babel-mask-org-config</span><span class="ef-ob"> (_backend)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Use `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">+org-mode--fontlock-only-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' instead of `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-mode</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> org-src-lang-modes
              (append org-src-lang-modes
                      (list (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"org"</span><span class="ef-ob"> #'+org-mode--fontlock-only)))))

(add-hook 'org-export-before-processing-hook #'+org-export-babel-mask-org-config)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** HTML Export</span>

<span style="color: #84888b;">#+call: confpkg("ox-html", after="ox-html")</span>

I want to tweak a whole bunch of things. While I'll want my tweaks almost all
the time, occasionally I may want to test how something turns out using a more
default config. With that in mind, a global minor mode seems like the most
appropriate architecture to use.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">define-minor-mode</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-fancy-html-export-mode</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Toggle my fabulous org export tweaks. While this mode itself does a little bit,
the vast majority of the change in behaviour comes from switch statements in:
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-template-fancier</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html--build-meta-info-extended</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-src-block-collapsable</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-block-collapsable</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-table-wrapped</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html--format-toc-headline-colapseable</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html--toc-text-stripped-leaves</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'
 - `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-export-html-headline-anchor</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:global</span><span class="ef-ob"> t
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init-value</span><span class="ef-ob"> t
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> org-fancy-html-export-mode
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-style-default org-html-style-fancy
            org-html-meta-tags #'org-html-meta-tags-fancy
            org-html-checkbox-type 'html-span)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-style-default org-html-style-plain
          org-html-meta-tags #'org-html-meta-tags-default
          org-html-checkbox-type 'html)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Extra header content</span>

We want to tack on a few more bits to the start of the body. Unfortunately, there
doesn't seem to be any nice variable or hook, so we'll just override the
relevant function.

This is done to allow me to add the date and author to the page header,
implement a CSS-only light/dark theme toggle, and a sprinkle of <span style="color: #4078f2; font-weight: 700;">[[https://ogp.me/][Open Graph]]</span>
metadata.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-html-template-fancier (orig-fn contents info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return complete document string after HTML conversion.
CONTENTS is the transcoded contents string.  INFO is a plist
holding export options. Adds a few extra things to the body
compared to the default implementation."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html-template
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not org-fancy-html-export-mode) (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-msg-export-in-progress))
      (funcall orig-fn contents info)
    (concat
     (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (org-html-html5-p info)) (org-html-xhtml-p info))
       (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((xml-declaration (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-xml-declaration</span><span class="ef-ob">))
              (decl (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (stringp xml-declaration) xml-declaration)
                        (cdr (assoc (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-extension</span><span class="ef-ob">)
                                    xml-declaration))
                        (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"html"</span><span class="ef-ob"> xml-declaration))
                        </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)))
         (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (not (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not decl) (string= </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> decl)))
           (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s\n"</span><span class="ef-ob">
                   (format decl
                           (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> org-html-coding-system
                                    (fboundp 'coding-system-get)
                                    (coding-system-get org-html-coding-system 'mime-charset))
                               </span><span style="color: #50a14f; background-color: #e7e7e7;">"iso-8859-1"</span><span class="ef-ob">))))))
     (org-html-doctype info)
     </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">
     (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;html"</span><span class="ef-ob">
             (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob"> ((org-html-xhtml-p info)
                    (format
                     </span><span style="color: #50a14f; background-color: #e7e7e7;">" xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"%s\" xml:lang=\"%s\""</span><span class="ef-ob">
                     (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob">) (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob">)))
                   ((org-html-html5-p info)
                    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">" lang=\"%s\""</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob">))))
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"&gt;\n"</span><span class="ef-ob">)
     </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;head&gt;\n"</span><span class="ef-ob">
     (org-html--build-meta-info info)
     (org-html--build-head info)
     (org-html--build-mathjax-config info)
     </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/head&gt;\n"</span>
     <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;body&gt;\n&lt;input type='</span><span style="color: #b751b6; background-color: #e7e7e7;">checkbox</span><span style="color: #50a14f; background-color: #e7e7e7;">' id='</span><span style="color: #b751b6; background-color: #e7e7e7;">theme-switch</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;&lt;div id='</span><span style="color: #b751b6; background-color: #e7e7e7;">page</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;&lt;label id='</span><span style="color: #b751b6; background-color: #e7e7e7;">switch-label</span><span style="color: #50a14f; background-color: #e7e7e7;">' for='</span><span style="color: #b751b6; background-color: #e7e7e7;">theme-switch</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;&lt;/label&gt;"</span><span class="ef-ob">
     (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((link-up (org-trim (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-link-up</span><span class="ef-ob">)))
           (link-home (org-trim (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-link-home</span><span class="ef-ob">))))
       (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string= link-up </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">) (string= link-home </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
         (format (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-home/up-format</span><span class="ef-ob">)
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> link-up link-home)
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> link-home link-up))))
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Preamble.
</span><span class="ef-ob">     (org-html--build-pre/postamble 'preamble info)
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Document contents.
</span><span class="ef-ob">     (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((div (assq 'content (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-divs</span><span class="ef-ob">))))
       (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;%s id=\"%s\"&gt;\n"</span><span class="ef-ob"> (nth 1 div) (nth 2 div)))
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Document title.
</span><span class="ef-ob">     (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-title</span><span class="ef-ob">)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((title (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-title</span><span class="ef-ob">)
                         (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">)))
             (subtitle (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:subtitle</span><span class="ef-ob">))
             (html5-fancy (org-html--html5-fancy-p info)))
         (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> title
           (format
            (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> html5-fancy
                </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;header class=\"page-header\"&gt;%s\n&lt;h1 class=\"title\"&gt;%s&lt;/h1&gt;\n%s&lt;/header&gt;"</span>
              <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;h1 class=\"title\"&gt;%s%s&lt;/h1&gt;\n"</span><span class="ef-ob">)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-date</span><span class="ef-ob">)
                    (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-author</span><span class="ef-ob">))
                (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;div class=\"page-meta\"&gt;"</span><span class="ef-ob">
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-date</span><span class="ef-ob">)
                          (org-export-data (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:date</span><span class="ef-ob">) info))
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-date</span><span class="ef-ob">) (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-author</span><span class="ef-ob">)) </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">)
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-author</span><span class="ef-ob">)
                          (org-export-data (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:author</span><span class="ef-ob">) info))
                        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/div&gt;\n"</span><span class="ef-ob">)
              </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
            (org-export-data title info)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> subtitle
                (format
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> html5-fancy
                     </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;p class=\"subtitle\" role=\"doc-subtitle\"&gt;%s&lt;/p&gt;\n"</span><span class="ef-ob">
                   (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob"> (org-html-close-tag </span><span style="color: #50a14f; background-color: #e7e7e7;">"br"</span><span class="ef-ob"> nil info) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span>
                           <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class=\"subtitle\"&gt;%s&lt;/span&gt;\n"</span><span class="ef-ob">))
                 (org-export-data subtitle info))
              </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)))))
     contents
     (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/%s&gt;\n"</span><span class="ef-ob"> (nth 1 (assq 'content (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-divs</span><span class="ef-ob">))))
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Postamble.
</span><span class="ef-ob">     (org-html--build-pre/postamble 'postamble info)
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Possibly use the Klipse library live code blocks.
</span><span class="ef-ob">     (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-klipsify-src</span><span class="ef-ob">)
       (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;script&gt;"</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-klipse-selection-script</span><span class="ef-ob">)
               </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/script&gt;&lt;script src=\""</span><span class="ef-ob">
               org-html-klipse-js
               </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"&gt;&lt;/script&gt;&lt;link rel=\"stylesheet\" type=\"text/css\" href=\""</span><span class="ef-ob">
               org-html-klipse-css </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"/&gt;"</span><span class="ef-ob">))
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Closing document.
</span>     <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
I think it would be nice if "Table of Contents" brought you back to the top of
the page. Well, since we've done this much advising already...
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-html-toc-linked (depth info </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> scope)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Build a table of contents.

Just like `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-toc</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', except the header is a link to \"#\".

DEPTH is an integer specifying the depth of the table.  INFO is
a plist used as a communication channel.  Optional argument SCOPE
is an element defining the scope of the table.  Return the table
of contents as a string, or nil if it is empty."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'org-html-toc
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((toc-entries
         (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (headline)
                   (cons (org-html--format-toc-headline headline info)
                         (org-export-get-relative-level headline info)))
                 (org-export-collect-headlines info depth scope))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> toc-entries
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((toc (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;div id=\"text-table-of-contents\"&gt;"</span><span class="ef-ob">
                         (org-html--toc-text toc-entries)
                         </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/div&gt;\n"</span><span class="ef-ob">)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> scope toc
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((outer-tag (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (org-html--html5-fancy-p info)
                               </span><span style="color: #50a14f; background-color: #e7e7e7;">"nav"</span>
                             <span style="color: #50a14f; background-color: #e7e7e7;">"div"</span><span class="ef-ob">)))
            (concat (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;%s id=\"table-of-contents\"&gt;\n"</span><span class="ef-ob"> outer-tag)
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((top-level (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:html-toplevel-hlevel</span><span class="ef-ob">)))
                      (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;h%d&gt;&lt;a href=\"#\" style=\"color:inherit; text-decoration: none;\"&gt;%s&lt;/a&gt;&lt;/h%d&gt;\n"</span><span class="ef-ob">
                              top-level
                              (org-html--translate </span><span style="color: #50a14f; background-color: #e7e7e7;">"Table of Contents"</span><span class="ef-ob"> info)
                              top-level))
                    toc
                    (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/%s&gt;\n"</span><span class="ef-ob"> outer-tag))))))))
</span><span class="ef-obe">#+end_src
</span>
Lastly, let's pile on some metadata. This gives my pages nice embeds.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-html-meta-tags-opengraph-image</span><span class="ef-ob">
  '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:image</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/org/nib.png"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:type</span> <span style="color: #50a14f; background-color: #e7e7e7;">"image/png"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:width</span> <span style="color: #50a14f; background-color: #e7e7e7;">"200"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:height</span> <span style="color: #50a14f; background-color: #e7e7e7;">"200"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:alt</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Green fountain pen nib"</span><span class="ef-ob">)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Plist of og:image:PROP properties and their value, for use in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-meta-tags-fancy</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-html-meta-tags-fancy</span><span class="ef-ob"> (info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Use the INFO plist to construct the meta tags, as described in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-meta-tags</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((title (org-html-plain-text
                 (org-element-interpret-data (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">)) info))
         (author (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-author</span><span class="ef-ob">)
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((auth (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:author</span><span class="ef-ob">)))
                        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Return raw Org syntax.
</span><span class="ef-ob">                        (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> auth (org-html-plain-text
                                   (org-element-interpret-data auth) info)))))
         (author-first-last
          (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (org-string-nw-p author))
               (</span><span style="color: #e45649; background-color: #e7e7e7;">save-match-data</span><span class="ef-ob">
                 (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-match </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.+?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;"> +</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.+?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">\\'"</span><span class="ef-ob"> author)
                     (cons (match-string 1 author)
                           (match-string 2 author))
                   (cons author nil))))))
    (append
     (list
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-string-nw-p author)
        (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"name"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"author"</span><span class="ef-ob"> author))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-string-nw-p (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:description</span><span class="ef-ob">))
        (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"name"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"description"</span><span class="ef-ob">
              (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:description</span><span class="ef-ob">)))
      '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"name"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"generator"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"org mode"</span><span class="ef-ob">)
      '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"name"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"theme-color"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"#77aa99"</span><span class="ef-ob">)
      '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:type"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"article"</span><span class="ef-ob">)
      (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:title"</span><span class="ef-ob"> title)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((subtitle (org-export-data (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:subtitle</span><span class="ef-ob">) info)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-string-nw-p subtitle)
          (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:description"</span><span class="ef-ob"> subtitle))))
     (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> org-html-meta-tags-opengraph-image
       (list (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:image"</span><span class="ef-ob"> (plist-get org-html-meta-tags-opengraph-image </span><span style="color: #a626a4; background-color: #e7e7e7;">:image</span><span class="ef-ob">))
             (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:image:type"</span><span class="ef-ob"> (plist-get org-html-meta-tags-opengraph-image </span><span style="color: #a626a4; background-color: #e7e7e7;">:type</span><span class="ef-ob">))
             (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:image:width"</span><span class="ef-ob"> (plist-get org-html-meta-tags-opengraph-image </span><span style="color: #a626a4; background-color: #e7e7e7;">:width</span><span class="ef-ob">))
             (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:image:height"</span><span class="ef-ob"> (plist-get org-html-meta-tags-opengraph-image </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob">))
             (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:image:alt"</span><span class="ef-ob"> (plist-get org-html-meta-tags-opengraph-image </span><span style="color: #a626a4; background-color: #e7e7e7;">:alt</span><span class="ef-ob">))))
     (list
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (car author-first-last)
        (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:article:author:first_name"</span><span class="ef-ob"> (car author-first-last)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (cdr author-first-last)
        (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:article:author:last_name"</span><span class="ef-ob"> (cdr author-first-last)))
      (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:article:published_time"</span><span class="ef-ob">
            (format-time-string
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"%FT%T%z"</span><span class="ef-ob">
             (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob">
              (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((date-str (cadar (org-collect-keywords '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"DATE"</span><span class="ef-ob">)))))
                (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (string= date-str (format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%F"</span><span class="ef-ob">))
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">ignore-errors</span><span class="ef-ob"> (encode-time (org-parse-time-string date-str)))))
              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> buffer-file-name
                  (file-attribute-modification-time (file-attributes buffer-file-name))
                (current-time)))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> buffer-file-name
        (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"property"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"og:article:modified_time"</span><span class="ef-ob">
              (format-time-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"%FT%T%z"</span><span class="ef-ob"> (file-attribute-modification-time (file-attributes buffer-file-name)))))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (functionp #'org-html-meta-tags-default)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defalias</span><span class="ef-ob"> '</span><span style="color: #a626a4; background-color: #e7e7e7;">org-html-meta-tags-default</span><span class="ef-ob"> #'ignore))
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-meta-tags #'org-html-meta-tags-fancy)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Custom CSS/JS</span>

The default org HTML export is ... alright, but we can really jazz it up.
<span style="color: #4078f2; font-weight: 700;">[[https://lepisma.xyz][lepisma.xyz]]</span> has a really nice style, and from and org export too!
Suffice to say I've snatched it, with a few of my own tweaks applied.

<span class="ef-obb">#+begin_src html :tangle misc/org-export-header.html :comments no
</span><span class="ef-ob">&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">link</span> <span style="color: #6a1868; background-color: #e7e7e7;">rel</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"icon"</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/org/nib.ico"</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"image/ico"</span><span class="ef-ob"> /&gt;

&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">link</span> <span style="color: #6a1868; background-color: #e7e7e7;">rel</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"preload"</span> <span style="color: #6a1868; background-color: #e7e7e7;">as</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font"</span> <span style="color: #6a1868; background-color: #e7e7e7;">crossorigin</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"anonymous"</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font/woff2"</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/org/etbookot-roman-webfont.woff2"</span><span class="ef-ob">&gt;
&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">link</span> <span style="color: #6a1868; background-color: #e7e7e7;">rel</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"preload"</span> <span style="color: #6a1868; background-color: #e7e7e7;">as</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font"</span> <span style="color: #6a1868; background-color: #e7e7e7;">crossorigin</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"anonymous"</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font/woff2"</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/org/etbookot-italic-webfont.woff2"</span><span class="ef-ob">&gt;
&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">link</span> <span style="color: #6a1868; background-color: #e7e7e7;">rel</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"preload"</span> <span style="color: #6a1868; background-color: #e7e7e7;">as</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font"</span> <span style="color: #6a1868; background-color: #e7e7e7;">crossorigin</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"anonymous"</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font/woff2"</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/org/Merriweather-TextRegular.woff2"</span><span class="ef-ob">&gt;
&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">link</span> <span style="color: #6a1868; background-color: #e7e7e7;">rel</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"preload"</span> <span style="color: #6a1868; background-color: #e7e7e7;">as</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font"</span> <span style="color: #6a1868; background-color: #e7e7e7;">crossorigin</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"anonymous"</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font/woff2"</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/org/Merriweather-TextItalic.woff2"</span><span class="ef-ob">&gt;
&lt;</span><span style="color: #a626a4; background-color: #e7e7e7;">link</span> <span style="color: #6a1868; background-color: #e7e7e7;">rel</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"preload"</span> <span style="color: #6a1868; background-color: #e7e7e7;">as</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font"</span> <span style="color: #6a1868; background-color: #e7e7e7;">crossorigin</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"anonymous"</span> <span style="color: #6a1868; background-color: #e7e7e7;">type</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"font/woff2"</span> <span style="color: #6a1868; background-color: #e7e7e7;">href</span><span class="ef-ob">=</span><span style="color: #50a14f; background-color: #e7e7e7;">"https://tecosaur.com/resources/org/Merriweather-TextBold.woff2"</span><span class="ef-ob">&gt;
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-style-plain org-html-style-default
      org-html-htmlize-output-type 'css
      org-html-doctype </span><span style="color: #50a14f; background-color: #e7e7e7;">"html5"</span><span class="ef-ob">
      org-html-html5-fancy t)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-html-reload-fancy-style</span><span class="ef-ob"> ()
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-style-fancy
        (</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
          (insert-file-contents (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"misc/org-export-header.html"</span><span class="ef-ob"> doom-user-dir))
          (goto-char (point-max))
          (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;script&gt;\n"</span><span class="ef-ob">)
          (insert-file-contents (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"misc/org-css/main.js"</span><span class="ef-ob"> doom-user-dir))
          (goto-char (point-max))
          (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/script&gt;\n&lt;style&gt;\n"</span><span class="ef-ob">)
          (insert-file-contents (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"misc/org-css/main.min.css"</span><span class="ef-ob"> doom-user-dir))
          (goto-char (point-max))
          (insert </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/style&gt;"</span><span class="ef-ob">)
          (buffer-string)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> org-fancy-html-export-mode
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-style-default org-html-style-fancy)))
(org-html-reload-fancy-style)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Collapsable src and example blocks</span>

By wrapping the <span style="color: #84888b;">~&lt;pre&gt;~</span> element in a <span style="color: #84888b;">~&lt;details&gt;~</span> block, we can obtain collapsable
blocks with no CSS, though we will toss a little in anyway to have this looking
somewhat spiffy.

Since this collapsability seems useful to have on by default for certain chunks
of code, it would be nice if you could set it with <span style="color: #84888b;">=#+attr_html: :collapsed t=</span>.

It would be nice to also have a corresponding global / session-local way of
setting this, but I haven't quite been able to get that working (yet).

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-html-export-collapsed</span><span class="ef-ob"> nil)
(eval '(cl-pushnew '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:collapsed</span> <span style="color: #50a14f; background-color: #e7e7e7;">"COLLAPSED"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"collapsed"</span><span class="ef-ob"> org-html-export-collapsed t)
                   (org-export-backend-options (org-export-get-backend 'html))))
(add-to-list 'org-default-properties </span><span style="color: #50a14f; background-color: #e7e7e7;">"EXPORT_COLLAPSED"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
We can take our src block modification a step further, and add a gutter on the
side of the src block containing both an anchor referencing the current block,
and a button to copy the content of the block.

<span style="color: #84888b;">#+name: Src blocks</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-html-src-block-collapsable (orig-fn src-block contents info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Wrap the usual &lt;pre&gt; block in a &lt;details&gt;"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html-src-block
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not org-fancy-html-export-mode) (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-msg-export-in-progress))
      (funcall orig-fn src-block contents info)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((properties (cadr src-block))
           (lang (mode-name-to-lang-name
                  (plist-get properties </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob">)))
           (name (plist-get properties </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob">))
           (ref (org-export-get-reference src-block info))
           (collapsed-p (member (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (org-export-read-attribute </span><span style="color: #a626a4; background-color: #e7e7e7;">:attr_html</span><span class="ef-ob"> src-block </span><span style="color: #a626a4; background-color: #e7e7e7;">:collapsed</span><span class="ef-ob">)
                                    (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:collapsed</span><span class="ef-ob">))
                                '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"y"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"yes"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span><span class="ef-ob"> t </span><span style="color: #50a14f; background-color: #e7e7e7;">"true"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"all"</span><span class="ef-ob">))))
      (format
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;details id='</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' class='</span><span style="color: #b751b6; background-color: #e7e7e7;">code</span><span style="color: #50a14f; background-color: #e7e7e7;">'%s&gt;&lt;summary%s&gt;%s&lt;/summary&gt;
&lt;div class='</span><span style="color: #b751b6; background-color: #e7e7e7;">gutter</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;
&lt;a href='#%s'&gt;#&lt;/a&gt;
&lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;⎘&lt;/button&gt;\
&lt;/div&gt;
%s
&lt;/details&gt;"</span><span class="ef-ob">
       ref
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> collapsed-p </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span> <span style="color: #50a14f; background-color: #e7e7e7;">" open"</span><span class="ef-ob">)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> name </span><span style="color: #50a14f; background-color: #e7e7e7;">" class='</span><span style="color: #b751b6; background-color: #e7e7e7;">named</span><span style="color: #50a14f; background-color: #e7e7e7;">'"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
       (concat
        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> name (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class=\"name\"&gt;"</span><span class="ef-ob"> name </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/span&gt;"</span><span class="ef-ob">))
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class=\"lang\"&gt;"</span><span class="ef-ob"> lang </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/span&gt;"</span><span class="ef-ob">)
       ref
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> name
           (replace-regexp-in-string (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;pre</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;"> class=\"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">\"]+\"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">? id=\"%s\"&gt;"</span><span class="ef-ob"> ref) </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;pre\\1&gt;"</span><span class="ef-ob">
                                     (funcall orig-fn src-block contents info))
         (funcall orig-fn src-block contents info))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">mode-name-to-lang-name</span><span class="ef-ob"> (mode)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cadr (assoc mode
                   '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"asymptote"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Asymptote"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"awk"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Awk"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"C"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"C"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"clojure"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Clojure"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"css"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"CSS"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"D"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"D"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ditaa"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ditaa"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"dot"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Graphviz"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"calc"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Emacs Calc"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"emacs-lisp"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Emacs Lisp"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"fortran"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Fortran"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"gnuplot"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"gnuplot"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"haskell"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Haskell"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"hledger"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"hledger"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"java"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Java"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"js"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Javascript"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ledger"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Ledger"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"lisp"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Lisp"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"lilypond"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Lilypond"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"lua"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Lua"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"matlab"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"MATLAB"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mscgen"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Mscgen"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ocaml"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Objective Caml"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"octave"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Octave"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"org"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Org mode"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"oz"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"OZ"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"plantuml"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Plantuml"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"processing"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Processing.js"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"python"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Python"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"R"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"R"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ruby"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Ruby"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"sass"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Sass"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"scheme"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Scheme"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"screen"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Gnu Screen"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"sed"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Sed"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"sh"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"shell"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"sql"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"SQL"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"sqlite"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"SQLite"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"forth"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Forth"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"io"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"IO"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"J"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"J"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"makefile"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Makefile"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"maxima"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Maxima"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"perl"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Perl"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"picolisp"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Pico Lisp"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"scala"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Scala"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"shell"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Shell Script"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ebnf2ps"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ebfn2ps"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"cpp"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"C++"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"abc"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ABC"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"coq"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Coq"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"groovy"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Groovy"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"bash"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"bash"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"csh"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"csh"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ash"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ash"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"dash"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"dash"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ksh"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ksh"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mksh"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"mksh"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"posh"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"posh"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ada"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Ada"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"asm"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Assembler"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"caml"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Caml"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"delphi"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Delphi"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"html"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"HTML"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"idl"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"IDL"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mercury"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Mercury"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"metapost"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"MetaPost"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"modula-2"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Modula-2"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"pascal"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Pascal"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ps"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"PostScript"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"prolog"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Prolog"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"simula"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Simula"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"tcl"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"tcl"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"tex"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"plain-tex"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"TeX"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"verilog"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Verilog"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"vhdl"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"VHDL"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"xml"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"XML"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"nxml"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"XML"</span><span class="ef-ob">)
                     (</span><span style="color: #50a14f; background-color: #e7e7e7;">"conf"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Configuration File"</span><span class="ef-ob">))))
      mode))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+name: Example, fixed width, and property blocks</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-html-block-collapsable</span><span class="ef-ob"> (orig-fn block contents info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Wrap the usual block in a &lt;details&gt;"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not org-fancy-html-export-mode) (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-msg-export-in-progress))
      (funcall orig-fn block contents info)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((ref (org-export-get-reference block info))
          (type (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (car block)
                  ('property-drawer </span><span style="color: #50a14f; background-color: #e7e7e7;">"Properties"</span><span class="ef-ob">)))
          (collapsed-default (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (car block)
                               ('property-drawer t)
                               (_ nil)))
          (collapsed-value (org-export-read-attribute </span><span style="color: #a626a4; background-color: #e7e7e7;">:attr_html</span><span class="ef-ob"> block </span><span style="color: #a626a4; background-color: #e7e7e7;">:collapsed</span><span class="ef-ob">))
          (collapsed-p (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (member (org-export-read-attribute </span><span style="color: #a626a4; background-color: #e7e7e7;">:attr_html</span><span class="ef-ob"> block </span><span style="color: #a626a4; background-color: #e7e7e7;">:collapsed</span><span class="ef-ob">)
                                   '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"y"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"yes"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"t"</span><span class="ef-ob"> t </span><span style="color: #50a14f; background-color: #e7e7e7;">"true"</span><span class="ef-ob">))
                           (member (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:collapsed</span><span class="ef-ob">) '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"all"</span><span class="ef-ob">)))))
      (format
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;details id='</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' class='</span><span style="color: #b751b6; background-color: #e7e7e7;">code</span><span style="color: #50a14f; background-color: #e7e7e7;">'%s&gt;
&lt;summary%s&gt;%s&lt;/summary&gt;
&lt;div class='</span><span style="color: #b751b6; background-color: #e7e7e7;">gutter</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;\
&lt;a href='#%s'&gt;#&lt;/a&gt;
&lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;⎘&lt;/button&gt;\
&lt;/div&gt;
%s\n
&lt;/details&gt;"</span><span class="ef-ob">
       ref
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> collapsed-p collapsed-default) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span> <span style="color: #50a14f; background-color: #e7e7e7;">" open"</span><span class="ef-ob">)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> type </span><span style="color: #50a14f; background-color: #e7e7e7;">" class='</span><span style="color: #b751b6; background-color: #e7e7e7;">named</span><span style="color: #50a14f; background-color: #e7e7e7;">'"</span> <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> type (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class='</span><span style="color: #b751b6; background-color: #e7e7e7;">type</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;%s&lt;/span&gt;"</span><span class="ef-ob"> type) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
       ref
       (funcall orig-fn block contents info)))))

(advice-add 'org-html-example-block   </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html-block-collapsable)
(advice-add 'org-html-fixed-width     </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html-block-collapsable)
(advice-add 'org-html-property-drawer </span><span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html-block-collapsable)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Include extra font-locking in htmlize</span>

Org uses <span style="color: #4078f2; font-weight: 700;">[[https://github.com/hniksic/emacs-htmlize][htmlize.el]]</span> to export buffers with syntax highlighting.

The works fantastically, for the most part. Minor modes that provide
font-locking are <span style="text-decoration: italic;">/not/</span> loaded, and so do not impact the result.

By enabling these modes in <span style="color: #84888b;">~htmlize-before-hook~</span> we can correct this behaviour.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(autoload #'highlight-numbers--turn-on </span><span style="color: #50a14f; background-color: #e7e7e7;">"highlight-numbers"</span><span class="ef-ob">)
(add-hook 'htmlize-before-hook #'highlight-numbers--turn-on)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Handle table overflow</span>

In order to accommodate wide tables ---particularly on mobile devices--- we want
to set a maximum width and scroll overflow. Unfortunately, this cannot be applied
directly to the <span style="color: #84888b;">~table~</span> element, so we have to wrap it in a <span style="color: #84888b;">~div~</span>.

While we're at it, we can a link gutter, as we did with src blocks, and show the
<span style="color: #84888b;">~#+name~</span>, if one is given.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-html-table-wrapped (orig-fn table contents info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Wrap the usual &lt;table&gt; in a &lt;div&gt;"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html-table
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not org-fancy-html-export-mode) (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-msg-export-in-progress))
      (funcall orig-fn table contents info)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((name (plist-get (cadr table) </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span><span class="ef-ob">))
           (ref (org-export-get-reference table info)))
      (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;div id='</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' class='</span><span style="color: #b751b6; background-color: #e7e7e7;">table</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;
&lt;div class='</span><span style="color: #b751b6; background-color: #e7e7e7;">gutter</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;&lt;a href='#%s'&gt;#&lt;/a&gt;&lt;/div&gt;
&lt;div class='</span><span style="color: #b751b6; background-color: #e7e7e7;">tabular</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;
%s
&lt;/div&gt;\
&lt;/div&gt;"</span><span class="ef-ob">
              ref ref
              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> name
                  (replace-regexp-in-string (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;table id=\"%s\""</span><span class="ef-ob"> ref) </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;table"</span><span class="ef-ob">
                                            (funcall orig-fn table contents info))
                (funcall orig-fn table contents info))))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** TOC as a collapsable tree</span>

The TOC is much nicer to navigate as a collapsable tree. Unfortunately we cannot
achieve this with CSS alone. Thankfully we can avoid JS though, by adapting the
TOC generation code to use a <span style="color: #84888b;">~label~</span> for each item, and a hidden <span style="color: #84888b;">~checkbox~</span> to keep
track of state.

To add this, we need to change one line in <span style="color: #4078f2; font-weight: 700;">[[file:lisp/org/lisp/ox-html.el::(format "&lt;a href=\"#%s\"&gt;%s&lt;/a&gt;"][org-html--format-toc-headline]]</span>.

Since we can actually accomplish the desired effect by adding advice <span style="text-decoration: italic;">/around/</span> the
function, without overriding it --- let's do that to reduce the bug surface of
this config a tad.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-html--format-toc-headline-colapseable (orig-fn headline info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Add a label and checkbox to `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html--format-toc-headline</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'s usual output,
to allow the TOC to be a collapseable tree."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html--format-toc-headline
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not org-fancy-html-export-mode) (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-msg-export-in-progress))
      (funcall orig-fn headline info)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((id (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:CUSTOM_ID</span><span class="ef-ob"> headline)
                  (org-export-get-reference headline info))))
      (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;input type='</span><span style="color: #b751b6; background-color: #e7e7e7;">checkbox</span><span style="color: #50a14f; background-color: #e7e7e7;">' id='</span><span style="color: #b751b6; background-color: #e7e7e7;">toc--%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'/&gt;&lt;label for='</span><span style="color: #b751b6; background-color: #e7e7e7;">toc--%s</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;%s&lt;/label&gt;"</span><span class="ef-ob">
              id id (funcall orig-fn headline info)))))
</span><span class="ef-obe">#+end_src
</span>
Now, leaves (headings with no children) shouldn't have the <span style="color: #84888b;">~label~</span> item. The
obvious way to achieve this is by including some <span style="text-decoration: italic;">/if no children.../</span> logic in
<span style="color: #84888b;">~org-html--format-toc-headline-colapseable~</span>. Unfortunately, I can't my elisp isn't
up to par to extract the number of child headings from the mountain of info that
org provides.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-html--toc-text-stripped-leaves (orig-fn toc-entries)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Remove label"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-html--toc-text
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not org-fancy-html-export-mode) (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-msg-export-in-progress))
      (funcall orig-fn toc-entries)
    (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;input [</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">&gt;]+&gt;&lt;label [</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">&gt;]+&gt;</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.+?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">&lt;/label&gt;&lt;/li&gt;"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\1&lt;/li&gt;"</span><span class="ef-ob">
                              (funcall orig-fn toc-entries))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Make verbatim different to code</span>

Since we have <span style="color: #84888b;">=verbatim=</span> and <span style="color: #84888b;">~code~</span>, let's make use of the difference.

We can use <span style="color: #84888b;">~code~</span> exclusively for code snippets and commands like: "calling
<span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Hello"</span><span class="ef-ob">)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> in batch-mode Emacs prints to stdout like <span style="color: #84888b;">~echo~</span>".
Then we can use <span style="color: #84888b;">=verbatim=</span> for miscellaneous 'other monospace' like keyboard
shortcuts: "either <span style="color: #84888b;">=C-c C-c=</span> or <span style="color: #84888b;">=C-g=</span> is likely the most useful keybinding in Emacs",
or file names: "I keep my configuration in <span style="color: #84888b;">=~/.config/doom/=</span>", among other things.

Then, styling these two cases differently can help improve clarity in a document.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-text-markup-alist
      '((bold . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;b&gt;%s&lt;/b&gt;"</span><span class="ef-ob">)
        (code . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;code&gt;%s&lt;/code&gt;"</span><span class="ef-ob">)
        (italic . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;i&gt;%s&lt;/i&gt;"</span><span class="ef-ob">)
        (strike-through . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;del&gt;%s&lt;/del&gt;"</span><span class="ef-ob">)
        (underline . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class=\"underline\"&gt;%s&lt;/span&gt;"</span><span class="ef-ob">)
        (verbatim . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;kbd&gt;%s&lt;/kbd&gt;"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Change checkbox type</span>

We also want to use HTML checkboxes, however we want to get a bit fancier than default
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">appendq!</span><span class="ef-ob"> org-html-checkbox-types
          '((html-span
             (on . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class='</span><span style="color: #b751b6; background-color: #e7e7e7;">checkbox</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;&lt;/span&gt;"</span><span class="ef-ob">)
             (off . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class='</span><span style="color: #b751b6; background-color: #e7e7e7;">checkbox</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;&lt;/span&gt;"</span><span class="ef-ob">)
             (trans . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;span class='</span><span style="color: #b751b6; background-color: #e7e7e7;">checkbox</span><span style="color: #50a14f; background-color: #e7e7e7;">'&gt;&lt;/span&gt;"</span><span class="ef-ob">))))
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-checkbox-type 'html-span)
</span><span class="ef-obe">#+end_src
</span>- <span style="font-weight: 700;">[ ]</span> I'm yet to do this
- <span style="font-weight: 700;">[-]</span> Work in progress
- <span style="font-weight: 700;">[X]</span> This is done

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Extra special strings</span>

The <span style="color: #84888b;">~org-html-special-string-regexps~</span> variable defines substitutions for:
+ <span style="color: #84888b;">=\-=</span>, a shy hyphen
+ <span style="color: #84888b;">=---=</span>, an em dash
+ <span style="color: #84888b;">=--=</span>, an en dash
+ <span style="color: #84888b;">=...=</span>, (horizontal) ellipses

However I think it would be nice if there was also a substitution for left/right
arrows (<span style="color: #84888b;">=-&gt;=</span> and <span style="color: #84888b;">=&lt;-=</span>). This is a <span style="color: #84888b;">~defconst~</span>, but as you may tell from the amount of
advice in this config, I'm not above messing with things I'm not 'supposed' to.

The only minor complication is that <span style="color: #84888b;">=&lt;=</span> and <span style="color: #84888b;">=&gt;=</span> are converted to <span style="color: #84888b;">=&amp;lt;=</span> and <span style="color: #84888b;">=&amp;gt;=</span>
before this stage of output processing.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">pushnew!</span><span class="ef-ob"> org-html-special-string-regexps
          '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"-&amp;gt;"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&amp;#8594;"</span><span class="ef-ob">)
          '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"&amp;lt;-"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"&amp;#8592;"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Header anchors</span>

I want to add GitHub-style links on hover for headings.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-export-html-headline-anchor</span><span class="ef-ob"> (text backend info)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (org-export-derived-backend-p backend 'html)
             (not (org-export-derived-backend-p backend 're-reveal))
             org-fancy-html-export-mode)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> org-msg-export-in-progress)
      (replace-regexp-in-string
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;h</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;"> id=\"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[a-z0-9-]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">\"&gt;</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">.*[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;"> ]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">&lt;\\/h[0-9]&gt;"</span> <span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">this is quite restrictive, but due to `</span><span style="color: #b751b6; background-color: #e7e7e7;">org-reference-contraction</span><span style="color: #84888b; background-color: #e7e7e7;">' I can do this
</span>       <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;h\\1 id=\"\\2\"&gt;\\3&lt;a aria-hidden=\"true\" href=\"#\\2\"&gt;#&lt;/a&gt; &lt;/h\\1&gt;"</span><span class="ef-ob">
       text))))

(add-to-list 'org-export-filter-headline-functions
             'org-export-html-headline-anchor)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Link previews</span>

Sometimes it's nice to make a link particularly prominent, an embed/preview like
Twitter does would be nice I think.

We can do this without too much trouble by adding a new link type ever so
slightly different from <span style="color: #84888b;">=https=</span> --- <span style="color: #84888b;">=Https=</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(org-link-set-parameters </span><span style="color: #50a14f; background-color: #e7e7e7;">"Https"</span>
                         <span style="color: #a626a4; background-color: #e7e7e7;">:follow</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (url arg) (browse-url (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"https:"</span><span class="ef-ob"> url) arg))
                         </span><span style="color: #a626a4; background-color: #e7e7e7;">:export</span><span class="ef-ob"> #'org-url-fancy-export)
</span><span class="ef-obe">#+end_src
</span>
Then, if we can fetch a plist of the form <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(</span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span> <span style="color: #50a14f; background-color: #e7e7e7;">"..."</span> <span style="color: #a626a4; background-color: #e7e7e7;">:description</span>
<span style="color: #50a14f; background-color: #e7e7e7;">"..."</span> <span style="color: #a626a4; background-color: #e7e7e7;">:image</span> <span style="color: #50a14f; background-color: #e7e7e7;">"..."</span><span class="ef-ob">)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> for such links via a function <span style="color: #84888b;">~org-url-unfurl-metadata~</span>, we
can make a fancy export.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-url-fancy-export</span><span class="ef-ob"> (url _desc backend)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((metadata (org-url-unfurl-metadata (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"https:"</span><span class="ef-ob"> url))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
     ((org-export-derived-backend-p backend 'html)
      (concat
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;div class=\"link-preview\"&gt;"</span><span class="ef-ob">
       (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;a href=\"%s\"&gt;"</span><span class="ef-ob"> (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"https:"</span><span class="ef-ob"> url))
       (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get metadata </span><span style="color: #a626a4; background-color: #e7e7e7;">:image</span><span class="ef-ob">)
         (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;img src=\"%s\"/&gt;"</span><span class="ef-ob"> (plist-get metadata </span><span style="color: #a626a4; background-color: #e7e7e7;">:image</span><span class="ef-ob">)))
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;small&gt;"</span><span class="ef-ob">
       (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"//</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">www\\.</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">/?.*"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\1"</span><span class="ef-ob"> url)
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/small&gt;&lt;p&gt;"</span><span class="ef-ob">
       (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get metadata </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">)
         (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;b&gt;"</span><span class="ef-ob"> (org-html-encode-plain-text (plist-get metadata </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob">)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/b&gt;&lt;/br&gt;"</span><span class="ef-ob">))
       (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get metadata </span><span style="color: #a626a4; background-color: #e7e7e7;">:description</span><span class="ef-ob">)
         (org-html-encode-plain-text (plist-get metadata </span><span style="color: #a626a4; background-color: #e7e7e7;">:description</span><span class="ef-ob">)))
       </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/p&gt;&lt;/a&gt;&lt;/div&gt;"</span><span class="ef-ob">))
     (t url))))
</span><span class="ef-obe">#+end_src
</span>
Now we just need to actually implement that metadata extraction function.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-url-unfurl-metadata--cache nil)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-url-unfurl-metadata</span><span class="ef-ob"> (url)
  (cdr (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (assoc url org-url-unfurl-metadata--cache)
           (car (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob">
                 (cons
                  url
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((head-data
                          (cl-remove-if-not
                           #'listp
                           (cdaddr
                            (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob">
                                (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob"> (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Fetching metadata from %s"</span><span class="ef-ob"> url)
                                       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"curl"</span><span class="ef-ob">)
                                           (</span><span style="color: #e45649; background-color: #e7e7e7;">with-current-buffer</span><span class="ef-ob"> (generate-new-buffer </span><span style="color: #50a14f; background-color: #e7e7e7;">" *curl*"</span><span class="ef-ob">)
                                             (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"curl"</span><span class="ef-ob"> nil t nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"--max-time"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"5"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-sSL"</span><span class="ef-ob"> url)
                                             (current-buffer))
                                         (url-retrieve-synchronously url t t 5)))
                              (goto-char (point-min))
                              (delete-region (point-min) (- (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;head"</span><span class="ef-ob">) 6))
                              (delete-region (search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;/head&gt;"</span><span class="ef-ob">) (point-max))
                              (goto-char (point-min))
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;script[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">\u2800]+?&lt;/script&gt;"</span><span class="ef-ob"> nil t)
                                (replace-match </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
                              (goto-char (point-min))
                              (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;style[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">\u2800]+?&lt;/style&gt;"</span><span class="ef-ob"> nil t)
                                (replace-match </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">))
                              (libxml-parse-html-region (point-min) (point-max))))))
                         (meta (delq nil
                                     (mapcar
                                      (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (tag)
                                        (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq 'meta (car tag))
                                          (cons (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr (assoc 'name (cadr tag)))
                                                    (cdr (assoc 'property (cadr tag))))
                                                (cdr (assoc 'content (cadr tag))))))
                                      head-data))))
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((title (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"og:title"</span><span class="ef-ob"> meta))
                                     (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"twitter:title"</span><span class="ef-ob"> meta))
                                     (nth 2 (assq 'title head-data))))
                          (description (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"og:description"</span><span class="ef-ob"> meta))
                                           (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"twitter:description"</span><span class="ef-ob"> meta))
                                           (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"description"</span><span class="ef-ob"> meta))))
                          (image (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"og:image"</span><span class="ef-ob"> meta))
                                     (cdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"twitter:image"</span><span class="ef-ob"> meta)))))
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> image
                        (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> image (replace-regexp-in-string
                                     </span><span style="color: #50a14f; background-color: #e7e7e7;">"^/"</span><span class="ef-ob"> (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://"</span><span class="ef-ob"> (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"//</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">/]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">/?.*"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\1"</span><span class="ef-ob"> url) </span><span style="color: #50a14f; background-color: #e7e7e7;">"/"</span><span class="ef-ob">)
                                     (replace-regexp-in-string
                                      </span><span style="color: #50a14f; background-color: #e7e7e7;">"^//"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://"</span><span class="ef-ob">
                                      image))))
                      (list </span><span style="color: #a626a4; background-color: #e7e7e7;">:title</span><span class="ef-ob"> title </span><span style="color: #a626a4; background-color: #e7e7e7;">:description</span><span class="ef-ob"> description </span><span style="color: #a626a4; background-color: #e7e7e7;">:image</span><span class="ef-ob"> image))))
                 org-url-unfurl-metadata--cache)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** LaTeX Rendering</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Pre-rendered</span>

I consider <span style="color: #84888b;">~dvisvgm~</span> to be a rather compelling option. However this isn't scaled
very well at the moment.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(setq-default org-html-with-latex `dvisvgm)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** MathJax</span>

I want to use svg MathJax by default, and with a few of the custom commands that
are part of my LaTeX preamble.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(setcdr (assoc 'path org-html-mathjax-options)
        (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"</span><span class="ef-ob">))

(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-html-mathjax-template
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;script&gt;
  window.MathJax = {
    loader: {
      load: ['[tex]/mathtools'],
    },
    tex: {
      ams: {
        multlineWidth: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%MULTLINEWIDTH</span><span style="color: #50a14f; background-color: #e7e7e7;">'
      },
      tags: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%TAGS</span><span style="color: #50a14f; background-color: #e7e7e7;">',
      tagSide: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%TAGSIDE</span><span style="color: #50a14f; background-color: #e7e7e7;">',
      tagIndent: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%TAGINDENT</span><span style="color: #50a14f; background-color: #e7e7e7;">',
      packages: {'[+]': ['</span><span style="color: #b751b6; background-color: #e7e7e7;">mathtools</span><span style="color: #50a14f; background-color: #e7e7e7;">']},
      macros: {
        RR: ['\\\\ifstrempty{#1}{\\\\mathbb{R}}{\\\\mathbb{R}^{#1}}', 1, ''],
        NN: ['\\\\ifstrempty{#1}{\\\\mathbb{N}}{\\\\mathbb{N}^{#1}}', 1, ''],
        ZZ: ['\\\\ifstrempty{#1}{\\\\mathbb{Z}}{\\\\mathbb{Z}^{#1}}', 1, ''],
        QQ: ['\\\\ifstrempty{#1}{\\\\mathbb{Q}}{\\\\mathbb{Q}^{#1}}', 1, ''],
        CC: ['\\\\ifstrempty{#1}{\\\\mathbb{C}}{\\\\mathbb{C}^{#1}}', 1, ''],
        EE: '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\mathbb{E}</span><span style="color: #50a14f; background-color: #e7e7e7;">',
        Lap: '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\operatorname{\\\\mathcal{L}}</span><span style="color: #50a14f; background-color: #e7e7e7;">',
        Var: '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\operatorname{Var}</span><span style="color: #50a14f; background-color: #e7e7e7;">',
        Cor: '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\operatorname{Cor}</span><span style="color: #50a14f; background-color: #e7e7e7;">',
        E: '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\operatorname{E}</span><span style="color: #50a14f; background-color: #e7e7e7;">',
      },
      mathtools: {
        pairedDelimiters: {
          abs: ['</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\lvert</span><span style="color: #50a14f; background-color: #e7e7e7;">', '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\rvert</span><span style="color: #50a14f; background-color: #e7e7e7;">'],
          norm: ['</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\lVert</span><span style="color: #50a14f; background-color: #e7e7e7;">', '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\rVert</span><span style="color: #50a14f; background-color: #e7e7e7;">'],
          ceil: ['</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\lceil</span><span style="color: #50a14f; background-color: #e7e7e7;">', '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\rceil</span><span style="color: #50a14f; background-color: #e7e7e7;">'],
          floor: ['</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\lfloor</span><span style="color: #50a14f; background-color: #e7e7e7;">', '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\rfloor</span><span style="color: #50a14f; background-color: #e7e7e7;">'],
          round: ['</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\lfloor</span><span style="color: #50a14f; background-color: #e7e7e7;">', '</span><span style="color: #b751b6; background-color: #e7e7e7;">\\\\rceil</span><span style="color: #50a14f; background-color: #e7e7e7;">'],
        }
      }
    },
    chtml: {
      scale: %SCALE,
      displayAlign: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%ALIGN</span><span style="color: #50a14f; background-color: #e7e7e7;">',
      displayIndent: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%INDENT</span><span style="color: #50a14f; background-color: #e7e7e7;">'
    },
    svg: {
      scale: %SCALE,
      displayAlign: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%ALIGN</span><span style="color: #50a14f; background-color: #e7e7e7;">',
      displayIndent: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%INDENT</span><span style="color: #50a14f; background-color: #e7e7e7;">'
    },
    output: {
      font: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%FONT</span><span style="color: #50a14f; background-color: #e7e7e7;">',
      displayOverflow: '</span><span style="color: #b751b6; background-color: #e7e7e7;">%OVERFLOW</span><span style="color: #50a14f; background-color: #e7e7e7;">'
    }
  };
&lt;/script&gt;

&lt;script
  id=\"MathJax-script\"
  async
  src=\"%PATH\"&gt;
&lt;/script&gt;"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** LaTeX Export</span>

<span style="color: #84888b;">#+call: confpkg("ox-latex", after="ox-latex")</span>

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Compiling</span>

By default Org uses <span style="color: #84888b;">~pdflatex~</span> \times 3 + <span style="color: #84888b;">~bibtex~</span>. This simply won't do in our
modern world. <span style="color: #84888b;">~latexmk~</span> + <span style="color: #84888b;">~biber~</span> (which is used automatically with <span style="color: #84888b;">~latexmk~</span>) is a
simply superior combination.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">org-latex-compilers = ("pdflatex" "xelatex" "lualatex"), which are the possible values for %latex
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-latex-pdf-process '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"LC_ALL=en_US.UTF-8 latexmk -f -pdf -%latex -shell-escape -interaction=nonstopmode -output-directory=%o %f"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
While <span style="color: #84888b;">~org-latex-pdf-process~</span> does support a function, and we could use that
instead, this would no longer use the log buffer --- it's a bit blind, you give
it the file name and expect it to do its thing.

The default values of <span style="color: #84888b;">~org-latex-compilers~</span> is given in commented form to see how
<span style="color: #84888b;">~org-latex-pdf-process~</span> works with them.

While the <span style="color: #84888b;">~-%latex~</span> above is slightly hacky (<span style="color: #84888b;">~-pdflatex~</span> expects to be given a
value) it allows us to leave <span style="color: #84888b;">~org-latex-compilers~</span> unmodified.
This is nice in case I open an org file that uses <span style="color: #84888b;">=#+LATEX_COMPILER=</span> for example,
it should still work.

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Nicer checkboxes</span>

We'll assume that thanks to the clever preamble the various custom <span style="color: #84888b;">=\checkbox...=</span>
commands below are defined.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-export-latex-fancy-item-checkboxes</span><span class="ef-ob"> (text backend info)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-export-derived-backend-p backend 'latex)
    (replace-regexp-in-string
     </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\item\\[{$\\\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">\\w+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">$}\\]"</span><span class="ef-ob">
     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (fullmatch)
       (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\item["</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (substring fullmatch 9 -3) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">content of capture group
</span><span class="ef-ob">                             (</span><span style="color: #50a14f; background-color: #e7e7e7;">"square"</span>   <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\checkboxUnchecked"</span><span class="ef-ob">)
                             (</span><span style="color: #50a14f; background-color: #e7e7e7;">"boxminus"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\checkboxTransitive"</span><span class="ef-ob">)
                             (</span><span style="color: #50a14f; background-color: #e7e7e7;">"boxtimes"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\checkboxChecked"</span><span class="ef-ob">)
                             (_ (substring fullmatch 9 -3))) </span><span style="color: #986801; background-color: #e7e7e7;">"]"</span><span style="color: #986801; background-color: #e7e7e7;">))</span><span class="ef-ob">
     text)))

(add-to-list 'org-export-filter-item-functions
             '+org-export-latex-fancy-item-checkboxes)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Class templates</span>

I really like the KOMA bundle. It provides a set of mechanisms to tweak document
styling which is both easy to use, and quite comprehensive.
For example, I rather like section numbers in the margin, which can be
accomplished with
<span style="color: #84888b;">#+name: latex-hanging-secnum</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #a626a4; background-color: #e7e7e7;">\sectionformat</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\llap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\thesection</span><span style="color: #a626a4; background-color: #e7e7e7;">\autodot</span><span style="color: #a626a4; background-color: #e7e7e7;">\enskip</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #a626a4; background-color: #e7e7e7;">\subsectionformat</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\llap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\thesubsection</span><span style="color: #a626a4; background-color: #e7e7e7;">\autodot</span><span style="color: #a626a4; background-color: #e7e7e7;">\enskip</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #a626a4; background-color: #e7e7e7;">\subsubsectionformat</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\llap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\thesubsubsection</span><span style="color: #a626a4; background-color: #e7e7e7;">\autodot</span><span style="color: #a626a4; background-color: #e7e7e7;">\enskip</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
It can also be nice to have big <span style="color: #84888b;">=\chapter=​</span>s.
<span style="color: #84888b;">#+name: latex-big-chapter</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">\RedeclareSectionCommand</span><span class="ef-ob">[afterindent=false, beforeskip=0pt, afterskip=0pt, innerskip=0pt]{chapter}
</span><span style="color: #84888b; background-color: #e7e7e7;">\setkomafont</span><span class="ef-ob">{chapter}{</span><span style="color: #e45649; background-color: #e7e7e7;">\normalfont</span><span style="color: #986801; background-color: #e7e7e7;">\Huge</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\chapterheadstartvskip</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\vspace</span><span style="color: #a626a4; background-color: #e7e7e7;">*{0</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselineskip</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\chapterheadendvskip</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\vspace</span><span style="color: #a626a4; background-color: #e7e7e7;">*{0</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselineskip</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\chapterformat</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\fontsize</span><span style="color: #a626a4; background-color: #e7e7e7;">{60}{30}</span><span style="color: #a626a4; background-color: #e7e7e7;">\selectfont</span><span style="color: #a626a4; background-color: #e7e7e7;">\rlap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\hspace</span><span style="color: #a626a4; background-color: #e7e7e7;">{6pt}</span><span style="color: #a626a4; background-color: #e7e7e7;">\thechapter</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span style="color: #a626a4; background-color: #e7e7e7;">\chapterlinesformat</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">3</span><span class="ef-ob">]{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\parbox</span><span style="color: #a626a4; background-color: #e7e7e7;">[b]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\dimexpr</span><span style="color: #a626a4; background-color: #e7e7e7;">\textwidth</span><span style="color: #a626a4; background-color: #e7e7e7;">-0.5em</span><span style="color: #a626a4; background-color: #e7e7e7;">\relax</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\raggedleft</span><span style="color: #a626a4; background-color: #e7e7e7;">{{</span><span style="color: #a626a4; background-color: #e7e7e7;">\large</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\scshape</span><span style="color: #a626a4; background-color: #e7e7e7;">\bfseries</span><span style="color: #a626a4; background-color: #e7e7e7;">\chapapp</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #a626a4; background-color: #e7e7e7;">\vspace</span><span style="color: #a626a4; background-color: #e7e7e7;">{-0.5ex}</span><span style="color: #a626a4; background-color: #e7e7e7;">\par</span><span style="color: #a626a4; background-color: #e7e7e7;">\Huge</span><span style="color: #a626a4; background-color: #e7e7e7;">#3}}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\hfill</span><span style="color: #a626a4; background-color: #e7e7e7;">\makebox</span><span style="color: #a626a4; background-color: #e7e7e7;">[0pt][l]{#2}</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
Now let's just sprinkle some KOMA all over the Org LaTeX classes.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> ox-latex
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((article-sections '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\section{%s}"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\section*{%s}"</span><span class="ef-ob">)
                             (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\subsection{%s}"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\subsection*{%s}"</span><span class="ef-ob">)
                             (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\subsubsection{%s}"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\subsubsection*{%s}"</span><span class="ef-ob">)
                             (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\paragraph{%s}"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\paragraph*{%s}"</span><span class="ef-ob">)
                             (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\subparagraph{%s}"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\subparagraph*{%s}"</span><span class="ef-ob">)))
         (book-sections (append '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\chapter{%s}"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\chapter*{%s}"</span><span class="ef-ob">))
                                article-sections))
         (hanging-secnum-preamble &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-hanging-secnum"</span><span class="ef-ob">)&gt;&gt;)
         (big-chap-preamble &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-big-chapter"</span><span class="ef-ob">)&gt;&gt;))
    (setcdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"article"</span><span class="ef-ob"> org-latex-classes)
            `(,(concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\documentclass{scrartcl}"</span><span class="ef-ob"> hanging-secnum-preamble)
              ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(</span><span style="color: #50a14f; background-color: #e7e7e7;">"report"</span><span class="ef-ob"> ,(concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\documentclass{scrartcl}"</span><span class="ef-ob"> hanging-secnum-preamble)
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(</span><span style="color: #50a14f; background-color: #e7e7e7;">"book"</span><span class="ef-ob"> ,(concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\documentclass[twoside=false]{scrbook}"</span><span class="ef-ob">
                                   big-chap-preamble hanging-secnum-preamble)
                   ,@book-sections))
    (add-to-list 'org-latex-classes
                 `(</span><span style="color: #50a14f; background-color: #e7e7e7;">"blank"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span><span class="ef-ob">
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(</span><span style="color: #50a14f; background-color: #e7e7e7;">"bmc-article"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\documentclass[article,code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span><span class="ef-ob">
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(</span><span style="color: #50a14f; background-color: #e7e7e7;">"bmc"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\documentclass[code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span><span class="ef-ob">
                   ,@book-sections))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-latex-tables-booktabs t
      org-latex-hyperref-template
      &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-fancy-hyperref"</span><span class="ef-ob">)&gt;&gt;
      org-latex-reference-command </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\cref{%s}"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>

The <span style="color: #84888b;">=hyperref=</span> setup needs to be handled separately however.
<span style="color: #84888b;">#+name: latex-fancy-hyperref</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">\providecolor</span><span class="ef-ob">{url}{HTML}{0077bb}
</span><span style="color: #84888b; background-color: #e7e7e7;">\providecolor</span><span class="ef-ob">{link}{HTML}{882255}
</span><span style="color: #84888b; background-color: #e7e7e7;">\providecolor</span><span class="ef-ob">{cite}{HTML}{999933}
</span><span style="color: #84888b; background-color: #e7e7e7;">\hypersetup</span><span class="ef-ob">{
  pdfauthor={</span><span style="color: #84888b; background-color: #e7e7e7;">%a},
</span><span class="ef-ob">  pdftitle={</span><span style="color: #84888b; background-color: #e7e7e7;">%t},
</span><span class="ef-ob">  pdfkeywords={</span><span style="color: #84888b; background-color: #e7e7e7;">%k},
</span><span class="ef-ob">  pdfsubject={</span><span style="color: #84888b; background-color: #e7e7e7;">%d},
</span><span class="ef-ob">  pdfcreator={</span><span style="color: #84888b; background-color: #e7e7e7;">%c},
</span><span class="ef-ob">  pdflang={</span><span style="color: #84888b; background-color: #e7e7e7;">%L},
</span><span class="ef-ob">  breaklinks=true,
  colorlinks=true,
  linkcolor=link,
  urlcolor=url,
  citecolor=cite
}
</span><span style="color: #84888b; background-color: #e7e7e7;">\urlstyle</span><span class="ef-ob">{same}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** A cleverer preamble</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Use case</span>

We often want particular snippets of LaTeX in our documents preambles.
It's a pain to have to work out / remember them every time.

We could have every package we could possibly need in every one of
<span style="color: #84888b;">~org-latex-classes~</span>, but that's <span style="text-decoration: italic;">/horribly/</span> inefficient and I don't want to think
about maintaining that.

Instead we can provide some granularity by splitting up the features we want,
and then take the experience to a whole new level by implementing a system to
automatically detect which features are desired and generating a preamble that
provides these features.

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Conditional Content</span>

Let's consider content we want in particular situations.

Captions could do with a bit of tweaking such that
+ You can easily have multiple captions
+ Links to figures take you to the <span style="text-decoration: italic;">/top/</span> of the figure (not the bottom)
+ Caption labels could do with being emphasised slightly more
+ Multiline captions should run ragged-right, but only when then span more than
  one line

<span style="color: #84888b;">#+name: org-latex-caption-preamble</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">subcaption</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">hypcap=true</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">caption</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\setkomafont</span><span class="ef-ob">{caption}{</span><span style="color: #e45649; background-color: #e7e7e7;">\sffamily</span><span style="color: #986801; background-color: #e7e7e7;">\small</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\setkomafont</span><span class="ef-ob">{captionlabel}{</span><span style="color: #e45649; background-color: #e7e7e7;">\upshape</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\bfseries</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\captionsetup</span><span class="ef-ob">{justification=raggedright,singlelinecheck=true}
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">capt-of</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% required by Org
</span><span class="ef-obe">#+end_src
</span>
The default checkboxes look rather ugly, so let's provide some prettier alternatives.

<span style="color: #84888b;">#+name: org-latex-checkbox-preamble</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\checkboxUnchecked</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span style="color: #a626a4; background-color: #e7e7e7;">\square</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\checkboxTransitive</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\rlap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\raisebox</span><span style="color: #a626a4; background-color: #e7e7e7;">{-0.1ex}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\hspace</span><span style="color: #a626a4; background-color: #e7e7e7;">{0.35ex}</span><span style="color: #a626a4; background-color: #e7e7e7;">\Large</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #a626a4; background-color: #e7e7e7;">textbf</span><span style="color: #a626a4; background-color: #e7e7e7;"> -}}</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span style="color: #a626a4; background-color: #e7e7e7;">\square</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\checkboxChecked</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\rlap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\raisebox</span><span style="color: #a626a4; background-color: #e7e7e7;">{0.2ex}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\hspace</span><span style="color: #a626a4; background-color: #e7e7e7;">{0.35ex}</span><span style="color: #a626a4; background-color: #e7e7e7;">\scriptsize</span> <span style="color: #a626a4; background-color: #e7e7e7;">\ding</span><span style="color: #a626a4; background-color: #e7e7e7;">{52}}}</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span style="color: #a626a4; background-color: #e7e7e7;">\square</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
We set up a maths typesetting preamble <span style="color: #4078f2; font-weight: 700;">[[*Maths notation conveniences][later on]]</span>, but it would be nice to save it
to a variable here:

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-maths-preamble</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-maths-conveniences"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Preamble that sets up a bunch of mathematical conveniences."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
It's nice to have "message blocks", things like info/warning/error/success.
A LaTeX macro should make them trivial to create.

<span style="color: #84888b;">#+name: org-latex-box-preamble</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">\ExplSyntaxOn</span>
<span style="color: #84888b; background-color: #e7e7e7;">\NewCoffin</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXBaseline</span>
<span style="color: #84888b; background-color: #e7e7e7;">\NewCoffin</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXHeader</span>
<span style="color: #84888b; background-color: #e7e7e7;">\NewCoffin</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span>
<span style="color: #84888b; background-color: #e7e7e7;">\NewCoffin</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXSideRule</span>
<span style="color: #84888b; background-color: #e7e7e7;">\newbox</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXSplitBox</span>
<span style="color: #84888b; background-color: #e7e7e7;">\cs</span><span class="ef-ob">_new_protected:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_start:nnn {
  </span><span style="color: #84888b; background-color: #e7e7e7;">% #1 ding, #3 name, #4 label
</span>  <span style="color: #84888b; background-color: #e7e7e7;">\vcoffin</span><span class="ef-ob">_set:Nnn </span><span style="color: #84888b; background-color: #e7e7e7;">\SBXHeader</span><span class="ef-ob"> { </span><span style="color: #84888b; background-color: #e7e7e7;">\linewidth</span><span class="ef-ob"> - 1em } {
  </span><span style="color: #e45649; background-color: #e7e7e7;">\noindent</span><span style="color: #84888b; background-color: #e7e7e7;">\textcolor</span><span class="ef-ob">{#2}{#1}~</span><span style="color: #84888b; background-color: #e7e7e7;">\textcolor</span><span class="ef-ob">{#2}{</span><span style="color: #e45649; background-color: #e7e7e7;">\textbf</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">#3</span><span class="ef-ob">}}}
  </span><span style="color: #84888b; background-color: #e7e7e7;">\vcoffin</span><span class="ef-ob">_set:Nnw </span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob"> { </span><span style="color: #84888b; background-color: #e7e7e7;">\linewidth</span><span class="ef-ob"> - 1.5em }
}
</span><span style="color: #84888b; background-color: #e7e7e7;">\cs</span><span class="ef-ob">_new_protected:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_split_content:n {
  </span><span style="color: #84888b; background-color: #e7e7e7;">% #1 name
</span>  <span style="color: #84888b; background-color: #e7e7e7;">\setbox</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXSplitBox</span><span class="ef-ob"> = </span><span style="color: #84888b; background-color: #e7e7e7;">\vbox</span><span class="ef-ob">:n { </span><span style="color: #84888b; background-color: #e7e7e7;">\vbox</span><span class="ef-ob">_unpack_drop:N </span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob"> }
  </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_set:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\l</span><span class="ef-ob">_tmpa_dim { </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_eval:n { </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_min:nn { </span><span style="color: #84888b; background-color: #e7e7e7;">\pagegoal</span><span class="ef-ob"> } { </span><span style="color: #84888b; background-color: #e7e7e7;">\textheight</span><span class="ef-ob"> } - </span><span style="color: #84888b; background-color: #e7e7e7;">\pagetotal</span><span class="ef-ob"> - 2</span><span style="color: #84888b; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob"> } }
  </span><span style="color: #84888b; background-color: #e7e7e7;">\setbox</span><span class="ef-ob">0 = </span><span style="color: #84888b; background-color: #e7e7e7;">\vsplit</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXSplitBox</span><span class="ef-ob"> to </span><span style="color: #84888b; background-color: #e7e7e7;">\l</span><span class="ef-ob">_tmpa_dim
  </span><span style="color: #84888b; background-color: #e7e7e7;">\vcoffin</span><span class="ef-ob">_set:Nnn </span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob"> { </span><span style="color: #84888b; background-color: #e7e7e7;">\CoffinWidth</span> <span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob"> } { </span><span style="color: #84888b; background-color: #e7e7e7;">\box</span><span class="ef-ob">0 </span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #e45649; background-color: #e7e7e7;">\vspace</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">-1.7</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob">}
    </span><span style="color: #e45649; background-color: #e7e7e7;">\noindent</span><span style="color: #84888b; background-color: #e7e7e7;">\textcolor</span><span class="ef-ob">{#1}{</span><span style="color: #e45649; background-color: #e7e7e7;">\textbf</span><span class="ef-ob">{</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\ldots</span> <span class="ef-ob">}}
    </span><span style="color: #e45649; background-color: #e7e7e7;">\vspace</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">-0.3</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob">}}
}
</span><span style="color: #84888b; background-color: #e7e7e7;">\cs</span><span class="ef-ob">_new_protected:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_split_refill:nnnn {
  </span><span style="color: #84888b; background-color: #e7e7e7;">% #1 ding, #2 ding offset, #3 name, #4 label
</span>  <span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_start:nnn {#1} {#3} {#4,</span><span style="color: #84888b; background-color: #e7e7e7;">\space</span><span class="ef-ob">{}</span><span style="color: #e45649; background-color: #e7e7e7;">\emph</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7; text-decoration: italic;">continued</span><span class="ef-ob">}}
  </span><span style="color: #e45649; background-color: #e7e7e7;">\vspace</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">-0.2</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob">}
  </span><span style="color: #84888b; background-color: #e7e7e7;">\vbox</span><span class="ef-ob">_unpack_drop:N </span><span style="color: #84888b; background-color: #e7e7e7;">\SBXSplitBox</span>
  <span style="color: #84888b; background-color: #e7e7e7;">\vcoffin</span><span class="ef-ob">_set_end:
}
</span><span style="color: #84888b; background-color: #e7e7e7;">\cs</span><span class="ef-ob">_new_protected:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_typeset:nn {
    </span><span style="color: #84888b; background-color: #e7e7e7;">% #1 name, #2 ding offset
</span>    <span style="color: #84888b; background-color: #e7e7e7;">\vcoffin</span><span class="ef-ob">_set:Nnn </span><span style="color: #84888b; background-color: #e7e7e7;">\SBXBaseline</span><span class="ef-ob"> {0pt} {</span><span style="color: #84888b; background-color: #e7e7e7;">\vbox</span><span class="ef-ob">{}}
    </span><span style="color: #84888b; background-color: #e7e7e7;">\SetHorizontalCoffin</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXSideRule</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\color</span><span class="ef-ob">{#1}</span><span style="color: #e45649; background-color: #e7e7e7;">\rule</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">1pt</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\dim</span><span style="color: #a626a4; background-color: #e7e7e7;">_eval:n { </span><span style="color: #a626a4; background-color: #e7e7e7;">\CoffinTotalHeight</span><span style="color: #a626a4; background-color: #e7e7e7;">\SBXContent</span><span style="color: #a626a4; background-color: #e7e7e7;"> + </span><span style="color: #a626a4; background-color: #e7e7e7;">\baselineskip</span><span style="color: #a626a4; background-color: #e7e7e7;"> }</span><span class="ef-ob">}}
    </span><span style="color: #84888b; background-color: #e7e7e7;">\JoinCoffins</span><span class="ef-ob">*</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob">[l,t]</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXSideRule</span><span class="ef-ob">[l,t](</span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_eval:n {#2 - 1em}, </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_eval:n{</span><span style="color: #84888b; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob"> - 0.5em})
    </span><span style="color: #84888b; background-color: #e7e7e7;">\JoinCoffins</span><span class="ef-ob">*</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob">[l,t]</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXHeader</span><span class="ef-ob">[l,B](-1em, 0.5</span><span style="color: #84888b; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob">)
    </span><span style="color: #84888b; background-color: #e7e7e7;">\JoinCoffins</span><span class="ef-ob">*</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXBaseline</span><span class="ef-ob">[l,T]</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob">[l,T]
    </span><span style="color: #e45649; background-color: #e7e7e7;">\vspace</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">-0.5</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob">}
    </span><span style="color: #e45649; background-color: #e7e7e7;">\noindent</span><span style="color: #84888b; background-color: #e7e7e7;">\TypesetCoffin</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXBaseline</span><span class="ef-ob">(</span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_eval:n { 1em - #2 + 1pt }, 0pt)
    </span><span style="color: #e45649; background-color: #e7e7e7;">\vspace</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\CoffinTotalHeight</span><span style="color: #a626a4; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob">}
    </span><span style="color: #e45649; background-color: #e7e7e7;">\vspace</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">-0.08em</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% Why on earth is this needed for baseline alignment!?
</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\cs</span><span class="ef-ob">_new_protected:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_typeset_breakable:nnnn {
    </span><span style="color: #84888b; background-color: #e7e7e7;">% #1 ding, #2 ding offset, #3 name, #4 label
</span>    <span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_set:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\l</span><span class="ef-ob">_tmpa_dim {</span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_eval:n { </span><span style="color: #84888b; background-color: #e7e7e7;">\CoffinTotalHeight</span><span style="color: #84888b; background-color: #e7e7e7;">\SBXContent</span><span class="ef-ob"> + </span><span style="color: #84888b; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob"> }}
    </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_set:Nn </span><span style="color: #84888b; background-color: #e7e7e7;">\l</span><span class="ef-ob">_tmpb_dim { </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_eval:n { </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_min:nn { </span><span style="color: #84888b; background-color: #e7e7e7;">\pagegoal</span><span class="ef-ob"> } { </span><span style="color: #84888b; background-color: #e7e7e7;">\textheight</span><span class="ef-ob"> } - </span><span style="color: #84888b; background-color: #e7e7e7;">\pagetotal</span><span class="ef-ob"> - </span><span style="color: #84888b; background-color: #e7e7e7;">\baselineskip</span><span class="ef-ob"> } }
    </span><span style="color: #84888b; background-color: #e7e7e7;">\dim</span><span class="ef-ob">_compare:nNnTF {</span><span style="color: #84888b; background-color: #e7e7e7;">\l</span><span class="ef-ob">_tmpa_dim} &gt; {</span><span style="color: #84888b; background-color: #e7e7e7;">\l</span><span class="ef-ob">_tmpb_dim} {
      </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_split_content:n {#3}
      </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_typeset:nn {#3} {#2}
      </span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\newpage</span>
      <span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_split_refill:nnnn {#1} {#2} {#3} {#4}
      </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_typeset_breakable:nnnn {#1} {#2} {#3} {#4}
    }{
      </span><span style="color: #84888b; background-color: #e7e7e7;">\simplebox</span><span class="ef-ob">_typeset:nn {#3} {#2}
    }
}
</span><span style="color: #e45649; background-color: #e7e7e7;">\NewDocumentCommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\defsimplebox</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">O{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ding</span><span style="color: #a626a4; background-color: #e7e7e7;">{117}} O{0.35em} O{#1} O{#2} m m m</span><span class="ef-ob">}{</span>
  <span style="color: #84888b; background-color: #e7e7e7;">% #1 ding, #2 ding offset, #3 alt-ding, #4 alt-ding offset,
</span>  <span style="color: #84888b; background-color: #e7e7e7;">% #5 name, #6 colour, #7 default label
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\definecolor</span><span style="color: #a626a4; background-color: #e7e7e7;">{#5}{HTML}{#6}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\NewDocumentEnvironment</span><span style="color: #a626a4; background-color: #e7e7e7;">{#5}{ O{#7} }{
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\simplebox</span><span style="color: #a626a4; background-color: #e7e7e7;">_start:nnn {#1} {#5} {##1}
  }{
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\vcoffin</span><span style="color: #a626a4; background-color: #e7e7e7;">_set_end:
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\simplebox</span><span style="color: #a626a4; background-color: #e7e7e7;">_typeset_breakable:nnnn {#3} {#4} {#5} {##1}
  }
</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\ExplSyntaxOff</span>
<span class="ef-obe">#+end_src
</span>
Lastly, we will pass this content into some global variables we for ease of
access.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-embed-files-preamble</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"org-latex-embed-files-preamble"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Preamble that embeds files within the pdf."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-caption-preamble</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"org-latex-caption-preamble"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Preamble that improves captions."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-checkbox-preamble</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"org-latex-checkbox-preamble"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Preamble that improves checkboxes."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-box-preamble</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"org-latex-box-preamble"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"Preamble that provides a macro for custom boxes."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
In the "universal preamble", we already embed the source <span style="color: #84888b;">=.org=</span> file, but it would
be nice to embed all the tangled files. This is fairly easy to accomplish by
mapping each tangled file to a form which embeds the file if it exists.
Considering we're going this far, why not add a dedicated <span style="color: #84888b;">=#+emded=</span> keyword, so we
can embed whatever we want.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-embed-extra-files</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return a string that uses embedfile to embed all tangled files."</span><span class="ef-ob">
  (mapconcat
   (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (file-desc)
     (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\IfFileExists{%1$s}{\\embedfile[desc=%2$s]{%1$s}}{}"</span><span class="ef-ob">
             (</span><span style="color: #e45649; background-color: #e7e7e7;">thread-last</span><span class="ef-ob"> (car file-desc)
                          (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\\\\\"</span><span class="ef-ob">)
                          (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"~"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\string~"</span><span class="ef-ob">))
             (cdr file-desc)))
   (append
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (tangle-fspecs) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">All files being tangled to.
</span><span class="ef-ob">      (org-element-cache-map
       (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (src)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not (org-in-commented-heading-p nil src))
                    (not (org-in-archived-heading-p nil src)))
           (</span><span style="color: #e45649; background-color: #e7e7e7;">when-let</span><span class="ef-ob"> ((lang (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:language</span><span class="ef-ob"> src))
                      (params
                       (apply
                        #'org-babel-merge-params
                        (append
                         (</span><span style="color: #e45649; background-color: #e7e7e7;">org-with-point-at</span><span class="ef-ob"> (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:begin</span><span class="ef-ob"> src)
                           (org-babel-params-from-properties lang t))
                         (mapcar
                          (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (h)
                            (org-babel-parse-header-arguments h t))
                          (cons (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:parameters</span><span class="ef-ob"> src)
                                (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:header</span><span class="ef-ob"> src))))))
                      (tangle-value
                       (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (alist-get </span><span style="color: #a626a4; background-color: #e7e7e7;">:tangle</span><span class="ef-ob"> params)
                         ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (pred stringp) (pred (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"^(.*)$"</span><span class="ef-ob">)) expr)
                          (eval (read expr)))
                         (val val)))
                      (tangle-file
                       (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> tangle-value
                         ((</span><span style="color: #e45649; background-color: #e7e7e7;">or</span> <span style="color: #50a14f; background-color: #e7e7e7;">"no"</span><span class="ef-ob"> (guard (member (alist-get </span><span style="color: #a626a4; background-color: #e7e7e7;">:export-embed</span><span class="ef-ob"> params) '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"no"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"nil"</span><span class="ef-ob">))))
                          nil)
                         (</span><span style="color: #50a14f; background-color: #e7e7e7;">"yes"</span><span class="ef-ob">
                          (file-name-with-extension
                           (file-name-nondirectory (buffer-file-name))
                           (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (alist-get lang org-babel-tangle-lang-exts nil nil #'equal)
                               lang)))
                         (val val))))
             (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (assoc tangle-file tangle-fspecs)
               (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob">
                (cons tangle-file (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Tangled %s file"</span><span class="ef-ob"> lang))
                tangle-fspecs)))))
       </span><span style="color: #a626a4; background-color: #e7e7e7;">:granularity</span><span class="ef-ob"> 'element
       </span><span style="color: #a626a4; background-color: #e7e7e7;">:restrict-elements</span><span class="ef-ob"> '(src-block))
      (nreverse tangle-fspecs))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (extra-files)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
        (goto-char (point-min))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+embed:"</span><span class="ef-ob"> nil t)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((file-desc (split-string (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> (org-element-at-point)) </span><span style="color: #50a14f; background-color: #e7e7e7;">" :desc</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">ription</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">? "</span><span class="ef-ob">)))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (cons (car file-desc) (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr file-desc) </span><span style="color: #50a14f; background-color: #e7e7e7;">"Extra file"</span><span class="ef-ob">)) extra-files))))
      (nreverse extra-files)))
   </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Now all tangled files will be embedded, and we can embed arbitrary files like
so:
<span class="ef-obb">#+begin_src org
</span><span class="ef-ob">,#+embed: some-file :description flavour text about the file
</span><span class="ef-obe">#+end_src
</span>
This currently won't complete or anything like that, as we haven't told Org that
it's a keyword yet. It's also LaTeX-specific, so maybe it should be changed to
<span style="color: #84888b;">=#+latex_embed=</span> or something like that.

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Content-feature-preamble association</span>

Initially this idea was implemented with an alist that associated a construct
that would search the current Org file for an indication that some feature was
needed, with a LaTeX snippet to be inserted in the preamble which would provide
that feature.
This is all well and good when there is a bijection between detected features
and the LaTeX code needed to support those features, but in many cases this
relation is not injective.

To better model the reality of the situation, I add an extra layer to this
process where each detected feature gives a list of required "feature flags".
Simply be merging the lists of feature flags we no longer have to require
injectivity to avoid LaTeX duplication. Then the extra layer forms a bijection
between there feature flags and a specification which can be used to implement
the feature.

This model also provides a number of nice secondary benefits, such as a simple
implementation of feature dependency.

<span class="ef-obb">#+begin_src dot :file misc/org-latex-clever-preamble.svg :exports none
</span><span class="ef-ob">digraph {
    graph [bgcolor="transparent"];
    node  [shape="underline" penwidth="2" width="1.3" style="rounded,filled" fillcolor="#efefef" color="#c9c9c9" fontcolor="#000000" fontname="overpass"];
    edge  [color="#aaaaaa" penwidth="1.2"]
    rankdir=LR

    node[group=a,color="#2ec27e"]
    "file:*.svg"
    "file:*.jpeg"
    "file:*.png"
    "#+caption"
    "xkcd:*"
    node[group=b,color="#f5c211"]
    "svg"
    "image"
    "caption"
    node[group=c,color="#813d9c"]
    "(TeX) svg"
    "(TeX) graphicx"
    "(TeX) caption"

    "file:*.svg" -&gt; "svg" -&gt; "(TeX) svg"
    "file:*.jpeg" -&gt; "image" -&gt; "(TeX) graphicx"
    "file:*.png" -&gt; "image"
    "(TeX) svg":s -&gt; "(TeX) graphicx":n [constraint=false]
    "#+caption" -&gt; "caption" -&gt; "(TeX) caption"
    "xkcd:*" -&gt; "image"
    "xkcd:*" -&gt; "caption"
}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+caption:</span> <span class="ef-ob">Association between Org features, feature flags, and LaTeX snippets required.</span>
<span style="color: #84888b;">#+attr_html: :class invertible :alt DAG showing how Org features flow through to LaTeX :style max-width:min(24em,100%)</span>
<span style="color: #84888b;">#+attr_latex: :width 0.6\linewidth</span>
<span style="color: #4078f2; font-weight: 700;">[[file:misc/org-latex-clever-preamble.svg]]</span>

First we will implement the feature detection component of this model. I'd like
this to be able to use as much state information as possible, so the feature
tests should be very versatile.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-embed-files</span><span class="ef-ob"> t
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Embed the source .org, .tex, and any tangled files."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-use-microtype</span><span class="ef-ob"> t
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Use the microtype pakage."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-italic-quotes</span><span class="ef-ob"> t
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Make \"quote\" environments italic."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-par-sep</span><span class="ef-ob"> t
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Vertically seperate paragraphs, and remove indentation."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  ((image caption)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\[\\[xkcd:"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Then we provide a way to generate the preamble that provides those features. In
addition to the features named in <span style="color: #84888b;">~org-latex-conditional-features~</span> we'll also
create <span style="text-decoration: italic;">/meta-features/</span>, which can be required by other features (with <span style="color: #84888b;">=:requires=</span>).
For further control I some features may only be used when certain other features
are active (with <span style="color: #84888b;">=:when=</span>), and masked by other features (with <span style="color: #84888b;">=:prevents=</span>). I will
use the convention of starting meta-features with <span style="color: #84888b;">=.=</span>, to make their nature more
readily apparent.

Another consideration in LaTeX is load order, which matters in some cases.
Beyond that, it's nice to have some sort of sensible ordering. For this I'll
introduce an <span style="color: #84888b;">=:order=</span> keyword. Using this I'll arrange snippets as follows.

+ <span style="color: #84888b;">=0=</span> Typography
  - <span style="color: #84888b;">=0=</span> Fonts themselves
  - <span style="color: #84888b;">=0.1=</span> Typographic tweaks (<span style="color: #84888b;">=microtype=</span>)
  - <span style="color: #84888b;">=0.2=</span> Maths setup
  - <span style="color: #84888b;">=0.3=</span> Maths font
  - <span style="color: #84888b;">=0.4=</span> Extra text shaping (<span style="color: #84888b;">~\acr~</span>)
  - <span style="color: #84888b;">=0.5-0.9=</span> Miscellaneous text modifications, trying to put shorter snippets first
+ <span style="color: #84888b;">=1=</span> (<span style="text-decoration: italic;">/default/</span>)
+ <span style="color: #84888b;">=2=</span> Tables and figures
+ <span style="color: #84888b;">=3=</span> Miscellaneous short content
+ <span style="color: #84888b;">=4=</span> Fancy boxes
+ <span style="color: #84888b;">=70=</span> setup for non-precompilable content
+ <span style="color: #84888b;">=80=</span> non-precompileable content

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (maths
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-latex-maths-preamble
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.2)
  (cleveref
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cref:</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\cref{</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\[\\[[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">\\]+\n?[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">\\]\\]\\]"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[capitalize]{cleveref}
% Fix for cleveref in order to work with long range of pages
% See https://tex.stackexchange.com/a/620066
\\makeatletter
\\newcommand*{\\@setcpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{cref}{#3}}
\\newcommand*{\\@setCpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{Cref}{#3}}
\\newcommand*{\\@setlabelcpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{labelcref}{#3}}
\\makeatother"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 1)
  (caption
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-latex-caption-preamble
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 2.1)
  (microtype
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> org-latex-use-microtype
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000]{microtype}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.1)
  (embed-files
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> org-latex-embed-files
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[include]{embedall}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 70)
  (embed-source
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> embed-files
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\IfFileExists{./\\jobname.org}{\\embedfile[desc=Primary source file]{\\jobname.org}}{}
\\IfFileExists{./\\jobname.tex}{\\embedfile[desc=The (generated) LaTeX source file]{\\jobname.tex}}{}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:no-precompile</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> embed-files
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 80)
  (embed-tangled
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> org-latex-embed-files
                   </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+embed</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">^[ \t]*#\\+begin_src</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">^[ \t]*#\\+BEGIN_SRC"</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> embed-files
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> (org-latex-embed-extra-files)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:no-precompile</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> (embed-source embed-files)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 80)
  (acronym
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"[;\\\\]?\\b[A-Z][A-Z]+s?[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">A-Za-z]"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\newcommand{\\acr}[1]{\\protect\\textls*[110]{\\scshape #1}}\n\\newcommand{\\acrs}{\\protect\\scalebox{.91}[.84]{\\hspace{0.15ex}s}}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.4)
  (box-drawing
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"[\u2500-\u259F]"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{pmboxdraw}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.05)
  (italic-quotes
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> org-latex-italic-quotes </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_quote</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\\\begin{quote}"</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\renewcommand{\\quote}{\\list{}{\\rightmargin\\leftmargin}\\item\\relax\\em}\n"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.5)
  (par-sep
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> org-latex-par-sep
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\setlength{\\parskip}{\\baselineskip}\n\\setlength{\\parindent}{0pt}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.5)
  (.pifont
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{pifont}"</span><span class="ef-ob">)
  (.xcoffins
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{xcoffins}"</span><span class="ef-ob">)
  (checkbox
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">[-+*]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9]+[.)]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">[A-Za-z]+[.)]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;"> \\[[ -X]\\]"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> .pifont
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> (concat (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (memq 'maths features)
                      </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{amssymb} % provides \\square"</span><span class="ef-ob">)
                    org-latex-checkbox-preamble)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> .pifont)
  (.fancy-box
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> (.pifont .xcoffins)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-latex-box-preamble
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> (.pifont .xcoffins))
  (box-warning
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_warning</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\\\begin{warning}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> .fancy-box
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\defsimplebox{warning}{e66100}{Warning}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> .fancy-box)
  (box-info
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_info</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\\\begin{info}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> .fancy-box
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\defsimplebox{info}{3584e4}{Information}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> .fancy-box)
  (box-notes
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_notes</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\\\begin{notes}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> .fancy-box
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\defsimplebox{notes}{26a269}{Notes}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> .fancy-box)
  (box-success
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_success</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\\\begin{success}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> .fancy-box
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\defsimplebox{success}{26a269}{\\vspace{-\\baselineskip}}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> .fancy-box)
  (box-error
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_error</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">\\\\begin{error}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> .fancy-box
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\defsimplebox{error}{c01c28}{Important}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> .fancy-box)
  (hanging-section-numbers
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob">
   (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((latex-class
          (assoc (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-class</span><span class="ef-ob">) (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-classes</span><span class="ef-ob">))))
     (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (cadr latex-class)
          (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`\\\\documentclass</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(?:</span><span style="color: #50a14f; background-color: #e7e7e7;">\\[</span><span style="color: #b751b6; background-color: #e7e7e7;">.*\\</span><span style="color: #50a14f; background-color: #e7e7e7;">]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">?{scr"</span><span class="ef-ob"> (cadr latex-class))
          (not (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"[[,]twocolumn[],]"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-class-options</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)))))
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span>
   <span style="color: #50a14f; background-color: #e7e7e7;">"\\renewcommand\\sectionformat{\\llap{\\thesection\\autodot\\enskip}}
\\renewcommand\\subsectionformat{\\llap{\\thesubsection\\autodot\\enskip}}
\\renewcommand\\subsubsectionformat{\\llap{\\thesubsubsection\\autodot\\enskip}}"</span><span class="ef-ob">)
  (toc-hidelinks
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob">
   (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-toc</span><span class="ef-ob">)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
         (goto-char (point-min))
         (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\tableofcontents"</span><span class="ef-ob"> nil t)))
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%% hide links styles in toc
\\NewCommandCopy{\\oldtoc}{\\tableofcontents}
\\renewcommand{\\tableofcontents}{\\begingroup\\hypersetup{hidelinks}\\oldtoc\\endgroup}"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Content-feature graph</span>

<span style="color: #84888b;">#+name: generate-cfg</span>
<span class="ef-obb">#+begin_src emacs-lisp :var backend="" :noweb-ref none
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">with-temp-buffer</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((lambda-count 0)
        (regexp-count 0)
        (string-count 0)
        (nil-count 0)
        cond-names feats impl-names)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (cond-feats (org-export-get-all-feature-conditions (intern backend)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (feat (cdr cond-feats))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((cond-name
               (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (car cond-feats)
                 ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (pred symbolp) f)
                  (symbol-name f))
                 ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (pred stringp) f)
                  (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Regexp #%d"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> regexp-count)))
                 ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (pred functionp) f)
                  (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"λ #%d"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> lambda-count)))
                 (_ </span><span style="color: #50a14f; background-color: #e7e7e7;">"???"</span><span class="ef-ob">))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> cond-name cond-names)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> feat feats)
          (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"%s\" -&gt; \"%s\"\n"</span><span class="ef-ob"> cond-name feat)))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (feat-impl (org-export-get-all-feature-implementations (intern backend)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((impl-name
             (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (plist-get (cdr feat-impl) </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob">)
               ((pred not)
                (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"nil #%d"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> nil-count)))
               ((</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (pred symbolp) imp)
                (symbol-name imp))
               ((pred stringp)
                (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"String #%d"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> string-count)))
               ((pred functionp)
                (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"λ #%d"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-incf</span><span class="ef-ob"> lambda-count))))))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> impl-name impl-names)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (car feat-impl) feats)
        (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"%s\" -&gt; \"%s\"\n"</span><span class="ef-ob"> (car feat-impl) impl-name))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (req (ensure-list (plist-get (cdr feat-impl) </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob">)))
          (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"%s\" -&gt; \"%s\" [color=\"#a991f1\" labelfontcolor=\"#a991f1\"]"</span><span class="ef-ob"> impl-name req)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (prv (ensure-list (plist-get (cdr feat-impl) </span><span style="color: #a626a4; background-color: #e7e7e7;">:prevents</span><span class="ef-ob">)))
          (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"%s\" -&gt; \"%s\" [color=\"#ff665c\" penwidth=\"0.9\" arrowhead=empty]"</span><span class="ef-ob"> impl-name prv)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (whn (ensure-list (plist-get (cdr feat-impl) </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob">)))
          (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"%s\" -&gt; \"%s\" [style=\"dashed\" color=\"#4db5bd\" penwidth=\"0.9\" arrowhead=empty labelfontcolor=\"#4db5bd\" taillabel=\"%s\"]"</span><span class="ef-ob"> whn impl-name impl-name)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (bfr (ensure-list (plist-get (cdr feat-impl) </span><span style="color: #a626a4; background-color: #e7e7e7;">:before</span><span class="ef-ob">)))
          (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"%s\" -&gt; \"%s\" [style=\"dotted\" color=\"#fcce7b\" penwidth=\"1.4\" arrowhead=halfopen]"</span><span class="ef-ob"> impl-name bfr)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (afr (ensure-list (plist-get (cdr feat-impl) </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob">)))
          (insert (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"%s\" -&gt; \"%s\" [style=\"dotted\" color=\"#7bc275\" penwidth=\"1.4\" arrowhead=halfopen]"</span><span class="ef-ob"> afr impl-name)))))
    (goto-char (point-min))
    (insert (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"subgraph cluster_0 {\n  peripheries=0\n  \""</span><span class="ef-ob">
                    (string-join (nreverse cond-names) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\" [color=\"#e69055\"]\n  \""</span><span class="ef-ob">)
                    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\" [color=\"#e69055\"]\n}\n"</span><span class="ef-ob">)
            (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"subgraph cluster_1 {\n  peripheries=0\n  \""</span><span class="ef-ob">
                    (string-join (mapcar #'symbol-name (nreverse (delete-dups feats))) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"\n  \""</span><span class="ef-ob">)
                    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\"\n}\n"</span><span class="ef-ob">)
            (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"subgraph cluster_2 {\n  peripheries=0\n  \""</span><span class="ef-ob">
                    (string-join (nreverse impl-names) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\" [color=\"#4db5bd\"]\n  \""</span><span class="ef-ob">)
                    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\" [color=\"#4db5bd\"]\n}\n"</span><span class="ef-ob">))
    )
  (buffer-string))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src dot :cmd twopi :file misc/ox-latex-cfg.svg :results file graphics :noweb no-export
</span><span class="ef-ob">digraph {
    graph [bgcolor="transparent", ranksep="2.5"];
    node  [shape="underline" penwidth="2" style="rounded,filled" fillcolor="#efefef" color="#c9c9c9" fontcolor="#000000" fontname="Alegreya Sans"];
    edge  [color="#9ca0a4" penwidth="1.2" fontname="Alegreya Sans"]
    rankdir="LR"
    &lt;&lt;generate-cfg("beamer")&gt;&gt;
}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #4078f2; font-weight: 700;">[[file:misc/ox-latex-cfg.svg]]</span>

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Adding xcolor as an unconditional package</span>

<span style="color: #84888b;">=xcolor=</span> is just convenient to have.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-latex-packages-alist
      '((</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span> <span style="color: #50a14f; background-color: #e7e7e7;">"xcolor"</span><span class="ef-ob"> t)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Font collections</span>

Using the lovely conditional preamble, I'll define a number of font collections
that can be used for LaTeX exports. Who knows, maybe I'll use it with other
export formats too at some point.

To start with I'll create a default state variable and register <span style="color: #84888b;">=fontset=</span> as part
of <span style="color: #84888b;">=#+options=</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-default-fontset</span><span class="ef-ob"> 'alegreya
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Fontset from `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-fontsets</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' to use by default.
As cm (computer modern) is TeX's default, that causes nothing
to be added to the document.

If \"nil\" no custom fonts will ever be used."</span><span class="ef-ob">)

(eval '(cl-pushnew '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-font-set</span><span class="ef-ob"> nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"fontset"</span><span class="ef-ob"> org-latex-default-fontset)
                   (org-export-backend-options (org-export-get-backend 'latex))))
</span><span class="ef-obe">#+end_src
</span>
Then a function is needed to generate a LaTeX snippet which applies the fontset. It
would be nice if this could be done for individual styles and use different
styles as the main document font. If the individual typefaces for a fontset are
defined individually as
<span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>, <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">:sans</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>, <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">:mono</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>, and <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">:maths</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>.
I can use those to generate LaTeX for subsets of the full fontset. Then, if I
don't let any fontset names have <span style="color: #84888b;">=-=</span> in them, I can use <span style="color: #84888b;">=-sans=</span> and <span style="color: #84888b;">=-mono=</span> as
suffixes that specify the document font to use.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-fontset-entry</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Get the fontset spec of the current file.
Has format \"name\" or \"name-style\" where '</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">name</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' is one of
the cars in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-fontsets</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((fontset-spec
         (symbol-name
          (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (car (delq nil
                         (mapcar
                          (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (opt-line)
                            (plist-get (org-export--parse-option-keyword opt-line 'latex)
                                       </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-font-set</span><span class="ef-ob">))
                          (cdar (org-collect-keywords '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"OPTIONS"</span><span class="ef-ob">))))))
              org-latex-default-fontset))))
    (cons (intern (car (split-string fontset-spec </span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob">)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (cadr (split-string fontset-spec </span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob">))
            (intern (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">":"</span><span class="ef-ob"> (cadr (split-string fontset-spec </span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob">))))))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-fontset</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> desired-styles)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Generate a LaTeX preamble snippet which applies the current fontset for DESIRED-STYLES."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((fontset-spec (org-latex-fontset-entry))
         (fontset (alist-get (car fontset-spec) org-latex-fontsets)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> fontset
        (string-trim
         (concat
          (mapconcat
           (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (style)
             (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get fontset style)
               (concat (plist-get fontset style) </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)))
           desired-styles
           </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (memq (cdr fontset-spec) desired-styles)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (cdr fontset-spec)
              (</span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\renewcommand{\\familydefault}{\\rmdefault}\n"</span><span class="ef-ob">)
              (</span><span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\renewcommand{\\familydefault}{\\sfdefault}\n"</span><span class="ef-ob">)
              (</span><span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\renewcommand{\\familydefault}{\\ttdefault}\n"</span><span class="ef-ob">)))))
      (</span><span style="color: #986801; background-color: #e7e7e7;">error</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Font-set %s is not provided in org-latex-fontsets"</span><span class="ef-ob"> (car fontset-spec)))))
</span><span class="ef-obe">#+end_src
</span>
Now that all the functionality has been implemented, we should hook it into our
preamble generation.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (custom-font
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> org-latex-default-fontset
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> (org-latex-fontset </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0)
  (custom-maths-font
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> (custom-font maths)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> (org-latex-fontset </span><span style="color: #a626a4; background-color: #e7e7e7;">:maths</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> (custom-font maths)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0))
</span><span class="ef-obe">#+end_src
</span>
Finally, we just need to add some fonts.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-fontsets</span><span class="ef-ob">
  '((cm nil) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">computer modern
</span><span class="ef-ob">    (## nil) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">no font set
</span><span class="ef-ob">    (alegreya
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[osf]{Alegreya}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{AlegreyaSans}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[scale=0.88]{sourcecodepro}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\let\\Bbbk\\relax\n\\usepackage[varbb]{newpxmath}"</span><span class="ef-ob">)
    (biolinum
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[osf]{libertineRoman}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[sfdefault,osf]{biolinum}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[scale=0.88]{sourcecodepro}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[libertine,varvw]{newtxmath}"</span><span class="ef-ob">)
    (fira
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[sfdefault,scale=0.85]{FiraSans}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[scale=0.80]{FiraMono}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{newtxsf} % change to firamath in future?"</span><span class="ef-ob">)
    (kp
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{kpfonts}"</span><span class="ef-ob">)
    (newpx
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{newpxtext}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{gillius}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[scale=0.9]{sourcecodepro}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\let\\Bbbk\\relax\n\\usepackage[varbb]{newpxmath}"</span><span class="ef-ob">)
    (noto
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[osf]{noto-serif}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[osf]{noto-sans}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[scale=0.96]{noto-mono}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{notomath}"</span><span class="ef-ob">)
    (plex
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{plex-serif}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{plex-sans}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[scale=0.95]{plex-mono}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{newtxmath}"</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">may be plex-based in future
</span><span class="ef-ob">    (source
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[osf,semibold]{sourceserifpro}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[osf,semibold]{sourcesanspro}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:mono</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[scale=0.92]{sourcecodepro}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{newtxmath}"</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">may be sourceserifpro-based in future
</span><span class="ef-ob">    (times
     </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{newtxtext}"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:maths</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{newtxmath}"</span><span class="ef-ob">))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Alist of fontset specifications.
Each car is the name of the fontset (which cannot include \"-\").

Each cdr is a plist with (optional) keys :serif, :sans, :mono, and :maths.
A key's value is a LaTeX snippet which loads such a font."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
When we're using Alegreya we can apply a lovely little tweak to <span style="color: #84888b;">=tabular=</span> which
(locally) changes the figures used to lining fixed-width.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (alegreya-typeface
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> (string= (car (org-latex-fontset-entry)) </span><span style="color: #50a14f; background-color: #e7e7e7;">"alegreya"</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> nil)
  (alegreya-tabular-figures
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> (alegreya-typeface table)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\
\\makeatletter
% tabular lining figures in tables
\\renewcommand{\\tabular}{\\AlegreyaTLF\\let\\@halignto\\@empty\\@tabular}
\\makeatother"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> custom-font
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.5))
</span><span class="ef-obe">#+end_src
</span>
Due to Alegreya's metrics, the <span style="color: #84888b;">=\LaTeX=</span> symbol doesn't quite look right. We
can correct for this by redefining it with subtlety shifted kerning.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (alegreya-latex-symbol
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> alegreya-typeface
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\
\\makeatletter
% Kerning around the A needs adjusting
\\DeclareRobustCommand{\\LaTeX}{L\\kern-.24em%
        {\\sbox\\z@ T%
         \\vbox to\\ht\\z@{\\hbox{\\check@mathfonts
                              \\fontsize\\sf@size\\z@
                              \\math@fontsfalse\\selectfont
                              A}%
                        \\vss}%
        }%
        \\kern-.10em%
        \\TeX}
\\makeatother"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> alegreya-typeface
    </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.5))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Maths notation conveniences</span>
<span style="font-weight: 700;">:PROPERTIES:</span>
<span style="color: #e45649;">:header-args:LaTeX:</span> :noweb-ref latex-maths-conveniences
<span style="font-weight: 700;">:END:</span>

Maths has a way of popping up relentlessly. I think this says something both
about me and the subject itself. While the LaTeX set of commands is quite
reasonable, we can make a few common bits of notation a tad more convenient.

<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Packages</span>

First, there are a few useful packages we want to use.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">%% </span><span style="color: #84888b; background-color: #e7e7e7;">Maths-related packages
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">More maths environments, commands, and symbols.
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">amsmath, amssymb</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Slanted fractions with </span><span style="color: #84888b; background-color: #e7e7e7;">\sfrac</span><span style="color: #84888b; background-color: #e7e7e7;">{a}{b}, in text and maths.
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">xfrac</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Visually cancel expressions with </span><span style="color: #84888b; background-color: #e7e7e7;">\cancel</span><span style="color: #84888b; background-color: #e7e7e7;">{value} and </span><span style="color: #84888b; background-color: #e7e7e7;">\cancelto</span><span style="color: #84888b; background-color: #e7e7e7;">{expression}{value}
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">makeroom</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">cancel</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Improvements on amsmath and utilities for mathematical typesetting
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">mathtools</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Custom delimiters</span>

Next up we want to make the various types of rounding-related and absolute value
delimitors accessible as commands.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Deliminators
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclarePairedDelimiter</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\abs</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\lvert</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\rvert</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclarePairedDelimiter</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\norm</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\lVert</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\rVert</span><span class="ef-ob">}

</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclarePairedDelimiter</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\ceil</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\lceil</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\rceil</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclarePairedDelimiter</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\floor</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\lfloor</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\rfloor</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclarePairedDelimiter</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\round</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\lfloor</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\rceil</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Number sets</span>

Then we have the various common number sets, it would be nice to have a
convenient way of typing them and optionally giving them powers. It's fairly
easy to support both <span style="color: #84888b;">=\XX=</span> and <span style="color: #84888b;">=\XX[n]=</span>.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\RR</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob">][]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ensuremath</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifstrempty</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{R}}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{R}</span><span style="color: #a626a4; background-color: #e7e7e7;">^</span><span style="color: #a626a4; background-color: #e7e7e7; font-size: 0.85em">{#1}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% Real numbers
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\NN</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob">][]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ensuremath</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifstrempty</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{N}}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{N}</span><span style="color: #a626a4; background-color: #e7e7e7;">^</span><span style="color: #a626a4; background-color: #e7e7e7; font-size: 0.85em">{#1}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% Natural numbers
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ZZ</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob">][]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ensuremath</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifstrempty</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{Z}}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{Z}</span><span style="color: #a626a4; background-color: #e7e7e7;">^</span><span style="color: #a626a4; background-color: #e7e7e7; font-size: 0.85em">{#1}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% Integer numbers
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\QQ</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob">][]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ensuremath</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifstrempty</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{Q}}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{Q}</span><span style="color: #a626a4; background-color: #e7e7e7;">^</span><span style="color: #a626a4; background-color: #e7e7e7; font-size: 0.85em">{#1}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% Rational numbers
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\CC</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob">][]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ensuremath</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifstrempty</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{C}}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{C}</span><span style="color: #a626a4; background-color: #e7e7e7;">^</span><span style="color: #a626a4; background-color: #e7e7e7; font-size: 0.85em">{#1}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% Complex numbers
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Derivatives</span>

Derivatives are actually a bit of a pain to typeset, it would be nice to have a
<span style="color: #84888b;">=\dv=</span> command that supports:
+ <span style="color: #84888b;">=\dv{x}=</span> for the derivative with respect to <span style="color: #84888b;">=x=</span>
+ <span style="color: #84888b;">=\dv{f}{x}=</span> for the derivative of <span style="color: #84888b;">=f=</span> with respect to <span style="color: #84888b;">=x=</span>
+ <span style="color: #84888b;">=\dv[2]{f}{x}=</span> for the second order derivative of <span style="color: #84888b;">=f=</span> with respect to <span style="color: #84888b;">=x=</span>

Similarly, it would be nice to have a partial derivate counterpart <span style="color: #84888b;">=\pdv=</span> which
behaves in a similar way, but with the possibility of providing multiple
comma-delimited variables --- e.g. <span style="color: #84888b;">=\pdv{f}{x,y,z}=</span>.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Easy derivatives
</span><span style="color: #e45649; background-color: #e7e7e7;">\ProvideDocumentCommand</span><span style="color: #a626a4; background-color: #e7e7e7;">\dv</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">o m g</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\IfNoValueTF</span><span style="color: #a626a4; background-color: #e7e7e7;">{#3}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\dv</span><span style="color: #a626a4; background-color: #e7e7e7;">[#1]{}{#2}}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\IfNoValueTF</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\frac</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\dd</span><span style="color: #a626a4; background-color: #e7e7e7;"> #2}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\dd</span><span style="color: #a626a4; background-color: #e7e7e7;"> #3}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span><span style="color: #a626a4; background-color: #e7e7e7;">    }{</span><span style="color: #a626a4; background-color: #e7e7e7;">\frac</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\dd</span><span style="color: #a626a4; background-color: #e7e7e7;">[#1] #2}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\dd</span><span style="color: #a626a4; background-color: #e7e7e7;"> {#3}^{#1}}}}</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Easy partial derivatives
</span><span style="color: #84888b; background-color: #e7e7e7;">\ExplSyntaxOn</span>
<span style="color: #e45649; background-color: #e7e7e7;">\ProvideDocumentCommand</span><span style="color: #a626a4; background-color: #e7e7e7;">\pdv</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">o m g</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\IfNoValueTF</span><span style="color: #a626a4; background-color: #e7e7e7;">{#3}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\pdv</span><span style="color: #a626a4; background-color: #e7e7e7;">[#1]{}{#2}}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span><span style="color: #a626a4; background-color: #e7e7e7;">  {</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifnum</span><span style="color: #a626a4; background-color: #e7e7e7;">\clist</span><span style="color: #a626a4; background-color: #e7e7e7;">_count:n{#3}&lt;2
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\IfValueTF</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\frac</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\partial</span><span style="color: #a626a4; background-color: #e7e7e7;">^{#1} #2}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\partial</span><span style="color: #a626a4; background-color: #e7e7e7;"> {#3}^{#1}}}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span><span style="color: #a626a4; background-color: #e7e7e7;">    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\frac</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\partial</span><span style="color: #a626a4; background-color: #e7e7e7;"> #2}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\partial</span><span style="color: #a626a4; background-color: #e7e7e7;"> #3}}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\else</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">\frac</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\IfValueTF</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\partial</span><span style="color: #a626a4; background-color: #e7e7e7;">^{#1}}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\partial</span><span style="color: #a626a4; background-color: #e7e7e7;">^{</span><span style="color: #a626a4; background-color: #e7e7e7;">\clist</span><span style="color: #a626a4; background-color: #e7e7e7;">_count:n{#3}}}#2}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span><span style="color: #a626a4; background-color: #e7e7e7;">    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\clist</span><span style="color: #a626a4; background-color: #e7e7e7;">_map_inline:nn{#3}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\partial</span><span style="color: #a626a4; background-color: #e7e7e7;"> ##1 \,}</span><span style="color: #a626a4; background-color: #e7e7e7;">\!</span><span style="color: #a626a4; background-color: #e7e7e7;">}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\fi</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\ExplSyntaxOff</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Common operators</span>

The default set of operators could benefit from a bit of expansion.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Laplacian
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclareMathOperator</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\Lap</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\mathcal</span><span class="ef-ob">{L}}

</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Statistics
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclareMathOperator</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\Var</span><span class="ef-ob">}{Var} </span><span style="color: #84888b; background-color: #e7e7e7;">% varience
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclareMathOperator</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\Cov</span><span class="ef-ob">}{Cov} </span><span style="color: #84888b; background-color: #e7e7e7;">% covarience
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\EE</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ensuremath</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathbb</span><span style="color: #a626a4; background-color: #e7e7e7;">{E}</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% expected value
</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclareMathOperator</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\E</span><span class="ef-ob">}{E} </span><span style="color: #84888b; background-color: #e7e7e7;">% expected value
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Slanted inequalities</span>

As a matter of personal taste, I prefer the slanted less/greater than or equal
to operators, and would like to use them by default.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">I prefer the slanted </span><span style="color: #84888b; background-color: #e7e7e7;">\leq</span><span style="color: #84888b; background-color: #e7e7e7;">/</span><span style="color: #84888b; background-color: #e7e7e7;">\geq</span>
<span style="color: #84888b; background-color: #e7e7e7;">\let</span><span style="color: #84888b; background-color: #e7e7e7;">\barleq</span><span style="color: #84888b; background-color: #e7e7e7;">\leq</span> <span style="color: #84888b; background-color: #e7e7e7;">% Save them in case they're every wanted
</span><span style="color: #84888b; background-color: #e7e7e7;">\let</span><span style="color: #84888b; background-color: #e7e7e7;">\bargeq</span><span style="color: #84888b; background-color: #e7e7e7;">\geq</span>
<span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\leq</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\leqslant</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\geq</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\geqslant</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Alignment of matrix columns</span>

By default, everything in a matrix is centred, which I actually find often
undesirable. It would be much nicer to take the alignment as an optional
argument of the environment, and default to right-alignment.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Redefine the matrix environment to allow for alignment
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">via an optional argument, and use r as the default.
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatletter</span>
<span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span style="color: #a626a4; background-color: #e7e7e7;">\env@matrix</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob">][</span><span style="color: #6a1868; background-color: #e7e7e7;">r</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\hskip</span><span style="color: #a626a4; background-color: #e7e7e7;"> -</span><span style="color: #a626a4; background-color: #e7e7e7;">\arraycolsep</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\let</span><span style="color: #a626a4; background-color: #e7e7e7;">\@ifnextchar</span><span style="color: #a626a4; background-color: #e7e7e7;">\new@ifnextchar</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">\array</span><span style="color: #a626a4; background-color: #e7e7e7;">{*</span><span style="color: #a626a4; background-color: #e7e7e7;">\c@MaxMatrixCols</span><span style="color: #a626a4; background-color: #e7e7e7;"> #1}</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatother</span>
<span class="ef-obe">#+end_src
</span>
<span style="color: #bc5cba; font-weight: 600; font-size: 1.06em">***** Slanted derivative "d"</span>

Determining an appropriate styling for a derivative "d" (e.g. "dx") is
surprisingly hard, as the "d" is neither:
+ An operator (which are typeset as upright roman)
+ A variable (which are typeset as italic roman)

The ISO 80000-2 standard (2009) specifies that it should be upright, however (a)
it is still not an operator, (b) not used in any maths book I've seen, and (c)
doesn't look very good. I'm not entirely comfortable with the variable styling
either though, so perhaps something else is in order?

After trying a few different options, I rather like the idea of using a <span style="text-decoration: italic;">/slanted
roman "d"/</span>. This stylistically works for me, while being just distinct enough
from other faces. As long as we are creating a PDF, we can apply a transform
that slants a "d".

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Slanted roman "d" for derivatives
</span><span style="color: #84888b; background-color: #e7e7e7;">\ifcsname</span><span class="ef-ob"> pdfoutput</span><span style="color: #84888b; background-color: #e7e7e7;">\endcsname</span>
  <span style="color: #84888b; background-color: #e7e7e7;">\ifnum</span><span style="color: #84888b; background-color: #e7e7e7;">\pdfoutput</span><span class="ef-ob">&gt;0 </span><span style="color: #84888b; background-color: #e7e7e7;">% PDF
</span>    <span style="color: #e45649; background-color: #e7e7e7;">\newsavebox</span><span style="color: #a626a4; background-color: #e7e7e7;">\diffdbox</span><span class="ef-ob">{}
    </span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\slantedromand</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathpalette</span><span style="color: #a626a4; background-color: #e7e7e7;">\makesl</span><span style="color: #a626a4; background-color: #e7e7e7;">{d}}</span><span class="ef-ob">}
    </span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\makesl</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">2</span><span class="ef-ob">]{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\begingroup</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">\sbox</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\diffdbox</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathsurround</span><span style="color: #a626a4; background-color: #e7e7e7;">=0pt#1</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathrm</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">#2</span><span style="color: #a626a4; background-color: #e7e7e7;">}$</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\pdfsave</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\pdfsetmatrix</span><span style="color: #a626a4; background-color: #e7e7e7;">{1 0 0.2 1}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\rlap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\usebox</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\diffdbox</span><span style="color: #a626a4; background-color: #e7e7e7;">}}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\pdfrestore</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\hskip</span><span style="color: #a626a4; background-color: #e7e7e7;">\wd</span><span style="color: #a626a4; background-color: #e7e7e7;">\diffdbox</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\endgroup</span><span class="ef-ob">}
  </span><span style="color: #84888b; background-color: #e7e7e7;">\else</span> <span style="color: #84888b; background-color: #e7e7e7;">% DVI
</span>    <span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\slantedromand</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">d</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% fallback
</span>  <span style="color: #84888b; background-color: #e7e7e7;">\fi</span>
<span style="color: #84888b; background-color: #e7e7e7;">\else</span> <span style="color: #84888b; background-color: #e7e7e7;">% Also DVI
</span>  <span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\slantedromand</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">d</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% fallback
</span><span style="color: #84888b; background-color: #e7e7e7;">\fi</span>
<span class="ef-obe">#+end_src
</span>
Now there's the matter of <span style="text-decoration: italic;">/placing/</span> the "d", or rather adjusting the space around
it. After much fiddling, I've ended up with the following.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">Derivative d^n, nicely spaced
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatletter</span>
<span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\dd</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob">][]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\mathop</span><span style="color: #a626a4; background-color: #e7e7e7;">{}</span><span style="color: #a626a4; background-color: #e7e7e7;">\!</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\expandafter</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifx</span><span style="color: #a626a4; background-color: #e7e7e7;">\expandafter</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">&amp;</span><span style="color: #a626a4; background-color: #e7e7e7;">\detokenize</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">&amp;</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">\ifstrempty</span><span style="color: #84888b; background-color: #e7e7e7;"> from etoolbox
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\slantedromand</span><span style="color: #a626a4; background-color: #e7e7e7;">\@ifnextchar</span><span style="color: #a626a4; background-color: #e7e7e7;">^{</span><span style="color: #a626a4; background-color: #e7e7e7;">\hspace</span><span style="color: #a626a4; background-color: #e7e7e7;">{0.2ex}}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\hspace</span><span style="color: #a626a4; background-color: #e7e7e7;">{0.1ex}}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\else</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">\slantedromand</span><span style="color: #a626a4; background-color: #e7e7e7;">\hspace</span><span style="color: #a626a4; background-color: #e7e7e7;">{0.2ex}^{#1}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\fi</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatother</span>
<span class="ef-obe">#+end_src
</span>
While <span style="color: #84888b;">=\dd=</span> isn't much effort to type, it would be much cleaner to be able to do
<span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #84888b; background-color: #e7e7e7;">\int</span><span class="ef-ob"> x^2 </span><span style="color: #84888b; background-color: #e7e7e7;">\d</span><span class="ef-ob"> x</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>. The problem with defining <span style="color: #84888b;">=\d=</span> is that it is already used
for the under-dot accent. However, since this is a text-mode (only) accent, and
defined with <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #84888b; background-color: #e7e7e7;">\@dec@text@cmd</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">newcommand</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> instead of
<span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span style="color: #84888b; background-color: #e7e7e7;">\DeclareRobustCommand</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> we can redefine the command to mean <span style="color: #84888b;">=\dd=</span> in
math-mode.

<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\NewCommandCopy</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\daccent</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\d</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\d</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\ifmmode</span><span style="color: #a626a4; background-color: #e7e7e7;">\dd</span><span style="color: #a626a4; background-color: #e7e7e7;">\else</span><span style="color: #a626a4; background-color: #e7e7e7;">\daccent</span><span style="color: #a626a4; background-color: #e7e7e7;">\fi</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Cover page</span>

To make a nice cover page, a simple method that comes to mind is just redefining
<span style="color: #84888b;">=\maketitle=</span>. To get precise control over the positioning we'll use the <span style="color: #84888b;">=tikz=</span>
package, and then add in the Tikz libraries <span style="color: #84888b;">=calc=</span> and <span style="color: #84888b;">=shapes.geometric=</span> to make
some nice decorations for the background.

I'll start off by setting up the required additions to the preamble.
This will accomplish the following:
+ Load the required packages
+ Redefine <span style="color: #84888b;">=\maketitle=</span>
+ Draw an Org icon with Tikz to use in the cover page (it's a little easter egg)
+ Start a new page after the table of contents by redefining <span style="color: #84888b;">=\tableofcontents=</span>

<span style="color: #84888b;">#+name: latex-cover-page</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">tikz</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\usetikzlibrary</span><span class="ef-ob">{shapes.geometric}
</span><span style="color: #84888b; background-color: #e7e7e7;">\usetikzlibrary</span><span class="ef-ob">{calc}

</span><span style="color: #e45649; background-color: #e7e7e7;">\newsavebox</span><span style="color: #a626a4; background-color: #e7e7e7;">\orgicon</span>
<span style="color: #e45649; background-color: #e7e7e7;">\begin</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">lrbox</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">\orgicon</span><span class="ef-ob">}
  </span><span style="color: #e45649; background-color: #e7e7e7;">\begin</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">tikzpicture</span><span class="ef-ob">}[y=0.80pt, x=0.80pt, inner sep=0pt, outer sep=0pt]
    </span><span style="color: #84888b; background-color: #e7e7e7;">\path</span><span class="ef-ob">[fill=black!6] (16.15,24.00) .. controls (15.58,24.00) and (13.99,20.69) .. (12.77,18.06)arc(215.55:180.20:2.19) .. controls (12.33,19.91) and (11.27,19.09) .. (11.43,18.05) .. controls (11.36,18.09) and (10.17,17.83) .. (10.17,17.82) .. controls (9.94,18.75) and (9.37,19.44) .. (9.02,18.39) .. controls (8.32,16.72) and (8.14,15.40) .. (9.13,13.80) .. controls (8.22,9.74) and (2.18,7.75) .. (2.81,4.47) .. controls (2.99,4.47) and (4.45,0.99) .. (9.15,2.41) .. controls (14.71,3.99) and (17.77,0.30) .. (18.13,0.04) .. controls (18.65,-0.49) and (16.78,4.61) .. (12.83,6.90) .. controls (10.49,8.18) and (11.96,10.38) .. (12.12,11.15) .. controls (12.12,11.15) and (14.00,9.84) .. (15.36,11.85) .. controls (16.58,11.53) and (17.40,12.07) .. (18.46,11.69) .. controls (19.10,11.41) and (21.79,11.58) .. (20.79,13.08) .. controls (20.79,13.08) and (21.71,13.90) .. (21.80,13.99) .. controls (21.97,14.75) and (21.59,14.91) .. (21.47,15.12) .. controls (21.44,15.60) and (21.04,15.79) .. (20.55,15.44) .. controls (19.45,15.64) and (18.36,15.55) .. (17.83,15.59) .. controls (16.65,15.76) and (15.67,16.38) .. (15.67,16.38) .. controls (15.40,17.19) and (14.82,17.01) .. (14.09,17.32) .. controls (14.70,18.69) and (14.76,19.32) .. (15.50,21.32) .. controls (15.76,22.37) and (16.54,24.00) .. (16.15,24.00) -- cycle(7.83,16.74) .. controls (6.83,15.71) and (5.72,15.70) .. (4.05,15.42) .. controls (2.75,15.19) and (0.39,12.97) .. (0.02,10.68) .. controls (-0.02,10.07) and (-0.06,8.50) .. (0.45,7.18) .. controls (0.94,6.05) and (1.27,5.45) .. (2.29,4.85) .. controls (1.41,8.02) and (7.59,10.18) .. (8.55,13.80) -- (8.55,13.80) .. controls (7.73,15.00) and (7.80,15.64) .. (7.83,16.74) -- cycle;
  </span><span style="color: #e45649; background-color: #e7e7e7;">\end</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">tikzpicture</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\end</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">lrbox</span><span class="ef-ob">}

</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatletter</span>
<span style="color: #84888b; background-color: #e7e7e7;">\g@addto@macro</span><span style="color: #e45649; background-color: #e7e7e7;">\tableofcontents</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\clearpage</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #a626a4; background-color: #e7e7e7;">\maketitle</span><span class="ef-ob">{</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">\thispagestyle</span><span style="color: #a626a4; background-color: #e7e7e7;">{empty}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\hyphenpenalty</span><span style="color: #a626a4; background-color: #e7e7e7;">=10000 </span><span style="color: #84888b; background-color: #e7e7e7;">% hyphens look bad in titles
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\renewcommand</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselinestretch</span><span style="color: #a626a4; background-color: #e7e7e7;">}{1.1}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\NewCommandCopy</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\oldtoday</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\today</span><span style="color: #a626a4; background-color: #e7e7e7;">}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\renewcommand</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\today</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\LARGE</span><span style="color: #a626a4; background-color: #e7e7e7;">\number</span><span style="color: #a626a4; background-color: #e7e7e7;">\year</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #a626a4; background-color: #e7e7e7;">\large</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\ifcase</span> <span style="color: #a626a4; background-color: #e7e7e7;">\month</span> <span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Jan</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Feb</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Mar</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Apr</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> May </span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Jun</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Jul</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Aug</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Sep</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Oct</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Nov</span><span style="color: #a626a4; background-color: #e7e7e7;">\or</span><span style="color: #a626a4; background-color: #e7e7e7;"> Dec</span><span style="color: #a626a4; background-color: #e7e7e7;">\fi</span><span style="color: #a626a4; background-color: #e7e7e7;">
    ~</span><span style="color: #a626a4; background-color: #e7e7e7;">\number</span><span style="color: #a626a4; background-color: #e7e7e7;">\day</span><span style="color: #a626a4; background-color: #e7e7e7;">}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\begin</span><span style="color: #a626a4; background-color: #e7e7e7;">{tikzpicture}[remember picture,overlay]
    </span><span style="color: #84888b; background-color: #e7e7e7;">%% </span><span style="color: #84888b; background-color: #e7e7e7;">Background Polygons %%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\foreach</span> <span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> in {2.5,...,22} </span><span style="color: #84888b; background-color: #e7e7e7;">% bottom left
</span><span style="color: #a626a4; background-color: #e7e7e7;">    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[rounded corners,black!3.5,draw,regular polygon,regular polygon sides=6, minimum size=</span><span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> cm,ultra thick] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.west)+(2.5,-4.2)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {} ;}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\foreach</span> <span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> in {0.5,...,22} </span><span style="color: #84888b; background-color: #e7e7e7;">% top left
</span><span style="color: #a626a4; background-color: #e7e7e7;">    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[rounded corners,black!5,draw,regular polygon,regular polygon sides=6, minimum size=</span><span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> cm,ultra thick] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.north west)+(2.5,2)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {} ;}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[rounded corners,fill=black!4,regular polygon,regular polygon sides=6, minimum size=5.5 cm,ultra thick] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.north west)+(2.5,2)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {};
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\foreach</span> <span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> in {0.5,...,24} </span><span style="color: #84888b; background-color: #e7e7e7;">% top right
</span><span style="color: #a626a4; background-color: #e7e7e7;">    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[rounded corners,black!2,draw,regular polygon,regular polygon sides=6, minimum size=</span><span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> cm,ultra thick] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.north east)+(0,-8.5)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {} ;}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2.5 cm,ultra thick] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.north east)+(0,-8.5)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {};
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\foreach</span> <span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> in {21,...,3} </span><span style="color: #84888b; background-color: #e7e7e7;">% bottom right
</span><span style="color: #a626a4; background-color: #e7e7e7;">    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[black!3,rounded corners,draw,regular polygon,regular polygon sides=6, minimum size=</span><span style="color: #a626a4; background-color: #e7e7e7;">\i</span><span style="color: #a626a4; background-color: #e7e7e7;"> cm,ultra thick] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.south east)+(-1.5,0.75)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {} ;}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2 cm,ultra thick] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.south east)+(-1.5,0.75)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {};
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[align=center, scale=1.4] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.south east)+(-1.5,0.75)$</span><span style="color: #a626a4; background-color: #e7e7e7;">) {</span><span style="color: #a626a4; background-color: #e7e7e7;">\usebox</span><span style="color: #a626a4; background-color: #e7e7e7;">\orgicon</span><span style="color: #a626a4; background-color: #e7e7e7;">};
    </span><span style="color: #84888b; background-color: #e7e7e7;">%% </span><span style="color: #84888b; background-color: #e7e7e7;">Text %%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[left, align=right, black, text width=0.8</span><span style="color: #a626a4; background-color: #e7e7e7;">\paperwidth</span><span style="color: #a626a4; background-color: #e7e7e7;">, minimum height=3cm, rounded corners,font=</span><span style="color: #a626a4; background-color: #e7e7e7;">\Huge</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\bfseries</span><span style="color: #a626a4; background-color: #e7e7e7;">] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.north east)+(-2,-8.5)$</span><span style="color: #a626a4; background-color: #e7e7e7;">)
    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\@title</span><span style="color: #a626a4; background-color: #e7e7e7;">};
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[left, align=right, black, text width=0.8</span><span style="color: #a626a4; background-color: #e7e7e7;">\paperwidth</span><span style="color: #a626a4; background-color: #e7e7e7;">, minimum height=2cm, rounded corners, font=</span><span style="color: #a626a4; background-color: #e7e7e7;">\Large</span><span style="color: #a626a4; background-color: #e7e7e7;">] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.north east)+(-2,-11.8)$</span><span style="color: #a626a4; background-color: #e7e7e7;">)
    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\scshape</span> <span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\@author</span><span style="color: #a626a4; background-color: #e7e7e7;">};
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\renewcommand</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\baselinestretch</span><span style="color: #a626a4; background-color: #e7e7e7;">}{0.75}
    </span><span style="color: #a626a4; background-color: #e7e7e7;">\node</span><span style="color: #a626a4; background-color: #e7e7e7;">[align=center,rounded corners,fill=black!3,text=black,regular polygon,regular polygon sides=6, minimum size=2.5 cm,inner sep=0, font=</span><span style="color: #a626a4; background-color: #e7e7e7;">\Large</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\bfseries</span><span style="color: #a626a4; background-color: #e7e7e7;"> ] at (</span><span style="color: #a626a4; background-color: #e7e7e7;">$(current page.west)+(2.5,-4.2)$</span><span style="color: #a626a4; background-color: #e7e7e7;">)
    {</span><span style="color: #a626a4; background-color: #e7e7e7;">\@date</span><span style="color: #a626a4; background-color: #e7e7e7;">};
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\end</span><span style="color: #a626a4; background-color: #e7e7e7;">{tikzpicture}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\let</span><span style="color: #a626a4; background-color: #e7e7e7;">\today</span><span style="color: #a626a4; background-color: #e7e7e7;">\oldtoday</span>
  <span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\clearpage</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatother</span>
<span class="ef-obe">#+end_src
</span>
Now we've got a nice cover page to work with, we just need to use it every now
and then. Adding this to <span style="color: #84888b;">=#+options=</span> feels most appropriate.
Let's have the <span style="color: #84888b;">=coverpage=</span> option accept <span style="color: #84888b;">=auto=</span> as a value and then decide whether
or not a cover page should be used based on the word count --- I'll have this be
the global default. Then we just want to insert a LaTeX snippet tweak the
subtitle format to use the cover page.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-cover-page</span><span class="ef-ob"> 'auto
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"When t, use a cover page by default.
When auto, use a cover page when the document's wordcount exceeds
`</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-cover-page-wordcount-threshold</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.

Set with #+option: coverpage:{yes,auto,no} in org buffers."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-cover-page-wordcount-threshold</span><span class="ef-ob"> 5000
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Document word count at which a cover page will be used automatically.
This condition is applied when cover page option is set to auto."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-subtitle-coverpage-format</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\\\bigskip\n\\LARGE\\mdseries\\itshape\\color{black!80} %s\\par"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Variant of `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-subtitle-format</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' to use with the cover page."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-cover-page-maketitle</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-cover-page"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX preamble snippet that sets \\maketitle to produce a cover page."</span><span class="ef-ob">)

(eval '(cl-pushnew '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-cover-page</span><span class="ef-ob"> nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"coverpage"</span><span class="ef-ob"> org-latex-cover-page)
                   (org-export-backend-options (org-export-get-backend 'latex))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-cover-page-p</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Whether a cover page should be used when exporting this Org file."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (car
              (delq nil
                    (mapcar
                     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (opt-line)
                       (plist-get (org-export--parse-option-keyword opt-line 'latex) </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-cover-page</span><span class="ef-ob">))
                     (cdar (org-collect-keywords '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"OPTIONS"</span><span class="ef-ob">))))))
             org-latex-cover-page)
    ((</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> 't 'yes) t)
    ('auto (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt; (count-words (point-min) (point-max)) org-latex-cover-page-wordcount-threshold) t))
    (_ nil)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-latex-set-coverpage-subtitle-format-a (contents info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Set the subtitle format when a cover page is being used."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:before</span><span class="ef-ob"> #'org-latex-template
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-latex-cover-page-p)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> info (plist-put info </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-subtitle-format</span><span class="ef-ob"> org-latex-subtitle-coverpage-format))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (cover-page
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> (org-latex-cover-page-p)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-latex-cover-page-maketitle
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 9))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Condensed lists</span>

LaTeX is generally pretty good by default, but it's <span style="text-decoration: italic;">/really/</span> generous with how
much space it puts between list items by default. I'm generally not a fan.

Thankfully this is easy to correct with a small snippet:
<span style="color: #84888b;">#+name: latex-condense-lists</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\setuplistspacing</span><span class="ef-ob">}{</span><span style="color: #e45649; background-color: #e7e7e7;">\setlength</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #6a1868; background-color: #e7e7e7;">\itemsep</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #6a1868; background-color: #e7e7e7;">-0.5ex</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #e45649; background-color: #e7e7e7;">\setlength</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #6a1868; background-color: #e7e7e7;">\parskip</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #6a1868; background-color: #e7e7e7;">1.5ex</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span style="color: #e45649; background-color: #e7e7e7;">\setlength</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #6a1868; background-color: #e7e7e7;">\parsep</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #6a1868; background-color: #e7e7e7;">0pt</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\let</span><span style="color: #84888b; background-color: #e7e7e7;">\olditem</span><span style="color: #84888b; background-color: #e7e7e7;">\itemize</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\itemize</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\olditem</span><span style="color: #a626a4; background-color: #e7e7e7;">\setuplistspacing</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\let</span><span style="color: #84888b; background-color: #e7e7e7;">\oldenum</span><span style="color: #84888b; background-color: #e7e7e7;">\enumerate</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\enumerate</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\oldenum</span><span style="color: #a626a4; background-color: #e7e7e7;">\setuplistspacing</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\let</span><span style="color: #84888b; background-color: #e7e7e7;">\olddesc</span><span style="color: #84888b; background-color: #e7e7e7;">\description</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\description</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\olddesc</span><span style="color: #a626a4; background-color: #e7e7e7;">\setuplistspacing</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
Then we can just hook this in with our clever preamble.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-condense-lists</span><span class="ef-ob"> t
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Reduce the space between list items."</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-condensed-lists</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-condense-lists"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX preamble snippet that reduces the space between list items."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (condensed-lists
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> org-latex-condense-lists </span><span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*[-+]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">^[ \t]*[1Aa][.)] "</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-latex-condensed-lists
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.7))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Upright parentheses in italic text</span>

TODO, see <span style="color: #4078f2; font-weight: 700;">https://tex.stackexchange.com/a/13057/167605</span>

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Pretty code blocks</span>

We could just use minted for syntax highlighting --- however, we can do better!
The <span style="color: #84888b;">=engrave-faces=</span> package lets us use Emacs' font-lock for syntax highlighting,
exporting that as LaTeX commands.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> engrave-faces </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/engrave-faces"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! engrave-faces-latex
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> ox-latex)
</span><span class="ef-obe">#+end_src
</span>
Using this as in LaTeX exports is now as easy as

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-latex-listings 'engraved
      org-latex-engraved-theme 'doom-one-light)
</span><span class="ef-obe">#+end_src
</span>
One little annoyance with this is the interaction between microtype and <span style="color: #84888b;">=Verbatim=</span>
environments. Protrusion is not desirable here. Thankfully, we can patch the
<span style="color: #84888b;">=Verbatim=</span> environment to turn off protrusion locally.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (no-protrusion-in-code
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> (microtype engraved-code)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\ifcsname Code\\endcsname\n  \\let\\oldcode\\Code\\renewcommand{\\Code}{\\microtypesetup{protrusion=false}\\oldcode}\n\\fi"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> (engraved-code microtype)))
</span><span class="ef-obe">#+end_src
</span>
At some point it would be nice to make the box colours easily customisable. At
the moment it's fairly easy to change the syntax highlighting colours with
<span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> engrave-faces-preset-styles (engrave-faces-generate-preset))</span><span style="color: #84888b; background-color: #e7e7e7;">}</span>,
but perhaps a toggle which specifies whether to use the default values, the
current theme, or any named theme could be a good idea. It should also possible
to set the box background dynamically to match. The named theme could work by
looking for a style definition with a certain name in a cache dir, and then
switching to that theme and producing (and saving) the style definition if it
doesn't exist.

Now let's have the example block be styled similarly.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-latex-example-block-engraved (orig-fn example-block contents info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Like `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-example-block</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">', but supporting an engraved backend"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-latex-example-block
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((output-block (funcall orig-fn example-block contents info)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eq 'engraved (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-listings</span><span class="ef-ob">))
        (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\begin{Code}[alt]\n%s\n\\end{Code}"</span><span class="ef-ob"> output-block)
      output-block)))
</span><span class="ef-obe">#+end_src
</span>
In addition to the vastly superior visual output, this should also be much
faster to compile for code-heavy documents (like this config).

Performing a little benchmark with this document, I find that this is indeed the
case.

| LaTeX syntax highlighting backend | Compile time | Overhead | Overhead ratio |
|-----------------------------------+--------------+----------+----------------|
| verbatim                          | 12 s         | 0        |            0.0 |
| lstlistings                       | 15 s         | 3 s      |            0.2 |
| Engrave                           | 34 s         | 22 s     |            1.8 |
| Pygments (Minted)                 | 184 s        | 172 s    |           14.3 |
<span style="color: #84888b;">#+TBLFM: $3=$2-@2$2::$4=$3 / @2$2;%.1f</span>

Treating the verbatim (no syntax highlighting) result as a baseline; this
rudimentary test suggest that <span style="color: #84888b;">=engrave-faces=</span> is around eight times faster than
<span style="color: #84888b;">=pygments=</span>, and takes three times as long as no syntax highlighting (verbatim).

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Julia code blocks</span>

Julia code has fantastic support for unicode! The downside is that <span style="color: #84888b;">=pdflatex=</span> is
<span style="text-decoration: italic;">/still/</span> a pain to use with unicode symbols. The solution --- <span style="color: #84888b;">=lualatex=</span>. Now we just
need to make it automatic

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-latex-pick-compiler (_contents info)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:before</span><span class="ef-ob"> #'org-latex-template
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:before</span><span class="ef-ob"> #'org-beamer-template
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (memq 'code (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:features</span><span class="ef-ob">))
             (memq 'julia-code (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:features</span><span class="ef-ob">))
             (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
               (goto-char (point-min))
               (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">\x00-\x7F\u200b]"</span><span class="ef-ob"> nil t)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> info (plist-put
                (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (member #'+org-latex-replace-non-ascii-chars (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:filter-final-output</span><span class="ef-ob">))
                    (plist-put info </span><span style="color: #a626a4; background-color: #e7e7e7;">:filter-final-output</span><span class="ef-ob">
                               (delq #'+org-latex-replace-non-ascii-chars (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:filter-final-output</span><span class="ef-ob">)))
                  info)
                </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-compiler</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lualatex"</span><span class="ef-ob">))))
</span><span class="ef-obe">#+end_src
</span>
Then a font with unicode support must be used. JuliaMono is the obvious choice,
and we can use it with the <span style="color: #84888b;">=fontspec=</span> package. In future it may be nice to set
this just as a fallback font (when it isn't a pain to do so).

<span style="color: #84888b;">#+name: julia-mono-fontspec</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #84888b; background-color: #e7e7e7;">\ifcsname</span><span class="ef-ob"> directlua</span><span style="color: #84888b; background-color: #e7e7e7;">\endcsname</span>
  <span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">fontspec</span><span class="ef-ob">}
  </span><span style="color: #84888b; background-color: #e7e7e7;">\newfontfamily</span><span style="color: #84888b; background-color: #e7e7e7;">\JuliaMono</span><span class="ef-ob">{JuliaMono-Regular.ttf}[Path=/usr/share/fonts/truetype/, Extension=.ttf]
  </span><span style="color: #84888b; background-color: #e7e7e7;">\newfontface</span><span style="color: #84888b; background-color: #e7e7e7;">\JuliaMonoRegular</span><span class="ef-ob">{JuliaMono-Regular}
  </span><span style="color: #84888b; background-color: #e7e7e7;">\setmonofont</span><span class="ef-ob">{JuliaMonoRegular}[Contextuals=Alternate, Scale=MatchLowercase]
</span><span style="color: #84888b; background-color: #e7e7e7;">\fi</span>
<span class="ef-obe">#+end_src
</span>
Now all that remains is to hook this into the preamble generation.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-julia-mono-fontspec</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"julia-mono-fontspec"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX preamble snippet that sets LuaLaTeX's fontspec to use Julia Mono."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (julia-code
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^[ \t]*#\\+begin_src julia</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">^[ \t]*#\\+BEGIN_SRC julia</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">src_julia"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> code
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-latex-julia-mono-fontspec
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> custom-font
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0)
  (microtype-lualatex
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> (microtype julia-code)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prevents</span><span class="ef-ob"> microtype
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage[activate={true,nocompatibility},final,tracking=true,factor=2000]{microtype}\n"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0.1)
  (custom-font-no-mono
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> julia-code
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prevents</span><span class="ef-ob"> custom-font
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> (org-latex-fontset </span><span style="color: #a626a4; background-color: #e7e7e7;">:serif</span> <span style="color: #a626a4; background-color: #e7e7e7;">:sans</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 0))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Emojis</span>

<span style="color: #84888b;">#+call: confpkg("ox-latex-emoji", after="ox-latex", prefix="")</span>

It would be nice to actually include emojis where used.
Thanks to <span style="color: #84888b;">=emojify=</span>, we have a folder of emoji images just sitting and waiting to
be used 🙂.

First up, we want to detect when emojis are actually present. Manually
constructing a regex for this would be a huge pain with the way the codepoints
are scattered around, but thanks to <span style="color: #84888b;">~char-script-table~</span> we don't have to!

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-emoji--rx</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (emojis)
    (map-char-table
     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (char set)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eq set 'emoji)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (copy-tree char) emojis)))
     char-script-table)
    (rx-to-string `(any ,@emojis)))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A regexp to find all emoji-script characters."</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
Once we've found an Emoji, we would like to include it in LaTeX. We'll set up
the infrastructure for this with the help of two packages
+ <span style="color: #84888b;">=accsupp=</span>, to provide the copy-paste text overlay
+ <span style="color: #84888b;">=transparent=</span>, to provide invisible text to enable text copying at the image

With these packages we can insert an emoji image at the point and then place
some invisible text on-top of it that copies as the emoji codepoint.

Unfortunately though, <span style="color: #84888b;">=accsupp=</span> doesn't seem to accept five digit hexadecimal
codepoints at this point in time, instead we need to convert to UTF-16 surrogate
pairs, so we'll give our <span style="color: #84888b;">=\DeclareEmoji=</span> command two arguments: one for the
non-surrogate form required by <span style="color: #84888b;">=\DeclareUnicodeCharacter=</span>, and another for the
surrogate form required by <span style="color: #84888b;">=\BeginAccSupp=</span>.

<span style="color: #84888b;">#+name: latex-emoji-preamble</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">accsupp</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">The transparent package is also needed, but will be loaded later.
</span><span style="color: #e45649; background-color: #e7e7e7;">\newsavebox</span><span style="color: #a626a4; background-color: #e7e7e7;">\emojibox</span>

<span style="color: #e45649; background-color: #e7e7e7;">\NewDocumentCommand</span><span style="color: #a626a4; background-color: #e7e7e7;">\DeclareEmoji</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">m m</span><span class="ef-ob">}{</span><span style="color: #84888b; background-color: #e7e7e7;">% UTF-8 codepoint, UTF-16 codepoint
</span>  <span style="color: #a626a4; background-color: #e7e7e7;">\DeclareUnicodeCharacter</span><span style="color: #a626a4; background-color: #e7e7e7;">{#1}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\sbox</span><span style="color: #a626a4; background-color: #e7e7e7;">\emojibox</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\raisebox</span><span style="color: #a626a4; background-color: #e7e7e7;">{OFFSET}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>        <span style="color: #a626a4; background-color: #e7e7e7;">\includegraphics</span><span style="color: #a626a4; background-color: #e7e7e7;">[height=HEIGHT]{EMOJI-FOLDER/#1}}}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">\usebox</span><span style="color: #a626a4; background-color: #e7e7e7;">\emojibox</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">\llap</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>      <span style="color: #a626a4; background-color: #e7e7e7;">\resizebox</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\wd</span><span style="color: #a626a4; background-color: #e7e7e7;">\emojibox</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\height</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>        <span style="color: #a626a4; background-color: #e7e7e7;">\BeginAccSupp</span><span style="color: #a626a4; background-color: #e7e7e7;">{method=hex,unicode,ActualText=#2}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>        <span style="color: #a626a4; background-color: #e7e7e7;">\texttransparent</span><span style="color: #a626a4; background-color: #e7e7e7;">{0}{X}</span><span style="color: #84888b; background-color: #e7e7e7;">%
</span>        <span style="color: #a626a4; background-color: #e7e7e7;">\EndAccSupp</span><span style="color: #a626a4; background-color: #e7e7e7;">{}}}}</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
Once we know that there are emojis present we can add a bit of preamble to the
buffer to make insertion easier.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defconst</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-emoji-base-dir</span><span class="ef-ob">
  (expand-file-name </span><span style="color: #50a14f; background-color: #e7e7e7;">"emojis/"</span><span class="ef-ob"> doom-cache-dir)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Directory where emojis should be saved and look for."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-emoji-sets</span><span class="ef-ob">
  '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"twemoji"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:url</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://github.com/jdecked/twemoji/archive/refs/tags/v15.1.0.zip"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:folder</span> <span style="color: #50a14f; background-color: #e7e7e7;">"twemoji-15.1.0/assets/svg"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:height</span> <span style="color: #50a14f; background-color: #e7e7e7;">"1.8ex"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:offset</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-0.3ex"</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"twemoji-bw"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:url</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://github.com/youdly/twemoji-color-font/archive/refs/heads/v11-release.zip"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:folder</span> <span style="color: #50a14f; background-color: #e7e7e7;">"twemoji-color-font-11-release/assets/builds/svg-bw"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:height</span> <span style="color: #50a14f; background-color: #e7e7e7;">"1.8ex"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:offset</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-0.3ex"</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"openmoji"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:url</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://github.com/hfg-gmuend/openmoji/releases/latest/download/openmoji-svg-color.zip"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:height</span> <span style="color: #50a14f; background-color: #e7e7e7;">"2.2ex"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:offset</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-0.45ex"</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"openmoji-bw"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:url</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://github.com/hfg-gmuend/openmoji/releases/latest/download/openmoji-svg-black.zip"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:height</span> <span style="color: #50a14f; background-color: #e7e7e7;">"2.2ex"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:offset</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-0.45ex"</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"emojione"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:url</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://github.com/joypixels/emojione/archive/refs/tags/v2.2.7.zip"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:folder</span> <span style="color: #50a14f; background-color: #e7e7e7;">"emojione-2.2.7/assets/svg"</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Warning, poor coverage
</span><span class="ef-ob">    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"noto"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:url</span> <span style="color: #50a14f; background-color: #e7e7e7;">"https://github.com/googlefonts/noto-emoji/archive/refs/tags/v2.038.zip"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:folder</span> <span style="color: #50a14f; background-color: #e7e7e7;">"noto-emoji-2.038/svg"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:file-regexp</span> <span style="color: #50a14f; background-color: #e7e7e7;">"^emoji_u</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9a-f_]+</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span>
     <span style="color: #a626a4; background-color: #e7e7e7;">:height</span> <span style="color: #50a14f; background-color: #e7e7e7;">"2.0ex"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:offset</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-0.3ex"</span><span class="ef-ob">))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"An alist of plistst of emoji sets.
Specified with the minimal form:
  (\"SET-NAME\" :url \"URL\")
The following optional parameters are supported:
  :folder (defaults to \"\")
  The folder within the archive where the emojis exist.
  :file-regexp (defaults to nil)
  Pattern with the emoji code point as the first capture group.
  :height (defaults to \"1.8ex\")
  Height of the emojis to be used.
  :offset (defaults to \"-0.3ex\")
  Baseline offset of the emojis."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defconst</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-emoji-keyword</span>
  <span style="color: #50a14f; background-color: #e7e7e7;">"LATEX_EMOJI_SET"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Keyword used to set the emoji set from `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-emoji-sets</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-emoji-preamble</span><span class="ef-ob"> &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"latex-emoji-preamble"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX preamble snippet that will allow for emojis to be declared.
Contains the string \"EMOJI-FOLDER\" which should be replaced with
the path to the emoji folder."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-utf16</span><span class="ef-ob"> (char)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return the pair of UTF-16 surrogates that represent CHAR."</span><span class="ef-ob">
  (list
   (+ #xD7C0 (ash char -10))
   (+ #xDC00 (logand char #x03FF))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-declaration</span><span class="ef-ob"> (char)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Construct the LaTeX command declaring CHAR as an emoji."</span><span class="ef-ob">
  (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\DeclareEmoji{%X}{%s} %% %s"</span><span class="ef-ob">
          char
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&lt; char #xFFFF)
              (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%X"</span><span class="ef-ob"> char)
            (apply #'format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%X%X"</span><span class="ef-ob"> (org-latex-emoji-utf16 char)))
          (capitalize (get-char-code-property char 'name))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-fill-preamble</span><span class="ef-ob"> (emoji-folder </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> height offset svg-p)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Fill in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-emoji-preamble</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' with EMOJI-FOLDER, HEIGHT, and OFFSET.
If SVG-P is set \"includegraphics\" will be replaced with \"includesvg\"."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> (case-fold-search
         (filled-preamble
          (replace-regexp-in-string
           </span><span style="color: #50a14f; background-color: #e7e7e7;">"HEIGHT"</span><span class="ef-ob">
           (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> height </span><span style="color: #50a14f; background-color: #e7e7e7;">"1.8ex"</span><span class="ef-ob">)
           (replace-regexp-in-string
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"OFFSET"</span><span class="ef-ob">
            (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> offset </span><span style="color: #50a14f; background-color: #e7e7e7;">"-0.3ex"</span><span class="ef-ob">)
            (replace-regexp-in-string
             </span><span style="color: #50a14f; background-color: #e7e7e7;">"EMOJI-FOLDER"</span><span class="ef-ob">
             (directory-file-name
              (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"HOME"</span><span class="ef-ob">)
                  (replace-regexp-in-string
                   (regexp-quote (getenv </span><span style="color: #50a14f; background-color: #e7e7e7;">"HOME"</span><span class="ef-ob">))
                   </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\string~"</span><span class="ef-ob">
                   emoji-folder t t)
                emoji-folder))
             org-latex-emoji-preamble t t)
            t t)
           t t)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> svg-p
        (replace-regexp-in-string
         </span><span style="color: #50a14f; background-color: #e7e7e7;">"includegraphics"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"includesvg"</span><span class="ef-ob">
         filled-preamble t t)
      filled-preamble)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-setup</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Construct a preamble snippet to set up emojis based on INFO."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((emoji-set
          (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (org-element-map
                  (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:parse-tree</span><span class="ef-ob">)
                  'keyword
                (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (keyword)
                  (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string= (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:key</span><span class="ef-ob"> keyword)
                                org-latex-emoji-keyword)
                       (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> keyword)))
                info t)
              (caar org-latex-emoji-sets)))
         (emoji-spec (cdr (assoc emoji-set org-latex-emoji-sets)))
         (emoji-folder
          (expand-file-name emoji-set org-latex-emoji-base-dir))
         (emoji-svg-only
          (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (file-exists-p emoji-folder)
               (not (cl-some
                     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (path)
                       (not (string= (file-name-extension path) </span><span style="color: #50a14f; background-color: #e7e7e7;">"svg"</span><span class="ef-ob">)))
                     (directory-files emoji-folder nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\....$"</span><span class="ef-ob">))))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
     ((not emoji-spec)
      (</span><span style="color: #986801; background-color: #e7e7e7;">error</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Emoji set `</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' is unknown. Try one of: %s"</span><span class="ef-ob"> emoji-set
             (string-join (mapcar #'car org-latex-emoji-sets) </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">)))
     ((not (file-exists-p emoji-folder))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not noninteractive)
               (yes-or-no-p (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emoji set `</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' is not installed, would you like to install it?"</span><span class="ef-ob"> emoji-set)))
          (org-latex-emoji-install
           emoji-set
           (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"cairosvg"</span><span class="ef-ob">) (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"inkscape"</span><span class="ef-ob">)))
        (</span><span style="color: #986801; background-color: #e7e7e7;">error</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Emoji set `</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' is not installed"</span><span class="ef-ob"> emoji-set))))
    (org-latex-emoji-fill-preamble
     emoji-folder (plist-get emoji-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob">)
     (plist-get emoji-spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:offset</span><span class="ef-ob">) emoji-svg-only)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (emoji-setup </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">The precompilable bit
</span>   <span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
                (goto-char (point-min))
                (re-search-forward org-latex-emoji--rx nil t))
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> (image pkg-transparent)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-latex-emoji-setup
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 3)
  (pkg-transparent </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Part of emoji setup, but non-precompilable.
</span>   <span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{transparent}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 84)
  (emoji-declarations
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> emoji-setup
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob">
   (mapconcat
    #'org-latex-emoji-declaration
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (unicode-cars)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
        (goto-char (point-min))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (re-search-forward org-latex-emoji--rx nil t)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> (aref (match-string 0) 0) unicode-cars)))
      (cl-delete-duplicates unicode-cars))
    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\n"</span><span class="ef-ob">)
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 85))
</span><span class="ef-obe">#+end_src
</span>
Unfortunately this isn't a global solution, as LuaLaTeX doesn't have
<span style="color: #84888b;">=\DeclareUnicodeCharacter=</span>. However, we can fix this with a hack for the one case
when we know it will be used.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (emoji-lualatex-hack
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:when</span><span class="ef-ob"> (emoji julia-code) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">LuaLaTeX is used with julia-code.
</span>   <span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span>
   <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{newunicodechar}
\\newcommand{\\DeclareUnicodeCharacter}[2]{%
    \\begingroup\\lccode`|=\\string\"#1\\relax
    \\lowercase{\\endgroup\\newunicodechar{|}}{#2}}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:before</span><span class="ef-ob"> emoji))
</span><span class="ef-obe">#+end_src
</span>
This works fairly nicely, there's just one little QOL upgrade that we can
perform. <span style="color: #84888b;">=emojify=</span> downloads the <span style="color: #84888b;">~72x72~</span> versions of Twemoji, however SVG versions
are also produced. We could use <span style="color: #84888b;">~inkscape~</span> to convert those to PDFs, which would
likely be best for including.

This works fairly nicely, but it would be good to use <span style="color: #84888b;">=.pdf=</span> forms whenever
possible. We can use <span style="color: #84888b;">=texdef=</span> to check the file extension priority list.

<span class="ef-obb">#+begin_src shell :tangle no :exports both :results output verbatim :wrap example
</span><span class="ef-ob">texdef -t pdflatex -p graphicx Gin@extensions
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #84888b;">#+RESULTS:</span>
<span class="ef-obb">#+begin_example
</span><span class="ef-ob">\Gin@extensions:
macro:-&gt;.pdf,.png,.jpg,.mps,.jpeg,.jbig2,.jb2,.PDF,.PNG,.JPG,.JPEG,.JBIG2,.JB2,.eps
</span><span class="ef-obe">#+end_example
</span>
Fantastic! We can see that <span style="color: #84888b;">=.pdf=</span> actually comes first in the priority list.
Now we just need to fetch and convert the emoji images.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-install</span><span class="ef-ob"> (set </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> convert)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Dowload, convert, and install emojis for use with LaTeX."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">
   (list (completing-read </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emoji set to install: "</span><span class="ef-ob">
                          (mapcar
                           (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (set-spec)
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (file-exists-p (expand-file-name (car set-spec) org-latex-emoji-base-dir))
                                 (propertize (car set-spec) 'face 'font-lock-doc-face)
                               (car set-spec)))
                           org-latex-emoji-sets)
                          nil t)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"cairosvg"</span><span class="ef-ob">) (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"inkscape"</span><span class="ef-ob">))
             (yes-or-no-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"Would you like to create .pdf forms of the Emojis (strongly recommended)?"</span><span class="ef-ob">)
           (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Install `</span><span style="color: #b751b6; background-color: #e7e7e7;">cairosvg</span><span style="color: #50a14f; background-color: #e7e7e7;">' (recommended) or `</span><span style="color: #b751b6; background-color: #e7e7e7;">inkscape</span><span style="color: #50a14f; background-color: #e7e7e7;">' to convert to PDF forms"</span><span class="ef-ob">)
           nil)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((emoji-folder (expand-file-name set org-latex-emoji-base-dir)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (not (file-exists-p emoji-folder))
              (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (not noninteractive)
                   (yes-or-no-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emoji folder already present, would you like to re-download?"</span><span class="ef-ob">)
                   (</span><span style="color: #e45649; background-color: #e7e7e7;">progn</span><span class="ef-ob"> (delete-directory emoji-folder t) t)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((spec (cdr (assoc set org-latex-emoji-sets)))
             (dir (org-latex-emoji-install--download set (plist-get spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:url</span><span class="ef-ob">)))
             (svg-dir (expand-file-name (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (plist-get spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:folder</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">) dir)))
        (org-latex-emoji-install--install
         set svg-dir (plist-get spec </span><span style="color: #a626a4; background-color: #e7e7e7;">:file-regexp</span><span class="ef-ob">))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> convert
      (org-latex-emoji-install--convert (file-name-as-directory emoji-folder))))
  (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Emojis set `</span><span style="color: #b751b6; background-color: #e7e7e7;">%s</span><span style="color: #50a14f; background-color: #e7e7e7;">' installed."</span><span class="ef-ob"> set))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-install--download</span><span class="ef-ob"> (name url)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Download the emoji archive URL for the set NAME."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((dest-folder (make-temp-file (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s-"</span><span class="ef-ob"> name) t)))
    (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Downloading %s..."</span><span class="ef-ob"> name)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((default-directory dest-folder))
      (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"curl"</span><span class="ef-ob"> nil nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"-sL"</span><span class="ef-ob"> url </span><span style="color: #50a14f; background-color: #e7e7e7;">"--output"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"emojis.zip"</span><span class="ef-ob">)
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Unzipping"</span><span class="ef-ob">)
      (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"unzip"</span><span class="ef-ob"> nil nil nil </span><span style="color: #50a14f; background-color: #e7e7e7;">"emojis.zip"</span><span class="ef-ob">)
      dest-folder)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-install--install</span><span class="ef-ob"> (name dir </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> filename-regexp)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Install the emoji files in DIR to the NAME set folder.
If a FILENAME-REGEXP, only files matching this regexp will be moved,
and they will be renamed to the first capture group of the regexp."</span><span class="ef-ob">
  (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Installing %s emojis into emoji directory"</span><span class="ef-ob"> name)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((images (append (directory-files dir t </span><span style="color: #50a14f; background-color: #e7e7e7;">".*.svg"</span><span class="ef-ob">)
                        (directory-files dir t </span><span style="color: #50a14f; background-color: #e7e7e7;">".*.pdf"</span><span class="ef-ob">)))
        (emoji-dir (file-name-as-directory
                    (expand-file-name name org-latex-emoji-base-dir))))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (file-exists-p emoji-dir)
      (make-directory emoji-dir t))
    (mapc
     (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (image)
       (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> filename-regexp
           (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (string-match filename-regexp (file-name-nondirectory image))
             (rename-file image
                          (expand-file-name
                           (file-name-with-extension
                            (upcase (match-string 1 (file-name-nondirectory image)))
                            (file-name-extension image))
                           emoji-dir)
                          t))
         (rename-file image
                      (expand-file-name
                       (file-name-with-extension
                        (upcase (file-name-nondirectory image))
                        (file-name-extension image))
                       emoji-dir)
                      t)))
     images)
    (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"%d emojis installed"</span><span class="ef-ob"> (length images))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-emoji-install--convert</span><span class="ef-ob"> (dir)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Convert all .svg files in DIR to .pdf forms.
Uses cairosvg if possible, falling back to inkscape."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((default-directory dir))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"cairosvg"</span><span class="ef-ob">) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">cairo's PDFs are ~10% smaller
</span><span class="ef-ob">        (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((images (directory-files dir nil </span><span style="color: #50a14f; background-color: #e7e7e7;">".*.svg"</span><span class="ef-ob">))
               (num-images (length images))
               (index 0)
               (max-threads (1- (string-to-number (shell-command-to-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"nproc"</span><span class="ef-ob">))))
               (threads 0))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (&lt; index num-images)
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> threads (1+ threads))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (message-log-max)
              (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Converting emoji %d/%d (%s)"</span><span class="ef-ob"> (1+ index) num-images (nth index images)))
            (make-process </span><span style="color: #a626a4; background-color: #e7e7e7;">:name</span> <span style="color: #50a14f; background-color: #e7e7e7;">"cairosvg"</span>
                          <span style="color: #a626a4; background-color: #e7e7e7;">:command</span><span class="ef-ob"> (list </span><span style="color: #50a14f; background-color: #e7e7e7;">"cairosvg"</span><span class="ef-ob"> (nth index images) </span><span style="color: #50a14f; background-color: #e7e7e7;">"-o"</span><span class="ef-ob"> (concat (file-name-sans-extension (nth index images)) </span><span style="color: #50a14f; background-color: #e7e7e7;">".pdf"</span><span class="ef-ob">))
                          </span><span style="color: #a626a4; background-color: #e7e7e7;">:sentinel</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (proc msg)
                                      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (memq (process-status proc) '(exit signal))
                                        (</span><span style="color: #e45649; background-color: #e7e7e7;">setf</span><span class="ef-ob"> threads (1- threads)))))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> index (1+ index))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (&gt; threads max-threads)
              (sleep-for 0.01)))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (&gt; threads 0)
            (sleep-for 0.01)))
      (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Cairosvg not found. Proceeding with inkscape as a fallback."</span><span class="ef-ob">)
      (shell-command </span><span style="color: #50a14f; background-color: #e7e7e7;">"inkscape --batch-process --export-type='</span><span style="color: #b751b6; background-color: #e7e7e7;">pdf</span><span style="color: #50a14f; background-color: #e7e7e7;">' *.svg"</span><span class="ef-ob">))
    (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Finished conversion!"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Remove non-ascii chars</span>

When using <span style="color: #84888b;">~pdflatex~</span>, almost non-ascii characters are generally problematic, and
don't appear in the pdf. It's preferable to see that there was <span style="text-decoration: italic;">/some/</span> character
which wasn't displayed as opposed to nothing.

We check every non-ascii character to make sure it's not a character encoded by
the <span style="color: #84888b;">=inputenc=</span> packages when loaded with the <span style="color: #84888b;">=utf8=</span> option. We'll also allow
box-drawing characters since they can be mostly supported with <span style="color: #84888b;">=pmboxdraw=</span>.
Finally, we see if we have our own LaTeX conversion we can apply and if there is
none we replace the non-ascii char with <span style="color: #84888b;">=¿=</span>.

No to make sure we only remove characters that can't be displayed, we check
<span style="color: #84888b;">=/usr/share/texmf/tex/latex/base/utf8enc.dfu=</span>.

We just need to make sure this is appended to the list of filter functions,
since we want to let emoji processing occur first.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-pdflatex-inputenc-encoded-chars</span>
  <span style="color: #50a14f; background-color: #e7e7e7;">"[[:ascii:]\u00A0-\u01F0\u0218-\u021BȲȳȷˆˇ˜˘˙˛˝\u0400-\u04FFḂḃẞ\u200B\u200C\u2010-\u201E†‡•…‰‱‹›※‽⁄⁎⁒₡₤₦₩₫€₱℃№℗℞℠™Ω℧℮←↑→↓〈〉␢␣◦◯♪⟨⟩Ḡḡ\uFB00-\uFB06\u2500-\u259F]"</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-latex-replace-non-ascii-chars</span><span class="ef-ob"> (text backend info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Replace non-ascii chars with \\char\"XYZ forms."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (org-export-derived-backend-p backend 'latex)
             (string= (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:latex-compiler</span><span class="ef-ob">) </span><span style="color: #50a14f; background-color: #e7e7e7;">"pdflatex"</span><span class="ef-ob">))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> (case-replace)
      (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">[:ascii:]]"</span><span class="ef-ob">
                                (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (nonascii)
                                  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (string-match-p +org-pdflatex-inputenc-encoded-chars nonascii)
                                          (string-match-p org-latex-emoji--rx nonascii))
                                      nonascii
                                    (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> (cdr (assoc nonascii +org-latex-non-ascii-char-substitutions))
                                        </span><span style="color: #50a14f; background-color: #e7e7e7;">"¿"</span><span class="ef-ob">)))
                                text))))

(add-to-list 'org-export-filter-plain-text-functions #'+org-latex-replace-non-ascii-chars t)
</span><span class="ef-obe">#+end_src
</span>
Now, there are some symbols that aren't included in <span style="color: #84888b;">=inputenc=</span>, but we should be
able to handle anyway. For them we define a table of LaTeX translations

<span style="color: #84888b;">#+name: latex-non-ascii-char-substitutions</span>
| Character | LaTeX |
|-----------+-------|
| ɑ         | \(\alpha\) |
| β         | \(\beta\) |
| γ         | \(\gamma\) |
| δ         | \(\delta\) |
| ε         | \(\epsilon\) |
| ϵ         | \(\varepsilon\) |
| ζ         | \(\zeta\) |
| η         | \(\eta\) |
| θ         | \(\theta\) |
| ϑ         | \(\vartheta\) |
| ι         | \(\iota\) |
| κ         | \(\kappa\) |
| λ         | \(\lambda\) |
| μ         | \(\mu\) |
| ν         | \(\nu\) |
| ξ         | \(\xi\) |
| π         | \(\pi\) |
| ϖ         | \(\varpi\) |
| ρ         | \(\rho\) |
| ϱ         | \(\varrho\) |
| σ         | \(\sigma\) |
| ς         | \(\varsigma\) |
| τ         | \(\tau\) |
| υ         | \(\upsilon\) |
| ϕ         | \(\phi\) |
| φ         | \(\varphi\) |
| ψ         | \(\psi\) |
| ω         | \(\omega\) |
| Γ         | \(\Gamma\) |
| Δ         | \(\Delta\) |
| Θ         | \(\Theta\) |
| Λ         | \(\Lambda\) |
| Ξ         | \(\Xi\) |
| Π         | \(\Pi\) |
| Σ         | \(\Sigma\) |
| Υ         | \(\Upsilon\) |
| Φ         | \(\Phi\) |
| Ψ         | \(\Psi\) |
| Ω         | \(\Omega\) |
| א         | \(\aleph\) |
| ב         | \(\beth\) |
| ד         | \(\daleth\) |
| ג         | \(\gimel\) |

<span style="color: #84888b;">#+name: gen-latex-non-ascii-char-substitutions</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none :var latex-non-ascii-char-substitutions=latex-non-ascii-char-substitutions
</span><span class="ef-ob">(replace-regexp-in-string
 </span><span style="color: #50a14f; background-color: #e7e7e7;">" '(("</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\n   '(("</span><span class="ef-ob">
 (replace-regexp-in-string
  </span><span style="color: #50a14f; background-color: #e7e7e7;">") ("</span> <span style="color: #50a14f; background-color: #e7e7e7;">")\n     ("</span><span class="ef-ob">
  (prin1-to-string
   `(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-latex-non-ascii-char-substitutions</span><span class="ef-ob">
      ',(mapcar
         (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (entry)
           (cons (car entry) (replace-regexp-in-string </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\\\\\\\"</span><span class="ef-ob"> (cadr entry))))
         latex-non-ascii-char-substitutions)))))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">&lt;&lt;gen-latex-non-ascii-char-substitutions()&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Normal spaces after abbreviations</span>

In LaTeX inter-word and sentence spaces are typically of different widths. This
can be an issue when using abbreviations i.e. e.g. etc. et al..
This can be corrected by forcing a normal space with <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">LaTeX</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">\ </span><span style="color: #84888b; background-color: #e7e7e7;">}</span>.
When exporting Org documents, we can add a filter to check for common
abbreviations and make the space normal.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">+org-latex-abbreviations</span><span class="ef-ob">
  '(</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Latin
</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"cf."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"e.g."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"etc."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"et al."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"i.e."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"v."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"vs."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"viz."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"n.b."</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Corperate
</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"inc."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"govt."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ltd."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"pty."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"dept."</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Temporal
</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"est."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"c."</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Honorifics
</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"Prof."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Dr."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Mr."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Mrs."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Ms."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Miss."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Sr."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"Jr."</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Components of a work
</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"ed."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"vol."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"sec."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"chap."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"pt."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"pp."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"op."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"no."</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Common usage
</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"approx."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"misc."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"min."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"max."</span><span class="ef-ob">)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A list of abbreviations that should be spaced correctly when exporting to LaTeX."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-latex-correct-latin-abbreviation-spaces</span><span class="ef-ob"> (text backend _info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Normalise spaces after Latin abbreviations."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (org-export-derived-backend-p backend 'latex)
    (replace-regexp-in-string (</span><span style="color: #e45649; background-color: #e7e7e7;">rx</span><span class="ef-ob"> (group (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> line-start space)
                                         (regexp (regexp-opt-group +org-latex-abbreviations)))
                                  (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> line-end space))
                              </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\1\\\\ "</span><span class="ef-ob">
                              text)))

(add-to-list 'org-export-filter-paragraph-functions #'+org-latex-correct-latin-abbreviation-spaces t)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Extra special strings</span>

LaTeX already recognises <span style="color: #84888b;">=---=</span> and <span style="color: #84888b;">=--=</span> as em/en-dashes, <span style="color: #84888b;">=\-=</span> as a shy hyphen, and the
conversion of <span style="color: #84888b;">=...=</span> to <span style="color: #84888b;">=\ldots{}=</span> is hardcoded into <span style="color: #84888b;">~org-latex-plain-text~</span> (unlike
<span style="color: #84888b;">~org-html-plain-text~</span>).

I'd quite like to also recognise <span style="color: #84888b;">=-&gt;=</span> and <span style="color: #84888b;">=&lt;-=</span>, so let's set come up with some advice.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-latex-extra-special-string-regexps</span><span class="ef-ob">
  '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;-&gt;"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\(\\\\leftrightarrow{}\\\\)"</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"-&gt;"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\textrightarrow{}"</span><span class="ef-ob">)
    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;-"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\textleftarrow{}"</span><span class="ef-ob">)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-latex-convert-extra-special-strings</span><span class="ef-ob"> (string)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Convert special characters in STRING to LaTeX."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">dolist</span><span class="ef-ob"> (a org-latex-extra-special-string-regexps string)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((re (car a))
          (rpl (cdr a)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> string (replace-regexp-in-string re rpl string t)))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-latex-plain-text-extra-special-a (orig-fn text info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Make `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-latex-plain-text</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' handle some extra special strings."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-latex-plain-text
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((output (funcall orig-fn text info)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-special-strings</span><span class="ef-ob">)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> output (org-latex-convert-extra-special-strings output)))
    output))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Chameleon --- aka. match theme</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg ox-chameleon")</span>

Once I had the idea of having the look of the LaTeX document produced match the
current Emacs theme, I was enraptured. The result is the pseudo-class <span style="color: #84888b;">~chameleon~</span>,
which I have implemented in the package <span style="color: #84888b;">=ox-chameleon=</span>.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> ox-chameleon </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/ox-chameleon"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! ox-chameleon
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> ox)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Make verbatim different to code</span>

Since have just gone to so much effort above let's make the most of it by making
<span style="color: #84888b;">=verbatim=</span> use <span style="color: #84888b;">~verb~</span> instead of <span style="color: #84888b;">~protectedtexttt~</span> (default).

This gives the same advantages as mentioned in the <span style="color: #4078f2; font-weight: 700;">[[*Make verbatim different to code][HTML export section]]</span>.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-latex-text-markup-alist
      '((bold . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\textbf{%s}"</span><span class="ef-ob">)
        (code . protectedtexttt)
        (italic . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\emph{%s}"</span><span class="ef-ob">)
        (strike-through . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\sout{%s}"</span><span class="ef-ob">)
        (underline . </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\uline{%s}"</span><span class="ef-ob">)
        (verbatim . verb)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Check for required packages</span>

For how I've setup Org's LaTeX export, the following packages are needed:
<span style="color: #84888b;">#+name: org-latex-required-packages-list</span>
| Package     | Description                                           |
|-------------+-------------------------------------------------------|
| adjustbox   | Adjust general LaTeX material in like includegraphics |
| accsupp     | Copy-paste text overlay for emoji images              |
| amsmath     | A near-essential maths package                        |
| booktabs    | Nice horizontal lines in tables                       |
| cancel      | Cancel terms in equations                             |
| capt-of     | Captions outside floats                               |
| caption     | Finer control over captions                           |
| cleveref    | Easy cross-referencing                                |
| embedall    | Embed files in the document                           |
| etoolbox    | Document hooks                                        |
| float       | Floating environments                                 |
| fontenc     | Font encodings                                        |
| fvextra     | Enhanced verbatim environments                        |
| graphicx    | An extended graphics package                          |
| hanging     | Used by oc-csl                                        |
| hyperref    | Links                                                 |
| inputenc    | Input file encodings                                  |
| longtable   | Multi-page tables                                     |
| mathalpha   | Set extended math alphabet fonts                      |
| mathtools   | Typesetting tools for maths                           |
| microtype   | Microtypography                                       |
| pdfx        | Create pdf/a- and pdf/x- compatible documents         |
| pifont      | A collection of symbols                               |
| pmboxdraw   | Good-looking box drawing characters                   |
| preview     | Needed for AUCTeX and ob-latex                        |
| scrbase     | KOMA classes and more                                 |
| scrextend   | KOMA utilities                                        |
| siunitx     | Proper unit support                                   |
| soul        | Strikethrough and underline, flexibly                 |
| subcaption  | Form subfigures and subcaptions                       |
| svg         | Insert SVG images                                     |
| tcolorbox   | Nice boxes for code                                   |
| textcomp    | Font encodings                                        |
| tikz        | Generally handy, as a dependancy and for graphics     |
| transparent | Invisible text for emoji copying                      |
| xcoffins    | Manipulate coffins (boxes) for typesetting            |
| xcolor      | Colours                                               |
| xparse      | Extended command/env definition forms                 |

Then for the various fontsets:
<span style="color: #84888b;">#+name: org-latex-font-packages-list</span>
+ Alegreya
+ arev
+ arevmath
+ biolinum
+ FiraMono
+ FiraSans
+ fourier
+ gillius
+ kpfonts
+ libertine
+ newpxmath
+ newpxtext
+ newtxmath
+ newtxtext
+ newtxsf
+ noto
+ notomath
+ plex-mono
+ plex-sans
+ plex-serif
+ sourcecodepro
+ sourcesanspro
+ sourceserifpro

We can write a function which will check for each of these packages with
<span style="color: #84888b;">=kpsewhich=</span>, and then if any of them are missing we'll inject some advice into the
generated config that gets a list of missing packages and warns us every time we
export to a PDF.

<span style="color: #84888b;">#+name: org-missing-latex-packages</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none :var org-latex-required-packages-list=org-latex-required-packages-list[,0] :var org-latex-font-packages-list=org-latex-font-packages-list
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-required-latex-packages
      (append org-latex-required-packages-list
              org-latex-font-packages-list))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">check-for-latex-packages</span><span class="ef-ob"> (packages)
  (delq nil (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (package)
                      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob">
                          (= 0 (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"kpsewhich"</span><span class="ef-ob"> nil nil nil (concat package </span><span style="color: #50a14f; background-color: #e7e7e7;">".sty"</span><span class="ef-ob">)))
                        package))
                    packages)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">if-let</span><span class="ef-ob"> (((executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"kpsewhich"</span><span class="ef-ob">))
         (missing-pkgs (check-for-latex-packages org-required-latex-packages)))
    (concat
     (pp-to-string `(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-required-latex-packages ',org-required-latex-packages))
     (message </span><span style="color: #50a14f; background-color: #e7e7e7;">";; Detected missing LaTeX packages: %s\n"</span><span class="ef-ob"> (mapconcat #'identity missing-pkgs </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">))
     (pp-to-string
      '(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">check-for-latex-packages</span><span class="ef-ob"> (packages)
         (delq nil (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (package)
                             (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob">
                                 (= 0 (call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"kpsewhich"</span><span class="ef-ob"> nil nil nil (concat package </span><span style="color: #50a14f; background-color: #e7e7e7;">".sty"</span><span class="ef-ob">)))
                               package))
                           packages))))
     (pp-to-string
      '(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">+org-warn-about-missing-latex-packages</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;rest</span><span class="ef-ob"> _)
         (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"Checking for missing LaTeX packages..."</span><span class="ef-ob">)
         (sleep-for 0.4)
         (</span><span style="color: #e45649; background-color: #e7e7e7;">if-let</span><span class="ef-ob"> (missing-pkgs (check-for-latex-packages org-required-latex-packages))
             (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s You are missing the following LaTeX packages: %s."</span><span class="ef-ob">
                      (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Warning!"</span><span class="ef-ob"> 'face '(bold warning))
                      (mapconcat (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (pkg) (propertize pkg 'face 'font-lock-variable-name-face))
                                 missing-pkgs
                                 </span><span style="color: #50a14f; background-color: #e7e7e7;">", "</span><span class="ef-ob">))
           (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"%s You have all the required LaTeX packages. Run %s to make this message go away."</span><span class="ef-ob">
                    (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"Success!"</span><span class="ef-ob"> 'face '(bold success))
                    (propertize </span><span style="color: #50a14f; background-color: #e7e7e7;">"doom sync"</span><span class="ef-ob"> 'face 'font-lock-keyword-face))
           (advice-remove 'org-latex-export-to-pdf #'+org-warn-about-missing-latex-packages))
         (sleep-for 1)))
     (pp-to-string
      '(advice-add 'org-latex-export-to-pdf </span><span style="color: #a626a4; background-color: #e7e7e7;">:before</span><span class="ef-ob"> #'+org-warn-about-missing-latex-packages)))
  </span><span style="color: #50a14f; background-color: #e7e7e7;">";; No missing LaTeX packags detected"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">&lt;&lt;org-missing-latex-packages()&gt;&gt;
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Beamer Export</span>

<span style="color: #84888b;">#+call: confpkg("ox-beamer", after="ox-beamer")</span>

It's nice to use a different theme
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-beamer-theme </span><span style="color: #50a14f; background-color: #e7e7e7;">"[progressbar=foot]metropolis"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
When using metropolis though, we want to make a few tweaks:
<span style="color: #84888b;">#+name: beamer-metropolis-tweaks</span>
<span class="ef-obb">#+begin_src LaTeX
</span><span style="color: #e45649; background-color: #e7e7e7;">\NewCommandCopy</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\moldusetheme</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\usetheme</span><span class="ef-ob">}
</span><span style="color: #e45649; background-color: #e7e7e7;">\renewcommand</span><span style="color: #e45649; background-color: #e7e7e7;">*</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\usetheme</span><span class="ef-ob">}[</span><span style="color: #6a1868; background-color: #e7e7e7;">2</span><span class="ef-ob">][]{</span><span style="color: #a626a4; background-color: #e7e7e7;">\moldusetheme</span><span style="color: #a626a4; background-color: #e7e7e7;">[#1]{#2}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\setbeamertemplate</span><span style="color: #a626a4; background-color: #e7e7e7;">{items}{</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span style="color: #a626a4; background-color: #e7e7e7;">\bullet</span><span style="color: #a626a4; background-color: #e7e7e7;">$</span><span style="color: #a626a4; background-color: #e7e7e7;">}
  </span><span style="color: #a626a4; background-color: #e7e7e7;">\setbeamerfont</span><span style="color: #a626a4; background-color: #e7e7e7;">{block title}{size=</span><span style="color: #a626a4; background-color: #e7e7e7;">\normalsize</span><span style="color: #a626a4; background-color: #e7e7e7;">, series=</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\bfseries</span><span style="color: #a626a4; background-color: #e7e7e7;">\parbox</span><span style="color: #a626a4; background-color: #e7e7e7;">{0pt}{</span><span style="color: #a626a4; background-color: #e7e7e7;">\rule</span><span style="color: #a626a4; background-color: #e7e7e7;">{0pt}{4ex}}}</span><span class="ef-ob">}

</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatletter</span>
<span style="color: #e45649; background-color: #e7e7e7;">\newcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">\setmetropolislinewidth</span><span class="ef-ob">}{</span>
  <span style="color: #e45649; background-color: #e7e7e7;">\setlength</span><span style="color: #a626a4; background-color: #e7e7e7;">{</span><span style="color: #6a1868; background-color: #e7e7e7;">\metropolis@progressinheadfoot@linewidth</span><span style="color: #a626a4; background-color: #e7e7e7;">}{</span><span style="color: #6a1868; background-color: #e7e7e7;">1.2px</span><span style="color: #a626a4; background-color: #e7e7e7;">}</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\makeatother</span>

<span style="color: #e45649; background-color: #e7e7e7;">\usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">etoolbox</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">\AtEndPreamble</span><span class="ef-ob">{</span><span style="color: #84888b; background-color: #e7e7e7;">\setmetropolislinewidth</span><span class="ef-ob">}
</span><span class="ef-obe">#+end_src
</span>
Now let's just apply this along with some extra beamer tweaks.

<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-beamer-p</span><span class="ef-ob"> (info)
  (eq 'beamer (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:back-end</span><span class="ef-ob">)
                   (org-export-backend-name (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:back-end</span><span class="ef-ob">)))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'beamer
  (beamer-setup
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> t
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:requires</span><span class="ef-ob"> .missing-koma
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:prevents</span><span class="ef-ob"> (italic-quotes condensed-lists cover-page)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'latex
  (.missing-koma
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\usepackage{scrextend}"</span>
   <span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 2))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-beamer-metropolis-tweaks</span><span class="ef-ob">
  &lt;&lt;grab(</span><span style="color: #50a14f; background-color: #e7e7e7;">"beamer-metropolis-tweaks"</span><span class="ef-ob">)&gt;&gt;
  </span><span style="color: #50a14f; background-color: #e7e7e7;">"LaTeX preamble snippet that tweaks the Beamer metropolis theme styling."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">org-export-update-features</span><span class="ef-ob"> 'beamer
  (beamer-metropolis
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:condition</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"metropolis$"</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:beamer-theme</span><span class="ef-ob">))
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:snippet</span><span class="ef-ob"> org-beamer-metropolis-tweaks
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:order</span><span class="ef-ob"> 3))
</span><span class="ef-obe">#+end_src
</span>
And I think that it's natural to divide a presentation into sections, e.g.
Introduction, Overview... so let's set bump up the headline level that becomes a
frame from <span style="color: #84888b;">~1~</span> to <span style="color: #84888b;">~2~</span>.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-beamer-frame-level 2)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Reveal export</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg org-re-reveal", after="org-re-reveal")</span>

By default reveal is rather nice, there are just a few tweaks that I consider a
good idea.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-re-reveal-theme </span><span style="color: #50a14f; background-color: #e7e7e7;">"white"</span><span class="ef-ob">
      org-re-reveal-transition </span><span style="color: #50a14f; background-color: #e7e7e7;">"slide"</span><span class="ef-ob">
      org-re-reveal-plugins '(markdown notes math search zoom))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** ASCII export</span>

<span style="color: #84888b;">#+call: confpkg("ox-ascii", after="ox-ascii")</span>

To start with, why settle for ASCII when UTF-8 exists?
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> org-ascii-charset 'utf-8)
</span><span class="ef-obe">#+end_src
</span>
The ASCII export is generally fairly nice. I think the main aspect that could
benefit from improvement is the appearance of LaTeX fragments. There's a nice
utility we can use to create unicode representation, which are much nicer.
It's called <span style="color: #84888b;">~latex2text~</span>, and it's part of the <span style="color: #84888b;">=pylatexenc=</span> package, and it's <span style="color: #4078f2; font-weight: 700;">[[https://repology.org/project/python:pylatexenc/versions][not
really packaged]]</span>. So, we'll resort to installing it with <span style="color: #84888b;">=pip=</span>.

<span class="ef-obb">#+begin_src shell :tangle (if (executable-find "latex2text") "no" "setup.sh")
</span><span class="ef-ob">sudo python3 -m pip install pylatexenc
</span><span class="ef-obe">#+end_src
</span>
With an accompanying <span style="color: #84888b;">=doctor=</span> check.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref doctor
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"latex2text"</span><span class="ef-ob">)
  (warn! </span><span style="color: #50a14f; background-color: #e7e7e7;">"Couldn't find latex2text executable (from pylatexenc), will be unable to render LaTeX fragments in org→text exports."</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
With that installed, we can override the <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(org-ascii-latex-fragment)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> and
<span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">elisp</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">(org-ascii-latex-environment)</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> functions, which are conveniently very
slim --- just extracting the content, and indenting. We'll only do something
different when <span style="color: #84888b;">=utf-8=</span> is set.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (executable-find </span><span style="color: #50a14f; background-color: #e7e7e7;">"latex2text"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> ox-ascii
    (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-ascii-convert-latex</span><span class="ef-ob"> t
      </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Use latex2text to convert LaTeX elements to unicode."</span><span class="ef-ob">)

    (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-ascii-latex-environment-unicode-a (latex-environment _contents info)
      </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Transcode a LATEX-ENVIRONMENT element from Org to ASCII, converting to unicode.
CONTENTS is nil.  INFO is a plist holding contextual
information."</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'org-ascii-latex-environment
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-latex</span><span class="ef-ob">)
        (org-ascii--justify-element
         (org-remove-indentation
          (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((latex (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> latex-environment))
                 (unicode (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (eq (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:ascii-charset</span><span class="ef-ob">) 'utf-8)
                               org-ascii-convert-latex
                               (doom-call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"latex2text"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-q"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"--code"</span><span class="ef-ob"> latex))))
            (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (= (car unicode) 0) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">utf-8 set, and sucessfully ran latex2text
</span><span class="ef-ob">                (cdr unicode) latex)))
         latex-environment info)))

    (</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-ascii-latex-fragment-unicode-a (latex-fragment _contents info)
      </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Transcode a LATEX-FRAGMENT object from Org to ASCII, converting to unicode.
CONTENTS is nil.  INFO is a plist holding contextual
information."</span>
      <span style="color: #a626a4; background-color: #e7e7e7;">:override</span><span class="ef-ob"> #'org-ascii-latex-fragment
      (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-latex</span><span class="ef-ob">)
        (</span><span style="color: #e45649; background-color: #e7e7e7;">let*</span><span class="ef-ob"> ((latex (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> latex-fragment))
               (unicode (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (eq (plist-get info </span><span style="color: #a626a4; background-color: #e7e7e7;">:ascii-charset</span><span class="ef-ob">) 'utf-8)
                             org-ascii-convert-latex
                             (doom-call-process </span><span style="color: #50a14f; background-color: #e7e7e7;">"latex2text"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"-q"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"--code"</span><span class="ef-ob"> latex))))
          (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> unicode (= (car unicode) 0)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">utf-8 set, and sucessfully ran latex2text
</span><span class="ef-ob">              (cdr unicode) latex))))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Markdown Export</span>

<span style="color: #84888b;">#+call: confpkg("ox-md", after="ox-md")</span>

<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** GFM</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg ox-gfm")</span>

Because of the <span style="text-decoration: italic;">/</span><span style="color: #4078f2; text-decoration: italic; font-weight: 700;">[[https://github.com/commonmark/commonmark-spec/wiki/markdown-flavors][lovely variety in markdown implementations]]</span><span style="text-decoration: italic;">/</span> there isn't actually
such a thing a standard table spec ... or standard anything really. Because
<span style="color: #84888b;">~org-md~</span> is a goody-two-shoes, it just uses HTML for all these non-standardised
elements (a lot of them). So <span style="color: #84888b;">~ox-gfm~</span> is handy for exporting markdown with all the
features that GitHub has.

<span class="ef-obb">#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> ox-gfm </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"4f774f13d34b3db9ea4ddb0b1edc070b1526ccbb"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! ox-gfm
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:after</span><span class="ef-ob"> ox)
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Character substitutions</span>

When I want to paste exported markdown somewhere (for example when using <span style="color: #4078f2; font-weight: 700;">[[Emacs Everywhere][Emacs
Everywhere]]</span>), it can be preferable to have unicode characters for <span style="color: #84888b;">=---=</span> etc. instead
of <span style="color: #84888b;">=&amp;#x2014;=</span>.

To accomplish this, we just need to locally rebind the alist which provides
these substitution.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-md-plain-text-unicode-a (orig-fn text info)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Locally rebind `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-html-special-string-regexps</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-md-plain-text
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((org-html-special-string-regexps
         '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\-"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"-"</span><span class="ef-ob">)
           (</span><span style="color: #50a14f; background-color: #e7e7e7;">"---</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">-]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">$</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"—\\1"</span><span class="ef-ob">)
           (</span><span style="color: #50a14f; background-color: #e7e7e7;">"--</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">^</span><span style="color: #50a14f; background-color: #e7e7e7;">-]</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">|</span><span style="color: #50a14f; background-color: #e7e7e7;">$</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"–\\1"</span><span class="ef-ob">)
           (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.\\.\\."</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"…"</span><span class="ef-ob">)
           (</span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;-&gt;"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"⟷"</span><span class="ef-ob">)
           (</span><span style="color: #50a14f; background-color: #e7e7e7;">"-&gt;"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"→"</span><span class="ef-ob">)
           (</span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;-"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">"←"</span><span class="ef-ob">))))
    (funcall orig-fn text (plist-put info </span><span style="color: #a626a4; background-color: #e7e7e7;">:with-smart-quotes</span><span class="ef-ob"> nil))))
</span><span class="ef-obe">#+end_src
</span>
In the future, I may want to check <span style="color: #84888b;">=info=</span> to only have this active when <span style="color: #84888b;">=ox-gfm=</span> is
being used.

Another worthwhile consideration is LaTeX formatting. It seems most Markdown
parsers are fixated on TeX-style syntax (<span style="color: #84888b;">=$=</span> and <span style="color: #84888b;">=$$=</span>). As unfortunate as this is,
it's probably best to accommodate them, for the sake of decent rendering.

<span style="color: #84888b;">=ox-md=</span> doesn't provide any transcoders for this, so we'll have to whip up our own
and push them onto the <span style="color: #84888b;">=md=</span> transcoders alist.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> ox-md
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-md-latex-fragment</span><span class="ef-ob"> (latex-fragment _contents info)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Transcode a LATEX-FRAGMENT object from Org to Markdown."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((frag (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:value</span><span class="ef-ob"> latex-fragment)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
       ((string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"^\\\\("</span><span class="ef-ob"> frag)
        (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"$"</span><span class="ef-ob"> (substring frag 2 -2) </span><span style="color: #50a14f; background-color: #e7e7e7;">"$"</span><span class="ef-ob">))
       ((string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"^\\\\\\["</span><span class="ef-ob"> frag)
        (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"$$"</span><span class="ef-ob"> (substring frag 2 -2) </span><span style="color: #50a14f; background-color: #e7e7e7;">"$$"</span><span class="ef-ob">))
       (t (message </span><span style="color: #50a14f; background-color: #e7e7e7;">"unrecognised fragment: %s"</span><span class="ef-ob"> frag)
          frag))))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-md-latex-environment</span><span class="ef-ob"> (latex-environment contents info)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Transcode a LATEX-ENVIRONMENT object from Org to Markdown."</span><span class="ef-ob">
    (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"$$\n"</span><span class="ef-ob">
            (org-html-latex-environment latex-environment contents info)
            </span><span style="color: #50a14f; background-color: #e7e7e7;">"$$\n"</span><span class="ef-ob">))

  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">org-utf8-entity</span><span class="ef-ob"> (entity _contents _info)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Transcode an ENTITY object from Org to utf-8.
CONTENTS are the definition itself.  INFO is a plist holding
contextual information."</span><span class="ef-ob">
    (org-element-property </span><span style="color: #a626a4; background-color: #e7e7e7;">:utf-8</span><span class="ef-ob"> entity))

  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">We can't let this be immediately parsed and evaluated,
</span>  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">because eager macro-expansion tries to call as-of-yet
</span>  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">undefined functions.
</span>  <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">NOTE in the near future this shouldn't be required
</span><span class="ef-ob">  (eval
   '(dolist (extra-transcoder
             '((latex-fragment . org-md-latex-fragment)
               (latex-environment . org-md-latex-environment)
               (entity . org-utf8-entity)))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (member extra-transcoder (org-export-backend-transcoders
                                        (org-export-get-backend 'md)))
        (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> extra-transcoder (org-export-backend-transcoders
                                (org-export-get-backend 'md)))))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Babel</span>

<span style="color: #84888b;">#+call: confpkg("Org Babel")</span>

Doom lazy-loads babel languages, with is lovely.
It also pulls in <span style="color: #4078f2; font-weight: 700;">[[https://github.com/astahlman/ob-async][ob-async]]</span>, which is nice, but it would be even better if it was
used by default.

There are two caveats to <span style="color: #84888b;">=ob-async=</span>:
1. It does not support <span style="color: #84888b;">=:session=</span>
   + So, we don't want <span style="color: #84888b;">=:async=</span> used when <span style="color: #84888b;">=:session=</span> is set
2. It adds a fixed delay to execution
   + This is undesirable in a number of cases, for example it's generally
     unwanted with <span style="color: #84888b;">=emacs-lisp=</span> code
   + As such, I also introduce a async language blacklist to control when it's
     automatically enabled

Due to the nuance in the desired behaviour, instead of just adding <span style="color: #84888b;">=:async=</span> to
<span style="color: #84888b;">~org-babel-default-header-args~</span>, I advice <span style="color: #84888b;">~org-babel-get-src-block-info~</span> to add
<span style="color: #84888b;">=:async=</span> intelligently. As an escape hatch, it also recognises <span style="color: #84888b;">=:sync=</span> as an
indication that <span style="color: #84888b;">=:async=</span> should not be added.

I did originally have this enabled for everything except for <span style="color: #84888b;">=emacs-lisp=</span> and
<span style="color: #84888b;">=LaTeX=</span> (there were weird issues), but this added  a ~3s "startup" cost to every
src block evaluation, which was a bit of a pain. Since <span style="color: #84888b;">=:async=</span> can be added
easily with <span style="color: #84888b;">=#+properties=</span>, I've turned this behaviour from a blacklist to a
whitelist.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">add-transient-hook!</span><span class="ef-ob"> #'org-babel-execute-src-block
  (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">ob-async</span><span class="ef-ob">))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">org-babel-auto-async-languages</span><span class="ef-ob"> '()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Babel languages which should be executed asyncronously by default."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defadvice!</span><span class="ef-ob"> org-babel-get-src-block-info-eager-async-a (orig-fn </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> light datum)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Eagarly add an :async parameter to the src information, unless it seems problematic.
This only acts o languages in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">org-babel-auto-async-languages</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.
Not added when either:
+ session is not \"none\"
+ :sync is set"</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:around</span><span class="ef-ob"> #'org-babel-get-src-block-info
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((result (funcall orig-fn light datum)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (string= </span><span style="color: #50a14f; background-color: #e7e7e7;">"none"</span><span class="ef-ob"> (cdr (assoc </span><span style="color: #a626a4; background-color: #e7e7e7;">:session</span><span class="ef-ob"> (caddr result))))
               (member (car result) org-babel-auto-async-languages)
               (not (assoc </span><span style="color: #a626a4; background-color: #e7e7e7;">:async</span><span class="ef-ob"> (caddr result))) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">don't duplicate
</span><span class="ef-ob">               (not (assoc </span><span style="color: #a626a4; background-color: #e7e7e7;">:sync</span><span class="ef-ob"> (caddr result))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">push</span><span class="ef-ob"> '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:async</span><span class="ef-ob">) (caddr result)))
    result))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** ESS</span>

<span style="color: #84888b;">#+call: confpkg("Org ESS")</span>

We don't want <span style="color: #84888b;">~R~</span> evaluation to hang the editor, hence
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> ess-eval-visibly 'nowait)
</span><span class="ef-obe">#+end_src
</span>
Syntax highlighting is nice, so let's turn all of that on
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> ess-R-font-lock-keywords
      '((ess-R-fl-keyword:keywords . t)
        (ess-R-fl-keyword:constants . t)
        (ess-R-fl-keyword:modifiers . t)
        (ess-R-fl-keyword:fun-defs . t)
        (ess-R-fl-keyword:assign-ops . t)
        (ess-R-fl-keyword:%op% . t)
        (ess-fl-keyword:fun-calls . t)
        (ess-fl-keyword:numbers . t)
        (ess-fl-keyword:operators . t)
        (ess-fl-keyword:delimiters . t)
        (ess-fl-keyword:= . t)
        (ess-R-fl-keyword:F&amp;T . t)))
</span><span class="ef-obe">#+end_src
</span>
Lastly, in the event that I use <span style="color: #84888b;">=JAGS=</span>, it would be nice to be able to use <span style="color: #84888b;">=jags=</span> as
the language identifier, not <span style="color: #84888b;">=ess-jags=</span>.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> org
  (add-to-list '+org-babel-mode-alist '(jags . ess-jags)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** LaTeX</span>

<span style="color: #84888b;">#+call: confpkg()</span>

<span style="color: #4078f2; font-weight: 700;">[[xkcd:1301]]</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** To-be-implemented ideas</span>

- Paste image from clipboard
  + Determine first folder in <span style="color: #84888b;">~graphicspath~</span> if applicable
  + Ask for file name
  + Use <span style="color: #84888b;">~xclip~</span> to save file to graphics folder, or current directory (whichever applies)
<span class="ef-obb">  #+begin_src shell :eval no :tangle no
</span><span class="ef-ob">command -v xclip &gt;/dev/null 2&gt;&amp;1 || { </span><span style="color: #a626a4; background-color: #e7e7e7;">echo</span><span class="ef-ob"> &gt;&amp;1 </span><span style="color: #50a14f; background-color: #e7e7e7;">"no xclip"</span><span class="ef-ob">; </span><span style="color: #e45649; background-color: #e7e7e7;">exit</span><span class="ef-ob"> 1; }

</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob">
    xclip -selection clipboard -target image/png -o &gt;/dev/null 2&gt;&amp;1
</span><span style="color: #e45649; background-color: #e7e7e7;">then</span><span class="ef-ob">
    xclip -selection clipboard -target image/png -o &gt;$</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span><span class="ef-ob"> 2&gt;/dev/null
    </span><span style="color: #a626a4; background-color: #e7e7e7;">echo</span><span class="ef-ob"> $</span><span style="color: #6a1868; background-color: #e7e7e7;">1</span>
<span style="color: #e45649; background-color: #e7e7e7;">else</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">echo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"no image"</span>
<span style="color: #e45649; background-color: #e7e7e7;">fi</span>
<span class="ef-obe">  #+end_src
</span>  + Insert figure, with filled in details as a result (activate <span style="color: #84888b;">=yasnippet=</span> with
    filename as variable maybe?)

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Compilation</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> TeX-save-query nil
      TeX-show-compilation t
      TeX-command-extra-options </span><span style="color: #50a14f; background-color: #e7e7e7;">"-shell-escape"</span><span class="ef-ob">)
(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> latex
  (add-to-list 'TeX-command-list '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"XeLaTeX"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%`xelatex%(mode)%' %t"</span><span class="ef-ob"> TeX-run-TeX nil t)))
</span><span class="ef-obe">#+end_src
</span>
For viewing the PDF, I rather like the pdf-tools viewer. While auctex is trying
to be nice in recognising that I have some PDF viewing apps installed, I'd
rather not have it default to using them, so let's re-order the preferences.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> +latex-viewers '(pdf-tools evince zathura okular skim sumatrapdf))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Snippet helpers</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Template</span>

For use in the new-file template, let's set out a nice preamble we may want to use.
<span style="color: #84888b;">#+name: latex-nice-preamble</span>
<span class="ef-obb">#+begin_src latex :tangle no
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">pdfa,unicode=true,hidelinks</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">hyperref</span><span class="ef-ob">}

</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">dvipsnames,svgnames,table,hyperref</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">xcolor</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">renewcommand</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #a626a4; background-color: #e7e7e7;">UrlFont</span><span class="ef-ob">}{</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #a626a4; background-color: #e7e7e7;">ttfamily</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #a626a4; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #a626a4; background-color: #e7e7e7;">small</span><span class="ef-ob">}

</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">a-2b</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">pdfx</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% why not be archival
</span>
<span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">T1</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">fontenc</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">osf</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">newpxtext</span><span class="ef-ob">}  </span><span style="color: #84888b; background-color: #e7e7e7;">% Palatino
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">gillius</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">scale=0.9</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">sourcecodepro</span><span class="ef-ob">}

</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">mathtools</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">amssymb</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\\</span><span class="ef-ob">let</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\\</span><span class="ef-ob">Bbbk</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\\</span><span class="ef-ob">relax
</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">varbb</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">newpxmath</span><span class="ef-ob">}

</span><span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">[</span><span style="color: #6a1868; background-color: #e7e7e7;">activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000</span><span class="ef-ob">]{</span><span style="color: #a626a4; background-color: #e7e7e7;">microtype</span><span class="ef-ob">}
</span><span style="color: #84888b; background-color: #e7e7e7;">% </span><span style="color: #84888b; background-color: #e7e7e7;">microtype makes text look nicer
</span>
<span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">graphicx</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% include graphics
</span>
<span style="color: #84888b; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7; font-weight: 700;">\</span><span style="color: #e45649; background-color: #e7e7e7;">usepackage</span><span class="ef-ob">{</span><span style="color: #a626a4; background-color: #e7e7e7;">booktabs</span><span class="ef-ob">} </span><span style="color: #84888b; background-color: #e7e7e7;">% nice table rules
</span><span class="ef-obe">#+end_src
</span>Then let's bind the content to a function, and define some nice helpers.
<span class="ef-obb">#+begin_src emacs-lisp :noweb no-export
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> tec/yas-latex-template-preamble </span><span style="color: #50a14f; background-color: #e7e7e7;">"
&lt;&lt;latex-nice-preamble&gt;&gt;
"</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">tec/yas-latex-get-class-choice</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Prompt user for LaTeX class choice"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> tec/yas-latex-class-choice (completing-read </span><span style="color: #50a14f; background-color: #e7e7e7;">"Select document class: "</span><span class="ef-ob"> '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"article"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"scrartcl"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"bmc"</span><span class="ef-ob">))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">tec/yas-latex-preamble-if</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Based on class choice prompt for insertion of default preamble"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (equal tec/yas-latex-class-choice </span><span style="color: #50a14f; background-color: #e7e7e7;">"bmc"</span><span class="ef-ob">) 'nil
    (eq (read-char-choice </span><span style="color: #50a14f; background-color: #e7e7e7;">"Include default preamble? [Type y/n]"</span><span class="ef-ob"> '(?y ?n)) ?y)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** Deliminators</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> tex
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">tec/tex-last-delim-char</span><span class="ef-ob"> nil
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Last open delim expanded in a tex document"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">tec/tex-delim-dot-second</span><span class="ef-ob"> t
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"When the `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">tec/tex-last-delim-char</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' is . a second character (this) is prompted for"</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">tec/get-open-delim-char</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Exclusivly read next char to tec/tex-last-delim-char"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> tec/tex-delim-dot-second nil)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> tec/tex-last-delim-char (read-char-exclusive </span><span style="color: #50a14f; background-color: #e7e7e7;">"Opening deliminator, recognises: 9 ( [ { &lt; | ."</span><span class="ef-ob">))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (eql ?. tec/tex-last-delim-char)
      (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> tec/tex-delim-dot-second (read-char-exclusive </span><span style="color: #50a14f; background-color: #e7e7e7;">"Other deliminator, recognises: 0 9 (  ) [ ] { } &lt; &gt; |"</span><span class="ef-ob">))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">tec/tex-open-delim-from-char</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> open-char)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Find the associated opening delim as string"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> open-char (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> open-char (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (eql ?. tec/tex-last-delim-char)
                                          tec/tex-delim-dot-second
                                        tec/tex-last-delim-char)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> open-char
      (?\( </span><span style="color: #50a14f; background-color: #e7e7e7;">"("</span><span class="ef-ob">)
      (?9  </span><span style="color: #50a14f; background-color: #e7e7e7;">"("</span><span class="ef-ob">)
      (?\[ </span><span style="color: #50a14f; background-color: #e7e7e7;">"["</span><span class="ef-ob">)
      (?\{ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\{"</span><span class="ef-ob">)
      (?&lt;  </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;"</span><span class="ef-ob">)
      (?|  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> tec/tex-delim-dot-second </span><span style="color: #50a14f; background-color: #e7e7e7;">"."</span> <span style="color: #50a14f; background-color: #e7e7e7;">"|"</span><span class="ef-ob">))
      (_   </span><span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob">)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">tec/tex-close-delim-from-char</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> open-char)
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Find the associated closing delim as string"</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> tec/tex-delim-dot-second
        (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> tec/tex-delim-dot-second
          (?\) </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">)
          (?0  </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">)
          (?\] </span><span style="color: #50a14f; background-color: #e7e7e7;">"]"</span><span class="ef-ob">)
          (?\} </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\}"</span><span class="ef-ob">)
          (?\&gt; </span><span style="color: #50a14f; background-color: #e7e7e7;">"&gt;"</span><span class="ef-ob">)
          (?|  </span><span style="color: #50a14f; background-color: #e7e7e7;">"|"</span><span class="ef-ob">)
          (_   </span><span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob">))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> open-char tec/tex-last-delim-char)
        (?\( </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">)
        (?9  </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">)
        (?\[ </span><span style="color: #50a14f; background-color: #e7e7e7;">"]"</span><span class="ef-ob">)
        (?\{ </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\}"</span><span class="ef-ob">)
        (?&lt;  </span><span style="color: #50a14f; background-color: #e7e7e7;">"&gt;"</span><span class="ef-ob">)
        (?\) </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">)
        (?0  </span><span style="color: #50a14f; background-color: #e7e7e7;">")"</span><span class="ef-ob">)
        (?\] </span><span style="color: #50a14f; background-color: #e7e7e7;">"]"</span><span class="ef-ob">)
        (?\} </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\}"</span><span class="ef-ob">)
        (?\&gt; </span><span style="color: #50a14f; background-color: #e7e7e7;">"&gt;"</span><span class="ef-ob">)
        (?|  </span><span style="color: #50a14f; background-color: #e7e7e7;">"|"</span><span class="ef-ob">)
        (_   </span><span style="color: #50a14f; background-color: #e7e7e7;">"."</span><span class="ef-ob">))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">tec/tex-next-char-smart-close-delim</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> open-char)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> smartparens-mode)
         (eql (char-after) (</span><span style="color: #e45649; background-color: #e7e7e7;">pcase</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">or</span><span class="ef-ob"> open-char tec/tex-last-delim-char)
                             (?\( ?\))
                             (?\[ ?\])
                             (?{ ?})
                             (?&lt; ?&gt;)))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">tec/tex-delim-yas-expand</span><span class="ef-ob"> (</span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> open-char)
    (yas-expand-snippet (yas-lookup-snippet </span><span style="color: #50a14f; background-color: #e7e7e7;">"_deliminators"</span><span class="ef-ob"> 'latex-mode) (point) (+ (point) (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (tec/tex-next-char-smart-close-delim open-char) 2 1)))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Editor visuals</span>

Let's enhance <span style="color: #84888b;">~TeX-fold-math~</span> a bit
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> latex
  (setcar (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"⋆"</span><span class="ef-ob"> LaTeX-fold-math-spec-list) </span><span style="color: #50a14f; background-color: #e7e7e7;">"★"</span><span class="ef-ob">)) </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">make \star bigger
</span><span class="ef-ob">
(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> TeX-fold-math-spec-list
      `(</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">missing/better symbols
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"≤"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"le"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"≥"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ge"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"≠"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ne"</span><span class="ef-ob">))
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">convenience shorts -- these don't work nicely ATM
</span>        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">("‹" ("left"))
</span>        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">("›" ("right"))
</span>        <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">private macros
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ℝ"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"RR"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ℕ"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"NN"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ℤ"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ZZ"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ℚ"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"QQ"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ℂ"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"CC"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ℙ"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"PP"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ℍ"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"HH"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"𝔼"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"EE"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"𝑑"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"dd"</span><span class="ef-ob">))
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">known commands
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"phantom"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (num den) (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (TeX-string-single-token-p num) (TeX-string-single-token-p den))
                                (concat num </span><span style="color: #50a14f; background-color: #e7e7e7;">"／"</span><span class="ef-ob"> den)
                              (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"❪"</span><span class="ef-ob"> num </span><span style="color: #50a14f; background-color: #e7e7e7;">"／"</span><span class="ef-ob"> den </span><span style="color: #50a14f; background-color: #e7e7e7;">"❫"</span><span class="ef-ob">))) </span><span style="color: #986801; background-color: #e7e7e7;">(</span><span style="color: #986801; background-color: #e7e7e7;">"frac"</span><span style="color: #986801; background-color: #e7e7e7;">))</span><span class="ef-ob">
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (arg) (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"√"</span><span class="ef-ob"> (TeX-fold-parenthesize-as-necessary arg))) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"sqrt"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (arg) (concat </span><span style="color: #50a14f; background-color: #e7e7e7;">"⭡"</span><span class="ef-ob"> (TeX-fold-parenthesize-as-necessary arg))) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"vec"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"‘</span><span style="color: #b751b6; background-color: #e7e7e7;">{1}</span><span style="color: #50a14f; background-color: #e7e7e7;">’"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"text"</span><span class="ef-ob">))
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">private commands
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"|{1}|"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"abs"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"‖{1}‖"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"norm"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"⌊{1}⌋"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"floor"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"⌈{1}⌉"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ceil"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"⌊{1}⌉"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"round"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"𝑑{1}/𝑑{2}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"dv"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"∂{1}/∂{2}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"pdv"</span><span class="ef-ob">))
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">fancification
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"{1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mathrm"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word) (string-offset-roman-chars 119743 word)) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mathbf"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word) (string-offset-roman-chars 119951 word)) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mathcal"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word) (string-offset-roman-chars 120003 word)) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mathfrak"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word) (string-offset-roman-chars 120055 word)) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mathbb"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word) (string-offset-roman-chars 120159 word)) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mathsf"</span><span class="ef-ob">))
        (,(</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (word) (string-offset-roman-chars 120367 word)) (</span><span style="color: #50a14f; background-color: #e7e7e7;">"mathtt"</span><span class="ef-ob">))
        )
      TeX-fold-macro-spec-list
      '(
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">as the defaults
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[f]"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"footnote"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"marginpar"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[c]"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"cite"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[l]"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"label"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[r]"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"ref"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"pageref"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"eqref"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[i]"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"index"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"glossary"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"..."</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"dots"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"{1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"emph"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"textit"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"textsl"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"textmd"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"textrm"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"textsf"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"texttt"</span>
                <span style="color: #50a14f; background-color: #e7e7e7;">"textbf"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"textsc"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"textup"</span><span class="ef-ob">))
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">tweaked defaults
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"©"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"copyright"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"®"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"textregistered"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"™"</span><span class="ef-ob">  (</span><span style="color: #50a14f; background-color: #e7e7e7;">"texttrademark"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"[1]:||►"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"item"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"❡❡ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"part"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"part*"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"❡ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"chapter"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"chapter*"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"§ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"section"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"section*"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"§§ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"subsection"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"subsection*"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"§§§ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"subsubsection"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"subsubsection*"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"¶ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"paragraph"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"paragraph*"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"¶¶ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"subparagraph"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"subparagraph*"</span><span class="ef-ob">))
        </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">extra
</span><span class="ef-ob">        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"⬖ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"begin"</span><span class="ef-ob">))
        (</span><span style="color: #50a14f; background-color: #e7e7e7;">"⬗ {1}"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"end"</span><span class="ef-ob">))
        ))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">string-offset-roman-chars</span><span class="ef-ob"> (offset word)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Shift the codepoint of each character in WORD by OFFSET with an extra -6 shift if the letter is lowercase"</span><span class="ef-ob">
  (apply 'string
         (mapcar (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> (c)
                   (string-offset-apply-roman-char-exceptions
                    (+ (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (&gt;= c 97) (- c 6) c) offset)))
                 word)))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defvar</span> <span style="color: #6a1868; background-color: #e7e7e7;">string-offset-roman-char-exceptions</span><span class="ef-ob">
  '(</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">lowercase serif
</span><span class="ef-ob">    (119892 .  8462) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℎ
</span>    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">lowercase caligraphic
</span><span class="ef-ob">    (119994 . 8495) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℯ
</span><span class="ef-ob">    (119996 . 8458) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℊ
</span><span class="ef-ob">    (120004 . 8500) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℴ
</span>    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">caligraphic
</span><span class="ef-ob">    (119965 . 8492) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℬ
</span><span class="ef-ob">    (119968 . 8496) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℰ
</span><span class="ef-ob">    (119969 . 8497) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℱ
</span><span class="ef-ob">    (119971 . 8459) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℋ
</span><span class="ef-ob">    (119972 . 8464) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℐ
</span><span class="ef-ob">    (119975 . 8466) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℒ
</span><span class="ef-ob">    (119976 . 8499) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℳ
</span><span class="ef-ob">    (119981 . 8475) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℛ
</span>    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">fraktur
</span><span class="ef-ob">    (120070 . 8493) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℭ
</span><span class="ef-ob">    (120075 . 8460) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℌ
</span><span class="ef-ob">    (120076 . 8465) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℑ
</span><span class="ef-ob">    (120085 . 8476) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℜ
</span><span class="ef-ob">    (120092 . 8488) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℨ
</span>    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">blackboard
</span><span class="ef-ob">    (120122 . 8450) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℂ
</span><span class="ef-ob">    (120127 . 8461) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℍ
</span><span class="ef-ob">    (120133 . 8469) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℕ
</span><span class="ef-ob">    (120135 . 8473) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℙ
</span><span class="ef-ob">    (120136 . 8474) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℚ
</span><span class="ef-ob">    (120137 . 8477) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℝ
</span><span class="ef-ob">    (120145 . 8484) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">ℤ
</span><span class="ef-ob">    )
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"An alist of deceptive codepoints, and then where the glyph actually resides."</span><span class="ef-ob">)

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">string-offset-apply-roman-char-exceptions</span><span class="ef-ob"> (char)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Sometimes the codepoint doesn't contain the char you expect.
Such special cases should be remapped to another value, as given in `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">string-offset-roman-char-exceptions</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (assoc char string-offset-roman-char-exceptions)
      (cdr (assoc char string-offset-roman-char-exceptions))
    char))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">TeX-fold-parenthesize-as-necessary</span><span class="ef-ob"> (tokens </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> suppress-left suppress-right)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Add ❪ ❫ parenthesis as if multiple LaTeX tokens appear to be present"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (TeX-string-single-token-p tokens) tokens
    (concat (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> suppress-left </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span> <span style="color: #50a14f; background-color: #e7e7e7;">"❪"</span><span class="ef-ob">)
            tokens
            (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> suppress-right </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span> <span style="color: #50a14f; background-color: #e7e7e7;">"❫"</span><span class="ef-ob">))))

(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">TeX-string-single-token-p</span><span class="ef-ob"> (teststring)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Return t if TESTSTRING appears to be a single token, nil otherwise"</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"^\\\\?\\w+$"</span><span class="ef-ob"> teststring) t nil))
</span><span class="ef-obe">#+end_src
</span>
Some local keybindings to make life a bit easier
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> tex
  (map!
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> LaTeX-mode-map
   </span><span style="color: #a626a4; background-color: #e7e7e7;">:ei</span><span class="ef-ob"> [C-return] #'LaTeX-insert-item)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> TeX-electric-math '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> . </span><span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
Maths deliminators can be de-emphasised a bit
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Making \( \) less visible
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defface</span> <span style="color: #6a1868; background-color: #e7e7e7;">unimportant-latex-face</span><span class="ef-ob">
  '((t </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> font-lock-comment-face </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> extra-light))
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Face used to make \\(\\), \\[</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">\\</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">] less visible."</span>
  <span style="color: #a626a4; background-color: #e7e7e7;">:group</span><span class="ef-ob"> 'LaTeX-math)

(font-lock-add-keywords
 'latex-mode
 `((</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\\\[]()[]"</span><span class="ef-ob"> 0 'unimportant-latex-face prepend))
 'end)

</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(font-lock-add-keywords
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">'latex-mode
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">'(("\\\\[[:word:]]+" 0 'font-lock-keyword-face prepend))
</span><span style="color: #84888b; background-color: #e7e7e7;">;;  </span><span style="color: #84888b; background-color: #e7e7e7;">'end)
</span><span class="ef-obe">#+end_src
</span>
And enable shell escape for the preview
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> preview-LaTeX-command '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"%`%l \"\\nonstopmode\\nofiles\
\\PassOptionsToPackage{"</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">","</span><span class="ef-ob"> . preview-required-option-list) </span><span style="color: #50a14f; background-color: #e7e7e7;">"}{preview}\
\\AtBeginDocument{\\ifx\\ifPreview\\undefined"</span><span class="ef-ob">
preview-default-preamble </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\fi}\"%' \"\\detokenize{\" %t \"}\""</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Math input</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** CDLaTeX</span>

The symbols and modifies are very nice by default, but could do with a bit of
fleshing out. Let's change the prefix to a key which is similarly rarely used,
but more convenient, like <span style="color: #84888b;">=;=</span>.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> cdlatex
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> cdlatex-env-alist
        '((</span><span style="color: #50a14f; background-color: #e7e7e7;">"bmatrix"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\begin{bmatrix}\n?\n\\end{bmatrix}"</span><span class="ef-ob"> nil)
          (</span><span style="color: #50a14f; background-color: #e7e7e7;">"equation*"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\begin{equation*}\n?\n\\end{equation*}"</span><span class="ef-ob"> nil)))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span> <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">cdlatex-math-symbol-prefix ?\; ;; doesn't work at the moment :(
</span><span class="ef-ob">   cdlatex-math-symbol-alist
   '( </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">adding missing functions to 3rd level symbols
</span><span class="ef-ob">     (?_    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\downarrow"</span>  <span style="color: #50a14f; background-color: #e7e7e7;">""</span>           <span style="color: #50a14f; background-color: #e7e7e7;">"\\inf"</span><span class="ef-ob">))
     (?2    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"^2"</span>           <span style="color: #50a14f; background-color: #e7e7e7;">"\\sqrt{?}"</span>     <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">     ))
     (?3    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"^3"</span>           <span style="color: #50a14f; background-color: #e7e7e7;">"\\sqrt[3]{?}"</span>  <span style="color: #50a14f; background-color: #e7e7e7;">""</span><span class="ef-ob">     ))
     (?^    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\uparrow"</span>    <span style="color: #50a14f; background-color: #e7e7e7;">""</span>           <span style="color: #50a14f; background-color: #e7e7e7;">"\\sup"</span><span class="ef-ob">))
     (?k    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\kappa"</span>      <span style="color: #50a14f; background-color: #e7e7e7;">""</span>           <span style="color: #50a14f; background-color: #e7e7e7;">"\\ker"</span><span class="ef-ob">))
     (?m    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\mu"</span>         <span style="color: #50a14f; background-color: #e7e7e7;">""</span>           <span style="color: #50a14f; background-color: #e7e7e7;">"\\lim"</span><span class="ef-ob">))
     (?c    (</span><span style="color: #50a14f; background-color: #e7e7e7;">""</span>             <span style="color: #50a14f; background-color: #e7e7e7;">"\\circ"</span>     <span style="color: #50a14f; background-color: #e7e7e7;">"\\cos"</span><span class="ef-ob">))
     (?d    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\delta"</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"\\partial"</span>  <span style="color: #50a14f; background-color: #e7e7e7;">"\\dim"</span><span class="ef-ob">))
     (?D    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\Delta"</span>      <span style="color: #50a14f; background-color: #e7e7e7;">"\\nabla"</span>    <span style="color: #50a14f; background-color: #e7e7e7;">"\\deg"</span><span class="ef-ob">))
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">no idea why \Phi isnt on '</span><span style="color: #b751b6; background-color: #e7e7e7;">F</span><span style="color: #84888b; background-color: #e7e7e7;">' in first place, \phi is on '</span><span style="color: #b751b6; background-color: #e7e7e7;">f</span><span style="color: #84888b; background-color: #e7e7e7;">'.
</span><span class="ef-ob">     (?F    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\Phi"</span><span class="ef-ob">))
     </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">now just convenience
</span><span class="ef-ob">     (?.    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\cdot"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\dots"</span><span class="ef-ob">))
     (?:    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\vdots"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\ddots"</span><span class="ef-ob">))
     (?*    (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\times"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\star"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"\\ast"</span><span class="ef-ob">)))
   cdlatex-math-modify-alist
   '( </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">my own stuff
</span><span class="ef-ob">     (?B    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\mathbb"</span><span class="ef-ob">        nil          t    nil  nil)
     (?a    </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\abs"</span><span class="ef-ob">           nil          t    nil  nil))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #6f99f5; font-weight: 600; font-size: 1.09em">**** LAAS</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg LAAS")</span>

This makes use of <span style="color: #84888b;">=aas=</span> (<span style="text-decoration: italic;">/Auto Activating Snippets/</span>) for CDLaTeX-like symbol input.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> laas </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/LaTeX-auto-activating-snippets"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! laas
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:hook</span><span class="ef-ob"> (LaTeX-mode . laas-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">laas-tex-fold-maybe</span><span class="ef-ob"> ()
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (equal </span><span style="color: #50a14f; background-color: #e7e7e7;">"/"</span><span class="ef-ob"> aas-transient-snippet-key)
      (+latex-fold-last-macro-a)))
  (add-hook 'aas-post-snippet-expand-hook #'laas-tex-fold-maybe))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** SyncTeX</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> tex
  (add-to-list 'TeX-view-program-list '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"Evince"</span> <span style="color: #50a14f; background-color: #e7e7e7;">"evince %o"</span><span class="ef-ob">))
  (add-to-list 'TeX-view-program-selection '(output-pdf </span><span style="color: #50a14f; background-color: #e7e7e7;">"Evince"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Fixes</span>

In case of Emacs28:

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (&gt;= emacs-major-version 28)
  (add-hook 'latex-mode-hook #'TeX-latex-mode))
</span><span class="ef-obe">#+end_src
</span>
With Emacs 29.4

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (= emacs-major-version 29) (= emacs-minor-version 4))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> auctex </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">See &lt;https://github.com/minad/vertico/discussions/475&gt;
</span><span class="ef-ob">    (fmakunbound 'ConTeXt-mode)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Python</span>

Since I'm using <span style="color: #84888b;">=mypyls=</span>, as suggested in <span style="color: #4078f2; font-weight: 700;">[[file:~/.config/emacs/modules/lang/python/README.org::*Language Server Protocol Support][:lang python LSP support]]</span> I'll tweak the
priority of <span style="color: #84888b;">=mypyls=</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> lsp-python-ms
  (set-lsp-priority! 'mspyls 1))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** PDF</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** MuPDF</span>

<span style="color: #84888b;">=pdf-tools=</span> is nice, but a <span style="color: #84888b;">=mupdf=</span>-based solution is nicer.

<span class="ef-obb">#+begin_src emacs-lisp :tangle no
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> paper </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ymarco/paper-mode"</span>
                         <span style="color: #a626a4; background-color: #e7e7e7;">:files</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"*.el"</span> <span style="color: #50a14f; background-color: #e7e7e7;">".so"</span><span class="ef-ob">)
                         </span><span style="color: #a626a4; background-color: #e7e7e7;">:pre-build</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"make"</span><span class="ef-ob">)))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">(use-package paper
</span><span style="color: #84888b; background-color: #e7e7e7;">;;   </span><span style="color: #84888b; background-color: #e7e7e7;">;; :mode ("\\.pdf\\'"  . paper-mode)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;   </span><span style="color: #84888b; background-color: #e7e7e7;">;; :mode ("\\.epub\\'"  . paper-mode)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;   </span><span style="color: #84888b; background-color: #e7e7e7;">:config
</span><span style="color: #84888b; background-color: #e7e7e7;">;;   </span><span style="color: #84888b; background-color: #e7e7e7;">(require 'evil-collection-paper)
</span><span style="color: #84888b; background-color: #e7e7e7;">;;   </span><span style="color: #84888b; background-color: #e7e7e7;">(evil-collection-paper-setup))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Terminal viewing</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg pdftotext", needs="pdftotext")</span>

Sometimes I'm in a terminal and I still want to see the content. Additionally,
sometimes I'd like to act on the textual content and so would like a plaintext version.
Thanks to <span style="color: #84888b; background-color: #e7e7e7;">src_</span><span style="color: #84888b; background-color: #e7e7e7;">shell</span><span style="color: #84888b; background-color: #e7e7e7;">{</span><span class="ef-ob">pdftotext</span><span style="color: #84888b; background-color: #e7e7e7;">}</span> we have a convenient way of performing this conversion.
I've integrated this into a little package, <span style="color: #84888b;">=pdftotext.el=</span>.
<span class="ef-obb">#+begin_src emacs-lisp :tangle (if (executable-find "pdftotext") "packages.el" "no")
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> pdftotext </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/pdftotext"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
The output can be slightly nicer without spelling errors, and with prettier page
feeds (<span style="color: #84888b;">=^L=</span> by default).

This is very nice, now we just need to associate it with <span style="color: #84888b;">=.pdf=</span> files, and make
sure <span style="color: #84888b;">=pdf-tools=</span> doesn't take priority.

Lastly, whenever Emacs is non-graphical (i.e. a TUI), we want to use this by default.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! pdftotext
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (display-graphic-p)
    (add-to-list 'auto-mode-alist '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.[pP][dD][fF]\\'"</span><span class="ef-ob"> . pdftotext-mode))
    (add-to-list 'magic-mode-alist '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"%PDF"</span><span class="ef-ob"> . pdftotext-mode)))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">unless</span><span class="ef-ob"> (display-graphic-p) (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> pdf-tools (pdftotext-install)))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">For prettyness
</span><span class="ef-ob">  (add-hook 'pdftotext-mode-hook #'spell-fu-mode-disable)
  (add-hook 'pdftotext-mode-hook (</span><span style="color: #e45649; background-color: #e7e7e7;">lambda</span><span class="ef-ob"> () (page-break-lines-mode 1)))
  </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">I have no idea why this is needed
</span><span class="ef-ob">  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> pdftotext-mode-map
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;mouse-4&gt;"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (scroll-down mouse-wheel-scroll-amount-horizontal))
        </span><span style="color: #50a14f; background-color: #e7e7e7;">"&lt;mouse-5&gt;"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (scroll-up mouse-wheel-scroll-amount-horizontal))))

</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** R</span>

<span style="color: #84888b;">#+call: confpkg("R lang")</span>

<span style="color: #b751b6; font-weight: 700; font-size: 1.12em">*** Editor Visuals</span>

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> ess-r-mode
  (</span><span style="color: #e45649; background-color: #e7e7e7;">appendq!</span><span class="ef-ob"> +ligatures-extra-symbols
            '(</span><span style="color: #a626a4; background-color: #e7e7e7;">:assign</span> <span style="color: #50a14f; background-color: #e7e7e7;">"⟵"</span>
              <span style="color: #a626a4; background-color: #e7e7e7;">:multiply</span> <span style="color: #50a14f; background-color: #e7e7e7;">"×"</span><span class="ef-ob">))
  (set-ligatures! 'ess-r-mode
    </span><span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Functional
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">:def</span> <span style="color: #50a14f; background-color: #e7e7e7;">"function"</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Types
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">:null</span> <span style="color: #50a14f; background-color: #e7e7e7;">"NULL"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:true</span> <span style="color: #50a14f; background-color: #e7e7e7;">"TRUE"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:false</span> <span style="color: #50a14f; background-color: #e7e7e7;">"FALSE"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:int</span> <span style="color: #50a14f; background-color: #e7e7e7;">"int"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:floar</span> <span style="color: #50a14f; background-color: #e7e7e7;">"float"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:bool</span> <span style="color: #50a14f; background-color: #e7e7e7;">"bool"</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Flow
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">:not</span> <span style="color: #50a14f; background-color: #e7e7e7;">"!"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:and</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&amp;&amp;"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:or</span> <span style="color: #50a14f; background-color: #e7e7e7;">"||"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:for</span> <span style="color: #50a14f; background-color: #e7e7e7;">"for"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:in</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%in%"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:return</span> <span style="color: #50a14f; background-color: #e7e7e7;">"return"</span>
    <span style="color: #84888b; background-color: #e7e7e7;">;; </span><span style="color: #84888b; background-color: #e7e7e7;">Other
</span>    <span style="color: #a626a4; background-color: #e7e7e7;">:assign</span> <span style="color: #50a14f; background-color: #e7e7e7;">"&lt;-"</span>
    <span style="color: #a626a4; background-color: #e7e7e7;">:multiply</span> <span style="color: #50a14f; background-color: #e7e7e7;">"%*%"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Julia</span>

<span style="color: #84888b;">#+call: confpkg(after="julia-mode")</span>

It would be nice if <span style="color: #84888b;">=julia-mode=</span> also highlighted the <span style="color: #84888b;">=julia&gt;=</span> prompt when writing
REPL examples.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-to-list
 'julia-font-lock-keywords
 '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"^julia&gt;"</span><span class="ef-ob"> 0 '(font-lock-string-face bold) prepend))
</span><span class="ef-obe">#+end_src
</span>
As mentioned in <span style="color: #4078f2; font-weight: 700;">[[https://github.com/non-Jedi/lsp-julia/issues/35][lsp-julia#35]]</span>, <span style="color: #84888b;">=lsp-mode=</span> seems to serve an invalid response to the
Julia server. The pseudo-fix is rather simple at least
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-hook 'julia-mode-hook #'rainbow-delimiters-mode-enable)
(</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> 'julia-mode-hook
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq-local</span><span class="ef-ob"> lsp-enable-folding t
              lsp-folding-range-limit 100))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Data.toml files</span>

<span style="color: #84888b;">#+call: confpkg("conf-data-toml")</span>

For <span style="color: #84888b;">=DataToolkit.jl=</span>-formatted TOML files, I've made a major mode.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> conf-data-toml </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:local-repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"lisp/conf-data-toml"</span><span class="ef-ob">))
</span><span class="ef-obe">#+end_src
</span>
Since the major mode is autoloaded, all we need to do is register an appropriate
magic command for it to be used in <span style="color: #84888b;">=Data.toml=</span> files.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! conf-data-toml
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:magic</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`data_config_version = [0-9]"</span><span class="ef-ob"> . conf-data-toml-mode))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Graphviz</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg graphviz-dot-mode")</span>

Graphviz is a nice method of visualising simple graphs, based on plaintext
<span style="color: #84888b;">=.dot=</span> / <span style="color: #84888b;">=.gv=</span> files.
<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> graphviz-dot-mode </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"8ff793b13707cb511875f56e167ff7f980a31136"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! graphviz-dot-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:commands</span><span class="ef-ob"> graphviz-dot-mode
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:mode</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.dot\\'"</span><span class="ef-ob"> . graphviz-dot-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> org
    (setcdr (assoc </span><span style="color: #50a14f; background-color: #e7e7e7;">"dot"</span><span class="ef-ob"> org-src-lang-modes)
            'graphviz-dot)))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Markdown</span>

<span style="color: #84888b;">#+call: confpkg()</span>

Most of the time when I write markdown, it's going into some app/website which
will do it's own line wrapping, hence we <span style="text-decoration: italic;">/only/</span> want to use visual line wrapping. No hard stuff.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">add-hook!</span><span class="ef-ob"> (gfm-mode markdown-mode) #'visual-line-mode #'turn-off-auto-fill)
</span><span class="ef-obe">#+end_src
</span>
Since markdown is often seen as rendered HTML, let's try to somewhat mirror the
style or markdown renderers.

Most markdown renders seem to make the first three headings levels larger than
normal text, the first two much so. Then the fourth level tends to be the same
as body text, while the fifth and sixth are (increasingly) smaller, with the
sixth greyed out. Since the sixth level is so small, I'll turn up the boldness a notch.
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(custom-set-faces!
  '(markdown-header-face-1 </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.25 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> extra-bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> markdown-header-face)
  '(markdown-header-face-2 </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.15 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> bold       </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> markdown-header-face)
  '(markdown-header-face-3 </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.08 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> bold       </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> markdown-header-face)
  '(markdown-header-face-4 </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 1.00 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> bold       </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> markdown-header-face)
  '(markdown-header-face-5 </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 0.90 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> bold       </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> markdown-header-face)
  '(markdown-header-face-6 </span><span style="color: #a626a4; background-color: #e7e7e7;">:height</span><span class="ef-ob"> 0.75 </span><span style="color: #a626a4; background-color: #e7e7e7;">:weight</span><span class="ef-ob"> extra-bold </span><span style="color: #a626a4; background-color: #e7e7e7;">:inherit</span><span class="ef-ob"> markdown-header-face))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** Beancount</span>

<span style="color: #84888b;">#+call: confpkg("!Pkg Beancount")</span>

There are a number of rather compelling advantages to <span style="color: #4078f2; font-weight: 700;">[[https://plaintextaccounting.org/][plain text accounting]]</span>,
with <span style="color: #4078f2; font-weight: 700;">[[https://www.ledger-cli.org/][ledger]]</span> being the most obvious example. However, <span style="color: #4078f2; font-weight: 700;">[[https://github.com/beancount/beancount][beancount]]</span>, a more recent
implementation of the idea is ledger-compatible (meaning I can switch easily if
I change my mind) and has a gorgeous front-end --- <span style="color: #4078f2; font-weight: 700;">[[https://beancount.github.io/fava/][fava]]</span>.

Of course, there's an Emacs mode for this.

<span class="ef-obb">#+begin_src emacs-lisp :tangle packages.el
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">package!</span><span class="ef-ob"> beancount </span><span style="color: #a626a4; background-color: #e7e7e7;">:recipe</span><span class="ef-ob"> (</span><span style="color: #a626a4; background-color: #e7e7e7;">:host</span><span class="ef-ob"> github </span><span style="color: #a626a4; background-color: #e7e7e7;">:repo</span> <span style="color: #50a14f; background-color: #e7e7e7;">"beancount/beancount-mode"</span><span class="ef-ob">)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:pin</span> <span style="color: #50a14f; background-color: #e7e7e7;">"ddd4b8725703cf17a665b56cc26a3f9f95642424"</span><span class="ef-ob">)
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(use-package! beancount
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:mode</span><span class="ef-ob"> (</span><span style="color: #50a14f; background-color: #e7e7e7;">"\\.beancount\\'"</span><span class="ef-ob"> . beancount-mode)
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:init</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">after!</span><span class="ef-ob"> nerd-icons
    (add-to-list 'nerd-icons-extension-icon-alist
                 '(</span><span style="color: #50a14f; background-color: #e7e7e7;">"beancount"</span><span class="ef-ob"> nerd-icons-faicon </span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-dollar"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> nerd-icons-lblue))
    (add-to-list 'nerd-icons-mode-icon-alist
                 '(beancount-mode nerd-icons-faicon </span><span style="color: #50a14f; background-color: #e7e7e7;">"nf-fa-dollar"</span> <span style="color: #a626a4; background-color: #e7e7e7;">:face</span><span class="ef-ob"> nerd-icons-lblue)))
  </span><span style="color: #a626a4; background-color: #e7e7e7;">:config</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">setq</span><span class="ef-ob"> beancount-electric-currency t)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">beancount-bal</span><span class="ef-ob"> ()
    </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Run bean-report bal."</span><span class="ef-ob">
    (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((compilation-read-command nil))
      (beancount--run </span><span style="color: #50a14f; background-color: #e7e7e7;">"bean-report"</span><span class="ef-ob">
                      (file-relative-name buffer-file-name) </span><span style="color: #50a14f; background-color: #e7e7e7;">"bal"</span><span class="ef-ob">)))
  (map! </span><span style="color: #a626a4; background-color: #e7e7e7;">:map</span><span class="ef-ob"> beancount-mode-map
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:n</span> <span style="color: #50a14f; background-color: #e7e7e7;">"TAB"</span><span class="ef-ob"> #'beancount-align-to-previous-number
        </span><span style="color: #a626a4; background-color: #e7e7e7;">:i</span> <span style="color: #50a14f; background-color: #e7e7e7;">"RET"</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">cmd!</span><span class="ef-ob"> (newline-and-indent) (beancount-align-to-previous-number))))
</span><span class="ef-obe">#+end_src
</span>
<span style="color: #da8548; font-weight: 700; font-size: 1.15em">** GIMP Palette files</span>

<span style="color: #84888b;">#+call: confpkg("gimp-palette")</span>

I like using colour schemes with Inkscape, and it uses "GIMP Palette" colour
scheme definition files. It's easy to edit them by hand, but often a bit annoying
as you need to keep the RGB code and hex representation in sync. Let's make that
a little easier by writing a little major mode for it.

The major mode doesn't need to do much, just try to turn <span style="color: #84888b;">~rainbow-mode~</span> on for
 pretty hex colours, turn off <span style="color: #84888b;">~hl-line-mode~</span> (if required) so the <span style="color: #84888b;">=hl-line=</span> face
 doesn't overshadow them, and then the most crucial part: syncing the RGB/hex
 colour specifications on every buffer modification.

To catch all relevant modifications, but not trigger more frequently than needed
(as would happen if using <span style="color: #84888b;">~post-command-hook~</span>, for example),
<span style="color: #84888b;">~after-change-functions~</span> is the perfect option. We can make a buffer-local
addition that will sync all colours in the modified region.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">define-derived-mode</span> <span style="color: #a626a4; background-color: #e7e7e7;">gimp-palette-mode</span><span class="ef-ob"> fundamental-mode </span><span style="color: #50a14f; background-color: #e7e7e7;">"GIMP Palette"</span>
  <span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"A major mode for GIMP Palette (.gpl) files that keeps RGB and Hex colors in sync."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">require</span><span class="ef-ob"> '</span><span style="color: #b751b6; background-color: #e7e7e7;">rainbow-mode</span><span class="ef-ob">)
    (rainbow-mode 1))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">bound-and-true-p</span><span class="ef-ob"> hl-line-mode)
    (hl-line-mode -1))
  (add-hook 'after-change-functions #'gimp-palette-update-region nil t))
</span><span class="ef-obe">#+end_src
</span>
Now we need to implement the <span style="color: #84888b;">~gimp-palette-update-region~</span> function. If we plan on
implementing a per-line update function, this is simply a matter of calling it
on each line with a few quality of life improvements:
+ Batching all the changes into a single undo step (via <span style="color: #84888b;">~undo-amalgamate-change-group~</span>)
+ Working interactively with a selected region, or the whole buffer.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">gimp-palette-update-region</span><span class="ef-ob"> (beg end </span><span style="color: #986801; background-color: #e7e7e7;">&amp;optional</span><span class="ef-ob"> _)
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Update each line between BEG and END with `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">gimp-palette-update-line</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">'.
If run interactively without a region set, the whole buffer is affected."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">
   (</span><span style="color: #e45649; background-color: #e7e7e7;">if</span><span class="ef-ob"> (region-active-p)
       (list (region-beginning) (region-end))
     (list (point-min) (point-max))))
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((marker (prepare-change-group)))
    (</span><span style="color: #e45649; background-color: #e7e7e7;">unwind-protect</span><span class="ef-ob">
        (</span><span style="color: #e45649; background-color: #e7e7e7;">save-excursion</span><span class="ef-ob">
          (goto-char beg)
          (</span><span style="color: #e45649; background-color: #e7e7e7;">while</span><span class="ef-ob"> (&lt; (point) end)
            (gimp-palette-update-line)
            (forward-line 1)))
      (undo-amalgamate-change-group marker))))
</span><span class="ef-obe">#+end_src
</span>
Now we need to implement the per-line update function. This won't be a
particularly short function, but it isn't complicated either. It should work as
follows:
1. Check to see whether the line starts with <span style="color: #84888b;">=R G B #HEX=</span> 
2. Check that <span style="color: #84888b;">~point~</span> is within the RGB/hex part of the linen
3. If on the hex part, parse the hex string and update the RGB to match
   (inserting the RGB component if it does not already exist)
4. If on the RGB part, update the hex part to match

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(</span><span style="color: #e45649; background-color: #e7e7e7;">defun</span> <span style="color: #a626a4; background-color: #e7e7e7;">gimp-palette-update-line</span><span class="ef-ob"> ()
  </span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">"Update the RGB and Hex colour codes on the current line.
Whichever `</span><span style="color: #b751b6; background-color: #e7e7e7; text-decoration: italic;">point</span><span style="color: #727578; background-color: #e7e7e7; text-decoration: italic;">' is currently on is taken as the source of truth."</span><span class="ef-ob">
  (</span><span style="color: #e45649; background-color: #e7e7e7;">interactive</span><span class="ef-ob">)
  (</span><span style="color: #e45649; background-color: #e7e7e7;">let</span><span class="ef-ob"> ((column (current-column))
        (ipoint (point)))
    (beginning-of-line)
    (</span><span style="color: #e45649; background-color: #e7e7e7;">when</span><span class="ef-ob"> (</span><span style="color: #e45649; background-color: #e7e7e7;">and</span><span class="ef-ob"> (re-search-forward </span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span style="color: #a626a4; background-color: #e7e7e7;">\\=</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">[0-9 ]*</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">(</span><span style="color: #50a14f; background-color: #e7e7e7;">#[0-9A-Fa-f]\\{</span><span style="color: #6a1868; background-color: #e7e7e7;">6\\</span><span style="color: #50a14f; background-color: #e7e7e7;">}</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">\\</span><span style="color: #4078f2; background-color: #e7e7e7; font-weight: 700;">)</span><span style="color: #50a14f; background-color: #e7e7e7;">"</span><span class="ef-ob"> nil t)
               (&lt;= column (length (match-string 0))))
      (</span><span style="color: #e45649; background-color: #e7e7e7;">cond</span><span class="ef-ob">
       ((&gt;= column (length (match-string 1))) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Point in #HEX
</span><span class="ef-ob">        (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-destructuring-bind</span><span class="ef-ob"> (r g b) (color-name-to-rgb (match-string 2))
          (replace-match
           (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%3d %3d %3d "</span><span class="ef-ob">
                   (round (* 255 r))
                   (round (* 255 g))
                   (round (* 255 b)))
           nil t nil 1)))
       ((string-match-p </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`[0-9]+ +[0-9]+ +[0-9]+\\'"</span><span class="ef-ob"> (match-string 1)) </span><span style="color: #84888b; background-color: #e7e7e7;">; </span><span style="color: #84888b; background-color: #e7e7e7;">Valid R G B
</span><span class="ef-ob">        (</span><span style="color: #e45649; background-color: #e7e7e7;">cl-destructuring-bind</span><span class="ef-ob"> (r g b)
            (mapcar #'string-to-number
                    (</span><span style="color: #e45649; background-color: #e7e7e7;">save-match-data</span><span class="ef-ob">
                      (split-string (match-string 1) </span><span style="color: #50a14f; background-color: #e7e7e7;">" +"</span><span class="ef-ob"> t)))
          (replace-match
           (format </span><span style="color: #50a14f; background-color: #e7e7e7;">"%3d %3d %3d "</span><span class="ef-ob"> r g b)
           nil t nil 1)
          (replace-match
           (color-rgb-to-hex (/ r 255.0) (/ g 255.0) (/ b 255.0) 2)
           nil t nil 2)))))
    (goto-char ipoint)))
</span><span class="ef-obe">#+end_src
</span>   
The last thing that's needed to make this functionality convenient is to have it
automatically activate when appropriate. GIMP palette files re-use the <span style="color: #84888b;">=.gpl=</span>
extension, so <span style="color: #84888b;">~auto-mode-alist~</span> isn't a good choice, but we can use the
<span style="color: #84888b;">~magic-mode-alist~</span> to use this mode in any file that begins with <span style="color: #84888b;">=GIMP Palette=</span>,
which is perfect for our needs.

<span class="ef-obb">#+begin_src emacs-lisp
</span><span class="ef-ob">(add-to-list 'magic-mode-alist (cons </span><span style="color: #50a14f; background-color: #e7e7e7;">"\\`GIMP Palette\n"</span><span class="ef-ob"> #'gimp-palette-mode))
</span><span class="ef-obe">#+end_src
</span>
<span class="ef-c"># Local Variables:</span>
<span class="ef-c"># jinx-local-words: "confpkg confpkgs smartparens tempbuffer"</span>
<span class="ef-c"># End:</span>

</pre>
  <body>
</html>