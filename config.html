<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-06-14 Sat 10:35 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doom Emacs Configuration</title>
<meta name="author" content="tecosaur" />
<meta name="generator" content="org mode" />
<meta name="theme-color" content="#77aa99" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Doom Emacs Configuration" />
<meta property="og:description" content="The Methods, Management, and Menagerie of Madness" />
<meta property="og:image" content="https://tecosaur.com/resources/org/nib.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="200" />
<meta property="og:image:height" content="200" />
<meta property="og:image:alt" content="Green fountain pen nib" />
<meta property="og:article:published_time" content="2025-06-09T00:00:00+0000" />
<meta property="og:article:modified_time" content="2025-06-14T10:21:12+0000" />
<link rel="icon" href="https://tecosaur.com/resources/org/nib.ico" type="image/ico" />

<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/etbookot-roman-webfont.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/etbookot-italic-webfont.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/Merriweather-TextRegular.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/Merriweather-TextItalic.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/Merriweather-TextBold.woff2">
<script>
// @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
function copyPreToClipbord(btn) {
    const pre = btn.parentElement.parentElement.getElementsByTagName("PRE")[0];
    const range = document.createRange();
    range.selectNodeContents(pre);
    range.setEnd(pre.childNodes[pre.childNodes.length-1], 0);
    window.getSelection().addRange(range);
    var successful = document.execCommand('copy');
    window.getSelection().removeRange(range);
}
window.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById("text-table-of-contents")) {
        const sections = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        const activate = (entry) => {
            entry.classList.add('active');
            if (["LI", "UL"].includes(entry.parentElement.tagName)) {
                activate(entry.parentElement);
            }
        };
        const activateLast = () => {
            document.querySelectorAll('#text-table-of-contents li.active, #text-table-of-contents ul.active').forEach(a => {
                a.classList.remove('active')
            });
            let mostRecent = { section: sections[0], bottom: -Infinity };
            const windowHeight = window.innerHeight;
            sections.forEach((section) => {
                const bounds = section.getBoundingClientRect()
                if ( bounds.bottom > mostRecent.bottom && bounds.top < windowHeight ) {
                    mostRecent = { section, bottom: bounds.bottom };
                }
            })
            activate(document.querySelector(`#text-table-of-contents li a[href="#${mostRecent.section.getAttribute('id')}"]`).parentElement);
        }
        const observer = new IntersectionObserver(entries => {
            activateLast();
        });
        sections.forEach((section) => {
            observer.observe(section);
        });}
});
// @license-end
</script>
<style>
/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0}pre{font-family:monospace, monospace;font-size:1em}b{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}button::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring{outline:1px dotted ButtonText}details{display:block}summary{display:list-item}/*! end normalise.css */@media (prefers-color-scheme: light){#page{--accent: #002642;--accent-dark: #00151c;--code-foreground: #2c3e50;--code-background: #f5f5f5;--code-func: #6c3163;--code-const: #4e3163;--code-regex: #655370;--back-white: #fff;--back-light: #f0eeed;--back-medium: #c8c8c8;--text-light: #7b7b7b;--text-gray: #444;--text-medium: #222;--text-dark: #000;--switch-icon: "🌚";--switch-shadow-color: #373d4e;--switch-text: "dark mode?"}#theme-switch:checked~#page{--accent: #002642;--accent-dark: #daf1ff;--code-foreground: #a1a8ae;--code-background: #222;--code-func: #bd56ad;--code-const: #8755ab;--code-regex: #a184b3;--back-white: #000;--back-light: #181818;--back-medium: #444;--text-light: #7b7b7b;--text-gray: #c8c8c8;--text-medium: #ddd;--text-dark: #efefef;--switch-icon: "🌝";--switch-shadow-color: #fce477;--switch-text: "light mode?"}#theme-switch:checked~#page img.invertible,#theme-switch:checked~#page object[type="image/svg+xml"].invertible,#theme-switch:checked~#page img.org-latex{filter:invert(90.5%) hue-rotate(180deg) sepia(1%)}}@media (prefers-color-scheme: dark){#theme-switch:checked~#page{--accent: #002642;--accent-dark: #00151c;--code-foreground: #2c3e50;--code-background: #f5f5f5;--code-func: #6c3163;--code-const: #4e3163;--code-regex: #655370;--back-white: #fff;--back-light: #f0eeed;--back-medium: #c8c8c8;--text-light: #7b7b7b;--text-gray: #444;--text-medium: #222;--text-dark: #000;--switch-icon: "🌚";--switch-shadow-color: #373d4e;--switch-text: "dark mode?"}#theme-switch:checked~#page img.invertible,#theme-switch:checked~#page object[type="image/svg+xml"].invertible,#theme-switch:checked~#page img.org-latex{filter:invert(7%) sepia(4%)}#page{--accent: #002642;--accent-dark: #daf1ff;--code-foreground: #a1a8ae;--code-background: #222;--code-func: #bd56ad;--code-const: #8755ab;--code-regex: #a184b3;--back-white: #000;--back-light: #181818;--back-medium: #444;--text-light: #7b7b7b;--text-gray: #c8c8c8;--text-medium: #ddd;--text-dark: #efefef;--switch-icon: "🌝";--switch-shadow-color: #fce477;--switch-text: "light mode?"}#page img.invertible,#page object[type="image/svg+xml"].invertible,#page img.org-latex{filter:invert(90.5%) hue-rotate(180deg) sepia(1%)}}#theme-switch{display:none}#switch-label{position:fixed;bottom:4rem;left:3rem}#switch-label::before{content:var(--switch-icon);font-size:20px;transition:text-shadow .2s}#switch-label::after{content:var(--switch-text);color:var(--switch-shadow-color);font-size:12px;visibility:hidden;margin-left:0.5em;z-index:1;position:fixed;bottom:calc(4rem - 25px);left:calc(3rem - 10px)}@media (max-width: 1000px){#switch-label{left:auto;bottom:auto;right:1vw;top:1vh}#switch-label::after{position:fixed;top:calc(1vh + 3px);right:calc(1vw + 30px);left:auto;bottom:auto}}#theme-switch:focus~#page #switch-label::before,#switch-label:hover::before{text-shadow:0 0 15px var(--switch-shadow-color)}#theme-switch:focus~#page #switch-label::after,#switch-label:hover::after{visibility:visible}@font-face{font-family:"Merriweather";src:url("https://tecosaur.com/resources/org/Merriweather-TextRegular.woff2") format("woff2");font-weight:normal;font-style:normal;font-display:fallback}@font-face{font-family:"Merriweather";src:url("https://tecosaur.com/resources/org/Merriweather-TextItalic.woff2") format("woff2");font-weight:normal;font-style:italic;font-display:fallback}@font-face{font-family:"Merriweather";src:url("https://tecosaur.com/resources/org/Merriweather-TextBold.woff2") format("woff2");font-weight:bold;font-style:normal;font-display:fallback}@font-face{font-family:"et-book";src:url("https://tecosaur.com/resources/org/etbookot-roman-webfont.woff2") format("woff2");font-weight:normal;font-style:normal;font-display:fallback}@font-face{font-family:"et-book";src:url("https://tecosaur.com/resources/org/etbookot-italic-webfont.woff2") format("woff2");font-weight:normal;font-style:italic;font-display:fallback}*::selection{background:var(--back-medium)}.pace .pace-progress{background-color:var(--accent) !important}html,body{height:100%}body{display:flex;flex-direction:column;font-size:16px;font-family:"Merriweather",serif}#page{color:var(--text-dark);background-color:var(--back-light);transition-property:color, background-color;transition-duration:100ms}#content,header,.page-header{margin:32px;flex:1 0 auto}#content{margin-top:4rem;min-height:calc(100vh - 4rem - 48px)}.clearfix::after{clear:both}.clearfix::before,.clearfix::after{content:" ";display:table}.page-header{margin-top:80px;margin-left:0 !important}.page-header h1{font-size:40px;margin-bottom:10px;margin-top:10px;text-transform:none}.page-header .subtitle{font-size:24px;color:var(--text-light);margin:0}.page-meta{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light)}header .site-nav{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light);font-weight:bold;line-height:2.0;margin-top:22px}header .site-nav a{color:var(--text-light);text-decoration:none;margin-left:10px}header .site-nav a:hover{color:var(--text-gray)}header .site-nav a.active{border-bottom:solid;border-bottom-width:2px}header .site-nav a:first-child{margin-left:0}header>div{display:inherit}.site-title{font-size:16px}.site-title span{display:none !important}.site-title ul{display:block !important;list-style:none;padding:0;margin:0}.site-title ul img{border-radius:2px;max-width:32px}.site-header nav a{color:var(--text-light);font-family:"Open Sans",sans;font-size:12px;font-weight:bold;text-transform:uppercase}.site-header nav a:hover{border:0;color:var(--accent)}@media (max-width: 1000px){header *{display:inline}}@media (min-width: 1000px){#content,header,.page-header{max-width:720px;margin-left:164px}header .site-title{float:left}header .site-nav{float:right;margin-top:0}}@media (min-width: 2800px){#content,header,.page-header{margin-left:auto;margin-right:auto}}#content .page-intro{font-family:"Open Sans",sans;font-weight:normal;font-size:15px;line-height:1.6;color:var(--text-gray);margin-bottom:40px}#content p,#content li,#content dd{line-height:1.9}#footer{margin-top:70px;height:10px;background:var(--accent-dark)}.archive-item{margin:50px 0}.archive-item .archive-title{font-size:25px;margin:5px 0;background:none;text-shadow:none;text-decoration:none}.archive-item .archive-title:hover{background:none;text-shadow:none;text-decoration:none}#postamble{display:none}aside{background-color:var(--code-background);border-radius:5px;font-family:"Open Sans",sans;font-weight:normal;font-size:14px;line-height:1.6;color:var(--text-gray);margin:20px 0;padding:5px 20px 10px;line-height:1.6 !important}aside p{line-height:1.6 !important}aside pre{font-size:12px;border:none;padding-left:0}aside :first-child{margin-top:0.5em}aside :last-child{margin-bottom:0.5em}@media (min-width: 1280px){aside{float:right;clear:right;background-color:var(--back-white);max-width:45% !important;margin-right:-52%}aside::before{content:''}}blockquote{border-width:0;border-left-style:solid;border-left-width:1px;border-left-color:var(--back-medium);margin:20px 0;padding:0;padding-left:15px}blockquote p{display:inline;font-size:14px}blockquote ol,blockquote ul{margin-left:1em}blockquote footer{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light);text-transform:none}div.info{background:rgba(58,129,195,0.15);border-left:4px solid rgba(58,129,195,0.45);margin:1.8rem 0 1.25rem 15px;padding:0.8em;line-height:1.4;text-align:center;position:relative;clear:both}div.info p{margin:0}div.info::before{content:"i";color:var(--back-white);background:rgba(58,129,195,0.8);align-items:flex-end;top:-1rem;font-weight:700;font-size:1.4rem;-webkit-clip-path:circle(50% at 50% 50%);clip-path:circle(50% at 50% 50%);width:30px;height:30px;display:inline-flex;justify-content:center;position:absolute;left:-1.2rem;line-height:1.3;text-align:center}div.success{background:rgba(45,149,116,0.15);border-left:4px solid rgba(45,149,116,0.45);margin:1.8rem 0 1.25rem 15px;padding:0.8em;line-height:1.4;text-align:center;position:relative;clear:both}div.success p{margin:0}div.success::before{content:"✔";color:var(--back-white);background:rgba(45,149,116,0.8);align-items:flex-end;top:-1rem;font-weight:700;font-size:1.4rem;-webkit-clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);width:35px;height:35px;display:inline-flex;justify-content:center;position:absolute;left:-1.2rem;line-height:1.5;text-align:center}div.warning{background:rgba(220,117,47,0.15);border-left:4px solid rgba(220,117,47,0.45);margin:1.8rem 0 1.25rem 15px;padding:0.8em;line-height:1.4;text-align:center;position:relative;clear:both}div.warning p{margin:0}div.warning::before{content:"!";color:var(--back-white);background:rgba(220,117,47,0.8);align-items:flex-end;top:-1rem;font-weight:700;font-size:1.4rem;-webkit-clip-path:polygon(50% 0, 0 100%, 100% 100%);clip-path:polygon(50% 0, 0 100%, 100% 100%);width:35px;height:35px;display:inline-flex;justify-content:center;position:absolute;left:-1.2rem;line-height:1.1;text-align:center}div.error{background:rgba(186,47,89,0.15);border-left:4px solid rgba(186,47,89,0.45);margin:1.8rem 0 1.25rem 15px;padding:0.8em;line-height:1.4;text-align:center;position:relative;clear:both}div.error p{margin:0}div.error::before{content:"!";color:var(--back-white);background:rgba(186,47,89,0.8);align-items:flex-end;top:-1rem;font-weight:700;font-size:1.4rem;-webkit-clip-path:polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);clip-path:polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);width:35px;height:30px;display:inline-flex;justify-content:center;position:absolute;left:-1.2rem;line-height:1.1;text-align:center}div.notes{background:rgba(113,90,177,0.15);border-left:4px solid rgba(113,90,177,0.45);margin:1.8rem 0 1.25rem 15px;padding:0.8em;line-height:1.4;text-align:center;position:relative;clear:both}div.notes p{margin:0}div.notes::before{content:"✎";color:var(--back-white);background:rgba(113,90,177,0.8);align-items:flex-end;top:-1rem;font-weight:700;font-size:1.4rem;-webkit-clip-path:polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);clip-path:polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);width:32px;height:32px;display:inline-flex;justify-content:center;position:absolute;left:-1.2rem;line-height:1.3;text-align:center}.org-ref-bib-h1{margin-top:70px;padding-top:30px;border-width:0;border-top-style:solid;border-top-width:1px;border-color:var(--back-light);font-family:"Open Sans",sans;font-family:"Open Sans",sans;font-weight:normal;font-size:20px;line-height:1.6;color:var(--text-gray)}.org-ref-bib{font-family:"Open Sans",sans;font-weight:normal;font-size:15px;line-height:1.6;color:var(--text-gray)}.org-ref-bib li>a:nth-child(2){background:none;text-shadow:none;text-decoration:none}.org-ref-bib li>a:nth-child(2):hover{background:none;text-shadow:none;text-decoration:none}.org-ref-bib .bib-link{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light);background:none;text-shadow:none;text-decoration:none}pre.src,pre.example{border-width:0;border-left-style:solid;border-left-width:1px;border-left-color:var(--back-medium);margin:20px 0;padding:0;padding-left:15px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:14px;line-height:1.9;overflow-x:visible;box-shadow:none;white-space:pre-wrap;position:relative}pre.example{border-left-style:dotted;border-left-width:2px}pre.src::before{display:inline-block;position:absolute;background-color:transparent;top:unset;bottom:-16px;left:20px;padding:0px;border:none;font-size:80%;font-style:italic;color:var(--text-light)}pre.src:empty{display:none}code{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;color:var(--code-foreground);font-size:0.9em;padding:0 2px}kbd{display:inline-block;padding:0.25em 0.35em;font:80% SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-weight:inherit;line-height:normal;line-height:80%;color:var(--text-gray);vertical-align:middle;background-color:var(--back-light);border:1px solid #91959a88;border-radius:0.35em;box-shadow:inset 0 -1px 0 #91959a88}li code{font-size:14px}li p code{font-size:15px}details.code{position:relative}details.code summary{position:relative;left:-2.5px;padding-left:10px;padding-bottom:4px;margin-left:-10px;z-index:1;outline:none;font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light)}details.code summary .name{font-size:14px;color:var(--text-medium);margin-right:0.7em}details.code summary .lang{font-family:SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;font-style:italic}details.code summary::marker{color:var(--back-medium)}details.code[open] summary{margin-bottom:-32px}details.code[open] summary .lang{display:none}details.code[open] summary.named{margin-bottom:-26px}details.code:not([open]) summary{margin-bottom:-5px}p+details.code{margin-top:-20px}li p+details.code{margin-top:-5px}.example,.src{color:var(--code-foreground)}.example .org-keyword,.src .org-keyword{color:#3a81c3}.example .org-variable-name,.src .org-variable-name{color:#715ab1}.example .org-rainbow-delimiters-depth-1,.example .org-rainbow-delimiters-depth-2,.example .org-rainbow-delimiters-depth-3,.example .org-rainbow-delimiters-depth-4,.example .org-rainbow-delimiters-depth-5,.example .org-rainbow-delimiters-depth-6,.example .org-rainbow-delimiters-depth-7,.example .org-rainbow-delimiters-depth-8,.example .org-rainbow-delimiters-depth-9,.src .org-rainbow-delimiters-depth-1,.src .org-rainbow-delimiters-depth-2,.src .org-rainbow-delimiters-depth-3,.src .org-rainbow-delimiters-depth-4,.src .org-rainbow-delimiters-depth-5,.src .org-rainbow-delimiters-depth-6,.src .org-rainbow-delimiters-depth-7,.src .org-rainbow-delimiters-depth-8,.src .org-rainbow-delimiters-depth-9{color:#555}.example .org-string,.src .org-string{color:#2d9574}.example .org-comment,.example .org-comment-delimiter,.src .org-comment,.src .org-comment-delimiter{color:#555}.example .org-function-name,.src .org-function-name{color:var(--code-func)}.example .org-constant,.example .org-highlight-numbers-number,.src .org-constant,.src .org-highlight-numbers-number{color:var(--code-const)}.gutter{position:absolute;top:0;left:-2.5rem;width:2rem;padding-right:0.3rem;padding-top:5px;height:calc(100% - 10px);z-index:1;transition:opacity 200ms;opacity:0;font-size:15px}.gutter:hover{opacity:1}.gutter *{display:block;width:100%;text-align:right;padding:0;margin:0;color:var(--text-light)}.gutter *:hover{color:var(--text-gray)}.gutter *:active{font-weight:bold}.gutter a{text-decoration:none;font-size:110%}.gutter button{background:none;border:none}pre.src-asymptote::before{content:'Asymptote'}pre.src-authinfo::before{content:'Authinfo'}pre.src-awk::before{content:'Awk'}pre.src-C::before{content:'C'}pre.src-clojure::before{content:'Clojure'}pre.src-css::before{content:'CSS'}pre.src-D::before{content:'D'}pre.src-ditaa::before{content:'ditaa'}pre.src-dot::before{content:'Graphviz'}pre.src-calc::before{content:'Emacs Calc'}pre.src-emacs-lisp::before{content:'Emacs Lisp'}pre.src-fortran::before{content:'Fortran'}pre.src-gnuplot::before{content:'gnuplot'}pre.src-haskell::before{content:'Haskell'}pre.src-hledger::before{content:'hledger'}pre.src-java::before{content:'Java'}pre.src-js::before{content:'Javascript'}pre.src-latex::before{content:'LaTeX'}pre.src-ledger::before{content:'Ledger'}pre.src-lisp::before{content:'Lisp'}pre.src-lilypond::before{content:'Lilypond'}pre.src-lua::before{content:'Lua'}pre.src-matlab::before{content:'MATLAB'}pre.src-mscgen::before{content:'Mscgen'}pre.src-ocaml::before{content:'Objective Caml'}pre.src-octave::before{content:'Octave'}pre.src-org::before{content:'Org mode'}pre.src-oz::before{content:'OZ'}pre.src-plantuml::before{content:'Plantuml'}pre.src-processing::before{content:'Processing.js'}pre.src-python::before{content:'Python'}pre.src-R::before{content:'R'}pre.src-ruby::before{content:'Ruby'}pre.src-sass::before{content:'Sass'}pre.src-scheme::before{content:'Scheme'}pre.src-screen::before{content:'Gnu Screen'}pre.src-sed::before{content:'Sed'}pre.src-sh::before{content:'shell'}pre.src-sql::before{content:'SQL'}pre.src-sqlite::before{content:'SQLite'}pre.src-forth::before{content:'Forth'}pre.src-io::before{content:'IO'}pre.src-J::before{content:'J'}pre.src-makefile::before{content:'Makefile'}pre.src-maxima::before{content:'Maxima'}pre.src-perl::before{content:'Perl'}pre.src-picolisp::before{content:'Pico Lisp'}pre.src-scala::before{content:'Scala'}pre.src-shell::before{content:'Shell Script'}pre.src-systemd::before{content:'Systemd'}pre.src-ebnf2ps::before{content:'ebfn2ps'}pre.src-cpp::before{content:'C++'}pre.src-abc::before{content:'ABC'}pre.src-coq::before{content:'Coq'}pre.src-groovy::before{content:'Groovy'}pre.src-bash::before{content:'bash'}pre.src-csh::before{content:'csh'}pre.src-ash::before{content:'ash'}pre.src-dash::before{content:'dash'}pre.src-ksh::before{content:'ksh'}pre.src-mksh::before{content:'mksh'}pre.src-posh::before{content:'posh'}pre.src-ada::before{content:'Ada'}pre.src-asm::before{content:'Assembler'}pre.src-caml::before{content:'Caml'}pre.src-delphi::before{content:'Delphi'}pre.src-html::before{content:'HTML'}pre.src-idl::before{content:'IDL'}pre.src-mercury::before{content:'Mercury'}pre.src-metapost::before{content:'MetaPost'}pre.src-modula-2::before{content:'Modula-2'}pre.src-pascal::before{content:'Pascal'}pre.src-ps::before{content:'PostScript'}pre.src-prolog::before{content:'Prolog'}pre.src-simula::before{content:'Simula'}pre.src-tcl::before{content:'tcl'}pre.src-tex::before{content:'LaTeX'}pre.src-plain-tex::before{content:'TeX'}pre.src-verilog::before{content:'Verilog'}pre.src-vhdl::before{content:'VHDL'}pre.src-xml::before{content:'XML'}pre.src-nxml::before{content:'XML'}pre.src-conf::before{content:'Configuration File'}.dropcap{float:left;font-size:55px;font-style:normal;line-height:.1;margin-right:0.2em;margin-top:0.5em;padding:0}figure{text-align:center}figure figcaption{margin-top:10px;font-family:"Open Sans",sans;font-weight:normal;font-size:15px;line-height:1.6;color:var(--text-gray)}figure figcaption .figure-number{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light)}img.zoomTarget:hover{cursor:default !important}img,object[type="image/svg+xml"]{filter:invert(7%) sepia(4%);max-width:100%}.org-svg{width:90%}#footnotes{margin-top:70px;padding-top:30px;border-width:0;border-top-style:solid;border-top-width:1px;border-color:var(--back-light);font-family:"Open Sans",sans;font-weight:normal;font-size:15px;line-height:1.6;color:var(--text-gray)}#footnotes p,#footnotes li{font-family:"Open Sans",sans;font-weight:normal;font-size:15px;line-height:1.6;color:var(--text-gray)}#footnotes h2.footnotes{margin-top:0;margin-bottom:30px;font-family:"Open Sans",sans;font-size:18px;letter-spacing:5px;display:none}#footnotes .footnum{color:var(--text-dark)}h1,h2,h3,h4,h5,h6{font-family:"et-book",serif;font-weight:normal;margin-bottom:0;margin-top:60px}h1>a[aria-hidden='true'],h2>a[aria-hidden='true'],h3>a[aria-hidden='true'],h4>a[aria-hidden='true'],h5>a[aria-hidden='true'],h6>a[aria-hidden='true']{color:var(--back-medium);position:relative;top:0.06em;line-height:1;font-size:110%;padding-left:0.2em;text-decoration:none;visibility:hidden}h1>a[aria-hidden='true']:hover,h2>a[aria-hidden='true']:hover,h3>a[aria-hidden='true']:hover,h4>a[aria-hidden='true']:hover,h5>a[aria-hidden='true']:hover,h6>a[aria-hidden='true']:hover{color:var(--text-light)}h1:hover>a[aria-hidden='true'],h2:hover>a[aria-hidden='true'],h3:hover>a[aria-hidden='true'],h4:hover>a[aria-hidden='true'],h5:hover>a[aria-hidden='true'],h6:hover>a[aria-hidden='true']{visibility:visible}h1,h2,h3,h4,h5,h6{padding-left:30px;margin-left:-30px;position:relative}h1,.section-number-1{font-size:40px}h2,.section-number-2{font-size:30px}h3,.section-number-3{font-size:24px}h4,.section-number-4{font-size:20px;font-style:italic}h5{font-size:20px;font-variant:small-caps}.section-number-5{font-size:20px}h6{font-size:18px;font-style:italic}.section-number-6{font-size:18px}.section-number-1,.section-number-2,.section-number-3,.section-number-4,.section-number-5,.section-number-6{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light);font-size:inherit;color:var(--text-light);line-height:1}@media (min-width: 1000px){.section-number-1,.section-number-2,.section-number-3,.section-number-4,.section-number-5,.section-number-6{position:absolute;transform:translateX(-100%) translateX(-10px)}}.outline-text-2:empty+.outline-3>h3,.outline-text-2:-moz-only-whitespace+.outline-3>h3{margin-top:20px}.outline-text-3:empty+.outline-4>h4,.outline-text-3:-moz-only-whitespace+.outline-4>h4{margin-top:15px}.outline-text-4:empty+.outline-5>h5,.outline-text-4:-moz-only-whitespace+.outline-5>h5{margin-top:15px}.outline-text-5:empty+.outline-6>h6,.outline-text-5:-moz-only-whitespace+.outline-6>h6{margin-top:10px}hr{border:none;border-top-style:solid;border-top-width:1px;color:var(--back-medium);margin-bottom:30px;margin-top:40px}a{color:inherit;position:relative}figcaption a,p a,.page-tags a,table a,li a,dl a{text-decoration-line:underline;text-decoration-style:dotted;text-decoration-color:var(--text-light);text-decoration-thickness:.1em;text-underline-offset:1.5px;border-radius:1px}figcaption a::selection,p a::selection,.page-tags a::selection,table a::selection,li a::selection,dl a::selection{background:var(--back-medium)}figcaption a *,figcaption a *:after,figcaption a:after,figcaption a *:before,figcaption a:before,p a *,p a *:after,p a:after,p a *:before,p a:before,.page-tags a *,.page-tags a *:after,.page-tags a:after,.page-tags a *:before,.page-tags a:before,table a *,table a *:after,table a:after,table a *:before,table a:before,li a *,li a *:after,li a:after,li a *:before,li a:before,dl a *,dl a *:after,dl a:after,dl a *:before,dl a:before{text-shadow:none}figcaption a:visited,p a:visited,.page-tags a:visited,table a:visited,li a:visited,dl a:visited{color:var(--text-dark)}figcaption a:hover,p a:hover,.page-tags a:hover,table a:hover,li a:hover,dl a:hover{opacity:0.9;filter:drop-shadow(1px 1px 1px var(--back-white));text-decoration:none}figcaption a:hover::before,p a:hover::before,.page-tags a:hover::before,table a:hover::before,li a:hover::before,dl a:hover::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;mask-image:url("data:image/svg+xml;charset=utf8,%3Csvg id='squiggle-link' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:ev='http://www.w3.org/2001/xml-events' viewBox='0 0 20 4'%3E%3Cstyle type='text/css'%3E.squiggle{animation:shift .3s linear infinite;}@keyframes shift {from {transform:translateX(0);}to {transform:translateX(-20px);}}%3C/style%3E%3Cpath fill='none' stroke='%23000000' stroke-width='2' class='squiggle' d='M0,3.5 c 5,0,5,-3,10,-3 s 5,3,10,3 c 5,0,5,-3,10,-3 s 5,3,10,3'/%3E%3C/svg%3E") !important;mask-position:0% 100%;mask-size:0.8em auto;mask-repeat:repeat-x;background:var(--text-light)}figcaption a[href^="#"],p a[href^="#"],.page-tags a[href^="#"],table a[href^="#"],li a[href^="#"],dl a[href^="#"]{text-decoration-line:underline;text-decoration-style:dotted;text-decoration-color:var(--text-light);text-decoration-thickness:.1em;text-underline-offset:1.5px}figcaption a[href^="#"]::selection,p a[href^="#"]::selection,.page-tags a[href^="#"]::selection,table a[href^="#"]::selection,li a[href^="#"]::selection,dl a[href^="#"]::selection{background:var(--back-white)}figcaption a[href^="#"]:hover,p a[href^="#"]:hover,.page-tags a[href^="#"]:hover,table a[href^="#"]:hover,li a[href^="#"]:hover,dl a[href^="#"]:hover{opacity:0.9;filter:drop-shadow(1px 1px 1px var(--back-white));text-decoration-line:underline;text-decoration-style:dotted;text-decoration-color:var(--text-light);text-decoration-thickness:.1em;text-underline-offset:1.5px}figcaption a[href^="#"]:hover::selection,p a[href^="#"]:hover::selection,.page-tags a[href^="#"]:hover::selection,table a[href^="#"]:hover::selection,li a[href^="#"]:hover::selection,dl a[href^="#"]:hover::selection{background:var(--back-white)}#theme-switch:checked~#page #breadcrumbs a:hover,#theme-switch:checked~#page figcaption a:hover,#theme-switch:checked~#page p a:hover,#theme-switch:checked~#page .page-tags a:hover,#theme-switch:checked~#page table a:hover,#theme-switch:checked~#page #crosslinks a:not(.highlight):hover,#theme-switch:checked~#page li a:hover,#theme-switch:checked~#page dl a:hover{text-decoration:none}#theme-switch:checked~#page #breadcrumbs a:hover::before,#theme-switch:checked~#page figcaption a:hover::before,#theme-switch:checked~#page p a:hover::before,#theme-switch:checked~#page .page-tags a:hover::before,#theme-switch:checked~#page table a:hover::before,#theme-switch:checked~#page #crosslinks a:not(.highlight):hover::before,#theme-switch:checked~#page li a:hover::before,#theme-switch:checked~#page dl a:hover::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;mask-image:url("data:image/svg+xml;charset=utf8,%3Csvg id='squiggle-link' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:ev='http://www.w3.org/2001/xml-events' viewBox='0 0 20 4'%3E%3Cstyle type='text/css'%3E.squiggle{animation:shift .3s linear infinite;}@keyframes shift {from {transform:translateX(0);}to {transform:translateX(-20px);}}%3C/style%3E%3Cpath fill='none' stroke='%23000000' stroke-width='2' class='squiggle' d='M0,3.5 c 5,0,5,-3,10,-3 s 5,3,10,3 c 5,0,5,-3,10,-3 s 5,3,10,3'/%3E%3C/svg%3E") !important;mask-position:0% 100%;mask-size:0.8em auto;mask-repeat:repeat-x;background:var(--text-light)}*:target::before{content:"🠖";position:absolute;left:-7rem;top:calc(0.5em - 2rem);line-height:1;color:#e65353aa;font-size:3rem;font-style:normal}@media (max-width: 1000px){*:target::before{content:"🠔";left:unset;right:0}}#content .page-intro p a,#footnotes a{text-decoration-line:underline;text-decoration-style:dotted;text-decoration-color:var(--text-light);text-decoration-thickness:.1em;text-underline-offset:1.5px;border-radius:1px}#content .page-intro p a::selection,#footnotes a::selection{background:var(--back-medium)}#content .page-intro p a *,#content .page-intro p a *:after,#content .page-intro p a:after,#content .page-intro p a *:before,#content .page-intro p a:before,#footnotes a *,#footnotes a *:after,#footnotes a:after,#footnotes a *:before,#footnotes a:before{text-shadow:none}#content .page-intro p a:visited,#footnotes a:visited{color:var(--text-gray)}#content .page-intro p a:hover,#footnotes a:hover{text-decoration-line:underline;text-decoration-style:dotted;text-decoration-color:var(--text-light);text-decoration-thickness:.1em;text-underline-offset:1.5px;border-radius:1px}#content .page-intro p a:hover::selection,#footnotes a:hover::selection{background:var(--back-medium)}#content .page-intro p a:hover *,#content .page-intro p a:hover *:after,#content .page-intro p a:hover:after,#content .page-intro p a:hover *:before,#content .page-intro p a:hover:before,#footnotes a:hover *,#footnotes a:hover *:after,#footnotes a:hover:after,#footnotes a:hover *:before,#footnotes a:hover:before{text-shadow:none}#content .page-intro p a:hover:visited,#footnotes a:hover:visited{color:var(--text-gray)}.btn{padding:7px 14px;border-style:solid;border-width:1px;border-color:var(--back-light);border-radius:1px;font-family:"Open Sans",sans;font-variant:all-small-caps;font-size:14px;font-style:normal;letter-spacing:2px;background-image:none;cursor:pointer}.btn:hover{background-color:var(--back-light);background-image:none}.btn.disabled{color:var(--text-light)}.btn.disabled:hover{cursor:default}.btn.small{padding:3px 6px;border-style:solid;border-width:1px;border-color:var(--back-light);border-radius:1px;font-family:"Open Sans",sans;font-variant:all-small-caps;font-size:12px;font-style:normal;letter-spacing:2px;background-image:none;padding-right:9px;padding-left:9px}.btn.small:hover{background-color:var(--back-light);background-image:none}.btn.highlight{text-shadow:none;text-decoration:none;color:var(--text-dark);background-color:yellow}.btn.primary{text-shadow:none;text-decoration:none;color:var(--back-white);background-color:var(--accent)}.btn.primary:hover{background-color:var(--back-light);background-image:none;color:var(--text-dark)}.image-link,.image-link:hover{background:none;text-shadow:none;text-decoration:none}div.link-preview{border:1px solid var(--back-medium);border-radius:0.5em;overflow:hidden;position:relative;max-height:5em;padding-left:0.5em}div.link-preview a{color:inherit;text-decoration:none}div.link-preview img{border-right:1px solid var(--back-medium);float:left;height:5em;margin-left:-0.5em;margin-right:0.5em}div.link-preview p{margin:0 0.6em 0 0;font-size:10pt}div.link-preview p b{font-size:11pt}div.link-preview small{float:right;font-family:sans;color:var(--text-light);margin:0.45em 0.6em}ul,ol,dl{list-style:none;list-style-position:outside;padding:0}ul li::before,ul dt::before,ol li::before,ol dt::before,dl li::before,dl dt::before{display:inline-block;width:1em;font-family:"Open Sans",sans;font-weight:normal;font-size:15px;line-height:1.6;color:var(--text-gray)}ul li,ol li,dl li{margin:5px 0;font-size:14px}ul li p,ol li p,dl li p{font-size:15px}ul li::before{content:"•";margin-left:-1em}ol{counter-reset:li}ol li:not([value]){counter-increment:li}ol li::before{content:counter(li);margin-left:-1.5em;margin-right:0.5em;text-align:right;direction:rtl}ol li[value]::before{content:attr(value)}ul ul,ol ol{padding-left:20px}ul ul ul,ol ol ol{padding-left:30px}li p:first-child{display:inline-block;margin-bottom:0}dl dt::before{content:"•";margin-left:-1em}dl dt{font-weight:normal;margin-bottom:10px}dl dd{font-style:italic;margin-bottom:20px}li .checkbox{display:inline-block;width:0.9em;height:0.9em;border-radius:3px;margin:3px;top:4px;position:relative}li.on>.checkbox{background:#2d9574;box-shadow:0 0 2px #2d9574}li.trans>.checkbox{background:#dc752f;box-shadow:0 0 2px #dc752f}li.off>.checkbox{background:#ba2f59;box-shadow:0 0 2px #ba2f59;top:6px}li.on>.checkbox::after{content:'';height:0.45em;width:0.225em;-webkit-transform-origin:left top;transform-origin:left top;transform:scaleX(-1) rotate(135deg);border-right:2.8px solid #fff;border-top:2.8px solid #fff;opacity:0.9;left:0.10em;top:0.45em;position:absolute}li.trans>.checkbox::after{content:'';font-weight:bold;font-size:1.6em;position:absolute;top:0.2em;left:0.11em;width:0.35em;height:0.12em;background:#fff;opacity:0.9;border-radius:0.1em}li.off>.checkbox::after{content:'✖';color:#fff;opacity:0.9;position:relative;top:-0.50rem;left:0.17em;font-size:0.75em}#org-div-home-and-up{display:none !important}.outline-2 h2{font-size:30px}.outline-3 h3{font-size:24px;font-style:normal}.outline-2 .section-number-2{font-size:30px}.outline-3 .section-number-3{font-size:24px}.timestamp,.timestamp-kwd{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light);background-color:var(--back-white);border-radius:1px}.todo,.done{padding:.1em .2em;border-style:solid;border-width:1px;border-color:var(--back-light);border-radius:1px;font-family:"Open Sans",sans;font-variant:all-small-caps;font-size:max(0.4em, 10px);font-style:normal;letter-spacing:2px;background-image:none;line-height:1;white-space:nowrap;vertical-align:middle;padding:0.1em 0.5em;background-color:var(--back-white);background-color:transparent;border:none;font-weight:bold}.todo:hover,.done:hover{background-color:var(--back-light);background-image:none}.todo:not(.active),.done:not(.active){border-color:var(--back-white)}.todo.active,.done.active{text-shadow:none;text-decoration:none;color:var(--back-white);background-color:var(--code-foreground)}.todo.active:hover,.done.active:hover{background-color:var(--back-light);background-image:none;color:var(--text-dark)}.outline-2,.outline-3,.outline-4{contain:layout}.outline-2 .todo,.outline-2 .done,.outline-3 .todo,.outline-3 .done,.outline-4 .todo,.outline-4 .done{font-size:18px}.todo{color:#ee3333}.done{color:var(--text-light)}.tag>span{padding:.1em .2em;border-style:solid;border-width:1px;border-color:var(--back-light);border-radius:1px;font-family:"Open Sans",sans;font-variant:all-small-caps;font-size:max(0.4em, 10px);font-style:normal;letter-spacing:2px;background-image:none;line-height:1;white-space:nowrap;vertical-align:middle;padding:0.1em 0.5em;background-color:var(--back-white);border-radius:100px}.tag>span:hover{background-color:var(--back-light);background-image:none}.tag>span:not(.active){border-color:var(--back-white)}.tag>span.active{text-shadow:none;text-decoration:none;color:var(--back-white);background-color:var(--code-foreground)}.tag>span.active:hover{background-color:var(--back-light);background-image:none;color:var(--text-dark)}.priority{color:var(--text-light);font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace}.footref{text-shadow:none}.footpara{display:inline}.footdef{margin-bottom:1em}th.org-right{text-align:center}th.org-left{text-align:center}th.org-center{text-align:center}td.org-right{text-align:right}td.org-left{text-align:left}td.org-center{text-align:center}div.org-center{text-align:center}span.acr{font-variant-caps:all-small-caps;letter-spacing:0.1em}.music-track{display:flex;justify-content:center;align-items:center;flex-wrap:wrap}.music-track img{height:6rem;margin-right:2rem}.music-track a{text-decoration:none}.music-track span{min-width:35%}div.table{position:relative}div.table .gutter{left:calc(20px - 2.5rem);padding-top:18px}div.table .tabular{max-width:100%;overflow-x:auto}table{border-color:var(--text-light);border-left:transparent;border-right:transparent;border-style:solid;border-width:2px;border-collapse:collapse;font-size:15px;font-family:"Open Sans",sans;margin:20px;padding:20px}table thead{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light);font-size:15px}table thead tr th{padding:4px 10px;background-color:#9991}table thead tr:last-of-type th{border-bottom:solid 1px var(--text-light)}table tr,table th,table td{border:none}table tbody tr td{border-top:0;padding:0 10px}table tr{line-height:1.9}table caption{margin-bottom:10px;min-width:20em;font-family:"Open Sans",sans;font-weight:normal;font-size:15px;line-height:1.6;color:var(--text-gray)}table caption .table-number{font-family:"Open Sans",sans;font-weight:normal;font-style:normal;font-size:12px;line-height:1.9;color:var(--text-light)}::-webkit-scrollbar{width:10px;height:8px}::-webkit-scrollbar-track{background:#9992}::-webkit-scrollbar-thumb{background:#ccc}::-webkit-scrollbar-thumb:hover{background:#888}@media (min-width: 1280px){#table-of-contents{position:fixed;width:18rem;right:1rem;top:0;padding:1em;line-height:1.5;margin-top:4rem}#table-of-contents h2{margin-top:0}#table-of-contents #text-table-of-contents{position:relative}#table-of-contents #text-table-of-contents::before,#table-of-contents #text-table-of-contents::after{position:absolute;content:'';width:calc(100% - 10px);height:0.7rem;left:0;z-index:1}#table-of-contents #text-table-of-contents::before{top:0;background:linear-gradient(180deg, var(--back-light) 0%, var(--back-light) 35%, rgba(0,0,0,0) 100%)}#table-of-contents #text-table-of-contents::after{bottom:0;background:linear-gradient(0deg, var(--back-light) 0%, var(--back-light) 35%, rgba(0,0,0,0) 100%)}#table-of-contents #text-table-of-contents>ul{list-style:none;padding:0;margin:0;max-height:calc(100vh - 5rem - 50px);overflow-y:auto;overflow-x:hidden;scrollbar-width:thin}#table-of-contents #text-table-of-contents>ul ul{padding-left:2em}#table-of-contents #text-table-of-contents>ul ul.active{display:inline-block}#table-of-contents #text-table-of-contents>ul li.active>ul{display:inline-block}#table-of-contents #text-table-of-contents>ul li.active>label a,#table-of-contents #text-table-of-contents>ul li.active>a{color:var(--text-dark)}#table-of-contents #text-table-of-contents>ul li.active>input:not(:checked)~label::after{transform:rotate(90deg);top:5px;opacity:0.35}#table-of-contents #text-table-of-contents>ul>li:last-child{margin-bottom:2rem}}@media (min-width: 1440px){#table-of-contents{width:20rem;right:2rem}}@media (min-width: 1640px){#table-of-contents{right:5rem}}@media (min-width: 2000px){#table-of-contents{width:25rem}}#table-of-contents #text-table-of-contents ul{width:100%}#table-of-contents #text-table-of-contents>ul ul{display:none}#table-of-contents #text-table-of-contents li input[type=checkbox]{display:none}#table-of-contents #text-table-of-contents li label{display:inline-block;width:100%;position:relative}#table-of-contents #text-table-of-contents li a{display:inline-block;color:var(--text-gray);text-decoration:none !important;text-shadow:none;background:none !important}#table-of-contents #text-table-of-contents li label::after{content:"\25b6";color:var(--text-gray);margin-left:0.5em;font-size:10px;display:inline-block;position:absolute;top:3.4px;left:-20px;opacity:0.8}#table-of-contents #text-table-of-contents li input:checked~ul{display:inline-block !important}#table-of-contents #text-table-of-contents li input:checked~label a{font-weight:bold}#table-of-contents #text-table-of-contents li input:checked~label::after{transform:rotate(90deg);top:5px}#table-of-contents #text-table-of-contents li::before{content:"" !important}.page-tags a{padding:.1em .2em;border-style:solid;border-width:1px;border-color:var(--back-light);border-radius:1px;font-family:"Open Sans",sans;font-variant:all-small-caps;font-size:max(0.4em, 10px);font-style:normal;letter-spacing:2px;background-image:none;line-height:1;white-space:nowrap;vertical-align:middle;padding:0.1em 0.5em;background-color:var(--back-white);margin-right:5px;line-height:3em}.page-tags a:hover{background-color:var(--back-light);background-image:none}.page-tags a:not(.active){border-color:var(--back-white)}.page-tags a.active{text-shadow:none;text-decoration:none;color:var(--back-white);background-color:var(--code-foreground)}.page-tags a.active:hover{background-color:var(--back-light);background-image:none;color:var(--text-dark)}@media print{h2{page-break-before:always}h1,h2,h3,h4,h5{page-break-after:avoid}#switch-label{display:none}#content,#page-header{margin-top:0}#table-of-contents #text-table-of-contents>ul ul{display:inline-block}#table-of-contents #text-table-of-contents>ul a::after{content:leader(".") target-counter(attr(href), page)}#table-of-contents #text-table-of-contents li label::after{display:none}img{filter:none}}@page{size:auto;margin-top:4mm;margin-bottom:4mm}
</style>
<link rel='shortcut icon' type='image/png' href='https://www.gnu.org/software/emacs/favicon.png'>
<script>
  window.MathJax = {
    loader: {
      load: ['[tex]/mathtools'],
    },
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em',
      packages: {'[+]': ['mathtools']},
      macros: {
        RR: ['\\ifstrempty{#1}{\\mathbb{R}}{\\mathbb{R}^{#1}}', 1, ''],
        NN: ['\\ifstrempty{#1}{\\mathbb{N}}{\\mathbb{N}^{#1}}', 1, ''],
        ZZ: ['\\ifstrempty{#1}{\\mathbb{Z}}{\\mathbb{Z}^{#1}}', 1, ''],
        QQ: ['\\ifstrempty{#1}{\\mathbb{Q}}{\\mathbb{Q}^{#1}}', 1, ''],
        CC: ['\\ifstrempty{#1}{\\mathbb{C}}{\\mathbb{C}^{#1}}', 1, ''],
        EE: '\\mathbb{E}',
        Lap: '\\operatorname{\\mathcal{L}}',
        Var: '\\operatorname{Var}',
        Cor: '\\operatorname{Cor}',
        E: '\\operatorname{E}',
      },
      mathtools: {
        pairedDelimiters: {
          abs: ['\\lvert', '\\rvert'],
          norm: ['\\lVert', '\\rVert'],
          ceil: ['\\lceil', '\\rceil'],
          floor: ['\\lfloor', '\\rfloor'],
          round: ['\\lfloor', '\\rceil'],
        }
      }
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
</head>
<body>
<input type='checkbox' id='theme-switch'><div id='page'><label id='switch-label' for='theme-switch'></label><div id="content">
<header class="page-header"><div class="page-meta"><!--<a href="https://code.tecosaur.net/tec/emacs-config/commit/e1dfc56" style="text-decoration: none"><code style="padding: 0; color: var(--text-light); font-size: inherit; opacity: 0.7">e1dfc56</code></a>-->2025-06-09 14:56 <span class='acr'>UTC</span>, <a href="https://code.tecosaur.net/tec/emacs-config/commit/e1dfc56" style="text-decoration: none"><code style="padding: 0; color: var(--text-light); font-size: inherit; opacity: 0.7">e1dfc56</code></a>, tecosaur</div>

<h1 class="title">Doom Emacs Configuration</h1>
<p class="subtitle" role="doc-subtitle">The Methods, Management, and Menagerie of Madness</p>
</header><nav id="table-of-contents">
<h2><a href="#" style="color:inherit; text-decoration: none;">Table of Contents</a></h2>
<div id="text-table-of-contents">
<ul>
<li><input type='checkbox' id='toc--introduction'/><label for='toc--introduction'><a href="#introduction">1. Introduction</a></label>
<ul>
<li><input type='checkbox' id='toc--why-emacs'/><label for='toc--why-emacs'><a href="#why-emacs">1.1. Why Emacs?</a></label>
<ul>
<li><a href="#enveloping-editor">1.1.1. The enveloping editor</a></li>
<li><a href="#some-notably-unique">1.1.2. Some notably unique features</a></li>
<li><a href="#issues">1.1.3. Issues</a></li>
<li><a href="#teach-man-fish">1.1.4. Teach a man to fish&#x2026;</a></li>
</ul>
</li>
<li><a href="#editor-comparison">1.2. Editor comparison</a></li>
<li><input type='checkbox' id='toc--notes-unwary-adventurer'/><label for='toc--notes-unwary-adventurer'><a href="#notes-unwary-adventurer">1.3. Notes for the unwary adventurer</a></label>
<ul>
<li><a href="#extra-requirements">1.3.1. Extra Requirements</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--current-issues'/><label for='toc--current-issues'><a href="#current-issues">1.4. Current Issues</a></label>
<ul>
<li><a href="#magit-push-daemon">1.4.1. Magit push in daemon</a></li>
<li><a href="#unread-emails-doesnt">1.4.2. Unread emails doesn't work across Emacs instances</a></li>
</ul>
</li>
</ul>
</li>
<li><input type='checkbox' id='toc--rudimentary-configuration'/><label for='toc--rudimentary-configuration'><a href="#rudimentary-configuration">2. Rudimentary configuration</a></label>
<ul>
<li><input type='checkbox' id='toc--rudimentary-configuration-confpkg'/><label for='toc--rudimentary-configuration-confpkg'><a href="#rudimentary-configuration-confpkg">2.1. Confpkg</a></label>
<ul>
<li><a href="#motivation">2.1.1. Motivation</a></li>
<li><a href="#design">2.1.2. Design</a></li>
<li><a href="#preparation">2.1.3. Preparation</a></li>
<li><a href="#setup">2.1.4. Setup</a></li>
<li><a href="#package-generation">2.1.5. Package generation</a></li>
<li><a href="#identify-cross-package">2.1.6. Identify cross-package dependencies</a></li>
<li><a href="#commenting-out-package">2.1.7. Commenting out <code>package!</code> statements</a></li>
<li><a href="#creating-config-file">2.1.8. Creating the config file</a></li>
<li><a href="#quieter-output">2.1.9. Quieter output</a></li>
<li><a href="#reporting-load-time">2.1.10. Reporting load time information</a></li>
<li><a href="#finalise">2.1.11. Finalise</a></li>
<li><a href="#bootstrap">2.1.12. Bootstrap</a></li>
</ul>
</li>
<li><a href="#personal-information">2.2. Personal Information</a></li>
<li><input type='checkbox' id='toc--better-defaults'/><label for='toc--better-defaults'><a href="#better-defaults">2.3. Better defaults</a></label>
<ul>
<li><a href="#simple-settings">2.3.1. Simple settings</a></li>
<li><a href="#frame-sizing">2.3.2. Frame sizing</a></li>
<li><a href="#auto-customisations">2.3.3. Auto-customisations</a></li>
<li><a href="#windows">2.3.4. Windows</a></li>
<li><input type='checkbox' id='toc--hippie-expand'/><label for='toc--hippie-expand'><a href="#hippie-expand">2.3.5. Hippie expand</a></label>
<ul>
<li><a href="#expansion-prioritisation">2.3.5.1. Expansion prioritisation</a></li>
<li><a href="#suffix-stripping">2.3.5.2. Suffix stripping</a></li>
</ul>
</li>
<li><a href="#buffer-defaults">2.3.6. Buffer defaults</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--doom-configuration'/><label for='toc--doom-configuration'><a href="#doom-configuration">2.4. Doom configuration</a></label>
<ul>
<li><input type='checkbox' id='toc--modules'/><label for='toc--modules'><a href="#modules">2.4.1. Modules</a></label>
<ul>
<li><a href="#structure">2.4.1.1. Structure</a></li>
<li><a href="#interface">2.4.1.2. Interface</a></li>
<li><a href="#language-support">2.4.1.3. Language support</a></li>
<li><a href="#input">2.4.1.4. Input</a></li>
<li><a href="#everything-emacs">2.4.1.5. Everything in Emacs</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--profiles'/><label for='toc--profiles'><a href="#profiles">2.4.2. Profiles</a></label>
<ul>
<li><a href="#org-development-profile">2.4.2.1. Org development profile</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--visual-settings'/><label for='toc--visual-settings'><a href="#visual-settings">2.4.3. Visual Settings</a></label>
<ul>
<li><input type='checkbox' id='toc--font-face'/><label for='toc--font-face'><a href="#font-face">2.4.3.1. Font Face</a></label>
<ul>
<li><a href="#setting-fonts">2.4.3.1.1. Setting fonts</a></li>
<li><a href="#emojis">2.4.3.1.2. Emojis</a></li>
<li><a href="#checking-system">2.4.3.1.3. Checking the system</a></li>
</ul>
</li>
<li><a href="#theme">2.4.3.2. Theme</a></li>
<li><a href="#line-numbers">2.4.3.3. Line numbers</a></li>
</ul>
</li>
<li><a href="#some-helper-macros">2.4.4. Some helper macros</a></li>
<li><a href="#allow-babel-execution">2.4.5. Allow babel execution in <span class='acr'>CLI</span> actions</a></li>
<li><a href="#elisp-repl">2.4.6. Elisp <span class='acr'>REPL</span></a></li>
<li><a href="#htmlize-command">2.4.7. Htmlize command</a></li>
<li><a href="#org-buffer-creation">2.4.8. Org buffer creation</a></li>
<li><input type='checkbox' id='toc--dashboard'/><label for='toc--dashboard'><a href="#dashboard">2.4.9. Dashboard</a></label>
<ul>
<li><a href="#fancy-splash-screen">2.4.9.1. A fancy splash screen</a></li>
<li><a href="#ascii-banner">2.4.9.2. <span class='acr'>ASCII</span> banner</a></li>
<li><a href="#splash-phrases">2.4.9.3. Splash phrases</a></li>
<li><a href="#quick-actions">2.4.9.4. Quick actions</a></li>
<li><a href="#putting-it-all">2.4.9.5. Putting it all together</a></li>
</ul>
</li>
<li><a href="#config-doctor">2.4.10. Config doctor</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--other-things'/><label for='toc--other-things'><a href="#other-things">2.5. Other things</a></label>
<ul>
<li><input type='checkbox' id='toc--editor-interaction'/><label for='toc--editor-interaction'><a href="#editor-interaction">2.5.1. Editor interaction</a></label>
<ul>
<li><a href="#mouse-buttons">2.5.1.1. Mouse buttons</a></li>
</ul>
</li>
<li><a href="#window-title">2.5.2. Window title</a></li>
<li><a href="#systemd-daemon">2.5.3. Systemd daemon</a></li>
<li><a href="#emacs-client-wrapper">2.5.4. Emacs client wrapper</a></li>
<li><a href="#prompt-run-setup">2.5.5. Prompt to run setup script</a></li>
<li><a href="#grabbing-source-block">2.5.6. Grabbing source block content as a string</a></li>
</ul>
</li>
</ul>
</li>
<li><input type='checkbox' id='toc--packages'/><label for='toc--packages'><a href="#packages">3. Packages</a></label>
<ul>
<li><input type='checkbox' id='toc--loading-instructions'/><label for='toc--loading-instructions'><a href="#loading-instructions">3.1. Loading instructions</a></label>
<ul>
<li><a href="#packages-melpa-elpa">3.1.1. Packages in <span class='acr'>MELPA</span>/<span class='acr'>ELPA</span>/emacsmirror</a></li>
<li><a href="#packages-from-git">3.1.2. Packages from git repositories</a></li>
<li><a href="#disabling-built-packages">3.1.3. Disabling built-in packages</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--convenience'/><label for='toc--convenience'><a href="#convenience">3.2. Convenience</a></label>
<ul>
<li><a href="#avy">3.2.1. Avy</a></li>
<li><a href="#rotate-window-management">3.2.2. Rotate (window management)</a></li>
<li><a href="#emacs-everywhere">3.2.3. Emacs Everywhere</a></li>
<li><a href="#which-key">3.2.4. Which-key</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--tools'/><label for='toc--tools'><a href="#tools">3.3. Tools</a></label>
<ul>
<li><a href="#abbrev">3.3.1. Abbrev</a></li>
<li><a href="#very-large-files">3.3.2. Very large files</a></li>
<li><a href="#eros">3.3.3. Eros</a></li>
<li><a href="#evil">3.3.4. <span class='acr'>EVIL</span></a></li>
<li><a href="#gptel">3.3.5. GPTel</a></li>
<li><a href="#headlice">3.3.6. Headlice</a></li>
<li><a href="#consult">3.3.7. Consult</a></li>
<li><input type='checkbox' id='toc--magit'/><label for='toc--magit'><a href="#magit">3.3.8. Magit</a></label>
<ul>
<li><a href="#easier-forge-remotes">3.3.8.1. Easier forge remotes</a></li>
<li><a href="#commit-message-templates">3.3.8.2. Commit message templates</a></li>
<li><a href="#magit-delta">3.3.8.3. Magit delta</a></li>
</ul>
</li>
<li><a href="#mpris">3.3.9. <span class='acr'>MPRIS</span></a></li>
<li><a href="#smerge">3.3.10. Smerge</a></li>
<li><a href="#corfu">3.3.11. Corfu</a></li>
<li><a href="#projectile">3.3.12. Projectile</a></li>
<li><input type='checkbox' id='toc--jinx'/><label for='toc--jinx'><a href="#jinx">3.3.13. Jinx</a></label>
<ul>
<li><a href="#configuration">3.3.13.1. Configuration</a></li>
<li><a href="#autocorrect">3.3.13.2. Autocorrect</a></li>
<li><input type='checkbox' id='toc--downloading-dictionaries'/><label for='toc--downloading-dictionaries'><a href="#downloading-dictionaries">3.3.13.3. Downloading dictionaries</a></label>
<ul>
<li><a href="#hunspell">3.3.13.3.1. Hunspell</a></li>
<li><a href="#aspell">3.3.13.3.2. Aspell</a></li>
</ul>
</li>
</ul>
</li>
<li><input type='checkbox' id='toc--tramp'/><label for='toc--tramp'><a href="#tramp">3.3.14. <span class='acr'>TRAMP</span></a></label>
<ul>
<li><a href="#prompt-recognition">3.3.14.1. Prompt recognition</a></li>
<li><input type='checkbox' id='toc--troubleshooting'/><label for='toc--troubleshooting'><a href="#troubleshooting">3.3.14.2. Troubleshooting</a></label>
<ul>
<li><a href="#zsh">3.3.14.2.1. Zsh</a></li>
</ul>
</li>
<li><a href="#guix">3.3.14.3. Guix</a></li>
</ul>
</li>
<li><a href="#auto-activating-snippets">3.3.15. Auto activating snippets</a></li>
<li><a href="#screenshot">3.3.16. Screenshot</a></li>
<li><a href="#etrace">3.3.17. Etrace</a></li>
<li><a href="#yasnippet">3.3.18. YASnippet</a></li>
<li><a href="#string-inflection">3.3.19. String inflection</a></li>
<li><a href="#smart-parentheses">3.3.20. Smart parentheses</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--visuals'/><label for='toc--visuals'><a href="#visuals">3.4. Visuals</a></label>
<ul>
<li><a href="#info-colours">3.4.1. Info colours</a></li>
<li><a href="#modus-themes">3.4.2. Modus themes</a></li>
<li><a href="#spacemacs-themes">3.4.3. Spacemacs themes</a></li>
<li><a href="#theme-magic">3.4.4. Theme magic</a></li>
<li><a href="#simple-comment-markup">3.4.5. Simple comment markup</a></li>
<li><input type='checkbox' id='toc--doom-modeline'/><label for='toc--doom-modeline'><a href="#doom-modeline">3.4.6. Doom modeline</a></label>
<ul>
<li><a href="#modified-buffer-colour">3.4.6.1. Modified buffer colour</a></li>
<li><a href="#height">3.4.6.2. Height</a></li>
<li><a href="#file-encoding">3.4.6.3. File encoding</a></li>
<li><a href="#analogue-clock">3.4.6.4. Analogue clock</a></li>
<li><a href="#media-player">3.4.6.5. Media player</a></li>
<li><a href="#pdf-modeline">3.4.6.6. <span class='acr'>PDF</span> modeline</a></li>
</ul>
</li>
<li><a href="#keycast">3.4.7. Keycast</a></li>
<li><a href="#screencast">3.4.8. Screencast</a></li>
<li><input type='checkbox' id='toc--mixed-pitch'/><label for='toc--mixed-pitch'><a href="#mixed-pitch">3.4.9. Mixed pitch</a></label>
<ul>
<li><a href="#variable-pitch-serif">3.4.9.1. Variable pitch serif font</a></li>
</ul>
</li>
<li><a href="#marginalia">3.4.10. Marginalia</a></li>
<li><a href="#centaur-tabs">3.4.11. Centaur Tabs</a></li>
<li><a href="#nerd-icons">3.4.12. Nerd Icons</a></li>
<li><a href="#prettier-page-breaks">3.4.13. Prettier page breaks</a></li>
<li><a href="#writeroom">3.4.14. Writeroom</a></li>
<li><a href="#treemacs">3.4.15. Treemacs</a></li>
<li><a href="#visual-fill-column">3.4.16. Visual fill column</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--frivolities'/><label for='toc--frivolities'><a href="#frivolities">3.5. Frivolities</a></label>
<ul>
<li><a href="#xkcd">3.5.1. xkcd</a></li>
<li><a href="#selectric">3.5.2. Selectric</a></li>
<li><a href="#wttrin">3.5.3. Wttrin</a></li>
<li><a href="#spray">3.5.4. Spray</a></li>
<li><a href="#elcord">3.5.5. Elcord</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--file-types'/><label for='toc--file-types'><a href="#file-types">3.6. File types</a></label>
<ul>
<li><a href="#systemd">3.6.1. Systemd</a></li>
</ul>
</li>
</ul>
</li>
<li><input type='checkbox' id='toc--applications'/><label for='toc--applications'><a href="#applications">4. Applications</a></label>
<ul>
<li><a href="#ebooks">4.1. Ebooks</a></li>
<li><input type='checkbox' id='toc--calculator'/><label for='toc--calculator'><a href="#calculator">4.2. Calculator</a></label>
<ul>
<li><a href="#calctex">4.2.1. CalcTeX</a></li>
<li><a href="#defaults">4.2.2. Defaults</a></li>
<li><a href="#embedded-calc">4.2.3. Embedded calc</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--newsfeed'/><label for='toc--newsfeed'><a href="#newsfeed">4.3. Newsfeed</a></label>
<ul>
<li><a href="#keybindings">4.3.1. Keybindings</a></li>
<li><a href="#usability-enhancements">4.3.2. Usability enhancements</a></li>
<li><a href="#visual-enhancements">4.3.3. Visual enhancements</a></li>
<li><a href="#functionality-enhancements">4.3.4. Functionality enhancements</a></li>
</ul>
</li>
<li><a href="#dictionary">4.4. Dictionary</a></li>
<li><input type='checkbox' id='toc--mail'/><label for='toc--mail'><a href="#mail">4.5. Mail</a></label>
<ul>
<li><input type='checkbox' id='toc--fetching'/><label for='toc--fetching'><a href="#fetching">4.5.1. Fetching</a></label>
<ul>
<li><a href="#rebuild-mail-index">4.5.1.1. Rebuild mail index while using mu4e</a></li>
<li><a href="#config-transcoding-service">4.5.1.2. Config transcoding &amp; service management</a></li>
<li><a href="#fetching-systemd">4.5.1.3. Systemd</a></li>
</ul>
</li>
<li><a href="#indexing-searching">4.5.2. Indexing/Searching</a></li>
<li><input type='checkbox' id='toc--sending'/><label for='toc--sending'><a href="#sending">4.5.3. Sending</a></label>
<ul>
<li><a href="#system-hackery">4.5.3.1. System hackery</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--mu4e'/><label for='toc--mu4e'><a href="#mu4e">4.5.4. Mu4e</a></label>
<ul>
<li><a href="#viewing-mail">4.5.4.1. Viewing Mail</a></li>
<li><a href="#sending-mail">4.5.4.2. Sending Mail</a></li>
<li><input type='checkbox' id='toc--working-with-org'/><label for='toc--working-with-org'><a href="#working-with-org">4.5.4.3. Working with the Org mailing list</a></label>
<ul>
<li><a href="#adding-x-woof">4.5.4.3.1. Adding <kbd>X-Woof</kbd> headers</a></li>
<li><a href="#patch-workflow">4.5.4.3.2. Patch workflow</a></li>
<li><a href="#mail-list-archive">4.5.4.3.3. Mail list archive links</a></li>
<li><a href="#setup-when-composing">4.5.4.3.4. Setup when composing a new email</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org-msg">4.5.5. Org Msg</a></li>
</ul>
</li>
</ul>
</li>
<li><input type='checkbox' id='toc--language-configuration'/><label for='toc--language-configuration'><a href="#language-configuration">5. Language configuration</a></label>
<ul>
<li><input type='checkbox' id='toc--general'/><label for='toc--general'><a href="#general">5.1. General</a></label>
<ul>
<li><a href="#file-templates">5.1.1. File Templates</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--plaintext'/><label for='toc--plaintext'><a href="#plaintext">5.2. Plaintext</a></label>
<ul>
<li><a href="#ansi-colours">5.2.1. Ansi colours</a></li>
<li><a href="#margin-without-line">5.2.2. Margin without line numbers</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--org'/><label for='toc--org'><a href="#org">5.3. Org</a></label>
<ul>
<li><input type='checkbox' id='toc--system-config'/><label for='toc--system-config'><a href="#system-config">5.3.1. System config</a></label>
<ul>
<li><a href="#mime-types">5.3.1.1. Mime types</a></li>
<li><a href="#git-diffs">5.3.1.2. Git diffs</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--org-packages'/><label for='toc--org-packages'><a href="#org-packages">5.3.2. Packages</a></label>
<ul>
<li><a href="#org-itself">5.3.2.1. Org itself</a></li>
<li><input type='checkbox' id='toc--packages-visuals'/><label for='toc--packages-visuals'><a href="#packages-visuals">5.3.2.2. Visuals</a></label>
<ul>
<li><a href="#org-modern">5.3.2.2.1. Org Modern</a></li>
<li><a href="#emphasis-markers">5.3.2.2.2. Emphasis markers</a></li>
<li><a href="#heading-structure">5.3.2.2.3. Heading structure</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--extra-functionality'/><label for='toc--extra-functionality'><a href="#extra-functionality">5.3.2.3. Extra functionality</a></label>
<ul>
<li><a href="#julia-support">5.3.2.3.1. Julia support</a></li>
<li><a href="#http-requests">5.3.2.3.2. <span class='acr'>HTTP</span> requests</a></li>
<li><a href="#rss-feeds">5.3.2.3.3. <span class='acr'>RSS</span> feeds</a></li>
<li><a href="#transclusion">5.3.2.3.4. Transclusion</a></li>
<li><a href="#heading-graph">5.3.2.3.5. Heading graph</a></li>
<li><a href="#cooking-recipes">5.3.2.3.6. Cooking recipes</a></li>
<li><a href="#importing-with-pandoc">5.3.2.3.7. Importing with Pandoc</a></li>
<li><a href="#glossaries-more">5.3.2.3.8. Glossaries and more</a></li>
<li><a href="#document-comparison">5.3.2.3.9. Document comparison</a></li>
<li><a href="#org-music">5.3.2.3.10. Org music</a></li>
</ul>
</li>
</ul>
</li>
<li><input type='checkbox' id='toc--behaviour'/><label for='toc--behaviour'><a href="#behaviour">5.3.3. Behaviour</a></label>
<ul>
<li><a href="#tweaking-defaults">5.3.3.1. Tweaking defaults</a></li>
<li><input type='checkbox' id='toc--behaviour-extra-functionality'/><label for='toc--behaviour-extra-functionality'><a href="#behaviour-extra-functionality">5.3.3.2. Extra functionality</a></label>
<ul>
<li><a href="#utility-zero-width">5.3.3.2.1. The utility of zero-width spaces</a></li>
<li><a href="#list-bullet-sequence">5.3.3.2.2. List bullet sequence</a></li>
<li><a href="#easier-file-links">5.3.3.2.3. Easier file links</a></li>
<li><a href="#citation">5.3.3.2.4. Citation</a></li>
<li><a href="#cdlatex-environments">5.3.3.2.5. cdlatex environments</a></li>
<li><a href="#lsp-support-src">5.3.3.2.6. <span class='acr'>LSP</span> support in <code>src</code> blocks</a></li>
<li><a href="#view-exported-file">5.3.3.2.7. View exported file</a></li>
</ul>
</li>
<li><a href="#super-agenda">5.3.3.3. Super agenda</a></li>
<li><a href="#capture">5.3.3.4. Capture</a></li>
<li><input type='checkbox' id='toc--roam'/><label for='toc--roam'><a href="#roam">5.3.3.5. Roam</a></label>
<ul>
<li><a href="#basic-settings">5.3.3.5.1. Basic settings</a></li>
<li><a href="#modeline-file-name">5.3.3.5.2. Modeline file name</a></li>
<li><a href="#graph-view">5.3.3.5.3. Graph view</a></li>
</ul>
</li>
<li><a href="#nicer-org-return">5.3.3.6. Nicer <code>org-return</code></a></li>
<li><a href="#snippet-helpers">5.3.3.7. Snippet Helpers</a></li>
<li><a href="#translate-capital-keywords">5.3.3.8. Translate capital keywords (old) to lower case (new)</a></li>
<li><input type='checkbox' id='toc--extra-links'/><label for='toc--extra-links'><a href="#extra-links">5.3.3.9. Extra links</a></label>
<ul>
<li><a href="#extra-links-xkcd">5.3.3.9.1. xkcd</a></li>
<li><a href="#youtube">5.3.3.9.2. YouTube</a></li>
</ul>
</li>
<li><a href="#fix-problematic-hooks">5.3.3.10. Fix problematic hooks</a></li>
<li><a href="#flycheck-with-org">5.3.3.11. Flycheck with org-lint</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--org-visuals'/><label for='toc--org-visuals'><a href="#org-visuals">5.3.4. Visuals</a></label>
<ul>
<li><a href="#font-display">5.3.4.1. Font Display</a></li>
<li><a href="#reduced-text-indent">5.3.4.2. Reduced text indent</a></li>
<li><a href="#fontifying-inline-src">5.3.4.3. Fontifying inline src blocks</a></li>
<li><a href="#symbols">5.3.4.4. Symbols</a></li>
<li><input type='checkbox' id='toc--latex-fragments'/><label for='toc--latex-fragments'><a href="#latex-fragments">5.3.4.5. LaTeX Fragments</a></label>
<ul>
<li><a href="#prettier-highlighting">5.3.4.5.1. Prettier highlighting</a></li>
<li><a href="#automatic-previewing">5.3.4.5.2. Automatic previewing</a></li>
<li><a href="#prettier-rendering">5.3.4.5.3. Prettier rendering</a></li>
<li><a href="#rendering-speed-tests">5.3.4.5.4. Rendering speed tests</a></li>
</ul>
</li>
<li><a href="#org-plot">5.3.4.6. Org Plot</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--exporting'/><label for='toc--exporting'><a href="#exporting">5.3.5. Exporting</a></label>
<ul>
<li><a href="#general-settings">5.3.5.1. General settings</a></li>
<li><a href="#acronym-formatting">5.3.5.2. Acronym formatting</a></li>
<li><a href="#nicer-generated-heading">5.3.5.3. Nicer generated heading <span class='acr'>ID</span><small>s</small></a></li>
<li><a href="#strip-zero-width">5.3.5.4. Strip zero width spaces</a></li>
<li><a href="#exporting-org-code">5.3.5.5. Exporting Org code</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--html-export'/><label for='toc--html-export'><a href="#html-export">5.3.6. <span class='acr'>HTML</span> Export</a></label>
<ul>
<li><a href="#extra-header-content">5.3.6.1. Extra header content</a></li>
<li><a href="#custom-css-js">5.3.6.2. Custom <span class='acr'>CSS</span>/<span class='acr'>JS</span></a></li>
<li><a href="#collapsable-src-example">5.3.6.3. Collapsable src and example blocks</a></li>
<li><a href="#include-extra-font">5.3.6.4. Include extra font-locking in htmlize</a></li>
<li><a href="#handle-table-overflow">5.3.6.5. Handle table overflow</a></li>
<li><a href="#toc-collapsable-tree">5.3.6.6. <span class='acr'>TOC</span> as a collapsable tree</a></li>
<li><a href="#make-verbatim-different">5.3.6.7. Make verbatim different to code</a></li>
<li><a href="#change-checkbox-type">5.3.6.8. Change checkbox type</a></li>
<li><a href="#extra-special-strings">5.3.6.9. Extra special strings</a></li>
<li><a href="#header-anchors">5.3.6.10. Header anchors</a></li>
<li><a href="#link-previews">5.3.6.11. Link previews</a></li>
<li><input type='checkbox' id='toc--latex-rendering'/><label for='toc--latex-rendering'><a href="#latex-rendering">5.3.6.12. LaTeX Rendering</a></label>
<ul>
<li><a href="#pre-rendered">5.3.6.12.1. Pre-rendered</a></li>
<li><a href="#mathjax">5.3.6.12.2. MathJax</a></li>
</ul>
</li>
</ul>
</li>
<li><input type='checkbox' id='toc--latex-export'/><label for='toc--latex-export'><a href="#latex-export">5.3.7. LaTeX Export</a></label>
<ul>
<li><a href="#compiling">5.3.7.1. Compiling</a></li>
<li><a href="#nicer-checkboxes">5.3.7.2. Nicer checkboxes</a></li>
<li><a href="#class-templates">5.3.7.3. Class templates</a></li>
<li><input type='checkbox' id='toc--cleverer-preamble'/><label for='toc--cleverer-preamble'><a href="#cleverer-preamble">5.3.7.4. A cleverer preamble</a></label>
<ul>
<li><a href="#use-case">5.3.7.4.1. Use case</a></li>
<li><a href="#conditional-content">5.3.7.4.2. Conditional Content</a></li>
<li><a href="#content-feature-preamble">5.3.7.4.3. Content-feature-preamble association</a></li>
<li><a href="#content-feature-graph">5.3.7.4.4. Content-feature graph</a></li>
<li><a href="#adding-xcolor-an">5.3.7.4.5. Adding xcolor as an unconditional package</a></li>
</ul>
</li>
<li><a href="#font-collections">5.3.7.5. Font collections</a></li>
<li><input type='checkbox' id='toc--maths-notation-conveniences'/><label for='toc--maths-notation-conveniences'><a href="#maths-notation-conveniences">5.3.7.6. Maths notation conveniences</a></label>
<ul>
<li><a href="#latex-export-maths">5.3.7.6.1. Packages</a></li>
<li><a href="#custom-delimiters">5.3.7.6.2. Custom delimiters</a></li>
<li><a href="#number-sets">5.3.7.6.3. Number sets</a></li>
<li><a href="#derivatives">5.3.7.6.4. Derivatives</a></li>
<li><a href="#common-operators">5.3.7.6.5. Common operators</a></li>
<li><a href="#slanted-inequalities">5.3.7.6.6. Slanted inequalities</a></li>
<li><a href="#alignment-matrix-columns">5.3.7.6.7. Alignment of matrix columns</a></li>
<li><a href="#slanted-derivative-d">5.3.7.6.8. Slanted derivative "d"</a></li>
</ul>
</li>
<li><a href="#cover-page">5.3.7.7. Cover page</a></li>
<li><a href="#condensed-lists">5.3.7.8. Condensed lists</a></li>
<li><a href="#upright-parentheses-italic">5.3.7.9. Upright parentheses in italic text</a></li>
<li><a href="#pretty-code-blocks">5.3.7.10. Pretty code blocks</a></li>
<li><a href="#julia-code-blocks">5.3.7.11. Julia code blocks</a></li>
<li><a href="#latex-export-emojis">5.3.7.12. Emojis</a></li>
<li><a href="#remove-non-ascii">5.3.7.13. Remove non-ascii chars</a></li>
<li><a href="#normal-spaces-after">5.3.7.14. Normal spaces after abbreviations</a></li>
<li><a href="#latex-export-extra">5.3.7.15. Extra special strings</a></li>
<li><a href="#chameleon-aka-match">5.3.7.16. Chameleon &#x2014; aka. match theme</a></li>
<li><a href="#latex-export-make">5.3.7.17. Make verbatim different to code</a></li>
<li><a href="#check-required-packages">5.3.7.18. Check for required packages</a></li>
</ul>
</li>
<li><a href="#beamer-export">5.3.8. Beamer Export</a></li>
<li><a href="#reveal-export">5.3.9. Reveal export</a></li>
<li><a href="#ascii-export">5.3.10. <span class='acr'>ASCII</span> export</a></li>
<li><input type='checkbox' id='toc--markdown-export'/><label for='toc--markdown-export'><a href="#markdown-export">5.3.11. Markdown Export</a></label>
<ul>
<li><a href="#gfm">5.3.11.1. <span class='acr'>GFM</span></a></li>
<li><a href="#character-substitutions">5.3.11.2. Character substitutions</a></li>
</ul>
</li>
<li><a href="#babel">5.3.12. Babel</a></li>
<li><a href="#ess">5.3.13. <span class='acr'>ESS</span></a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--latex'/><label for='toc--latex'><a href="#latex">5.4. LaTeX</a></label>
<ul>
<li><a href="#be-implemented-ideas">5.4.1. To-be-implemented ideas</a></li>
<li><a href="#compilation">5.4.2. Compilation</a></li>
<li><input type='checkbox' id='toc--latex-snippet-helpers'/><label for='toc--latex-snippet-helpers'><a href="#latex-snippet-helpers">5.4.3. Snippet helpers</a></label>
<ul>
<li><a href="#template">5.4.3.1. Template</a></li>
<li><a href="#deliminators">5.4.3.2. Deliminators</a></li>
</ul>
</li>
<li><a href="#editor-visuals">5.4.4. Editor visuals</a></li>
<li><input type='checkbox' id='toc--math-input'/><label for='toc--math-input'><a href="#math-input">5.4.5. Math input</a></label>
<ul>
<li><a href="#cdlatex">5.4.5.1. CDLaTeX</a></li>
<li><a href="#laas">5.4.5.2. <span class='acr'>LAAS</span></a></li>
</ul>
</li>
<li><a href="#synctex">5.4.6. SyncTeX</a></li>
<li><a href="#fixes">5.4.7. Fixes</a></li>
</ul>
</li>
<li><a href="#python">5.5. Python</a></li>
<li><input type='checkbox' id='toc--pdf'/><label for='toc--pdf'><a href="#pdf">5.6. <span class='acr'>PDF</span></a></label>
<ul>
<li><a href="#mupdf">5.6.1. MuPDF</a></li>
<li><a href="#terminal-viewing">5.6.2. Terminal viewing</a></li>
</ul>
</li>
<li><input type='checkbox' id='toc--r'/><label for='toc--r'><a href="#r">5.7. R</a></label>
<ul>
<li><a href="#r-editor-visuals">5.7.1. Editor Visuals</a></li>
</ul>
</li>
<li><a href="#julia">5.8. Julia</a></li>
<li><a href="#datatoml-files">5.9. Data.toml files</a></li>
<li><a href="#graphviz">5.10. Graphviz</a></li>
<li><a href="#markdown">5.11. Markdown</a></li>
<li><a href="#beancount">5.12. Beancount</a></li>
<li><a href="#gimp-palette-files">5.13. <span class='acr'>GIMP</span> Palette files</a></li>
<li><input type='checkbox' id='toc--snippets'/><label for='toc--snippets'><a href="#snippets">5.14. Snippets</a></label>
<ul>
<li><a href="#latex-mode">5.14.1. Latex mode</a></li>
<li><a href="#markdown-mode">5.14.2. Markdown mode</a></li>
<li><a href="#org-mode">5.14.3. Org mode</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<a href="https://code.tecosaur.net/tec/emacs-config/"
   style="font-family: 'Open Sans'; background-image: none; color: inherit;
          text-decoration: none; position: relative; top: clamp(-26px, calc(1280px - 100vw), 0px); opacity: 0.7;">
  <img src="https://git-scm.com/images/logos/downloads/Git-Icon-Black.svg"
       class="invertible" alt="Git"
       style="height: 1em; position: relative; top: 0.1em;">
  Repository</a>&ensp;
<a href="https://liberapay.com/tec"
   style="position: relative;top: clamp(-22px, calc(1280px - 100vw), 0px);">
  <img src="https://shields.io/badge/support%20my%20efforts-f6c915?logo=Liberapay&style=flat&logoColor=black"
       class="invertible" alt="Support my efforts"
       style="border-radius: 4px; opacity: 0.85;"></a>

<blockquote>
<p>
Let us change our traditional attitude to the construction of programs:
Instead of imagining that our main task is to instruct a computer what to do,
let us concentrate rather on explaining to human beings what we want a
computer to do. &#x2014; Donald Knuth
</p>
</blockquote>
<div id="outline-container-introduction" class="outline-2">
<h2 id="introduction"><span class="section-number-2">1.</span> Introduction<a aria-hidden="true" href="#introduction">#</a> </h2>
<div class="outline-text-2" id="text-1">
<p>
Customising an editor can be very rewarding &#x2026; until you have to leave it.
For years I have been looking for ways to avoid this pain.
Then I discovered <a href="https://github.com/cknadler/vim-anywhere">vim-anywhere</a>, and found that it had an Emacs companion,
<a href="https://github.com/zachcurry/emacs-anywhere">emacs-anywhere</a>. To me, this looked most attractive.
</p>

<p>
Separately, online I have seen the following statement enough times I think it's a catchphrase
</p>
<blockquote>
<p>
Redditor 1: I just discovered this thing, isn't it cool. <br>
Redditor 2: Oh, there's an Emacs mode for that.
</p>
</blockquote>

<p>
This was enough for me to install Emacs, but I soon learned there are <a href="https://github.com/remacs/remacs#why-emacs">far more
compelling reasons</a> to keep using it.
</p>

<p>
I tried out the <kbd>spacemacs</kbd> distribution a bit, but it wasn't quite to my liking.
Then I heard about <kbd>doom emacs</kbd> and thought I may as well give that a try.
<span class='acr'>TLDR</span>; it's great.
</p>

<p>
Now I've discovered the wonders of literate programming, and am becoming more
settled by the day. This is both my config, and a cautionary tale (just replace
"Linux" with "Emacs" in the comic below).
</p>

<p>

</p>
</div>
<div id="outline-container-why-emacs" class="outline-3">
<h3 id="why-emacs"><span class="section-number-3">1.1.</span> Why Emacs?<a aria-hidden="true" href="#why-emacs">#</a> </h3>
<div class="outline-text-3" id="text-1-1">
<p>
Emacs is <a href="https://www.eigenbahn.com/2020/01/12/emacs-is-no-editor">not a text editor</a>, this is a common misnomer. It is far more apt to
describe Emacs as <i>a Lisp machine providing a generic user-centric text
manipulation environment</i>. That's quite a mouthful.
In simpler terms one can think of Emacs as a platform for text-related
applications. It's a vague and generic definition because Emacs itself is
generic.
</p>

<p>
Good with text. How far does that go? A lot further than one initially thinks:
</p>
<ul class="org-ul">
<li><a href="https://orgmode.org/">Task planning</a></li>
<li><a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Dired.html">File management</a></li>
<li><a href="https://github.com/akermu/emacs-libvterm">Terminal emulation</a></li>
<li><a href="https://www.djcbsoftware.nl/code/mu/mu4e.html">Email client</a></li>
<li><a href="https://www.gnu.org/software/tramp/">Remote server tool</a></li>
<li><a href="https://magit.vc/">Git frontend</a></li>
<li>Web <a href="https://github.com/pashky/restclient.el">client</a>/<a href="https://github.com/skeeto/emacs-web-server">server</a></li>
<li>and more&#x2026;</li>
</ul>

<p>
Ideally, one may use Emacs as <i>the</i> interface to perform <kbd>input → transform →
output</kbd> cycles, i.e. form a bridge between the human mind and information
manipulation.
</p>
</div>
<div id="outline-container-enveloping-editor" class="outline-4">
<h4 id="enveloping-editor"><span class="section-number-4">1.1.1.</span> The enveloping editor<a aria-hidden="true" href="#enveloping-editor">#</a> </h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Emacs allows one to do more in one place than any other application. Why is this
good?
</p>
<ul class="org-ul">
<li>Enables one to complete tasks with a consistent, standard set of keybindings,
<span class='acr'>GUI</span> and editing methods &#x2014; learn once, use everywhere</li>
<li>Reduced context-switching</li>
<li>Compressing the stages of a project &#x2014; a more centralised workflow can progress
with greater ease</li>
<li>Integration between tasks previously relegated to different applications, but
with a common subject &#x2014; e.g. linking to an email in a to-do list</li>
</ul>

<p>
Emacs can be thought of as a platform within which various elements of your
workflow may settle, with the potential for rich integrations between them &#x2014; a
<i>life</i> <span class='acr'>IDE</span> if you will.
</p>

<p>
Today, many aspects of daily computer usage are split between different
applications which act like islands, but this often doesn't mirror how we
<i>actually use</i> our computers. Emacs, if one goes down the rabbit hole, can give
users the power to bridge this gap.
</p>


<figure id="org6088ad8">
<img src="misc/emacs-platform.svg" alt="Graph of possible Emacs task integrations" class="invertible" style="max-width:min(24em,100%)">

<figcaption><span class="figure-number">Figure 1: </span>Some sample workflow integrations that can be used within Emacs</figcaption>
</figure>
</div>
</div>
<div id="outline-container-some-notably-unique" class="outline-4">
<h4 id="some-notably-unique"><span class="section-number-4">1.1.2.</span> Some notably unique features<a aria-hidden="true" href="#some-notably-unique">#</a> </h4>
<div class="outline-text-4" id="text-1-1-2">
<ul class="org-ul">
<li>Recursive editing</li>
<li>Completely introspectable, with pervasive docstrings</li>
<li>Mutable environment, which can be incrementally modified</li>
<li>Functionality without applications</li>
<li>Client-server separation allows for a daemon, giving near-instant perceived
startup time.</li>
</ul>
</div>
</div>
<div id="outline-container-issues" class="outline-4">
<h4 id="issues"><span class="section-number-4">1.1.3.</span> Issues<a aria-hidden="true" href="#issues">#</a> </h4>
<div class="outline-text-4" id="text-1-1-3">
<ul class="org-ul">
<li>Emacs has irritating quirks</li>
<li>Some aspects are showing their age (naming conventions, <span class='acr'>API</span><small>s</small>)</li>
<li>Emacs is (<a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Threads.html">mostly</a>) single-threaded, meaning that when something holds that
thread up the whole application freezes</li>
<li>A few other nuisances</li>
</ul>
</div>
</div>
<div id="outline-container-teach-man-fish" class="outline-4">
<h4 id="teach-man-fish"><span class="section-number-4">1.1.4.</span> Teach a man to fish&#x2026;<a aria-hidden="true" href="#teach-man-fish">#</a> </h4>
<div class="outline-text-4" id="text-1-1-4">
<blockquote>
<p>
Give a man a fish, and you feed him for a day. Teach a man to fish, and you feed
him for a lifetime. &#x2014; Anne Isabella
</p>
</blockquote>

<p>
Most popular editors have a simple and pretty <a href="https://code.visualstudio.com/docs/getstarted/settings">settings interface</a>, filled with
check-boxes, selects, and the occasional text-box. This makes it easy for the
user to pick between common desirable behaviours. To me this is now like <i>giving
a man a fish</i>.
</p>

<p>
What if you want one of those 'check-box' settings to be only on in certain
conditions? Some editors have workspace settings, but that requires you to
manually set the value for <i>every single instance</i>. Urgh, <a href="https://github.com/microsoft/vscode/issues/93153">what</a> <a href="https://github.com/microsoft/vscode/issues/93628">a</a> <a href="https://github.com/microsoft/vscode/issues/5595">pain</a>.
</p>

<p>
What if you could set the value of that 'check-box' setting to be the result of
an arbitrary expression evaluated for each file? This is where an editor like
Emacs comes in.
Configuration for Emacs isn't a list of settings in <span class='acr'>JSON</span> etc. it's <b>an executable
program which modifies the behaviour of the editor to suit your liking</b>.
This is 'teaching a man to fish'.
</p>

<p>
Emacs is built in the same language you configure it in (Emacs <a href="https://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a>, or <a href="https://www.gnu.org/software/emacs/manual/html_node/eintr/">elisp</a>).
It comes with a broad array of useful functions for text-editing, and Doom adds
a few handy little convenience functions.
</p>

<p>
Want to add a keybinding to delete the previous line? It's as easy as
</p>
<details id='keybinding-delete-previous' class='code' open><summary class='named'><span class="name">Keybinding to delete the previous line</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#keybinding-delete-previous'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-string">"C-d"</span>
      (<span class="org-keyword">cmd!</span> (previous-line)
            (kill-line)
            (forward-line)))
</pre>
</div>
</details>

<p>
How about another example, say you want to be presented with a list of currently
open <i>buffers</i> (think files, almost) when you split the window. It's as simple as
</p>
<details id='prompt-buffer-after' class='code' open><summary class='named'><span class="name">Prompt for buffer after split</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prompt-buffer-after'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> prompt-for-buffer (<span class="org-type">&amp;rest</span> _)
  <span class="org-builtin">:after</span> 'window-split (switch-to-buffer))
</pre>
</div>
</details>

<p>
Want to test it out? You don't need to save and restart, you can just <i>evaluate
the expression</i> within your current Emacs instance and try it immediately! This
editor is, after all, a Lisp interpreter.
</p>

<p>
Want to tweak the behaviour? Just re-evaluate your new version &#x2014; it's a
super-tight iteration loop.
</p>
</div>
</div>
</div>
<div id="outline-container-editor-comparison" class="outline-3">
<h3 id="editor-comparison"><span class="section-number-3">1.2.</span> Editor comparison<a aria-hidden="true" href="#editor-comparison">#</a> </h3>
<div class="outline-text-3" id="text-1-2">
<p>

</p>

<p>
Over the years I have tried out (spent at least a year using as my primary
editor) the following applications
</p>
<ul class="org-ul">
<li>Python <span class='acr'>IDLE</span></li>
<li>Komodo Edit</li>
<li>Brackets</li>
<li>VSCode</li>
<li>and now, Emacs</li>
</ul>

<p>
I have attempted to quantify aspects of my impressions of them below.
</p>

<div id='editor-comparison,table--1' class='table'>
<div class='gutter'><a href='#editor-comparison,table--1'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Editor</th>
<th scope="col" class="org-right">Extensibility</th>
<th scope="col" class="org-right">Ecosystem</th>
<th scope="col" class="org-right">Ease of Use</th>
<th scope="col" class="org-right">Comfort</th>
<th scope="col" class="org-right">Completion</th>
<th scope="col" class="org-right">Performance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><span class='acr'>IDLE</span></td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">VSCode</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">3.5</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">Brackets</td>
<td class="org-right">2.5</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">2.5</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">Emacs</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
<td class="org-right">2</td>
<td class="org-right">4</td>
<td class="org-right">3.5</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">Komodo Edit</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
</div></div>


<figure id="orga36f92e">
<img src="misc/editor-comparison.svg" alt="Radar chart comparing my thoughts on a few editors." class="invertible">

</figure>
</div>
</div>
<div id="outline-container-notes-unwary-adventurer" class="outline-3">
<h3 id="notes-unwary-adventurer"><span class="section-number-3">1.3.</span> Notes for the unwary adventurer<a aria-hidden="true" href="#notes-unwary-adventurer">#</a> </h3>
<div class="outline-text-3" id="text-1-3">
<p>
If you like the look of this, that's marvellous, and I'm really happy that I've
made something which you may find interesting, however:
</p>
<div class="warning" id="org8ec2cb4">
<p>
This config is <i>insidious</i>. Copying the whole thing blindly can easily lead to
undesired effects. I recommend copying chunks instead.
</p>

</div>

<p>
If you are so bold as to wish to steal bits of my config (or if I upgrade and
wonder why things aren't working), here's a list of sections which rely on
external setup (i.e. outside of this config).
</p>

<dl class="org-dl">
<dt>dictionary</dt><dd>I've downloaded a custom <a href="http://app.aspell.net/create"><span class='acr'>SCOWL</span></a> dictionary, which I use in .
If this causes issues, just delete the <code class="src src-elisp">(<span class="org-keyword">setq</span> ispell-dictionary ...)</code>
bit.</dd>
</dl>

<p>
There are also a number of files I may tangle to <i>other than</i>
<kbd>{init,config,package}.el</kbd>. The complete list (excluding confpkg generated files)
is as follows:
</p>

<ul class="org-ul">
<li><kbd>~/.config/doom.orgdev/config.el</kbd></li>
<li><kbd>~/.config/doom.orgdev/init.el</kbd></li>
<li><kbd>~/.config/doom.orgdev/packages.el</kbd></li>
<li><kbd>~/.config/doom/cli.el</kbd></li>
<li><kbd>~/.config/doom/doctor.el</kbd></li>
<li><kbd>~/.config/doom/init.el</kbd></li>
<li><kbd>~/.config/doom/misc/mbsync-imapnotify.py</kbd></li>
<li><kbd>~/.config/doom/misc/org-export-header.html</kbd></li>
<li><kbd>~/.config/doom/packages.el</kbd></li>
<li><kbd>~/.config/doom/setup.sh</kbd></li>
<li><kbd>~/.config/emacs/profiles.el</kbd></li>
<li><kbd>~/.config/inkscape/palettes/Emacs Fancy Splash.gpl</kbd></li>
<li><kbd>~/.config/systemd/user/emacs.service</kbd></li>
<li><kbd>~/.config/systemd/user/goimapnotify@.service</kbd></li>
<li><kbd>~/.config/systemd/user/mbsync.service</kbd></li>
<li><kbd>~/.config/systemd/user/mbsync.timer</kbd></li>
<li><kbd>~/.local/bin/e</kbd></li>
<li><kbd>~/.local/bin/emacsmail</kbd></li>
<li><kbd>~/.local/share/applications/emacs-client.desktop</kbd></li>
<li><kbd>~/.local/share/applications/emacsmail.desktop</kbd></li>
<li><kbd>~/.local/share/mime/packages/org.xml</kbd></li>
</ul>

<p>
Oh, did I mention that I started this config when I didn't know any <kbd>elisp</kbd>, and
this whole thing is a hack job? If you can suggest any improvements, please do
so, no matter how much criticism you include I'll appreciate it :)
</p>

<p>

</p>
</div>
<div id="outline-container-extra-requirements" class="outline-4">
<h4 id="extra-requirements"><span class="section-number-4">1.3.1.</span> Extra Requirements<a aria-hidden="true" href="#extra-requirements">#</a> </h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
The lovely <code>doom doctor</code> is good at diagnosing most missing things, but here are a
few extras.
</p>
<ul class="org-ul">
<li>A <a href="https://www.tug.org/texlive/">LaTeX Compiler</a> is required for the mathematics rendering performed in <a href="#org">Org</a>,
and by <a href="#calctex">CalcTeX</a>.</li>
<li>I use the <a href="https://overpassfont.org/">Overpass</a> font as a go-to sans serif.
It's used as my <code>doom-variable-pitch-font</code> and in the graph generated
by <a href="#roam">Roam</a>.
I have chosen it because it possesses a few characteristics I consider
desirable, namely:
<ul class="org-ul">
<li>A clean, and legible style. Highway-style fonts tend to be designed to be
clear at a glance, and work well with a thicker weight, and this is inspired
by <i>Highway Gothic</i>.</li>
<li>It's slightly quirky. Look at the diagonal cut on stems for example.
Helvetica is a masterful design, but I like a bit more pizzazz now and then.</li>
</ul></li>
<li>A few <span class='acr'>LSP</span> servers. Take a look at <a href="init.el">init.el</a> to see which modules have the <code>+lsp</code> flag.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-current-issues" class="outline-3">
<h3 id="current-issues"><span class="section-number-3">1.4.</span> Current Issues<a aria-hidden="true" href="#current-issues">#</a> </h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-magit-push-daemon" class="outline-4">
<h4 id="magit-push-daemon"><span class="section-number-4">1.4.1.</span> Magit push in daemon<a aria-hidden="true" href="#magit-push-daemon">#</a> </h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
Quite often trying to push to a remote in the Emacs daemon produces as error like this:
</p>

<details id='org7531fb1' class='code' open>
<summary></summary>
<div class='gutter'><a href='#org7531fb1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="org7531fb1">
128 git … push -v origin refs/heads/master\:refs/heads/master
Pushing to git@github.com:tecosaur/emacs-config.git

fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
</pre>

</details>
</div>
</div>
<div id="outline-container-unread-emails-doesnt" class="outline-4">
<h4 id="unread-emails-doesnt"><span class="section-number-4">1.4.2.</span> Unread emails doesn't work across Emacs instances<a aria-hidden="true" href="#unread-emails-doesnt">#</a> </h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
It would be nice if it did, so that I could have the Emacs-daemon hold the
active mu4e session, but still get that information. In this case I'd want to
change the action to open the Emacs daemon, but it should be possible.
</p>

<p>
This would probably involve hooking into the daemon's modeline update function
to write to a temporary file, and having a file watcher started in other Emacs
instances, in a similar manner to <a href="#rebuild-mail-index">Rebuild mail index while using mu4e</a>.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-rudimentary-configuration" class="outline-2">
<h2 id="rudimentary-configuration"><span class="section-number-2">2.</span> Rudimentary configuration<a aria-hidden="true" href="#rudimentary-configuration">#</a> </h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-rudimentary-configuration-confpkg" class="outline-3">
<h3 id="rudimentary-configuration-confpkg"><span class="section-number-3">2.1.</span> Confpkg<a aria-hidden="true" href="#rudimentary-configuration-confpkg">#</a> </h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-motivation" class="outline-4">
<h4 id="motivation"><span class="section-number-4">2.1.1.</span> Motivation<a aria-hidden="true" href="#motivation">#</a> </h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
Previously, all of my configuration was directly tangled into <kbd>config.el</kbd>. This
<i>almost</i> satisfies my use. Occasionally though, I'd want to apply or extract a
<i>specific bit</i> of my config in an elisp script, such as some of my Org-export
customisations. This is a hassle, either loading my entire config (of which 90%
simply complicates the state), or manually copying the relevant code in pieces,
one source block at a time (just a different kind of hassle). While I'd like to
think my config is "greater than the sum of its parts", much of it can be safely
clumped into self-contained packets of functionality.
</p>

<p>
One afternoon I thought "wouldn't it be nice if I could just load a few of those
self-contained chunks of my config", then I started thinking about how I could
have that <i>and</i> <kbd>config.el</kbd>. This is the result.
</p>
</div>
</div>
<div id="outline-container-design" class="outline-4">
<h4 id="design"><span class="section-number-4">2.1.2.</span> Design<a aria-hidden="true" href="#design">#</a> </h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
It's already natural to organise blocks of config under sections, and we can use
<kbd>:noweb-ref</kbd> with a <kbd>header-args:emacs-lisp</kbd> property to direct all child source
blocks into a single parent. We could have two parents, one tangling to
<kbd>subconf/config-X.el</kbd> and the other to <kbd>config.el</kbd>, however this will duplicate
any evaluations required to generate the content, which isn't great
(particularly for things which take a moment, like checking for LaTeX
packages). Instead we can <i>just</i> write to the <kbd>subconf/*</kbd> files and then at the
end of tangling extract their contents into <kbd>config.el</kbd>.
</p>

<details id='design,code--1' class='code' open><summary><span class="lang">Graphviz</span></summary>
<div class='gutter'>
<a href='#design,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-dot">digraph {
    graph [bgcolor="transparent"];
    node  [shape="underline" penwidth="2" style="rounded,filled" fillcolor="#efefef" color="#c9c9c9" fontcolor="#000000" fontname="Alegreya Sans"];
    edge  [color="#aaaaaa" penwidth="1.2" fontname="Alegreya Sans"]
    rankdir="LR"
    "config.org" [color="#4db5bd"]
    "config.el" [color="#e69055"]
    node[color="#a991f1"]
    "subconf/config-magit.el"
    "subconf/config-org.el"
    "subconf/config-?.el"
    node[color="#51afef"]
    "config.org" -&gt; "Magit#src1" -&gt; "subconf/config-magit.el" -&gt; "config.el"
    "config.org" -&gt; "Magit#src2" -&gt; "subconf/config-magit.el"
    "config.org" -&gt; "Org#src1" -&gt; "subconf/config-org.el" -&gt; "config.el"
    "config.org" -&gt; "Org#src2" -&gt; "subconf/config-org.el"
    "config.org" -&gt; "Org#..." -&gt; "subconf/config-org.el"
    "config.org" -&gt; "(etc.)#..." -&gt; "subconf/config-?.el" -&gt; "config.el"
}
</pre>
</div>
</details>

<p>
To set this up within each section, instead of manually repeating a common form
we can generate the form and supply the relevant section properties via a babel
call keyword, like so:
</p>

<details id='design,code--2' class='code' open><summary><span class="lang">Org mode</span></summary>
<div class='gutter'>
<a href='#design,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-org"><span class="org-org-level-1">* Subject</span>

<span class="org-org-meta-line">#+call: confpkg("subject")</span>

<span class="org-org-block-begin-line">#+begin_src emacs-lisp</span>
<span class="org-org-block"><span class="org-comment-delimiter">;; </span></span><span class="org-org-block"><span class="org-comment">Code that configures the subject...</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre>
</div>
</details>

<p>
This isn't entirely straightforward, but with some mild abuse of noweb and babel
we can make it work!
</p>
</div>
</div>
<div id="outline-container-preparation" class="outline-4">
<h4 id="preparation"><span class="section-number-4">2.1.3.</span> Preparation<a aria-hidden="true" href="#preparation">#</a> </h4>
<div class="outline-text-4" id="text-2-1-3">
<p>
This approach is built around <kbd>#+call</kbd> invocations that affect the tangling.
Unfortunately for this use-case, babel call keywords are not executed on tangle.
Tangled noweb blocks <i>are</i> however, and so we can fudge the behaviour we want by
tangling a noweb block to a temp file, with a noweb block that executes babel
calls in the buffer.
</p>

<details id='confpkg-prepare' class='code' open><summary class='named'><span class="name">confpkg-prepare</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-prepare'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">condition-case</span> nil
    (<span class="org-keyword">progn</span>
      (message <span class="org-string">"Intitialising confpkg"</span>)
      &lt;&lt;bootstrap&gt;&gt;
      (<span class="org-keyword">org-fold-core-ignore-fragility-checks</span>
        (<span class="org-keyword">org-babel-map-executables</span> nil
          (<span class="org-keyword">when</span> (eq (org-element-type (org-element-context)) 'babel-call)
            (org-babel-lob-execute-maybe)))))
  (quit (revert-buffer t t t)))
</pre>
</div>
</details>

<p>
See the <a href="#bootstrap">2.1.12</a> section for an explanation of the <kbd>&lt;&lt;bootstrap&gt;&gt;</kbd> noweb reference.
</p>

<details id='preparation,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#preparation,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;confpkg-prepare()&gt;&gt;
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-setup" class="outline-4">
<h4 id="setup"><span class="section-number-4">2.1.4.</span> Setup<a aria-hidden="true" href="#setup">#</a> </h4>
<div class="outline-text-4" id="text-2-1-4">
<p>
Before generating the template with babel, we want to keep track of:
</p>
<ul class="org-ul">
<li>How many config groups are created</li>
<li>Information about each config group</li>
</ul>

<p>
To do this we can simply create two variables. Due to temp-buffer shenanigans,
we'll have to use global variables here.
</p>

<p>
Then we need to set up the two final phases of this process:
</p>
<ul class="org-ul">
<li>Creating <kbd>config.el</kbd></li>
<li>Cleaning up the superfluous generated content</li>
</ul>

<p>
To trigger the final phases we'll add a hook to <code>org-babel-post-tangle-hook</code>. Once
again, it would be preferred if this was done locally, but it needs to be
global. To avoid this causing headaches down the line we'll make sure when
implementing the hook function to have it remove itself from the hook when
executed.
</p>

<details id='confpkg-setup' class='code' open><summary class='named'><span class="name">confpkg-setup</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-setup'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> confpkg--num 0
      confpkg--list nil)

&lt;&lt;confpkg-dependency-analysis&gt;&gt;
&lt;&lt;confpkg-strip-package-statements&gt;&gt;
&lt;&lt;confpkg-create-config&gt;&gt;
(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-cleanup</span> ()
 &lt;&lt;confpkg-cleanup&gt;&gt;
  )
&lt;&lt;confpkg-finaliser&gt;&gt;

&lt;&lt;confpkg-clear-old-files&gt;&gt;

(add-hook 'org-babel-tangle-finished-hook #'confpkg-tangle-finalise)
</pre>
</div>
</details>

<p>
To avoid generating cruft, it would also be good to get rid of old tangled
config files at the start.
</p>

<details id='confpkg-clear-old' class='code' open><summary class='named'><span class="name">confpkg-clear-old-files</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-clear-old'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(make-directory <span class="org-string">"subconf"</span> t)
(<span class="org-keyword">dolist</span> (conf-file (directory-files <span class="org-string">"subconf"</span> t <span class="org-string">"config-.*\\.el"</span>))
  (delete-file conf-file))
</pre>
</div>
</details>

<p>
Now to have this take effect, we can just use a babel call keyword. Thanks to
the preparation step this will be executed during tangling.
</p>
</div>
</div>
<div id="outline-container-package-generation" class="outline-4">
<h4 id="package-generation"><span class="section-number-4">2.1.5.</span> Package generation<a aria-hidden="true" href="#package-generation">#</a> </h4>
<div class="outline-text-4" id="text-2-1-5">
<p>
Now we actually implement the <kbd>confpkg</kbd> babel function. We could just direct the
output into the <kbd>subconf/config-X.el</kbd> file without any extra steps, but why not be
a bit fancier and make it more like a package.
</p>

<p>
To do this, we'll have <kbd>confpkg</kbd> load a template and then fill it in using
<code>format-spec</code>. To make sure this is actually used, we'll call <code>org-set-property</code> to
modify the parent heading, and register the config group with the variables we
created earlier.
</p>

<details id='confpkg' class='code' open><summary class='named'><span class="name">confpkg</span><span class="lang">elisp</span></summary>
<div class='gutter'>
<a href='#confpkg'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-elisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Babel block for use with #+call</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Arguments:</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">- name, the name of the config sub-package</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">- needs, (when non-empty) required system executable(s)</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">- after, required features as a string or vector of strings</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">- pre, a noweb reference to code that should be executed eagerly,</span>
<span class="org-comment-delimiter">;;    </span><span class="org-comment">and not deferred via after. The code is not included in the</span>
<span class="org-comment-delimiter">;;    </span><span class="org-comment">generated .el file and should only be used in dire situations.</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">- prefix, the package prefix ("config-" by default)</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">- via, how this configuration should be included in config.el,</span>
<span class="org-comment-delimiter">;;    </span><span class="org-comment">the current options are:</span>
<span class="org-comment-delimiter">;;    </span><span class="org-comment">+ "copy", copy the configuration lisp</span>
<span class="org-comment-delimiter">;;    </span><span class="org-comment">+ "require", insert a require statement</span>
<span class="org-comment-delimiter">;;    </span><span class="org-comment">+ "none", do not do anything to load this configuration.</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">This only makes sense when configuration is either being</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">temporarily disabled or loaded indirectly/elsewhere.</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">- emacs-minimum, the minimum emacs version ("29.1" by default)</span>
(<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (string-empty-p needs)
          (cl-every #'executable-find (delq nil (split-string needs <span class="org-string">","</span>))))
  (<span class="org-keyword">let*</span> ((name (<span class="org-keyword">if</span> (string-empty-p name)
                   (<span class="org-keyword">save-excursion</span>
                     (<span class="org-keyword">and</span> (org-back-to-heading-or-point-min t)
                          (substring-no-properties
                           (org-element-interpret-data
                            (org-element-property <span class="org-builtin">:title</span> (org-element-at-point))))))
                 name))
         (after
          (<span class="org-keyword">cond</span>
           ((<span class="org-keyword">and</span> (stringp after) (string-empty-p after)) nil)
           ((<span class="org-keyword">and</span> (stringp after) (string-match-p <span class="org-string">"\\`[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">()]+\\'"</span> after))
            (intern after)) <span class="org-comment-delimiter">; </span><span class="org-comment">Single feature.</span>
           ((<span class="org-keyword">and</span> (vectorp after) (cl-every #'stringp after))
            (nconc (list <span class="org-builtin">:and</span>) (mapcar #'intern after)))
           (t nil)))
         (pre (<span class="org-keyword">and</span> (not (string-empty-p pre)) pre))
         (confpkg-name
          (concat prefix (replace-regexp-in-string
                          <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">a-z-]"</span> <span class="org-string">"-"</span> (downcase name))))
         (confpkg-file (expand-file-name (concat confpkg-name <span class="org-string">".el"</span>)
                                         <span class="org-string">"subconf"</span>)))
    (<span class="org-keyword">unless</span> (file-exists-p confpkg-file)
      (make-empty-file confpkg-file t))
    (<span class="org-keyword">cl-incf</span> confpkg--num)
    (org-set-property
     <span class="org-string">"header-args:emacs-lisp"</span>
     (format <span class="org-string">":tangle no :noweb-ref %s :noweb-sep \"\\n\\n\""</span> confpkg-name))
    (<span class="org-keyword">push</span> (list <span class="org-builtin">:name</span> name
                <span class="org-builtin">:package</span> confpkg-name
                <span class="org-builtin">:file</span> confpkg-file
                <span class="org-builtin">:after</span> after
                <span class="org-builtin">:pre</span> pre
                <span class="org-builtin">:via</span> (intern via)
                <span class="org-builtin">:package-statements</span> nil)
          confpkg--list)
    (format-spec
     <span class="org-string">"#+begin_src emacs-lisp :tangle %f :mkdirp yes :noweb no-export :noweb-ref none :comments no</span>
<span class="org-string">&lt;&lt;confpkg-template&gt;&gt;</span>
<span class="org-string">#+end_src"</span>
     `((?n . ,confpkg--num)
       (?p . ,confpkg-name)
       (?f . ,confpkg-file)
       (?e . ,emacs-minimum)
       (?Y . ,(format-time-string <span class="org-string">"%Y"</span>))
       (?B . ,(format-time-string <span class="org-string">"%B"</span>))
       (?m . ,(format-time-string <span class="org-string">"%m"</span>))
       (?d . ,(format-time-string <span class="org-string">"%d"</span>))
       (?M . ,(format-time-string <span class="org-string">"%M"</span>))
       (?S . ,(format-time-string <span class="org-string">"%S"</span>))))))
</pre>
</div>
</details>

<p>
Now all that's needed is a template to be used.
</p>

<details id='confpkg-template' class='code' open><summary class='named'><span class="name">confpkg-template</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-template'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">%p.el --- Generated package (no.%n) from my config -*- lexical-binding: t; -*-</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Copyright (C) %Y TEC</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Author: TEC <a href="https://code.tecosaur.net/tec">&lt;https://code.tecosaur.net/tec&gt;</a></span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Maintainer: TEC <a href="mailto:contact%40tecosaur.net">&lt;contact@tecosaur.net&gt;</a></span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Created: %B %d, %Y</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Modified: %B %d, %Y</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Version: %Y.%m.%d</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Homepage: https://code.tecosaur.net/tec/emacs-config</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Package-Requires: ((emacs \"%e\"))</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">This file is not part of GNU Emacs.</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Commentary:</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">Generated package (no.%n) from my config.</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">During generation, dependency on other aspects of my configuration and</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">packages is inferred via (regexp-based) static analysis.  While this seems</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">to do a good job, this method is imperfect.  This code likely depends on</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">utilities provided by Doom, and if you try to run it in isolation you may</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">discover the code makes more assumptions.</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">That said, I've found pretty good results so far.</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Code:</span>

&lt;&lt;%p&gt;&gt;

(<span class="org-keyword">provide</span> '<span class="org-constant">%p</span>)
<span class="org-comment-delimiter">;;; </span><span class="org-comment">%p.el ends here</span>
</pre>
</div>
</details>

<p>
This currently makes the included content look much more package-like that in
truly is. However, I hope that some static analysis in future will allow for
dependency information to be collected and included.
</p>

<p>
Lastly, should there be an issue or interruption, it's possible that the
modifications from <kbd>#+call: confpkg</kbd> may persist. If I've been good with my
committing, resolving this should be as simple as reverting unstaged changes.
So&#x2026; back in reality, it would be nice to have a way to clean up <kbd>confpkg</kbd>
residue.
</p>

<details id='confpkg-cleanup' class='code' open><summary class='named'><span class="name">confpkg-cleanup</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-cleanup'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">org-fold-core-ignore-fragility-checks</span>
  (<span class="org-keyword">org-babel-map-executables</span> nil
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (eq (org-element-type (org-element-context)) 'babel-call)
               (equal (org-element-property <span class="org-builtin">:call</span> (org-element-context)) <span class="org-string">"confpkg"</span>))
      (org-babel-remove-result)
      (org-entry-delete nil <span class="org-string">"header-args:emacs-lisp"</span>))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-identify-cross-package" class="outline-4">
<h4 id="identify-cross-package"><span class="section-number-4">2.1.6.</span> Identify cross-package dependencies<a aria-hidden="true" href="#identify-cross-package">#</a> </h4>
<div class="outline-text-4" id="text-2-1-6">
<p>
At a basic level, we can search for regexp expressions indicating the definition
of functions or variables and search for their usage.
</p>

<details id='identify-cross-package,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#identify-cross-package,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg--rough-extract-definitions</span> (file)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert-file-contents file)
    (goto-char (point-min))
    (<span class="org-keyword">let</span> (symbols)
      (<span class="org-keyword">while</span> (re-search-forward
              (<span class="org-keyword">rx</span> line-start (* (any ?\s ?\t)) <span class="org-string">"("</span>
                  (<span class="org-keyword">or</span> <span class="org-string">"defun"</span> <span class="org-string">"defmacro"</span> <span class="org-string">"defsubst"</span> <span class="org-string">"defgeneric"</span> <span class="org-string">"defalias"</span> <span class="org-string">"defvar"</span> <span class="org-string">"defcustom"</span> <span class="org-string">"defface"</span> <span class="org-string">"deftheme"</span>
                      <span class="org-string">"cl-defun"</span> <span class="org-string">"cl-defmacro"</span> <span class="org-string">"cl-defsubst"</span> <span class="org-string">"cl-defmethod"</span> <span class="org-string">"cl-defstruct"</span> <span class="org-string">"cl-defgeneric"</span> <span class="org-string">"cl-deftype"</span>)
                  (+ (any ?\s ?\t))
                  (group (+ (any <span class="org-string">"A-Z"</span> <span class="org-string">"a-z"</span> <span class="org-string">"0-9"</span>
                                 ?+ ?- ?* ?/ ?_ ?~ ?! ?@ ?$ ?% ?^ ?&amp; ?= ?: ?&lt; ?&gt; ?{ ?})))
                  (<span class="org-keyword">or</span> blank ?\n))
              nil t)
        (<span class="org-keyword">push</span> (match-string 1) symbols))
      symbols)))
</pre>
</div>
</details>

<p>
Continuing our rough regexp approach, we can construct a similar function to
look for uses of symbols.
</p>

<details id='identify-cross-package,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#identify-cross-package,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg--rough-uses-p</span> (file symbols)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert-file-contents file)
    (<span class="org-keyword">let</span> ((symbols (copy-sequence symbols)) uses-p)
      (<span class="org-keyword">while</span> symbols
        (goto-char (point-min))
        (<span class="org-keyword">if</span> (re-search-forward (<span class="org-keyword">rx</span> word-start (literal (car symbols)) word-end) nil t)
            (<span class="org-keyword">setq</span> uses-p t symbols nil)
          (<span class="org-keyword">setq</span> symbols (cdr symbols))))
      uses-p)))
</pre>
</div>
</details>

<p>
Now we can put these two functions together to annotate <code>confpkg--list</code> with their
(confpkg) dependencies.
</p>

<details id='identify-cross-package,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#identify-cross-package,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-annotate-list-dependencies</span> ()
  (<span class="org-keyword">dolist</span> (confpkg confpkg--list)
    (plist-put confpkg <span class="org-builtin">:defines</span>
               (confpkg--rough-extract-definitions
                (plist-get confpkg <span class="org-builtin">:file</span>))))
  (<span class="org-keyword">dolist</span> (confpkg confpkg--list)
    (<span class="org-keyword">let</span> ((after (plist-get confpkg <span class="org-builtin">:after</span>))
          requires)
      (<span class="org-keyword">dolist</span> (other-confpkg confpkg--list)
        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not (eq other-confpkg confpkg))
                   (confpkg--rough-uses-p (plist-get confpkg <span class="org-builtin">:file</span>)
                                          (plist-get other-confpkg <span class="org-builtin">:defines</span>)))
          (<span class="org-keyword">push</span> (plist-get other-confpkg <span class="org-builtin">:package</span>) requires)))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> after (symbolp after))
        (<span class="org-keyword">push</span> after requires))
      (plist-put confpkg <span class="org-builtin">:requires</span> requires))))
</pre>
</div>
</details>

<p>
Finally, we can use this information to edit the confpkg files to add the
necessary <code>require</code> statements.
</p>

<details id='identify-cross-package,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#identify-cross-package,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-write-dependencies</span> ()
  (<span class="org-keyword">dolist</span> (confpkg confpkg--list)
    (<span class="org-keyword">when</span> (plist-get confpkg <span class="org-builtin">:requires</span>)
      (<span class="org-keyword">with-temp-buffer</span>
        (<span class="org-keyword">setq</span> buffer-file-name (plist-get confpkg <span class="org-builtin">:file</span>))
        (insert-file-contents buffer-file-name)
        (re-search-forward <span class="org-string">"^;;; Code:\n"</span>)
        (insert <span class="org-string">"\n"</span>)
        (<span class="org-keyword">dolist</span> (req (plist-get confpkg <span class="org-builtin">:requires</span>))
          (insert (format <span class="org-string">"(require '%s)\n"</span> req)))
        (write-region nil nil buffer-file-name)
        (set-buffer-modified-p nil)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-commenting-out-package" class="outline-4">
<h4 id="commenting-out-package"><span class="section-number-4">2.1.7.</span> Commenting out <code>package!</code> statements<a aria-hidden="true" href="#commenting-out-package">#</a> </h4>
<div class="outline-text-4" id="text-2-1-7">
<p>
It's easy enough to set <code>package!</code> statements to tangle to <kbd>packages.el</kbd>, however
with our noweb ref approach they will <i>also</i> go to the config files. This could be
viewed as a problem, but I actually think it's rather nice to have the package
information with the config. So, we can look for an immediate <code>package!</code> statement
and simply comment it out. As a bonus, we can also then record which packages
are needed for each block of config.
</p>

<details id='confpkg-strip-package' class='code' open><summary class='named'><span class="name">confpkg-strip-package-statements</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-strip-package'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-comment-out-package-statements</span> ()
  (<span class="org-keyword">dolist</span> (confpkg confpkg--list)
    (<span class="org-keyword">with-temp-buffer</span>
      (<span class="org-keyword">setq</span> buffer-file-name (plist-get confpkg <span class="org-builtin">:file</span>))
      (insert-file-contents buffer-file-name)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^;;; Code:\n[[:space:]\n]*(</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">package!</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">unpin!</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[[:space:]\n]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">[:space:]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\b"</span> nil t)
        (plist-put confpkg <span class="org-builtin">:package-statements</span>
                   (nconc (plist-get confpkg <span class="org-builtin">:package-statements</span>)
                          (list (match-string 2))))
        (<span class="org-keyword">let*</span> ((start (<span class="org-keyword">progn</span> (beginning-of-line) (point)))
               (end (<span class="org-keyword">progn</span> (forward-sexp 1)
                           (<span class="org-keyword">if</span> (looking-at <span class="org-string">"[\t ]*;.*"</span>)
                               (line-end-position)
                             (point))))
               (contents (buffer-substring start end))
               paste-start paste-end
               (comment-start <span class="org-string">";"</span>)
               (comment-padding <span class="org-string">"   "</span>)
               (comment-end <span class="org-string">""</span>))
          (delete-region start (1+ end))
          (re-search-backward <span class="org-string">"^;;; Code:"</span>)
          (beginning-of-line)
          (insert <span class="org-string">";;  Package statement:\n"</span>)
          (<span class="org-keyword">setq</span> paste-start (point))
          (insert contents)
          (<span class="org-keyword">setq</span> paste-end (point))
          (insert  <span class="org-string">"\n;;\n"</span>)
          (comment-region paste-start paste-end 2)))
      (<span class="org-keyword">when</span> (buffer-modified-p)
        (write-region nil nil buffer-file-name)
        (set-buffer-modified-p nil)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-creating-config-file" class="outline-4">
<h4 id="creating-config-file"><span class="section-number-4">2.1.8.</span> Creating the config file<a aria-hidden="true" href="#creating-config-file">#</a> </h4>
<div class="outline-text-4" id="text-2-1-8">
<p>
After all the subconfig files have been tangled, we need to collect their
content and put them together into <kbd>config.el</kbd>. For this, all that's needed is a
function to go through the registered config groups and put their content in a
tempbuffer. We can call this with the finalising step.
</p>

<details id='confpkg-create-config' class='code' open><summary class='named'><span class="name">confpkg-create-config</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-create-config'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-create-config</span> ()
  (<span class="org-keyword">let</span> ((revert-without-query '(<span class="org-string">"config\\.el"</span>))
        (keywords (org-collect-keywords '(<span class="org-string">"AUTHOR"</span> <span class="org-string">"EMAIL"</span>)))
        (original-buffer (current-buffer)))
    (<span class="org-keyword">with-temp-buffer</span>
      (insert
       (format <span class="org-string">";;; config.el -*- lexical-binding: t; -*-</span>

<span class="org-string">;; SPDX-FileCopyrightText: &#169; 2020-%s %s &lt;%s&gt;</span>
<span class="org-string">;; SPDX-License-Identifier: MIT</span>

<span class="org-string">;; Generated at %s from the literate configuration.</span>

<span class="org-string">(add-to-list 'load-path %S)\n"</span>
               (format-time-string <span class="org-string">"%Y"</span>)
               (cadr (assoc <span class="org-string">"AUTHOR"</span> keywords))
               (cadr (assoc <span class="org-string">"EMAIL"</span> keywords))
               (format-time-string <span class="org-string">"%FT%T%z"</span>)
               (replace-regexp-in-string
                (regexp-quote (getenv <span class="org-string">"HOME"</span>)) <span class="org-string">"~"</span>
                (expand-file-name <span class="org-string">"subconf/"</span>))))
      (mapc
       (<span class="org-keyword">lambda</span> (confpkg)
         (insert
          (<span class="org-keyword">if</span> (eq 'none (plist-get confpkg <span class="org-builtin">:via</span>))
              (format <span class="org-string">"\n;;; %s intentionally omitted.\n"</span> (plist-get confpkg <span class="org-builtin">:name</span>))
            (<span class="org-keyword">with-temp-buffer</span>
              (<span class="org-keyword">cond</span>
               ((eq 'copy (plist-get confpkg <span class="org-builtin">:via</span>))
                (insert-file-contents (plist-get confpkg <span class="org-builtin">:file</span>))
                (goto-char (point-min))
                (narrow-to-region
                 (re-search-forward <span class="org-string">"^;;; Code:\n+"</span>)
                 (<span class="org-keyword">progn</span>
                   (goto-char (point-max))
                   (re-search-backward (format <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\n\t ][\n\t ]*\n[\t ]*(provide '%s)"</span> (plist-get confpkg <span class="org-builtin">:package</span>)))
                   (match-end 0))))
               ((eq 'require (plist-get confpkg <span class="org-builtin">:via</span>))
                (insert (format <span class="org-string">"(require '%s)\n"</span> (plist-get confpkg <span class="org-builtin">:package</span>))))
               (t (insert (format <span class="org-string">"(warn \"%s confpkg :via has unrecognised value: %S\" %S %S)"</span>
                                  (plist-get confpkg <span class="org-builtin">:name</span>) (plist-get confpkg <span class="org-builtin">:via</span>)))))
              (goto-char (point-min))
              (insert <span class="org-string">"\n;;:------------------------"</span>
                      <span class="org-string">"\n;;; "</span> (plist-get confpkg <span class="org-builtin">:name</span>)
                      <span class="org-string">"\n;;:------------------------\n\n"</span>)
              (<span class="org-keyword">when</span> (plist-get confpkg <span class="org-builtin">:defines</span>)
                (insert <span class="org-string">";; This block defines "</span>
                        (mapconcat
                         (<span class="org-keyword">lambda</span> (d) (format <span class="org-string">"`</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'"</span> d))
                         (plist-get confpkg <span class="org-builtin">:defines</span>)
                         <span class="org-string">", "</span>)
                        <span class="org-string">"."</span>)
                (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">, ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">, </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">, ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">, </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">, ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.</span><span class="org-string"><span class="org-builtin">\\=</span></span><span class="org-string">"</span>
                                          (line-beginning-position) t)
                  (replace-match <span class="org-string">"\\1, \\2, and \\3."</span>))
                (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">, ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">, </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">, ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.</span><span class="org-string"><span class="org-builtin">\\=</span></span><span class="org-string">"</span>
                                          (line-beginning-position) t)
                  (replace-match <span class="org-string">"\\1 and \\2."</span>))
                (insert <span class="org-string">"\n\n"</span>)
                (forward-line -2)
                (<span class="org-keyword">setq-local</span> comment-start <span class="org-string">";"</span>)
                (fill-comment-paragraph)
                (forward-paragraph 1)
                (forward-line 1))
              (<span class="org-keyword">if</span> (equal (plist-get confpkg <span class="org-builtin">:package</span>) <span class="org-string">"config-confpkg-timings"</span>)
                  (<span class="org-keyword">progn</span>
                    (goto-char (point-max))
                    (insert <span class="org-string">"\n\n\</span>
<span class="org-string">(confpkg-create-record 'doom-pre-config (float-time (time-subtract (current-time) before-init-time)))</span>
<span class="org-string">(confpkg-start-record 'config)</span>
<span class="org-string">(confpkg-create-record 'config-defered 0.0 'config)</span>
<span class="org-string">(confpkg-create-record 'set-hooks 0.0 'config-defered)</span>
<span class="org-string">(confpkg-create-record 'load-hooks 0.0 'config-defered)</span>
<span class="org-string">(confpkg-create-record 'requires 0.0 'root)\n"</span>))
                (<span class="org-keyword">let</span> ((after (plist-get confpkg <span class="org-builtin">:after</span>))
                      (pre (<span class="org-keyword">and</span> (plist-get confpkg <span class="org-builtin">:pre</span>)
                                (org-babel-expand-noweb-references
                                 (list <span class="org-string">"emacs-lisp"</span>
                                       (format <span class="org-string">"&lt;&lt;%s&gt;&gt;"</span> (plist-get confpkg <span class="org-builtin">:pre</span>))
                                       '((<span class="org-builtin">:noweb</span> . <span class="org-string">"yes"</span>)
                                         (<span class="org-builtin">:comments</span> . <span class="org-string">"none"</span>)))
                                 original-buffer)))
                      (name (replace-regexp-in-string
                             <span class="org-string">"config--?"</span> <span class="org-string">""</span>
                             (plist-get confpkg <span class="org-builtin">:package</span>))))
                  (<span class="org-keyword">if</span> after
                      (insert (format <span class="org-string">"(confpkg-with-record '%S\n"</span>
                                      (list (concat <span class="org-string">"hook: "</span> name) 'set-hooks))
                              (<span class="org-keyword">if</span> pre
                                  (concat <span class="org-string">";; Begin pre\n"</span> pre <span class="org-string">"\n;; End pre\n"</span>)
                                <span class="org-string">""</span>)
                              (format (<span class="org-keyword">if</span> (symbolp after) <span class="org-comment-delimiter">; </span><span class="org-comment">If single feature.</span>
                                          <span class="org-string">"  (with-eval-after-load '%s\n"</span>
                                        <span class="org-string">"  (after! %s\n"</span>)
                                      after))
                    (<span class="org-keyword">when</span> pre
                      (insert <span class="org-string">"\n;; Begin pre (unnecesary since after is unused)\n"</span>
                              pre
                              <span class="org-string">"\n;; End pre\n"</span>)))
                  (insert
                   (format <span class="org-string">"(confpkg-with-record '%S\n"</span>
                           (list (concat <span class="org-string">"load: "</span> name)
                                 (<span class="org-keyword">if</span> after 'load-hooks 'config)))))
                (goto-char (point-max))
                (<span class="org-keyword">when</span> (string-match-p <span class="org-string">";"</span> (thing-at-point 'line))
                  (insert <span class="org-string">"\n"</span>))
                (insert <span class="org-string">")"</span>)
                (<span class="org-keyword">when</span> (plist-get confpkg <span class="org-builtin">:after</span>)
                  (insert <span class="org-string">"))"</span>))
                (insert <span class="org-string">"\n"</span>))
              (buffer-string)))))
       (<span class="org-keyword">let</span> ((confpkg-timings <span class="org-comment-delimiter">;; </span><span class="org-comment">Ensure timings is put first.</span>
              (cl-some (<span class="org-keyword">lambda</span> (p) (<span class="org-keyword">and</span> (equal (plist-get p <span class="org-builtin">:package</span>) <span class="org-string">"config-confpkg-timings"</span>) p))
                       confpkg--list)))
         (append (list confpkg-timings)
                 (nreverse (remove confpkg-timings confpkg--list)))))
      (insert <span class="org-string">"\n(confpkg-finish-record 'config)\n\n;;; config.el ends here"</span>)
      (write-region nil nil <span class="org-string">"config.el"</span> nil <span class="org-builtin">:silent</span>))))
</pre>
</div>
</details>

<p>
Applying lexical binding to the config file is good for a number of reasons,
among which it's (slightly) faster than dynamic binding (see <a href="https://nullprogram.com/blog/2016/12/22/">this blog post</a> for
more info).
</p>
</div>
</div>
<div id="outline-container-quieter-output" class="outline-4">
<h4 id="quieter-output"><span class="section-number-4">2.1.9.</span> Quieter output<a aria-hidden="true" href="#quieter-output">#</a> </h4>
<div class="outline-text-4" id="text-2-1-9">
<p>
All the babel evaluation here ends up being quite noisy (along with a few other
things during tangle), let's see if we can change that.
</p>

<details id='confpkg-quieter-output' class='code' open><summary class='named'><span class="name">confpkg-quieter-output</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-quieter-output'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> noninteractive
  (<span class="org-keyword">unless</span> (fboundp 'doom-shut-up-a)
    (<span class="org-keyword">defun</span> <span class="org-function-name">doom-shut-up-a</span> (fn <span class="org-type">&amp;rest</span> args)
      (<span class="org-keyword">let</span> ((standard-output #'ignore)
            (inhibit-message t))
        (apply fn args))))
  (advice-add 'org-babel-expand-body:emacs-lisp <span class="org-builtin">:around</span> #'doom-shut-up-a)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Quiet some other annoying messages</span>
  (advice-add 'sh-set-shell <span class="org-builtin">:around</span> #'doom-shut-up-a)
  (advice-add 'rng-what-schema <span class="org-builtin">:around</span> #'doom-shut-up-a)
  (advice-add 'python-indent-guess-indent-offset <span class="org-builtin">:around</span> #'doom-shut-up-a))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-reporting-load-time" class="outline-4">
<h4 id="reporting-load-time"><span class="section-number-4">2.1.10.</span> Reporting load time information<a aria-hidden="true" href="#reporting-load-time">#</a> </h4>
<div class="outline-text-4" id="text-2-1-10">
<p>
When generating the config we added a form to collect load-time information.
</p>

<details id='reporting-load-time,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#reporting-load-time,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">confpkg-load-time-tree</span> (list (list 'root)))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">confpkg-record-branch</span> (list 'root))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">confpkg-record-num</span> 0)
</pre>
</div>
</details>

<p>
It would be good to process <code>confpkg-load-times</code> at the end to make it more
useful, and provide a function to display load time information from it. This is
to aid in identification of confpkgs that take particularly long to load, and
thus would benefit from some attention.
</p>

<p>
To extract the per-confpkg load times, we can just take the difference in
<code>(float-time)</code> and exclude the first entry.
</p>

<details id='reporting-load-time,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#reporting-load-time,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-create-record</span> (name elapsed <span class="org-type">&amp;optional</span> parent enclosing)
  (<span class="org-keyword">let</span> ((parent (assoc (<span class="org-keyword">or</span> parent (car confpkg-record-branch))
                       confpkg-load-time-tree))
        (record (cons name (list (list 'self
                                       <span class="org-builtin">:name</span> (format <span class="org-string">"%s"</span> name)
                                       <span class="org-builtin">:num</span> (<span class="org-keyword">cl-incf</span> confpkg-record-num)
                                       <span class="org-builtin">:elapsed</span> elapsed
                                       <span class="org-builtin">:enclosing</span> enclosing)))))
    (<span class="org-keyword">push</span> record confpkg-load-time-tree)
    (<span class="org-keyword">push</span> record (cdr parent))
    record))

(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-start-record</span> (name <span class="org-type">&amp;optional</span> parent)
  (<span class="org-keyword">let</span> ((record (confpkg-create-record name 0.0e+NaN parent t)))
    (plist-put (cdadr record) <span class="org-builtin">:start</span> (float-time))
    (<span class="org-keyword">push</span> name confpkg-record-branch)
    record))

(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-finish-record</span> (name)
  (<span class="org-keyword">let</span> ((self-record (cdar (last (cdr (assoc name confpkg-load-time-tree))))))
    (plist-put self-record <span class="org-builtin">:elapsed</span>
               (- (float-time) (plist-get self-record <span class="org-builtin">:start</span>) 0.0))
    (<span class="org-keyword">unless</span> (equal (car confpkg-record-branch) name)
      (message <span class="org-string">"Warning: Confpkg timing record expected to finish %S, instead found %S. %S"</span>
               name (car confpkg-record-branch) confpkg-record-branch))
    (<span class="org-keyword">setq</span> confpkg-record-branch (cdr confpkg-record-branch))))
</pre>
</div>
</details>

<p>
A convenience macro could be nice to have.
</p>

<details id='reporting-load-time,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#reporting-load-time,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">confpkg-with-record</span> (name <span class="org-type">&amp;rest</span> body)
  <span class="org-doc">"Create a time record around BODY.</span>
<span class="org-doc">The record must have a NAME."</span>
  (<span class="org-keyword">declare</span> (indent 1))
  (<span class="org-keyword">let</span> ((name-val (make-symbol <span class="org-string">"name-val"</span>))
        (record-spec (make-symbol <span class="org-string">"record-spec"</span>)))
    `(<span class="org-keyword">let*</span> ((,name-val ,name)
            (,record-spec (<span class="org-keyword">if</span> (consp ,name-val) ,name-val (list ,name-val))))
       (apply #'confpkg-start-record ,record-spec)
       (<span class="org-keyword">unwind-protect</span>
           (<span class="org-keyword">progn</span> ,@body)
         (confpkg-finish-record (car ,record-spec))))))
</pre>
</div>
</details>

<p>
It would also be nice to collect some other load-time-related information.
</p>

<details id='reporting-load-time,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#reporting-load-time,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +require--log-timing-a (orig-fn feature <span class="org-type">&amp;optional</span> filename noerror)
  <span class="org-builtin">:around</span> #'require
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (<span class="org-keyword">featurep</span> <span class="org-constant">feature</span>)
          (eq feature 'cus-start) <span class="org-comment-delimiter">; </span><span class="org-comment">HACK Why!?!</span>
          (assoc (format <span class="org-string">"require: %s"</span> feature) confpkg-load-time-tree))
      (funcall orig-fn feature filename noerror)
    (confpkg-with-record (list (format <span class="org-string">"require: %s"</span> feature)
                               (<span class="org-keyword">and</span> (eq (car confpkg-record-branch) 'root)
                                    'requires))
      (funcall orig-fn feature filename noerror))))
</pre>
</div>
</details>

<p>
At last, we'll go to some pains to make a nice result tabulation function.
</p>

<p>
I will readily admit that this function is absolutely horrible. I just spent an
evening adding to it till it worked then stopped touching it. Maybe in the
future I'll go back to it and try to clean up the implementation.
</p>

<details id='reporting-load-time,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#reporting-load-time,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-timings-report</span> (<span class="org-type">&amp;optional</span> sort-p node)
  <span class="org-doc">"Display a report on load-time information.</span>
<span class="org-doc">Supply SORT-P (or the universal argument) to sort the results.</span>
<span class="org-doc">NODE defaults to the root node."</span>
  (<span class="org-keyword">interactive</span>
   (list (<span class="org-keyword">and</span> current-prefix-arg t)))
  (<span class="org-keyword">let</span> ((buf (get-buffer-create <span class="org-string">"*Confpkg Load Time Report*"</span>))
        (depth 0)
        num-pad name-pad max-time max-total-time max-depth)
    (<span class="org-keyword">cl-labels</span>
        ((sort-records-by-time
          (record)
          (<span class="org-keyword">let</span> ((self (assoc 'self record)))
            (append (list self)
                    (sort (nreverse (remove self (cdr record)))
                          (<span class="org-keyword">lambda</span> (a b)
                            (&gt; (<span class="org-keyword">or</span> (plist-get (alist-get 'self a) <span class="org-builtin">:total</span>) 0.0)
                               (<span class="org-keyword">or</span> (plist-get (alist-get 'self b) <span class="org-builtin">:total</span>) 0.0)))))))
         (print-record
          (record)
          (<span class="org-keyword">cond</span>
           ((eq (car record) 'self)
            (insert
             (propertize
              (string-pad (number-to-string (plist-get (cdr record) <span class="org-builtin">:num</span>)) num-pad)
              'face 'font-lock-keyword-face)
             <span class="org-string">" "</span>
             (propertize
              (apply #'concat
                     (make-list (1- depth) <span class="org-string">"&#8226; "</span>))
              'face 'font-lock-comment-face)
             (string-pad (format <span class="org-string">"%s"</span> (plist-get (cdr record) <span class="org-builtin">:name</span>)) name-pad)
             (make-string (* (- max-depth depth) 2) ?\s)
             (propertize
              (format <span class="org-string">"%.4fs"</span> (plist-get (cdr record) <span class="org-builtin">:elapsed</span>))
              'face
              (list <span class="org-builtin">:foreground</span>
                    (doom-blend 'orange 'green
                                (/ (plist-get (cdr record) <span class="org-builtin">:elapsed</span>) max-time))))
             (<span class="org-keyword">if</span> (= (plist-get (cdr record) <span class="org-builtin">:elapsed</span>)
                    (plist-get (cdr record) <span class="org-builtin">:total</span>))
                 <span class="org-string">""</span>
               (concat <span class="org-string">"   (&#931;="</span>
                       (propertize
                        (format <span class="org-string">"%.3fs"</span> (plist-get (cdr record) <span class="org-builtin">:total</span>))
                        'face
                        (list <span class="org-builtin">:foreground</span>
                              (doom-blend 'orange 'green
                                          (/ (plist-get (cdr record) <span class="org-builtin">:total</span>) max-total-time))))
                       <span class="org-string">")"</span>))
             <span class="org-string">"\n"</span>))
           (t
            (<span class="org-keyword">cl-incf</span> depth)
            (mapc
             #'print-record
             (<span class="org-keyword">if</span> sort-p
                 (sort-records-by-time record)
               (reverse (cdr record))))
            (<span class="org-keyword">cl-decf</span> depth))))
         (flatten-records
          (records)
          (<span class="org-keyword">if</span> (eq (car records) 'self)
              (list records)
            (mapcan
             #'flatten-records
             (reverse (cdr records)))))
         (tree-depth
          (records <span class="org-type">&amp;optional</span> depth)
          (<span class="org-keyword">if</span> (eq (car records) 'self)
              (<span class="org-keyword">or</span> depth 0)
            (1+ (cl-reduce #'max (cdr records) <span class="org-builtin">:key</span> #'tree-depth))))
         (mapreduceprop
          (list map reduce prop)
          (cl-reduce
           reduce list
           <span class="org-builtin">:key</span>
           (<span class="org-keyword">lambda</span> (p) (funcall map (plist-get (cdr p) prop)))))
         (elaborate-timings
          (record)
          (<span class="org-keyword">if</span> (eq (car record) 'self)
              (plist-get (cdr record) <span class="org-builtin">:elapsed</span>)
            (<span class="org-keyword">let</span> ((total (cl-reduce #'+ (cdr record)
                                    <span class="org-builtin">:key</span> #'elaborate-timings))
                  (self (cdr (assoc 'self record))))
              (<span class="org-keyword">if</span> (plist-get self <span class="org-builtin">:enclosing</span>)
                  (<span class="org-keyword">prog1</span>
                      (plist-get self <span class="org-builtin">:elapsed</span>)
                    (plist-put self <span class="org-builtin">:total</span> (plist-get self <span class="org-builtin">:elapsed</span>))
                    (plist-put self <span class="org-builtin">:elapsed</span>
                               (- (* 2 (plist-get self <span class="org-builtin">:elapsed</span>)) total)))
                (plist-put self <span class="org-builtin">:total</span> total)
                total))))
         (elaborated-timings
          (record)
          (<span class="org-keyword">let</span> ((record (copy-tree record)))
            (elaborate-timings record)
            record)))
      (<span class="org-keyword">let*</span> ((tree
              (elaborated-timings
               (append '(root)
                       (copy-tree
                        (alist-get (<span class="org-keyword">or</span> node 'root)
                                   confpkg-load-time-tree
                                   nil nil #'equal))
                       '((self <span class="org-builtin">:num</span> 0 <span class="org-builtin">:elapsed</span> 0)))))
             (flat-records
              (cl-remove-if
               (<span class="org-keyword">lambda</span> (rec) (= (plist-get (cdr rec) <span class="org-builtin">:num</span>) 0))
               (flatten-records tree))))
        (<span class="org-keyword">setq</span> max-time (mapreduceprop flat-records #'identity #'max <span class="org-builtin">:elapsed</span>)
              max-total-time (mapreduceprop flat-records #'identity #'max <span class="org-builtin">:total</span>)
              name-pad (mapreduceprop flat-records #'length #'max <span class="org-builtin">:name</span>)
              num-pad (mapreduceprop flat-records
                                     (<span class="org-keyword">lambda</span> (n) (length (number-to-string n)))
                                     #'max <span class="org-builtin">:num</span>)
              max-depth (tree-depth tree))
        (<span class="org-keyword">with-current-buffer</span> buf
          (erase-buffer)
          (<span class="org-keyword">setq-local</span> outline-regexp <span class="org-string">"[0-9]+ *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">&#8226; </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>)
          (outline-minor-mode 1)
          (use-local-map (make-sparse-keymap))
          (local-set-key <span class="org-string">"TAB"</span> #'outline-toggle-children)
          (local-set-key <span class="org-string">"\t"</span> #'outline-toggle-children)
          (local-set-key (kbd <span class="org-string">"&lt;backtab&gt;"</span>) #'outline-show-subtree)
          (local-set-key (kbd <span class="org-string">"C-&lt;iso-lefttab&gt;"</span>)
                         (eval `(<span class="org-keyword">cmd!</span> (<span class="org-keyword">if</span> current-prefix-arg
                                          (outline-show-all)
                                        (outline-hide-sublevels (+ ,num-pad 2))))))
          (insert
           (propertize
            (concat (string-pad <span class="org-string">"#"</span> num-pad) <span class="org-string">" "</span>
                    (string-pad <span class="org-string">"Confpkg"</span>
                                (+ name-pad (* 2 max-depth) -3))
                    (format <span class="org-string">" Load Time (&#931;=%.3fs)\n"</span>
                            (plist-get (cdr (assoc 'self tree)) <span class="org-builtin">:total</span>)))
            'face '(<span class="org-builtin">:inherit</span> (tab-bar-tab bold) <span class="org-builtin">:extend</span> t <span class="org-builtin">:underline</span> t)))
          (<span class="org-keyword">dolist</span> (record (<span class="org-keyword">if</span> sort-p
                              (sort-records-by-time tree)
                            (reverse (cdr tree))))
            (<span class="org-keyword">unless</span> (eq (car record) 'self)
              (print-record record)))
          (set-buffer-modified-p nil)
          (goto-char (point-min)))
        (pop-to-buffer buf)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-finalise" class="outline-4">
<h4 id="finalise"><span class="section-number-4">2.1.11.</span> Finalise<a aria-hidden="true" href="#finalise">#</a> </h4>
<div class="outline-text-4" id="text-2-1-11">
<p>
At last, to clean up the content inserted by the babel calls we can just revert
the buffer. As long as <code>org-babel-pre-tangle-hook</code> hasn't been modified,
<code>save-buffer</code> will be run at the start of the tangle process and so reverting will
take us back to just before the tangle started.
</p>

<p>
Since this is <i>the</i> function added as the post-tangle hook, we also need to remove
the function from the hook and call the <kbd>config.el</kbd> creation function.
</p>

<details id='confpkg-finaliser' class='code' open><summary class='named'><span class="name">confpkg-finaliser</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#confpkg-finaliser'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">confpkg-tangle-finalise</span> ()
  (remove-hook 'org-babel-tangle-finished-hook #'confpkg-tangle-finalise)
  (revert-buffer t t t)
  (confpkg-comment-out-package-statements)
  (confpkg-annotate-list-dependencies)
  (confpkg-create-config)
  (confpkg-write-dependencies)
  (message <span class="org-string">"Processed %s elisp files"</span> (length confpkg--list)))
</pre>
</div>
</details>

<p>
Within <code>confpkg-tangle-finalise</code> we carefully order each step so that
the most important steps go first, to minimise the impact should a particular
step fail.
</p>
</div>
</div>
<div id="outline-container-bootstrap" class="outline-4">
<h4 id="bootstrap"><span class="section-number-4">2.1.12.</span> Bootstrap<a aria-hidden="true" href="#bootstrap">#</a> </h4>
<div class="outline-text-4" id="text-2-1-12">
<p>
This system makes use of some recent commits introduced to Org, such as <a href="https://git.savannah.gnu.org/cgit/emacs/org-mode.git/commit/?id=cb8bf4a0d">this
noweb expansion bugfix</a> which will be included in Org 9.5.4. This is
problematic if using Emacs 28.2 or older, so to get around this we must go
through a bootstrap process.
</p>

<p>

</p>

<p>
To start with, we'll check if we are:
</p>
<ul class="org-ul">
<li>Running an Org version prior to 9.5.4</li>
<li>Running in a <code>noninteractive</code> session</li>
<li>Using an Org that's not installed in the user directory</li>
<li>In a session with the symbol <code>exit!</code> defined</li>
</ul>

<details id='bootstrap--1' class='code' open><summary class='named'><span class="name">bootstrap</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#bootstrap--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let</span> ((required-org-version <span class="org-string">"9.5.4"</span>)
      (standard-output t))
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (version&lt; (org-version) required-org-version)
             (not (string-match-p (regexp-quote (expand-file-name <span class="org-string">"~"</span>))
                                  (locate-library <span class="org-string">"org"</span>))))
    (<span class="org-keyword">cond</span>
     ((<span class="org-keyword">and</span> noninteractive (fboundp 'exit!))
      (<span class="org-keyword">print!</span> (<span class="org-warning">warn</span> (format <span class="org-string">"Detected conditions provoking a config bootstrap (Org %s)"</span> (org-version))))
      (<span class="org-keyword">print!</span> (start <span class="org-string">"Initiating bootstrap..."</span>))
      &lt;&lt;bootstrap-perform&gt;&gt;
      )
     (t (message <span class="org-string">"Installed Org version %s is too old, %s is needed.\nRun \"doom sync\" to fix."</span>
                 (org-version) required-org-version)))))
</pre>
</div>
</details>

<p>
If these conditions are met, we can assume that the loaded Org version is
insufficient, and that it's likely a Emacs is currently running a command like
<kbd>doom sync</kbd>, and so it makes sense to perform the 3-step bootstrap.
</p>
<ol class="org-ol">
<li>Temporarily rename <kbd>config.org</kbd> to <kbd>config.original.org</kbd>.</li>
<li>Create a new <kbd>config.org</kbd> that when tangled results in Org being installed.</li>
<li>Swap back to the original <kbd>config.org</kbd>, and re-sync.</li>
</ol>

<details id='bootstrap-perform' class='code' open><summary class='named'><span class="name">bootstrap-perform</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#bootstrap-perform'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">print!</span> (item <span class="org-string">"Temporarily relocating config.org to config.original.org"</span>))
(rename-file <span class="org-string">"config.org"</span> <span class="org-string">"config.original.org"</span> t)
&lt;&lt;boostrap-create-transient-config&gt;&gt;
(<span class="org-keyword">print!</span> (item <span class="org-string">"%s"</span>) (bold <span class="org-string">"Re-running sync"</span>))
(exit! <span class="org-builtin">:restart</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">Re-run =doom sync= with the transient config.</span>
</pre>
</div>
</details>

<p>
With the approach worked out, we just need to generate a snipped that will
create a new <kbd>config.org</kbd> that when tangled:
</p>
<ul class="org-ul">
<li>Tangles our Org recipe to <kbd>packages.el</kbd></li>
<li>Swaps back to the original <kbd>config.org</kbd></li>
<li>Re-runs <kbd>doom sync</kbd></li>
</ul>

<details id='boostrap-create-transient' class='code' open><summary class='named'><span class="name">boostrap-create-transient-config</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#boostrap-create-transient'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">print!</span> (item <span class="org-string">"Creating minimal init.el"</span>))

(<span class="org-keyword">let</span> ((standard-output #'ignore))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert
     <span class="org-string">";;; init.el -*- lexical-binding: t; -*-\n\n"</span>
     (pp (<span class="org-keyword">quote</span>
          &lt;&lt;bootstrap-init&gt;&gt;
          )))
    (write-region nil nil <span class="org-string">"init.el"</span>)))

(<span class="org-keyword">print!</span> (item <span class="org-string">"Creating boostrap config.el"</span>))

(<span class="org-keyword">let</span> ((standard-output #'ignore))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert
     (org-element-interpret-data
      (list
       '(keyword (<span class="org-builtin">:key</span> <span class="org-string">"title"</span> <span class="org-builtin">:value</span> <span class="org-string">"Boostrap Stage 1 Config"</span> <span class="org-builtin">:post-blank</span> 1))
       `(src-block
         (<span class="org-builtin">:language</span> <span class="org-string">"emacs-lisp"</span>
          <span class="org-builtin">:value</span> ,(pp (<span class="org-keyword">quote</span> (<span class="org-keyword">progn</span>
                               &lt;&lt;boostrap-transition&gt;&gt;
                               )))
          <span class="org-builtin">:name</span> <span class="org-string">"bootstrap-transition"</span>
          <span class="org-builtin">:post-blank</span> 1))
       `(src-block
         (<span class="org-builtin">:language</span> <span class="org-string">"emacs-lisp"</span>
          <span class="org-builtin">:parameters</span>
          ,(concat <span class="org-string">":noweb no-export "</span>
                   <span class="org-string">":tangle (expand-file-name (make-temp-name \"emacs-org-babel-excuses/confpkg-prepare-\") temporary-file-directory) "</span>
                   <span class="org-string">":mkdirp yes"</span>)
          <span class="org-builtin">:value</span> ,(concat <span class="org-string">"&lt;&lt;"</span> <span class="org-comment-delimiter">; </span><span class="org-comment">Split to avoid (prematurely) creating a noweb reference.</span>
                          <span class="org-string">"bootstrap-transition()"</span>
                          <span class="org-string">"&gt;&gt;\n"</span>))))))
    (write-region nil nil <span class="org-string">"config.org"</span>)))
</pre>
</div>
</details>

<p>
For the bootstrap we need a minimal <kbd>init.el</kbd>, just the literate module should be
sufficient.
</p>

<details id='bootstrap-init' class='code' open><summary class='named'><span class="name">bootstrap-init</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#bootstrap-init'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">doom!</span> <span class="org-builtin">:config</span> literate)
</pre>
</div>
</details>

<p>
This <kbd>config.org</kbd> simply provides an entry point for us to run elisp during
tangle. We just need to make use of it to install Org and re-sync the original
configuration.
</p>

<details id='boostrap-transition' class='code' open><summary class='named'><span class="name">boostrap-transition</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#boostrap-transition'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> standard-output t)

(<span class="org-keyword">print!</span> (start <span class="org-string">"Starting second stage of the bootstrap."</span>))
(<span class="org-keyword">print!</span> (item <span class="org-string">"Creating minimal packages.el"</span>))

(<span class="org-keyword">let</span> ((standard-output #'ignore))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert
     <span class="org-string">";; -*- no-byte-compile: t; -*-\n\n"</span>
     (pp (<span class="org-keyword">quote</span>
          &lt;&lt;org-pkg-statement()&gt;&gt;
          )))
    (write-region nil nil <span class="org-string">"packages.el"</span>)))

(doom-packages-install)

(<span class="org-keyword">print!</span> (item <span class="org-string">"Switching back to original config.org"</span>))
(rename-file <span class="org-string">"config.original.org"</span> <span class="org-string">"config.org"</span> t)

(<span class="org-keyword">print!</span> (item <span class="org-string">"%s"</span>) (bold <span class="org-string">"Re-running sync"</span>))
(exit! <span class="org-builtin">:restart</span>)
</pre>
</div>
</details>

<p>
There we go, that should do the trick, so long as we call the <kbd>bootstrap</kbd> block at
the start of the tangle process. This is done by calling <kbd>bootstrap</kbd> within the
<a href="#preparation">confpkg preparation</a> stage.
</p>
</div>
</div>
</div>
<div id="outline-container-personal-information" class="outline-3">
<h3 id="personal-information"><span class="section-number-3">2.2.</span> Personal Information<a aria-hidden="true" href="#personal-information">#</a> </h3>
<div class="outline-text-3" id="text-2-2">
<p>
It's useful to have some basic personal information
</p>
<details id='personal-information,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#personal-information,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> user-full-name <span class="org-string">"TEC"</span>
      user-mail-address <span class="org-string">"contact@tecosaur.net"</span>)
</pre>
</div>
</details>
<p>
Apparently this is used by <code>GPG</code>, and all sorts of other things.
</p>

<p>
Speaking of <code>GPG</code>, I want to use <kbd>~/.authinfo.gpg</kbd> instead of the default in
<kbd>~/.config/emacs</kbd>. Why? Because my home directory is already cluttered, so this won't
make a difference, and I don't want to accidentally purge this file (I have done
. I also want to cache as much as possible, as
my home machine is pretty safe, and my laptop is shutdown a lot.
</p>
<details id='personal-information,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#personal-information,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> auth-sources '(<span class="org-string">"~/.authinfo.gpg"</span>)
      auth-source-cache-expiry nil) <span class="org-comment-delimiter">; </span><span class="org-comment">default is 7200 (2h)</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-better-defaults" class="outline-3">
<h3 id="better-defaults"><span class="section-number-3">2.3.</span> Better defaults<a aria-hidden="true" href="#better-defaults">#</a> </h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-simple-settings" class="outline-4">
<h4 id="simple-settings"><span class="section-number-4">2.3.1.</span> Simple settings<a aria-hidden="true" href="#simple-settings">#</a> </h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
Inspired by a few sources of modified defaults (such as <a href="https://github.com/angrybacon/dotemacs/blob/master/dotemacs.org#use-better-defaults">angrybacon/dotemacs</a>) and
my own experiences, I've ended up with a small set of tweaks on top of the
changes Doom makes:
</p>

<details id='simple-settings,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#simple-settings,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq-default</span>
 delete-by-moving-to-trash t                      <span class="org-comment-delimiter">; </span><span class="org-comment">Delete files to trash</span>
 window-combination-resize t                      <span class="org-comment-delimiter">; </span><span class="org-comment">take new window space from all other windows (not just current)</span>
 x-stretch-cursor t)                              <span class="org-comment-delimiter">; </span><span class="org-comment">Stretch cursor to the glyph width</span>

(<span class="org-keyword">setq</span> undo-limit 80000000                         <span class="org-comment-delimiter">; </span><span class="org-comment">Raise undo-limit to 80Mb</span>
      evil-want-fine-undo t                       <span class="org-comment-delimiter">; </span><span class="org-comment">By default while in insert all changes are one big blob. Be more granular</span>
      auto-save-default t                         <span class="org-comment-delimiter">; </span><span class="org-comment">Nobody likes to loose work, I certainly don't</span>
      truncate-string-ellipsis <span class="org-string">"&#8230;"</span>                <span class="org-comment-delimiter">; </span><span class="org-comment">Unicode ellispis are nicer than "...", and also save /precious/ space</span>
      password-cache-expiry nil                   <span class="org-comment-delimiter">; </span><span class="org-comment">I can trust my computers ... can't I?</span>
      <span class="org-comment-delimiter">;; </span><span class="org-comment">scroll-preserve-screen-position 'always     ; Don't have `</span><span class="org-comment"><span class="org-constant">point</span></span><span class="org-comment">' jump around</span>
      scroll-margin 2                             <span class="org-comment-delimiter">; </span><span class="org-comment">It's nice to maintain a little margin</span>
      display-time-default-load-average nil)      <span class="org-comment-delimiter">; </span><span class="org-comment">I don't think I've ever found this useful</span>

(display-time-mode 1)                             <span class="org-comment-delimiter">; </span><span class="org-comment">Enable time in the mode-line</span>
(global-subword-mode 1)                           <span class="org-comment-delimiter">; </span><span class="org-comment">Iterate through CamelCase words</span>
</pre>
</div>
</details>

<p>
When using a device with a battery, it would be nice to display battery
 information. We can check for a battery during tangle via noweb, and only call
 <code>display-battery-mode</code> when relevant. From a look at the various status functions
 in <kbd>battery.el</kbd>, it seems like the <code>?L</code> key is consistently <kbd>N/A</kbd> when there is no
 battery, so we'll test on that.
</p>

<details id='battery-status-setup' class='code' open><summary class='named'><span class="name">battery-status-setup</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#battery-status-setup'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">battery</span>)
(<span class="org-keyword">if</span> (<span class="org-keyword">and</span> battery-status-function
         (not (equal (alist-get ?L (funcall battery-status-function))
                     <span class="org-string">"N/A"</span>)))
    (prin1-to-string `(display-battery-mode 1))
  <span class="org-string">""</span>)
</pre>
</div>
</details>

<p>
Now with noweb we' use the result.
</p>

<details id='simple-settings,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#simple-settings,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;battery-status-setup()&gt;&gt;
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-frame-sizing" class="outline-4">
<h4 id="frame-sizing"><span class="section-number-4">2.3.2.</span> Frame sizing<a aria-hidden="true" href="#frame-sizing">#</a> </h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
It's nice to control the size of new frames, when launching Emacs that can be
done with . After the font size adjustment
during initialisation this works out to be <code>102x31</code>.
</p>

<p>
Thanks to hotkeys, it's easy for me to expand a frame to half/full-screen, so it
makes sense to be conservative with the sizing of new frames.
</p>

<p>
Then, for creating new frames within the same Emacs instance, we'll just set the
default to be something roughly 80% of that size.
</p>

<details id='frame-sizing,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#frame-sizing,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'default-frame-alist '(height . 24))
(add-to-list 'default-frame-alist '(width . 80))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-auto-customisations" class="outline-4">
<h4 id="auto-customisations"><span class="section-number-4">2.3.3.</span> Auto-customisations<a aria-hidden="true" href="#auto-customisations">#</a> </h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
By default changes made via a customisation interface are added to <kbd>init.el</kbd>.
I prefer the idea of using a separate file for this. We just need to change a
setting, and load it if it exists.
</p>
<details id='auto-customisations,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#auto-customisations,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq-default</span> custom-file (expand-file-name <span class="org-string">".custom.el"</span> doom-user-dir))
(<span class="org-keyword">when</span> (file-exists-p custom-file)
  (load custom-file))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-windows" class="outline-4">
<h4 id="windows"><span class="section-number-4">2.3.4.</span> Windows<a aria-hidden="true" href="#windows">#</a> </h4>
<div class="outline-text-4" id="text-2-3-4">
<p>
I find it rather handy to be asked which buffer I want to see after splitting
the window. Let's make that happen.
</p>

<p>
First, we'll enter the new window
</p>
<details id='windows,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#windows,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> evil-vsplit-window-right t
      evil-split-window-below t)
</pre>
</div>
</details>

<p>
Then, we'll pull up a buffer prompt.
</p>
<details id='windows,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#windows,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> prompt-for-buffer (<span class="org-type">&amp;rest</span> _)
  <span class="org-builtin">:after</span> '(evil-window-split evil-window-vsplit)
  (consult-buffer))
</pre>
</div>
</details>

<p>
Window rotation is nice, and can be found under <kbd>SPC w r</kbd> and <kbd>SPC w R</kbd>.
<i>Layout</i> rotation is also nice though. Let's stash this under <kbd>SPC w SPC</kbd>, inspired
by Tmux's use of <kbd>C-b SPC</kbd> to rotate windows.
</p>

<p>
We could also do with adding the missing arrow-key variants of the window
navigation/swapping commands.
</p>
<details id='windows,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#windows,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:map</span> evil-window-map
      <span class="org-string">"SPC"</span> #'rotate-layout
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Navigation</span>
      <span class="org-string">"&lt;left&gt;"</span>     #'evil-window-left
      <span class="org-string">"&lt;down&gt;"</span>     #'evil-window-down
      <span class="org-string">"&lt;up&gt;"</span>       #'evil-window-up
      <span class="org-string">"&lt;right&gt;"</span>    #'evil-window-right
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Swapping windows</span>
      <span class="org-string">"C-&lt;left&gt;"</span>       #'+evil/window-move-left
      <span class="org-string">"C-&lt;down&gt;"</span>       #'+evil/window-move-down
      <span class="org-string">"C-&lt;up&gt;"</span>         #'+evil/window-move-up
      <span class="org-string">"C-&lt;right&gt;"</span>      #'+evil/window-move-right)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-hippie-expand" class="outline-4">
<h4 id="hippie-expand"><span class="section-number-4">2.3.5.</span> Hippie expand<a aria-hidden="true" href="#hippie-expand">#</a> </h4>
<div class="outline-text-4" id="text-2-3-5">
<p>
Completing text based on other availible content is a great idea, and so <code>dabbrev</code>
(dynamic abbreviations) is throughly useful. There's another similar tool that
Emacs comes with though, called <a href="https://www.masteringemacs.org/article/text-expansion-hippie-expand">hippie expand</a>, which is just a bit nicer yet,
and can be used as a swap-in upgrade to <code>dabbrev</code>.
</p>

<details id='hippie-expand,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#hippie-expand,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(global-set-key [remap dabbrev-expand] #'hippie-expand)
</pre>
</div>
</details>
</div>
<div id="outline-container-expansion-prioritisation" class="outline-5">
<h5 id="expansion-prioritisation"><span class="section-number-5">2.3.5.1.</span> Expansion prioritisation<a aria-hidden="true" href="#expansion-prioritisation">#</a> </h5>
<div class="outline-text-5" id="text-2-3-5-1">
<p>
Hippie expand works by cycling through a series of expansion-generating
functions, listed in the variable <code>hippie-expand-try-functions-list</code>.
</p>

<p>
By default, it completes (in order):
</p>
<ul class="org-ul">
<li>File names</li>
<li>Known abbreviations</li>
<li>Lists (i.e. bracketed regions)</li>
<li>Previous lines</li>
<li>Dabbrev (this buffer)</li>
<li>Dabbrev (all buffers)</li>
<li>Dabbrev (kill ring)</li>
<li>Known elisp symbols</li>
</ul>

<p>
I find that <code>try-expand-line</code> completions often appear when I actually want a
dabbrev completion, so let's deprioritise it somewhat. If I actually want to try
for a line expansion, it's fairly easy to deliberately trigger it &#x2014; just
invoke <code>hippie-expand</code> after typing a space and there will be no dabbrev
candidates.
</p>

<p>
Speaking of dabbrev, I do think of hippie-expand mostly as "a stangely named
dabbrev+", so let's prioritise the dabbrev-related expanders a bit. I'll also
toss in a nice non-default expansion generator as the first dabbrev candidate
function: <code>try-expand-dabbrev-visible</code>.
</p>

<p>
There's another cool source of multi-word expansion (actually multi-line) that
isn't used by default, <code>try-expand-dabbrev-from-kill</code>. I personally think this one
is quite neat, but don't want it to interfere with more common single-word
completions, and so will place it just above <code>try-expand-line</code>.
</p>

<details id='expansion-prioritisation,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#expansion-prioritisation,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> hippie-expand-try-functions-list
      '(try-expand-list
        try-expand-dabbrev-visible
        try-expand-dabbrev
        try-expand-all-abbrevs
        try-expand-dabbrev-all-buffers
        try-complete-file-name-partially
        try-complete-file-name
        try-expand-dabbrev-from-kill
        try-expand-whole-kill
        try-expand-line
        try-complete-lisp-symbol-partially
        try-complete-lisp-symbol))
</pre>
</div>
</details>

<p>
Unfortunately there's one aspect of <code>try-expand-dabbrev-from-kill</code> that I find
lets me down a bit, which is that it fails to complete when the killed text
starts with a newline and the current line does not. I'll see if I can do
something about this in the future.
</p>
</div>
</div>
<div id="outline-container-suffix-stripping" class="outline-5">
<h5 id="suffix-stripping"><span class="section-number-5">2.3.5.2.</span> Suffix stripping<a aria-hidden="true" href="#suffix-stripping">#</a> </h5>
<div class="outline-text-5" id="text-2-3-5-2">
<p>
I am occasionally annoyed by expansions that I make mid-line and cause a common
suffix in the completion to be repeated. For instance, say in an earlier line of
a file I have:
</p>

<details id='org666e93a' class='code' open>
<summary></summary>
<div class='gutter'><a href='#org666e93a'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="org666e93a">
func foo(int x, int y, int z)
</pre>

</details>

<p>
where the <kbd>int y</kbd> argument has just been added. I move to another function that
should have the same adjustment and invoke hippie-expand (at <code>|</code>) to save me keystrokes:
</p>

<details id='org6d60fe6' class='code' open>
<summary></summary>
<div class='gutter'><a href='#org6d60fe6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="org6d60fe6">
func bar(int x,| int z)
</pre>

</details>

<p>
This invokes <code>try-expand-list</code> and completes to
</p>

<details id='org4d35248' class='code' open>
<summary></summary>
<div class='gutter'><a href='#org4d35248'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="org4d35248">
func bar(int x, int y, int z) int z)
</pre>

</details>

<p>
Clearly, that's not what I want! I suspect that we can make it "just work" the
vast majority of the time by looking to see if there's a suffix in the
completion that's also a prefix of the remainder of the line, and stripping it.
In our example, this would be <kbd>int z)</kbd> which would turn the completed line into:
</p>

<details id='orgf188b3c' class='code' open>
<summary></summary>
<div class='gutter'><a href='#orgf188b3c'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="orgf188b3c">
func bar(int x, int y, int z)
</pre>

</details>

<p>
Hippie-expand doesn't provide a good point to modify expansion behaviour like
this, however the insertion of the expansion is handled by the helper function
<code>he-substitute-strings</code>, which we can advise to behave as we wish.
</p>

<details id='suffix-stripping,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#suffix-stripping,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+he-subst-suffix-overlap</span> (ins rem)
  <span class="org-doc">"The longest suffix of the string INS that is a prefix of REM.</span>
<span class="org-doc">This is intended to be used when INS is a newly inserted string and REM is the</span>
<span class="org-doc">remainder of the line, to allow for handling potentially duplicated content."</span>
  (<span class="org-keyword">let</span> ((len (min (length ins) (length rem))))
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (&gt; len 0)
                (not (eq 't (compare-strings ins (- len) nil rem 0 len))))
      (<span class="org-keyword">setq</span> len (1- len)))
    len))

(<span class="org-keyword">defun</span> <span class="org-function-name">+he-suffix-strip-a</span> (args)
  <span class="org-doc">"Filter ARG list for `</span><span class="org-doc"><span class="org-constant">he-substitute-string</span></span><span class="org-doc">', truncating duplicated suffix.</span>
<span class="org-doc">ARGS is the raw argument list (STRING &amp;optional TRANS-CASE)."</span>
  (<span class="org-keyword">pcase-let*</span> ((`(,ins <span class="org-type">&amp;optional</span> ,trans-case) args)
               (rem (<span class="org-keyword">save-excursion</span>
                      (goto-char (marker-position he-string-end))
                      (buffer-substring-no-properties
                       (point) (line-end-position))))
               (ov (+he-subst-suffix-overlap ins rem)))
    (<span class="org-keyword">when</span> (&gt;= ov 0)
      (<span class="org-keyword">setq</span> ins (substring ins 0 (- (length ins) ov))))
    (list ins trans-case)))

(advice-add #'he-substitute-string <span class="org-builtin">:filter-args</span> #'+he-suffix-strip-a)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-buffer-defaults" class="outline-4">
<h4 id="buffer-defaults"><span class="section-number-4">2.3.6.</span> Buffer defaults<a aria-hidden="true" href="#buffer-defaults">#</a> </h4>
<div class="outline-text-4" id="text-2-3-6">
<p>
I'd much rather have my new buffers in <code>org-mode</code> than <code>fundamental-mode</code>, hence
</p>
<details id='buffer-defaults,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#buffer-defaults,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">(setq-default major-mode 'org-mode)</span>
</pre>
</div>
</details>
<p>
For some reason this + the mixed pitch hook causes issues with hydra and so I'll
just need to resort to <kbd>SPC b o</kbd> for now.
</p>
</div>
</div>
</div>
<div id="outline-container-doom-configuration" class="outline-3">
<h3 id="doom-configuration"><span class="section-number-3">2.4.</span> Doom configuration<a aria-hidden="true" href="#doom-configuration">#</a> </h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-modules" class="outline-4">
<h4 id="modules"><span class="section-number-4">2.4.1.</span> Modules<a aria-hidden="true" href="#modules">#</a> </h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
Doom has this lovely <i>modular configuration base</i> that takes a lot of work out of
configuring Emacs. Each module (when enabled) can provide a list of packages to
install (on <code>doom sync</code>) and configuration to be applied. The modules can also
have flags applied to tweak their behaviour.
</p>

<details id='initel' class='code'><summary class='named'><span class="name">init.el</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#initel'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">init.el -*- lexical-binding: t; -*-</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">This file controls what Doom modules are enabled and what order they load in.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Press '</span><span class="org-comment"><span class="org-constant">K</span></span><span class="org-comment">' on a module to view its documentation, and '</span><span class="org-comment"><span class="org-constant">gd</span></span><span class="org-comment">' to browse its directory.</span>

(<span class="org-keyword">doom!</span> <span class="org-builtin">:input</span>
       &lt;&lt;doom-input&gt;&gt;

       <span class="org-builtin">:completion</span>
       &lt;&lt;doom-completion&gt;&gt;

       <span class="org-builtin">:ui</span>
       &lt;&lt;doom-ui&gt;&gt;

       <span class="org-builtin">:editor</span>
       &lt;&lt;doom-editor&gt;&gt;

       <span class="org-builtin">:emacs</span>
       &lt;&lt;doom-emacs&gt;&gt;

       <span class="org-builtin">:term</span>
       &lt;&lt;doom-term&gt;&gt;

       <span class="org-builtin">:checkers</span>
       &lt;&lt;doom-checkers&gt;&gt;

       <span class="org-builtin">:tools</span>
       &lt;&lt;doom-tools&gt;&gt;

       <span class="org-builtin">:os</span>
       &lt;&lt;doom-os&gt;&gt;

       <span class="org-builtin">:lang</span>
       &lt;&lt;doom-lang&gt;&gt;

       <span class="org-builtin">:email</span>
       &lt;&lt;doom-email&gt;&gt;

       <span class="org-builtin">:app</span>
       &lt;&lt;doom-app&gt;&gt;

       <span class="org-builtin">:config</span>
       &lt;&lt;doom-config&gt;&gt;
       )
</pre>
</div>
</details>
</div>
<div id="outline-container-structure" class="outline-5">
<h5 id="structure"><span class="section-number-5">2.4.1.1.</span> Structure<a aria-hidden="true" href="#structure">#</a> </h5>
<div class="outline-text-5" id="text-2-4-1-1">
<p>
As you may have noticed by this point, this is a <a href="https://en.wikipedia.org/wiki/Literate_programming">literate</a> configuration. Doom
has good support for this which we access though the <code>literate</code> module.
</p>

<p>
While we're in the <code class="src src-elisp"><span class="org-builtin">:config</span></code> section, we'll use Dooms nicer defaults,
along with the bindings and smartparens behaviour (the flags aren't documented,
but they exist).
</p>
<details id='doom-config' class='code' open><summary class='named'><span class="name">doom-config</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-config'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">literate
(default +bindings +smartparens)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-interface" class="outline-5">
<h5 id="interface"><span class="section-number-5">2.4.1.2.</span> Interface<a aria-hidden="true" href="#interface">#</a> </h5>
<div class="outline-text-5" id="text-2-4-1-2">
<p>
There's a lot that can be done to enhance Emacs' capabilities.
I reckon enabling half the modules Doom provides should do it.
</p>

<details id='doom-completion' class='code' open><summary class='named'><span class="name">doom-completion</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-completion'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">company                   ; the ultimate code completion backend</span>
(corfu +orderless +dabbrev)  <span class="org-comment-delimiter">; </span><span class="org-comment">complete with cap(f), cape and a flying feather!</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">helm                       ; the *other* search engine for love and life</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">ido                        ; the other *other* search engine...</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">(ivy                      ; a search engine for love and life</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">+icons                   ; ... icons are nice</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">+prescient)              ; ... I know what I want(ed)</span>
(vertico +icons)             <span class="org-comment-delimiter">; </span><span class="org-comment">the search engine of the future</span>
</pre>
</div>
</details>

<details id='doom-ui' class='code' open><summary class='named'><span class="name">doom-ui</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-ui'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;</span><span class="org-comment">deft                       ; notational velocity for Emacs</span>
doom                         <span class="org-comment-delimiter">; </span><span class="org-comment">what makes DOOM look the way it does</span>
doom-dashboard               <span class="org-comment-delimiter">; </span><span class="org-comment">a nifty splash screen for Emacs</span>
doom-quit                    <span class="org-comment-delimiter">; </span><span class="org-comment">DOOM quit-message prompts when you quit Emacs</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">(emoji +unicode)          ; &#128578;</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">fill-column                ; a `</span><span class="org-comment"><span class="org-constant">fill-column</span></span><span class="org-comment">' indicator</span>
hl-todo                      <span class="org-comment-delimiter">; </span><span class="org-comment">highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">hydra                      ; quick documentation for related commands</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">indent-guides              ; highlighted indent columns, notoriously slow</span>
(ligatures +extra)           <span class="org-comment-delimiter">; </span><span class="org-comment">ligatures and symbols to make your code pretty again</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">minimap                    ; show a map of the code on the side</span>
modeline                     <span class="org-comment-delimiter">; </span><span class="org-comment">snazzy, Atom-inspired modeline, plus API</span>
nav-flash                    <span class="org-comment-delimiter">; </span><span class="org-comment">blink the current line after jumping</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">neotree                    ; a project drawer, like NERDTree for vim</span>
ophints                      <span class="org-comment-delimiter">; </span><span class="org-comment">highlight the region an operation acts on</span>
(popup                       <span class="org-comment-delimiter">; </span><span class="org-comment">tame sudden yet inevitable temporary windows</span>
 +all                        <span class="org-comment-delimiter">; </span><span class="org-comment">catch all popups that start with an asterix</span>
 +defaults)                  <span class="org-comment-delimiter">; </span><span class="org-comment">default popup rules</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(tabs                      ; an tab bar for Emacs</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">+centaur-tabs)           ; ... with prettier tabs</span>
treemacs                     <span class="org-comment-delimiter">; </span><span class="org-comment">a project drawer, like neotree but cooler</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">unicode                    ; extended unicode support for various languages</span>
(vc-gutter +pretty)          <span class="org-comment-delimiter">; </span><span class="org-comment">vcs diff in the fringe</span>
vi-tilde-fringe              <span class="org-comment-delimiter">; </span><span class="org-comment">fringe tildes to mark beyond EOB</span>
(window-select +numbers)     <span class="org-comment-delimiter">; </span><span class="org-comment">visually switch windows</span>
workspaces                   <span class="org-comment-delimiter">; </span><span class="org-comment">tab emulation, persistence &amp; separate workspaces</span>
zen                          <span class="org-comment-delimiter">; </span><span class="org-comment">distraction-free coding or writing</span>
</pre>
</div>
</details>

<details id='doom-editor' class='code' open><summary class='named'><span class="name">doom-editor</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-editor'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(evil +everywhere)           <span class="org-comment-delimiter">; </span><span class="org-comment">come to the dark side, we have cookies</span>
file-templates               <span class="org-comment-delimiter">; </span><span class="org-comment">auto-snippets for empty files</span>
fold                         <span class="org-comment-delimiter">; </span><span class="org-comment">(nigh) universal code folding</span>
(format)                     <span class="org-comment-delimiter">; </span><span class="org-comment">automated prettiness</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">god                        ; run Emacs commands without modifier keys</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">lispy                      ; vim for lisp, for people who don't like vim</span>
multiple-cursors             <span class="org-comment-delimiter">; </span><span class="org-comment">editing in many places at once</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">objed                      ; text object editing for the innocent</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">parinfer                   ; turn lisp into python, sort of</span>
rotate-text                  <span class="org-comment-delimiter">; </span><span class="org-comment">cycle region at point between text candidates</span>
snippets                     <span class="org-comment-delimiter">; </span><span class="org-comment">my elves. They type so I don't have to</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">word-wrap                  ; soft wrapping with language-aware indent</span>
</pre>
</div>
</details>

<details id='doom-emacs' class='code' open><summary class='named'><span class="name">doom-emacs</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-emacs'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(dired +icons)               <span class="org-comment-delimiter">; </span><span class="org-comment">making dired pretty [functional]</span>
electric                     <span class="org-comment-delimiter">; </span><span class="org-comment">smarter, keyword-based electric-indent</span>
(ibuffer +icons)             <span class="org-comment-delimiter">; </span><span class="org-comment">interactive buffer management</span>
undo                         <span class="org-comment-delimiter">; </span><span class="org-comment">persistent, smarter undo for your inevitable mistakes</span>
vc                           <span class="org-comment-delimiter">; </span><span class="org-comment">version-control and Emacs, sitting in a tree</span>
</pre>
</div>
</details>

<details id='doom-term' class='code' open><summary class='named'><span class="name">doom-term</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-term'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;</span><span class="org-comment">eshell                     ; the elisp shell that works everywhere</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">shell                      ; simple shell REPL for Emacs</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">term                       ; basic terminal emulator for Emacs</span>
vterm                        <span class="org-comment-delimiter">; </span><span class="org-comment">the best terminal emulation in Emacs</span>
</pre>
</div>
</details>

<details id='doom-checkers' class='code' open><summary class='named'><span class="name">doom-checkers</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-checkers'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">syntax                       <span class="org-comment-delimiter">; </span><span class="org-comment">tasing you for every semicolon you forget</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">spell                     ; tasing you for misspelling mispelling</span>
grammar                      <span class="org-comment-delimiter">; </span><span class="org-comment">tasing grammar mistake every you make</span>
</pre>
</div>
</details>

<details id='doom-tools' class='code' open><summary class='named'><span class="name">doom-tools</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-tools'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">ansible                      <span class="org-comment-delimiter">; </span><span class="org-comment">a crucible for infrastructure as code</span>
biblio                       <span class="org-comment-delimiter">; </span><span class="org-comment">Writes a PhD for you (citation needed)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">collab                     ; buffers with friends</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">debugger                   ; FIXME stepping through code, to help you add bugs</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">direnv                     ; be direct about your environment</span>
docker                       <span class="org-comment-delimiter">; </span><span class="org-comment">port everything to containers</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">editorconfig               ; let someone else argue about tabs vs spaces</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">ein                        ; tame Jupyter notebooks with emacs</span>
(eval +overlay)              <span class="org-comment-delimiter">; </span><span class="org-comment">run code, run (also, repls)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">gist                       ; interacting with github gists</span>
(lookup                      <span class="org-comment-delimiter">; </span><span class="org-comment">helps you navigate your code and documentation</span>
 +dictionary                 <span class="org-comment-delimiter">; </span><span class="org-comment">dictionary/thesaurus is nice</span>
 +docsets)                   <span class="org-comment-delimiter">; </span><span class="org-comment">...or in Dash docsets locally</span>
lsp                          <span class="org-comment-delimiter">; </span><span class="org-comment">Language Server Protocol</span>
(magit                       <span class="org-comment-delimiter">; </span><span class="org-comment">a git porcelain for Emacs</span>
 +forge)                     <span class="org-comment-delimiter">; </span><span class="org-comment">interface with git forges</span>
make                         <span class="org-comment-delimiter">; </span><span class="org-comment">run make tasks from Emacs</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">pass                       ; password manager for nerds</span>
pdf                          <span class="org-comment-delimiter">; </span><span class="org-comment">pdf enhancements</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">prodigy                    ; FIXME managing external services &amp; code builders</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">terraform                  ; infrastructure as code</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">tmux                       ; an API for interacting with tmux</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">tree-sitter                ; syntax and parsing, sitting in a tree...</span>
upload                       <span class="org-comment-delimiter">; </span><span class="org-comment">map local to remote projects via ssh/ftp</span>
</pre>
</div>
</details>

<details id='doom-os' class='code' open><summary class='named'><span class="name">doom-os</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-os'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-builtin">:if</span> (<span class="org-keyword">featurep</span> <span class="org-constant">:system</span> 'macos) macos) <span class="org-comment-delimiter">; </span><span class="org-comment">improve compatibility with macOS</span>
tty                          <span class="org-comment-delimiter">; </span><span class="org-comment">improve the terminal Emacs experience</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-language-support" class="outline-5">
<h5 id="language-support"><span class="section-number-5">2.4.1.3.</span> Language support<a aria-hidden="true" href="#language-support">#</a> </h5>
<div class="outline-text-5" id="text-2-4-1-3">
<p>
We can be rather liberal with enabling support for languages as the associated
packages/configuration are (usually) only loaded when first opening an
associated file.
</p>

<details id='doom-lang' class='code' open><summary class='named'><span class="name">doom-lang</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-lang'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;</span><span class="org-comment">agda                       ; types of types of types of types...</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">beancount                  ; mind the GAAP</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(cc +lsp)                  ; C &gt; C++ == 1</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">clojure                    ; java with a lisp</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">common-lisp                ; if you've seen one lisp, you've seen them all</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">coq                        ; proofs-as-programs</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">crystal                    ; ruby at the speed of c</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">csharp                     ; unity, .NET, and mono shenanigans</span>
data                         <span class="org-comment-delimiter">; </span><span class="org-comment">config/data formats</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(dart +flutter)            ; paint ui and not much else</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">dhall                      ; JSON with FP sprinkles</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">elixir                     ; erlang done right</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">elm                        ; care for a cup of TEA?</span>
emacs-lisp                   <span class="org-comment-delimiter">; </span><span class="org-comment">drown in parentheses</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">erlang                     ; an elegant language for a more civilized age</span>
ess                          <span class="org-comment-delimiter">; </span><span class="org-comment">emacs speaks statistics</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">faust                      ; dsp, but you get to keep your soul</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">fsharp                     ; ML stands for Microsoft's Language</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">fstar                      ; (dependent) types and (monadic) effects and Z3</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">gdscript                   ; the language you waited for</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(graphql +lsp)             ; Give queries a REST</span>
(go +lsp)                    <span class="org-comment-delimiter">; </span><span class="org-comment">the hipster dialect</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(haskell +lsp)             ; a language that's lazier than I am</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">hy                         ; readability of scheme w/ speed of python</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">idris                      ;</span>
json                         <span class="org-comment-delimiter">; </span><span class="org-comment">At least it ain't XML</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(java +lsp)                ; the poster child for carpal tunnel syndrome</span>
(javascript +lsp)            <span class="org-comment-delimiter">; </span><span class="org-comment">all(hope(abandon(ye(who(enter(here))))))</span>
(julia +lsp)                 <span class="org-comment-delimiter">; </span><span class="org-comment">Python, R, and MATLAB in a blender</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">kotlin                     ; a better, slicker Java(Script)</span>
(latex                       <span class="org-comment-delimiter">; </span><span class="org-comment">writing papers in Emacs has never been so fun</span>
 +latexmk                    <span class="org-comment-delimiter">; </span><span class="org-comment">what else would you use?</span>
 +cdlatex                    <span class="org-comment-delimiter">; </span><span class="org-comment">quick maths symbols</span>
 +fold)                      <span class="org-comment-delimiter">; </span><span class="org-comment">fold the clutter away nicities</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">lean                       ; proof that mathematicians need help</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">factor                     ; for when scripts are stacked against you</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">ledger                     ; an accounting system in Emacs</span>
lua                          <span class="org-comment-delimiter">; </span><span class="org-comment">one-based indices? one-based indices</span>
markdown                     <span class="org-comment-delimiter">; </span><span class="org-comment">writing docs for people to ignore</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">nim                        ; python + lisp at the speed of c</span>
nix                          <span class="org-comment-delimiter">; </span><span class="org-comment">I hereby declare "nix geht mehr!"</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">ocaml                      ; an objective camel</span>
(org                         <span class="org-comment-delimiter">; </span><span class="org-comment">organize your plain life in plain text</span>
 +dragndrop                  <span class="org-comment-delimiter">; </span><span class="org-comment">drag &amp; drop files/images into org buffers</span>
 <span class="org-comment-delimiter">;;</span><span class="org-comment">+hugo                     ; use Emacs for hugo blogging</span>
 +noter                      <span class="org-comment-delimiter">; </span><span class="org-comment">enhanced PDF notetaking</span>
 +jupyter                    <span class="org-comment-delimiter">; </span><span class="org-comment">ipython/jupyter support for babel</span>
 +pandoc                     <span class="org-comment-delimiter">; </span><span class="org-comment">export-with-pandoc support</span>
 +gnuplot                    <span class="org-comment-delimiter">; </span><span class="org-comment">who doesn't like pretty pictures</span>
 <span class="org-comment-delimiter">;;</span><span class="org-comment">+pomodoro                 ; be fruitful with the tomato technique</span>
 +present                    <span class="org-comment-delimiter">; </span><span class="org-comment">using org-mode for presentations</span>
 +roam2)                     <span class="org-comment-delimiter">; </span><span class="org-comment">wander around notes</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">php                        ; perl's insecure younger brother</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">plantuml                   ; diagrams for confusing people more</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">purescript                 ; javascript, but functional</span>
(python +lsp +pyright)       <span class="org-comment-delimiter">; </span><span class="org-comment">beautiful is better than ugly</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">qt                         ; the '</span><span class="org-comment"><span class="org-constant">cutest</span></span><span class="org-comment">' gui framework ever</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">racket                     ; a DSL for DSLs</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">raku                       ; the artist formerly known as perl6</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">rest                       ; Emacs as a REST client</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">rst                        ; ReST in peace</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(ruby +rails)              ; 1.step {|i| p "Ruby is #{i.even? ? '</span><span class="org-comment"><span class="org-constant">love</span></span><span class="org-comment">' : '</span><span class="org-comment"><span class="org-constant">life</span></span><span class="org-comment">'}"}</span>
(rust +lsp)                  <span class="org-comment-delimiter">; </span><span class="org-comment">Fe2O3.unwrap().unwrap().unwrap().unwrap()</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">scala                      ; java, but good</span>
scheme                       <span class="org-comment-delimiter">; </span><span class="org-comment">a fully conniving family of lisps</span>
sh                           <span class="org-comment-delimiter">; </span><span class="org-comment">she sells {ba,z,fi}sh shells on the C xor</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">sml                        ; no, the /other/ ML</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">solidity                   ; do you need a blockchain? No.</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">swift                      ; who asked for emoji variables?</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">terra                      ; Earth and Moon in alignment for performance.</span>
web                          <span class="org-comment-delimiter">; </span><span class="org-comment">the tubes</span>
yaml                         <span class="org-comment-delimiter">; </span><span class="org-comment">JSON, but readable</span>
zig                          <span class="org-comment-delimiter">; </span><span class="org-comment">C, but simpler</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-input" class="outline-5">
<h5 id="input"><span class="section-number-5">2.4.1.4.</span> Input<a aria-hidden="true" href="#input">#</a> </h5>
<div class="outline-text-5" id="text-2-4-1-4">
<details id='doom-input' class='code' open><summary class='named'><span class="name">doom-input</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-input'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;</span><span class="org-comment">bidi                       ; (tfel ot) thgir etirw uoy gnipleh</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">chinese</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">japanese</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">layout                     ; auie,ctsrnm is the superior home row</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-everything-emacs" class="outline-5">
<h5 id="everything-emacs"><span class="section-number-5">2.4.1.5.</span> Everything in Emacs<a aria-hidden="true" href="#everything-emacs">#</a> </h5>
<div class="outline-text-5" id="text-2-4-1-5">
<p>
It's just too convenient being able to have everything in Emacs.
I couldn't resist the Email and Feed modules.
</p>

<details id='doom-email' class='code' open><summary class='named'><span class="name">doom-email</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-email'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-builtin">:if</span> (executable-find <span class="org-string">"mu"</span>) (mu4e +org))
<span class="org-comment-delimiter">;;</span><span class="org-comment">notmuch</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">(wanderlust +gmail)</span>
</pre>
</div>
</details>

<details id='doom-app' class='code' open><summary class='named'><span class="name">doom-app</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#doom-app'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;</span><span class="org-comment">calendar                   ; A dated approach to timetabling</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">emms                       ; Multimedia in Emacs is music to my ears</span>
everywhere                   <span class="org-comment-delimiter">; </span><span class="org-comment">*leave* Emacs!? You must be joking.</span>
irc                          <span class="org-comment-delimiter">; </span><span class="org-comment">how neckbeards socialize</span>
(rss +org)                   <span class="org-comment-delimiter">; </span><span class="org-comment">emacs as an RSS reader</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">twitter                    ; twitter client https://twitter.com/vnought</span>
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-profiles" class="outline-4">
<h4 id="profiles"><span class="section-number-4">2.4.2.</span> Profiles<a aria-hidden="true" href="#profiles">#</a> </h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
Doom has support for multiple configuration profiles. For general usage, this
isn't a particularly useful feature, but for niche use cases it's fantastic.
</p>

<details id='profiles,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#profiles,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">((orgdev (env (<span class="org-string">"DOOMDIR"</span> . <span class="org-string">"~/.config/doom.orgdev"</span>))))
</pre>
</div>
</details>
</div>
<div id="outline-container-org-development-profile" class="outline-5">
<h5 id="org-development-profile"><span class="section-number-5">2.4.2.1.</span> Org development profile<a aria-hidden="true" href="#org-development-profile">#</a> </h5>
<div class="outline-text-5" id="text-2-4-2-1">
<p>
For development purposes, it's handy to have a more minimal config without my
many customisations and interacting packages. Let's go ahead and create a
near-minimal new config:
</p>

<details id='org-development-profile,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-development-profile,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">init.el -*- lexical-binding: t; -*-</span>
(<span class="org-keyword">doom!</span> <span class="org-builtin">:completion</span> vertico
       <span class="org-builtin">:editor</span> evil
       <span class="org-builtin">:config</span> (default +bindings))
</pre>
</div>
</details>

<details id='org-development-profile,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-development-profile,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unpin!</span> org) <span class="org-comment-delimiter">; </span><span class="org-comment">there be bugs</span>
</pre>
</div>
</details>

<details id='org-development-profile,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-development-profile,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">org</span>)
(load-theme 'modus-operandi t)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-visual-settings" class="outline-4">
<h4 id="visual-settings"><span class="section-number-4">2.4.3.</span> Visual Settings<a aria-hidden="true" href="#visual-settings">#</a> </h4>
<div class="outline-text-4" id="text-2-4-3">
</div>
<div id="outline-container-font-face" class="outline-5">
<h5 id="font-face"><span class="section-number-5">2.4.3.1.</span> Font Face<a aria-hidden="true" href="#font-face">#</a> </h5>
<div class="outline-text-5" id="text-2-4-3-1">
</div>
<div id="outline-container-setting-fonts" class="outline-6">
<h6 id="setting-fonts"><span class="section-number-6">2.4.3.1.1.</span> Setting fonts<a aria-hidden="true" href="#setting-fonts">#</a> </h6>
<div class="outline-text-6" id="text-2-4-3-1-1">
<p>
'Fira Code' is nice, and 'Overpass' makes for a nice sans companion. We just need to
fiddle with the font sizes a tad so that they visually match. Just for fun I'm
trying out JetBrains Mono though. So far I have mixed feelings on it, some
aspects are nice, but on others I prefer Fira.
</p>

<details id='setting-fonts,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#setting-fonts,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> doom-font (font-spec <span class="org-builtin">:family</span> <span class="org-string">"JetBrains Mono"</span> <span class="org-builtin">:size</span> 24)
      doom-big-font (font-spec <span class="org-builtin">:family</span> <span class="org-string">"JetBrains Mono"</span> <span class="org-builtin">:size</span> 36)
      doom-variable-pitch-font (font-spec <span class="org-builtin">:family</span> <span class="org-string">"Overpass"</span> <span class="org-builtin">:size</span> 26)
      doom-symbol-font (font-spec <span class="org-builtin">:family</span> <span class="org-string">"JuliaMono"</span>)
      doom-emoji-font (font-spec <span class="org-builtin">:family</span> <span class="org-string">"Twitter Color Emoji"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">Just used by me</span>
      doom-serif-font (font-spec <span class="org-builtin">:family</span> <span class="org-string">"IBM Plex Mono"</span> <span class="org-builtin">:size</span> 22 <span class="org-builtin">:weight</span> 'light))
</pre>
</div>
</details>


<figure id="orgc6b0790">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/font-face.png" alt="Screenshot of the fonts within Emacs." class="invertible">

</figure>

<p>
In addition to these fonts, Merriweather is used with <kbd>nov.el</kbd>, and Alegreya as a
serifed proportional font used by <kbd>mixed-pitch-mode</kbd> for <kbd>writeroom-mode</kbd> with Org
files.
</p>
</div>
</div>
<div id="outline-container-emojis" class="outline-6">
<h6 id="emojis"><span class="section-number-6">2.4.3.1.2.</span> Emojis<a aria-hidden="true" href="#emojis">#</a> </h6>
<div class="outline-text-6" id="text-2-4-3-1-2">
<p>
Emacs (28+) has an <code>emoji</code> script table. We're about to use it, but before doing
so we're going to excise a few characters that I actually want rendered as
using the symbol font (not as emojis).
</p>

<details id='emojis,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">dolist</span> (char '(?&#9193; ?&#9194; ?&#10067;))
  (set-char-table-range char-script-table char 'symbol))
</pre>
</div>
</details>

<p>
To actually sort out emojis, all that's really needed here is to apply
<kbd>doom-emoji-font</kbd>, which needs to be done <i>here</i> because it's not <i>actually</i> a Doom
font variable, but rather my own addition.
</p>

<details id='emojis,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">add-hook!</span> 'after-setting-font-hook
  (<span class="org-keyword">defun</span> <span class="org-function-name">+emoji-set-font</span> ()
    (set-fontset-font t 'emoji doom-emoji-font nil 'prepend)))
</pre>
</div>
</details>

<p>
We might as well also construct a regexp to make identifying emojis if buffers
more convenient.
</p>

<details id='emojis,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+emoji-rx</span>
  (<span class="org-keyword">let</span> (emojis)
    (map-char-table
     (<span class="org-keyword">lambda</span> (char set)
       (<span class="org-keyword">when</span> (eq set 'emoji)
         (<span class="org-keyword">push</span> (copy-tree char) emojis)))
     char-script-table)
    (rx-to-string `(any ,@emojis)))
  <span class="org-doc">"A regexp to find all emoji-script characters."</span>)
</pre>
</div>
</details>

<p>
For the sake of convenient insertion, we'll also register some emoji aliases
based on common usage.
</p>

<details id='emojis,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> emoji-alternate-names
      '((<span class="org-string">"&#128578;"</span> <span class="org-string">":)"</span>)
        (<span class="org-string">"&#128516;"</span> <span class="org-string">":D"</span>)
        (<span class="org-string">"&#128521;"</span> <span class="org-string">";)"</span>)
        (<span class="org-string">"&#128577;"</span> <span class="org-string">":("</span>)
        (<span class="org-string">"&#128518;"</span> <span class="org-string">"laughing face"</span> <span class="org-string">"xD"</span>)
        (<span class="org-string">"&#129315;"</span> <span class="org-string">"ROFL face"</span>)
        (<span class="org-string">"&#128546;"</span> <span class="org-string">":'("</span>)
        (<span class="org-string">"&#129394;"</span> <span class="org-string">":')"</span>)
        (<span class="org-string">"&#128558;"</span> <span class="org-string">":o"</span>)
        (<span class="org-string">"&#128529;"</span> <span class="org-string">":|"</span>)
        (<span class="org-string">"&#128526;"</span> <span class="org-string">"cool face"</span>)
        (<span class="org-string">"&#129322;"</span> <span class="org-string">"goofy face"</span>)
        (<span class="org-string">"&#129317;"</span> <span class="org-string">"pinnochio face"</span> <span class="org-string">"liar face"</span>)
        (<span class="org-string">"&#128544;"</span> <span class="org-string">"&gt;:("</span>)
        (<span class="org-string">"&#128545;"</span> <span class="org-string">"angry+ face"</span>)
        (<span class="org-string">"&#129324;"</span> <span class="org-string">"swearing face"</span>)
        (<span class="org-string">"&#129314;"</span> <span class="org-string">"sick face"</span>)
        (<span class="org-string">"&#128520;"</span> <span class="org-string">"smiling imp"</span>)
        (<span class="org-string">"&#128127;"</span> <span class="org-string">"frowning imp"</span>)
        (<span class="org-string">"&#10084;&#65039;"</span> <span class="org-string">"&lt;3"</span>)
        (<span class="org-string">"&#129761;"</span> <span class="org-string">"o7"</span>)
        (<span class="org-string">"&#128077;"</span> <span class="org-string">"+1"</span>)
        (<span class="org-string">"&#128078;"</span> <span class="org-string">"-1"</span>)
        (<span class="org-string">"&#128072;"</span> <span class="org-string">"left"</span>)
        (<span class="org-string">"&#128073;"</span> <span class="org-string">"right"</span>)
        (<span class="org-string">"&#128070;"</span> <span class="org-string">"up"</span>)
        (<span class="org-string">"&#128175;"</span> <span class="org-string">"100"</span>)
        (<span class="org-string">"&#128184;"</span> <span class="org-string">"flying money"</span>)))
</pre>
</div>
</details>

<p>
Lastly, when using Emacs 28+ it would be nice to open the nice emoji dispatch
with the leader key as well as <kbd>C-x 8 e</kbd>. Since <kbd>SPC e</kbd> is unclaimed, let's just use
that until we have a better use for it (we could also split up the insertion and
querying commands in other parts of the map).
</p>

<details id='emojis,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (&gt;= emacs-major-version 29)
  (map! <span class="org-builtin">:leader</span>
        (<span class="org-builtin">:prefix</span> (<span class="org-string">"e"</span> . <span class="org-string">"Emoji"</span>)
         <span class="org-builtin">:desc</span> <span class="org-string">"Search"</span> <span class="org-string">"s"</span> #'emoji-search
         <span class="org-builtin">:desc</span> <span class="org-string">"Recent"</span> <span class="org-string">"r"</span> #'emoji-recent
         <span class="org-builtin">:desc</span> <span class="org-string">"List"</span> <span class="org-string">"l"</span> #'emoji-list
         <span class="org-builtin">:desc</span> <span class="org-string">"Describe"</span> <span class="org-string">"d"</span> #'emoji-describe
         <span class="org-builtin">:desc</span> <span class="org-string">"Insert"</span> <span class="org-string">"i"</span> #'emoji-insert
         <span class="org-builtin">:desc</span> <span class="org-string">"Insert"</span> <span class="org-string">"e"</span> #'emoji-insert)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-checking-system" class="outline-6">
<h6 id="checking-system"><span class="section-number-6">2.4.3.1.3.</span> Checking the system<a aria-hidden="true" href="#checking-system">#</a> </h6>
<div class="outline-text-6" id="text-2-4-3-1-3">
<p>
Because we care about how things look let's add a check to make sure we're told
if the system doesn't have any of those fonts. We can obtain a list of installed
fonts with either <code>(font-family-list)</code> or with the <code>fc-list</code> command.
</p>

<details id='detect-missing-fonts' class='code' open><summary class='named'><span class="name">detect-missing-fonts</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#detect-missing-fonts'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> required-fonts '(<span class="org-string">"JetBrains ?Mono.*"</span> <span class="org-string">"Overpass"</span> <span class="org-string">"JuliaMono"</span> <span class="org-string">"IBM Plex Mono"</span>
                       <span class="org-string">"Merriweather"</span> <span class="org-string">"Alegreya"</span> <span class="org-string">"Twitter Color Emoji"</span>))

(<span class="org-keyword">setq</span> available-fonts
      (delete-dups
       (<span class="org-keyword">or</span> (font-family-list)
           (<span class="org-keyword">and</span> (executable-find <span class="org-string">"fc-list"</span>)
                (<span class="org-keyword">with-temp-buffer</span>
                  (call-process <span class="org-string">"fc-list"</span> nil t nil <span class="org-string">":"</span> <span class="org-string">"family"</span>)
                  (split-string (buffer-string) <span class="org-string">"[,\n]"</span>))))))

(<span class="org-keyword">setq</span> missing-fonts
      (delq nil (mapcar
                 (<span class="org-keyword">lambda</span> (font)
                   (<span class="org-keyword">unless</span> (delq nil (mapcar (<span class="org-keyword">lambda</span> (f)
                                               (string-match-p (format <span class="org-string">"^%s$"</span> font) f))
                                             available-fonts))
                     font))
                 required-fonts)))
</pre>
</div>
</details>

<p>
We can then use this to create a <kbd>doctor</kbd> check.
</p>

<details id='checking-system,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#checking-system,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let</span> (required-fonts available-fonts missing-fonts)
  (<span class="org-keyword">setq</span> required-fonts '(<span class="org-string">"JetBrains ?Mono.*"</span> <span class="org-string">"Overpass"</span> <span class="org-string">"JuliaMono"</span> <span class="org-string">"IBM Plex Mono"</span>
                         <span class="org-string">"Merriweather"</span> <span class="org-string">"Alegreya"</span> <span class="org-string">"Twitter Color Emoji"</span>))

  (<span class="org-keyword">setq</span> available-fonts
        (delete-dups
         (<span class="org-keyword">or</span> (font-family-list)
             (<span class="org-keyword">and</span> (executable-find <span class="org-string">"fc-list"</span>)
                  (<span class="org-keyword">with-temp-buffer</span>
                    (call-process <span class="org-string">"fc-list"</span> nil t nil <span class="org-string">":"</span> <span class="org-string">"family"</span>)
                    (split-string (buffer-string) <span class="org-string">"[,\n]"</span>))))))

  (<span class="org-keyword">setq</span> missing-fonts
        (delq nil (mapcar
                   (<span class="org-keyword">lambda</span> (font)
                     (<span class="org-keyword">unless</span> (delq nil (mapcar (<span class="org-keyword">lambda</span> (f)
                                                 (string-match-p (format <span class="org-string">"^%s$"</span> font) f))
                                               available-fonts))
                       font))
                   required-fonts)))
  (<span class="org-keyword">if</span> available-fonts
      (<span class="org-keyword">dolist</span> (font missing-fonts)
        (warn! (format <span class="org-string">"Missing font: %s."</span> font)))
    (warn! <span class="org-string">"Unable to check for missing fonts, is fc-list installed?"</span>)))
</pre>
</div>
</details>

<p>
Furthermore, when fonts <i>are</i> missing, it could be good to check the state of
affairs on startup.
</p>

<details id='warn-missing-fonts' class='code' open><summary class='named'><span class="name">warn-missing-fonts</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#warn-missing-fonts'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> required-fonts '(<span class="org-string">"JetBrains ?Mono.*"</span> <span class="org-string">"Overpass"</span> <span class="org-string">"JuliaMono"</span> <span class="org-string">"IBM Plex Mono"</span>
                       <span class="org-string">"Merriweather"</span> <span class="org-string">"Alegreya"</span> <span class="org-string">"Twitter Color Emoji"</span>))

(<span class="org-keyword">setq</span> available-fonts
      (delete-dups
       (<span class="org-keyword">or</span> (font-family-list)
           (<span class="org-keyword">and</span> (executable-find <span class="org-string">"fc-list"</span>)
                (<span class="org-keyword">with-temp-buffer</span>
                  (call-process <span class="org-string">"fc-list"</span> nil t nil <span class="org-string">":"</span> <span class="org-string">"family"</span>)
                  (split-string (buffer-string) <span class="org-string">"[,\n]"</span>))))))

(<span class="org-keyword">setq</span> missing-fonts
      (delq nil (mapcar
                 (<span class="org-keyword">lambda</span> (font)
                   (<span class="org-keyword">unless</span> (delq nil (mapcar (<span class="org-keyword">lambda</span> (f)
                                               (string-match-p (format <span class="org-string">"^%s$"</span> font) f))
                                             available-fonts))
                     font))
                 required-fonts)))

(<span class="org-keyword">if</span> missing-fonts
    (pp-to-string
     `(<span class="org-keyword">unless</span> noninteractive
        (<span class="org-keyword">add-hook!</span> 'doom-init-ui-hook
          (run-at-time nil nil
                       (<span class="org-keyword">lambda</span> ()
                         (<span class="org-keyword">let</span> (required-fonts available-fonts missing-fonts)
                           (<span class="org-keyword">setq</span> required-fonts '(<span class="org-string">"JetBrains ?Mono.*"</span> <span class="org-string">"Overpass"</span> <span class="org-string">"JuliaMono"</span> <span class="org-string">"IBM Plex Mono"</span>
                                                  <span class="org-string">"Merriweather"</span> <span class="org-string">"Alegreya"</span> <span class="org-string">"Twitter Color Emoji"</span>))

                           (<span class="org-keyword">setq</span> available-fonts
                                 (delete-dups
                                  (<span class="org-keyword">or</span> (font-family-list)
                                      (<span class="org-keyword">and</span> (executable-find <span class="org-string">"fc-list"</span>)
                                           (<span class="org-keyword">with-temp-buffer</span>
                                             (call-process <span class="org-string">"fc-list"</span> nil t nil <span class="org-string">":"</span> <span class="org-string">"family"</span>)
                                             (split-string (buffer-string) <span class="org-string">"[,\n]"</span>))))))

                           (<span class="org-keyword">setq</span> missing-fonts
                                 (delq nil (mapcar
                                            (<span class="org-keyword">lambda</span> (font)
                                              (<span class="org-keyword">unless</span> (delq nil (mapcar (<span class="org-keyword">lambda</span> (f)
                                                                          (string-match-p (format <span class="org-string">"^%s$"</span> font) f))
                                                                        available-fonts))
                                                font))
                                            required-fonts)))
                           (message <span class="org-string">"%s missing the following fonts: %s"</span>
                                    (propertize <span class="org-string">"Warning!"</span> 'face '(bold warning))
                                    (mapconcat (<span class="org-keyword">lambda</span> (font)
                                                 (propertize font 'face 'font-lock-variable-name-face))
                                               ',missing-fonts
                                               <span class="org-string">", "</span>)))
                         (sleep-for 0.5))))))
  <span class="org-string">";; No missing fonts detected"</span>)
</pre>
</div>
</details>

<details id='checking-system,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#checking-system,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;warn-missing-fonts()&gt;&gt;
</pre>
</div>
</details>

<p>
This way whenever fonts are missing, after Doom's <span class='acr'>UI</span> has initialised, a warning
listing the missing fonts should appear for at least half a second.
</p>
</div>
</div>
</div>
<div id="outline-container-theme" class="outline-5">
<h5 id="theme"><span class="section-number-5">2.4.3.2.</span> Theme<a aria-hidden="true" href="#theme">#</a> </h5>
<div class="outline-text-5" id="text-2-4-3-2">
<p>
The <code>doom-one</code> theme is nice and all, but I find the <code>vibrant</code> variant nicer. With
the light themes, I rather like <code>doom-tomorrow-day</code>. I'd like to pick the default
from them based on the system theme. Thanks to the continued expansion of the
<kbd>xdg-desktop-portal</kbd> protocols, we can read this from D-Bus on most systems.
</p>

<details id='default-theme' class='code' open><summary class='named'><span class="name">default-theme</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#default-theme'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let</span> ((light-theme 'doom-tomorrow-day)
      (dark-theme 'doom-vibrant)
      (system-theme
       (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> (memq system-type '(gnu gnu/linux gnu/kfreebsd))
                (<span class="org-keyword">require</span> '<span class="org-constant">dbus</span> nil t)
                (caar
                 (<span class="org-keyword">ignore-errors</span>
                   (dbus-call-method
                    <span class="org-builtin">:session</span>
                    <span class="org-string">"org.freedesktop.portal.Desktop"</span> <span class="org-string">"/org/freedesktop/portal/desktop"</span>
                    <span class="org-string">"org.freedesktop.portal.Settings"</span> <span class="org-string">"Read"</span>
                    <span class="org-string">"org.freedesktop.appearance"</span> <span class="org-string">"color-scheme"</span>))))
           0)))
  (<span class="org-keyword">pcase</span> system-theme
    (1 dark-theme)
    (2 light-theme)
    (_ dark-theme)))
</pre>
</div>
</details>

<p>
We'll use the appropriate theme as the default, but let's also accept the theme
as an environment variable <kbd>DOOM_THEME</kbd> for fun.
</p>

<details id='theme,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#theme,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> doom-theme <span class="org-comment-delimiter">; </span><span class="org-comment">Set according to the env var or system-dependent default</span>
      (<span class="org-keyword">let</span> ((env-theme (getenv <span class="org-string">"DOOM_THEME"</span>)))
        (<span class="org-keyword">if</span> env-theme
            (intern env-theme) <span class="org-comment-delimiter">; </span><span class="org-comment">Note: `</span><span class="org-comment"><span class="org-constant">intern-soft</span></span><span class="org-comment">' doesn't work here</span>
          'nil)))
</pre>
</div>
</details>

<p>
Oh, and with the nice selection doom provides there's no reason for me to want
the defaults.
</p>

<details id='theme,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#theme,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">delq!</span> t custom-theme-load-path)
</pre>
</div>
</details>

<p>
While the theme environment variable is nice for flexibility, when starting
Emacs in a terminal it doesn't help us set the right sort of theme
automatically. However, we can check if we're in a terminal and pick a default
theme colour accordingly.
</p>

<details id='theme,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#theme,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">declare-function</span> 'xterm-query <span class="org-string">"xterm"</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">term-background-rgb</span> nil
  <span class="org-doc">"A RGB triple corresponding to the current terminal background, if known."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">+interpret-term-bg</span> ()
  <span class="org-doc">"Examine an OSC color query response, and set `</span><span class="org-doc"><span class="org-constant">term-background-rgb</span></span><span class="org-doc">' accordingly."</span>
  (<span class="org-keyword">let</span> ((str <span class="org-string">""</span>)
        chr)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">The reply should be: \e ] 11 ; rgb: NUMBER1 / NUMBER2 / NUMBER3 \e \\</span>
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (<span class="org-keyword">setq</span> chr (xterm--read-event-for-query)) (not (equal chr ?\\)))
      (<span class="org-keyword">setq</span> str (concat str (string chr))))
    (<span class="org-keyword">when</span> (string-match
           <span class="org-string">"rgb:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[a-f0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[a-f0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[a-f0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> str)
      (<span class="org-keyword">let</span> ((r (string-to-number (match-string 1 str) 16))
            (g (string-to-number (match-string 2 str) 16))
            (b (string-to-number (match-string 3 str) 16)))
        (<span class="org-keyword">setq</span> term-background-rgb (list r g b))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">+doom-init-theme-termaware</span> ()
  <span class="org-doc">"Update `</span><span class="org-doc"><span class="org-constant">doom-theme</span></span><span class="org-doc">' if in a terminal, unless DOOM_THEME has been set."</span>
  (<span class="org-keyword">let</span> (term-shade)
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not (display-graphic-p (selected-frame)))
               (not (getenv <span class="org-string">"DOOM_THEME"</span>))
               (<span class="org-keyword">require</span> '<span class="org-constant">xterm</span> nil t))
      (message <span class="org-string">"Querying terminal background color"</span>)
      (xterm--query <span class="org-string">"\e]11;?\e\\"</span> '((<span class="org-string">"\e]11;"</span> . +interpret-term-bg)))
      (<span class="org-keyword">when</span> term-background-rgb
        (<span class="org-keyword">setq</span> term-shade (<span class="org-keyword">if</span> (&lt; (apply #'+ term-background-rgb) (* 0.6 3 65535))
                             'dark 'light))
        (<span class="org-keyword">pcase</span> term-shade
          ('dark (<span class="org-keyword">setq</span> doom-theme 'doom-vibrant))
          ('light (<span class="org-keyword">setq</span> doom-theme 'doom-tomorrow-day)))))
    (doom-init-theme-h)))
</pre>
</div>
</details>

<p>
Lastly, I had some issues with theme race conditions, which seem to be resolved
by moving <kbd>doom-init-theme-h</kbd> around. Henrik attempted to help with this in May
2021 but we didn't manage to pin down the issue. It may be worth periodically
checking back and seeing if this is still needed. We might as well inject
<code>+doom-init-theme-termaware</code> while we're at it.
</p>

<details id='theme,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#theme,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(remove-hook 'window-setup-hook #'doom-init-theme-h)
(remove-hook 'after-init-hook   #'doom-init-theme-h)
(add-hook    'after-init-hook   #'+doom-init-theme-termaware 'append)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-line-numbers" class="outline-5">
<h5 id="line-numbers"><span class="section-number-5">2.4.3.3.</span> Line numbers<a aria-hidden="true" href="#line-numbers">#</a> </h5>
<div class="outline-text-5" id="text-2-4-3-3">
<p>
Relative line numbers are fantastic for knowing how far away line numbers are,
then <kbd>ESC 12 &lt;UP&gt;</kbd> gets you exactly where you think.
</p>

<details id='line-numbers,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#line-numbers,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> display-line-numbers-type 'relative)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-some-helper-macros" class="outline-4">
<h4 id="some-helper-macros"><span class="section-number-4">2.4.4.</span> Some helper macros<a aria-hidden="true" href="#some-helper-macros">#</a> </h4>
<div class="outline-text-4" id="text-2-4-4">
<p>
There are a few handy macros added by doom, namely
</p>
<ul class="org-ul">
<li><code>load!</code> for loading external <code>.el</code> files relative to this one</li>
<li><code>use-package!</code> for configuring packages</li>
<li><code>add-load-path!</code> for adding directories to the <code>load-path</code> where <code>Emacs</code> looks when
you load packages with <code>require</code> or <code>use-package</code></li>
<li><code>map!</code> for binding new keys</li>
</ul>
</div>
</div>
<div id="outline-container-allow-babel-execution" class="outline-4">
<h4 id="allow-babel-execution"><span class="section-number-4">2.4.5.</span> Allow babel execution in <span class='acr'><span class='acr'>CLI</span></span> actions<a aria-hidden="true" href="#allow-babel-execution">#</a> </h4>
<div class="outline-text-4" id="text-2-4-5">
<p>
In this config I sometimes generate code to include in my config.
This works nicely, but for it to work with <kbd>doom sync</kbd> et. al. I need to make sure
that Org doesn't try to confirm that I want to allow evaluation (I do!).
</p>

<p>
Thankfully Doom supports <kbd>$DOOMDIR/cli.el</kbd> file which is sourced every time a <span class='acr'>CLI</span>
command is run, so we can just enable evaluation by setting
<code>org-confirm-babel-evaluate</code> to <code>nil</code> there.
While we're at it, we should silence <code>org-babel-execute-src-block</code> to
avoid polluting the output.
</p>

<details id='allow-babel-execution,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#allow-babel-execution,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">cli.el -*- lexical-binding: t; -*-</span>
(<span class="org-keyword">setq</span> org-confirm-babel-evaluate nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">doom-shut-up-a</span> (orig-fn <span class="org-type">&amp;rest</span> args)
  (<span class="org-keyword">quiet!</span> (apply orig-fn args)))

(advice-add 'org-babel-execute-src-block <span class="org-builtin">:around</span> #'doom-shut-up-a)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-elisp-repl" class="outline-4">
<h4 id="elisp-repl"><span class="section-number-4">2.4.6.</span> Elisp <span class='acr'><span class='acr'>REPL</span></span><a aria-hidden="true" href="#elisp-repl">#</a> </h4>
<div class="outline-text-4" id="text-2-4-6">
<p>
I think an elisp <span class='acr'>REPL</span> sounds like a fun idea, even if not a particularly useful
one 😛. We can do this by adding a new command in <kbd>cli.el</kbd>.
</p>

<details id='elisp-repl,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#elisp-repl,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defcli!</span> repl ((in-rlwrap-p (<span class="org-string">"--rl"</span>) <span class="org-string">"For internal use only."</span>))
  <span class="org-doc">"Start an elisp REPL."</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">core-start</span>)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (executable-find <span class="org-string">"rlwrap"</span>) (not in-rlwrap-p))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">For autocomplete</span>
    (<span class="org-keyword">setq</span> autocomplete-file <span class="org-string">"/tmp/doom_elisp_repl_symbols"</span>)
    (<span class="org-keyword">unless</span> (file-exists-p autocomplete-file)
      (princ <span class="org-string">"\e[0;33mInitialising autocomplete list...\e[0m\n"</span>)
      (<span class="org-keyword">with-temp-buffer</span>
        (<span class="org-keyword">cl-do-all-symbols</span> (s)
          (<span class="org-keyword">let</span> ((sym (symbol-name s)))
            (<span class="org-keyword">when</span> (string-match-p <span class="org-string">"\\`[[:ascii:]][[:ascii:]]+\\'"</span> sym)
              (insert sym <span class="org-string">"\n"</span>))))
        (write-region nil nil autocomplete-file)))
    (princ <span class="org-string">"\e[F"</span>)
    (exit! <span class="org-string">"rlwrap"</span> <span class="org-string">"-f"</span> autocomplete-file
           (concat doom-emacs-dir <span class="org-string">"bin/doom"</span>) <span class="org-string">"repl"</span> <span class="org-string">"--rl"</span>))

  (doom-initialize-packages)
  (<span class="org-keyword">require</span> '<span class="org-constant">engrave-faces-ansi</span>)
  (<span class="org-keyword">setq</span> engrave-faces-ansi-color-mode '3-bit)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">For some reason (require 'parent-mode) doesn't work :(</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">parent-mode-list</span> (mode)
    <span class="org-doc">"Return a list of MODE and all its parent modes.</span>

<span class="org-doc">The returned list starts with the parent-most mode and ends with MODE."</span>
    (<span class="org-keyword">let</span> ((result ()))
      (parent-mode--worker mode (<span class="org-keyword">lambda</span> (mode)
                                  (<span class="org-keyword">push</span> mode result)))
      result))
  (<span class="org-keyword">defun</span> <span class="org-function-name">parent-mode--worker</span> (mode func)
    <span class="org-doc">"For MODE and all its parent modes, call FUNC.</span>

<span class="org-doc">FUNC is first called for MODE, then for its parent, then for the parent's</span>
<span class="org-doc">parent, and so on.</span>

<span class="org-doc">MODE shall be a symbol referring to a function.</span>
<span class="org-doc">FUNC shall be a function taking one argument."</span>
    (funcall func mode)
    (<span class="org-keyword">when</span> (not (fboundp mode))
      (<span class="org-warning">signal</span> 'void-function (list mode)))
    (<span class="org-keyword">let</span> ((modefunc (symbol-function mode)))
      (<span class="org-keyword">if</span> (symbolp modefunc)
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Hande all the modes that use (defalias 'foo-parent-mode (stuff)) as</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">their parent</span>
          (parent-mode--worker modefunc func)
        (<span class="org-keyword">let</span> ((parentmode (get mode 'derived-mode-parent)))
          (<span class="org-keyword">when</span> parentmode
            (parent-mode--worker parentmode func))))))
  (<span class="org-keyword">provide</span> '<span class="org-constant">parent-mode</span>)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Some extra highlighting (needs parent-mode)</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">rainbow-delimiters</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">highlight-quoted</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">highlight-numbers</span>)
  (<span class="org-keyword">setq</span> emacs-lisp-mode-hook '(rainbow-delimiters-mode
                               highlight-quoted-mode
                               highlight-numbers-mode))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Pretty print</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">pp-sexp</span> (sexp)
    (<span class="org-keyword">with-temp-buffer</span>
      (cl-prettyprint sexp)
      (emacs-lisp-mode)
      (font-lock-ensure)
      (<span class="org-keyword">with-current-buffer</span> (engrave-faces-ansi-buffer)
        (princ (string-trim (buffer-string)))
        (kill-buffer (current-buffer)))))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Now do the REPL</span>
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">accumulated-input</span> nil)
  (<span class="org-keyword">while</span> t
    (<span class="org-keyword">condition-case</span> nil
        (<span class="org-keyword">let</span> ((input (<span class="org-keyword">if</span> accumulated-input
                         (read-string <span class="org-string">"\e[31m .\e[0m  "</span>)
                       (read-string <span class="org-string">"\e[31m&#955;:\e[0m "</span>))))
          (<span class="org-keyword">setq</span> input (concat accumulated-input
                              (<span class="org-keyword">when</span> accumulated-input <span class="org-string">"\n"</span>)
                              input))
          (<span class="org-keyword">cond</span>
           ((string-match-p <span class="org-string">"\\`[[:space:]]*\\'"</span> input)
            nil)
           ((string= input <span class="org-string">"exit"</span>)
            (princ <span class="org-string">"\n"</span>) (kill-emacs 0))
           (t
            (<span class="org-keyword">condition-case</span> err
                (<span class="org-keyword">let</span> ((input-sexp (car (read-from-string input))))
                  (<span class="org-keyword">setq</span> accumulated-input nil)
                  (pp-sexp (eval input-sexp))
                  (princ <span class="org-string">"\n"</span>))
              <span class="org-comment-delimiter">;; </span><span class="org-comment">Caused when sexp in unbalanced</span>
              (end-of-file (<span class="org-keyword">setq</span> accumulated-input input))
              (<span class="org-warning">error</span>
               (<span class="org-keyword">cl-destructuring-bind</span> (backtrace <span class="org-type">&amp;optional</span> type data . _)
                   (cons (doom-cli--backtrace) err)
                 (princ (concat <span class="org-string">"\e[1;31mERROR:\e[0m "</span> (get type 'error-message)))
                 (princ <span class="org-string">"\n       "</span>)
                 (pp-sexp (cons type data))
                 (<span class="org-keyword">when</span> backtrace
                   (<span class="org-keyword">print!</span> (bold <span class="org-string">"Backtrace:"</span>))
                   (<span class="org-keyword">print-group!</span>
                    (<span class="org-keyword">dolist</span> (frame (seq-take backtrace 10))
                      (<span class="org-keyword">print!</span>
                       <span class="org-string">"%0.74s"</span> (replace-regexp-in-string
                                 <span class="org-string">"[\n\r]"</span> <span class="org-string">"\\\\n"</span>
                                 (format <span class="org-string">"%S"</span> frame))))))
                 (princ <span class="org-string">"\n"</span>)))))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">C-d causes an end-of-file error</span>
      (end-of-file (princ <span class="org-string">"exit\n"</span>) (kill-emacs 0)))
    (<span class="org-keyword">unless</span> accumulated-input (princ <span class="org-string">"\n"</span>))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-htmlize-command" class="outline-4">
<h4 id="htmlize-command"><span class="section-number-4">2.4.7.</span> Htmlize command<a aria-hidden="true" href="#htmlize-command">#</a> </h4>
<div class="outline-text-4" id="text-2-4-7">
<p>
Why not have a command to htmlize files? This is basically a little test of my
engrave-faces package because it somehow seems to work without a <span class='acr'>GUI</span>, while the
htmlize package doesn't.
</p>

<details id='htmlize-command,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#htmlize-command,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defcli!</span> htmlize (file)
  <span class="org-doc">"Export a FILE buffer to HTML."</span>

  (<span class="org-keyword">print!</span> <span class="org-string">"Htmlizing %s"</span> file)

  (doom-initialize)
  (<span class="org-keyword">require</span> '<span class="org-constant">highlight-numbers</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">highlight-quoted</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">rainbow-delimiters</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">engrave-faces-html</span>)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Lighten org-mode</span>
  (<span class="org-keyword">when</span> (string= <span class="org-string">"org"</span> (file-name-extension file))
    (setcdr (assoc 'org after-load-alist) nil)
    (<span class="org-keyword">setq</span> org-load-hook nil)
    (<span class="org-keyword">require</span> '<span class="org-constant">org</span>)
    (<span class="org-keyword">setq</span> org-mode-hook nil)
    (add-hook 'engrave-faces-before-hook
              (<span class="org-keyword">lambda</span> () (<span class="org-keyword">if</span> (eq major-mode 'org-mode)
                        (org-show-all)))))

  (engrave-faces-html-file file))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-org-buffer-creation" class="outline-4">
<h4 id="org-buffer-creation"><span class="section-number-4">2.4.8.</span> Org buffer creation<a aria-hidden="true" href="#org-buffer-creation">#</a> </h4>
<div class="outline-text-4" id="text-2-4-8">
<p>
Let's make creating an Org buffer just that little bit easier.
</p>

<details id='org-buffer-creation,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-buffer-creation,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(evil-define-command +evil-buffer-org-new (_count file)
  <span class="org-string">"Creates a new ORG buffer replacing the current window, optionally</span>
<span class="org-string">   editing a certain FILE"</span>
  <span class="org-builtin">:repeat</span> nil
  (<span class="org-keyword">interactive</span> <span class="org-string">"P&lt;f&gt;"</span>)
  (<span class="org-keyword">if</span> file
      (evil-edit file)
    (<span class="org-keyword">let</span> ((buffer (generate-new-buffer <span class="org-string">"*new org*"</span>)))
      (set-window-buffer nil buffer)
      (<span class="org-keyword">with-current-buffer</span> buffer
        (org-mode)
        (<span class="org-keyword">setq-local</span> doom-real-buffer-p t)))))

(map! <span class="org-builtin">:leader</span>
      (<span class="org-builtin">:prefix</span> <span class="org-string">"b"</span>
       <span class="org-builtin">:desc</span> <span class="org-string">"New empty Org buffer"</span> <span class="org-string">"o"</span> #'+evil-buffer-org-new))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-dashboard" class="outline-4">
<h4 id="dashboard"><span class="section-number-4">2.4.9.</span> Dashboard<a aria-hidden="true" href="#dashboard">#</a> </h4>
<div class="outline-text-4" id="text-2-4-9">
</div>
<div id="outline-container-fancy-splash-screen" class="outline-5">
<h5 id="fancy-splash-screen"><span class="section-number-5">2.4.9.1.</span> A fancy splash screen<a aria-hidden="true" href="#fancy-splash-screen">#</a> </h5>
<div class="outline-text-5" id="text-2-4-9-1">
<p>
Emacs can render an image as the splash screen, but I think we can do better
than just a completely static image. Since, <span class='acr'>SVG</span> images in particular are
supported, we can use them as the basis for a fancier splash screen image setup
&#x2014; with themeable, resizing images.
</p>

<p>
With the effort I'm putting into this, it would be nice to have a good image,
and <a href="https://github.com/MarioRicalde">@MarioRicalde</a> came up with a cracker! He's also provided me with a nice
Emacs-style <i>E</i>. I was using the black-hole image, but when I stripped down the
splash screen to something more minimal I switched to just using the <i>E</i>.
</p>


<figure id="org98b3fcc">
<img src="misc/splash-images/emacs-e-template.svg" alt="Fancy Emacs &quot;E&quot;" class="org-svg" style="width:20%">

</figure>

<details id='fancy-splash-screen,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">fancy-splash-image-directory</span>
  (expand-file-name <span class="org-string">"misc/splash-images/"</span> doom-user-dir)
  <span class="org-doc">"Directory in which to look for splash image templates."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">fancy-splash-image-template</span>
  (expand-file-name <span class="org-string">"emacs-e-template.svg"</span> fancy-splash-image-directory)
  <span class="org-doc">"Default template svg used for the splash image.</span>
<span class="org-doc">Colours are substituted as per `</span><span class="org-doc"><span class="org-constant">fancy-splash-template-colours</span></span><span class="org-doc">'."</span>)
</pre>
</div>
</details>

<p>
Special named colours can be used as the basis for theming, with a simple
replacement system.
</p>

<details id='fancy-splash-screen,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">fancy-splash-template-colours</span>
  '((<span class="org-string">"#111112"</span> <span class="org-builtin">:face</span> default   <span class="org-builtin">:attr</span> <span class="org-builtin">:foreground</span>)
    (<span class="org-string">"#8b8c8d"</span> <span class="org-builtin">:face</span> shadow)
    (<span class="org-string">"#eeeeef"</span> <span class="org-builtin">:face</span> default   <span class="org-builtin">:attr</span> <span class="org-builtin">:background</span>)
    (<span class="org-string">"#e66100"</span> <span class="org-builtin">:face</span> highlight <span class="org-builtin">:attr</span> <span class="org-builtin">:background</span>)
    (<span class="org-string">"#1c71d8"</span> <span class="org-builtin">:face</span> font-lock-keyword-face)
    (<span class="org-string">"#f5c211"</span> <span class="org-builtin">:face</span> font-lock-type-face)
    (<span class="org-string">"#813d9c"</span> <span class="org-builtin">:face</span> font-lock-constant-face)
    (<span class="org-string">"#865e3c"</span> <span class="org-builtin">:face</span> font-lock-function-name-face)
    (<span class="org-string">"#2ec27e"</span> <span class="org-builtin">:face</span> font-lock-string-face)
    (<span class="org-string">"#c01c28"</span> <span class="org-builtin">:face</span> error)
    (<span class="org-string">"#000001"</span> <span class="org-builtin">:face</span> ansi-color-black)
    (<span class="org-string">"#ff0000"</span> <span class="org-builtin">:face</span> ansi-color-red)
    (<span class="org-string">"#ff00ff"</span> <span class="org-builtin">:face</span> ansi-color-magenta)
    (<span class="org-string">"#00ff00"</span> <span class="org-builtin">:face</span> ansi-color-green)
    (<span class="org-string">"#ffff00"</span> <span class="org-builtin">:face</span> ansi-color-yellow)
    (<span class="org-string">"#0000ff"</span> <span class="org-builtin">:face</span> ansi-color-blue)
    (<span class="org-string">"#00ffff"</span> <span class="org-builtin">:face</span> ansi-color-cyan)
    (<span class="org-string">"#fffffe"</span> <span class="org-builtin">:face</span> ansi-color-white))
  <span class="org-doc">"Alist of colour-replacement plists.</span>
<span class="org-doc">Each plist is of the form (\"$placeholder\" :doom-color 'key :face 'face).</span>
<span class="org-doc">If the current theme is a doom theme :doom-color will be used,</span>
<span class="org-doc">otherwise the colour will be face foreground."</span>)
</pre>
</div>
</details>

<p>
If we want to make sure an image is themed, we can look for unrecognised hex
strings that are not greyscale (as greyscale can be expected in the form of a
transparent overlay).
</p>

<details id='fancy-splash-screen,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-check-buffer</span> ()
  <span class="org-doc">"Check the current SVG buffer for bad colours."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (eq major-mode 'image-mode)
    (xml-mode))
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (<span class="org-keyword">featurep</span> '<span class="org-constant">rainbow-mode</span>)
             (not (<span class="org-keyword">bound-and-true-p</span> rainbow-mode)))
    (rainbow-mode 1))
  (<span class="org-keyword">let*</span> ((colours (mapcar #'car fancy-splash-template-colours))
         (colourise-hex
          (<span class="org-keyword">lambda</span> (hex)
            (propertize
             hex
             'face `((<span class="org-builtin">:foreground</span>
                      ,(<span class="org-keyword">if</span> (&lt; 0.5
                              (<span class="org-keyword">cl-destructuring-bind</span> (r g b) (x-color-values hex)
                                <span class="org-comment-delimiter">;; </span><span class="org-comment">Values taken from `</span><span class="org-comment"><span class="org-constant">rainbow-color-luminance</span></span><span class="org-comment">'</span>
                                (/ (+ (* .2126 r) (* .7152 g) (* .0722 b))
                                   (* 256 255 1.0))))
                           <span class="org-string">"white"</span> <span class="org-string">"black"</span>)
                      (<span class="org-builtin">:background</span> ,hex))))))
         (cn 96)
         (colour-menu-entries
          (mapcar
           (<span class="org-keyword">lambda</span> (colour)
             (<span class="org-keyword">cl-incf</span> cn)
             (cons cn
                   (cons
                    (substring-no-properties colour)
                    (format <span class="org-string">" (%s) %s %s"</span>
                            (propertize (char-to-string cn)
                                        'face 'font-lock-keyword-face)
                            (funcall colourise-hex colour)
                            (propertize
                             (symbol-name
                              (plist-get
                               (cdr (assoc colour fancy-splash-template-colours))
                               <span class="org-builtin">:face</span>))
                             'face 'shadow)))))
           colours))
         (colour-menu-template
          (format
           <span class="org-string">"Colour %%s is unexpected! Should this be one of the following?\n</span>
<span class="org-string">%s</span>
<span class="org-string"> %s to ignore</span>
<span class="org-string"> %s to quit"</span>
           (mapconcat
            #'cddr
            colour-menu-entries
            <span class="org-string">"\n"</span>)
           (propertize <span class="org-string">"SPC"</span> 'face 'font-lock-keyword-face)
           (propertize <span class="org-string">"ESC"</span> 'face 'font-lock-keyword-face)))
         (colour-menu-choice-keys
          (append (mapcar #'car colour-menu-entries)
                  (list ?\s)))
         (buf (get-buffer-create <span class="org-string">"*fancy-splash-lint-colours-popup*"</span>))
         (good-colour-p
          (<span class="org-keyword">lambda</span> (colour)
            (<span class="org-keyword">or</span> (assoc colour fancy-splash-template-colours)
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Check if greyscale</span>
                (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> (= (length colour) 4)
                         (= (aref colour 1)   <span class="org-comment-delimiter">; </span><span class="org-comment">r</span>
                            (aref colour 2)   <span class="org-comment-delimiter">; </span><span class="org-comment">g</span>
                            (aref colour 3))) <span class="org-comment-delimiter">; </span><span class="org-comment">b</span>
                    (<span class="org-keyword">and</span> (= (length colour) 7)
                         (string= (substring colour 1 3)       <span class="org-comment-delimiter">; </span><span class="org-comment">rr =</span>
                                  (substring colour 3 5))      <span class="org-comment-delimiter">; </span><span class="org-comment">gg</span>
                         (string= (substring colour 3 5)       <span class="org-comment-delimiter">; </span><span class="org-comment">gg =</span>
                                  (substring colour 5 7))))))) <span class="org-comment-delimiter">; </span><span class="org-comment">bb</span>
         (prompt-to-replace
          (<span class="org-keyword">lambda</span> (target)
            (<span class="org-keyword">with-current-buffer</span> buf
              (erase-buffer)
              (insert (format colour-menu-template
                              (funcall colourise-hex target)))
              (<span class="org-keyword">setq-local</span> cursor-type nil)
              (set-buffer-modified-p nil)
              (goto-char (point-min)))
            (<span class="org-keyword">save-window-excursion</span>
              (pop-to-buffer buf)
              (fit-window-to-buffer (get-buffer-window buf))
              (car (alist-get
                    (read-char-choice
                     (format <span class="org-string">"Select replacement, %s-%s or SPC: "</span>
                             (char-to-string (caar colour-menu-entries))
                             (char-to-string (caar (last colour-menu-entries))))
                     colour-menu-choice-keys)
                    colour-menu-entries))))))
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"#[0-9A-Fa-f]\\{</span><span class="org-string"><span class="org-variable-name">6\\</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">#[0-9A-Fa-f]\\{</span><span class="org-string"><span class="org-variable-name">3\\</span></span><span class="org-string">}"</span> nil t)
        (recenter)
        (<span class="org-keyword">let*</span> ((colour (match-string 0))
               (replacement (<span class="org-keyword">and</span> (not (funcall good-colour-p colour))
                                 (funcall prompt-to-replace colour))))
          (<span class="org-keyword">when</span> replacement
            (replace-match replacement t t))))
      (message <span class="org-string">"Done"</span>))))
</pre>
</div>
</details>

<p>
To make it easier to produce themeable images, we can also provide an Inkscape
colour palette.
</p>

<details id='fancy-splash-screen,code--4' class='code' open><summary><span class="lang">text</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-text">GIMP Palette
Name: Emacs Fancy Splash Template
#
 17  17  18 #111112 Foreground
139 140 141 #8b8c8d Shadow
238 238 239 #eeeeef Background
230  97   0 #e66100 Colour 1 (Highlight)
 28 113 216 #1c71d8 Colour 2 (Keyword)
245 194  17 #f5c211 Colour 3 (Type)
129  61 156 #813d9c Colour 4 (Constant)
134  94  60 #865e3c Colour 5 (Function)
 46 194 126 #2ec27e Colour 6 (String)
192  28  40 #c01c28 Colour 7 (Error)
  0   0   1 #000001 Black
255   0   0 #ff0000 Red
255   0 255 #ff00ff Magenta
  0 255   0 #00ff00 Green
255 255   0 #ffff00 Yellow
  0   0 255 #0000ff Blue
  0 255 255 #00ffff Cyan
255 255 254 #fffffe White
</pre>
</div>
</details>

<p>
Since we're going to be generating theme-specific versions of splash images, it
would be good to have a cache directory.
</p>

<details id='fancy-splash-screen,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">fancy-splash-cache-dir</span> (expand-file-name <span class="org-string">"theme-splashes/"</span> doom-cache-dir))
</pre>
</div>
</details>

<p>
To set up dynamic resizing, we'll use a list specifying the image height at
various frame-height thresholds, with a few extra bells and whistles (such as
the ability to change image too).
</p>

<details id='fancy-splash-screen,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">fancy-splash-sizes</span>
  `((<span class="org-builtin">:height</span> 300 <span class="org-builtin">:min-height</span> 50 <span class="org-builtin">:padding</span> (0 . 2))
    (<span class="org-builtin">:height</span> 250 <span class="org-builtin">:min-height</span> 42 <span class="org-builtin">:padding</span> (2 . 4))
    (<span class="org-builtin">:height</span> 200 <span class="org-builtin">:min-height</span> 35 <span class="org-builtin">:padding</span> (3 . 3))
    (<span class="org-builtin">:height</span> 150 <span class="org-builtin">:min-height</span> 28 <span class="org-builtin">:padding</span> (3 . 3))
    (<span class="org-builtin">:height</span> 100 <span class="org-builtin">:min-height</span> 20 <span class="org-builtin">:padding</span> (2 . 2))
    (<span class="org-builtin">:height</span> 75  <span class="org-builtin">:min-height</span> 15 <span class="org-builtin">:padding</span> (2 . 1))
    (<span class="org-builtin">:height</span> 50  <span class="org-builtin">:min-height</span> 10 <span class="org-builtin">:padding</span> (1 . 0))
    (<span class="org-builtin">:height</span> 1   <span class="org-builtin">:min-height</span> 0  <span class="org-builtin">:padding</span> (0 . 0)))
  <span class="org-doc">"List of plists specifying image sizing states.</span>
<span class="org-doc">Each plist should have the following properties:</span>
<span class="org-doc">- :height, the height of the image</span>
<span class="org-doc">- :min-height, the minimum `</span><span class="org-doc"><span class="org-constant">frame-height</span></span><span class="org-doc">' for image</span>
<span class="org-doc">- :padding, a `</span><span class="org-doc"><span class="org-constant">+doom-dashboard-banner-padding</span></span><span class="org-doc">' (top . bottom) padding</span>
<span class="org-doc">  specification to apply</span>
<span class="org-doc">Optionally, each plist may set the following two properties:</span>
<span class="org-doc">- :template, a non-default template file</span>
<span class="org-doc">- :file, a file to use instead of template"</span>)
</pre>
</div>
</details>

<p>
Now that's we've set up the customisation approach, we need to work out the
mechanics for actually implementing this. To start with, a basic utility
function to get the relevant file path.
</p>

<details id='fancy-splash-screen,code--7' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-filename</span> (theme template height)
  <span class="org-doc">"Get the file name for the splash image with THEME and of HEIGHT."</span>
  (expand-file-name (format <span class="org-string">"%s-%s-%d.svg"</span> theme (file-name-base template) height) fancy-splash-cache-dir))
</pre>
</div>
</details>

<p>
Now to go about actually generating the images. To adjust the sizing on demand,
we will offer two mechanisms:
</p>
<ol class="org-ol">
<li>A special <kbd>$height</kbd> token which is replaced with the desired height</li>
<li>Recognition of <kbd>height=100</kbd>, in which case <kbd>100</kbd> will be replaced with the
desired height and any <kbd>width</kbd> property will be removed.</li>
</ol>

<details id='fancy-splash-screen,code--8' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--8'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-generate-image</span> (template height)
  <span class="org-doc">"Create a themed image from TEMPLATE of HEIGHT.</span>
<span class="org-doc">The theming is performed using `</span><span class="org-doc"><span class="org-constant">fancy-splash-template-colours</span></span><span class="org-doc">'</span>
<span class="org-doc">and the current theme."</span>
  (<span class="org-keyword">with-temp-buffer</span>
    (insert-file-contents template)
    (goto-char (point-min))
    (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"$height"</span> nil t)
        (replace-match (number-to-string height) t t)
      (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"height=\"100</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">\\.0[0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?\""</span> nil t)
          (<span class="org-keyword">progn</span>
            (replace-match (format <span class="org-string">"height=\"%s\""</span> height) t t)
            (goto-char (point-min))
            (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[ \t\n]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">width=\"[\\.0-9]+\"[ \t\n]*"</span> nil t)
              (replace-match <span class="org-string">"\\1"</span>)))
        (<span class="org-warning">warn</span> <span class="org-string">"Warning! fancy splash template: neither $height nor height=100 not found in %s"</span> template)))
    (<span class="org-keyword">dolist</span> (substitution fancy-splash-template-colours)
      (goto-char (point-min))
      (<span class="org-keyword">let*</span> ((replacement-colour
              (face-attribute (plist-get (cdr substitution) <span class="org-builtin">:face</span>)
                              (<span class="org-keyword">or</span> (plist-get (cdr substitution) <span class="org-builtin">:attr</span>) <span class="org-builtin">:foreground</span>)
                              nil 'default))
             (replacement-hex
              (<span class="org-keyword">if</span> (string-prefix-p <span class="org-string">"#"</span> replacement-colour)
                  replacement-colour
                (apply 'format <span class="org-string">"#%02x%02x%02x"</span>
                       (mapcar (<span class="org-keyword">lambda</span> (c) (ash c -8))
                               (color-values replacement-colour))))))
        (<span class="org-keyword">while</span> (search-forward (car substitution) nil t)
          (replace-match replacement-hex nil nil))))
    (<span class="org-keyword">unless</span> (file-exists-p fancy-splash-cache-dir)
      (make-directory fancy-splash-cache-dir t))
    (<span class="org-keyword">let</span> ((inhibit-message t))
      (write-region nil nil (fancy-splash-filename (car custom-enabled-themes) template height)))))
</pre>
</div>
</details>

<p>
We may as well generate each theme's appropriate images in bunk.
</p>

<details id='fancy-splash-screen,code--9' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--9'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-generate-all-images</span> ()
  <span class="org-doc">"Perform `</span><span class="org-doc"><span class="org-constant">fancy-splash-generate-image</span></span><span class="org-doc">' in bulk."</span>
  (<span class="org-keyword">dolist</span> (size fancy-splash-sizes)
    (<span class="org-keyword">unless</span> (plist-get size <span class="org-builtin">:file</span>)
      (fancy-splash-generate-image
       (<span class="org-keyword">or</span> (plist-get size <span class="org-builtin">:template</span>)
           fancy-splash-image-template)
       (plist-get size <span class="org-builtin">:height</span>)))))
</pre>
</div>
</details>

<p>
It would be nice to have a simple check function which will just generate the
set of relevant images if needed, and do nothing if they already exist.
</p>

<details id='fancy-splash-screen,code--10' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--10'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-ensure-theme-images-exist</span> (<span class="org-type">&amp;optional</span> height)
  <span class="org-doc">"Ensure that the relevant images exist.</span>
<span class="org-doc">Use the image of HEIGHT to check, defaulting to the height of the first</span>
<span class="org-doc">specification in `</span><span class="org-doc"><span class="org-constant">fancy-splash-sizes</span></span><span class="org-doc">'. If that file does not exist for</span>
<span class="org-doc">the current theme, `</span><span class="org-doc"><span class="org-constant">fancy-splash-generate-all-images</span></span><span class="org-doc">' is called. "</span>
  (<span class="org-keyword">unless</span> (file-exists-p
           (fancy-splash-filename
            (car custom-enabled-themes)
            fancy-splash-image-template
            (<span class="org-keyword">or</span> height (plist-get (car fancy-splash-sizes) <span class="org-builtin">:height</span>))))
    (fancy-splash-generate-all-images)))
</pre>
</div>
</details>

<p>
In case we switch out the images used (or something else goes wrong), it would
be good to have a convenient method to clear this cache.
</p>

<details id='fancy-splash-screen,code--11' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--11'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-clear-cache</span> (<span class="org-type">&amp;optional</span> delete-files)
  <span class="org-doc">"Clear all cached fancy splash images.</span>
<span class="org-doc">Optionally delete all cache files and regenerate the currently relevant set."</span>
  (<span class="org-keyword">interactive</span> (list t))
  (<span class="org-keyword">dolist</span> (size fancy-splash-sizes)
    (<span class="org-keyword">unless</span> (plist-get size <span class="org-builtin">:file</span>)
      (<span class="org-keyword">let</span> ((image-file
             (fancy-splash-filename
              (car custom-enabled-themes)
              (<span class="org-keyword">or</span> (plist-get size <span class="org-builtin">:template</span>)
                  fancy-splash-image-template)
              (plist-get size <span class="org-builtin">:height</span>))))
        (image-flush (create-image image-file) t))))
  (message <span class="org-string">"Fancy splash image cache cleared!"</span>)
  (<span class="org-keyword">when</span> delete-files
    (delete-directory fancy-splash-cache-dir t)
    (fancy-splash-generate-all-images)
    (message <span class="org-string">"Fancy splash images cache deleted!"</span>)))
</pre>
</div>
</details>

<p>
In a similar way, it could be fun to allow for switching the template used. We
can support this by looking for files ending in <kbd>-template.svg</kbd> and running
<code>image-flush</code> via <code>fancy-splash-clear-cache</code>.
</p>

<details id='fancy-splash-screen,code--12' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--12'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-switch-template</span> ()
  <span class="org-doc">"Switch the template used for the fancy splash image."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((new (completing-read
              <span class="org-string">"Splash template: "</span>
              (mapcar
               (<span class="org-keyword">lambda</span> (template)
                 (replace-regexp-in-string <span class="org-string">"-template\\.svg$"</span> <span class="org-string">""</span> template))
               (directory-files fancy-splash-image-directory nil <span class="org-string">"-template\\.svg\\'"</span>))
              nil t)))
    (<span class="org-keyword">setq</span> fancy-splash-image-template
          (expand-file-name (concat new <span class="org-string">"-template.svg"</span>) fancy-splash-image-directory))
    (fancy-splash-clear-cache)
    (message <span class="org-string">""</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">Clear message from `</span><span class="org-comment"><span class="org-constant">fancy-splash-clear-cache</span></span><span class="org-comment">'.</span>
    (<span class="org-keyword">setq</span> fancy-splash--last-size nil)
    (fancy-splash-apply-appropriate-image)))
</pre>
</div>
</details>

<p>
Now we can ensure that the desired images exist, we need to work out which
particular one we want. This is really just a matter of comparing the frame
height to the set of presets.
</p>

<details id='fancy-splash-screen,code--13' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--13'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-get-appropriate-size</span> ()
  <span class="org-doc">"Find the firt `</span><span class="org-doc"><span class="org-constant">fancy-splash-sizes</span></span><span class="org-doc">' with min-height of at least frame height."</span>
  (<span class="org-keyword">let</span> ((height (frame-height)))
    (cl-some (<span class="org-keyword">lambda</span> (size) (<span class="org-keyword">when</span> (&gt;= height (plist-get size <span class="org-builtin">:min-height</span>)) size))
             fancy-splash-sizes)))
</pre>
</div>
</details>

<p>
We now want to apply the appropriate image to the dashboard. At the same time,
we don't want to do so needlessly, so we may as well record the size and theme
to determine when a refresh is actually needed.
</p>

<details id='fancy-splash-screen,code--14' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fancy-splash-screen,code--14'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> fancy-splash--last-size nil)
(<span class="org-keyword">setq</span> fancy-splash--last-theme nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">fancy-splash-apply-appropriate-image</span> (<span class="org-type">&amp;rest</span> _)
  <span class="org-doc">"Ensure the appropriate splash image is applied to the dashboard.</span>
<span class="org-doc">This function's signature is \"&amp;rest _\" to allow it to be used</span>
<span class="org-doc">in hooks that call functions with arguments."</span>
  (<span class="org-keyword">let</span> ((appropriate-size (fancy-splash-get-appropriate-size)))
    (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> (equal appropriate-size fancy-splash--last-size)
                 (equal (car custom-enabled-themes) fancy-splash--last-theme))
      (<span class="org-keyword">unless</span> (plist-get appropriate-size <span class="org-builtin">:file</span>)
        (fancy-splash-ensure-theme-images-exist (plist-get appropriate-size <span class="org-builtin">:height</span>)))
      (<span class="org-keyword">setq</span> fancy-splash-image
            (<span class="org-keyword">or</span> (plist-get appropriate-size <span class="org-builtin">:file</span>)
                (fancy-splash-filename (car custom-enabled-themes)
                                       fancy-splash-image-template
                                       (plist-get appropriate-size <span class="org-builtin">:height</span>)))
            +doom-dashboard-banner-padding (plist-get appropriate-size <span class="org-builtin">:padding</span>)
            fancy-splash--last-size appropriate-size
            fancy-splash--last-theme (car custom-enabled-themes))
      (+doom-dashboard-reload))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-ascii-banner" class="outline-5">
<h5 id="ascii-banner"><span class="section-number-5">2.4.9.2.</span> <span class='acr'><span class='acr'>ASCII</span></span> banner<a aria-hidden="true" href="#ascii-banner">#</a> </h5>
<div class="outline-text-5" id="text-2-4-9-2">
<p>
If we're operating in a terminal (or <kbd>emacclient</kbd>) we see an <span class='acr'>ASCII</span> banner instead
of the graphical one. I'd also like to use something simple for this.
</p>

<details id='ascii-banner,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ascii-banner,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">doom-dashboard-draw-ascii-emacs-banner-fn</span> ()
  (<span class="org-keyword">let*</span> ((banner
          '(<span class="org-string">",---.,-.-.,---.,---.,---."</span>
            <span class="org-string">"|---'| | |,---||    `---."</span>
            <span class="org-string">"`</span><span class="org-string"><span class="org-constant">---</span></span><span class="org-string">'` ' '`---^`</span><span class="org-string"><span class="org-constant">---</span></span><span class="org-string">'`</span><span class="org-string"><span class="org-constant">---</span></span><span class="org-string">'"</span>))
         (longest-line (apply #'max (mapcar #'length banner))))
    (put-text-property
     (point)
     (<span class="org-keyword">dolist</span> (line banner (point))
       (insert (+doom-dashboard--center
                +doom-dashboard--width
                (concat
                 line (make-string (max 0 (- longest-line (length line)))
                                   32)))
               <span class="org-string">"\n"</span>))
     'face 'doom-dashboard-banner)))
</pre>
</div>
</details>

<p>
Now we just need this as Doom's <span class='acr'>ASCII</span> banner function.
</p>

<details id='ascii-banner,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ascii-banner,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (display-graphic-p) <span class="org-comment-delimiter">; </span><span class="org-comment">for some reason this messes up the graphical splash screen atm</span>
  (<span class="org-keyword">setq</span> +doom-dashboard-ascii-banner-fn #'doom-dashboard-draw-ascii-emacs-banner-fn))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-splash-phrases" class="outline-5">
<h5 id="splash-phrases"><span class="section-number-5">2.4.9.3.</span> Splash phrases<a aria-hidden="true" href="#splash-phrases">#</a> </h5>
<div class="outline-text-5" id="text-2-4-9-3">
<p>
Having an aesthetically pleasing image is all very well and good, but I'm aiming
for minimal, not clinical &#x2014; it would be good to inject some fun into the
dashboard. After trawling around the internet for a bit, I've found three
sources of fun phrases, namely:
</p>
<ul class="org-ul">
<li>a nonsense corporate jargon generator,</li>
<li>a selection of random developer excuses, and</li>
<li>a collection of fun but rather useless facts.</li>
</ul>

<p>
I used to have a fancy method that used web <span class='acr'>API</span><small>s</small> for these and inserted an
invisible placeholder into the dashboard which was asynchronously replaced on
the result of (debounced) requests to the <span class='acr'>API</span><small>s</small>. While that actually worked quite
well, I realised that it would be much better and simpler if I simply copied the
phrases sources to local files and did the random selection / generation in
elisp.
</p>

<p>
Let's start off by setting the local folder to put the phrase source files in.
</p>

<details id='splash-phrases,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">splash-phrase-source-folder</span>
  (expand-file-name <span class="org-string">"misc/splash-phrases"</span> doom-user-dir)
  <span class="org-doc">"A folder of text files with a fun phrase on each line."</span>)
</pre>
</div>
</details>

<p>
Now we want to support two "phrase systems"
</p>
<ol class="org-ol">
<li>A complete file of phrases, one phrase per line</li>
<li>A collection of phrase-components, put together to form a phrase</li>
</ol>

<p>
It would be good to specify/detect which of the two cases apply based on the
file name alone. I've done this by setting the simple check that if the file
name contains <kbd>-N-</kbd> (where <kbd>N</kbd> is some number) then it is taken as the <kbd>N</kbd>th phrase
component, with everything preceding the <kbd>-N-</kbd> token taken as the collection
identifier, and everything after <kbd>-N-</kbd> ignored.
</p>

<details id='splash-phrases,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">splash-phrase-sources</span>
  (<span class="org-keyword">let*</span> ((files (directory-files splash-phrase-source-folder nil <span class="org-string">"\\.txt\\'"</span>))
         (sets (delete-dups (mapcar
                             (<span class="org-keyword">lambda</span> (file)
                               (replace-regexp-in-string <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">-[0-9]+-\\w+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?\\.txt"</span> <span class="org-string">""</span> file))
                             files))))
    (mapcar (<span class="org-keyword">lambda</span> (sset)
              (cons sset
                    (delq nil (mapcar
                               (<span class="org-keyword">lambda</span> (file)
                                 (<span class="org-keyword">when</span> (string-match-p (regexp-quote sset) file)
                                   file))
                               files))))
            sets))
  <span class="org-doc">"A list of cons giving the phrase set name, and a list of files which contain phrase components."</span>)
</pre>
</div>
</details>

<p>
Let's fix the phrase set in use, and pick a random phrase source on startup.
</p>

<details id='splash-phrases,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">splash-phrase-set</span>
  (nth (random (length splash-phrase-sources)) (mapcar #'car splash-phrase-sources))
  <span class="org-doc">"The default phrase set. See `</span><span class="org-doc"><span class="org-constant">splash-phrase-sources</span></span><span class="org-doc">'."</span>)
</pre>
</div>
</details>

<p>
While having a random set of phrases is fantastic the vast majority of the time,
I expect that occasionally I'll feel in the mood to change the phrase set or
pick a particular one, so some functions for that would be nice.
</p>

<details id='splash-phrases,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">splash-phrase-set-random-set</span> ()
  <span class="org-doc">"Set a new random splash phrase set."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> splash-phrase-set
        (nth (random (1- (length splash-phrase-sources)))
             (cl-set-difference (mapcar #'car splash-phrase-sources) (list splash-phrase-set))))
  (+doom-dashboard-reload t))

(<span class="org-keyword">defun</span> <span class="org-function-name">splash-phrase-select-set</span> ()
  <span class="org-doc">"Select a specific splash phrase set."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> splash-phrase-set (completing-read <span class="org-string">"Phrase set: "</span> (mapcar #'car splash-phrase-sources)))
  (+doom-dashboard-reload t))
</pre>
</div>
</details>

<p>
If we're going to be selecting phrases from a large list of lines, it could be
worth caching the list of lines.
</p>

<details id='splash-phrases,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">splash-phrase--cached-lines</span> nil)
</pre>
</div>
</details>

<p>
Now let's write a function that will pick a random line from a file, using
<code>splash-phrase--cached-lines</code> if possible.
</p>

<details id='splash-phrases,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">splash-phrase-get-from-file</span> (file)
  <span class="org-doc">"Fetch a random line from FILE."</span>
  (<span class="org-keyword">let</span> ((lines (<span class="org-keyword">or</span> (cdr (assoc file splash-phrase--cached-lines))
                   (cdar (<span class="org-keyword">push</span> (cons file
                                     (<span class="org-keyword">with-temp-buffer</span>
                                       (insert-file-contents (expand-file-name file splash-phrase-source-folder))
                                       (split-string (string-trim (buffer-string)) <span class="org-string">"\n"</span>)))
                               splash-phrase--cached-lines)))))
    (nth (random (length lines)) lines)))
</pre>
</div>
</details>

<p>
With this, we now have enough to generate random phrases on demand.
</p>

<details id='splash-phrases,code--7' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">splash-phrase</span> (<span class="org-type">&amp;optional</span> set)
  <span class="org-doc">"Construct a splash phrase from SET. See `</span><span class="org-doc"><span class="org-constant">splash-phrase-sources</span></span><span class="org-doc">'."</span>
  (mapconcat
   #'splash-phrase-get-from-file
   (cdr (assoc (<span class="org-keyword">or</span> set splash-phrase-set) splash-phrase-sources))
   <span class="org-string">" "</span>))
</pre>
</div>
</details>

<p>
I originally thought this might be enough, but some phrases are a tad long, and
this isn't exactly doom-dashboard appropriate. In such cases we need to split
lines, re-centre them, and add some whitespace. While we're at it, we may as
well make it that you can click on the phrase to replace it with new one.
</p>

<details id='splash-phrases,code--8' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--8'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">splash-phrase-dashboard-formatted</span> ()
  <span class="org-doc">"Get a splash phrase, flow it over multiple lines as needed, and fontify it."</span>
  (mapconcat
   (<span class="org-keyword">lambda</span> (line)
     (+doom-dashboard--center
      +doom-dashboard--width
      (<span class="org-keyword">with-temp-buffer</span>
        (insert-text-button
         line
         'action
         (<span class="org-keyword">lambda</span> (_) (+doom-dashboard-reload t))
         'face 'doom-dashboard-menu-title
         'mouse-face 'doom-dashboard-menu-title
         'help-echo <span class="org-string">"Random phrase"</span>
         'follow-link t)
        (buffer-string))))
   (split-string
    (<span class="org-keyword">with-temp-buffer</span>
      (insert (splash-phrase))
      (<span class="org-keyword">setq</span> fill-column (min 70 (/ (* 2 (window-width)) 3)))
      (fill-region (point-min) (point-max))
      (buffer-string))
    <span class="org-string">"\n"</span>)
   <span class="org-string">"\n"</span>))
</pre>
</div>
</details>

<p>
Almost there now, this just needs some centreing and newlines.
</p>

<details id='splash-phrases,code--9' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#splash-phrases,code--9'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">splash-phrase-dashboard-insert</span> ()
  <span class="org-doc">"Insert the splash phrase surrounded by newlines."</span>
  (insert <span class="org-string">"\n"</span> (splash-phrase-dashboard-formatted) <span class="org-string">"\n"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-quick-actions" class="outline-5">
<h5 id="quick-actions"><span class="section-number-5">2.4.9.4.</span> Quick actions<a aria-hidden="true" href="#quick-actions">#</a> </h5>
<div class="outline-text-5" id="text-2-4-9-4">
<p>
When using the dashboard, there are often a small number of actions I will take.
As the dashboard is it's own major mode, there is no need to suffer the tyranny
of unnecessary keystrokes &#x2014; we can simply bind common actions to a single key!
</p>

<details id='quick-actions,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#quick-actions,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+doom-dashboard-setup-modified-keymap</span> ()
  (<span class="org-keyword">setq</span> +doom-dashboard-mode-map (make-sparse-keymap))
  (map! <span class="org-builtin">:map</span> +doom-dashboard-mode-map
        <span class="org-builtin">:desc</span> <span class="org-string">"Find file"</span> <span class="org-builtin">:ng</span> <span class="org-string">"f"</span> #'find-file
        <span class="org-builtin">:desc</span> <span class="org-string">"Recent files"</span> <span class="org-builtin">:ng</span> <span class="org-string">"r"</span> #'consult-recent-file
        <span class="org-builtin">:desc</span> <span class="org-string">"Config dir"</span> <span class="org-builtin">:ng</span> <span class="org-string">"C"</span> #'doom/open-private-config
        <span class="org-builtin">:desc</span> <span class="org-string">"Open config.org"</span> <span class="org-builtin">:ng</span> <span class="org-string">"c"</span> (<span class="org-keyword">cmd!</span> (find-file (expand-file-name <span class="org-string">"config.org"</span> doom-user-dir)))
        <span class="org-builtin">:desc</span> <span class="org-string">"Open org-mode root"</span> <span class="org-builtin">:ng</span> <span class="org-string">"O"</span> (<span class="org-keyword">cmd!</span> (find-file (expand-file-name <span class="org-string">"lisp/org/"</span> doom-user-dir)))
        <span class="org-builtin">:desc</span> <span class="org-string">"Open dotfile"</span> <span class="org-builtin">:ng</span> <span class="org-string">"."</span> (<span class="org-keyword">cmd!</span> (doom-project-find-file <span class="org-string">"~/.config/"</span>))
        <span class="org-builtin">:desc</span> <span class="org-string">"Notes (roam)"</span> <span class="org-builtin">:ng</span> <span class="org-string">"n"</span> #'org-roam-node-find
        <span class="org-builtin">:desc</span> <span class="org-string">"Switch buffer"</span> <span class="org-builtin">:ng</span> <span class="org-string">"b"</span> #'+vertico/switch-workspace-buffer
        <span class="org-builtin">:desc</span> <span class="org-string">"Switch buffers (all)"</span> <span class="org-builtin">:ng</span> <span class="org-string">"B"</span> #'consult-buffer
        <span class="org-builtin">:desc</span> <span class="org-string">"IBuffer"</span> <span class="org-builtin">:ng</span> <span class="org-string">"i"</span> #'ibuffer
        <span class="org-builtin">:desc</span> <span class="org-string">"Previous buffer"</span> <span class="org-builtin">:ng</span> <span class="org-string">"p"</span> #'previous-buffer
        <span class="org-builtin">:desc</span> <span class="org-string">"Set theme"</span> <span class="org-builtin">:ng</span> <span class="org-string">"t"</span> #'consult-theme
        <span class="org-builtin">:desc</span> <span class="org-string">"Quit"</span> <span class="org-builtin">:ng</span> <span class="org-string">"Q"</span> #'save-buffers-kill-terminal
        <span class="org-builtin">:desc</span> <span class="org-string">"Show keybindings"</span> <span class="org-builtin">:ng</span> <span class="org-string">"h"</span> (<span class="org-keyword">cmd!</span> (which-key-show-keymap '+doom-dashboard-mode-map))))

(<span class="org-keyword">add-transient-hook!</span> #'+doom-dashboard-mode (+doom-dashboard-setup-modified-keymap))
(<span class="org-keyword">add-transient-hook!</span> #'+doom-dashboard-mode <span class="org-builtin">:append</span> (+doom-dashboard-setup-modified-keymap))
(<span class="org-keyword">add-hook!</span> 'doom-init-ui-hook <span class="org-builtin">:append</span> (+doom-dashboard-setup-modified-keymap))
</pre>
</div>
</details>

<p>
Unfortunately the show keybindings help doesn't currently work as intended, but
this is still quite nice overall.
</p>

<p>
Now that the dashboard is so convenient, I'll want to make it easier to get to.
</p>
<details id='quick-actions,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#quick-actions,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:leader</span> <span class="org-builtin">:desc</span> <span class="org-string">"Dashboard"</span> <span class="org-string">"d"</span> #'+doom-dashboard/open)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-putting-it-all" class="outline-5">
<h5 id="putting-it-all"><span class="section-number-5">2.4.9.5.</span> Putting it all together<a aria-hidden="true" href="#putting-it-all">#</a> </h5>
<div class="outline-text-5" id="text-2-4-9-5">
<p>
With the splash image and phrase generation worked out, we can almost put
together the desired dashboard from scratch, we just need to re-create the
benchmark information by itself.
</p>

<details id='putting-it-all,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+doom-dashboard-benchmark-line</span> ()
  <span class="org-doc">"Insert the load time line."</span>
  (<span class="org-keyword">when</span> doom-init-time
    (insert
     <span class="org-string">"\n\n"</span>
     (propertize
      (+doom-dashboard--center
       +doom-dashboard--width
       (doom-display-benchmark-h 'return))
      'face 'doom-dashboard-loaded))))
</pre>
</div>
</details>

<p>
With <code>doom-display-benchmark-h</code> displayed here, I don't see the need for it to be
shown in the minibuffer as well.
</p>

<details id='putting-it-all,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(remove-hook 'doom-after-init-hook #'doom-display-benchmark-h)
</pre>
</div>
</details>

<p>
Now we can create the desired dashboard by setting <code>+doom-dashboard-functions</code> to
just have:
</p>
<ul class="org-ul">
<li>The "widget banner" (splash image)</li>
<li>The benchmark line</li>
<li>A random phrase</li>
</ul>
<p>
This gets rid of two segments I'm not particularly interested in seeing
</p>
<ul class="org-ul">
<li>The shortmenu</li>
<li>The footer (github link)</li>
</ul>

<details id='putting-it-all,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> +doom-dashboard-functions
      (list #'doom-dashboard-widget-banner
            #'+doom-dashboard-benchmark-line
            #'splash-phrase-dashboard-insert))
</pre>
</div>
</details>

<p>
At this point there are just a few minor tweaks I'd still like to make to the
dashboard.
</p>

<details id='putting-it-all,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+doom-dashboard-tweak</span> (<span class="org-type">&amp;optional</span> _)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer +doom-dashboard-name)
    (<span class="org-keyword">setq-local</span> line-spacing 0.2
                mode-line-format nil
                mode-name <span class="org-string">""</span>
                evil-normal-state-cursor (list nil))))
</pre>
</div>
</details>

<p>
Now we can just add this as a mode hook.
</p>

<details id='putting-it-all,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook '+doom-dashboard-mode-hook #'+doom-dashboard-tweak)
</pre>
</div>
</details>

<p>
Unfortunately, the initialisation of <kbd>doom-modeline</kbd> interferes with the set
<code>mode-line-format</code> value. To get around this, we can re-apply
<code>+doom-dashboard-tweak</code> as a slightly late init hook, after <kbd>doom-modeline</kbd> has been
loaded.
</p>

<details id='putting-it-all,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'doom-after-init-hook #'+doom-dashboard-tweak 1)
</pre>
</div>
</details>

<p>
Lastly, with the buffer name being shown in the frame title thanks to some <a href="#window-title">other
configuration</a>, we might as well display something a bit prettier than <kbd>*doom*</kbd>.
</p>

<details id='putting-it-all,code--7' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> +doom-dashboard-name <span class="org-string">"&#9658; Doom"</span>
      doom-fallback-buffer-name +doom-dashboard-name)
</pre>
</div>
</details>

<p>
The end result is a minimal but rather nice splash screen.
</p>


<figure id="orgf1afef9">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/splash-screen.png" alt="The splash screen, just loaded." class="invertible">

</figure>

<p>
To keep the splash image up to date, we just need to check it every time the
frame size or theme is changed.
</p>

<details id='putting-it-all,code--8' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#putting-it-all,code--8'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'window-size-change-functions #'fancy-splash-apply-appropriate-image)
(add-hook 'doom-load-theme-hook #'fancy-splash-apply-appropriate-image)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-config-doctor" class="outline-4">
<h4 id="config-doctor"><span class="section-number-4">2.4.10.</span> Config doctor<a aria-hidden="true" href="#config-doctor">#</a> </h4>
<div class="outline-text-4" id="text-2-4-10">
<p>
We can collect checks throughout this config and put them in a <kbd>doctor.el</kbd> file
that will be run as part of <kbd>doom doctor</kbd>. This will complement the <kbd>setup.sh</kbd>
approach.
</p>

<details id='config-doctor,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#config-doctor,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">doctor.el -*- lexical-binding: t; no-byte-compile: t; -*-</span>

(<span class="org-keyword">let</span> (required-fonts available-fonts missing-fonts)
  (<span class="org-keyword">setq</span> required-fonts '(<span class="org-string">"JetBrains ?Mono.*"</span> <span class="org-string">"Overpass"</span> <span class="org-string">"JuliaMono"</span> <span class="org-string">"IBM Plex Mono"</span>
                         <span class="org-string">"Merriweather"</span> <span class="org-string">"Alegreya"</span> <span class="org-string">"Twitter Color Emoji"</span>))

  (<span class="org-keyword">setq</span> available-fonts
        (delete-dups
         (<span class="org-keyword">or</span> (font-family-list)
             (<span class="org-keyword">and</span> (executable-find <span class="org-string">"fc-list"</span>)
                  (<span class="org-keyword">with-temp-buffer</span>
                    (call-process <span class="org-string">"fc-list"</span> nil t nil <span class="org-string">":"</span> <span class="org-string">"family"</span>)
                    (split-string (buffer-string) <span class="org-string">"[,\n]"</span>))))))

  (<span class="org-keyword">setq</span> missing-fonts
        (delq nil (mapcar
                   (<span class="org-keyword">lambda</span> (font)
                     (<span class="org-keyword">unless</span> (delq nil (mapcar (<span class="org-keyword">lambda</span> (f)
                                                 (string-match-p (format <span class="org-string">"^%s$"</span> font) f))
                                               available-fonts))
                       font))
                   required-fonts)))
  (<span class="org-keyword">if</span> available-fonts
      (<span class="org-keyword">dolist</span> (font missing-fonts)
        (warn! (format <span class="org-string">"Missing font: %s."</span> font)))
    (warn! <span class="org-string">"Unable to check for missing fonts, is fc-list installed?"</span>)))
(<span class="org-keyword">unless</span> (string= <span class="org-string">"enabled\n"</span> (shell-command-to-string <span class="org-string">"systemctl --user is-enabled emacs.service"</span>))
  (warn! <span class="org-string">"Emacsclient service is not enabled."</span>))
(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"hunspell"</span>)
  (warn! <span class="org-string">"Couldn't find hunspell executable."</span>))
(<span class="org-keyword">unless</span> (file-exists-p <span class="org-string">"~/.local/share/hunspell/en-custom.dic"</span>)
  (warn! <span class="org-string">"Custom hunspell dictionary is not present."</span>))
(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"aspell"</span>)
  (warn! <span class="org-string">"Couldn't find aspell executable."</span>))
(<span class="org-keyword">unless</span> (file-exists-p <span class="org-string">"~/.config/enchant/aspell/en-custom.multi"</span>)
  (warn! <span class="org-string">"Custom aspell dictionary is not present."</span>))
(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"wal"</span>)
  (warn! <span class="org-string">"Couldn't find the pywal executable (wal), theme-magic will not function."</span>))
(<span class="org-keyword">if</span> (executable-find <span class="org-string">"sdcv"</span>)
    (<span class="org-keyword">let</span> ((dict-root (concat (<span class="org-keyword">or</span> (getenv <span class="org-string">"STARDICT_DATA_DIR"</span>)
                                 (concat (<span class="org-keyword">or</span> <span class="org-string">"~/.local/share"</span>
                                             (getenv <span class="org-string">"XDG_DATA_HOME"</span>))
                                         <span class="org-string">"/stardict"</span>))
                             <span class="org-string">"/dic"</span>))
          (dicts '(<span class="org-string">"webster"</span> <span class="org-string">"synonyms"</span> <span class="org-string">"etymology"</span> <span class="org-string">"en-to-latin"</span> <span class="org-string">"hitchcock"</span> <span class="org-string">"elements"</span>)))
      (<span class="org-keyword">if</span> (file-exists-p dict-root)
          (<span class="org-keyword">dolist</span> (dict dicts)
            (<span class="org-keyword">unless</span> (file-exists-p (file-name-concat dict-root dict))
              (warn! (format <span class="org-string">"Absent sdcv dictionary: %s."</span> dict))))
        (warn! <span class="org-string">"Couldn't find any stcv dictionaries, lexic will not function"</span>)))
  (warn! <span class="org-string">"Couldn't find sdcv executable, lexic will be disabled"</span>))
(<span class="org-keyword">when</span> (file-exists-p <span class="org-string">"~/.mail"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">We care about mail when the mail folder exists</span>
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"mu"</span>)
    (error! <span class="org-string">"Couldn't find mail dependency mu."</span>))
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"mbsync"</span>)
    (error! <span class="org-string">"Couldn't find mail dependency mbsync."</span>))
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"msmtp"</span>)
    (error! <span class="org-string">"Couldn't find mail dependency msmtp."</span>))
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"goimapnotify"</span>)
    (warn! <span class="org-string">"Couldn't find mail helper goimapnotify, mail syncs will be slower."</span>)))
(<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (executable-find <span class="org-string">"goimapnotify"</span>)
           (not (file-exists-p <span class="org-string">"~/.config/imapnotify"</span>)))
  (warn! <span class="org-string">"goimapnotify is installed but not configured."</span>))
(<span class="org-keyword">when</span> (executable-find <span class="org-string">"mbsync"</span>)
  (<span class="org-keyword">unless</span> (string= <span class="org-string">"enabled\n"</span> (shell-command-to-string <span class="org-string">"systemctl --user is-enabled mbsync.timer"</span>))
    (warn! <span class="org-string">"The mbsync timer is not enabled."</span>)))
(<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (executable-find <span class="org-string">"mu"</span>)
           (not (string= (shell-command-to-string <span class="org-string">"xdg-mime query default x-scheme-handler/mailto"</span>)
                         <span class="org-string">"emacsmail.desktop\n"</span>)))
  (warn! <span class="org-string">"Emacs is not registered as a mailto handler."</span>))
(<span class="org-keyword">if</span> (string= (shell-command-to-string <span class="org-string">"xdg-mime query default text/org"</span>) <span class="org-string">""</span>)
  (warn! <span class="org-string">"text/org is not a registered mime type."</span>)
  (<span class="org-keyword">unless</span> (string= (shell-command-to-string <span class="org-string">"xdg-mime query default text/org"</span>) <span class="org-string">"emacs-client.desktop\n"</span>)
    (warn! <span class="org-string">"Emacs(client) is not set up as the text/org handler."</span>)))
(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"latex2text"</span>)
  (warn! <span class="org-string">"Couldn't find latex2text executable (from pylatexenc), will be unable to render LaTeX fragments in org&#8594;text exports."</span>))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-other-things" class="outline-3">
<h3 id="other-things"><span class="section-number-3">2.5.</span> Other things<a aria-hidden="true" href="#other-things">#</a> </h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-editor-interaction" class="outline-4">
<h4 id="editor-interaction"><span class="section-number-4">2.5.1.</span> Editor interaction<a aria-hidden="true" href="#editor-interaction">#</a> </h4>
<div class="outline-text-4" id="text-2-5-1">
</div>
<div id="outline-container-mouse-buttons" class="outline-5">
<h5 id="mouse-buttons"><span class="section-number-5">2.5.1.1.</span> Mouse buttons<a aria-hidden="true" href="#mouse-buttons">#</a> </h5>
<div class="outline-text-5" id="text-2-5-1-1">
<details id='mouse-buttons,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mouse-buttons,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:n</span> [mouse-8] #'better-jumper-jump-backward
      <span class="org-builtin">:n</span> [mouse-9] #'better-jumper-jump-forward)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-window-title" class="outline-4">
<h4 id="window-title"><span class="section-number-4">2.5.2.</span> Window title<a aria-hidden="true" href="#window-title">#</a> </h4>
<div class="outline-text-4" id="text-2-5-2">
<p>
I'd like to have just the buffer name, then if applicable the project folder
</p>
<details id='window-title,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#window-title,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> frame-title-format
      '(<span class="org-string">""</span>
        (<span class="org-builtin">:eval</span>
         (<span class="org-keyword">if</span> (string-match-p (regexp-quote (<span class="org-keyword">or</span> (<span class="org-keyword">bound-and-true-p</span> org-roam-directory) <span class="org-string">"\u0000"</span>))
                             (<span class="org-keyword">or</span> buffer-file-name <span class="org-string">""</span>))
             (replace-regexp-in-string
              <span class="org-string">".*/[0-9]*-?"</span> <span class="org-string">"&#9776; "</span>
              (subst-char-in-string ?_ ?\s buffer-file-name))
           <span class="org-string">"%b"</span>))
        (<span class="org-builtin">:eval</span>
         (<span class="org-keyword">when-let</span> ((project-name (<span class="org-keyword">and</span> (<span class="org-keyword">featurep</span> '<span class="org-constant">projectile</span>) (projectile-project-name))))
           (<span class="org-keyword">unless</span> (string= <span class="org-string">"-"</span> project-name)
             (format (<span class="org-keyword">if</span> (buffer-modified-p)  <span class="org-string">" &#9673; %s"</span> <span class="org-string">" &#8198;&#9679;&#8198; %s"</span>) project-name))))))
</pre>
</div>
</details>

<p>
For example when I open my config file it the window will be titled <kbd>config.org ●
doom</kbd> then as soon as I make a change it will become <kbd>config.org ◉ doom</kbd>.
</p>
</div>
</div>
<div id="outline-container-systemd-daemon" class="outline-4">
<h4 id="systemd-daemon"><span class="section-number-4">2.5.3.</span> Systemd daemon<a aria-hidden="true" href="#systemd-daemon">#</a> </h4>
<div class="outline-text-4" id="text-2-5-3">
<p>
For running a systemd service for a Emacs server I have the following. <kbd>zsh -c</kbd> is
used to ensure that <kbd>.zshenv</kbd> is loaded.
</p>

<details id='emacsclient-service' class='code' open><summary class='named'><span class="name">emacsclient service</span><span class="lang">systemd</span></summary>
<div class='gutter'>
<a href='#emacsclient-service'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-systemd"><span class="org-type">[Unit]</span>
<span class="org-keyword">Description</span>=Emacs server daemon
<span class="org-keyword">Documentation</span>=info:emacs man:emacs(1) https://gnu.org/software/emacs/
<span class="org-keyword">Wants</span>=gpg-agent.service

<span class="org-type">[Service]</span>
<span class="org-keyword">Type</span>=<span class="org-builtin">forking</span>
<span class="org-keyword">ExecStart</span>=zsh -c <span class="org-string">'emacs --daemon &amp;&amp; emacsclient -c --eval "(delete-frame)"'</span>
<span class="org-keyword">ExecStop</span>=/usr/bin/emacsclient --no-wait --eval <span class="org-string">"(progn (setq kill-emacs-hook nil) (kill emacs))"</span>
<span class="org-keyword">Environment</span>=COLORTERM=truecolor
<span class="org-keyword">Restart</span>=<span class="org-builtin">on-failure</span>

<span class="org-type">[Install]</span>
<span class="org-keyword">WantedBy</span>=default.target
</pre>
</div>
</details>

<p>
which is then enabled by
</p>
<details id='systemd-daemon,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#systemd-daemon,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">systemctl --user enable emacs.service
</pre>
</div>
</details>

<p>
We can also add a <kbd>doctor</kbd> warning should this not be enabled.
</p>

<details id='systemd-daemon,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#systemd-daemon,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (string= <span class="org-string">"enabled\n"</span> (shell-command-to-string <span class="org-string">"systemctl --user is-enabled emacs.service"</span>))
  (warn! <span class="org-string">"Emacsclient service is not enabled."</span>))
</pre>
</div>
</details>

<p>
For some reason if a frame isn't opened early in the initialisation process, the
daemon doesn't seem to like opening frames later &#x2014; hence the <code>&amp;&amp; emacsclient</code>
part of the <kbd>ExecStart</kbd> value.
</p>

<p>
It can now be nice to use this as a 'default app' for opening files. If we add
an appropriate desktop entry, and enable it in the desktop environment.
</p>

<details id='systemd-daemon,code--3' class='code' open><summary><span class="lang">Configuration File</span></summary>
<div class='gutter'>
<a href='#systemd-daemon,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">Desktop Entry</span>]
<span class="org-variable-name">Name</span>=Emacs client
<span class="org-variable-name">GenericName</span>=Text Editor
<span class="org-variable-name">Comment</span>=A flexible platform for end-user applications
<span class="org-variable-name">MimeType</span>=text/english;text/plain;text/x-makefile;text/x-c++hdr;text/x-c++src;text/x-chdr;text/x-csrc;text/x-java;text/x-moc;text/x-pascal;text/x-tcl;text/x-tex;application/x-shellscript;text/x-c;text/x-c++;
<span class="org-variable-name">Exec</span>=emacsclient -create-frame --alternate-editor=<span class="org-string">""</span> --no-wait %F
<span class="org-variable-name">Icon</span>=emacs
<span class="org-variable-name">Type</span>=Application
<span class="org-variable-name">Terminal</span>=false
<span class="org-variable-name">Categories</span>=TextEditor;Utility;
<span class="org-variable-name">StartupWMClass</span>=Emacs
<span class="org-variable-name">Keywords</span>=Text;Editor;
<span class="org-variable-name">X-KDE-StartupNotify</span>=false
</pre>
</div>
</details>

<p>
When the daemon is running, I almost always want to do a few particular things
with it, so I may as well eat the load time at startup. We also want to keep
<kbd>mu4e</kbd> running.
</p>

<p>
It would be good to start the <span class='acr'>IRC</span> client (<kbd>circe</kbd>) too, but that seems to have
issues when started in a non-graphical session.
</p>

<p>
Lastly, while I'm not sure quite why it happens, but after a bit it seems that
new Emacsclient frames start on the <kbd>*scratch*</kbd> buffer instead of the dashboard.
I prefer the dashboard, so let's ensure that's always switched to in new frames.
</p>

<details id='daemon-initialisation' class='code' open><summary class='named'><span class="name">daemon initialisation</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#daemon-initialisation'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">greedily-do-daemon-setup</span> ()
  (<span class="org-keyword">require</span> '<span class="org-constant">org</span>)
  (<span class="org-keyword">when</span> (<span class="org-keyword">require</span> '<span class="org-constant">mu4e</span> nil t)
    (<span class="org-keyword">setq</span> mu4e-confirm-quit t)
    (<span class="org-keyword">setq</span> +mu4e-lock-greedy t)
    (<span class="org-keyword">setq</span> +mu4e-lock-relaxed t)
    (<span class="org-keyword">when</span> (+mu4e-lock-available t)
      (mu4e--start)))
  (<span class="org-keyword">when</span> (<span class="org-keyword">require</span> '<span class="org-constant">elfeed</span> nil t)
    (run-at-time nil (* 8 60 60) #'elfeed-update)))

(<span class="org-keyword">when</span> (daemonp)
  (add-hook 'emacs-startup-hook #'greedily-do-daemon-setup)
  (<span class="org-keyword">add-hook!</span> 'server-after-make-frame-hook
    (<span class="org-keyword">unless</span> (string-match-p <span class="org-string">"\\*draft</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\*stdin</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">emacs-everywhere"</span> (buffer-name))
      (switch-to-buffer +doom-dashboard-name))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-emacs-client-wrapper" class="outline-4">
<h4 id="emacs-client-wrapper"><span class="section-number-4">2.5.4.</span> Emacs client wrapper<a aria-hidden="true" href="#emacs-client-wrapper">#</a> </h4>
<div class="outline-text-4" id="text-2-5-4">
<p>
I frequently want to make use of Emacs while in a terminal emulator. To make
this easier, I can construct a few handy aliases.
</p>

<p>
However, a little convenience script in <kbd>~/.local/bin</kbd> can have the same effect,
be available beyond the specific shell I plop the alias in, then also allow me
to add a few bells and whistles &#x2014; namely:
</p>
<ul class="org-ul">
<li>Accepting stdin by putting it in a temporary file and immediately opening it.</li>
<li>Guessing that the <kbd>tty</kbd> is a good idea when <code>$DISPLAY</code> is unset (relevant with <span class='acr'>SSH</span>
sessions, among other things).</li>
<li>With a whiff of 24-bit colour support, sets <code>TERM</code> variable to a <kbd>terminfo</kbd> that
(probably) announces 24-bit colour support.</li>
<li>Changes <span class='acr'>GUI</span> <kbd>emacsclient</kbd> instances to be non-blocking by default (<code>--no-wait</code>),
and instead take a flag to suppress this behaviour (<code>-w</code>).</li>
</ul>

<p>
I would use <kbd>sh</kbd>, but using arrays for argument manipulation is just too
convenient, so I'll raise the requirement to <kbd>bash</kbd>. Since arrays are the only
'extra' compared to <kbd>sh</kbd>, other shells like <kbd>ksh</kbd> etc. should work too.
</p>

<details id='e' class='code' open><summary class='named'><span class="name">e</span><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#e'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash</span>
<span class="org-variable-name">force_tty</span>=false
<span class="org-variable-name">force_wait</span>=false
<span class="org-variable-name">stdin_mode</span>=<span class="org-string">""</span>

<span class="org-variable-name">args</span>=()

<span class="org-keyword">while</span> :; <span class="org-keyword">do</span>
    <span class="org-keyword">case</span> <span class="org-string">"$1"</span><span class="org-keyword"> in</span>
        -t | -nw | --tty)
            <span class="org-variable-name">force_tty</span>=true
            <span class="org-builtin">shift</span> ;;
        -w | --wait)
            <span class="org-variable-name">force_wait</span>=true
            <span class="org-builtin">shift</span> ;;
        -m | --mode)
            <span class="org-variable-name">stdin_mode</span>=<span class="org-string">" ($2-mode)"</span>
            <span class="org-builtin">shift</span> 2 ;;
        -h | --help)
            <span class="org-builtin">echo</span> -e <span class="org-string">"\033[1mUsage: e [-t] [-m MODE] [OPTIONS] FILE [-]\033[0m</span>

<span class="org-string">Emacs client convenience wrapper.</span>

<span class="org-string">\033[1mOptions:\033[0m</span>
<span class="org-string">\033[0;34m-h, --help\033[0m            Show this message</span>
<span class="org-string">\033[0;34m-t, -nw, --tty\033[0m        Force terminal mode</span>
<span class="org-string">\033[0;34m-w, --wait\033[0m            Don't supply \033[0;34m--no-wait\033[0m to graphical emacsclient</span>
<span class="org-string">\033[0;34m-\033[0m                     Take \033[0;33mstdin\033[0m (when last argument)</span>
<span class="org-string">\033[0;34m-m MODE, --mode MODE\033[0m  Mode to open \033[0;33mstdin\033[0m with</span>

<span class="org-string">Run \033[0;32memacsclient --help\033[0m to see help for the emacsclient."</span>
            <span class="org-keyword">exit</span> 0 ;;
        --*=*)
            <span class="org-builtin">set</span> -- <span class="org-string">"$@"</span> <span class="org-string">"${1%%=*}"</span> <span class="org-string">"${1#*=}"</span>
            <span class="org-builtin">shift</span> ;;
        *)
            <span class="org-keyword">if</span> [ <span class="org-string">"$#"</span> = 0 ]; <span class="org-keyword">then</span>
                <span class="org-keyword">break</span>; <span class="org-keyword">fi</span>
            args+=(<span class="org-string">"$1"</span>)
            <span class="org-builtin">shift</span> ;;
    <span class="org-keyword">esac</span>
<span class="org-keyword">done</span>

<span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> <span class="org-string">"${#args[*]}"</span> = 0 ] &amp;&amp; [ <span class="org-string">"${args[-1]}"</span> = <span class="org-string">"-"</span> ]; <span class="org-keyword">then</span>
    <span class="org-builtin">unset</span> <span class="org-string">'args[-1]'</span>
    <span class="org-variable-name">TMP</span>=<span class="org-string">"$(mktemp /tmp/emacsstdin-XXX)"</span>
    cat &gt; <span class="org-string">"$TMP"</span>
    args+=(--eval <span class="org-string">"(let ((b (generate-new-buffer \"*stdin*\"))) (switch-to-buffer b) (insert-file-contents \"$TMP\") (delete-file \"$TMP\")${stdin_mode})"</span>)
<span class="org-keyword">fi</span>

<span class="org-keyword">if</span> [ -z <span class="org-string">"$DISPLAY"</span> ] || $<span class="org-variable-name">force_tty</span>; <span class="org-keyword">then</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">detect terminals with sneaky 24-bit support</span>
    <span class="org-keyword">if</span> { [ <span class="org-string">"$COLORTERM"</span> = truecolor ] || [ <span class="org-string">"$COLORTERM"</span> = 24bit ]; } <span class="org-sh-escaped-newline">\</span>
        &amp;&amp; [ <span class="org-string">"$(tput colors 2&gt;/dev/null)"</span> -lt 257 ]; <span class="org-keyword">then</span>
        <span class="org-keyword">if </span><span class="org-builtin">echo</span> <span class="org-string">"$TERM"</span> | grep -q <span class="org-string">"^\w\+-[0-9]"</span>; <span class="org-keyword">then</span>
            <span class="org-variable-name">termstub</span>=<span class="org-string">"${TERM%%-*}"</span>; <span class="org-keyword">else</span>
            <span class="org-variable-name">termstub</span>=<span class="org-string">"${TERM#*-}"</span>; <span class="org-keyword">fi</span>
        <span class="org-keyword">if</span> infocmp <span class="org-string">"$termstub-direct"</span> &gt;/dev/null 2&gt;&amp;1; <span class="org-keyword">then</span>
            <span class="org-variable-name">TERM</span>=<span class="org-string">"$termstub-direct"</span>; <span class="org-keyword">else</span>
            <span class="org-variable-name">TERM</span>=<span class="org-string">"xterm-direct"</span>; <span class="org-keyword">fi</span> <span class="org-comment-delimiter"># </span><span class="org-comment">should be fairly safe</span>
    <span class="org-keyword">fi</span>
    emacsclient --tty -create-frame --alternate-editor=<span class="org-string">"$ALTERNATE_EDITOR"</span> <span class="org-string">"${args[@]}"</span>
<span class="org-keyword">else</span>
    <span class="org-keyword">if</span> <span class="org-negation-char">!</span> $<span class="org-variable-name">force_wait</span>; <span class="org-keyword">then</span>
        args+=(--no-wait); <span class="org-keyword">fi</span>
    emacsclient -create-frame --alternate-editor=<span class="org-string">"$ALTERNATE_EDITOR"</span> <span class="org-string">"${args[@]}"</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</details>

<p>
Now, to set an alias to use <kbd>e</kbd> with Magit, and then for maximum laziness we can
set aliases for the terminal-forced variants.
</p>
<details id='emacs-client-wrapper,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#emacs-client-wrapper,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">alias <span class="org-variable-name">m</span>=<span class="org-string">'e --eval "(progn (magit-status) (delete-other-windows))"'</span>
alias <span class="org-variable-name">mt</span>=<span class="org-string">"m -t"</span>
alias <span class="org-variable-name">et</span>=<span class="org-string">"e -t"</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-prompt-run-setup" class="outline-4">
<h4 id="prompt-run-setup"><span class="section-number-4">2.5.5.</span> Prompt to run setup script<a aria-hidden="true" href="#prompt-run-setup">#</a> </h4>
<div class="outline-text-4" id="text-2-5-5">
<p>
At various points in this config, content is conditionally tangled to
<kbd>./setup.sh</kbd>. It's no good just putting content there if it isn't run though.
To help remind me to run it when needed, let's add a little prompt when there's
anything to be run.
</p>

<details id='run-setup' class='code' open><summary class='named'><span class="name">run-setup</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#run-setup'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">if</span> (file-exists-p <span class="org-string">"setup.sh"</span>)
    (<span class="org-keyword">if</span> (string-empty-p (string-trim (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"setup.sh"</span>) (buffer-string)) <span class="org-string">"#!/usr/bin/env bash"</span>))
        (message <span class="org-string">";; Setup script is empty"</span>)
      (message <span class="org-string">";; Detected content in the setup script"</span>)
      (pp-to-string
       `(<span class="org-keyword">unless</span> noninteractive
          (<span class="org-keyword">defun</span> <span class="org-function-name">+config-run-setup</span> ()
            (<span class="org-keyword">when-let</span> ((setup-file (expand-file-name <span class="org-string">"setup.sh"</span> doom-user-dir))
                       ((file-exists-p setup-file))
                       (setup-content (string-trim (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents setup-file) (buffer-string))
                                                   <span class="org-string">"#!/usr/bin/env bash"</span>))
                       ((not (string-empty-p setup-content)))
                       ((yes-or-no-p (format <span class="org-string">"%s The setup script has content. Check and run the script?"</span>
                                             (propertize <span class="org-string">"Warning!"</span> 'face '(bold warning))))))
              (find-file setup-file)
              (<span class="org-keyword">when</span> (yes-or-no-p <span class="org-string">"Would you like to run this script?"</span>)
                (async-shell-command <span class="org-string">"./setup.sh"</span>))))
          (<span class="org-keyword">add-hook!</span> 'doom-init-ui-hook
            (run-at-time nil nil #'+config-run-setup)))))
  (message <span class="org-string">";; setup.sh did not exist during tangle. Tangle again."</span>)
  (pp-to-string
   `(<span class="org-keyword">unless</span> noninteractive
      (<span class="org-keyword">add-hook!</span> 'doom-init-ui-hook #'+literate-tangle-async-h))))
</pre>
</div>
</details>

<details id='prompt-run-setup,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prompt-run-setup,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;run-setup()&gt;&gt;
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-grabbing-source-block" class="outline-4">
<h4 id="grabbing-source-block"><span class="section-number-4">2.5.6.</span> Grabbing source block content as a string<a aria-hidden="true" href="#grabbing-source-block">#</a> </h4>
<div class="outline-text-4" id="text-2-5-6">
<p>
In a few places in this configuration, it is desirable to grab a source block's
content as a string. We can use a noweb <kbd>&lt;&lt;replacement&gt;&gt;</kbd> form, however that
doesn't work with string escaping.
</p>

<p>
We can get around this by using noweb execution and write an name (unexported)
babel block that will grab the content of another named source block as a
string. Note that this does not currently expand nested noweb references.
</p>

<details id='grab' class='code' open><summary class='named'><span class="name">grab</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#grab'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Babel block: grab(name &amp;optional pre post)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">NAME is the name of the source block to grab.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">PRE is a string to prepend to the content of the block.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">POST is a string to append to the content of the block.</span>
(<span class="org-keyword">if-let</span> ((block-pos (org-babel-find-named-block name))
         (<span class="org-keyword">block</span> (org-element-at-point block-pos)))
    (format <span class="org-string">"%S"</span> (concat pre (string-trim (org-element-property <span class="org-builtin">:value</span> block)) post))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">look for :noweb-ref matches</span>
  (<span class="org-keyword">let</span> (block-contents)
    (org-element-cache-map
     (<span class="org-keyword">lambda</span> (src)
       (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not (org-in-commented-heading-p nil src))
                  (not (org-in-archived-heading-p nil src))
                  (<span class="org-keyword">let*</span> ((lang (org-element-property <span class="org-builtin">:language</span> src))
                         (params
                          (apply
                           #'org-babel-merge-params
                           (append
                            (<span class="org-keyword">org-with-point-at</span> (org-element-property <span class="org-builtin">:begin</span> src)
                              (org-babel-params-from-properties lang t))
                            (mapcar
                             (<span class="org-keyword">lambda</span> (h)
                               (org-babel-parse-header-arguments h t))
                             (cons (org-element-property <span class="org-builtin">:parameters</span> src)
                                   (org-element-property <span class="org-builtin">:header</span> src))))))
                         (ref (alist-get <span class="org-builtin">:noweb-ref</span> params)))
                    (equal ref name)))
         (<span class="org-keyword">push</span> (org-babel--normalize-body src)
               block-contents)))
     <span class="org-builtin">:granularity</span> 'element
     <span class="org-builtin">:restrict-elements</span> '(src-block))
    (<span class="org-keyword">and</span> block-contents
         (format <span class="org-string">"%S"</span>
                 (concat
                  pre
                  (mapconcat
                   #'identity
                   (nreverse block-contents)
                   <span class="org-string">"\n\n"</span>)
                  post)))))
</pre>
</div>
</details>

<p>
There we go, that's all it takes! This can be used via the form <kbd>&lt;&lt;grab("block-name")&gt;&gt;</kbd>.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-packages" class="outline-2">
<h2 id="packages"><span class="section-number-2">3.</span> Packages<a aria-hidden="true" href="#packages">#</a> </h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-loading-instructions" class="outline-3">
<h3 id="loading-instructions"><span class="section-number-3">3.1.</span> Loading instructions<a aria-hidden="true" href="#loading-instructions">#</a> </h3>
<div class="outline-text-3" id="text-3-1">
<p>
This is where you install packages, by declaring them with the <code>package!</code> macro in
<kbd>packages.el</kbd>, then running <code>doom refresh</code> on the command line.
This file shouldn't be byte compiled.
</p>
<details id='loading-instructions,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#loading-instructions,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">-*- no-byte-compile: t; -*-</span>
</pre>
</div>
</details>

<p>
You'll then need to restart Emacs for your changes to take effect! Or at least,
run <kbd>M-x doom/reload</kbd>.
</p>

<p>
<b>Warning</b>: Don't disable core packages listed in <kbd>~/.config/emacs/core/packages.el</kbd>.
Doom requires these, and disabling them may have terrible side effects.
</p>
</div>
<div id="outline-container-packages-melpa-elpa" class="outline-4">
<h4 id="packages-melpa-elpa"><span class="section-number-4">3.1.1.</span> Packages in <span class='acr'><span class='acr'>MELPA</span></span>/<span class='acr'><span class='acr'>ELPA</span></span>/emacsmirror<a aria-hidden="true" href="#packages-melpa-elpa">#</a> </h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
To install <code>some-package</code> from <span class='acr'>MELPA</span>, <span class='acr'>ELPA</span> or emacsmirror:
</p>
<details id='packages-melpa-elpa,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#packages-melpa-elpa,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> some-package)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-packages-from-git" class="outline-4">
<h4 id="packages-from-git"><span class="section-number-4">3.1.2.</span> Packages from git repositories<a aria-hidden="true" href="#packages-from-git">#</a> </h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
To install a package directly from a particular repo, you'll need to specify
a <code>:recipe</code>. You'll find documentation on what <code>:recipe</code> accepts <a href="https://github.com/raxod502/straight.el#the-recipe-format">here</a>:
</p>
<details id='packages-from-git,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#packages-from-git,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> another-package
  <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"username/repo"</span>))
</pre>
</div>
</details>

<p>
If the package you are trying to install does not contain a <code>PACKAGENAME.el</code>
file, or is located in a subdirectory of the repo, you'll need to specify
<code>:files</code> in the <code>:recipe</code>:
</p>
<details id='packages-from-git,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#packages-from-git,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> this-package
  <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"username/repo"</span>
           <span class="org-builtin">:files</span> (<span class="org-string">"some-file.el"</span> <span class="org-string">"src/lisp/*.el"</span>)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-disabling-built-packages" class="outline-4">
<h4 id="disabling-built-packages"><span class="section-number-4">3.1.3.</span> Disabling built-in packages<a aria-hidden="true" href="#disabling-built-packages">#</a> </h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
If you'd like to disable a package included with Doom, for whatever reason,
you can do so here with the <code>:disable</code> property:
</p>
<details id='disabling-built-packages,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#disabling-built-packages,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> builtin-package <span class="org-builtin">:disable</span> t)
</pre>
</div>
</details>
<p>
You can override the recipe of a built in package without having to specify
all the properties for <code>:recipe</code>. These will inherit the rest of its recipe
from Doom or <span class='acr'>MELPA</span>/<span class='acr'>ELPA</span>/Emacsmirror:
</p>
<details id='disabling-built-packages,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#disabling-built-packages,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> builtin-package <span class="org-builtin">:recipe</span> (<span class="org-builtin">:nonrecursive</span> t))
(<span class="org-keyword">package!</span> builtin-package-2 <span class="org-builtin">:recipe</span> (<span class="org-builtin">:repo</span> <span class="org-string">"myfork/package"</span>))
</pre>
</div>
</details>

<p>
Specify a <code>:branch</code> to install a package from a particular branch or tag.
</p>
<details id='disabling-built-packages,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#disabling-built-packages,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> builtin-package <span class="org-builtin">:recipe</span> (<span class="org-builtin">:branch</span> <span class="org-string">"develop"</span>))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-convenience" class="outline-3">
<h3 id="convenience"><span class="section-number-3">3.2.</span> Convenience<a aria-hidden="true" href="#convenience">#</a> </h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-avy" class="outline-4">
<h4 id="avy"><span class="section-number-4">3.2.1.</span> Avy<a aria-hidden="true" href="#avy">#</a> </h4>
<div class="outline-text-4" id="text-3-2-1">
<blockquote>
<p>
From the <kbd>:config default</kbd> module.
</p>
</blockquote>


<p>
What a wonderful way to jump to buffer positions, and it uses the <span class='acr'>QWERTY</span>
home-row for jumping. Very convenient &#x2026; except I'm using Colemak.
</p>

<details id='avy-colemak-setup' class='code' open><summary class='named'><span class="name">avy-colemak-setup</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#avy-colemak-setup'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> avy
  <span class="org-comment-delimiter">;; </span><span class="org-comment">home row priorities: 8 6 4 5 - - 1 2 3 7</span>
  (<span class="org-keyword">setq</span> avy-keys '(?n ?e ?i ?s ?t ?r ?i ?a)))
</pre>
</div>
</details>

<p>
Now let's just have this included when an ErgoDox is found via <kbd>dmesg</kbd>.
</p>

<details id='avy-detect-colemak' class='code' open><summary class='named'><span class="name">avy-detect-colemak</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#avy-detect-colemak'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">if</span> (= 0 (call-process <span class="org-string">"sh"</span> nil nil nil <span class="org-string">"-c"</span> <span class="org-string">"dmesg | grep -q '</span><span class="org-string"><span class="org-constant">ErgoDox</span></span><span class="org-string">'"</span>))
    (pp '&lt;&lt;avy-colemak-setup&gt;&gt;)
  <span class="org-string">";; Avy: Colemak layout not detected (ErgoDox not mentioned in dmesg)."</span>)
</pre>
</div>
</details>

<details id='avy,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#avy,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;avy-detect-colemak()&gt;&gt;
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-rotate-window-management" class="outline-4">
<h4 id="rotate-window-management"><span class="section-number-4">3.2.2.</span> Rotate (window management)<a aria-hidden="true" href="#rotate-window-management">#</a> </h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
The <kbd>rotate</kbd> package just adds the ability to rotate window layouts, but that
sounds nice to me.
</p>

<details id='rotate-window-management,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#rotate-window-management,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> rotate <span class="org-builtin">:pin</span> <span class="org-string">"4e9ac3ff800880bd9b705794ef0f7c99d72900a6"</span>)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-emacs-everywhere" class="outline-4">
<h4 id="emacs-everywhere"><span class="section-number-4">3.2.3.</span> Emacs Everywhere<a aria-hidden="true" href="#emacs-everywhere">#</a> </h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
The name says it all. It's loaded and set up (a bit) by <kbd>:app everywhere</kbd>, however
as I develop this I want the unpinned version I have as a submodule.
</p>

<details id='emacs-everywhere,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emacs-everywhere,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> emacs-everywhere <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/emacs-everywhere"</span>))
(<span class="org-keyword">unpin!</span> emacs-everywhere)
</pre>
</div>
</details>

<p>
Additionally, I'm going to make some personal choices that aren't made in the
Doom module.
</p>

<details id='emacs-everywhere,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emacs-everywhere,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! emacs-everywhere
  <span class="org-builtin">:if</span> (daemonp)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">spell-fu</span>)
  (<span class="org-keyword">setq</span> emacs-everywhere-major-mode-function #'org-mode
        emacs-everywhere-frame-name-format <span class="org-string">"Edit &#8759; %s &#8212; %s"</span>)
  (<span class="org-keyword">defadvice!</span> emacs-everywhere-raise-frame ()
    <span class="org-builtin">:after</span> #'emacs-everywhere-set-frame-name
    (<span class="org-keyword">setq</span> emacs-everywhere-frame-name (format emacs-everywhere-frame-name-format
                                (emacs-everywhere-app-class emacs-everywhere-current-app)
                                (truncate-string-to-width
                                 (emacs-everywhere-app-title emacs-everywhere-current-app)
                                 45 nil nil <span class="org-string">"&#8230;"</span>)))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">need to wait till frame refresh happen before really set</span>
    (run-with-timer 0.1 nil #'emacs-everywhere-raise-frame-1))
  (<span class="org-keyword">defun</span> <span class="org-function-name">emacs-everywhere-raise-frame-1</span> ()
    (call-process <span class="org-string">"wmctrl"</span> nil nil nil <span class="org-string">"-a"</span> emacs-everywhere-frame-name)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-which-key" class="outline-4">
<h4 id="which-key"><span class="section-number-4">3.2.4.</span> Which-key<a aria-hidden="true" href="#which-key">#</a> </h4>
<div class="outline-text-4" id="text-3-2-4">
<blockquote>
<p>
From the <kbd>:core packages</kbd> module.
</p>
</blockquote>

<p>
Let's make this popup a bit faster
</p>
<details id='which-key,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#which-key,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> which-key-idle-delay 0.5) <span class="org-comment-delimiter">;; </span><span class="org-comment">I need the help, I really do</span>
</pre>
</div>
</details>

<p>
I also think that having <kbd>evil-</kbd> appear in so many popups is a bit too verbose,
let's change that, and do a few other similar tweaks while we're at it.
</p>
<details id='which-key,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#which-key,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> which-key-allow-multiple-replacements t)
(<span class="org-keyword">after!</span> which-key
  (<span class="org-keyword">pushnew!</span>
   which-key-replacement-alist
   '((<span class="org-string">""</span> . <span class="org-string">"\\`+?evil[-:]?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">a-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>) . (nil . <span class="org-string">"&#9666;\\1"</span>))
   '((<span class="org-string">"\\`g s"</span> . <span class="org-string">"\\`evilem--?motion-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>) . (nil . <span class="org-string">"&#9667;\\1"</span>))
   ))
</pre>
</div>
</details>


<figure id="org5b496dc">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/whichkey-evil.png" alt="Whichkey triggered on an evil motion" class="invertible">

</figure>
</div>
</div>
</div>
<div id="outline-container-tools" class="outline-3">
<h3 id="tools"><span class="section-number-3">3.3.</span> Tools<a aria-hidden="true" href="#tools">#</a> </h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-abbrev" class="outline-4">
<h4 id="abbrev"><span class="section-number-4">3.3.1.</span> Abbrev<a aria-hidden="true" href="#abbrev">#</a> </h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Abbrev mode is great, and something I make use of in multiple ways. As such, I
want it on by default.
</p>

<details id='abbrev,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#abbrev,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq-default</span> abbrev-mode t)
</pre>
</div>
</details>

<p>
Abbrev-mode can save and load abbreviations from an "abbrev file", which I'd
like to locate in my Doom config folder.
</p>

<details id='abbrev,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#abbrev,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> abbrev-file-name (expand-file-name <span class="org-string">"abbrev.el"</span> doom-user-dir))
</pre>
</div>
</details>

<p>
I need to think more on how I want to manage abbrev changes in the current
session, but for now I'm going to be overly cautious and avoid any modifications
to the global abbrev file that I don't make myself.
</p>

<details id='abbrev,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#abbrev,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> save-abbrevs nil)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-very-large-files" class="outline-4">
<h4 id="very-large-files"><span class="section-number-4">3.3.2.</span> Very large files<a aria-hidden="true" href="#very-large-files">#</a> </h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
The <i>very large files</i> mode loads large files in chunks, allowing one to open
ridiculously large files.
</p>

<details id='very-large-files,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#very-large-files,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> vlf <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"emacs-straight/vlf"</span> <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span>))
  <span class="org-builtin">:pin</span> <span class="org-string">"d500f39672b35bf8551fdfafa892c551626c8d54"</span>)
</pre>
</div>
</details>

<p>
To make <span class='acr'>VLF</span> available without delaying startup, we'll just load it in quiet moments.
</p>

<details id='very-large-files,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#very-large-files,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! vlf-setup
  <span class="org-builtin">:defer-incrementally</span> vlf-tune vlf-base vlf-write
  vlf-search vlf-occur vlf-follow vlf-ediff vlf
  <span class="org-builtin">:commands</span> vlf vlf-mode
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">vlf-application</span> 'ask) <span class="org-comment-delimiter">; </span><span class="org-comment">Avoid load-order issues</span>
  &lt;&lt;vlf-largefile-prompt&gt;&gt;
  <span class="org-builtin">:config</span>
  (advice-remove 'abort-if-file-too-large #'ad-Advice-abort-if-file-too-large)
  &lt;&lt;vlf-linenum-offset&gt;&gt;
  &lt;&lt;vlf-search-chunking&gt;&gt;)
</pre>
</div>
</details>

<p>
Now, there are one or two tweaks worth applying to <span class='acr'>VLF</span>. For starters, it goes to
the liberty of advising <code>abort-if-file-too-large</code>, and in doing so removes the
option of opening files literally. I think that's a bit much, so we can remove
the advice and instead override <code>files--ask-user-about-large-file</code> (the more
appropriate function, I think) as a simpler approach, just sacrificing the
original behaviour with <code class="src src-elisp">(<span class="org-keyword">setq</span> vlf-application 'always)</code> (which I can't
imagine using anyway).
</p>

<details id='vlf-largefile-prompt' class='code' open><summary class='named'><span class="name">vlf-largefile-prompt</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#vlf-largefile-prompt'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +files--ask-about-large-file-vlf (size op-type filename offer-raw)
  <span class="org-doc">"Like `</span><span class="org-doc"><span class="org-constant">files--ask-user-about-large-file</span></span><span class="org-doc">', but with support for `</span><span class="org-doc"><span class="org-constant">vlf</span></span><span class="org-doc">'."</span>
  <span class="org-builtin">:override</span> #'files--ask-user-about-large-file
  (<span class="org-keyword">if</span> (eq vlf-application 'dont-ask)
      (<span class="org-keyword">progn</span> (vlf filename) (<span class="org-warning">error</span> <span class="org-string">""</span>))
    (<span class="org-keyword">let</span> ((prompt (format <span class="org-string">"File %s is large (%s), really %s?"</span>
                          (file-name-nondirectory filename)
                          (funcall byte-count-to-string-function size) op-type)))
      (<span class="org-keyword">if</span> (not offer-raw)
          (<span class="org-keyword">if</span> (y-or-n-p prompt) nil 'abort)
        (<span class="org-keyword">let</span> ((choice
               (car
                (read-multiple-choice
                 prompt '((?y <span class="org-string">"yes"</span>)
                          (?n <span class="org-string">"no"</span>)
                          (?l <span class="org-string">"literally"</span>)
                          (?v <span class="org-string">"vlf"</span>))
                 (files--ask-user-about-large-file-help-text
                  op-type (funcall byte-count-to-string-function size))))))
          (<span class="org-keyword">cond</span> ((eq choice ?y) nil)
                ((eq choice ?l) 'raw)
                ((eq choice ?v)
                 (vlf filename)
                 (<span class="org-warning">error</span> <span class="org-string">""</span>))
                (t 'abort)))))))
</pre>
</div>
</details>

<p>
As you go from one chunk fetched by <span class='acr'>VLF</span> to the next, the displayed line number
of the first line <i>in each chunk</i> is unchanged. I think it's reasonable to hope
for an <i>overall</i> line number, and by tracking chunk's cumulative line numbers we
can implement this behaviour fairly easily.
</p>

<details id='vlf-linenum-offset' class='code' open><summary class='named'><span class="name">vlf-linenum-offset</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#vlf-linenum-offset'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar-local</span> <span class="org-variable-name">+vlf-cumulative-linenum</span> '((0 . 0))
  <span class="org-doc">"An alist keeping track of the cumulative line number."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">+vlf-update-linum</span> ()
  <span class="org-doc">"Update the line number offset."</span>
  (<span class="org-keyword">let</span> ((linenum-offset (alist-get vlf-start-pos +vlf-cumulative-linenum)))
    (<span class="org-keyword">setq</span> display-line-numbers-offset (<span class="org-keyword">or</span> linenum-offset 0))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> linenum-offset (not (assq vlf-end-pos +vlf-cumulative-linenum)))
      (<span class="org-keyword">push</span> (cons vlf-end-pos (+ linenum-offset
                                 (count-lines (point-min) (point-max))))
            +vlf-cumulative-linenum))))

(add-hook 'vlf-after-chunk-update-hook #'+vlf-update-linum)

<span class="org-comment-delimiter">;; </span><span class="org-comment">Since this only works with absolute line numbers, let's make sure we use them.</span>
(<span class="org-keyword">add-hook!</span> 'vlf-mode-hook (<span class="org-keyword">setq-local</span> display-line-numbers t))
</pre>
</div>
</details>

<p>
The other thing that doesn't work too well with <span class='acr'>VLF</span> is searching with anything
other than <kbd>M-x occur</kbd>. This is because trying to go to the next match at the end
of a chunk usually wraps the point to the beginning of the chunk, instead of
moving to the next chunk.
</p>

<details id='vlf-search-chunking' class='code' open><summary class='named'><span class="name">vlf-search-chunking</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#vlf-search-chunking'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+vlf-next-chunk-or-start</span> ()
  (<span class="org-keyword">if</span> (= vlf-file-size vlf-end-pos)
      (vlf-jump-to-chunk 1)
    (vlf-next-batch 1))
  (goto-char (point-min)))

(<span class="org-keyword">defun</span> <span class="org-function-name">+vlf-last-chunk-or-end</span> ()
  (<span class="org-keyword">if</span> (= 0 vlf-start-pos)
      (vlf-end-of-file)
    (vlf-prev-batch 1))
  (goto-char (point-max)))

(<span class="org-keyword">defun</span> <span class="org-function-name">+vlf-isearch-wrap</span> ()
  (<span class="org-keyword">if</span> isearch-forward
      (+vlf-next-chunk-or-start)
    (+vlf-last-chunk-or-end)))

(<span class="org-keyword">add-hook!</span> 'vlf-mode-hook (<span class="org-keyword">setq-local</span> isearch-wrap-function #'+vlf-isearch-wrap))
</pre>
</div>
</details>

<p>
Unfortunately, since evil-search doesn't have an analogue to
<code>isearch-wrap-function</code>, we can't easily add support to it.
</p>
</div>
</div>
<div id="outline-container-eros" class="outline-4">
<h4 id="eros"><span class="section-number-4">3.3.3.</span> Eros<a aria-hidden="true" href="#eros">#</a> </h4>
<div class="outline-text-4" id="text-3-3-3">
<blockquote>
<p>
From the <kbd>:tools eval</kbd> module.
</p>
</blockquote>

<p>
This package enables the very nice inline evaluation with <kbd>gr</kbd> and <kbd>gR</kbd>. The prefix
could be slightly nicer though.
</p>
<details id='eros,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#eros,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> eros-eval-result-prefix <span class="org-string">"&#10233; "</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">default =&gt;</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-evil" class="outline-4">
<h4 id="evil"><span class="section-number-4">3.3.4.</span> <span class='acr'><span class='acr'>EVIL</span></span><a aria-hidden="true" href="#evil">#</a> </h4>
<div class="outline-text-4" id="text-3-3-4">
<blockquote>
<p>
From the <kbd>:editor evil</kbd> module.
</p>
</blockquote>

<p>
When I want to make a substitution, I want it to be global more often than not
&#x2014; so let's make that the default.
</p>

<p>
Now, <span class='acr'>EVIL</span> cares a fair bit about keeping compatibility with Vim's default
behaviour. I don't. There are some particular settings that I'd rather be
something else, so let's change them.
</p>

<details id='evil,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#evil,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> evil
  (<span class="org-keyword">setq</span> evil-ex-substitute-global t     <span class="org-comment-delimiter">; </span><span class="org-comment">I like my s/../.. to by global by default</span>
        evil-move-cursor-back nil       <span class="org-comment-delimiter">; </span><span class="org-comment">Don't move the block cursor when toggling insert mode</span>
        evil-kill-on-visual-paste nil)) <span class="org-comment-delimiter">; </span><span class="org-comment">Don't put overwritten text in the kill ring</span>
</pre>
</div>
</details>

<p>
I don't use <code>evil-escape-mode</code>, so I may as well turn it off, I've heard it
contributes a typing delay. I'm not sure it's much, but it is an extra
<code>pre-command-hook</code> that I don't benefit from, so&#x2026;
It seems that there's a dedicated package for this, so instead of just disabling
the mode on startup, let's prevent installation of the package.
</p>

<details id='evil,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#evil,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> evil-escape <span class="org-builtin">:disable</span> t)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-gptel" class="outline-4">
<h4 id="gptel"><span class="section-number-4">3.3.5.</span> GPTel<a aria-hidden="true" href="#gptel">#</a> </h4>
<div class="outline-text-4" id="text-3-3-5">
<details id='gptel,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gptel,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> gptel <span class="org-builtin">:pin</span> <span class="org-string">"94bf19da93aee9a101429d7ecbfbb9c7c5b67216"</span>)
</pre>
</div>
</details>

<details id='gptel,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gptel,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! gptel
  <span class="org-builtin">:commands</span> gptel gptel-menu gptel-mode gptel-send
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">let</span> ((groq-backend
         (gptel-make-openai <span class="org-string">"Groq"</span>
           <span class="org-builtin">:host</span> <span class="org-string">"api.groq.com"</span>
           <span class="org-builtin">:endpoint</span> <span class="org-string">"/openai/v1/chat/completions"</span>
           <span class="org-builtin">:stream</span> t
           <span class="org-builtin">:key</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">or</span> (secrets-get-secret <span class="org-string">"Login"</span> <span class="org-string">"groq"</span>)
                          (secrets-get-secret <span class="org-string">"kdewallet"</span> <span class="org-string">"groq"</span>)))
           <span class="org-builtin">:models</span> '(<span class="org-string">"llama3-70b-8192"</span>
                     <span class="org-string">"llama3-8b-8192"</span>
                     <span class="org-string">"llama-3.1-70b-versatile"</span>
                     <span class="org-string">"llama-3.1-8b-instant"</span>
                     <span class="org-string">"llama-3.2-1b-preview"</span>
                     <span class="org-string">"deepseek-r1-distill-llama-70b"</span>
                     <span class="org-string">"mixtral-8x7b-32768"</span>
                     <span class="org-string">"gemma-7b-it"</span>
                     <span class="org-string">"gemma2-9b-it"</span>)))
        (openai-backend
         (gptel-make-openai <span class="org-string">"ChatGPT"</span>
           <span class="org-builtin">:host</span> <span class="org-string">"api.openai.com"</span>
           <span class="org-builtin">:stream</span> t
           <span class="org-builtin">:key</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">or</span> (secrets-get-secret <span class="org-string">"Login"</span> <span class="org-string">"openai"</span>)
                          (secrets-get-secret <span class="org-string">"kdewallet"</span> <span class="org-string">"openai"</span>)))
           <span class="org-builtin">:models</span> '(<span class="org-string">"gpt-4o"</span> <span class="org-string">"gpt-4o-mini"</span> <span class="org-string">"chatgpt-4o-latest"</span>
                     <span class="org-string">"o1"</span> <span class="org-string">"o1-mini"</span>)))
        (anthropic-backend
         (gptel-make-anthropic <span class="org-string">"Claude"</span>
           <span class="org-builtin">:stream</span> t
           <span class="org-builtin">:key</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">or</span> (secrets-get-secret <span class="org-string">"Login"</span> <span class="org-string">"anthropic"</span>)
                          (secrets-get-secret <span class="org-string">"kdewallet"</span> <span class="org-string">"anthropic"</span>)))
           <span class="org-builtin">:models</span> '(<span class="org-string">"claude-3-5-sonnet-20240620"</span>
                     <span class="org-string">"claude-3-sonnet-20240229"</span>
                     <span class="org-string">"claude-3-haiku-20240307"</span>)))
        (ollama-backend
         (<span class="org-keyword">let</span> (ollama-models)
           (<span class="org-keyword">when</span> (executable-find <span class="org-string">"ollama"</span>)
             (<span class="org-keyword">with-temp-buffer</span>
               (call-process <span class="org-string">"ollama"</span> nil t nil <span class="org-string">"list"</span>)
               (goto-char (point-min))
               (forward-line 1)
               (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not (eobp)) (looking-at <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> \t]+"</span>))
                 (<span class="org-keyword">push</span> (match-string 0) ollama-models)
                 (forward-line 1)))
             (gptel-make-ollama <span class="org-string">"Ollama"</span> <span class="org-builtin">:models</span> ollama-models <span class="org-builtin">:stream</span> t)))))
    (<span class="org-keyword">setq-default</span> gptel-model <span class="org-string">"llama-3.1-70b-versatile"</span>
                  gptel-backend groq-backend))
  (delete (assoc <span class="org-string">"ChatGPT"</span> gptel--known-backends) gptel--known-backends)
  (<span class="org-keyword">setq</span> gptel-default-mode #'org-mode))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-headlice" class="outline-4">
<h4 id="headlice"><span class="section-number-4">3.3.6.</span> Headlice<a aria-hidden="true" href="#headlice">#</a> </h4>
<div class="outline-text-4" id="text-3-3-6">
<p>
Dealing with licenses and in particular license headers is frankly a bit of a
pain, and so I've written a package so that this just takes care of itself and I
don't have to think about it.
</p>

<details id='headlice,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#headlice,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> headlice <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/headlice"</span>
                            <span class="org-builtin">:files</span> (<span class="org-builtin">:defaults</span> <span class="org-string">"licenses"</span> <span class="org-string">"headers"</span>)))
</pre>
</div>
</details>

<p>
The author of this package has set some pretty good defaults, but as usual there
are some specific personal preferences I'd like to apply, and then there's the
minor matter of hooking it into Emacs/Doom.
</p>

<details id='headlice,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#headlice,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! headlice
  <span class="org-builtin">:hook</span> (prog-mode . headlice-auto-insert)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> headlice-preferred-license 'mpl
        headlice-use-spdx-headers t
        headlice-ignored-licenses '(gpl-3)
        headlice-user-email <span class="org-string">"contact@tecosaur.net"</span>)
  (<span class="org-keyword">defalias</span> '<span class="org-function-name">+file-templates/insert-license</span> #'headlice-create-license))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-consult" class="outline-4">
<h4 id="consult"><span class="section-number-4">3.3.7.</span> Consult<a aria-hidden="true" href="#consult">#</a> </h4>
<div class="outline-text-4" id="text-3-3-7">
<blockquote>
<p>
From the <kbd>:completion vertico</kbd> module.
</p>
</blockquote>

<p>
Since we're using <a href="#marginalia">3.4.10</a> too, the separation between buffers and files is
already clear, and there's no need for a different face.
</p>

<details id='consult,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#consult,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> consult
  (set-face-attribute 'consult-file nil <span class="org-builtin">:inherit</span> 'consult-buffer)
  (<span class="org-keyword">setf</span> (plist-get (alist-get 'perl consult-async-split-styles-alist) <span class="org-builtin">:initial</span>) <span class="org-string">";"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-magit" class="outline-4">
<h4 id="magit"><span class="section-number-4">3.3.8.</span> Magit<a aria-hidden="true" href="#magit">#</a> </h4>
<div class="outline-text-4" id="text-3-3-8">
<blockquote>
<p>
From the <kbd>:tools magit</kbd> module.
</p>
</blockquote>

<p>

</p>

<p>
Magit is great as-is, thanks for making such a lovely package <a href="https://github.com/tarsius">Jonas</a>!
</p>

<p>
There's still a room for a little tweaking though&#x2026;
</p>

<details id='magit,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#magit,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;magit-toplevel&gt;&gt;
(<span class="org-keyword">after!</span> magit
  &lt;&lt;magit-tweaks&gt;&gt;)
</pre>
</div>
</details>
</div>
<div id="outline-container-easier-forge-remotes" class="outline-5">
<h5 id="easier-forge-remotes"><span class="section-number-5">3.3.8.1.</span> Easier forge remotes<a aria-hidden="true" href="#easier-forge-remotes">#</a> </h5>
<div class="outline-text-5" id="text-3-3-8-1">
<p>
When creating a new project, I often want the remote to be to my personal Forgejo
instance. Let's make that a bit more streamlined by introducing a quick-entry
"default forge" option.
</p>

<details id='easier-forge-remotes,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#easier-forge-remotes,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+magit-default-forge-remote</span> <span class="org-string">"git@ssh.tecosaur.net:tec/%s.git"</span>
  <span class="org-doc">"Format string that fills out to a remote from the repo name.</span>
<span class="org-doc">Set to nil to disable this functionality."</span>)
</pre>
</div>
</details>

<p>
While we're at it, when creating a remote with the same name as my Github
username in a project where an <span class='acr'>HTTPS</span> GitHub remote already exists, let's make
the pre-filled remote <span class='acr'>URL</span> use ssh.
</p>

<details id='easier-forge-remotes,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#easier-forge-remotes,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +magit-remote-add--streamline-forge-a (args)
  <span class="org-doc">"Prompt to setup a remote using `</span><span class="org-doc"><span class="org-constant">+magit-default-forge-remote</span></span><span class="org-doc">'."</span>
  <span class="org-builtin">:filter-args</span> #'magit-remote-add
  (<span class="org-keyword">interactive</span>
   (<span class="org-keyword">let</span> ((default-name
          (subst-char-in-string
           ?\s ?-
           (file-name-nondirectory
            (directory-file-name
             (<span class="org-keyword">or</span> (doom-project-root) default-directory))))))
     (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> +magit-default-forge-remote
              (not (magit-list-remotes))
              (eq (read-char-choice
                   (format <span class="org-string">"Setup %s remote? [y/n]: "</span>
                           (replace-regexp-in-string
                            <span class="org-string">"\\`</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">@]+@</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">https://</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[:/].*\\'"</span> <span class="org-string">"\\1"</span>
                            +magit-default-forge-remote))
                   '(?y ?n))
                  ?y)
              (<span class="org-keyword">let</span> ((name (read-string <span class="org-string">"Name: "</span> default-name)))
                (list <span class="org-string">"origin"</span> (format +magit-default-forge-remote name)
                      (transient-args 'magit-remote))))
         (<span class="org-keyword">let</span> ((origin (magit-get <span class="org-string">"remote.origin.url"</span>))
               (remote (magit-read-string-ns <span class="org-string">"Remote name"</span>))
               (gh-user (magit-get <span class="org-string">"github.user"</span>)))
           (<span class="org-keyword">and</span> (equal remote gh-user)
                (<span class="org-keyword">if</span> origin
                    (<span class="org-keyword">and</span>
                     (string-match <span class="org-string">"\\`https://github\\.com/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.git\\'"</span>
                                   origin)
                     (not (string= (match-string 1 origin) gh-user)))
                  t)
                (<span class="org-keyword">setq</span> origin
                      (<span class="org-keyword">if</span> origin
                          (replace-regexp-in-string
                           <span class="org-string">"\\`https://github\\.com/"</span> <span class="org-string">"git@github.com:"</span>
                           origin)
                        (format <span class="org-string">"git@github.com:%s/%s"</span> gh-user (read-string <span class="org-string">"GitHub repo Name: "</span> default-name)))))
           (list remote
                 (magit-read-url
                  <span class="org-string">"Remote url"</span>
                  (<span class="org-keyword">and</span> origin
                       (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\.git</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?\\'"</span> origin)
                       (replace-match remote t t origin 1)))
                 (transient-args 'magit-remote))))))
  args)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-commit-message-templates" class="outline-5">
<h5 id="commit-message-templates"><span class="section-number-5">3.3.8.2.</span> Commit message templates<a aria-hidden="true" href="#commit-message-templates">#</a> </h5>
<div class="outline-text-5" id="text-3-3-8-2">
<p>
One little thing I want to add is some per-project commit message templates.
</p>

<details id='commit-message-templates,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#commit-message-templates,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+magit-project-commit-templates-alist</span> nil
  <span class="org-doc">"Alist of toplevel dirs and template hf strings/functions."</span>)
</pre>
</div>
</details>

<details id='commit-message-templates,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#commit-message-templates,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+magit-fill-in-commit-template</span> ()
  <span class="org-doc">"Insert template from `</span><span class="org-doc"><span class="org-constant">+magit-fill-in-commit-template</span></span><span class="org-doc">' if applicable."</span>
  (<span class="org-keyword">when-let</span> ((template (<span class="org-keyword">and</span> (<span class="org-keyword">save-excursion</span> (goto-char (point-min)) (string-match-p <span class="org-string">"\\`\\s-*$"</span> (thing-at-point 'line)))
                            (cdr (assoc (file-name-base (directory-file-name (magit-toplevel)))
                                        +magit-project-commit-templates-alist)))))
    (goto-char (point-min))
    (insert (<span class="org-keyword">if</span> (stringp template) template (funcall template)))
    (goto-char (point-min))
    (end-of-line)))
(add-hook 'git-commit-setup-hook #'+magit-fill-in-commit-template 90)
</pre>
</div>
</details>

<p>
This is particularly useful when creating commits for Org, as they need to
follow <a href="https://orgmode.org/worg/org-contribute.html#commit-messages">a certain format</a> and sometimes I forget elements (oops!).
</p>
<details id='commit-message-templates,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#commit-message-templates,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+org-commit-message-template</span> ()
  <span class="org-doc">"Create a skeleton for an Org commit message based on the staged diff."</span>
  (<span class="org-keyword">let</span> (change-data last-file file-changes temp-point)
    (<span class="org-keyword">with-temp-buffer</span>
      (apply #'call-process magit-git-executable
             nil t nil
             (append
              magit-git-global-arguments
              (list <span class="org-string">"diff"</span> <span class="org-string">"--cached"</span>)))
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^@@</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^\\+\\+\\+ b/"</span> nil t)
        (<span class="org-keyword">if</span> (looking-back <span class="org-string">"^\\+\\+\\+ b/"</span> (line-beginning-position))
            (<span class="org-keyword">progn</span>
              (<span class="org-keyword">push</span> (list last-file file-changes) change-data)
              (<span class="org-keyword">setq</span> last-file (buffer-substring-no-properties (point) (line-end-position))
                    file-changes nil))
          (<span class="org-keyword">setq</span> temp-point (line-beginning-position))
          (re-search-forward <span class="org-string">"^\\+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^-"</span> nil t)
          (end-of-line)
          (<span class="org-keyword">cond</span>
           ((string-match-p <span class="org-string">"\\.el$"</span> last-file)
            (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[+-]? *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">@@[ +-\\d,]+@@ </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">(</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">cl-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">defun</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">defvar</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">defmacro</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">defcustom</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> temp-point t)
              (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">cl-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">defun</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">defvar</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">defmacro</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">defcustom</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">[:space:]\n]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
              (<span class="org-keyword">push</span> (match-string 1) file-changes)))
           ((string-match-p <span class="org-string">"\\.org$"</span> last-file)
            (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"^[+-]\\*+ </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^@@[ +-\\d,]+@@ \\*+ "</span> temp-point t)
              (re-search-forward <span class="org-string">"@@ \\*+ "</span> nil t)
              (<span class="org-keyword">push</span> (buffer-substring-no-properties (point) (line-end-position)) file-changes)))))))
    (<span class="org-keyword">setq</span> file-changes (delete-dups file-changes))
    (<span class="org-keyword">push</span> (list last-file file-changes) change-data)
    (<span class="org-keyword">setq</span> change-data (delete '(nil nil) change-data))
    (concat
     (<span class="org-keyword">if</span> (= 1 (length change-data))
         (replace-regexp-in-string <span class="org-string">"^.*/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">.[a-z]+$"</span> <span class="org-string">""</span> (caar change-data))
       <span class="org-string">"?"</span>)
     <span class="org-string">": \n\n"</span>
     (mapconcat
      (<span class="org-keyword">lambda</span> (file-changes)
        (<span class="org-keyword">if</span> (cadr file-changes)
            (format <span class="org-string">"* %s (%s): "</span>
                    (car file-changes)
                    (mapconcat #'identity (cadr file-changes) <span class="org-string">", "</span>))
          (format <span class="org-string">"* %s: "</span> (car file-changes))))
      change-data
      <span class="org-string">"\n\n"</span>))))

(add-to-list '+magit-project-commit-templates-alist (cons <span class="org-string">"org"</span> #'+org-commit-message-template))
</pre>
</div>
</details>

<p>
This relies on two small entries in the git config files which improves the hunk
heading line selection for elisp and Org files.
</p>

<details id='commit-message-templates,code--4' class='code' open><summary><span class="lang">gitconfig</span></summary>
<div class='gutter'>
<a href='#commit-message-templates,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-gitconfig">[<span class="org-type">diff</span> <span class="org-function-name">"lisp"</span>]
  <span class="org-variable-name">xfuncname</span> = <span class="org-string">"^(((;;;+ )|\\(|([ \t]+\\(((cl-|el-patch-)?def(un|var|macro|method|custom)|gb/))).*)$"</span>

[<span class="org-type">diff</span> <span class="org-function-name">"org"</span>]
  <span class="org-variable-name">xfuncname</span> = <span class="org-string">"^(\\*+ +.*)$"</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-magit-delta" class="outline-5">
<h5 id="magit-delta"><span class="section-number-5">3.3.8.3.</span> Magit delta<a aria-hidden="true" href="#magit-delta">#</a> </h5>
<div class="outline-text-5" id="text-3-3-8-3">
<p>
<a href="https://github.com/dandavison/delta/">Delta</a> is a git diff syntax highlighter written in rust. The author also wrote a
package to hook this into the Magit diff view (which don't get any syntax
highlighting by default). This requires the <code>delta</code> binary. It's packaged on some
distributions, but most reliably installed through Rust's package manager cargo.
</p>

<details id='magit-delta,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#magit-delta,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">cargo install git-delta
</pre>
</div>
</details>

<p>
Now we can make use of the package for this.
</p>
<details id='magit-delta,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#magit-delta,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">(package! magit-delta :recipe (:host github :repo "dandavison/magit-delta") :pin "5fc7dbddcfacfe46d3fd876172ad02a9ab6ac616")</span>
</pre>
</div>
</details>

<p>
All that's left is to hook it into magit
</p>
<details id='magit-delta,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#magit-delta,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">(magit-delta-mode +1)</span>
</pre>
</div>
</details>
<p>
Unfortunately this currently seems to mess things up, which is something I'll
want to look into later.
</p>
</div>
</div>
</div>
<div id="outline-container-mpris" class="outline-4">
<h4 id="mpris"><span class="section-number-4">3.3.9.</span> <span class='acr'><span class='acr'>MPRIS</span></span><a aria-hidden="true" href="#mpris">#</a> </h4>
<div class="outline-text-4" id="text-3-3-9">
<p>
It's nice to be able to interact with <span class='acr'>MPRIS</span> players. This would just be a
dependency of <kbd>org-music</kbd> or <kbd>doom-modeline-media-player</kbd>, but I haven't made it
available on any an elisp archives. Thankfully most Emacs package managers make
using Git repository <span class='acr'>URL</span><small>s</small> pretty easy these days.
</p>

<details id='mpris,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mpris,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> mpris <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/mpris"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-smerge" class="outline-4">
<h4 id="smerge"><span class="section-number-4">3.3.10.</span> Smerge<a aria-hidden="true" href="#smerge">#</a> </h4>
<div class="outline-text-4" id="text-3-3-10">
<p>
For repeated operations, a hydra would be helpful. But I prefer transient.
</p>
<details id='smerge,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#smerge,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">smerge-repeatedly</span> ()
  <span class="org-doc">"Perform smerge actions again and again"</span>
  (<span class="org-keyword">interactive</span>)
  (smerge-mode 1)
  (smerge-transient))
(<span class="org-keyword">after!</span> transient
  (transient-define-prefix smerge-transient ()
    [[<span class="org-string">"Move"</span>
      (<span class="org-string">"n"</span> <span class="org-string">"next"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-next)) (smerge-repeatedly)))
      (<span class="org-string">"p"</span> <span class="org-string">"previous"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-prev)) (smerge-repeatedly)))]
     [<span class="org-string">"Keep"</span>
      (<span class="org-string">"b"</span> <span class="org-string">"base"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-keep-base)) (smerge-repeatedly)))
      (<span class="org-string">"u"</span> <span class="org-string">"upper"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-keep-upper)) (smerge-repeatedly)))
      (<span class="org-string">"l"</span> <span class="org-string">"lower"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-keep-lower)) (smerge-repeatedly)))
      (<span class="org-string">"a"</span> <span class="org-string">"all"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-keep-all)) (smerge-repeatedly)))
      (<span class="org-string">"RET"</span> <span class="org-string">"current"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-keep-current)) (smerge-repeatedly)))]
     [<span class="org-string">"Diff"</span>
      (<span class="org-string">"&lt;"</span> <span class="org-string">"upper/base"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-diff-base-upper)) (smerge-repeatedly)))
      (<span class="org-string">"="</span> <span class="org-string">"upper/lower"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-diff-upper-lower)) (smerge-repeatedly)))
      (<span class="org-string">"&gt;"</span> <span class="org-string">"base/lower"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-diff-base-lower)) (smerge-repeatedly)))
      (<span class="org-string">"R"</span> <span class="org-string">"refine"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-refine)) (smerge-repeatedly)))
      (<span class="org-string">"E"</span> <span class="org-string">"ediff"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-ediff)) (smerge-repeatedly)))]
     [<span class="org-string">"Other"</span>
      (<span class="org-string">"c"</span> <span class="org-string">"combine"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-combine-with-next)) (smerge-repeatedly)))
      (<span class="org-string">"r"</span> <span class="org-string">"resolve"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-resolve)) (smerge-repeatedly)))
      (<span class="org-string">"k"</span> <span class="org-string">"kill current"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">ignore-errors</span> (smerge-kill-current)) (smerge-repeatedly)))
      (<span class="org-string">"q"</span> <span class="org-string">"quit"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (smerge-auto-leave)))]]))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-corfu" class="outline-4">
<h4 id="corfu"><span class="section-number-4">3.3.11.</span> Corfu<a aria-hidden="true" href="#corfu">#</a> </h4>
<div class="outline-text-4" id="text-3-3-11">
<blockquote>
<p>
From the <kbd>:completion corfu</kbd> module.
</p>
</blockquote>

<p>
I like completion, but I don't like to feel spammed by it, so let's up the delay.
</p>

<details id='corfu,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#corfu,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> corfu-auto-delay 0.5)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-projectile" class="outline-4">
<h4 id="projectile"><span class="section-number-4">3.3.12.</span> Projectile<a aria-hidden="true" href="#projectile">#</a> </h4>
<div class="outline-text-4" id="text-3-3-12">
<blockquote>
<p>
From the <kbd>:core packages</kbd> module.
</p>
</blockquote>

<p>
Looking at documentation via <kbd>SPC h f</kbd> and <kbd>SPC h v</kbd> and looking at the source can
add package src directories to projectile. This isn't desirable in my opinion.
</p>

<details id='projectile,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#projectile,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> projectile-ignored-projects
      (list <span class="org-string">"~/"</span> <span class="org-string">"/tmp"</span> (expand-file-name <span class="org-string">"straight/repos"</span> doom-local-dir)))
(<span class="org-keyword">defun</span> <span class="org-function-name">projectile-ignored-project-function</span> (filepath)
  <span class="org-doc">"Return t if FILEPATH is within any of `</span><span class="org-doc"><span class="org-constant">projectile-ignored-projects</span></span><span class="org-doc">'"</span>
  (<span class="org-keyword">or</span> (mapcar (<span class="org-keyword">lambda</span> (p) (string-prefix-p p filepath)) projectile-ignored-projects)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-jinx" class="outline-4">
<h4 id="jinx"><span class="section-number-4">3.3.13.</span> Jinx<a aria-hidden="true" href="#jinx">#</a> </h4>
<div class="outline-text-4" id="text-3-3-13">
<p>
Minad's Jinx spell-checker looks pretty nifty. When Henrik and I (or someone
else) have some more bandwidth, I think it would be good to incorporate with
Doom.
</p>

<p>
In the meantime, let's use it here.
</p>

<details id='jinx,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#jinx,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> jinx)
</pre>
</div>
</details>
</div>
<div id="outline-container-configuration" class="outline-5">
<h5 id="configuration"><span class="section-number-5">3.3.13.1.</span> Configuration<a aria-hidden="true" href="#configuration">#</a> </h5>
<div class="outline-text-5" id="text-3-3-13-1">
<p>
Jinx has some pretty lovely defaults out of the box, we'll just be making a few
tweaks.
</p>

<details id='configuration,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#configuration,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! jinx
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:init</span>
  (add-hook 'doom-init-ui-hook #'global-jinx-mode)
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Use my custom dictionary</span>
  (<span class="org-keyword">setq</span> jinx-languages <span class="org-string">"en-custom"</span>)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Extra face(s) to ignore</span>
  (<span class="org-keyword">push</span> 'org-inline-src-block
        (alist-get 'org-mode jinx-exclude-faces))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Take over the relevant bindings.</span>
  (<span class="org-keyword">after!</span> ispell
    (global-set-key [remap ispell-word] #'jinx-correct))
  (<span class="org-keyword">after!</span> evil-commands
    (global-set-key [remap evil-next-flyspell-error] #'jinx-next)
    (global-set-key [remap evil-prev-flyspell-error] #'jinx-previous))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">I prefer for `</span><span class="org-comment"><span class="org-constant">point</span></span><span class="org-comment">' to end up at the start of the word,</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">not just after the end.</span>
  (advice-add 'jinx-next <span class="org-builtin">:after</span> (<span class="org-keyword">lambda</span> (_) (left-word))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-autocorrect" class="outline-5">
<h5 id="autocorrect"><span class="section-number-5">3.3.13.2.</span> Autocorrect<a aria-hidden="true" href="#autocorrect">#</a> </h5>
<div class="outline-text-5" id="text-3-3-13-2">
<p>
I used to have a small collection of configuration here, but then it grew
larger, and now it's a package.
</p>

<details id='autocorrect,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#autocorrect,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> autocorrect <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/autocorrect"</span>))
</pre>
</div>
</details>

<p>
To integrate Jinx with the <kbd>autocorrect</kbd> package, we need to tell it:
</p>
<ul class="org-ul">
<li>About corrections made with Jinx</li>
<li>How to tell if a word is spelled correctly with Jinx</li>
<li>When it's appropriate to make an autocorrection</li>
</ul>

<details id='autocorrect,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#autocorrect,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! autocorrect
  <span class="org-builtin">:after</span> jinx
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Integrate with Jinx</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">autocorrect-jinx-record-correction</span> (overlay corrected)
    <span class="org-doc">"Record that Jinx corrected the text in OVERLAY to CORRECTED."</span>
    (<span class="org-keyword">let</span> ((text
           (buffer-substring-no-properties
            (overlay-start overlay)
            (overlay-end overlay))))
      (autocorrect-record-correction text corrected)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">autocorrect-jinx-check-spelling</span> (word)
    <span class="org-doc">"Check if WORD is valid."</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Mostly a copy of `</span><span class="org-comment"><span class="org-constant">jinx--word-valid-p</span></span><span class="org-comment">', just without the buffer substring.</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">It would have been nice if `</span><span class="org-comment"><span class="org-constant">jinx--word-valid-p</span></span><span class="org-comment">' implemented like this</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">with `</span><span class="org-comment"><span class="org-constant">jinx--this-word-valid-p</span></span><span class="org-comment">' (or similar) as the at-point variant.</span>
    (<span class="org-keyword">or</span> (member word jinx--session-words)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Allow capitalized words</span>
        (<span class="org-keyword">and</span> (string-match-p <span class="org-string">"\\`[[:upper:]][[:lower:]]+\\'"</span> word)
             (<span class="org-keyword">cl-loop</span>
              for w in jinx--session-words
              thereis (<span class="org-keyword">and</span> (string-equal-ignore-case word w)
                           (string-match-p <span class="org-string">"\\`[[:lower:]]+\\'"</span> w))))
        (<span class="org-keyword">cl-loop</span> for dict in jinx--dicts
                 thereis (jinx--mod-check dict word))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">autocorrect-jinx-appropriate</span> (pos)
    <span class="org-doc">"Return non-nil if it is appropriate to spellcheck at POS according to jinx."</span>
    (<span class="org-keyword">and</span> (not (jinx--face-ignored-p pos))
         (not (jinx--regexp-ignored-p pos))))

  (<span class="org-keyword">setq</span> autocorrect-check-spelling-function #'autocorrect-jinx-check-spelling)
  (add-to-list 'autocorrect-predicates #'autocorrect-jinx-appropriate)
  (advice-add 'jinx--correct-replace <span class="org-builtin">:before</span> #'autocorrect-jinx-record-correction)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Run setup</span>
  (run-with-idle-timer 0.5 nil #'autocorrect-setup)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Make work with evil-mode</span>
  (evil-collection-set-readonly-bindings 'autocorrect-list-mode-map)
  (evil-collection-define-key 'normal 'autocorrect-list-mode-map
    (kbd <span class="org-string">"a"</span>) #'autocorrect-create-correction
    (kbd <span class="org-string">"x"</span>) #'autocorrect-remove-correction
    (kbd <span class="org-string">"i"</span>) #'autocorrect-ignore-word))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-downloading-dictionaries" class="outline-5">
<h5 id="downloading-dictionaries"><span class="section-number-5">3.3.13.3.</span> Downloading dictionaries<a aria-hidden="true" href="#downloading-dictionaries">#</a> </h5>
<div class="outline-text-5" id="text-3-3-13-3">
<p>
Let's get a nice big dictionary from <a href="http://app.aspell.net/create"><span class='acr'>SCOWL</span> Custom List/Dictionary Creator</a> with
the following configuration
</p>
<dl class="org-dl">
<dt>size</dt><dd>80 (huge)</dd>
<dt>spellings</dt><dd>British(-ise) and Australian</dd>
<dt>spelling variants level</dt><dd>0</dd>
<dt>diacritics</dt><dd>keep</dd>
<dt>extra lists</dt><dd>hacker, roman numerals</dd>
</dl>
</div>
<div id="outline-container-hunspell" class="outline-6">
<h6 id="hunspell"><span class="section-number-6">3.3.13.3.1.</span> Hunspell<a aria-hidden="true" href="#hunspell">#</a> </h6>
<div class="outline-text-6" id="text-3-3-13-3-1">
<details id='hunspell,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#hunspell,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">cd</span> /tmp
<span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> -d hunspell-en-custom ]; <span class="org-keyword">then</span>
    curl -o <span class="org-string">"hunspell-en-custom.zip"</span> <span class="org-string">'http://app.aspell.net/create?max_size=80&amp;spelling=GBs&amp;spelling=AU&amp;max_variant=0&amp;diacritic=keep&amp;special=hacker&amp;special=roman-numerals&amp;encoding=utf-8&amp;format=inline&amp;download=hunspell'</span>
    unzip <span class="org-string">"hunspell-en-custom.zip"</span> -d hunspell-en-custom
<span class="org-keyword">fi</span>

<span class="org-builtin">cd</span> hunspell-en-custom
<span class="org-variable-name">DESTDIR1</span>=<span class="org-string">"$HOME/.local/share/hunspell"</span>
<span class="org-variable-name">DESTDIR2</span>=<span class="org-string">"$HOME/.config/enchant/hunspell"</span>
mkdir -p <span class="org-string">"$DESTDIR1"</span>
mkdir -p <span class="org-string">"$DESTDIR2"</span>
cp en-custom.{aff,dic} <span class="org-string">"$DESTDIR1"</span>
cp en-custom.{aff,dic} <span class="org-string">"$DESTDIR2"</span>
</pre>
</div>
</details>

<p>
We will also add an accompanying <kbd>doctor</kbd> warning.
</p>

<details id='hunspell,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#hunspell,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"hunspell"</span>)
  (warn! <span class="org-string">"Couldn't find hunspell executable."</span>))
(<span class="org-keyword">unless</span> (file-exists-p <span class="org-string">"~/.local/share/hunspell/en-custom.dic"</span>)
  (warn! <span class="org-string">"Custom hunspell dictionary is not present."</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-aspell" class="outline-6">
<h6 id="aspell"><span class="section-number-6">3.3.13.3.2.</span> Aspell<a aria-hidden="true" href="#aspell">#</a> </h6>
<div class="outline-text-6" id="text-3-3-13-3-2">
<details id='aspell,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#aspell,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">cd</span> /tmp
<span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> -d aspell6-en-custom ]; <span class="org-keyword">then</span>
    curl -o <span class="org-string">"aspell6-en-custom.tar.bz2"</span> <span class="org-string">'http://app.aspell.net/create?max_size=80&amp;spelling=GBs&amp;spelling=AU&amp;max_variant=0&amp;diacritic=keep&amp;special=hacker&amp;special=roman-numerals&amp;encoding=utf-8&amp;format=inline&amp;download=aspell'</span>
    tar -xjf <span class="org-string">"aspell6-en-custom.tar.bz2"</span>
<span class="org-keyword">fi</span>

<span class="org-builtin">cd</span> aspell6-en-custom
<span class="org-variable-name">DESTDIR</span>=<span class="org-string">"$HOME/.config/enchant/"</span> ./configure
sed -i <span class="org-string">'s/dictdir = .*/dictdir = "aspell"/'</span> Makefile
sed -i <span class="org-string">'s/datadir = .*/datadir = "aspell"/'</span> Makefile
make &amp;&amp; make install
</pre>
</div>
</details>

<p>
We will also add an accompanying <kbd>doctor</kbd> warning.
</p>

<details id='aspell,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#aspell,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"aspell"</span>)
  (warn! <span class="org-string">"Couldn't find aspell executable."</span>))
(<span class="org-keyword">unless</span> (file-exists-p <span class="org-string">"~/.config/enchant/aspell/en-custom.multi"</span>)
  (warn! <span class="org-string">"Custom aspell dictionary is not present."</span>))
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
<div id="outline-container-tramp" class="outline-4">
<h4 id="tramp"><span class="section-number-4">3.3.14.</span> <span class='acr'><span class='acr'>TRAMP</span></span><a aria-hidden="true" href="#tramp">#</a> </h4>
<div class="outline-text-4" id="text-3-3-14">
<p>
Another lovely Emacs feature, <span class='acr'>TRAMP</span> stands for <i>Transparent Remote Access,
Multiple Protocol</i>. In brief, it's a lovely way to wander around outside your
local filesystem.
</p>
</div>
<div id="outline-container-prompt-recognition" class="outline-5">
<h5 id="prompt-recognition"><span class="section-number-5">3.3.14.1.</span> Prompt recognition<a aria-hidden="true" href="#prompt-recognition">#</a> </h5>
<div class="outline-text-5" id="text-3-3-14-1">
<p>
Unfortunately, when connecting to remote machines Tramp can be a wee pit picky
with the prompt format. Let's try to get Bash, and be a bit more permissive with
prompt recognition.
</p>

<details id='prompt-recognition,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prompt-recognition,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> tramp
  (setenv <span class="org-string">"SHELL"</span> <span class="org-string">"/bin/bash"</span>)
  (<span class="org-keyword">setq</span> tramp-shell-prompt-pattern <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\n</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\x0d</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]#$%&gt;\n]*#?[]#$%&gt;&#57520;] *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\e\\[[0-9;]*[a-zA-Z] *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>)) <span class="org-comment-delimiter">;; </span><span class="org-comment">default + &#57520;</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-troubleshooting" class="outline-5">
<h5 id="troubleshooting"><span class="section-number-5">3.3.14.2.</span> Troubleshooting<a aria-hidden="true" href="#troubleshooting">#</a> </h5>
<div class="outline-text-5" id="text-3-3-14-2">
<p>
In case the remote shell is misbehaving, here are some things to try
</p>
</div>
<div id="outline-container-zsh" class="outline-6">
<h6 id="zsh"><span class="section-number-6">3.3.14.2.1.</span> Zsh<a aria-hidden="true" href="#zsh">#</a> </h6>
<div class="outline-text-6" id="text-3-3-14-2-1">
<p>
There are some escape code you don't want, let's make it behave more considerately.
</p>
<details id='zsh,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#zsh,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-keyword">if</span> [[ <span class="org-string">"$TERM"</span> == <span class="org-string">"dumb"</span> ]]; <span class="org-keyword">then</span>
    <span class="org-builtin">unset</span> zle_bracketed_paste
    <span class="org-builtin">unset</span> zle
    <span class="org-variable-name">PS1</span>=<span class="org-string">'$ '</span>
    <span class="org-keyword">return</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-guix" class="outline-5">
<h5 id="guix"><span class="section-number-5">3.3.14.3.</span> Guix<a aria-hidden="true" href="#guix">#</a> </h5>
<div class="outline-text-5" id="text-3-3-14-3">
<p>
<a href="https://guix.gnu.org/">Guix</a> puts some binaries that <span class='acr'>TRAMP</span> looks for in unexpected locations.
That's no problem though, we just need to help <span class='acr'>TRAMP</span> find them.
</p>

<details id='guix,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#guix,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> tramp
  (<span class="org-keyword">appendq!</span> tramp-remote-path
            '(<span class="org-string">"~/.guix-profile/bin"</span> <span class="org-string">"~/.guix-profile/sbin"</span>
              <span class="org-string">"/run/current-system/profile/bin"</span>
              <span class="org-string">"/run/current-system/profile/sbin"</span>)))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-auto-activating-snippets" class="outline-4">
<h4 id="auto-activating-snippets"><span class="section-number-4">3.3.15.</span> Auto activating snippets<a aria-hidden="true" href="#auto-activating-snippets">#</a> </h4>
<div class="outline-text-4" id="text-3-3-15">
<p>
Sometimes pressing <kbd>TAB</kbd> is just too much.
</p>
<details id='auto-activating-snippets,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#auto-activating-snippets,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> aas <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"ymarco/auto-activating-snippets"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"ddc2b7a58a2234477006af348b30e970f73bc2c1"</span>)
</pre>
</div>
</details>

<details id='auto-activating-snippets,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#auto-activating-snippets,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! aas
  <span class="org-builtin">:commands</span> aas-mode)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-screenshot" class="outline-4">
<h4 id="screenshot"><span class="section-number-4">3.3.16.</span> Screenshot<a aria-hidden="true" href="#screenshot">#</a> </h4>
<div class="outline-text-4" id="text-3-3-16">
<p>
This makes it a breeze to take lovely screenshots.
</p>

<details id='screenshot,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#screenshot,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> screenshot <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/screenshot"</span>))
</pre>
</div>
</details>


<figure id="org4871de6">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/screenshot.png" alt="Example screenshot.el screenshot" class="invertible">

</figure>

<p>
Some light configuring is all we need, so we can make use of the <a href="https://github.com/Calinou/0x0">0x0</a> wrapper
file uploading script (which I've renamed to <code>upload</code>).
</p>

<details id='screenshot,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#screenshot,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! screenshot
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq</span> screenshot-upload-fn <span class="org-string">"upload %s 2&gt;/dev/null"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-etrace" class="outline-4">
<h4 id="etrace"><span class="section-number-4">3.3.17.</span> Etrace<a aria-hidden="true" href="#etrace">#</a> </h4>
<div class="outline-text-4" id="text-3-3-17">
<p>
The <i>Emacs Lisp Profiler</i> (<span class='acr'>ELP</span>) does a nice job recording information, but it
isn't the best for looking at results. <kbd>etrace</kbd> converts <span class='acr'>ELP</span>'s results to the
"Chromium Catapult Trace Event Format". This means that the output of <kbd>etrace</kbd> can
be loaded in something like the <a href="https://www.speedscope.app/">speedscope</a> webapp for easier profile
investigation.
</p>

<details id='etrace,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#etrace,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> etrace <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"aspiers/etrace"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"2291ccf2f2ccc80a6aac4664e8ede736ceb672b7"</span>)
</pre>
</div>
</details>

<details id='etrace,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#etrace,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! etrace
  <span class="org-builtin">:after</span> elp)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-yasnippet" class="outline-4">
<h4 id="yasnippet"><span class="section-number-4">3.3.18.</span> YASnippet<a aria-hidden="true" href="#yasnippet">#</a> </h4>
<div class="outline-text-4" id="text-3-3-18">
<blockquote>
<p>
From the <kbd>:editor snippets</kbd> module.
</p>
</blockquote>

<p>
Nested snippets are good, so let's enable that.
</p>
<details id='yasnippet,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#yasnippet,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> yas-triggers-in-field t)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-string-inflection" class="outline-4">
<h4 id="string-inflection"><span class="section-number-4">3.3.19.</span> String inflection<a aria-hidden="true" href="#string-inflection">#</a> </h4>
<div class="outline-text-4" id="text-3-3-19">
<p>
For when you want to change the case pattern for a symbol.
</p>
<details id='string-inflection,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#string-inflection,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> string-inflection <span class="org-builtin">:pin</span> <span class="org-string">"617df25e91351feffe6aff4d9e4724733449d608"</span>)
</pre>
</div>
</details>

<details id='string-inflection,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#string-inflection,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! string-inflection
  <span class="org-builtin">:commands</span> (string-inflection-all-cycle
             string-inflection-toggle
             string-inflection-camelcase
             string-inflection-lower-camelcase
             string-inflection-kebab-case
             string-inflection-underscore
             string-inflection-capital-underscore
             string-inflection-upcase)
  <span class="org-builtin">:init</span>
  (map! <span class="org-builtin">:leader</span> <span class="org-builtin">:prefix</span> (<span class="org-string">"c~"</span> . <span class="org-string">"naming convention"</span>)
        <span class="org-builtin">:desc</span> <span class="org-string">"cycle"</span> <span class="org-string">"~"</span> #'string-inflection-all-cycle
        <span class="org-builtin">:desc</span> <span class="org-string">"toggle"</span> <span class="org-string">"t"</span> #'string-inflection-toggle
        <span class="org-builtin">:desc</span> <span class="org-string">"CamelCase"</span> <span class="org-string">"c"</span> #'string-inflection-camelcase
        <span class="org-builtin">:desc</span> <span class="org-string">"downCase"</span> <span class="org-string">"d"</span> #'string-inflection-lower-camelcase
        <span class="org-builtin">:desc</span> <span class="org-string">"kebab-case"</span> <span class="org-string">"k"</span> #'string-inflection-kebab-case
        <span class="org-builtin">:desc</span> <span class="org-string">"under_score"</span> <span class="org-string">"_"</span> #'string-inflection-underscore
        <span class="org-builtin">:desc</span> <span class="org-string">"Upper_Score"</span> <span class="org-string">"u"</span> #'string-inflection-capital-underscore
        <span class="org-builtin">:desc</span> <span class="org-string">"UP_CASE"</span> <span class="org-string">"U"</span> #'string-inflection-upcase)
  (<span class="org-keyword">after!</span> evil
    (evil-define-operator evil-operator-string-inflection (beg end _type)
      <span class="org-string">"Define a new evil operator that cycles symbol casing."</span>
      <span class="org-builtin">:move-point</span> nil
      (<span class="org-keyword">interactive</span> <span class="org-string">"&lt;R&gt;"</span>)
      (string-inflection-all-cycle)
      (<span class="org-keyword">setq</span> evil-repeat-info '([?g ?~])))
    (define-key evil-normal-state-map (kbd <span class="org-string">"g~"</span>) 'evil-operator-string-inflection)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-smart-parentheses" class="outline-4">
<h4 id="smart-parentheses"><span class="section-number-4">3.3.20.</span> Smart parentheses<a aria-hidden="true" href="#smart-parentheses">#</a> </h4>
<div class="outline-text-4" id="text-3-3-20">
<blockquote>
<p>
From the <kbd>:core packages</kbd> module.
</p>
</blockquote>

<details id='smart-parentheses,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#smart-parentheses,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(sp-local-pair
 '(org-mode)
 <span class="org-string">"&lt;&lt;"</span> <span class="org-string">"&gt;&gt;"</span>
 <span class="org-builtin">:actions</span> '(insert))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-visuals" class="outline-3">
<h3 id="visuals"><span class="section-number-3">3.4.</span> Visuals<a aria-hidden="true" href="#visuals">#</a> </h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-info-colours" class="outline-4">
<h4 id="info-colours"><span class="section-number-4">3.4.1.</span> Info colours<a aria-hidden="true" href="#info-colours">#</a> </h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
This makes manual pages nicer to look at by adding variable pitch fontification
and colouring 🙂.
</p>


<figure id="orgda04d38">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/info-colours.png" alt="Example info-colours page." class="invertible" style="width:80%">

</figure>

<details id='info-colours,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#info-colours,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> info-colors <span class="org-builtin">:pin</span> <span class="org-string">"2e237c301ba62f0e0286a27c1abe48c4c8441143"</span>)
</pre>
</div>
</details>

<p>
To use this we'll just hook it into <kbd>Info</kbd>.
</p>

<details id='info-colours,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#info-colours,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! info-colors
  <span class="org-builtin">:commands</span> (info-colors-fontify-node))

(add-hook 'Info-selection-hook 'info-colors-fontify-node)
</pre>
</div>
</details>


<figure id="org887126d">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/info-coloured.png" alt="Example colourised info page" class="invertible">

</figure>
</div>
</div>
<div id="outline-container-modus-themes" class="outline-4">
<h4 id="modus-themes"><span class="section-number-4">3.4.2.</span> Modus themes<a aria-hidden="true" href="#modus-themes">#</a> </h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
Proteolas did a lovely job with the Modus themes, so much so that they were
welcomed into Emacs 28. However, he is also rather attentive with updates, and
so I'd like to make sure we have a recent version.
</p>

<details id='modus-themes,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#modus-themes,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> modus-themes <span class="org-builtin">:pin</span> <span class="org-string">"f3cd4d6983566dab0ef3bcddf812cfd565d00d08"</span> <span class="org-builtin">:pin</span> <span class="org-string">"3576d14f06f245c3111496bfb035bb0926f48089"</span>)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-spacemacs-themes" class="outline-4">
<h4 id="spacemacs-themes"><span class="section-number-4">3.4.3.</span> Spacemacs themes<a aria-hidden="true" href="#spacemacs-themes">#</a> </h4>
<div class="outline-text-4" id="text-3-4-3">
<details id='spacemacs-themes,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#spacemacs-themes,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> spacemacs-theme <span class="org-builtin">:pin</span> <span class="org-string">"a7c5dccb4a037ba1f090015fc8ffb9566c64e369"</span>)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-theme-magic" class="outline-4">
<h4 id="theme-magic"><span class="section-number-4">3.4.4.</span> Theme magic<a aria-hidden="true" href="#theme-magic">#</a> </h4>
<div class="outline-text-4" id="text-3-4-4">
<p>
With all our fancy Emacs themes, my terminal is missing out!
</p>
<details id='theme-magic,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#theme-magic,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> theme-magic <span class="org-builtin">:pin</span> <span class="org-string">"844c4311bd26ebafd4b6a1d72ddcc65d87f074e3"</span>)
</pre>
</div>
</details>

<p>
This operates using <kbd>pywal</kbd>, which is present in some repositories, but most
reliably installed with <kbd>pip</kbd>.
</p>

<details id='theme-magic,code--2' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#theme-magic,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">sudo python3 -m pip install pywal
</pre>
</div>
</details>

<p>
We can also add a <kbd>doctor</kbd> check.
</p>

<details id='theme-magic,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#theme-magic,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"wal"</span>)
  (warn! <span class="org-string">"Couldn't find the pywal executable (wal), theme-magic will not function."</span>))
</pre>
</div>
</details>

<p>
Theme magic takes a look at a number of faces, the saturation levels, and colour
differences to try to cleverly pick eight colours to use. However, it uses the
same colours for the light variants, and doesn't always make the best picks.
Since we're using <kbd>doom-themes</kbd>, our life is a little easier and we can use the
colour utilities from Doom themes to easily grab sensible colours and generate
lightened versions &#x2014; let's do that.
</p>

<details id='theme-magic,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#theme-magic,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! theme-magic
  <span class="org-builtin">:commands</span> theme-magic-from-emacs
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defadvice!</span> theme-magic--auto-extract-16-doom-colors ()
    <span class="org-builtin">:override</span> #'theme-magic--auto-extract-16-colors
    (list
     (face-attribute 'default <span class="org-builtin">:background</span>)
     (doom-color 'error)
     (doom-color 'success)
     (doom-color 'type)
     (doom-color 'keywords)
     (doom-color 'constants)
     (doom-color 'functions)
     (face-attribute 'default <span class="org-builtin">:foreground</span>)
     (face-attribute 'shadow <span class="org-builtin">:foreground</span>)
     (doom-blend 'base8 'error 0.1)
     (doom-blend 'base8 'success 0.1)
     (doom-blend 'base8 'type 0.1)
     (doom-blend 'base8 'keywords 0.1)
     (doom-blend 'base8 'constants 0.1)
     (doom-blend 'base8 'functions 0.1)
     (face-attribute 'default <span class="org-builtin">:foreground</span>))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-simple-comment-markup" class="outline-4">
<h4 id="simple-comment-markup"><span class="section-number-4">3.4.5.</span> Simple comment markup<a aria-hidden="true" href="#simple-comment-markup">#</a> </h4>
<div class="outline-text-4" id="text-3-4-5">
<p>
I find that every now and then I sprinkle a little markup in code comments. Of
course, this doesn't get fortified as it's ultimately meaningless &#x2026; but it
would be nice if it was, just slightly. Surprisingly, I couldn't find a package
for this, so I made one.
</p>

<details id='simple-comment-markup,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#simple-comment-markup,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> simple-comment-markup <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/simple-comment-markup"</span>))
</pre>
</div>
</details>

<p>
Let's use both basic Org markup and Markdown code backticks, to cover most
situations decently.
</p>

<details id='simple-comment-markup,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#simple-comment-markup,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! simple-comment-markup
  <span class="org-builtin">:hook</span> (prog-mode . simple-comment-markup-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> simple-comment-markup-set '(org markdown-code)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-doom-modeline" class="outline-4">
<h4 id="doom-modeline"><span class="section-number-4">3.4.6.</span> Doom modeline<a aria-hidden="true" href="#doom-modeline">#</a> </h4>
<div class="outline-text-4" id="text-3-4-6">
<blockquote>
<p>
From the <kbd>:ui modeline</kbd> module.
</p>
</blockquote>
</div>
<div id="outline-container-modified-buffer-colour" class="outline-5">
<h5 id="modified-buffer-colour"><span class="section-number-5">3.4.6.1.</span> Modified buffer colour<a aria-hidden="true" href="#modified-buffer-colour">#</a> </h5>
<div class="outline-text-5" id="text-3-4-6-1">
<p>
The modeline is very nice and pretty, however I have a few niggles with the
defaults. For starters, by default <code>red</code> text is used to indicate an unsaved file.
This makes me feel like something's gone <i>wrong</i>, so let's tone that down to
orange.
</p>

<details id='modified-buffer-colour,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#modified-buffer-colour,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(custom-set-faces!
  '(doom-modeline-buffer-modified <span class="org-builtin">:foreground</span> <span class="org-string">"orange"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-height" class="outline-5">
<h5 id="height"><span class="section-number-5">3.4.6.2.</span> Height<a aria-hidden="true" href="#height">#</a> </h5>
<div class="outline-text-5" id="text-3-4-6-2">
<p>
The default size (<kbd>25</kbd>) makes for a rather narrow mode line. To me, the modeline
feels a bit comfier if we give it a bit more space. I find <kbd>45</kbd> adds roughly a
third of the line height as padding above and below.
</p>

<details id='height,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#height,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> doom-modeline-height 45)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-file-encoding" class="outline-5">
<h5 id="file-encoding"><span class="section-number-5">3.4.6.3.</span> File encoding<a aria-hidden="true" href="#file-encoding">#</a> </h5>
<div class="outline-text-5" id="text-3-4-6-3">
<p>
While we're modifying the modeline, when we have the default file encoding (<kbd>LF
UTF-8</kbd>), it really isn't worth noting in the modeline. So, why not conditionally
hide it?
</p>

<details id='file-encoding,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#file-encoding,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">doom-modeline-conditional-buffer-encoding</span> ()
  <span class="org-doc">"We expect the encoding to be LF UTF-8, so only show the modeline when this is not the case"</span>
  (<span class="org-keyword">setq-local</span> doom-modeline-buffer-encoding
              (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> (memq (plist-get (coding-system-plist buffer-file-coding-system) <span class="org-builtin">:category</span>)
                                 '(coding-category-undecided coding-category-utf-8))
                           (not (memq (coding-system-eol-type buffer-file-coding-system) '(1 2))))
                t)))

(add-hook 'after-change-major-mode-hook #'doom-modeline-conditional-buffer-encoding)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-analogue-clock" class="outline-5">
<h5 id="analogue-clock"><span class="section-number-5">3.4.6.4.</span> Analogue clock<a aria-hidden="true" href="#analogue-clock">#</a> </h5>
<div class="outline-text-5" id="text-3-4-6-4">
<p>
Now that my code for an analogue clock icon has been upstreamed, all I do here
is adjust the size slightly 🙂.
</p>

<details id='analogue-clock,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#analogue-clock,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> doom-modeline-time-clock-size 0.65)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-media-player" class="outline-5">
<h5 id="media-player"><span class="section-number-5">3.4.6.5.</span> Media player<a aria-hidden="true" href="#media-player">#</a> </h5>
<div class="outline-text-5" id="text-3-4-6-5">
<p>
Sometimes (particularly when reading a novel, with Emacs full-screened) it would
be nice to know what I'm listening to. We can put this information in the
modeline with my media player package.
</p>

<details id='media-player,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#media-player,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> doom-modeline-media-player
  <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/doom-modeline-media-player"</span>))
</pre>
</div>
</details>

<p>
To enable the lazy loading, we make <kbd>doom-modeline</kbd> aware of the segment function
in <code>:init</code>, and the segment function itself is autoloaded.
</p>

<details id='media-player,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#media-player,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! doom-modeline-media-player
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">after!</span> doom-modeline
    (add-to-list 'doom-modeline-fn-alist
                 (cons 'media-player #'doom-modeline-segment--media-player)))
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">+single-fullscreen-window-p</span> ()
    (<span class="org-keyword">and</span> (memq (frame-parameter nil 'fullscreen) '(fullscreen fullboth))
         (not (consp (car (window-tree))))))
  (<span class="org-keyword">setq</span> doom-modeline-media-player #'+single-fullscreen-window-p
        doom-modeline-media-player-playback-indication 'dim))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-pdf-modeline" class="outline-5">
<h5 id="pdf-modeline"><span class="section-number-5">3.4.6.6.</span> <span class='acr'><span class='acr'>PDF</span></span> modeline<a aria-hidden="true" href="#pdf-modeline">#</a> </h5>
<div class="outline-text-5" id="text-3-4-6-6">
<p>
I think the <span class='acr'>PDF</span> modeline could do with tweaking. I raised <a href="https://github.com/seagle0128/doom-modeline/pull/425">an issue</a> on this,
however the response was basically "put your preferences in your personal
config, the current default is sensible" &#x2014; so here we are.
</p>

<p>
First up I'm going to want a segment for just the buffer file name, and a <span class='acr'>PDF</span>
icon. Then we'll redefine two functions used to generate the modeline.
</p>

<details id='pdf-modeline,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#pdf-modeline,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(doom-modeline-def-segment buffer-name
  <span class="org-string">"Display the current buffer's name, without any other information."</span>
  (concat
   (doom-modeline-spc)
   (doom-modeline--buffer-name)))

(doom-modeline-def-segment pdf-icon
  <span class="org-string">"PDF icon from nerd-icons."</span>
  (concat
   (doom-modeline-icon sucicon <span class="org-string">"nf-seti-pdf"</span> nil nil
   (doom-modeline-spc)
                       <span class="org-builtin">:face</span> (<span class="org-keyword">if</span> (doom-modeline--active)
                                 'nerd-icons-red
                               'mode-line-inactive)
                       <span class="org-builtin">:v-adjust</span> 0.02)))

(<span class="org-keyword">defun</span> <span class="org-function-name">doom-modeline-update-pdf-pages</span> ()
  <span class="org-doc">"Update PDF pages."</span>
  (<span class="org-keyword">setq</span> doom-modeline--pdf-pages
        (<span class="org-keyword">let</span> ((current-page-str (number-to-string (eval `(pdf-view-current-page))))
              (total-page-str (number-to-string (pdf-cache-number-of-pages))))
          (concat
           (propertize
            (concat (make-string (- (length total-page-str) (length current-page-str)) ? )
                    <span class="org-string">" P"</span> current-page-str)
            'face 'mode-line)
           (propertize (concat <span class="org-string">"/"</span> total-page-str) 'face 'doom-modeline-buffer-minor-mode)))))

(doom-modeline-def-segment pdf-pages
  <span class="org-string">"Display PDF pages."</span>
  (<span class="org-keyword">if</span> (doom-modeline--active) doom-modeline--pdf-pages
    (propertize doom-modeline--pdf-pages 'face 'mode-line-inactive)))

(doom-modeline-def-modeline 'pdf
  '(bar window-number pdf-pages pdf-icon buffer-name)
  '(media-player misc-info matches major-mode process vcs))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-keycast" class="outline-4">
<h4 id="keycast"><span class="section-number-4">3.4.7.</span> Keycast<a aria-hidden="true" href="#keycast">#</a> </h4>
<div class="outline-text-4" id="text-3-4-7">
<p>
For some reason, I find myself demoing Emacs every now and then. Showing what
keyboard stuff I'm doing on-screen seems helpful. While <a href="https://gitlab.com/screenkey/screenkey">screenkey</a> does exist,
having something that doesn't cover up screen content is nice.
</p>


<figure id="org7cff090">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/keycast.png" alt="Screenshot of Keycast-mode in action" class="invertible">

</figure>

<details id='keycast,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#keycast,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> keycast <span class="org-builtin">:pin</span> <span class="org-string">"53514c3dc3dfb7d4c3a65898b0b3edb69b6536c2"</span>)
</pre>
</div>
</details>

<p>
Let's just make sure this is lazy-loaded appropriately.
</p>
<details id='keycast,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#keycast,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! keycast
  <span class="org-builtin">:commands</span> keycast-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">keycast-mode</span>
    <span class="org-doc">"Show current command and its key binding in the mode line."</span>
    <span class="org-builtin">:global</span> t
    (<span class="org-keyword">if</span> keycast-mode
        (<span class="org-keyword">progn</span>
          (add-hook 'pre-command-hook 'keycast--update t)
          (add-to-list 'global-mode-string '(<span class="org-string">""</span> mode-line-keycast <span class="org-string">" "</span>)))
      (remove-hook 'pre-command-hook 'keycast--update)
      (<span class="org-keyword">setq</span> global-mode-string (remove '(<span class="org-string">""</span> mode-line-keycast <span class="org-string">" "</span>) global-mode-string))))
  (custom-set-faces!
    '(keycast-command <span class="org-builtin">:inherit</span> doom-modeline-debug
                      <span class="org-builtin">:height</span> 0.9)
    '(keycast-key <span class="org-builtin">:inherit</span> custom-modified
                  <span class="org-builtin">:height</span> 1.1
                  <span class="org-builtin">:weight</span> bold)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-screencast" class="outline-4">
<h4 id="screencast"><span class="section-number-4">3.4.8.</span> Screencast<a aria-hidden="true" href="#screencast">#</a> </h4>
<div class="outline-text-4" id="text-3-4-8">
<p>
In a similar manner to <a href="#keycast">3.4.7</a>, <a href="https://gitlab.com/ambrevar/emacs-gif-screencast">gif-screencast</a> may come in handy.
</p>
<details id='screencast,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#screencast,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> gif-screencast <span class="org-builtin">:pin</span> <span class="org-string">"6798656d3d3107d16e30cc26bc3928b00e50c1ca"</span>)
</pre>
</div>
</details>

<p>
We can lazy load this using the start/stop commands.
</p>

<p>
I initially installed <code>scrot</code> for this, since it was the default capture program.
However it raised <code>glib error: Saving to file ... failed</code> each time it was run.
Google didn't reveal any easy fixed, so I switched to <a href="https://github.com/naelstrof/maim">maim</a>. We now need to pass
it the window <span class='acr'>ID</span>. This doesn't change throughout the lifetime of an Emacs
instance, so as long as a single window is used <code>xdotool getactivewindow</code> will
give a satisfactory result.
</p>

<p>
It seems that when new colours appear, that tends to make <code>gifsicle</code> introduce
artefacts. To avoid this we pre-populate the colour map using the current doom
theme.
</p>

<details id='screencast,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#screencast,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! gif-screencast
  <span class="org-builtin">:commands</span> gif-screencast-mode
  <span class="org-builtin">:config</span>
  (map! <span class="org-builtin">:map</span> gif-screencast-mode-map
        <span class="org-builtin">:g</span> <span class="org-string">"&lt;f8&gt;"</span> #'gif-screencast-toggle-pause
        <span class="org-builtin">:g</span> <span class="org-string">"&lt;f9&gt;"</span> #'gif-screencast-stop)
  (<span class="org-keyword">setq</span> gif-screencast-program <span class="org-string">"maim"</span>
        gif-screencast-args `(<span class="org-string">"--quality"</span> <span class="org-string">"3"</span> <span class="org-string">"-i"</span> ,(string-trim-right
                                                     (shell-command-to-string
                                                      <span class="org-string">"xdotool getactivewindow"</span>)))
        gif-screencast-optimize-args '(<span class="org-string">"--batch"</span> <span class="org-string">"--optimize=3"</span> <span class="org-string">"--usecolormap=/tmp/doom-color-theme"</span>))
  (<span class="org-keyword">defun</span> <span class="org-function-name">gif-screencast-write-colormap</span> ()
    (write-region
     (replace-regexp-in-string
      <span class="org-string">"\n+"</span> <span class="org-string">"\n"</span>
      (mapconcat (<span class="org-keyword">lambda</span> (c) (<span class="org-keyword">if</span> (listp (cdr c))
                            (cadr c))) <span class="org-warning">doom-themes--colors </span><span class="org-string"><span class="org-warning">"\n"</span></span><span class="org-warning">))</span>
     nil <span class="org-string">"/tmp/doom-color-theme"</span>))
  (gif-screencast-write-colormap)
  (add-hook 'doom-load-theme-hook #'gif-screencast-write-colormap))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-mixed-pitch" class="outline-4">
<h4 id="mixed-pitch"><span class="section-number-4">3.4.9.</span> Mixed pitch<a aria-hidden="true" href="#mixed-pitch">#</a> </h4>
<div class="outline-text-4" id="text-3-4-9">
<blockquote>
<p>
From the <kbd>:ui zen</kbd> module.
</p>
</blockquote>

<p>
We'd like to use mixed pitch in certain modes. If we simply add a hook, when
directly opening a file with (a new) Emacs <kbd>mixed-pitch-mode</kbd> runs before <span class='acr'>UI</span>
initialisation, which is problematic. To resolve this, we create a hook that
runs after <span class='acr'>UI</span> initialisation and both
</p>
<ul class="org-ul">
<li>conditionally enables <kbd>mixed-pitch-mode</kbd></li>
<li>sets up the mixed pitch hooks</li>
</ul>

<details id='mixed-pitch,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mixed-pitch,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">mixed-pitch-modes</span> '(org-mode LaTeX-mode markdown-mode gfm-mode Info-mode)
  <span class="org-doc">"Modes that `</span><span class="org-doc"><span class="org-constant">mixed-pitch-mode</span></span><span class="org-doc">' should be enabled in, but only after UI initialisation."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">init-mixed-pitch-h</span> ()
  <span class="org-doc">"Hook `</span><span class="org-doc"><span class="org-constant">mixed-pitch-mode</span></span><span class="org-doc">' into each mode in `</span><span class="org-doc"><span class="org-constant">mixed-pitch-modes</span></span><span class="org-doc">'.</span>
<span class="org-doc">Also immediately enables `</span><span class="org-doc"><span class="org-constant">mixed-pitch-modes</span></span><span class="org-doc">' if currently in one of the modes."</span>
  (<span class="org-keyword">when</span> (memq major-mode mixed-pitch-modes)
    (mixed-pitch-mode 1))
  (<span class="org-keyword">dolist</span> (hook mixed-pitch-modes)
    (add-hook (intern (concat (symbol-name hook) <span class="org-string">"-hook"</span>)) #'mixed-pitch-mode)))
(add-hook 'doom-init-ui-hook #'init-mixed-pitch-h)
</pre>
</div>
</details>

<p>
As mixed pitch uses the variable <kbd>mixed-pitch-face</kbd>, we can create a new function
to apply mixed pitch with a serif face instead of the default (see the
subsequent face definition). This was created for writeroom mode.
</p>

<details id='mixed-pitch,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mixed-pitch,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(autoload #'mixed-pitch-serif-mode <span class="org-string">"mixed-pitch"</span>
  <span class="org-doc">"Change the default face of the current buffer to a serifed variable pitch, while keeping some faces fixed pitch."</span> t)

(<span class="org-keyword">setq!</span> variable-pitch-serif-font (font-spec <span class="org-builtin">:family</span> <span class="org-string">"Alegreya"</span> <span class="org-builtin">:size</span> 27))

(<span class="org-keyword">after!</span> mixed-pitch
  (<span class="org-keyword">setq</span> mixed-pitch-set-height t)
  (set-face-attribute 'variable-pitch-serif nil <span class="org-builtin">:font</span> variable-pitch-serif-font)
  (<span class="org-keyword">defun</span> <span class="org-function-name">mixed-pitch-serif-mode</span> (<span class="org-type">&amp;optional</span> arg)
    <span class="org-doc">"Change the default face of the current buffer to a serifed variable pitch, while keeping some faces fixed pitch."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">let</span> ((mixed-pitch-face 'variable-pitch-serif))
      (mixed-pitch-mode (<span class="org-keyword">or</span> arg 'toggle)))))
</pre>
</div>
</details>

<p>
Now, as Harfbuzz is currently used in Emacs, we'll be missing out on the
following Alegreya ligatures:
</p>
<div class="org-center">
<p>
ff <i>ff</i> ffi <i>ffi</i> ffj <i>ffj</i> ffl <i>ffl</i>
fft <i>fft</i> fi <i>fi</i> fj <i>fj</i> ft <i>ft</i>
Th <i>Th</i>
</p>
</div>

<p>
Thankfully, it isn't to hard to add these to the <code>composition-function-table</code>.
</p>
<details id='mixed-pitch,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mixed-pitch,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(set-char-table-range composition-function-table ?f '([<span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">ff?[fijlt]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> 0 font-shape-gstring]))
(set-char-table-range composition-function-table ?T '([<span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">Th</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> 0 font-shape-gstring]))
</pre>
</div>
</details>
</div>
<div id="outline-container-variable-pitch-serif" class="outline-5">
<h5 id="variable-pitch-serif"><span class="section-number-5">3.4.9.1.</span> Variable pitch serif font<a aria-hidden="true" href="#variable-pitch-serif">#</a> </h5>
<div class="outline-text-5" id="text-3-4-9-1">
<p>
It would be nice if we were able to make use of a serif version of the
<kbd>variable-pitch</kbd> face. Since this doesn't already exist, let's create it.
</p>

<details id='variable-pitch-serif,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#variable-pitch-serif,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defface</span> <span class="org-variable-name">variable-pitch-serif</span>
    '((t (<span class="org-builtin">:family</span> <span class="org-string">"serif"</span>)))
    <span class="org-doc">"A variable-pitch face with serifs."</span>
    <span class="org-builtin">:group</span> 'basic-faces)
</pre>
</div>
</details>

<p>
For ease of use, let's also set up an easy way of setting the <code>:font</code> attribute.
</p>

<details id='variable-pitch-serif,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#variable-pitch-serif,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defcustom</span> <span class="org-variable-name">variable-pitch-serif-font</span> (font-spec <span class="org-builtin">:family</span> <span class="org-string">"serif"</span>)
  <span class="org-doc">"The font face used for `</span><span class="org-doc"><span class="org-constant">variable-pitch-serif</span></span><span class="org-doc">'."</span>
  <span class="org-builtin">:group</span> 'basic-faces
  <span class="org-builtin">:type</span> '(restricted-sexp <span class="org-builtin">:tag</span> <span class="org-string">"font-spec"</span> <span class="org-builtin">:match-alternatives</span> (fontp))
  <span class="org-builtin">:set</span> (<span class="org-keyword">lambda</span> (symbol value)
         (set-face-attribute 'variable-pitch-serif nil <span class="org-builtin">:font</span> value)
         (set-default-toplevel-value symbol value)))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-marginalia" class="outline-4">
<h4 id="marginalia"><span class="section-number-4">3.4.10.</span> Marginalia<a aria-hidden="true" href="#marginalia">#</a> </h4>
<div class="outline-text-4" id="text-3-4-10">
<blockquote>
<p>
Part of the <kbd>:completion vertico</kbd> module.
</p>
</blockquote>

<p>
Marginalia is nice, but the file metadata annotations are a little too plain.
Specifically, I have these gripes
</p>
<ul class="org-ul">
<li>File attributes would be nicer if coloured</li>
<li>I don't care about the user/group information if the user/group is me</li>
<li>When a file time is recent, a relative age (e.g. <kbd>2h ago</kbd>) is more useful than
the date</li>
<li>An indication of file fatness would be nice</li>
</ul>

<p>
Thanks to the <code>marginalia-annotator-registry</code>, we don't have to advise, we can
just add a new <kbd>file</kbd> annotator.
</p>

<p>
Another small thing is the face used for docstrings. At the moment it's <kbd>(italic
shadow)</kbd>, but I don't like that.
</p>

<details id='marginalia,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#marginalia,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> marginalia
  (<span class="org-keyword">setq</span> marginalia-censor-variables nil)

  (<span class="org-keyword">defadvice!</span> +marginalia--anotate-local-file-colorful (cand)
    <span class="org-doc">"Just a more colourful version of `</span><span class="org-doc"><span class="org-constant">marginalia--anotate-local-file</span></span><span class="org-doc">'."</span>
    <span class="org-builtin">:override</span> #'marginalia--annotate-local-file
    (<span class="org-keyword">when-let</span> (attrs (file-attributes (substitute-in-file-name
                                       (marginalia--full-candidate cand))
                                      'integer))
      (marginalia--fields
       ((marginalia--file-owner attrs)
        <span class="org-builtin">:width</span> 12 <span class="org-builtin">:face</span> 'marginalia-file-owner)
       ((marginalia--file-modes attrs))
       ((+marginalia-file-size-colorful (file-attribute-size attrs))
        <span class="org-builtin">:width</span> 7)
       ((+marginalia--time-colorful (file-attribute-modification-time attrs))
        <span class="org-builtin">:width</span> 12))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+marginalia--time-colorful</span> (time)
    (<span class="org-keyword">let*</span> ((seconds (float-time (time-subtract (current-time) time)))
           (color (doom-blend
                   (face-attribute 'marginalia-date <span class="org-builtin">:foreground</span> nil t)
                   (face-attribute 'marginalia-documentation <span class="org-builtin">:foreground</span> nil t)
                   (/ 1.0 (log (+ 3 (/ (+ 1 seconds) 345600.0)))))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">1 - log(3 + 1/(days + 1)) % grey</span>
      (propertize (marginalia--time time) 'face (list <span class="org-builtin">:foreground</span> color))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+marginalia-file-size-colorful</span> (size)
    (<span class="org-keyword">let*</span> ((size-index (/ (log (+ 1 size)) 7.0))
           (color (<span class="org-keyword">if</span> (&lt; size-index 10000000) <span class="org-comment-delimiter">; </span><span class="org-comment">10m</span>
                      (doom-blend 'orange 'green size-index)
                    (doom-blend 'red 'orange (- size-index 1)))))
      (propertize (file-size-human-readable size) 'face (list <span class="org-builtin">:foreground</span> color)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-centaur-tabs" class="outline-4">
<h4 id="centaur-tabs"><span class="section-number-4">3.4.11.</span> Centaur Tabs<a aria-hidden="true" href="#centaur-tabs">#</a> </h4>
<div class="outline-text-4" id="text-3-4-11">
<blockquote>
<p>
From the <kbd>:ui tabs</kbd> module.
</p>
</blockquote>

<p>
We want to make the tabs a nice, comfy size (<code>36</code>), with icons. The modifier
marker is nice, but the particular default Unicode one causes a lag spike, so
let's just switch to an <code>o</code>, which still looks decent but doesn't cause any
issues.
An 'active-bar' is nice, so let's have one of those. If we have it <code>under</code> needs us to
turn on <code>x-underline-at-decent</code> though. For some reason this didn't seem to work
inside the <code class="src src-elisp">(<span class="org-keyword">after!</span> ... )</code> block ¯\<sub>(ツ)</sub>_/¯.
Then let's change the font to a sans serif, but the default one doesn't fit too
well somehow, so let's switch to 'P22 Underground Book'; it looks much nicer.
</p>

<details id='centaur-tabs,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#centaur-tabs,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> centaur-tabs
  (centaur-tabs-mode -1)
  (<span class="org-keyword">setq</span> centaur-tabs-height 36
        centaur-tabs-set-icons t
        centaur-tabs-modified-marker <span class="org-string">"o"</span>
        centaur-tabs-close-button <span class="org-string">"&#215;"</span>
        centaur-tabs-set-bar 'above
        centaur-tabs-gray-out-icons 'buffer)
  (centaur-tabs-change-fonts <span class="org-string">"P22 Underground Book"</span> 160))
<span class="org-comment-delimiter">;; </span><span class="org-comment">(setq x-underline-at-descent-line t)</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-nerd-icons" class="outline-4">
<h4 id="nerd-icons"><span class="section-number-4">3.4.12.</span> Nerd Icons<a aria-hidden="true" href="#nerd-icons">#</a> </h4>
<div class="outline-text-4" id="text-3-4-12">
<blockquote>
<p>
From the <kbd>:core packages</kbd> module.
</p>
</blockquote>

<p>
<kbd>nerd-icons</kbd> does a generally great job giving file names icons. One minor
niggle I have is that when <i>I</i> open a <kbd>.m</kbd> file, it's much more likely to be Matlab
than Objective-C. As such, it'll be switching the icon associated with <kbd>.m</kbd>.
</p>

<details id='nerd-icons,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#nerd-icons,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> nerd-icons
  (<span class="org-keyword">when-let</span> ((matlab-icon (assoc <span class="org-string">"matlab"</span> nerd-icons-extension-icon-alist)))
    (setcdr (assoc <span class="org-string">"m"</span> nerd-icons-extension-icon-alist)
            (cdr matlab-icon))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-prettier-page-breaks" class="outline-4">
<h4 id="prettier-page-breaks"><span class="section-number-4">3.4.13.</span> Prettier page breaks<a aria-hidden="true" href="#prettier-page-breaks">#</a> </h4>
<div class="outline-text-4" id="text-3-4-13">
<p>
In some files, <kbd>^L</kbd> appears as a page break character. This isn't that visually
appealing, and Steve Purcell has been nice enough to make a package to display
these as horizontal rules.
</p>

<details id='prettier-page-breaks,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prettier-page-breaks,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> page-break-lines <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"purcell/page-break-lines"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"982571749c8fe2b5e2997dd043003a1b9fe87b38"</span>)
</pre>
</div>
</details>

<p>
We can go from "better" to "where has this been all my life?" by now making page
navigation easy with some simple keybindings lifted from <a href="http://xahlee.info/emacs/emacs/modernization_formfeed.html">Xah Lee</a>'s post on the
form feed. Making <code>forward-page</code> and <code>backward-page</code> work with Evil mode also takes
a little tweaking, so we might as well do that too while we're at it.
</p>

<p>
We can also make the displayed horizontal rule communicate more useful
information by making it the same as the fill column. While this could be
accomplished by just <kbd>setq</kbd>ing the rule width to the default <code>fill-column</code> value,
it would be better for it to always match the local buffer value. This may be
accomplished with advise, but it's a bit cleaner (and even simpler) to just turn
the width variable into an alias for <code>fill-column</code>.
</p>

<details id='prettier-page-breaks,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prettier-page-breaks,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! page-break-lines
  <span class="org-builtin">:hook</span> (prog-mode . page-break-lines-mode)
  <span class="org-builtin">:init</span>
  (autoload 'turn-on-page-break-lines-mode <span class="org-string">"page-break-lines"</span>)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defvaralias</span> '<span class="org-variable-name">page-break-lines-max-width</span> 'fill-column)
  (<span class="org-keyword">defun</span> <span class="org-function-name">+evil-forward-page</span> ()
    <span class="org-doc">"Call `</span><span class="org-doc"><span class="org-constant">forward-page</span></span><span class="org-doc">', such that it works as intended with evil-mode."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">when</span> (eq (char-after (point)) ?\^L)
      (forward-char 1))
    (forward-page))
  (<span class="org-keyword">defun</span> <span class="org-function-name">+evil-backward-page</span> ()
    <span class="org-doc">"Call `</span><span class="org-doc"><span class="org-constant">backward-page</span></span><span class="org-doc">', such that it works as intended with evil-mode."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">when</span> (eq (char-after (point)) ?\^L)
      (backward-char 1))
    (backward-page))
  (map! <span class="org-builtin">:prefix</span> <span class="org-string">"g"</span>
        <span class="org-builtin">:desc</span> <span class="org-string">"Prev page break"</span> <span class="org-builtin">:nv</span> <span class="org-string">"["</span> #'+evil-backward-page
        <span class="org-builtin">:desc</span> <span class="org-string">"Next page break"</span> <span class="org-builtin">:nv</span> <span class="org-string">"]"</span> #'+evil-forward-page)
  (map! <span class="org-string">"&lt;C-M-prior&gt;"</span> #'+evil-backward-page
        <span class="org-string">"&lt;C-M-next&gt;"</span> #'+evil-forward-page))
</pre>
</div>
</details>

<p>
With this setup, I find form-feeds to be a really convenient addition to my
coding workflow. Despite generally poor adoption, they are the only
language-independent form that "just works". While you could also use specially
crafted comment forms and a more complex setup, it's not as though the form-feed
is being used for anything else &#x2014; it's free real estate! 😉
</p>
</div>
</div>
<div id="outline-container-writeroom" class="outline-4">
<h4 id="writeroom"><span class="section-number-4">3.4.14.</span> Writeroom<a aria-hidden="true" href="#writeroom">#</a> </h4>
<div class="outline-text-4" id="text-3-4-14">
<blockquote>
<p>
From the <kbd>:ui zen</kbd> module.
</p>
</blockquote>

<p>
For starters, I think Doom is a bit over-zealous when zooming in
</p>
<details id='writeroom,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#writeroom,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> +zen-text-scale 0.8)
</pre>
</div>
</details>

<p>
Then, when using Org it would be nice to make a number of other aesthetic
tweaks. Namely:
</p>
<ul class="org-ul">
<li>Use a serifed variable-pitch font</li>
<li>Hiding headline leading stars</li>
<li>Using fleurons as headline bullets</li>
<li>Hiding line numbers</li>
<li>Removing outline indentation</li>
<li>Centring the text</li>
</ul>

<details id='writeroom,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#writeroom,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+zen-serif-p</span> t
  <span class="org-doc">"Whether to use a serifed font with `</span><span class="org-doc"><span class="org-constant">mixed-pitch-mode</span></span><span class="org-doc">'."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">+zen-org-starhide</span> t
  <span class="org-doc">"The value `</span><span class="org-doc"><span class="org-constant">org-modern-hide-stars</span></span><span class="org-doc">' is set to."</span>)

(<span class="org-keyword">after!</span> writeroom-mode
  (<span class="org-keyword">defvar-local</span> <span class="org-variable-name">+zen--original-org-indent-mode-p</span> nil)
  (<span class="org-keyword">defvar-local</span> <span class="org-variable-name">+zen--original-mixed-pitch-mode-p</span> nil)
  (<span class="org-keyword">defun</span> <span class="org-function-name">+zen-enable-mixed-pitch-mode-h</span> ()
    <span class="org-doc">"Enable `</span><span class="org-doc"><span class="org-constant">mixed-pitch-mode</span></span><span class="org-doc">' when in `</span><span class="org-doc"><span class="org-constant">+zen-mixed-pitch-modes</span></span><span class="org-doc">'."</span>
    (<span class="org-keyword">when</span> (apply #'derived-mode-p +zen-mixed-pitch-modes)
      (<span class="org-keyword">if</span> writeroom-mode
          (<span class="org-keyword">progn</span>
            (<span class="org-keyword">setq</span> +zen--original-mixed-pitch-mode-p mixed-pitch-mode)
            (funcall (<span class="org-keyword">if</span> +zen-serif-p #'mixed-pitch-serif-mode #'mixed-pitch-mode) 1))
        (funcall #'mixed-pitch-mode (<span class="org-keyword">if</span> +zen--original-mixed-pitch-mode-p 1 -1)))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">+zen-prose-org-h</span> ()
    <span class="org-doc">"Reformat the current Org buffer appearance for prose."</span>
    (<span class="org-keyword">when</span> (eq major-mode 'org-mode)
      (<span class="org-keyword">setq</span> display-line-numbers nil
            visual-fill-column-width 60
            org-adapt-indentation nil)
      (<span class="org-keyword">when</span> (<span class="org-keyword">featurep</span> '<span class="org-constant">org-modern</span>)
        (<span class="org-keyword">setq-local</span> org-modern-star '(<span class="org-string">"&#128600;"</span> <span class="org-string">"&#128601;"</span> <span class="org-string">"&#128602;"</span> <span class="org-string">"&#128603;"</span>)
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">org-modern-star '("&#128592;" "&#128593;" "&#128594;" "&#128595;" "&#128596;" "&#128597;" "&#128598;" "&#128599;")</span>
                    org-modern-hide-stars +zen-org-starhide)
        (org-modern-mode -1)
        (org-modern-mode 1))
      (<span class="org-keyword">setq</span>
       +zen--original-org-indent-mode-p org-indent-mode)
      (org-indent-mode -1)))
  (<span class="org-keyword">defun</span> <span class="org-function-name">+zen-nonprose-org-h</span> ()
    <span class="org-doc">"Reverse the effect of `</span><span class="org-doc"><span class="org-constant">+zen-prose-org</span></span><span class="org-doc">'."</span>
    (<span class="org-keyword">when</span> (eq major-mode 'org-mode)
      (<span class="org-keyword">when</span> (<span class="org-keyword">bound-and-true-p</span> org-modern-mode)
        (org-modern-mode -1)
        (org-modern-mode 1))
      (<span class="org-keyword">when</span> +zen--original-org-indent-mode-p (org-indent-mode 1))))
  (<span class="org-keyword">pushnew!</span> writeroom--local-variables
            'display-line-numbers
            'visual-fill-column-width
            'org-adapt-indentation
            'org-modern-mode
            'org-modern-star
            'org-modern-hide-stars)
  (add-hook 'writeroom-mode-enable-hook #'+zen-prose-org-h)
  (add-hook 'writeroom-mode-disable-hook #'+zen-nonprose-org-h))
</pre>
</div>
</details>


<figure id="org023224d">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/writeroom-and-org.png" alt="Writeroom applied to an Org file" class="invertible">

</figure>
</div>
</div>
<div id="outline-container-treemacs" class="outline-4">
<h4 id="treemacs"><span class="section-number-4">3.4.15.</span> Treemacs<a aria-hidden="true" href="#treemacs">#</a> </h4>
<div class="outline-text-4" id="text-3-4-15">
<blockquote>
<p>
From the <kbd>:ui treemacs</kbd> module.
</p>
</blockquote>

<p>
Quite often there are superfluous files I'm not that interested in. There's no
good reason for them to take up space. Let's add a mechanism to ignore them.
</p>
<details id='treemacs,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#treemacs,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> treemacs
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">treemacs-file-ignore-extensions</span> '()
    <span class="org-doc">"File extension which `</span><span class="org-doc"><span class="org-constant">treemacs-ignore-filter</span></span><span class="org-doc">' will ensure are ignored"</span>)
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">treemacs-file-ignore-globs</span> '()
    <span class="org-doc">"Globs which will are transformed to `</span><span class="org-doc"><span class="org-constant">treemacs-file-ignore-regexps</span></span><span class="org-doc">' which `</span><span class="org-doc"><span class="org-constant">treemacs-ignore-filter</span></span><span class="org-doc">' will ensure are ignored"</span>)
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">treemacs-file-ignore-regexps</span> '()
    <span class="org-doc">"RegExps to be tested to ignore files, generated from `</span><span class="org-doc"><span class="org-constant">treeemacs-file-ignore-globs</span></span><span class="org-doc">'"</span>)
  (<span class="org-keyword">defun</span> <span class="org-function-name">treemacs-file-ignore-generate-regexps</span> ()
    <span class="org-doc">"Generate `</span><span class="org-doc"><span class="org-constant">treemacs-file-ignore-regexps</span></span><span class="org-doc">' from `</span><span class="org-doc"><span class="org-constant">treemacs-file-ignore-globs</span></span><span class="org-doc">'"</span>
    (<span class="org-keyword">setq</span> treemacs-file-ignore-regexps (mapcar 'dired-glob-regexp treemacs-file-ignore-globs)))
  (<span class="org-keyword">if</span> (equal treemacs-file-ignore-globs '()) nil (treemacs-file-ignore-generate-regexps))
  (<span class="org-keyword">defun</span> <span class="org-function-name">treemacs-ignore-filter</span> (file full-path)
    <span class="org-doc">"Ignore files specified by `</span><span class="org-doc"><span class="org-constant">treemacs-file-ignore-extensions</span></span><span class="org-doc">', and `</span><span class="org-doc"><span class="org-constant">treemacs-file-ignore-regexps</span></span><span class="org-doc">'"</span>
    (<span class="org-keyword">or</span> (member (file-name-extension file) treemacs-file-ignore-extensions)
        (<span class="org-keyword">let</span> ((ignore-file nil))
          (<span class="org-keyword">dolist</span> (regexp treemacs-file-ignore-regexps ignore-file)
            (<span class="org-keyword">setq</span> ignore-file (<span class="org-keyword">or</span> ignore-file (<span class="org-keyword">if</span> (string-match-p regexp full-path) t nil)))))))
  (add-to-list 'treemacs-ignored-file-predicates #'treemacs-ignore-filter))
</pre>
</div>
</details>

<p>
Now, we just identify the files in question.
</p>
<details id='treemacs,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#treemacs,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> treemacs-file-ignore-extensions
      '(<span class="org-comment-delimiter">;; </span><span class="org-comment">LaTeX</span>
        <span class="org-string">"aux"</span>
        <span class="org-string">"ptc"</span>
        <span class="org-string">"fdb_latexmk"</span>
        <span class="org-string">"fls"</span>
        <span class="org-string">"synctex.gz"</span>
        <span class="org-string">"toc"</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">LaTeX - glossary</span>
        <span class="org-string">"glg"</span>
        <span class="org-string">"glo"</span>
        <span class="org-string">"gls"</span>
        <span class="org-string">"glsdefs"</span>
        <span class="org-string">"ist"</span>
        <span class="org-string">"acn"</span>
        <span class="org-string">"acr"</span>
        <span class="org-string">"alg"</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">LaTeX - pgfplots</span>
        <span class="org-string">"mw"</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">LaTeX - pdfx</span>
        <span class="org-string">"pdfa.xmpi"</span>
        ))
(<span class="org-keyword">setq</span> treemacs-file-ignore-globs
      '(<span class="org-comment-delimiter">;; </span><span class="org-comment">LaTeX</span>
        <span class="org-string">"*/_minted-*"</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">AucTeX</span>
        <span class="org-string">"*/.auctex-auto"</span>
        <span class="org-string">"*/_region_.log"</span>
        <span class="org-string">"*/_region_.tex"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-visual-fill-column" class="outline-4">
<h4 id="visual-fill-column"><span class="section-number-4">3.4.16.</span> Visual fill column<a aria-hidden="true" href="#visual-fill-column">#</a> </h4>
<div class="outline-text-4" id="text-3-4-16">
<p>
This is already loaded by Doom, but it needs a patch applied for Emacs 29. I've
emailed this to the maintainer, hopefully Joost will take a look at it.
</p>

<details id='orgfc0b934' class='code' open>
<summary></summary>
<div class='gutter'><a href='#orgfc0b934'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="orgfc0b934">
Account for remapping in window width calculation

The window width calculation in
`visual-fill-column--window-max-text-width' uses `window-width' with the
active window as the sole argument. As of Emacs 29, this returns the
width of the window using the default face, even if the default face has
been remapped in the window: causing incorrect results when the window
is remapped.

Emacs 29 also introduces a special second argument value, `remap'
which (as we want) uses the remapped face, if applicable. This corrects
the width calculation. However, margin calculations are still done in
terms of the non-remapped default face, and so a conversion factor needs
to be applied when considering margins.
</pre>

</details>

<p>
That's the problem/fix, I'll just overwrite the two functions in question with
the fixed versions for now.
</p>

<details id='visual-fill-column,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#visual-fill-column,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+visual-fill-column--window-max-text-width--fixed</span> (<span class="org-type">&amp;optional</span> window)
  <span class="org-doc">"Return the maximum possible text width of WINDOW.</span>
<span class="org-doc">The maximum possible text width is the width of the current text</span>
<span class="org-doc">area plus the margins, but excluding the fringes, scroll bar, and</span>
<span class="org-doc">right divider.  WINDOW defaults to the selected window.  The</span>
<span class="org-doc">return value is scaled to account for `</span><span class="org-doc"><span class="org-constant">text-scale-mode-amount</span></span><span class="org-doc">'</span>
<span class="org-doc">and `</span><span class="org-doc"><span class="org-constant">text-scale-mode-step</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">or</span> window (<span class="org-keyword">setq</span> window (selected-window)))
  (<span class="org-keyword">let*</span> ((margins (window-margins window))
         (buffer (window-buffer window))
         (scale (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> visual-fill-column-adjust-for-text-scale
                         (boundp 'text-scale-mode-step)
                         (boundp 'text-scale-mode-amount))
                    (<span class="org-keyword">with-current-buffer</span> buffer
                      (expt text-scale-mode-step
                            text-scale-mode-amount))
                  1.0))
         (remap-scale
          (<span class="org-keyword">if</span> (&gt;= emacs-major-version 29)
              (/ (window-width window 'remap) (float (window-width window)))
            1.0)))
    (truncate (/ (+ (window-width window (<span class="org-keyword">and</span> (&gt;= emacs-major-version 29) 'remap))
                    (* (<span class="org-keyword">or</span> (car margins) 0) remap-scale)
                    (* (<span class="org-keyword">or</span> (cdr margins) 0) remap-scale))
                 (float scale)))))

(advice-add 'visual-fill-column--window-max-text-width
            <span class="org-builtin">:override</span> #'+visual-fill-column--window-max-text-width--fixed)

(<span class="org-keyword">defun</span> <span class="org-function-name">+visual-fill-column--set-margins--fixed</span> (window)
  <span class="org-doc">"Set window margins for WINDOW."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Calculate left &amp; right margins.</span>
  (<span class="org-keyword">let*</span> ((total-width (visual-fill-column--window-max-text-width window))
         (remap-scale
          (<span class="org-keyword">if</span> (&gt;= emacs-major-version 29)
              (/ (window-width window 'remap) (float (window-width window)))
            1.0))
         (width (<span class="org-keyword">or</span> visual-fill-column-width
                    fill-column))
         (margins (<span class="org-keyword">if</span> (&lt; (- total-width width) 0) <span class="org-comment-delimiter">; </span><span class="org-comment">margins must be &gt;= 0</span>
                      0
                    (round (/ (- total-width width) remap-scale))))
         (left (<span class="org-keyword">if</span> visual-fill-column-center-text
                   (/ margins 2)
                 0))
         (right (- margins left)))

    (<span class="org-keyword">if</span> visual-fill-column-extra-text-width
        (<span class="org-keyword">let</span> ((add-width (visual-fill-column--add-extra-width left right visual-fill-column-extra-text-width)))
          (<span class="org-keyword">setq</span> left (car add-width)
                right (cdr add-width))))

    <span class="org-comment-delimiter">;; </span><span class="org-comment">put an explicitly R2L buffer on the right side of the window</span>
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (eq bidi-paragraph-direction 'right-to-left)
               (= left 0))
      (<span class="org-keyword">setq</span> left right)
      (<span class="org-keyword">setq</span> right 0))

    (set-window-margins window left right)))

(advice-add 'visual-fill-column--set-margins
            <span class="org-builtin">:override</span> #'+visual-fill-column--set-margins--fixed)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-frivolities" class="outline-3">
<h3 id="frivolities"><span class="section-number-3">3.5.</span> Frivolities<a aria-hidden="true" href="#frivolities">#</a> </h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-xkcd" class="outline-4">
<h4 id="xkcd"><span class="section-number-4">3.5.1.</span> xkcd<a aria-hidden="true" href="#xkcd">#</a> </h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
<span class='acr'>XKCD</span> comics are fun.
</p>
<details id='xkcd,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#xkcd,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> xkcd <span class="org-builtin">:pin</span> <span class="org-string">"80011da2e7def8f65233d4e0d790ca60d287081d"</span>)
</pre>
</div>
</details>

<p>
We want to set this up so it loads nicely in <a href="#extra-links">Extra links</a>.
</p>
<details id='xkcd,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#xkcd,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! xkcd
  <span class="org-builtin">:commands</span> (xkcd-get-json
             xkcd-download xkcd-get
             <span class="org-comment-delimiter">;; </span><span class="org-comment">now for funcs from my extension of this pkg</span>
             +xkcd-find-and-copy +xkcd-find-and-view
             +xkcd-fetch-info +xkcd-select)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> xkcd-cache-dir (expand-file-name <span class="org-string">"xkcd/"</span> doom-cache-dir)
        xkcd-cache-latest (concat xkcd-cache-dir <span class="org-string">"latest"</span>))
  (<span class="org-keyword">unless</span> (file-exists-p xkcd-cache-dir)
    (make-directory xkcd-cache-dir))
  (<span class="org-keyword">after!</span> evil-snipe
    (add-to-list 'evil-snipe-disabled-modes 'xkcd-mode))
  <span class="org-builtin">:general</span> (<span class="org-builtin">:states</span> 'normal
            <span class="org-builtin">:keymaps</span> 'xkcd-mode-map
            <span class="org-string">"&lt;right&gt;"</span> #'xkcd-next
            <span class="org-string">"n"</span>       #'xkcd-next <span class="org-comment-delimiter">; </span><span class="org-comment">evil-ish</span>
            <span class="org-string">"&lt;left&gt;"</span>  #'xkcd-prev
            <span class="org-string">"N"</span>       #'xkcd-prev <span class="org-comment-delimiter">; </span><span class="org-comment">evil-ish</span>
            <span class="org-string">"r"</span>       #'xkcd-rand
            <span class="org-string">"a"</span>       #'xkcd-rand <span class="org-comment-delimiter">; </span><span class="org-comment">because image-rotate can interfere</span>
            <span class="org-string">"t"</span>       #'xkcd-alt-text
            <span class="org-string">"q"</span>       #'xkcd-kill-buffer
            <span class="org-string">"o"</span>       #'xkcd-open-browser
            <span class="org-string">"e"</span>       #'xkcd-open-explanation-browser
            <span class="org-comment-delimiter">;; </span><span class="org-comment">extras</span>
            <span class="org-string">"s"</span>       #'+xkcd-find-and-view
            <span class="org-string">"/"</span>       #'+xkcd-find-and-view
            <span class="org-string">"y"</span>       #'+xkcd-copy))
</pre>
</div>
</details>

<p>
Let's also extend the functionality a whole bunch.
</p>
<details id='xkcd,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#xkcd,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> xkcd
  (<span class="org-keyword">require</span> '<span class="org-constant">emacsql-sqlite</span>)

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-select</span> ()
    <span class="org-doc">"Prompt the user for an xkcd using `</span><span class="org-doc"><span class="org-constant">completing-read</span></span><span class="org-doc">' and `</span><span class="org-doc"><span class="org-constant">+xkcd-select-format</span></span><span class="org-doc">'. Return the xkcd number or nil"</span>
    (<span class="org-keyword">let*</span> (prompt-lines
           (-dummy (maphash (<span class="org-keyword">lambda</span> (key xkcd-info)
                              (<span class="org-keyword">push</span> (+xkcd-select-format xkcd-info) prompt-lines))
                            +xkcd-stored-info))
           (num (completing-read (format <span class="org-string">"xkcd (%s): "</span> xkcd-latest) prompt-lines)))
      (<span class="org-keyword">if</span> (equal <span class="org-string">""</span> num) xkcd-latest
        (string-to-number (replace-regexp-in-string <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.*"</span> <span class="org-string">"\\1"</span> num)))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-select-format</span> (xkcd-info)
    <span class="org-doc">"Creates each completing-read line from an xkcd info plist. Must start with the xkcd number"</span>
    (format <span class="org-string">"%-4s  %-30s %s"</span>
            (propertize (number-to-string (plist-get xkcd-info <span class="org-builtin">:num</span>))
                        'face 'counsel-key-binding)
            (plist-get xkcd-info <span class="org-builtin">:title</span>)
            (propertize (plist-get xkcd-info <span class="org-builtin">:alt</span>)
                        'face '(variable-pitch font-lock-comment-face))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-fetch-info</span> (<span class="org-type">&amp;optional</span> num)
    <span class="org-doc">"Fetch the parsed json info for comic NUM. Fetches latest when omitted or 0"</span>
    (<span class="org-keyword">require</span> '<span class="org-constant">xkcd</span>)
    (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (not num) (= num 0))
      (+xkcd-check-latest)
      (<span class="org-keyword">setq</span> num xkcd-latest))
    (<span class="org-keyword">let</span> ((res (<span class="org-keyword">or</span> (gethash num +xkcd-stored-info)
                   (puthash num (+xkcd-db-read num) +xkcd-stored-info))))
      (<span class="org-keyword">unless</span> res
        (+xkcd-db-write
         (<span class="org-keyword">let*</span> ((url (format <span class="org-string">"https://xkcd.com/%d/info.0.json"</span> num))
                (json-assoc
                 (<span class="org-keyword">if</span> (gethash num +xkcd-stored-info)
                     (gethash num +xkcd-stored-info)
                   (json-read-from-string (xkcd-get-json url num)))))
           json-assoc))
        (<span class="org-keyword">setq</span> res (+xkcd-db-read num)))
      res))

  <span class="org-comment-delimiter">;; </span><span class="org-comment">since we've done this, we may as well go one little step further</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-find-and-copy</span> ()
    <span class="org-doc">"Prompt for an xkcd using `</span><span class="org-doc"><span class="org-constant">+xkcd-select</span></span><span class="org-doc">' and copy url to clipboard"</span>
    (<span class="org-keyword">interactive</span>)
    (+xkcd-copy (+xkcd-select)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-copy</span> (<span class="org-type">&amp;optional</span> num)
    <span class="org-doc">"Copy a url to xkcd NUM to the clipboard"</span>
    (<span class="org-keyword">interactive</span> <span class="org-string">"i"</span>)
    (<span class="org-keyword">let</span> ((num (<span class="org-keyword">or</span> num xkcd-cur)))
      (gui-select-text (format <span class="org-string">"https://xkcd.com/%d"</span> num))
      (message <span class="org-string">"xkcd.com/%d copied to clipboard"</span> num)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-find-and-view</span> ()
    <span class="org-doc">"Prompt for an xkcd using `</span><span class="org-doc"><span class="org-constant">+xkcd-select</span></span><span class="org-doc">' and view it"</span>
    (<span class="org-keyword">interactive</span>)
    (xkcd-get (+xkcd-select))
    (switch-to-buffer <span class="org-string">"*xkcd*"</span>))

  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+xkcd-latest-max-age</span> (* 60 60) <span class="org-comment-delimiter">; </span><span class="org-comment">1 hour</span>
    <span class="org-doc">"Time after which xkcd-latest should be refreshed, in seconds"</span>)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">initialise `</span><span class="org-comment"><span class="org-constant">xkcd-latest</span></span><span class="org-comment">' and `</span><span class="org-comment"><span class="org-constant">+xkcd-stored-info</span></span><span class="org-comment">' with latest xkcd</span>
  (<span class="org-keyword">add-transient-hook!</span> '+xkcd-select
    (<span class="org-keyword">require</span> '<span class="org-constant">xkcd</span>)
    (+xkcd-fetch-info xkcd-latest)
    (<span class="org-keyword">setq</span> +xkcd-stored-info (+xkcd-db-read-all)))

  (<span class="org-keyword">add-transient-hook!</span> '+xkcd-fetch-info
    (xkcd-update-latest))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-check-latest</span> ()
    <span class="org-doc">"Use value in `</span><span class="org-doc"><span class="org-constant">xkcd-cache-latest</span></span><span class="org-doc">' as long as it isn't older thabn `</span><span class="org-doc"><span class="org-constant">+xkcd-latest-max-age</span></span><span class="org-doc">'"</span>
    (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> (file-exists-p xkcd-cache-latest)
                 (&lt; (- (time-to-seconds (current-time))
                       (time-to-seconds (file-attribute-modification-time (file-attributes xkcd-cache-latest))))
                    +xkcd-latest-max-age))
      (<span class="org-keyword">let*</span> ((out (xkcd-get-json <span class="org-string">"http://xkcd.com/info.0.json"</span> 0))
             (json-assoc (json-read-from-string out))
             (latest (cdr (assoc 'num json-assoc))))
        (<span class="org-keyword">when</span> (/= xkcd-latest latest)
          (+xkcd-db-write json-assoc)
          (<span class="org-keyword">with-current-buffer</span> (find-file xkcd-cache-latest)
            (<span class="org-keyword">setq</span> xkcd-latest latest)
            (erase-buffer)
            (insert (number-to-string latest))
            (save-buffer)
            (kill-buffer (current-buffer)))))
      (shell-command (format <span class="org-string">"touch %s"</span> xkcd-cache-latest))))

  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+xkcd-stored-info</span> (make-hash-table <span class="org-builtin">:test</span> 'eql)
    <span class="org-doc">"Basic info on downloaded xkcds, in the form of a hashtable"</span>)

  (<span class="org-keyword">defadvice!</span> xkcd-get-json--and-cache (url <span class="org-type">&amp;optional</span> num)
    <span class="org-doc">"Fetch the Json coming from URL.</span>
<span class="org-doc">If the file NUM.json exists, use it instead.</span>
<span class="org-doc">If NUM is 0, always download from URL.</span>
<span class="org-doc">The return value is a string."</span>
    <span class="org-builtin">:override</span> #'xkcd-get-json
    (<span class="org-keyword">let*</span> ((file (format <span class="org-string">"%s%d.json"</span> xkcd-cache-dir num))
           (cached (<span class="org-keyword">and</span> (file-exists-p file) (not (eq num 0))))
           (out (<span class="org-keyword">with-current-buffer</span> (<span class="org-keyword">if</span> cached
                                         (find-file file)
                                       (url-retrieve-synchronously url))
                  (goto-char (point-min))
                  (<span class="org-keyword">unless</span> cached (re-search-forward <span class="org-string">"^$"</span>))
                  (<span class="org-keyword">prog1</span>
                      (buffer-substring-no-properties (point) (point-max))
                    (kill-buffer (current-buffer))))))
      (<span class="org-keyword">unless</span> (<span class="org-keyword">or</span> cached (eq num 0))
        (xkcd-cache-json num out))
      out))

  (<span class="org-keyword">defadvice!</span> +xkcd-get (num)
    <span class="org-doc">"Get the xkcd number NUM."</span>
    <span class="org-builtin">:override</span> 'xkcd-get
    (<span class="org-keyword">interactive</span> <span class="org-string">"nEnter comic number: "</span>)
    (xkcd-update-latest)
    (get-buffer-create <span class="org-string">"*xkcd*"</span>)
    (switch-to-buffer <span class="org-string">"*xkcd*"</span>)
    (xkcd-mode)
    (<span class="org-keyword">let</span> (buffer-read-only)
      (erase-buffer)
      (<span class="org-keyword">setq</span> xkcd-cur num)
      (<span class="org-keyword">let*</span> ((xkcd-data (+xkcd-fetch-info num))
             (num (plist-get xkcd-data <span class="org-builtin">:num</span>))
             (img (plist-get xkcd-data <span class="org-builtin">:img</span>))
             (safe-title (plist-get xkcd-data <span class="org-builtin">:safe-title</span>))
             (alt (plist-get xkcd-data <span class="org-builtin">:alt</span>))
             title file)
        (message <span class="org-string">"Getting comic..."</span>)
        (<span class="org-keyword">setq</span> file (xkcd-download img num))
        (<span class="org-keyword">setq</span> title (format <span class="org-string">"%d: %s"</span> num safe-title))
        (insert (propertize title
                            'face 'outline-1))
        (center-line)
        (insert <span class="org-string">"\n"</span>)
        (xkcd-insert-image file num)
        (<span class="org-keyword">if</span> (eq xkcd-cur 0)
            (<span class="org-keyword">setq</span> xkcd-cur num))
        (<span class="org-keyword">setq</span> xkcd-alt alt)
        (message <span class="org-string">"%s"</span> title))))

  (<span class="org-keyword">defconst</span> <span class="org-variable-name">+xkcd-db--sqlite-available-p</span>
    (<span class="org-keyword">with-demoted-errors</span> <span class="org-string">"+org-xkcd initialization: %S"</span>
      (emacsql-sqlite-ensure-binary)
      t))

  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+xkcd-db--connection</span> (make-hash-table <span class="org-builtin">:test</span> #'equal)
    <span class="org-doc">"Database connection to +org-xkcd database."</span>)

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db--get</span> ()
    <span class="org-doc">"Return the sqlite db file."</span>
    (expand-file-name <span class="org-string">"xkcd.db"</span> xkcd-cache-dir))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db--get-connection</span> ()
    <span class="org-doc">"Return the database connection, if any."</span>
    (gethash (file-truename xkcd-cache-dir)
             +xkcd-db--connection))

  (<span class="org-keyword">defconst</span> <span class="org-variable-name">+xkcd-db--table-schema</span>
    '((xkcds
       [(num integer <span class="org-builtin">:unique</span> <span class="org-builtin">:primary-key</span>)
        (year        <span class="org-builtin">:not-null</span>)
        (month       <span class="org-builtin">:not-null</span>)
        (link        <span class="org-builtin">:not-null</span>)
        (news        <span class="org-builtin">:not-null</span>)
        (safe_title  <span class="org-builtin">:not-null</span>)
        (title       <span class="org-builtin">:not-null</span>)
        (transcript  <span class="org-builtin">:not-null</span>)
        (alt         <span class="org-builtin">:not-null</span>)
        (img         <span class="org-builtin">:not-null</span>)])))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db--init</span> (db)
    <span class="org-doc">"Initialize database DB with the correct schema and user version."</span>
    (emacsql-with-transaction db
      (<span class="org-keyword">pcase-dolist</span> (`(,table . ,schema) +xkcd-db--table-schema)
        (emacsql db [<span class="org-builtin">:create-table</span> $i1 $S2] table schema))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db</span> ()
    <span class="org-doc">"Entrypoint to the +org-xkcd sqlite database.</span>
<span class="org-doc">Initializes and stores the database, and the database connection.</span>
<span class="org-doc">Performs a database upgrade when required."</span>
    (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> (+xkcd-db--get-connection)
                 (emacsql-live-p (+xkcd-db--get-connection)))
      (<span class="org-keyword">let*</span> ((db-file (+xkcd-db--get))
             (init-db (not (file-exists-p db-file))))
        (make-directory (file-name-directory db-file) t)
        (<span class="org-keyword">let</span> ((conn (emacsql-sqlite db-file)))
          (set-process-query-on-exit-flag (emacsql-process conn) nil)
          (puthash (file-truename xkcd-cache-dir)
                   conn
                   +xkcd-db--connection)
          (<span class="org-keyword">when</span> init-db
            (+xkcd-db--init conn)))))
    (+xkcd-db--get-connection))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db-query</span> (sql <span class="org-type">&amp;rest</span> args)
    <span class="org-doc">"Run SQL query on +org-xkcd database with ARGS.</span>
<span class="org-doc">SQL can be either the emacsql vector representation, or a string."</span>
    (<span class="org-keyword">if</span>  (stringp sql)
        (emacsql (+xkcd-db) (apply #'format sql args))
      (apply #'emacsql (+xkcd-db) sql args)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db-read</span> (num)
    (<span class="org-keyword">when-let</span> ((res
                (car (+xkcd-db-query [<span class="org-builtin">:select</span> * <span class="org-builtin">:from</span> xkcds
                                      <span class="org-builtin">:where</span> (= num $s1)]
                                     num
                                     <span class="org-builtin">:limit</span> 1))))
      (+xkcd-db-list-to-plist res)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db-read-all</span> ()
    (<span class="org-keyword">let</span> ((xkcd-table (make-hash-table <span class="org-builtin">:test</span> 'eql <span class="org-builtin">:size</span> 4000)))
      (mapcar (<span class="org-keyword">lambda</span> (xkcd-info-list)
                (puthash (car xkcd-info-list) (+xkcd-db-list-to-plist xkcd-info-list) xkcd-table))
              (+xkcd-db-query [<span class="org-builtin">:select</span> * <span class="org-builtin">:from</span> xkcds]))
      xkcd-table))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db-list-to-plist</span> (xkcd-datalist)
    `(<span class="org-builtin">:num</span> ,(nth 0 xkcd-datalist)
      <span class="org-builtin">:year</span> ,(nth 1 xkcd-datalist)
      <span class="org-builtin">:month</span> ,(nth 2 xkcd-datalist)
      <span class="org-builtin">:link</span> ,(nth 3 xkcd-datalist)
      <span class="org-builtin">:news</span> ,(nth 4 xkcd-datalist)
      <span class="org-builtin">:safe-title</span> ,(nth 5 xkcd-datalist)
      <span class="org-builtin">:title</span> ,(nth 6 xkcd-datalist)
      <span class="org-builtin">:transcript</span> ,(nth 7 xkcd-datalist)
      <span class="org-builtin">:alt</span> ,(nth 8 xkcd-datalist)
      <span class="org-builtin">:img</span> ,(nth 9 xkcd-datalist)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+xkcd-db-write</span> (data)
    (+xkcd-db-query [<span class="org-builtin">:insert-into</span> xkcds
                     <span class="org-builtin">:values</span> $v1]
                    (list (vector
                           (cdr (assoc 'num        data))
                           (cdr (assoc 'year       data))
                           (cdr (assoc 'month      data))
                           (cdr (assoc 'link       data))
                           (cdr (assoc 'news       data))
                           (cdr (assoc 'safe_title data))
                           (cdr (assoc 'title      data))
                           (cdr (assoc 'transcript data))
                           (cdr (assoc 'alt        data))
                           (cdr (assoc 'img        data))
                           )))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-selectric" class="outline-4">
<h4 id="selectric"><span class="section-number-4">3.5.2.</span> Selectric<a aria-hidden="true" href="#selectric">#</a> </h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
Every so often, you want everyone else to <i>know</i> that you're typing, or just to
amuse oneself. Introducing: typewriter sounds!
</p>
<details id='selectric,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#selectric,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> selectric-mode <span class="org-builtin">:pin</span> <span class="org-string">"1840de71f7414b7cd6ce425747c8e26a413233aa"</span>)
</pre>
</div>
</details>

<details id='selectric,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#selectric,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! selectic-mode
  <span class="org-builtin">:commands</span> selectic-mode)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-wttrin" class="outline-4">
<h4 id="wttrin"><span class="section-number-4">3.5.3.</span> Wttrin<a aria-hidden="true" href="#wttrin">#</a> </h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
Hey, let's get the weather in here while we're at it.
Unfortunately this seems slightly unmaintained (<a href="https://github.com/bcbcarl/emacs-wttrin/pulls">few open bugfix <span class='acr'>PR</span><small>s</small></a>) so let's
roll our <a href="lisp/wttrin/wttrin.el">own version</a>.
</p>
<details id='wttrin,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#wttrin,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> wttrin <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/wttrin"</span>))
</pre>
</div>
</details>

<details id='wttrin,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#wttrin,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! wttrin
  <span class="org-builtin">:commands</span> wttrin)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-spray" class="outline-4">
<h4 id="spray"><span class="section-number-4">3.5.4.</span> Spray<a aria-hidden="true" href="#spray">#</a> </h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
Why not flash words on the screen. Why not &#x2014; hey, it could be fun.
</p>
<details id='spray,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#spray,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> spray <span class="org-builtin">:pin</span> <span class="org-string">"74d9dcfa2e8b38f96a43de9ab0eb13364300cb46"</span>
  <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"emacsmirror/spray"</span>)) <span class="org-comment-delimiter">; </span><span class="org-comment">sr.ht can be flaky</span>
</pre>
</div>
</details>

<p>
It would be nice if Spray's default speed suited me better, and the keybindings
worked in evil mode. Let's do that and make the display slightly nicer while
we're at it.
</p>

<details id='spray,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#spray,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! spray
  <span class="org-builtin">:commands</span> spray-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> spray-wpm 600
        spray-height 800)
  (<span class="org-keyword">defun</span> <span class="org-function-name">spray-mode-hide-cursor</span> ()
    <span class="org-doc">"Hide or unhide the cursor as is appropriate."</span>
    (<span class="org-keyword">if</span> spray-mode
        (<span class="org-keyword">setq-local</span> spray--last-evil-cursor-state evil-normal-state-cursor
                    evil-normal-state-cursor '(nil))
      (<span class="org-keyword">setq-local</span> evil-normal-state-cursor spray--last-evil-cursor-state)))
  (add-hook 'spray-mode-hook #'spray-mode-hide-cursor)
  (map! <span class="org-builtin">:map</span> spray-mode-map
        <span class="org-string">"&lt;return&gt;"</span> #'spray-start/stop
        <span class="org-string">"f"</span> #'spray-faster
        <span class="org-string">"s"</span> #'spray-slower
        <span class="org-string">"t"</span> #'spray-time
        <span class="org-string">"&lt;right&gt;"</span> #'spray-forward-word
        <span class="org-string">"h"</span> #'spray-forward-word
        <span class="org-string">"&lt;left&gt;"</span> #'spray-backward-word
        <span class="org-string">"l"</span> #'spray-backward-word
        <span class="org-string">"q"</span> #'spray-quit))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-elcord" class="outline-4">
<h4 id="elcord"><span class="section-number-4">3.5.5.</span> Elcord<a aria-hidden="true" href="#elcord">#</a> </h4>
<div class="outline-text-4" id="text-3-5-5">
<p>
What's even the point of using Emacs unless you're constantly telling everyone
about it?
</p>
<details id='elcord,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#elcord,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> elcord <span class="org-builtin">:pin</span> <span class="org-string">"deeb22f84378b382f09e78f1718bc4c39a3582b8"</span>)
</pre>
</div>
</details>

<details id='elcord,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#elcord,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! elcord
  <span class="org-builtin">:commands</span> elcord-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> elcord-use-major-mode-as-main-icon t))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-file-types" class="outline-3">
<h3 id="file-types"><span class="section-number-3">3.6.</span> File types<a aria-hidden="true" href="#file-types">#</a> </h3>
<div class="outline-text-3" id="text-3-6">
</div>
<div id="outline-container-systemd" class="outline-4">
<h4 id="systemd"><span class="section-number-4">3.6.1.</span> Systemd<a aria-hidden="true" href="#systemd">#</a> </h4>
<div class="outline-text-4" id="text-3-6-1">
<p>
For editing systemd unit files
</p>
<details id='systemd,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#systemd,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> systemd <span class="org-builtin">:pin</span> <span class="org-string">"8742607120fbc440821acbc351fda1e8e68a8806"</span>)
</pre>
</div>
</details>

<details id='systemd,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#systemd,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! systemd
  <span class="org-builtin">:defer</span> t)
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
<div id="outline-container-applications" class="outline-2">
<h2 id="applications"><span class="section-number-2">4.</span> Applications<a aria-hidden="true" href="#applications">#</a> </h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-ebooks" class="outline-3">
<h3 id="ebooks"><span class="section-number-3">4.1.</span> Ebooks<a aria-hidden="true" href="#ebooks">#</a> </h3>
<div class="outline-text-3" id="text-4-1">
<p>

</p>

<p>
For managing my ebooks, I'll hook into the well-established ebook library
manager <a href="https://calibre-ebook.com/">calibre</a>. A number of Emacs clients for this exist, but this seems like a
good option.
</p>
<details id='ebooks,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ebooks,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> calibredb <span class="org-builtin">:pin</span> <span class="org-string">"7d33947462c77f9e87e8078fa7b7b398feeef0f7"</span>)
</pre>
</div>
</details>

<p>
Then for reading them, the only currently viable options seems to be <a href="https://depp.brause.cc/nov.el/">nov.el</a>.
</p>
<details id='ebooks,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ebooks,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> nov <span class="org-builtin">:pin</span> <span class="org-string">"b37d9380752e541db3f4b947c219ca54d50ca273"</span>)
</pre>
</div>
</details>

<p>
Together these should give me a rather good experience reading ebooks.
</p>

<p>
<kbd>calibredb</kbd> lets us use calibre through Emacs, because who wouldn't want to use
something through Emacs?
</p>
<details id='ebooks,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ebooks,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! calibredb
  <span class="org-builtin">:commands</span> calibredb
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> calibredb-root-dir <span class="org-string">"~/.local/share/calibre-library"</span>
        calibredb-db-dir (expand-file-name <span class="org-string">"metadata.db"</span> calibredb-root-dir))
  (map! <span class="org-builtin">:map</span> calibredb-show-mode-map
        <span class="org-builtin">:ne</span> <span class="org-string">"?"</span> #'calibredb-entry-dispatch
        <span class="org-builtin">:ne</span> <span class="org-string">"o"</span> #'calibredb-find-file
        <span class="org-builtin">:ne</span> <span class="org-string">"O"</span> #'calibredb-find-file-other-frame
        <span class="org-builtin">:ne</span> <span class="org-string">"V"</span> #'calibredb-open-file-with-default-tool
        <span class="org-builtin">:ne</span> <span class="org-string">"s"</span> #'calibredb-set-metadata-dispatch
        <span class="org-builtin">:ne</span> <span class="org-string">"e"</span> #'calibredb-export-dispatch
        <span class="org-builtin">:ne</span> <span class="org-string">"q"</span> #'calibredb-entry-quit
        <span class="org-builtin">:ne</span> <span class="org-string">"."</span> #'calibredb-open-dired
        <span class="org-builtin">:ne</span> [tab] #'calibredb-toggle-view-at-point
        <span class="org-builtin">:ne</span> <span class="org-string">"M-t"</span> #'calibredb-set-metadata--tags
        <span class="org-builtin">:ne</span> <span class="org-string">"M-a"</span> #'calibredb-set-metadata--author_sort
        <span class="org-builtin">:ne</span> <span class="org-string">"M-A"</span> #'calibredb-set-metadata--authors
        <span class="org-builtin">:ne</span> <span class="org-string">"M-T"</span> #'calibredb-set-metadata--title
        <span class="org-builtin">:ne</span> <span class="org-string">"M-c"</span> #'calibredb-set-metadata--comments)
  (map! <span class="org-builtin">:map</span> calibredb-search-mode-map
        <span class="org-builtin">:ne</span> [mouse-3] #'calibredb-search-mouse
        <span class="org-builtin">:ne</span> <span class="org-string">"RET"</span> #'calibredb-find-file
        <span class="org-builtin">:ne</span> <span class="org-string">"?"</span> #'calibredb-dispatch
        <span class="org-builtin">:ne</span> <span class="org-string">"a"</span> #'calibredb-add
        <span class="org-builtin">:ne</span> <span class="org-string">"A"</span> #'calibredb-add-dir
        <span class="org-builtin">:ne</span> <span class="org-string">"c"</span> #'calibredb-clone
        <span class="org-builtin">:ne</span> <span class="org-string">"d"</span> #'calibredb-remove
        <span class="org-builtin">:ne</span> <span class="org-string">"D"</span> #'calibredb-remove-marked-items
        <span class="org-builtin">:ne</span> <span class="org-string">"j"</span> #'calibredb-next-entry
        <span class="org-builtin">:ne</span> <span class="org-string">"k"</span> #'calibredb-previous-entry
        <span class="org-builtin">:ne</span> <span class="org-string">"l"</span> #'calibredb-virtual-library-list
        <span class="org-builtin">:ne</span> <span class="org-string">"L"</span> #'calibredb-library-list
        <span class="org-builtin">:ne</span> <span class="org-string">"n"</span> #'calibredb-virtual-library-next
        <span class="org-builtin">:ne</span> <span class="org-string">"N"</span> #'calibredb-library-next
        <span class="org-builtin">:ne</span> <span class="org-string">"p"</span> #'calibredb-virtual-library-previous
        <span class="org-builtin">:ne</span> <span class="org-string">"P"</span> #'calibredb-library-previous
        <span class="org-builtin">:ne</span> <span class="org-string">"s"</span> #'calibredb-set-metadata-dispatch
        <span class="org-builtin">:ne</span> <span class="org-string">"S"</span> #'calibredb-switch-library
        <span class="org-builtin">:ne</span> <span class="org-string">"o"</span> #'calibredb-find-file
        <span class="org-builtin">:ne</span> <span class="org-string">"O"</span> #'calibredb-find-file-other-frame
        <span class="org-builtin">:ne</span> <span class="org-string">"v"</span> #'calibredb-view
        <span class="org-builtin">:ne</span> <span class="org-string">"V"</span> #'calibredb-open-file-with-default-tool
        <span class="org-builtin">:ne</span> <span class="org-string">"."</span> #'calibredb-open-dired
        <span class="org-builtin">:ne</span> <span class="org-string">"b"</span> #'calibredb-catalog-bib-dispatch
        <span class="org-builtin">:ne</span> <span class="org-string">"e"</span> #'calibredb-export-dispatch
        <span class="org-builtin">:ne</span> <span class="org-string">"r"</span> #'calibredb-search-refresh-and-clear-filter
        <span class="org-builtin">:ne</span> <span class="org-string">"R"</span> #'calibredb-search-clear-filter
        <span class="org-builtin">:ne</span> <span class="org-string">"q"</span> #'calibredb-search-quit
        <span class="org-builtin">:ne</span> <span class="org-string">"m"</span> #'calibredb-mark-and-forward
        <span class="org-builtin">:ne</span> <span class="org-string">"f"</span> #'calibredb-toggle-favorite-at-point
        <span class="org-builtin">:ne</span> <span class="org-string">"x"</span> #'calibredb-toggle-archive-at-point
        <span class="org-builtin">:ne</span> <span class="org-string">"h"</span> #'calibredb-toggle-highlight-at-point
        <span class="org-builtin">:ne</span> <span class="org-string">"u"</span> #'calibredb-unmark-and-forward
        <span class="org-builtin">:ne</span> <span class="org-string">"i"</span> #'calibredb-edit-annotation
        <span class="org-builtin">:ne</span> <span class="org-string">"DEL"</span> #'calibredb-unmark-and-backward
        <span class="org-builtin">:ne</span> [backtab] #'calibredb-toggle-view
        <span class="org-builtin">:ne</span> [tab] #'calibredb-toggle-view-at-point
        <span class="org-builtin">:ne</span> <span class="org-string">"M-n"</span> #'calibredb-show-next-entry
        <span class="org-builtin">:ne</span> <span class="org-string">"M-p"</span> #'calibredb-show-previous-entry
        <span class="org-builtin">:ne</span> <span class="org-string">"/"</span> #'calibredb-search-live-filter
        <span class="org-builtin">:ne</span> <span class="org-string">"M-t"</span> #'calibredb-set-metadata--tags
        <span class="org-builtin">:ne</span> <span class="org-string">"M-a"</span> #'calibredb-set-metadata--author_sort
        <span class="org-builtin">:ne</span> <span class="org-string">"M-A"</span> #'calibredb-set-metadata--authors
        <span class="org-builtin">:ne</span> <span class="org-string">"M-T"</span> #'calibredb-set-metadata--title
        <span class="org-builtin">:ne</span> <span class="org-string">"M-c"</span> #'calibredb-set-metadata--comments))
</pre>
</div>
</details>

<p>
Then, to actually read the ebooks we use <kbd>nov</kbd>.
</p>


<figure id="orga798ea7">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/nov.png" alt="Excerpt of the GNU Emacs manual viewed through nov.el" class="invertible">

</figure>

<details id='ebooks,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ebooks,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! nov
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.epub\\'"</span> . nov-mode)
  <span class="org-builtin">:config</span>
  (map! <span class="org-builtin">:map</span> nov-mode-map
        <span class="org-builtin">:n</span> <span class="org-string">"RET"</span> #'nov-scroll-up)

  (advice-add 'nov-render-title <span class="org-builtin">:override</span> #'ignore)

  (<span class="org-keyword">defun</span> <span class="org-function-name">+nov-mode-setup</span> ()
    <span class="org-doc">"Tweak nov-mode to our liking."</span>
    (face-remap-add-relative 'variable-pitch
                             <span class="org-builtin">:family</span> <span class="org-string">"Merriweather"</span>
                             <span class="org-builtin">:height</span> 1.4
                             <span class="org-builtin">:width</span> 'semi-expanded)
    (face-remap-add-relative 'default <span class="org-builtin">:height</span> 1.3)
    (variable-pitch-mode 1)
    (<span class="org-keyword">setq-local</span> line-spacing 0.2
                next-screen-context-lines 4
                shr-use-colors nil)
    (<span class="org-keyword">when</span> (<span class="org-keyword">require</span> '<span class="org-constant">visual-fill-column</span> nil t)
      (<span class="org-keyword">setq-local</span> visual-fill-column-center-text t
                  visual-fill-column-width 64
                  nov-text-width 106)
      (visual-fill-column-mode 1))
    (<span class="org-keyword">when</span> (<span class="org-keyword">featurep</span> '<span class="org-constant">hl-line-mode</span>)
      (hl-line-mode -1))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Re-render with new display settings</span>
    (nov-render-document)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Look up words with the dictionary.</span>
    (add-to-list '+lookup-definition-functions #'+lookup/dictionary-definition))

  (add-hook 'nov-mode-hook #'+nov-mode-setup))
</pre>
</div>
</details>

<p>
To enhance the reading experience, we can create a nice minimal modeline, with
just the basic bare minimum, information about the book/chapter, and possibly
currently playing media.
</p>

<details id='ebooks,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ebooks,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> doom-modeline
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">doom-modeline-nov-title-max-length</span> 40)
  (doom-modeline-def-segment nov-author
    (propertize
     (cdr (assoc 'creator nov-metadata))
     'face (doom-modeline-face 'doom-modeline-project-parent-dir)))
  (doom-modeline-def-segment nov-title
    (<span class="org-keyword">let</span> ((title (<span class="org-keyword">or</span> (cdr (assoc 'title nov-metadata)) <span class="org-string">""</span>)))
      (<span class="org-keyword">if</span> (&lt;= (length title) doom-modeline-nov-title-max-length)
          (concat <span class="org-string">" "</span> title)
        (propertize
         (concat <span class="org-string">" "</span> (truncate-string-to-width title doom-modeline-nov-title-max-length nil nil t))
         'help-echo title))))
  (doom-modeline-def-segment nov-current-page
    (<span class="org-keyword">let</span> ((words (count-words (point-min) (point-max))))
      (propertize
       (format <span class="org-string">" %d/%d"</span>
               (1+ nov-documents-index)
               (length nov-documents))
       'face (doom-modeline-face 'doom-modeline-info)
       'help-echo (<span class="org-keyword">if</span> (= words 1) <span class="org-string">"1 word in this chapter"</span>
                    (format <span class="org-string">"%s words in this chapter"</span> words)))))
  (doom-modeline-def-segment scroll-percentage-subtle
    (concat
     (doom-modeline-spc)
     (propertize (format-mode-line '(<span class="org-string">""</span> doom-modeline-percent-position <span class="org-string">"%%"</span>))
                 'face (doom-modeline-face 'shadow)
                 'help-echo <span class="org-string">"Buffer percentage"</span>)))

  (doom-modeline-def-modeline 'nov
    '(workspace-name window-number nov-author nov-title nov-current-page scroll-percentage-subtle)
    '(media-player misc-info major-mode time))

  (add-to-list 'doom-modeline-mode-alist '(nov-mode . nov)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-calculator" class="outline-3">
<h3 id="calculator"><span class="section-number-3">4.2.</span> Calculator<a aria-hidden="true" href="#calculator">#</a> </h3>
<div class="outline-text-3" id="text-4-2">
<p>
Emacs includes the venerable <kbd>calc</kbd>, which is a pretty impressive <span class='acr'>RPN</span> (Reverse
Polish Notation) calculator. However, we can do a bit to improve the experience.
</p>
</div>
<div id="outline-container-calctex" class="outline-4">
<h4 id="calctex"><span class="section-number-4">4.2.1.</span> CalcTeX<a aria-hidden="true" href="#calctex">#</a> </h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Everybody knows that mathematical expressions look best with LaTeX, so <kbd>calc</kbd>'s
ability to create LaTeX representations of its expressions provides a lovely
opportunity which is taken advantage of in the CalcTeX package.
</p>

<details id='calctex,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#calctex,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> calctex <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"johnbcoughlin/calctex"</span>
                           <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span> <span class="org-string">"calctex/*.el"</span> <span class="org-string">"calctex-contrib/*.el"</span> <span class="org-string">"org-calctex/*.el"</span> <span class="org-string">"vendor"</span>))
  <span class="org-builtin">:pin</span> <span class="org-string">"67a2e76847a9ea9eff1f8e4eb37607f84b380ebb"</span>)
</pre>
</div>
</details>


<figure id="orge9bf0ec">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/calc-with-calctex.png" alt="Demonstration of calc, prettified by calctex." class="invertible">

</figure>

<p>
We'd like to use CalcTeX too, so let's set that up, and fix some glaring
inadequacies &#x2014; why on earth would you commit a hard-coded path to an executable
that <i>only works on your local machine</i>, consequently breaking the package for
everyone else!?
</p>

<details id='calctex,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#calctex,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! calctex
  <span class="org-builtin">:commands</span> calctex-mode
  <span class="org-builtin">:init</span>
  (add-hook 'calc-mode-hook #'calctex-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> calctex-additional-latex-packages <span class="org-string">"</span>
<span class="org-string">\\usepackage[usenames]{xcolor}</span>
<span class="org-string">\\usepackage{soul}</span>
<span class="org-string">\\usepackage{adjustbox}</span>
<span class="org-string">\\usepackage{amsmath}</span>
<span class="org-string">\\usepackage{amssymb}</span>
<span class="org-string">\\usepackage{siunitx}</span>
<span class="org-string">\\usepackage{cancel}</span>
<span class="org-string">\\usepackage{mathtools}</span>
<span class="org-string">\\usepackage{mathalpha}</span>
<span class="org-string">\\usepackage{xparse}</span>
<span class="org-string">\\usepackage{arevmath}"</span>
        calctex-additional-latex-macros
        (concat calctex-additional-latex-macros
                <span class="org-string">"\n\\let\\evalto\\Rightarrow"</span>))
  (<span class="org-keyword">defadvice!</span> no-messaging-a (orig-fn <span class="org-type">&amp;rest</span> args)
    <span class="org-builtin">:around</span> #'calctex-default-dispatching-render-process
    (<span class="org-keyword">let</span> ((inhibit-message t) message-log-max)
      (apply orig-fn args)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Fix hardcoded dvichop path (whyyyyyyy)</span>
  (<span class="org-keyword">let</span> ((vendor-folder (concat (file-truename doom-local-dir)
                               <span class="org-string">"straight/"</span>
                               (format <span class="org-string">"build-%s"</span> emacs-version)
                               <span class="org-string">"/calctex/vendor/"</span>)))
    (<span class="org-keyword">setq</span> calctex-dvichop-sty (concat vendor-folder <span class="org-string">"texd/dvichop"</span>)
          calctex-dvichop-bin (concat vendor-folder <span class="org-string">"texd/dvichop"</span>)))
  (<span class="org-keyword">unless</span> (file-exists-p calctex-dvichop-bin)
    (message <span class="org-string">"CalcTeX: Building dvichop binary"</span>)
    (<span class="org-keyword">let</span> ((default-directory (file-name-directory calctex-dvichop-bin)))
      (call-process <span class="org-string">"make"</span> nil nil nil))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-defaults" class="outline-4">
<h4 id="defaults"><span class="section-number-4">4.2.2.</span> Defaults<a aria-hidden="true" href="#defaults">#</a> </h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
Any sane person prefers radians and exact values.
</p>

<details id='defaults,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#defaults,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> calc-angle-mode 'rad  <span class="org-comment-delimiter">; </span><span class="org-comment">radians are rad</span>
      calc-symbolic-mode t) <span class="org-comment-delimiter">; </span><span class="org-comment">keeps expressions like \sqrt{2} irrational for as long as possible</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-embedded-calc" class="outline-4">
<h4 id="embedded-calc"><span class="section-number-4">4.2.3.</span> Embedded calc<a aria-hidden="true" href="#embedded-calc">#</a> </h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
Embedded calc is a lovely feature which let's us use calc to operate on LaTeX
maths expressions. The standard keybinding is a bit janky however (<kbd>C-x * e</kbd>), so
we'll add a localleader-based alternative.
</p>

<details id='embedded-calc,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#embedded-calc,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:map</span> calc-mode-map
      <span class="org-builtin">:after</span> calc
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"Embedded calc (toggle)"</span> <span class="org-string">"e"</span> #'calc-embedded)
(map! <span class="org-builtin">:map</span> org-mode-map
      <span class="org-builtin">:after</span> org
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"Embedded calc (toggle)"</span> <span class="org-string">"E"</span> #'calc-embedded)
(map! <span class="org-builtin">:map</span> latex-mode-map
      <span class="org-builtin">:after</span> latex
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"Embedded calc (toggle)"</span> <span class="org-string">"e"</span> #'calc-embedded)
</pre>
</div>
</details>

<p>
Unfortunately this operates without the (rather informative) calculator and
trail buffers, but we can advice it that we would rather like those in a side
panel.
</p>

<details id='embedded-calc,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#embedded-calc,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">calc-embedded-trail-window</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">calc-embedded-calculator-window</span> nil)

(<span class="org-keyword">defadvice!</span> calc-embedded-with-side-pannel (<span class="org-type">&amp;rest</span> _)
  <span class="org-builtin">:after</span> #'calc-do-embedded
  (<span class="org-keyword">when</span> calc-embedded-trail-window
    (<span class="org-keyword">ignore-errors</span>
      (delete-window calc-embedded-trail-window))
    (<span class="org-keyword">setq</span> calc-embedded-trail-window nil))
  (<span class="org-keyword">when</span> calc-embedded-calculator-window
    (<span class="org-keyword">ignore-errors</span>
      (delete-window calc-embedded-calculator-window))
    (<span class="org-keyword">setq</span> calc-embedded-calculator-window nil))
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> calc-embedded-info
             (&gt; (* (window-width) (window-height)) 1200))
    (<span class="org-keyword">let</span> ((main-window (selected-window))
          (vertical-p (&gt; (window-width) 80)))
      (select-window
       (<span class="org-keyword">setq</span> calc-embedded-trail-window
             (<span class="org-keyword">if</span> vertical-p
                 (split-window-horizontally (- (max 30 (/ (window-width) 3))))
               (split-window-vertically (- (max 8 (/ (window-height) 4)))))))
      (switch-to-buffer <span class="org-string">"*Calc Trail*"</span>)
      (select-window
       (<span class="org-keyword">setq</span> calc-embedded-calculator-window
             (<span class="org-keyword">if</span> vertical-p
                 (split-window-vertically -6)
               (split-window-horizontally (- (/ (window-width) 2))))))
      (switch-to-buffer <span class="org-string">"*Calculator*"</span>)
      (select-window main-window))))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-newsfeed" class="outline-3">
<h3 id="newsfeed"><span class="section-number-3">4.3.</span> Newsfeed<a aria-hidden="true" href="#newsfeed">#</a> </h3>
<div class="outline-text-3" id="text-4-3">
<p>
<span class='acr'>RSS</span> feeds are still a thing. Why not make use of them with <kbd>elfeed</kbd>.
I really like what <a href="https://github.com/fuxialexander/doom-emacs-private-xfu/tree/master/modules/app/rss">fuxialexander</a> has going on, but I don't think I need a custom
module. Let's just try to patch on the main things I like the look of.
</p>


<figure id="orgf9d7469">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/elfeed.png" alt="Example elfeed entry" class="invertible">

</figure>
</div>
<div id="outline-container-keybindings" class="outline-4">
<h4 id="keybindings"><span class="section-number-4">4.3.1.</span> Keybindings<a aria-hidden="true" href="#keybindings">#</a> </h4>
<div class="outline-text-4" id="text-4-3-1">
<details id='keybindings,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#keybindings,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:map</span> elfeed-search-mode-map
      <span class="org-builtin">:after</span> elfeed-search
      [remap kill-this-buffer] <span class="org-string">"q"</span>
      [remap kill-buffer] <span class="org-string">"q"</span>
      <span class="org-builtin">:n</span> doom-leader-key nil
      <span class="org-builtin">:n</span> <span class="org-string">"q"</span> #'+rss/quit
      <span class="org-builtin">:n</span> <span class="org-string">"e"</span> #'elfeed-update
      <span class="org-builtin">:n</span> <span class="org-string">"r"</span> #'elfeed-search-untag-all-unread
      <span class="org-builtin">:n</span> <span class="org-string">"u"</span> #'elfeed-search-tag-all-unread
      <span class="org-builtin">:n</span> <span class="org-string">"s"</span> #'elfeed-search-live-filter
      <span class="org-builtin">:n</span> <span class="org-string">"RET"</span> #'elfeed-search-show-entry
      <span class="org-builtin">:n</span> <span class="org-string">"p"</span> #'elfeed-show-pdf
      <span class="org-builtin">:n</span> <span class="org-string">"+"</span> #'elfeed-search-tag-all
      <span class="org-builtin">:n</span> <span class="org-string">"-"</span> #'elfeed-search-untag-all
      <span class="org-builtin">:n</span> <span class="org-string">"S"</span> #'elfeed-search-set-filter
      <span class="org-builtin">:n</span> <span class="org-string">"b"</span> #'elfeed-search-browse-url
      <span class="org-builtin">:n</span> <span class="org-string">"y"</span> #'elfeed-search-yank)
(map! <span class="org-builtin">:map</span> elfeed-show-mode-map
      <span class="org-builtin">:after</span> elfeed-show
      [remap kill-this-buffer] <span class="org-string">"q"</span>
      [remap kill-buffer] <span class="org-string">"q"</span>
      <span class="org-builtin">:n</span> doom-leader-key nil
      <span class="org-builtin">:nm</span> <span class="org-string">"q"</span> #'+rss/delete-pane
      <span class="org-builtin">:nm</span> <span class="org-string">"o"</span> #'ace-link-elfeed
      <span class="org-builtin">:nm</span> <span class="org-string">"RET"</span> #'org-ref-elfeed-add
      <span class="org-builtin">:nm</span> <span class="org-string">"n"</span> #'elfeed-show-next
      <span class="org-builtin">:nm</span> <span class="org-string">"N"</span> #'elfeed-show-prev
      <span class="org-builtin">:nm</span> <span class="org-string">"p"</span> #'elfeed-show-pdf
      <span class="org-builtin">:nm</span> <span class="org-string">"+"</span> #'elfeed-show-tag
      <span class="org-builtin">:nm</span> <span class="org-string">"-"</span> #'elfeed-show-untag
      <span class="org-builtin">:nm</span> <span class="org-string">"s"</span> #'elfeed-show-new-live-search
      <span class="org-builtin">:nm</span> <span class="org-string">"y"</span> #'elfeed-show-yank)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-usability-enhancements" class="outline-4">
<h4 id="usability-enhancements"><span class="section-number-4">4.3.2.</span> Usability enhancements<a aria-hidden="true" href="#usability-enhancements">#</a> </h4>
<div class="outline-text-4" id="text-4-3-2">
<details id='usability-enhancements,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#usability-enhancements,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> elfeed-search
  (set-evil-initial-state! 'elfeed-search-mode 'normal))
(<span class="org-keyword">after!</span> elfeed-show-mode
  (set-evil-initial-state! 'elfeed-show-mode   'normal))

(<span class="org-keyword">after!</span> evil-snipe
  (<span class="org-keyword">push</span> 'elfeed-show-mode   evil-snipe-disabled-modes)
  (<span class="org-keyword">push</span> 'elfeed-search-mode evil-snipe-disabled-modes))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-visual-enhancements" class="outline-4">
<h4 id="visual-enhancements"><span class="section-number-4">4.3.3.</span> Visual enhancements<a aria-hidden="true" href="#visual-enhancements">#</a> </h4>
<div class="outline-text-4" id="text-4-3-3">
<details id='visual-enhancements,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#visual-enhancements,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> elfeed

  (elfeed-org)
  (use-package! elfeed-link)

  (<span class="org-keyword">setq</span> elfeed-search-filter <span class="org-string">"@1-week-ago +unread"</span>
        elfeed-search-print-entry-function '+rss/elfeed-search-print-entry
        elfeed-search-title-min-width 80
        elfeed-show-entry-switch #'pop-to-buffer
        elfeed-show-entry-delete #'+rss/delete-pane
        elfeed-show-refresh-function #'+rss/elfeed-show-refresh--better-style
        shr-max-image-proportion 0.6)

  (<span class="org-keyword">add-hook!</span> 'elfeed-show-mode-hook (hide-mode-line-mode 1))
  (<span class="org-keyword">add-hook!</span> 'elfeed-search-update-hook #'hide-mode-line-mode)

  (<span class="org-keyword">defface</span> <span class="org-variable-name">elfeed-show-title-face</span> '((t (<span class="org-builtin">:weight</span> ultrabold <span class="org-builtin">:slant</span> italic <span class="org-builtin">:height</span> 1.5)))
    <span class="org-doc">"title face in elfeed show buffer"</span>
    <span class="org-builtin">:group</span> 'elfeed)
  (<span class="org-keyword">defface</span> <span class="org-variable-name">elfeed-show-author-face</span> `((t (<span class="org-builtin">:weight</span> light)))
    <span class="org-doc">"title face in elfeed show buffer"</span>
    <span class="org-builtin">:group</span> 'elfeed)
  (set-face-attribute 'elfeed-search-title-face nil
                      <span class="org-builtin">:foreground</span> 'nil
                      <span class="org-builtin">:weight</span> 'light)

  (<span class="org-keyword">defadvice!</span> +rss-elfeed-wrap-h-nicer ()
    <span class="org-doc">"Enhances an elfeed entry's readability by wrapping it to a width of</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">fill-column</span></span><span class="org-doc">' and centering it with `</span><span class="org-doc"><span class="org-constant">visual-fill-column-mode</span></span><span class="org-doc">'."</span>
    <span class="org-builtin">:override</span> #'+rss-elfeed-wrap-h
    (<span class="org-keyword">setq-local</span> truncate-lines nil
                shr-width 120
                visual-fill-column-center-text t
                default-text-properties '(line-height 1.1))
    (<span class="org-keyword">let</span> ((inhibit-read-only t)
          (inhibit-modification-hooks t))
      (visual-fill-column-mode)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(setq-local shr-current-font '(:family "Merriweather" :height 1.2))</span>
      (set-buffer-modified-p nil)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+rss/elfeed-search-print-entry</span> (entry)
    <span class="org-doc">"Print ENTRY to the buffer."</span>
    (<span class="org-keyword">let*</span> ((elfeed-goodies/tag-column-width 40)
           (elfeed-goodies/feed-source-column-width 30)
           (title (<span class="org-keyword">or</span> (elfeed-meta entry <span class="org-builtin">:title</span>) (elfeed-entry-title entry) <span class="org-string">""</span>))
           (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
           (feed (elfeed-entry-feed entry))
           (feed-title
            (<span class="org-keyword">when</span> feed
              (<span class="org-keyword">or</span> (elfeed-meta feed <span class="org-builtin">:title</span>) (elfeed-feed-title feed))))
           (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
           (tags-str (concat (mapconcat 'identity tags <span class="org-string">","</span>)))
           (title-width (- (window-width) elfeed-goodies/feed-source-column-width
                           elfeed-goodies/tag-column-width 4))

           (tag-column (elfeed-format-column
                        tags-str (elfeed-clamp (length tags-str)
                                               elfeed-goodies/tag-column-width
                                               elfeed-goodies/tag-column-width)
                        <span class="org-builtin">:left</span>))
           (feed-column (elfeed-format-column
                         feed-title (elfeed-clamp elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width)
                         <span class="org-builtin">:left</span>)))

      (insert (propertize feed-column 'face 'elfeed-search-feed-face) <span class="org-string">" "</span>)
      (insert (propertize tag-column 'face 'elfeed-search-tag-face) <span class="org-string">" "</span>)
      (insert (propertize title 'face title-faces 'kbd-help title))
      (<span class="org-keyword">setq-local</span> line-spacing 0.2)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+rss/elfeed-show-refresh--better-style</span> ()
    <span class="org-doc">"Update the buffer to match the selected entry, using a mail-style."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">let*</span> ((inhibit-read-only t)
           (title (elfeed-entry-title elfeed-show-entry))
           (date (seconds-to-time (elfeed-entry-date elfeed-show-entry)))
           (author (elfeed-meta elfeed-show-entry <span class="org-builtin">:author</span>))
           (link (elfeed-entry-link elfeed-show-entry))
           (tags (elfeed-entry-tags elfeed-show-entry))
           (tagsstr (mapconcat #'symbol-name tags <span class="org-string">", "</span>))
           (nicedate (format-time-string <span class="org-string">"%a, %e %b %Y %T %Z"</span> date))
           (content (elfeed-deref (elfeed-entry-content elfeed-show-entry)))
           (type (elfeed-entry-content-type elfeed-show-entry))
           (feed (elfeed-entry-feed elfeed-show-entry))
           (feed-title (elfeed-feed-title feed))
           (base (<span class="org-keyword">and</span> feed (elfeed-compute-base (elfeed-feed-url feed)))))
      (erase-buffer)
      (insert <span class="org-string">"\n"</span>)
      (insert (format <span class="org-string">"%s\n\n"</span> (propertize title 'face 'elfeed-show-title-face)))
      (insert (format <span class="org-string">"%s\t"</span> (propertize feed-title 'face 'elfeed-search-feed-face)))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> author elfeed-show-entry-author)
        (insert (format <span class="org-string">"%s\n"</span> (propertize author 'face 'elfeed-show-author-face))))
      (insert (format <span class="org-string">"%s\n\n"</span> (propertize nicedate 'face 'elfeed-log-date-face)))
      (<span class="org-keyword">when</span> tags
        (insert (format <span class="org-string">"%s\n"</span>
                        (propertize tagsstr 'face 'elfeed-search-tag-face))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(insert (propertize "Link: " 'face 'message-header-name))</span>
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(elfeed-insert-link link link)</span>
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(insert "\n")</span>
      (<span class="org-keyword">cl-loop</span> for enclosure in (elfeed-entry-enclosures elfeed-show-entry)
               do (insert (propertize <span class="org-string">"Enclosure: "</span> 'face 'message-header-name))
               do (elfeed-insert-link (car enclosure))
               do (insert <span class="org-string">"\n"</span>))
      (insert <span class="org-string">"\n"</span>)
      (<span class="org-keyword">if</span> content
          (<span class="org-keyword">if</span> (eq type 'html)
              (elfeed-insert-html content base)
            (insert content))
        (insert (propertize <span class="org-string">"(empty)\n"</span> 'face 'italic)))
      (goto-char (point-min))))

  )
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-functionality-enhancements" class="outline-4">
<h4 id="functionality-enhancements"><span class="section-number-4">4.3.4.</span> Functionality enhancements<a aria-hidden="true" href="#functionality-enhancements">#</a> </h4>
<div class="outline-text-4" id="text-4-3-4">
<details id='functionality-enhancements,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#functionality-enhancements,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> elfeed-show
  (<span class="org-keyword">require</span> '<span class="org-constant">url</span>)

  (<span class="org-keyword">defvar</span> <span class="org-variable-name">elfeed-pdf-dir</span>
    (expand-file-name <span class="org-string">"pdfs/"</span>
                      (file-name-directory (directory-file-name elfeed-enclosure-default-dir))))

  (<span class="org-keyword">defvar</span> <span class="org-variable-name">elfeed-link-pdfs</span>
    '((<span class="org-string">"https://www.jstatsoft.org/index.php/jss/article/view/v0</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> . <span class="org-string">"https://www.jstatsoft.org/index.php/jss/article/view/v0\\1/v\\1.pdf"</span>)
      (<span class="org-string">"http://arxiv.org/abs/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> . <span class="org-string">"https://arxiv.org/pdf/\\1.pdf"</span>))
    <span class="org-doc">"List of alists of the form (REGEX-FOR-LINK . FORM-FOR-PDF)"</span>)

  (<span class="org-keyword">defun</span> <span class="org-function-name">elfeed-show-pdf</span> (entry)
    (<span class="org-keyword">interactive</span>
     (list (<span class="org-keyword">or</span> elfeed-show-entry (elfeed-search-selected <span class="org-builtin">:ignore-region</span>))))
    (<span class="org-keyword">let</span> ((link (elfeed-entry-link entry))
          (feed-name (plist-get (elfeed-feed-meta (elfeed-entry-feed entry)) <span class="org-builtin">:title</span>))
          (title (elfeed-entry-title entry))
          (file-view-function
           (<span class="org-keyword">lambda</span> (f)
             (<span class="org-keyword">when</span> elfeed-show-entry
               (elfeed-kill-buffer))
             (pop-to-buffer (find-file-noselect f))))
          pdf)

      (<span class="org-keyword">let</span> ((file (expand-file-name
                   (concat (subst-char-in-string ?/ ?, title) <span class="org-string">".pdf"</span>)
                   (expand-file-name (subst-char-in-string ?/ ?, feed-name)
                                     elfeed-pdf-dir))))
        (<span class="org-keyword">if</span> (file-exists-p file)
            (funcall file-view-function file)
          (<span class="org-keyword">dolist</span> (link-pdf elfeed-link-pdfs)
            (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string-match-p (car link-pdf) link)
                       (not pdf))
              (<span class="org-keyword">setq</span> pdf (replace-regexp-in-string (car link-pdf) (cdr link-pdf) link))))
          (<span class="org-keyword">if</span> (not pdf)
              (message <span class="org-string">"No associated PDF for entry"</span>)
            (message <span class="org-string">"Fetching %s"</span> pdf)
            (<span class="org-keyword">unless</span> (file-exists-p (file-name-directory file))
              (make-directory (file-name-directory file) t))
            (url-copy-file pdf file)
            (funcall file-view-function file))))))

  )
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-dictionary" class="outline-3">
<h3 id="dictionary"><span class="section-number-3">4.4.</span> Dictionary<a aria-hidden="true" href="#dictionary">#</a> </h3>
<div class="outline-text-3" id="text-4-4">
<p>
Doom already loads <kbd>define-word</kbd>, and provides it's own definition service using
<a href="https://github.com/gromnitsky/wordnut">wordnut</a>. However, using an offline dictionary possess a few compelling
advantages, namely:
</p>
<ul class="org-ul">
<li>speed</li>
<li>integration of multiple dictionaries</li>
</ul>
<p>
<a href="http://goldendict.org/">GoldenDict</a> seems like the best option currently available, but lacks a <span class='acr'>CLI</span>.
Hence, we'll fall back to <a href="https://dushistov.github.io/sdcv/">sdcv</a> (a <span class='acr'>CLI</span> version of StarDict) for now.
To interface with this, we'll use a my <kbd>lexic</kbd> package.
</p>


<figure id="orga460ade">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/lexic.png" alt="Screenshot of the lexic-mode view of &quot;literate&quot;" class="invertible">

</figure>

<details id='dictionary,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#dictionary,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> lexic <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/lexic"</span>))
</pre>
</div>
</details>

<p>
Given that a request for a <span class='acr'>CLI</span> is the <a href="https://github.com/goldendict/goldendict/issues/37">most upvoted issue</a> on GitHub for
GoldenDict, it's likely we'll be able to switch from <code>sdcv</code> to that in the future.
</p>

<p>
Since GoldenDict supports StarDict files, I expect this will be a relatively
painless switch.
</p>

<p>
We start off by loading <kbd>lexic</kbd>, then we'll integrate it into pre-existing
definition functionality (like <code>+lookup/dictionary-definition</code>).
</p>
<details id='dictionary,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#dictionary,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! lexic
  <span class="org-builtin">:commands</span> lexic-search lexic-list-dictionary
  <span class="org-builtin">:config</span>
  (map! <span class="org-builtin">:map</span> lexic-mode-map
        <span class="org-builtin">:n</span> <span class="org-string">"q"</span> #'lexic-return-from-lexic
        <span class="org-builtin">:nv</span> <span class="org-string">"RET"</span> #'lexic-search-word-at-point
        <span class="org-builtin">:n</span> <span class="org-string">"a"</span> #'outline-show-all
        <span class="org-builtin">:n</span> <span class="org-string">"h"</span> (<span class="org-keyword">cmd!</span> (outline-hide-sublevels 3))
        <span class="org-builtin">:n</span> <span class="org-string">"o"</span> #'lexic-toggle-entry
        <span class="org-builtin">:n</span> <span class="org-string">"n"</span> #'lexic-next-entry
        <span class="org-builtin">:n</span> <span class="org-string">"N"</span> (<span class="org-keyword">cmd!</span> (lexic-next-entry t))
        <span class="org-builtin">:n</span> <span class="org-string">"p"</span> #'lexic-previous-entry
        <span class="org-builtin">:n</span> <span class="org-string">"P"</span> (<span class="org-keyword">cmd!</span> (lexic-previous-entry t))
        <span class="org-builtin">:n</span> <span class="org-string">"E"</span> (<span class="org-keyword">cmd!</span> (lexic-return-from-lexic) <span class="org-comment-delimiter">; </span><span class="org-comment">expand</span>
                     (switch-to-buffer (lexic-get-buffer)))
        <span class="org-builtin">:n</span> <span class="org-string">"M"</span> (<span class="org-keyword">cmd!</span> (lexic-return-from-lexic) <span class="org-comment-delimiter">; </span><span class="org-comment">minimise</span>
                     (lexic-goto-lexic))
        <span class="org-builtin">:n</span> <span class="org-string">"C-p"</span> #'lexic-search-history-backwards
        <span class="org-builtin">:n</span> <span class="org-string">"C-n"</span> #'lexic-search-history-forwards
        <span class="org-builtin">:n</span> <span class="org-string">"/"</span> (<span class="org-keyword">cmd!</span> (call-interactively #'lexic-search))))
</pre>
</div>
</details>

<p>
Now let's use this instead of wordnet.
</p>
<details id='dictionary,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#dictionary,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +lookup/dictionary-definition-lexic (identifier <span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Look up the definition of the word at point (or selection) using `</span><span class="org-doc"><span class="org-constant">lexic-search</span></span><span class="org-doc">'."</span>
  <span class="org-builtin">:override</span> #'+lookup/dictionary-definition
  (<span class="org-keyword">interactive</span>
   (list (<span class="org-keyword">or</span> (doom-thing-at-point-or-region 'word)
             (read-string <span class="org-string">"Look up in dictionary: "</span>))
         current-prefix-arg))
  (lexic-search identifier nil nil t))
</pre>
</div>
</details>

<p>
Lastly, I want to make sure I have some dictionaries set up. I've put a tarball
of dictionaries online which we can download if none seem to be present on the
system.
</p>
<details id='dictionary,code--4' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#dictionary,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-variable-name">DIC_FOLDER</span>=${<span class="org-variable-name">STARDICT_DATA_DIR</span>:-${<span class="org-variable-name">XDG_DATA_HOME</span>:-$<span class="org-variable-name">HOME</span>/.local/share}/stardict}/dic
<span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> -d <span class="org-string">"$DIC_FOLDER"</span> ]; <span class="org-keyword">then</span>
    <span class="org-variable-name">TMP</span>=<span class="org-string">"$(mktemp -d /tmp/dict-XXX)"</span>
    <span class="org-builtin">cd</span> <span class="org-string">"$TMP"</span>
    curl -A <span class="org-string">"Mozilla/4.0"</span> -o <span class="org-string">"stardict.tar.gz"</span> <span class="org-string">"https://tecosaur.com/resources/config/stardict.tar.gz"</span>
    tar -xf <span class="org-string">"stardict.tar.gz"</span>
    rm <span class="org-string">"stardict.tar.gz"</span>
    mkdir -p <span class="org-string">"$DIC_FOLDER"</span>
    mv * <span class="org-string">"$DIC_FOLDER"</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</details>

<p>
We can also add a <kbd>doctor</kbd> dictionary check.
</p>

<details id='dictionary,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#dictionary,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">if</span> (executable-find <span class="org-string">"sdcv"</span>)
    (<span class="org-keyword">let</span> ((dict-root (concat (<span class="org-keyword">or</span> (getenv <span class="org-string">"STARDICT_DATA_DIR"</span>)
                                 (concat (<span class="org-keyword">or</span> <span class="org-string">"~/.local/share"</span>
                                             (getenv <span class="org-string">"XDG_DATA_HOME"</span>))
                                         <span class="org-string">"/stardict"</span>))
                             <span class="org-string">"/dic"</span>))
          (dicts '(<span class="org-string">"webster"</span> <span class="org-string">"synonyms"</span> <span class="org-string">"etymology"</span> <span class="org-string">"en-to-latin"</span> <span class="org-string">"hitchcock"</span> <span class="org-string">"elements"</span>)))
      (<span class="org-keyword">if</span> (file-exists-p dict-root)
          (<span class="org-keyword">dolist</span> (dict dicts)
            (<span class="org-keyword">unless</span> (file-exists-p (file-name-concat dict-root dict))
              (warn! (format <span class="org-string">"Absent sdcv dictionary: %s."</span> dict))))
        (warn! <span class="org-string">"Couldn't find any stcv dictionaries, lexic will not function"</span>)))
  (warn! <span class="org-string">"Couldn't find sdcv executable, lexic will be disabled"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-mail" class="outline-3">
<h3 id="mail"><span class="section-number-3">4.5.</span> Mail<a aria-hidden="true" href="#mail">#</a> </h3>
<div class="outline-text-3" id="text-4-5">
<p>

</p>
</div>
<div id="outline-container-fetching" class="outline-4">
<h4 id="fetching"><span class="section-number-4">4.5.1.</span> Fetching<a aria-hidden="true" href="#fetching">#</a> </h4>
<div class="outline-text-4" id="text-4-5-1">
<p>
The contenders for this seem to be:
</p>
<ul class="org-ul">
<li><a href="https://www.offlineimap.org/">OfflineIMAP</a> (<a href="https://wiki.archlinux.org/index.php/OfflineIMAP">ArchWiki page</a>)</li>
<li><a href="http://isync.sourceforge.net/mbsync.html">isync/mbsync</a> (<a href="https://wiki.archlinux.org/index.php/isync">ArchWiki page</a>)</li>
</ul>

<p>
From perusing r/emacs the prevailing opinion seems to be that
</p>
<ul class="org-ul">
<li>isync is faster</li>
<li>isync works more reliably</li>
</ul>
<p>
So let's use that.
</p>

<p>
The config was straightforward, and is located at <a href="file:///home/runner/.mbsyncrc">~/.mbsyncrc</a>.
I'm currently successfully connecting to: Gmail, office365mail, and dovecot.
I'm also shoving passwords in my <a href="file:///home/runner/.authinfo.gpg">authinfo.gpg</a> and fetching them using <code>PassCmd</code>:
</p>
<details id='fetching,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#fetching,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">gpg2 -q --for-your-eyes-only --no-tty -d ~/.authinfo.gpg | awk <span class="org-string">'/machine IMAP_SERCER login EMAIL_ADDR/ {print $NF}'</span>
</pre>
</div>
</details>

<p>
We can run <code>mbsync -a</code> in a systemd service file or something, but we can do
better than that. <a href="https://github.com/vsemyonoff/easymail#usage">vsemyonoff/easymail</a> seems like the sort of thing we want, but
is written for <kbd>notmuch</kbd> unfortunately. We can still use it for inspiration though.
Using <a href="https://gitlab.com/shackra/goimapnotify">goimapnotify</a> we should be able to sync just after new
mail. Unfortunately this means <i>yet another</i> config file :(
</p>

<p>
We install with
</p>
<details id='fetching,code--2' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#fetching,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">go get -u gitlab.com/shackra/goimapnotify
ln -s ~/.local/share/go/bin/goimapnotify ~/.local/bin/
</pre>
</div>
</details>

<p>
Here's the general plan:
</p>
<ol class="org-ol">
<li>Use <code>goimapnotify</code> to monitor mailboxes
This needs it's own set of configs, and <kbd>systemd</kbd> services, which is a pain. We
remove this pain by writing a python script (found below) to setup these
config files, and systemd services by parsing the  <a href="file:///home/runner/.mbsyncrc">~/.mbsyncrc</a> file.</li>
<li>On new mail, call <code>mbsync --pull --new ACCOUNT:BOX</code>
We try to be as specific as possible, so <code>mbsync</code> returns as soon as possible,
and we can <i>get those emails as soon as possible</i>.</li>
<li>Try to call <code>mu index --lazy-fetch</code>.
This fails if mu4e is already open (due to a write lock on the database), so
in that case we just <code>touch</code> a tmp file (<kbd>/tmp/mu_reindex_now</kbd>).</li>
<li>Separately, we set up Emacs to check for the existance of
<kbd>/tmp/mu_reindex_now</kbd> once a second while mu4e is
running, and (after deleting the file) call <code>mu4e-update-index</code>.</li>
</ol>

<p>
We can add a <kbd>doctor</kbd> check for these external dependencies.
</p>

<details id='fetching,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fetching,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (file-exists-p <span class="org-string">"~/.mail"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">We care about mail when the mail folder exists</span>
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"mu"</span>)
    (error! <span class="org-string">"Couldn't find mail dependency mu."</span>))
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"mbsync"</span>)
    (error! <span class="org-string">"Couldn't find mail dependency mbsync."</span>))
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"msmtp"</span>)
    (error! <span class="org-string">"Couldn't find mail dependency msmtp."</span>))
  (<span class="org-keyword">unless</span> (executable-find <span class="org-string">"goimapnotify"</span>)
    (warn! <span class="org-string">"Couldn't find mail helper goimapnotify, mail syncs will be slower."</span>)))
</pre>
</div>
</details>

<p>
Let's start off by handling the elisp side of things
</p>
</div>
<div id="outline-container-rebuild-mail-index" class="outline-5">
<h5 id="rebuild-mail-index"><span class="section-number-5">4.5.1.1.</span> Rebuild mail index while using mu4e<a aria-hidden="true" href="#rebuild-mail-index">#</a> </h5>
<div class="outline-text-5" id="text-4-5-1-1">
<details id='rebuild-mail-index,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#rebuild-mail-index,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">mu4e-reindex-request-file</span> <span class="org-string">"/tmp/mu_reindex_now"</span>
  <span class="org-doc">"Location of the reindex request, signaled by existance"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">mu4e-reindex-request-min-seperation</span> 5.0
  <span class="org-doc">"Don't refresh again until this many second have elapsed.</span>
<span class="org-doc">Prevents a series of redisplays from being called (when set to an appropriate value)"</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">mu4e-reindex-request--file-watcher</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">mu4e-reindex-request--file-just-deleted</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">mu4e-reindex-request--last-time</span> 0)

(<span class="org-keyword">defun</span> <span class="org-function-name">mu4e-reindex-request--add-watcher</span> ()
  (<span class="org-keyword">setq</span> mu4e-reindex-request--file-just-deleted nil)
  (<span class="org-keyword">setq</span> mu4e-reindex-request--file-watcher
        (file-notify-add-watch mu4e-reindex-request-file
                               '(change)
                               #'mu4e-file-reindex-request)))

(<span class="org-keyword">defadvice!</span> mu4e-stop-watching-for-reindex-request ()
  <span class="org-builtin">:after</span> #'mu4e--server-kill
  (<span class="org-keyword">if</span> mu4e-reindex-request--file-watcher
      (file-notify-rm-watch mu4e-reindex-request--file-watcher)))

(<span class="org-keyword">defadvice!</span> mu4e-watch-for-reindex-request ()
  <span class="org-builtin">:after</span> #'mu4e--server-start
  (mu4e-stop-watching-for-reindex-request)
  (<span class="org-keyword">when</span> (file-exists-p mu4e-reindex-request-file)
    (delete-file mu4e-reindex-request-file))
  (mu4e-reindex-request--add-watcher))

(<span class="org-keyword">defun</span> <span class="org-function-name">mu4e-file-reindex-request</span> (event)
  <span class="org-doc">"Act based on the existance of `</span><span class="org-doc"><span class="org-constant">mu4e-reindex-request-file</span></span><span class="org-doc">'"</span>
  (<span class="org-keyword">if</span> mu4e-reindex-request--file-just-deleted
      (mu4e-reindex-request--add-watcher)
    (<span class="org-keyword">when</span> (equal (nth 1 event) 'created)
      (delete-file mu4e-reindex-request-file)
      (<span class="org-keyword">setq</span> mu4e-reindex-request--file-just-deleted t)
      (mu4e-reindex-maybe t))))

(<span class="org-keyword">defun</span> <span class="org-function-name">mu4e-reindex-maybe</span> (<span class="org-type">&amp;optional</span> new-request)
  <span class="org-doc">"Run `</span><span class="org-doc"><span class="org-constant">mu4e--server-index</span></span><span class="org-doc">' if it's been more than</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">mu4e-reindex-request-min-seperation</span></span><span class="org-doc">'seconds since the last request,"</span>
  (<span class="org-keyword">let</span> ((time-since-last-request (- (float-time)
                                    mu4e-reindex-request--last-time)))
    (<span class="org-keyword">when</span> new-request
      (<span class="org-keyword">setq</span> mu4e-reindex-request--last-time (float-time)))
    (<span class="org-keyword">if</span> (&gt; time-since-last-request mu4e-reindex-request-min-seperation)
        (mu4e--server-index nil t)
      (<span class="org-keyword">when</span> new-request
        (run-at-time (* 1.1 mu4e-reindex-request-min-seperation) nil
                     #'mu4e-reindex-maybe)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-config-transcoding-service" class="outline-5">
<h5 id="config-transcoding-service"><span class="section-number-5">4.5.1.2.</span> Config transcoding &amp; service management<a aria-hidden="true" href="#config-transcoding-service">#</a> </h5>
<div class="outline-text-5" id="text-4-5-1-2">
<p>
As long as the <kbd>mbsyncrc</kbd> file exists, this is as easy as running
</p>

<details id='config-transcoding-service,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#config-transcoding-service,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">~/.config/doom/misc/mbsync-imapnotify.py
</pre>
</div>
</details>

<p>
Let's also add a <kbd>doctor</kbd> check for this.
</p>

<details id='config-transcoding-service,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#config-transcoding-service,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (executable-find <span class="org-string">"goimapnotify"</span>)
           (not (file-exists-p <span class="org-string">"~/.config/imapnotify"</span>)))
  (warn! <span class="org-string">"goimapnotify is installed but not configured."</span>))
</pre>
</div>
</details>

<p>
When run without flags this will perform the following actions
</p>
<ul class="org-ul">
<li>Read, and parse <a href="file:///home/runner/.mbsyncrc">~/.mbsyncrc</a>, specifically recognising the following properties
<ul class="org-ul">
<li><code>IMAPAccount</code></li>
<li><code>Host</code></li>
<li><code>Port</code></li>
<li><code>User</code></li>
<li><code>Password</code></li>
<li><code>PassCmd</code></li>
<li><code>Patterns</code></li>
</ul></li>
<li>Call <code>mbsync --list ACCOUNT</code>, and filter results according to <code>Patterns</code></li>
<li>Construct a imapnotify config for each account, with the following hooks
<dl class="org-dl">
<dt>onNewMail</dt><dd></dd>

<dt>onNewMailPost</dt><dd></dd>
</dl></li>
<li>Compare accounts list to previous accounts, enable/disable the relevant
systemd services, called with the <code>--now</code> flag (start/stop services as well)</li>
</ul>

<p>
This script also supports the following flags
</p>
<ul class="org-ul">
<li><code>--status</code> to get the status of the relevant systemd services supports <kbd>active</kbd>,
<kbd>failing</kbd>, and <kbd>disabled</kbd></li>
<li><code>--enable</code> to enable all relevant systemd services</li>
<li><code>--disable</code> to disable all relevant systemd services</li>
</ul>
<details id='config-transcoding-service,code--3' class='code' open><summary><span class="lang">Python</span></summary>
<div class='gutter'>
<a href='#config-transcoding-service,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">from</span> pathlib <span class="org-keyword">import</span> Path
<span class="org-keyword">import</span> json
<span class="org-keyword">import</span> re
<span class="org-keyword">import</span> shutil
<span class="org-keyword">import</span> subprocess
<span class="org-keyword">import</span> sys
<span class="org-keyword">import</span> fnmatch

<span class="org-variable-name">mbsyncFile</span> <span class="org-operator">=</span> Path(<span class="org-string">"~/.mbsyncrc"</span>).expanduser()

<span class="org-variable-name">imapnotifyConfigFolder</span> <span class="org-operator">=</span> Path(<span class="org-string">"~/.config/imapnotify/"</span>).expanduser()
imapnotifyConfigFolder.mkdir(exist_ok<span class="org-operator">=</span><span class="org-constant">True</span>)
<span class="org-variable-name">imapnotifyConfigFilename</span> <span class="org-operator">=</span> <span class="org-string">"notify.conf"</span>

<span class="org-variable-name">imapnotifyDefault</span> <span class="org-operator">=</span> {
    <span class="org-string">"host"</span>: <span class="org-string">""</span>,
    <span class="org-string">"port"</span>: 993,
    <span class="org-string">"tls"</span>: <span class="org-constant">True</span>,
    <span class="org-string">"tlsOptions"</span>: {<span class="org-string">"rejectUnauthorized"</span>: <span class="org-constant">True</span>},
    <span class="org-string">"onNewMail"</span>: <span class="org-string">""</span>,
    <span class="org-string">"onNewMailPost"</span>: <span class="org-string">"if mu index --lazy-check; then test -f /tmp/mu_reindex_now &amp;&amp; rm /tmp/mu_reindex_now; else touch /tmp/mu_reindex_now; fi"</span>,
}


<span class="org-keyword">def</span> <span class="org-function-name">stripQuotes</span>(string):
    <span class="org-keyword">if</span> string[0] <span class="org-operator">==</span> <span class="org-string">'"'</span> <span class="org-keyword">and</span> string[<span class="org-operator">-</span>1] <span class="org-operator">==</span> <span class="org-string">'"'</span>:
        <span class="org-keyword">return</span> string[1:<span class="org-operator">-</span>1].replace(<span class="org-string">'</span><span class="org-constant">\\</span><span class="org-string">"'</span>, <span class="org-string">'"'</span>)


<span class="org-variable-name">mbsyncInotifyMapping</span> <span class="org-operator">=</span> {
    <span class="org-string">"Host"</span>: (<span class="org-builtin">str</span>, <span class="org-string">"host"</span>),
    <span class="org-string">"Port"</span>: (<span class="org-builtin">int</span>, <span class="org-string">"port"</span>),
    <span class="org-string">"User"</span>: (<span class="org-builtin">str</span>, <span class="org-string">"username"</span>),
    <span class="org-string">"Password"</span>: (<span class="org-builtin">str</span>, <span class="org-string">"password"</span>),
    <span class="org-string">"PassCmd"</span>: (stripQuotes, <span class="org-string">"passwordCmd"</span>),
    <span class="org-string">"Patterns"</span>: (<span class="org-builtin">str</span>, <span class="org-string">"_patterns"</span>),
}

<span class="org-variable-name">oldAccounts</span> <span class="org-operator">=</span> [d.name <span class="org-keyword">for</span> d <span class="org-keyword">in</span> imapnotifyConfigFolder.iterdir() <span class="org-keyword">if</span> d.is_dir()]

<span class="org-variable-name">currentAccount</span> <span class="org-operator">=</span> <span class="org-string">""</span>
<span class="org-variable-name">currentAccountData</span> <span class="org-operator">=</span> {}

<span class="org-variable-name">successfulAdditions</span> <span class="org-operator">=</span> []


<span class="org-keyword">def</span> <span class="org-function-name">processLine</span>(line):
    <span class="org-variable-name">newAcc</span> <span class="org-operator">=</span> re.<span class="org-keyword">match</span>(r<span class="org-string">"^IMAPAccount ([^#]+)"</span>, line)

    <span class="org-variable-name">linecontent</span> <span class="org-operator">=</span> re.sub(r<span class="org-string">"(^|[^\\])#.*"</span>, <span class="org-string">""</span>, line).split(<span class="org-string">" "</span>, 1)
    <span class="org-keyword">if</span> <span class="org-builtin">len</span>(linecontent) <span class="org-operator">!=</span> 2:
        <span class="org-keyword">return</span>

    <span class="org-variable-name">parameter</span>, <span class="org-variable-name">value</span> <span class="org-operator">=</span> linecontent

    <span class="org-keyword">if</span> parameter <span class="org-operator">==</span> <span class="org-string">"IMAPAccount"</span>:
        <span class="org-keyword">if</span> currentAccountNumber <span class="org-operator">&gt;</span> 0:
            finaliseAccount()
        newAccount(value)
    <span class="org-keyword">elif</span> parameter <span class="org-keyword">in</span> mbsyncInotifyMapping.keys():
        <span class="org-variable-name">parser</span>, <span class="org-variable-name">key</span> <span class="org-operator">=</span> mbsyncInotifyMapping[parameter]
        <span class="org-variable-name">currentAccountData</span>[key] <span class="org-operator">=</span> parser(value)
    <span class="org-keyword">elif</span> parameter <span class="org-operator">==</span> <span class="org-string">"Channel"</span>:
        <span class="org-variable-name">currentAccountData</span>[<span class="org-string">"onNewMail"</span>] <span class="org-operator">=</span> f<span class="org-string">"mbsync --pull --new </span>{value}<span class="org-string">:'%s'"</span>


<span class="org-keyword">def</span> <span class="org-function-name">newAccount</span>(name):
    <span class="org-keyword">global</span> currentAccountNumber
    <span class="org-keyword">global</span> currentAccount
    <span class="org-keyword">global</span> currentAccountData
    <span class="org-variable-name">currentAccountNumber</span> <span class="org-operator">+=</span> 1
    <span class="org-variable-name">currentAccount</span> <span class="org-operator">=</span> name
    <span class="org-variable-name">currentAccountData</span> <span class="org-operator">=</span> {}
    <span class="org-builtin">print</span>(f<span class="org-string">"</span><span class="org-constant">\n\033</span><span class="org-string">[1;32m</span>{currentAccountNumber}<span class="org-constant">\033</span><span class="org-string">[0;32m - </span>{name}<span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)


<span class="org-keyword">def</span> <span class="org-function-name">accountToFoldername</span>(name):
    <span class="org-keyword">return</span> re.sub(r<span class="org-string">"[^A-Za-z0-9]"</span>, <span class="org-string">""</span>, name)


<span class="org-keyword">def</span> <span class="org-function-name">finaliseAccount</span>():
    <span class="org-keyword">if</span> currentAccountNumber <span class="org-operator">==</span> 0:
        <span class="org-keyword">return</span>

    <span class="org-keyword">global</span> currentAccountData
    <span class="org-keyword">try</span>:
        <span class="org-variable-name">currentAccountData</span>[<span class="org-string">"boxes"</span>] <span class="org-operator">=</span> getMailBoxes(currentAccount)
    <span class="org-keyword">except</span> subprocess.CalledProcessError <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(
            f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;31mError:</span><span class="org-constant">\033</span><span class="org-string">[0;31m failed to fetch mailboxes (skipping): "</span>
            <span class="org-operator">+</span> f<span class="org-string">"`</span>{' '.join(e.cmd)}<span class="org-string">' returned code </span>{e.returncode}<span class="org-constant">\033</span><span class="org-string">[0;37m"</span>
        )
        <span class="org-keyword">return</span>
    <span class="org-keyword">except</span> subprocess.TimeoutExpired <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(
            f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;31mError:</span><span class="org-constant">\033</span><span class="org-string">[0;31m failed to fetch mailboxes (skipping): "</span>
            <span class="org-operator">+</span> f<span class="org-string">"`</span>{' '.join(e.cmd)}<span class="org-string">' timed out after </span>{e.timeout:.2f}<span class="org-string"> seconds</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>
        )
        <span class="org-keyword">return</span>

    <span class="org-keyword">if</span> <span class="org-string">"_patterns"</span> <span class="org-keyword">in</span> currentAccountData:
        <span class="org-variable-name">currentAccountData</span>[<span class="org-string">"boxes"</span>] <span class="org-operator">=</span> applyPatternFilter(
            currentAccountData[<span class="org-string">"_patterns"</span>], currentAccountData[<span class="org-string">"boxes"</span>]
        )

    <span class="org-comment-delimiter"># </span><span class="org-comment">strip not-to-be-exported data</span>
    <span class="org-variable-name">currentAccountData</span> <span class="org-operator">=</span> {
        k: currentAccountData[k] <span class="org-keyword">for</span> k <span class="org-keyword">in</span> currentAccountData <span class="org-keyword">if</span> k[0] <span class="org-operator">!=</span> <span class="org-string">"_"</span>
    }

    <span class="org-variable-name">parametersSet</span> <span class="org-operator">=</span> currentAccountData.keys()
    <span class="org-variable-name">currentAccountData</span> <span class="org-operator">=</span> {<span class="org-operator">**</span>imapnotifyDefault, <span class="org-operator">**</span>currentAccountData}
    <span class="org-keyword">for</span> key, val <span class="org-keyword">in</span> currentAccountData.items():
        <span class="org-variable-name">valColor</span> <span class="org-operator">=</span> <span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;33m"</span> <span class="org-keyword">if</span> key <span class="org-keyword">in</span> parametersSet <span class="org-keyword">else</span> <span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>
        <span class="org-builtin">print</span>(f<span class="org-string">"  </span><span class="org-constant">\033</span><span class="org-string">[1;37m</span>{key:<span class="org-operator">&lt;</span>13}<span class="org-string"> </span>{valColor}{val}<span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)

    <span class="org-keyword">if</span> (
            <span class="org-builtin">len</span>(currentAccountData[<span class="org-string">"boxes"</span>]) <span class="org-operator">&gt;</span> 15
            <span class="org-keyword">and</span> <span class="org-string">"@gmail.com"</span> <span class="org-keyword">in</span> currentAccountData[<span class="org-string">"username"</span>]
    ):
        <span class="org-builtin">print</span>(
            <span class="org-string">"  </span><span class="org-constant">\033</span><span class="org-string">[1;31mWarning:</span><span class="org-constant">\033</span><span class="org-string">[0;31m Gmail raises an error when more than"</span>
            <span class="org-operator">+</span> <span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;31m15</span><span class="org-constant">\033</span><span class="org-string">[0;31m simultanious connections are attempted."</span>
            <span class="org-operator">+</span> <span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">           You are attempting to monitor "</span>
            <span class="org-operator">+</span> f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;31m</span>{<span class="org-builtin">len</span>(currentAccountData['boxes'])}<span class="org-constant">\033</span><span class="org-string">[0;31m mailboxes.</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>
        )

    <span class="org-variable-name">configFile</span> <span class="org-operator">=</span> (
        imapnotifyConfigFolder
        <span class="org-operator">/</span> accountToFoldername(currentAccount)
        <span class="org-operator">/</span> imapnotifyConfigFilename
    )
    configFile.parent.mkdir(exist_ok<span class="org-operator">=</span><span class="org-constant">True</span>)

    json.dump(currentAccountData, <span class="org-builtin">open</span>(configFile, <span class="org-string">"w"</span>), indent<span class="org-operator">=</span>2)
    <span class="org-builtin">print</span>(f<span class="org-string">" </span><span class="org-constant">\033</span><span class="org-string">[0;35mConfig generated and saved to </span>{configFile}<span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)

    <span class="org-keyword">global</span> successfulAdditions
    successfulAdditions.append(accountToFoldername(currentAccount))


<span class="org-keyword">def</span> <span class="org-function-name">getMailBoxes</span>(account):
    <span class="org-variable-name">boxes</span> <span class="org-operator">=</span> subprocess.run(
        [<span class="org-string">"mbsync"</span>, <span class="org-string">"--list"</span>, account], check<span class="org-operator">=</span><span class="org-constant">True</span>, stdout<span class="org-operator">=</span>subprocess.PIPE, timeout<span class="org-operator">=</span>10.0
    )
    <span class="org-keyword">return</span> boxes.stdout.decode(<span class="org-string">"utf-8"</span>).strip().split(<span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span>)


<span class="org-keyword">def</span> <span class="org-function-name">applyPatternFilter</span>(pattern, mailboxes):
    <span class="org-variable-name">patternRegexs</span> <span class="org-operator">=</span> getPatternRegexes(pattern)
    <span class="org-keyword">return</span> [m <span class="org-keyword">for</span> m <span class="org-keyword">in</span> mailboxes <span class="org-keyword">if</span> testPatternRegexs(patternRegexs, m)]


<span class="org-keyword">def</span> <span class="org-function-name">getPatternRegexes</span>(pattern):
    <span class="org-keyword">def</span> <span class="org-function-name">addGlob</span>(b):
        blobs.append(b.replace(<span class="org-string">'</span><span class="org-constant">\\</span><span class="org-string">"'</span>, <span class="org-string">'"'</span>))
        <span class="org-keyword">return</span> <span class="org-string">""</span>

    <span class="org-variable-name">blobs</span> <span class="org-operator">=</span> []
    <span class="org-variable-name">pattern</span> <span class="org-operator">=</span> re.sub(r<span class="org-string">' ?"([^"]+)"'</span>, <span class="org-keyword">lambda</span> m: addGlob(m.groups()[0]), pattern)
    blobs.extend(pattern.split(<span class="org-string">" "</span>))
    <span class="org-variable-name">blobs</span> <span class="org-operator">=</span> [
        (<span class="org-operator">-</span>1, fnmatch.translate(b[1::])) <span class="org-keyword">if</span> b[0] <span class="org-operator">==</span> <span class="org-string">"!"</span> <span class="org-keyword">else</span> (1, fnmatch.translate(b))
        <span class="org-keyword">for</span> b <span class="org-keyword">in</span> blobs
    ]
    <span class="org-keyword">return</span> blobs


<span class="org-keyword">def</span> <span class="org-function-name">testPatternRegexs</span>(regexCond, <span class="org-keyword">case</span>):
    <span class="org-keyword">for</span> factor, regex <span class="org-keyword">in</span> regexCond:
        <span class="org-keyword">if</span> factor <span class="org-operator">*</span> <span class="org-builtin">bool</span>(re.<span class="org-keyword">match</span>(regex, <span class="org-keyword">case</span>)) <span class="org-operator">&lt;</span> 0:
            <span class="org-keyword">return</span> <span class="org-constant">False</span>
    <span class="org-keyword">return</span> <span class="org-constant">True</span>


<span class="org-keyword">def</span> <span class="org-function-name">processSystemdServices</span>():
    <span class="org-variable-name">keptAccounts</span> <span class="org-operator">=</span> [acc <span class="org-keyword">for</span> acc <span class="org-keyword">in</span> successfulAdditions <span class="org-keyword">if</span> acc <span class="org-keyword">in</span> oldAccounts]
    <span class="org-variable-name">freshAccounts</span> <span class="org-operator">=</span> [acc <span class="org-keyword">for</span> acc <span class="org-keyword">in</span> successfulAdditions <span class="org-keyword">if</span> acc <span class="org-keyword">not</span> <span class="org-keyword">in</span> oldAccounts]
    <span class="org-variable-name">staleAccounts</span> <span class="org-operator">=</span> [acc <span class="org-keyword">for</span> acc <span class="org-keyword">in</span> oldAccounts <span class="org-keyword">if</span> acc <span class="org-keyword">not</span> <span class="org-keyword">in</span> successfulAdditions]

    <span class="org-keyword">if</span> keptAccounts:
        <span class="org-builtin">print</span>(f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;34m</span>{<span class="org-builtin">len</span>(keptAccounts)}<span class="org-constant">\033</span><span class="org-string">[0;34m kept accounts:</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        restartAccountSystemdServices(keptAccounts)

    <span class="org-keyword">if</span> freshAccounts:
        <span class="org-builtin">print</span>(f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;32m</span>{<span class="org-builtin">len</span>(freshAccounts)}<span class="org-constant">\033</span><span class="org-string">[0;32m new accounts:</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        enableAccountSystemdServices(freshAccounts)
    <span class="org-keyword">else</span>:
        <span class="org-builtin">print</span>(f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;32mNo new accounts.</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)

    <span class="org-variable-name">notActuallyEnabledAccounts</span> <span class="org-operator">=</span> [
        acc <span class="org-keyword">for</span> acc <span class="org-keyword">in</span> successfulAdditions <span class="org-keyword">if</span> <span class="org-keyword">not</span> getAccountServiceState(acc)[<span class="org-string">"enabled"</span>]
    ]
    <span class="org-keyword">if</span> notActuallyEnabledAccounts:
        <span class="org-builtin">print</span>(
            f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;32m</span>{<span class="org-builtin">len</span>(notActuallyEnabledAccounts)}<span class="org-constant">\033</span><span class="org-string">[0;32m accounts need re-enabling:</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>
        )
        enableAccountSystemdServices(notActuallyEnabledAccounts)

    <span class="org-keyword">if</span> staleAccounts:
        <span class="org-builtin">print</span>(f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;33m</span>{<span class="org-builtin">len</span>(staleAccounts)}<span class="org-constant">\033</span><span class="org-string">[0;33m removed accounts:</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        disableAccountSystemdServices(staleAccounts)
    <span class="org-keyword">else</span>:
        <span class="org-builtin">print</span>(f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;33mNo removed accounts.</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)


<span class="org-keyword">def</span> <span class="org-function-name">enableAccountSystemdServices</span>(accounts):
    <span class="org-keyword">for</span> account <span class="org-keyword">in</span> accounts:
        <span class="org-builtin">print</span>(f<span class="org-string">" </span><span class="org-constant">\033</span><span class="org-string">[0;32m - </span><span class="org-constant">\033</span><span class="org-string">[1;37m</span>{account:<span class="org-operator">&lt;</span>18}<span class="org-string">"</span>, end<span class="org-operator">=</span><span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>, flush<span class="org-operator">=</span><span class="org-constant">True</span>)
        <span class="org-keyword">if</span> setSystemdServiceState(
                <span class="org-string">"enable"</span>, f<span class="org-string">"goimapnotify@</span>{accountToFoldername(account)}<span class="org-string">.service"</span>
        ):
            <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;32m enabled"</span>)


<span class="org-keyword">def</span> <span class="org-function-name">disableAccountSystemdServices</span>(accounts):
    <span class="org-keyword">for</span> account <span class="org-keyword">in</span> accounts:
        <span class="org-builtin">print</span>(f<span class="org-string">" </span><span class="org-constant">\033</span><span class="org-string">[0;33m - </span><span class="org-constant">\033</span><span class="org-string">[1;37m</span>{account:<span class="org-operator">&lt;</span>18}<span class="org-string">"</span>, end<span class="org-operator">=</span><span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>, flush<span class="org-operator">=</span><span class="org-constant">True</span>)
        <span class="org-keyword">if</span> setSystemdServiceState(
                <span class="org-string">"disable"</span>, f<span class="org-string">"goimapnotify@</span>{accountToFoldername(account)}<span class="org-string">.service"</span>
        ):
            <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;33m disabled"</span>)


<span class="org-keyword">def</span> <span class="org-function-name">restartAccountSystemdServices</span>(accounts):
    <span class="org-keyword">for</span> account <span class="org-keyword">in</span> accounts:
        <span class="org-builtin">print</span>(f<span class="org-string">" </span><span class="org-constant">\033</span><span class="org-string">[0;34m - </span><span class="org-constant">\033</span><span class="org-string">[1;37m</span>{account:<span class="org-operator">&lt;</span>18}<span class="org-string">"</span>, end<span class="org-operator">=</span><span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>, flush<span class="org-operator">=</span><span class="org-constant">True</span>)
        <span class="org-keyword">if</span> setSystemdServiceState(
                <span class="org-string">"restart"</span>, f<span class="org-string">"goimapnotify@</span>{accountToFoldername(account)}<span class="org-string">.service"</span>
        ):
            <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;34m restarted"</span>)


<span class="org-keyword">def</span> <span class="org-function-name">setSystemdServiceState</span>(state, service):
    <span class="org-keyword">try</span>:
        <span class="org-variable-name">enabler</span> <span class="org-operator">=</span> subprocess.run(
            [<span class="org-string">"systemctl"</span>, <span class="org-string">"--user"</span>, state, service, <span class="org-string">"--now"</span>],
            check<span class="org-operator">=</span><span class="org-constant">True</span>,
            stderr<span class="org-operator">=</span>subprocess.DEVNULL,
            timeout<span class="org-operator">=</span>5.0,
        )
        <span class="org-keyword">return</span> <span class="org-constant">True</span>
    <span class="org-keyword">except</span> subprocess.CalledProcessError <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(
            f<span class="org-string">" </span><span class="org-constant">\033</span><span class="org-string">[1;31mfailed</span><span class="org-constant">\033</span><span class="org-string">[0;31m to </span>{state}<span class="org-string">, `</span>{' '.join(e.cmd)}<span class="org-string">'"</span>
            <span class="org-operator">+</span> f<span class="org-string">"returned code </span>{e.returncode}<span class="org-constant">\033</span><span class="org-string">[0;37m"</span>
        )
    <span class="org-keyword">except</span> subprocess.TimeoutExpired <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(f<span class="org-string">" </span><span class="org-constant">\033</span><span class="org-string">[1;31mtimed out after </span>{e.timeout:.2f}<span class="org-string"> seconds</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        <span class="org-keyword">return</span> <span class="org-constant">False</span>


<span class="org-keyword">def</span> <span class="org-function-name">getAccountServiceState</span>(account):
    <span class="org-keyword">return</span> {
        state: <span class="org-builtin">bool</span>(
            1
            <span class="org-operator">-</span> subprocess.run(
                [
                    <span class="org-string">"systemctl"</span>,
                    <span class="org-string">"--user"</span>,
                    f<span class="org-string">"is-</span>{state}<span class="org-string">"</span>,
                    <span class="org-string">"--quiet"</span>,
                    f<span class="org-string">"goimapnotify@</span>{accountToFoldername(account)}<span class="org-string">.service"</span>,
                ],
                stderr<span class="org-operator">=</span>subprocess.DEVNULL,
            ).returncode
        )
        <span class="org-keyword">for</span> state <span class="org-keyword">in</span> (<span class="org-string">"enabled"</span>, <span class="org-string">"active"</span>, <span class="org-string">"failing"</span>)
    }


<span class="org-keyword">def</span> <span class="org-function-name">getAccountServiceStates</span>(accounts):
    <span class="org-keyword">for</span> account <span class="org-keyword">in</span> accounts:
        <span class="org-variable-name">enabled</span>, <span class="org-variable-name">active</span>, <span class="org-variable-name">failing</span> <span class="org-operator">=</span> getAccountServiceState(account).values()
        <span class="org-builtin">print</span>(f<span class="org-string">"  - </span><span class="org-constant">\033</span><span class="org-string">[1;37m</span>{account:<span class="org-operator">&lt;</span>18}<span class="org-constant">\033</span><span class="org-string">[0;37m "</span>, end<span class="org-operator">=</span><span class="org-string">""</span>, flush<span class="org-operator">=</span><span class="org-constant">True</span>)
        <span class="org-keyword">if</span> <span class="org-keyword">not</span> enabled:
            <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;33mdisabled</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        <span class="org-keyword">elif</span> active:
            <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;32mactive</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        <span class="org-keyword">elif</span> failing:
            <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;31mfailing</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        <span class="org-keyword">else</span>:
            <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;35min an unrecognised state</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)


<span class="org-keyword">if</span> <span class="org-builtin">len</span>(sys.argv) <span class="org-operator">&gt;</span> 1:
    <span class="org-keyword">if</span> sys.argv[1]   <span class="org-keyword">in</span> [<span class="org-string">"-e"</span>, <span class="org-string">"--enable"</span>]:
        enableAccountSystemdServices(oldAccounts)
        <span class="org-constant">exit</span>()
    <span class="org-keyword">elif</span> sys.argv[1] <span class="org-keyword">in</span> [<span class="org-string">"-d"</span>, <span class="org-string">"--disable"</span>]:
        disableAccountSystemdServices(oldAccounts)
        <span class="org-constant">exit</span>()
    <span class="org-keyword">elif</span> sys.argv[1] <span class="org-keyword">in</span> [<span class="org-string">"-r"</span>, <span class="org-string">"--restart"</span>]:
        restartAccountSystemdServices(oldAccounts)
        <span class="org-constant">exit</span>()
    <span class="org-keyword">elif</span> sys.argv[1] <span class="org-keyword">in</span> [<span class="org-string">"-s"</span>, <span class="org-string">"--status"</span>]:
        getAccountServiceStates(oldAccounts)
        <span class="org-constant">exit</span>()
    <span class="org-keyword">elif</span> sys.argv[1] <span class="org-keyword">in</span> [<span class="org-string">"-h"</span>, <span class="org-string">"--help"</span>]:
        <span class="org-builtin">print</span>(<span class="org-string">"""</span><span class="org-constant">\033</span><span class="org-string">[1;37mMbsync to IMAP Notify config generator.</span><span class="org-constant">\033</span><span class="org-string">[0;37m</span>

<span class="org-string">Usage: mbsync-imapnotify [options]</span>

<span class="org-string">Options:</span>
<span class="org-string">    -e, --enable       enable all services</span>
<span class="org-string">    -d, --disable      disable all services</span>
<span class="org-string">    -r, --restart      restart all services</span>
<span class="org-string">    -s, --status       fetch the status for all services</span>
<span class="org-string">    -h, --help         show this help</span>
<span class="org-string">"""</span>, end<span class="org-operator">=</span><span class="org-string">''</span>)
        <span class="org-constant">exit</span>()
    <span class="org-keyword">else</span>:
        <span class="org-builtin">print</span>(f<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[0;31mFlag </span>{sys.argv[1]}<span class="org-string"> not recognised, try --help</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)
        <span class="org-constant">exit</span>()


<span class="org-variable-name">mbsyncData</span> <span class="org-operator">=</span> <span class="org-builtin">open</span>(mbsyncFile, <span class="org-string">"r"</span>).read()

<span class="org-variable-name">currentAccountNumber</span> <span class="org-operator">=</span> 0

<span class="org-variable-name">totalAccounts</span> <span class="org-operator">=</span> <span class="org-builtin">len</span>(re.findall(r<span class="org-string">"^IMAPAccount"</span>, mbsyncData, re.M))


<span class="org-keyword">def</span> <span class="org-function-name">main</span>():
    <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;34m:: MbSync to Go IMAP notify config file creator ::</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)

    shutil.rmtree(imapnotifyConfigFolder)
    imapnotifyConfigFolder.mkdir(exist_ok<span class="org-operator">=</span><span class="org-constant">False</span>)
    <span class="org-builtin">print</span>(<span class="org-string">"</span><span class="org-constant">\033</span><span class="org-string">[1;30mImap Notify config dir purged</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)

    <span class="org-builtin">print</span>(f<span class="org-string">"Identified </span><span class="org-constant">\033</span><span class="org-string">[1;32m</span>{totalAccounts}<span class="org-constant">\033</span><span class="org-string">[0;32m accounts.</span><span class="org-constant">\033</span><span class="org-string">[0;37m"</span>)

    <span class="org-keyword">for</span> line <span class="org-keyword">in</span> mbsyncData.split(<span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span>):
        processLine(line)

    finaliseAccount()

    <span class="org-builtin">print</span>(
        f<span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">Config files generated for </span><span class="org-constant">\033</span><span class="org-string">[1;36m</span>{<span class="org-builtin">len</span>(successfulAdditions)}<span class="org-constant">\033</span><span class="org-string">[0;36m"</span>
        <span class="org-operator">+</span> f<span class="org-string">" out of </span><span class="org-constant">\033</span><span class="org-string">[1;36m</span>{totalAccounts}<span class="org-constant">\033</span><span class="org-string">[0;37m accounts.</span><span class="org-constant">\n</span><span class="org-string">"</span>
    )

    processSystemdServices()


<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> <span class="org-operator">==</span> <span class="org-string">"__main__"</span>:
    main()
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-fetching-systemd" class="outline-5">
<h5 id="fetching-systemd"><span class="section-number-5">4.5.1.3.</span> Systemd<a aria-hidden="true" href="#fetching-systemd">#</a> </h5>
<div class="outline-text-5" id="text-4-5-1-3">
<p>
We then have a service file to run <code>goimapnotify</code> on all of these generated config files.
We'll use a template service file so we can enable a unit per-account.
</p>
<details id='systemd,code--3' class='code' open><summary><span class="lang">systemd</span></summary>
<div class='gutter'>
<a href='#systemd,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-systemd"><span class="org-type">[Unit]</span>
<span class="org-keyword">Description</span>=IMAP notifier using IDLE, golang version.
<span class="org-keyword">ConditionPathExists</span>=<span class="org-constant">%h</span>/.config/imapnotify/<span class="org-constant">%I</span>/notify.conf
<span class="org-keyword">After</span>=network.target
<span class="org-keyword">Wants</span>=gpg-agent.service

<span class="org-type">[Service]</span>
<span class="org-keyword">ExecStart</span>=<span class="org-constant">%h</span>/.local/bin/goimapnotify -conf <span class="org-constant">%h</span>/.config/imapnotify/<span class="org-constant">%I</span>/notify.conf
<span class="org-keyword">Restart</span>=<span class="org-builtin">always</span>
<span class="org-keyword">RestartSec</span>=30

<span class="org-type">[Install]</span>
<span class="org-keyword">WantedBy</span>=default.target
</pre>
</div>
</details>

<p>
Enabling the service is actually taken care of by that python script.
</p>

<p>
From one or two small tests, this can bring the delay down to as low as five
seconds, which I'm quite happy with.
</p>

<p>
This works well for fetching new mail, but we also want to propagate other
changes (e.g. marking mail as read), and make sure we're up to date at the
start, so for that I'll do the 'normal' thing and run <code>mbsync -all</code> every so often
&#x2014; let's say five minutes.
</p>

<p>
We can accomplish this via a systemd timer, and service file.
</p>
<details id='systemd,code--4' class='code' open><summary><span class="lang">systemd</span></summary>
<div class='gutter'>
<a href='#systemd,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-systemd"><span class="org-type">[Unit]</span>
<span class="org-keyword">Description</span>=call mbsync on all accounts every 5 minutes
<span class="org-keyword">ConditionPathExists</span>=<span class="org-constant">%h</span>/.mbsyncrc

<span class="org-type">[Timer]</span>
<span class="org-keyword">OnBootSec</span>=5m
<span class="org-keyword">OnUnitInactiveSec</span>=5m

<span class="org-type">[Install]</span>
<span class="org-keyword">WantedBy</span>=default.target
</pre>
</div>
</details>

<details id='systemd,code--5' class='code' open><summary><span class="lang">systemd</span></summary>
<div class='gutter'>
<a href='#systemd,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-systemd"><span class="org-type">[Unit]</span>
<span class="org-keyword">Description</span>=mbsync service, sync all mail
<span class="org-keyword">Documentation</span>=man:mbsync(1)
<span class="org-keyword">ConditionPathExists</span>=<span class="org-constant">%h</span>/.mbsyncrc
<span class="org-keyword">Wants</span>=gpg-agent.service

<span class="org-type">[Service]</span>
<span class="org-keyword">Type</span>=<span class="org-builtin">oneshot</span>
<span class="org-keyword">ExecStart</span>=/usr/bin/mbsync -c <span class="org-constant">%h</span>/.mbsyncrc --all

<span class="org-type">[Install]</span>
<span class="org-keyword">WantedBy</span>=mail.target
</pre>
</div>
</details>

<p>
Enabling (and starting) this is as simple as
</p>

<details id='systemd,code--6' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#systemd,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">systemctl --user enable mbsync.timer --now
</pre>
</div>
</details>

<p>
We can also add a <kbd>doctor</kbd> check for the timer state.
</p>

<details id='systemd,code--7' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#systemd,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (executable-find <span class="org-string">"mbsync"</span>)
  (<span class="org-keyword">unless</span> (string= <span class="org-string">"enabled\n"</span> (shell-command-to-string <span class="org-string">"systemctl --user is-enabled mbsync.timer"</span>))
    (warn! <span class="org-string">"The mbsync timer is not enabled."</span>)))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-indexing-searching" class="outline-4">
<h4 id="indexing-searching"><span class="section-number-4">4.5.2.</span> Indexing/Searching<a aria-hidden="true" href="#indexing-searching">#</a> </h4>
<div class="outline-text-4" id="text-4-5-2">
<p>
This is performed by <a href="https://www.djcbsoftware.nl/code/mu/">Mu</a>. This is a tool for finding emails stored in the <a href="http://en.wikipedia.org/wiki/Maildir">Maildir</a> format.
According to the homepage, it's main features are
</p>
<ul class="org-ul">
<li>Fast indexing</li>
<li>Good searching</li>
<li>Support for encrypted and signed messages</li>
<li>Rich <span class='acr'>CLI</span> tooling</li>
<li>accent/case normalisation</li>
<li>strong integration with email clients</li>
</ul>

<p>
Unfortunately <code>mu</code> is not currently packaged from me. Oh well, I guess I'm
building it from source then. I needed to install these packages
</p>
<ul class="org-ul">
<li><kbd>gmime-devel</kbd></li>
<li><kbd>xapian-core-devel</kbd></li>
</ul>

<details id='install-mu-from' class='code' open><summary class='named'><span class="name">Install mu from source</span><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#install-mu-from'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">cd</span> ~/.local/lib/
git clone https://github.com/djcb/mu.git
<span class="org-builtin">cd</span> ./mu
./autogen.sh
make
sudo make install
</pre>
</div>
</details>

<p>
To check how my version compares to the latest published:
</p>

<details id='indexing-searching,code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#indexing-searching,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">curl --silent <span class="org-string">"https://api.github.com/repos/djcb/mu/releases/latest"</span> | grep <span class="org-string">'"tag_name":'</span> | sed -E <span class="org-string">'s/.*"([^"]+)".*/\1/'</span>
mu --version | head -n 1 | sed <span class="org-string">'s/.* version //'</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-sending" class="outline-4">
<h4 id="sending"><span class="section-number-4">4.5.3.</span> Sending<a aria-hidden="true" href="#sending">#</a> </h4>
<div class="outline-text-4" id="text-4-5-3">
<p>
<a href="https://www.nongnu.org/smtpmail/">SmtpMail</a> seems to be the 'default' starting point, but that's not packaged for
me. <a href="https://marlam.de/msmtp/">msmtp</a> is however, so I'll give that a shot. Reading around a bit (googling
"msmtp vs sendmail" for example) almost every comparison mentioned seems to
suggest msmtp to be a better choice. I have seen the following points raised
</p>
<ul class="org-ul">
<li><code>sendmail</code> has several vulnerabilities</li>
<li><code>sendmail</code> is tedious to configure</li>
<li><code>ssmtp</code> is no longer maintained</li>
<li><code>msmtp</code> is a maintained alternative to <code>ssmtp</code></li>
<li><code>msmtp</code> is easier to configure</li>
</ul>

<p>
The config file is <a href="file:///home/runner/.config/msmtp/config">~/.config/msmtp/config</a>.
</p>
</div>
<div id="outline-container-system-hackery" class="outline-5">
<h5 id="system-hackery"><span class="section-number-5">4.5.3.1.</span> System hackery<a aria-hidden="true" href="#system-hackery">#</a> </h5>
<div class="outline-text-5" id="text-4-5-3-1">
<p>
Unfortunately, I seem to have run into a <a href="https://bugs.archlinux.org/task/44994">bug</a> present in my packaged version, so
we'll just install the latest from source.
</p>

<p>
For full use of the <code>auth</code> options, I need <kbd>GNU SASL</kbd>, which isn't packaged for me.
I don't think I want it, but in case I do, I'll need to do this.
</p>
<details id='install-gsasl-from' class='code' open><summary class='named'><span class="name">Install gsasl from source</span><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#install-gsasl-from'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">GSASL_VERSION</span>=1.8.1
<span class="org-builtin">cd</span> ~/.local/lib/
curl <span class="org-string">"ftp://ftp.gnu.org/gnu/gsasl/libgsasl-$GSASL_VERSION.tar.gz"</span> | tar xz
curl <span class="org-string">"ftp://ftp.gnu.org/gnu/gsasl/gsasl-$GSASL_VERSION.tar.gz"</span> | tar xz
<span class="org-builtin">cd</span> <span class="org-string">"./libgsasl-$GSASL_VERSION"</span>
./configure
make
sudo make install
<span class="org-builtin">cd</span> ..
<span class="org-builtin">cd</span> <span class="org-string">"./gsasl-$VERSION"</span>
./configure
make
sudo make install
<span class="org-builtin">cd</span> ..
</pre>
</div>
</details>

<p>
Now actually compile <code>msmtp</code>.
</p>
<details id='install-msmtp-from' class='code' open><summary class='named'><span class="name">Install msmtp from source</span><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#install-msmtp-from'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">cd</span> ~/.local/lib/
git clone https://github.com/marlam/msmtp-mirror.git ./msmtp
<span class="org-builtin">cd</span> ./msmtp
libtoolize --force
aclocal
autoheader
automake --force-missing --add-missing
autoconf
<span class="org-comment-delimiter"># </span><span class="org-comment">if using GSASL</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">PKG_CONFIG_PATH=/usr/local/lib/pkgconfig ./configure --with-libgsasl</span>
./configure
make
sudo make install
</pre>
</div>
</details>

<p>
If using <kbd>GSASL</kbd> (from earlier) we need to make ensure that the dynamic library in
in the library path. We can do by adding an executable with the same name
earlier on in my <code>$PATH</code>.
</p>
<details id='system-hackery,code--1' class='code' open><summary><span class="lang">shell</span></summary>
<div class='gutter'>
<a href='#system-hackery,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-variable-name">LD_LIBRARY_PATH</span>=/usr/local/lib exec /usr/local/bin/msmtp <span class="org-string">"$@"</span>
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-mu4e" class="outline-4">
<h4 id="mu4e"><span class="section-number-4">4.5.4.</span> Mu4e<a aria-hidden="true" href="#mu4e">#</a> </h4>
<div class="outline-text-4" id="text-4-5-4">
<p>
Webmail clients are nice and all, but I still don't believe that <span class='acr'>SPA</span><small>s</small> in my
browser can replaced desktop apps &#x2026; sorry Gmail. I'm also liking google less
and less.
</p>

<p>
Mailspring is a decent desktop client, quite lightweight for electron
(apparently the backend is in <kbd>C</kbd>, which probably helps), however I miss Emacs
stuff.
</p>

<p>
While <kbd>Notmuch</kbd> seems very promising, and I've heard good things about it, it
doesn't seem to make any changes to the emails themselves. All data is stored in
Notmuch's database. While this is a very interesting model, occasionally I need
to pull up an email on say my phone, and so not I want the tagging/folders etc.
to be applied to the mail itself &#x2014; not stored in a database.
</p>

<p>
On the other hand <kbd>Mu4e</kbd> is also talked about a lot in positive terms, and seems
to possess a similarly strong feature set &#x2014; and modifies the mail itself (I.e.
information is accessible without the database). <kbd>Mu4e</kbd> also seems to have a large
user base, which tends to correlate with better support and attention.
</p>

<p>
If I install mu4e from source, I need to add the <kbd>/usr/local/</kbd> loadpath so Mu4e
has a chance of loading. Alternatively, I may need to add the <kbd>/usr/share/</kbd> path.
</p>

<details id='add-mu4e-load' class='code' open><summary class='named'><span class="name">add-mu4e-load-path</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#add-mu4e-load'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cond</span>
 ((cl-some (<span class="org-keyword">lambda</span> (path) (string-match-p <span class="org-string">"mu4e"</span> path)) load-path) nil)
 ((file-directory-p <span class="org-string">"/usr/local/share/emacs/site-lisp/mu4e"</span>)
  (<span class="org-keyword">quote</span> (add-to-list 'load-path <span class="org-string">"/usr/local/share/emacs/site-lisp/mu4e"</span>)))
 ((file-directory-p <span class="org-string">"/usr/share/emacs/site-lisp/mu4e"</span>)
  (<span class="org-keyword">quote</span> (add-to-list 'load-path <span class="org-string">"/usr/share/emacs/site-lisp/mu4e"</span>))))
</pre>
</div>
</details>

<p>
Let's also just shove all the Elisp code here in an <code class="src src-elisp">(<span class="org-keyword">after!</span> ...)</code> block.
</p>
<details id='mu4e,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mu4e,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;mu4e-conf&gt;&gt;
</pre>
</div>
</details>
</div>
<div id="outline-container-viewing-mail" class="outline-5">
<h5 id="viewing-mail"><span class="section-number-5">4.5.4.1.</span> Viewing Mail<a aria-hidden="true" href="#viewing-mail">#</a> </h5>
<div class="outline-text-5" id="text-4-5-4-1">
<p>
There seem to be some advantages with using Gnus' article view (such as inline
images), and judging from <a href="https://github.com/djcb/mu/pull/1442#issuecomment-591695814">djcb/mu!1442 (comment)</a> this seems to be the 'way of
the future' for mu4e.
</p>

<p>
There are some nerd-icons font related issues, so we need to redefine the
fancy chars, and make sure they get the correct width.
</p>

<p>
To account for the increase width of each flag character, and make perform a
few more visual tweaks, we'll tweak the headers a bit
</p>
<details id='viewing-mail,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#viewing-mail,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> mu4e-headers-fields
      '((<span class="org-builtin">:flags</span> . 6)
        (<span class="org-builtin">:account-stripe</span> . 2)
        (<span class="org-builtin">:from-or-to</span> . 25)
        (<span class="org-builtin">:folder</span> . 10)
        (<span class="org-builtin">:recipnum</span> . 2)
        (<span class="org-builtin">:subject</span> . 80)
        (<span class="org-builtin">:human-date</span> . 8))
      +mu4e-min-header-frame-width 142
      mu4e-headers-date-format <span class="org-string">"%d/%m/%y"</span>
      mu4e-headers-time-format <span class="org-string">"&#10710; %H:%M"</span>
      mu4e-headers-results-limit 1000
      mu4e-index-cleanup t)

(add-to-list 'mu4e-bookmarks
             '(<span class="org-builtin">:name</span> <span class="org-string">"Yesterday's messages"</span> <span class="org-builtin">:query</span> <span class="org-string">"date:2d..1d"</span> <span class="org-builtin">:key</span> ?y) t)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">+mu4e-header--folder-colors</span> nil)
(<span class="org-keyword">appendq!</span> mu4e-header-info-custom
          '((<span class="org-builtin">:folder</span> .
             (<span class="org-builtin">:name</span> <span class="org-string">"Folder"</span> <span class="org-builtin">:shortname</span> <span class="org-string">"Folder"</span> <span class="org-builtin">:help</span> <span class="org-string">"Lowest level folder"</span> <span class="org-builtin">:function</span>
              (<span class="org-keyword">lambda</span> (msg)
                (+mu4e-colorize-str
                 (replace-regexp-in-string <span class="org-string">"\\`.*/"</span> <span class="org-string">""</span> (mu4e-message-field msg <span class="org-builtin">:maildir</span>))
                 '+mu4e-header--folder-colors))))))
</pre>
</div>
</details>

<p>
Among the flags mu4e displays is the "personal address" flag, for messages sent
<i>to</i> me (as opposed to mailing-list-y emails where I am not an explicit
recipient). Unfortunately, this doesn't play well with my wildcard email
addresses, so let's fix this with advise.
</p>

<details id='viewing-mail,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#viewing-mail,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +mu4e-personal-address-p--*-a (orig-fn addr)
  <span class="org-builtin">:around</span> #'mu4e-personal-address-p
  (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> (stringp addr)
           (string-match-p <span class="org-string">"@</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[a-z]+\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?tecosaur\\.net$"</span> addr))
      (funcall orig-fn addr)))
</pre>
</div>
</details>

<p>
We'll also use a nicer alert icon
</p>
<details id='viewing-mail,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#viewing-mail,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> mu4e-alert-icon <span class="org-string">"/usr/share/icons/Papirus/64x64/apps/evolution.svg"</span>)
</pre>
</div>
</details>

<p>
And save ourselves from the awful <kbd>mu4e-thread-fold-face</kbd>.
</p>

<details id='viewing-mail,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#viewing-mail,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(custom-set-faces!
  '(mu4e-thread-fold-face <span class="org-builtin">:inherit</span> default))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-sending-mail" class="outline-5">
<h5 id="sending-mail"><span class="section-number-5">4.5.4.2.</span> Sending Mail<a aria-hidden="true" href="#sending-mail">#</a> </h5>
<div class="outline-text-5" id="text-4-5-4-2">
<p>
Let's send emails too.
</p>
<details id='sending-mail,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> sendmail-program <span class="org-string">"/usr/bin/msmtp"</span>
      send-mail-function #'smtpmail-send-it
      message-sendmail-f-is-evil t
      message-sendmail-extra-arguments '(<span class="org-string">"--read-envelope-from"</span>)<span class="org-comment-delimiter">; </span><span class="org-comment">, "--read-recipients")</span>
      message-send-mail-function #'message-send-mail-with-sendmail)
</pre>
</div>
</details>

<p>
It's also nice to avoid accidentally sending emails with the wrong account. If
we can send from the address in the <code>To</code> field, let's do that. Opening a prompt
otherwise also seems sensible.
</p>

<p>
We can register Emacs as a potential email client with a desktop file. We could
put an <kbd>emacsclient ...</kbd> entry in the <kbd>Exec</kbd> field, but I've found this a bit dodgy.
Instead let's package the <kbd>emacslient</kbd> behaviour in a little executable
<kbd>~/.local/bin/emacsmail</kbd>.
</p>

<details id='sending-mail,code--2' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">emacsclient -create-frame --alternate-editor=<span class="org-string">''</span> --no-wait --eval <span class="org-sh-escaped-newline">\</span>
<span class="org-string">"(progn (x-focus-frame nil) (mu4e-compose-from-mailto \"$1\" t))"</span>
</pre>
</div>
</details>

<p>
Now we can just call that in a desktop file.
</p>

<details id='sending-mail,code--3' class='code' open><summary><span class="lang">Configuration File</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">Desktop Entry</span>]
<span class="org-variable-name">Name</span>=Mu4e
<span class="org-variable-name">GenericName</span>=Compose a new message with Mu4e in Emacs
<span class="org-variable-name">Comment</span>=Open mu4e compose window
<span class="org-variable-name">MimeType</span>=x-scheme-handler/mailto;
<span class="org-variable-name">Exec</span>=emacsmail %u
<span class="org-variable-name">Icon</span>=emacs
<span class="org-variable-name">Type</span>=Application
<span class="org-variable-name">Terminal</span>=false
<span class="org-variable-name">Categories</span>=Network;Email;
<span class="org-variable-name">StartupWMClass</span>=Emacs
</pre>
</div>
</details>

<p>
To register this, just call
</p>

<details id='sending-mail,code--4' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">update-desktop-database ~/.local/share/applications
</pre>
</div>
</details>

<p>
We can see if this is necessary with a <kbd>doctor</kbd> check.
</p>

<details id='sending-mail,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (executable-find <span class="org-string">"mu"</span>)
           (not (string= (shell-command-to-string <span class="org-string">"xdg-mime query default x-scheme-handler/mailto"</span>)
                         <span class="org-string">"emacsmail.desktop\n"</span>)))
  (warn! <span class="org-string">"Emacs is not registered as a mailto handler."</span>))
</pre>
</div>
</details>

<p>
We also want to define <code>mu4e-compose-from-mailto</code>.
</p>

<details id='sending-mail,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">mu4e-compose-from-mailto</span> (mailto-string <span class="org-type">&amp;optional</span> quit-frame-after)
  (<span class="org-keyword">require</span> '<span class="org-constant">mu4e</span>)
  (<span class="org-keyword">unless</span> mu4e--server-props (mu4e t) (sleep-for 0.1))
  (<span class="org-keyword">let*</span> ((mailto (message-parse-mailto-url mailto-string))
         (to (cadr (assoc <span class="org-string">"to"</span> mailto)))
         (subject (<span class="org-keyword">or</span> (cadr (assoc <span class="org-string">"subject"</span> mailto)) <span class="org-string">""</span>))
         (body (cadr (assoc <span class="org-string">"body"</span> mailto)))
         (headers (-filter (<span class="org-keyword">lambda</span> (spec) (not (-contains-p '(<span class="org-string">"to"</span> <span class="org-string">"subject"</span> <span class="org-string">"body"</span>) (car spec)))) mailto)))
    (<span class="org-keyword">when-let</span> ((mu4e-main (get-buffer mu4e-main-buffer-name)))
      (switch-to-buffer mu4e-main))
    (mu4e~compose-mail to subject headers)
    (<span class="org-keyword">when</span> body
      (goto-char (point-min))
      (<span class="org-keyword">if</span> (eq major-mode 'org-msg-edit-mode)
          (org-msg-goto-body)
        (mu4e-compose-goto-bottom))
      (insert body))
    (goto-char (point-min))
    (<span class="org-keyword">cond</span> ((null to) (search-forward <span class="org-string">"To: "</span>))
          ((string= <span class="org-string">""</span> subject) (search-forward <span class="org-string">"Subject: "</span>))
          (t (<span class="org-keyword">if</span> (eq major-mode 'org-msg-edit-mode)
                 (org-msg-goto-body)
               (mu4e-compose-goto-bottom))))
    (font-lock-ensure)
    (<span class="org-keyword">when</span> evil-normal-state-minor-mode
      (evil-append 1))
    (<span class="org-keyword">when</span> quit-frame-after
      (add-hook 'kill-buffer-hook
                `(<span class="org-keyword">lambda</span> ()
                   (<span class="org-keyword">when</span> (eq (selected-frame) ,(selected-frame))
                     (delete-frame)))))))
</pre>
</div>
</details>

<p>
It would also be nice to change the name pre-filled in <kbd>From:</kbd> when drafting.
</p>
<details id='sending-mail,code--7' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">mu4e-from-name</span> <span class="org-string">"Timothy"</span>
  <span class="org-doc">"Name used in \"From:\" template."</span>)
(<span class="org-keyword">defadvice!</span> mu4e~draft-from-construct-renamed (orig-fn)
  <span class="org-doc">"Wrap `</span><span class="org-doc"><span class="org-constant">mu4e~draft-from-construct-renamed</span></span><span class="org-doc">' to change the name."</span>
  <span class="org-builtin">:around</span> #'mu4e~draft-from-construct
  (<span class="org-keyword">let</span> ((user-full-name mu4e-from-name))
    (funcall orig-fn)))
</pre>
</div>
</details>

<p>
We can also use this a signature,
</p>
<details id='sending-mail,code--8' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--8'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> message-signature mu4e-from-name)
</pre>
</div>
</details>

<p>
I've got a few extra addresses I'd like <code>+mu4e-set-from-address-h</code> to be aware of.
</p>

<details id='sending-mail,code--9' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--9'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-update-personal-addresses</span> ()
  (<span class="org-keyword">let</span> ((primary-address
         (car (cl-remove-if-not
               (<span class="org-keyword">lambda</span> (a) (eq (mod (apply #'* (cl-coerce a 'list)) 600) 0))
               (mu4e-personal-addresses)))))
    (<span class="org-keyword">setq</span> +mu4e-personal-addresses
          (<span class="org-keyword">and</span> primary-address
               (append (mu4e-personal-addresses)
                       (mapcar
                        (<span class="org-keyword">lambda</span> (subalias)
                          (concat subalias <span class="org-string">"@"</span>
                                  (subst-char-in-string ?@ ?. primary-address)))
                        '(<span class="org-string">"orgmode"</span>))
                       (mapcar
                        (<span class="org-keyword">lambda</span> (alias)
                          (replace-regexp-in-string
                           <span class="org-string">"\\`</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">@"</span> alias primary-address t t 1))
                        '(<span class="org-string">"contact"</span> <span class="org-string">"timothy"</span>)))))))

(<span class="org-keyword">add-transient-hook!</span> 'mu4e-compose-pre-hook
  (+mu4e-update-personal-addresses))
</pre>
</div>
</details>

<p>
We also want to use any <kbd>@tecosaur.net</kbd> address as an automatic from address.
</p>

<details id='sending-mail,code--10' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--10'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +mu4e-set-from-adress-h-personal-a (orig-fn)
  <span class="org-builtin">:around</span> #'+mu4e-set-from-address-h
  (<span class="org-keyword">let*</span> ((msg-addrs
          (<span class="org-keyword">and</span> mu4e-compose-parent-message
               (delq nil
                     (mapcar
                      (<span class="org-keyword">lambda</span> (adr) (plist-get adr <span class="org-builtin">:email</span>))
                      (append (mu4e-message-field mu4e-compose-parent-message <span class="org-builtin">:to</span>)
                              (mu4e-message-field mu4e-compose-parent-message <span class="org-builtin">:cc</span>)
                              (mu4e-message-field mu4e-compose-parent-message <span class="org-builtin">:from</span>))))))
         (personal-addrs
          (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> mu4e-contexts +mu4e-personal-addresses)
              (<span class="org-keyword">and</span> (&gt; (length +mu4e-personal-addresses) 1)
                   +mu4e-personal-addresses)
            (mu4e-personal-addresses)))
         (personal-domain-addr
          (cl-some
           (<span class="org-keyword">lambda</span> (email)
             (<span class="org-keyword">and</span> (string-match-p <span class="org-string">"@</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">tec\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?tecosaur\\.net&gt;?$"</span>
                                  email)
                  email))
           msg-addrs)))
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> personal-domain-addr
             (not (cl-intersection msg-addrs personal-addrs <span class="org-builtin">:test</span> #'equal)))
        (<span class="org-keyword">setq</span> user-mail-address personal-domain-addr)
      (funcall orig-fn))))
</pre>
</div>
</details>

<p>
Speaking of, it would be good to put emails sent from <kbd>@tecosaur.net</kbd> in the
account-specific sent directory, not the catch-all.
</p>

<details id='sending-mail,code--11' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--11'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-account-sent-folder</span> (<span class="org-type">&amp;optional</span> msg)
  (<span class="org-keyword">let</span> ((from (<span class="org-keyword">if</span> msg
                  (plist-get (car (plist-get msg <span class="org-builtin">:from</span>)) <span class="org-builtin">:email</span>)
                (<span class="org-keyword">save-restriction</span>
                  (mail-narrow-to-head)
                  (mail-fetch-field <span class="org-string">"from"</span>)))))
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> from (string-match-p <span class="org-string">"@tecosaur\\.net&gt;?\\'"</span> from))
        <span class="org-string">"/tecosaur-net/Sent"</span>
      <span class="org-string">"/sent"</span>)))
(<span class="org-keyword">setq</span> mu4e-sent-folder #'+mu4e-account-sent-folder)
</pre>
</div>
</details>

<p>
When composing an email, I think it would make more sense to start off in <kbd>insert</kbd>
mode than <kbd>normal</kbd> mode, which can be accomplished via a compose hook.
</p>

<details id='sending-mail,code--12' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#sending-mail,code--12'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-evil-enter-insert-mode</span> ()
  (<span class="org-keyword">when</span> (eq (<span class="org-keyword">bound-and-true-p</span> evil-state) 'normal)
    (call-interactively #'evil-append)))

(add-hook 'mu4e-compose-mode-hook #'+mu4e-evil-enter-insert-mode 90)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-working-with-org" class="outline-5">
<h5 id="working-with-org"><span class="section-number-5">4.5.4.3.</span> Working with the Org mailing list<a aria-hidden="true" href="#working-with-org">#</a> </h5>
<div class="outline-text-5" id="text-4-5-4-3">
</div>
<div id="outline-container-adding-x-woof" class="outline-6">
<h6 id="adding-x-woof"><span class="section-number-6">4.5.4.3.1.</span> Adding <kbd>X-Woof</kbd> headers<a aria-hidden="true" href="#adding-x-woof">#</a> </h6>
<div class="outline-text-6" id="text-4-5-4-3-1">
<p>
I'm fairly active on the Org mailing list (<span class='acr'>ML</span>). The Org <span class='acr'>ML</span> has a linked
bug/patch tracker, <a href="https://updates.orgmode.org/">https://updates.orgmode.org/</a> managed by <a href="https://github.com/bzg/woof">Woof</a>. However, I feel
like I spend too much time looking up what the appropriate headers are for
updating the status of bugs and patches. What I need, is some sort of convenient
tool. Let's write one.
</p>

<p>
First, a function that asks what I want to do and returns the appropriate <kbd>X-Woof</kbd>
header.
</p>
<details id='adding-x-woof,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#adding-x-woof,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-get-woof-header</span> ()
  (<span class="org-keyword">pcase</span> (read-char
          (format <span class="org-string">"\</span>
<span class="org-string">%s</span>
<span class="org-string">  %s Declare %s Applied %s Aborted</span>
<span class="org-string">%s</span>
<span class="org-string">  %s Confirm %s Fixed</span>
<span class="org-string">%s</span>
<span class="org-string">  %s Request %s Resolved</span>

<span class="org-string">%s remove X-Woof header"</span>
                  (propertize <span class="org-string">"Patch"</span> 'face 'outline-3)
                  (propertize <span class="org-string">"p"</span> 'face '(bold consult-key))
                  (propertize <span class="org-string">"a"</span> 'face '(bold consult-key))
                  (propertize <span class="org-string">"c"</span> 'face '(bold consult-key))
                  (propertize <span class="org-string">"Bug"</span> 'face 'outline-3)
                  (propertize <span class="org-string">"b"</span> 'face '(bold consult-key))
                  (propertize <span class="org-string">"f"</span> 'face '(bold consult-key))
                  (propertize <span class="org-string">"Help"</span> 'face 'outline-3)
                  (propertize <span class="org-string">"h"</span> 'face '(bold consult-key))
                  (propertize <span class="org-string">"r"</span> 'face '(bold consult-key))
                  (propertize <span class="org-string">"x"</span> 'face '(bold error))))
    (?p <span class="org-string">"X-Woof-Patch: confirmed"</span>)
    (?a <span class="org-string">"X-Woof-Patch: applied"</span>)
    (?c <span class="org-string">"X-Woof-Patch: cancelled"</span>)
    (?b <span class="org-string">"X-Woof-Bug: confirmed"</span>)
    (?f <span class="org-string">"X-Woof-Bug: fixed"</span>)
    (?h <span class="org-string">"X-Woof-Help: confirmed"</span>)
    (?r <span class="org-string">"X-Woof-Help: cancelled"</span>)
    (?x 'delete)))
</pre>
</div>
</details>

<p>
Now we just need a function which will add such a header to a buffer
</p>
<details id='adding-x-woof,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#adding-x-woof,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-insert-woof-header</span> ()
  <span class="org-doc">"Insert an X-Woof header into the current message."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when-let</span> ((header (+mu4e-get-woof-header)))
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (search-forward <span class="org-string">"--text follows this line--"</span>)
      (<span class="org-keyword">unless</span> (eq header 'delete)
        (beginning-of-line)
        (insert header <span class="org-string">"\n"</span>)
        (forward-line -1))
      (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"^X-Woof-"</span> nil t)
        (kill-whole-line)))))

(map! <span class="org-builtin">:map</span> mu4e-compose-mode-map
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"Insert X-Woof Header"</span> <span class="org-string">"w"</span> #'+mu4e-insert-woof-header)

(map! <span class="org-builtin">:map</span> org-msg-edit-mode-map
      <span class="org-builtin">:after</span> org-msg
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"Insert X-Woof Header"</span> <span class="org-string">"w"</span> #'+mu4e-insert-woof-header)
</pre>
</div>
</details>

<p>
Lovely! That should make adding these headers a breeze.
</p>
</div>
</div>
<div id="outline-container-patch-workflow" class="outline-6">
<h6 id="patch-workflow"><span class="section-number-6">4.5.4.3.2.</span> Patch workflow<a aria-hidden="true" href="#patch-workflow">#</a> </h6>
<div class="outline-text-6" id="text-4-5-4-3-2">
<p>
Testing patches from the <span class='acr'>ML</span> is currently more hassle than it needs to be. Let's
change that.
</p>

<details id='patch-workflow,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#patch-workflow,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> mu4e
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-ml-target-dir</span>
    (expand-file-name <span class="org-string">"lisp/org/"</span> doom-user-dir))
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-ml-max-age</span> 600
    <span class="org-doc">"Maximum permissible age in seconds."</span>)
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-ml--cache-timestamp</span> 0)
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-ml--cache</span> nil)

  (<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">+org-ml-patchy-mood-mode</span>
    <span class="org-doc">"Apply patches to Org in bulk."</span>
    <span class="org-builtin">:global</span> t
    (<span class="org-keyword">let</span> ((action (cons <span class="org-string">"apply patch to org"</span> #'+org-ml-apply-patch)))
      (<span class="org-keyword">if</span> +org-ml-patchy-mood-mode
          (add-to-list 'mu4e-view-actions action)
        (<span class="org-keyword">setq</span> mu4e-view-actions (delete action mu4e-view-actions)))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-ml-apply-patch</span> (msg)
    <span class="org-doc">"Apply the patch in the current message to Org."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">unless</span> msg (<span class="org-keyword">setq</span> msg (mu4e-message-at-point)))
    (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Shell: Org apply patches*"</span>)
      (erase-buffer)
      (<span class="org-keyword">let*</span> ((default-directory +org-ml-target-dir)
             (exit-code (call-process <span class="org-string">"git"</span> nil t nil <span class="org-string">"am"</span> (mu4e-message-field msg <span class="org-builtin">:path</span>))))
        (magit-refresh)
        (<span class="org-keyword">when</span> (not (= 0 exit-code))
          (+popup/buffer)))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-ml-current-patches</span> ()
    <span class="org-doc">"Get the currently open patches, as a list of alists.</span>
<span class="org-doc">Entries of the form (subject . id)."</span>
    (delq nil
          (mapcar
           (<span class="org-keyword">lambda</span> (entry)
             (<span class="org-keyword">unless</span> (plist-get entry <span class="org-builtin">:fixed</span>)
               (cons
                (format <span class="org-string">"%-8s  %s"</span>
                        (propertize
                         (replace-regexp-in-string <span class="org-string">"T.*"</span> <span class="org-string">""</span>
                                                   (plist-get entry <span class="org-builtin">:date</span>))
                         'face 'font-lock-doc-face)
                        (propertize
                         (replace-regexp-in-string <span class="org-string">"\\[</span><span class="org-string"><span class="org-constant">PATCH\\</span></span><span class="org-string">] ?"</span> <span class="org-string">""</span>
                                                   (plist-get entry <span class="org-builtin">:summary</span>))
                         'face 'font-lock-keyword-face))
                (plist-get entry <span class="org-builtin">:id</span>))))
           (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously <span class="org-string">"https://updates.orgmode.org/data/patches"</span>)
             (goto-char url-http-end-of-headers)
             (json-parse-buffer <span class="org-builtin">:object-type</span> 'plist)))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-ml-select-patch-thread</span> ()
    <span class="org-doc">"Find and apply a proposed Org patch."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">let*</span> ((current-workspace (+workspace-current))
           (patches (<span class="org-keyword">progn</span>
                      (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (not +org-ml--cache)
                                (&gt; (- (float-time) +org-ml--cache-timestamp)
                                   +org-ml-max-age))
                        (<span class="org-keyword">setq</span> +org-ml--cache (+org-ml-current-patches)
                              +org-ml--cache-timestamp (float-time)))
                      +org-ml--cache))
           (msg-id (cdr (assoc (completing-read
                                <span class="org-string">"Thread: "</span> (mapcar #'car patches))
                               patches))))
      (+workspace-switch +mu4e-workspace-name)
      (mu4e-view-message-with-message-id msg-id)
      (<span class="org-keyword">unless</span> +org-ml-patchy-mood-mode
        (add-to-list 'mu4e-view-actions
                     (cons <span class="org-string">"apply patch to org"</span> #'+org-ml-transient-mu4e-action)))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-ml-transient-mu4e-action</span> (msg)
    (<span class="org-keyword">setq</span> mu4e-view-actions
          (delete (cons <span class="org-string">"apply patch to org"</span> #'+org-ml-transient-mu4e-action)
                  mu4e-view-actions))
    (+workspace/other)
    (magit-status +org-ml-target-dir)
    (+org-ml-apply-patch msg)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-mail-list-archive" class="outline-6">
<h6 id="mail-list-archive"><span class="section-number-6">4.5.4.3.3.</span> Mail list archive links<a aria-hidden="true" href="#mail-list-archive">#</a> </h6>
<div class="outline-text-6" id="text-4-5-4-3-3">
<p>
The other thing which it's good to be easily able to do is grab a link to the
current message on <a href="https://list.orgmode.org">https://list.orgmode.org</a>.
</p>

<details id='mail-list-archive,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mail-list-archive,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> mu4e
  (<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-ml-message-link</span> (msg)
    <span class="org-doc">"Copy the link to MSG on the mailing list archives."</span>
    (<span class="org-keyword">let*</span> ((list-addr (<span class="org-keyword">or</span> (mu4e-message-field msg <span class="org-builtin">:list</span>)
                          (<span class="org-keyword">thread-last</span> (append (mu4e-message-field-raw msg <span class="org-builtin">:list-post</span>)
                                               (mu4e-message-field msg <span class="org-builtin">:to</span>)
                                               (mu4e-message-field msg <span class="org-builtin">:cc</span>))
                                       (mapcar (<span class="org-keyword">lambda</span> (e) (plist-get e <span class="org-builtin">:email</span>)))
                                       (mapcar (<span class="org-keyword">lambda</span> (addr)
                                                 (<span class="org-keyword">when</span> (string-match-p <span class="org-string">"emacs.*@gnu\\.org$"</span> addr)
                                                   (replace-regexp-in-string <span class="org-string">"@"</span> <span class="org-string">"."</span> addr))))
                                       (delq nil)
                                       (car))))
           (msg-url
            (<span class="org-keyword">pcase</span> list-addr
              (<span class="org-string">"emacs-orgmode.gnu.org"</span>
               (format <span class="org-string">"https://list.orgmode.org/%s"</span> (mu4e-message-field msg <span class="org-builtin">:message-id</span>)))
              (_ (<span class="org-warning">user-error</span> <span class="org-string">"Mailing list %s not supported"</span> list-addr)))))
      (gui-select-text msg-url)
      (message <span class="org-string">"Link %s copied to clipboard"</span>
               (propertize msg-url 'face '((<span class="org-builtin">:weight</span> normal <span class="org-builtin">:underline</span> nil) link)))
      msg-url))

  (add-to-list 'mu4e-view-actions (cons <span class="org-string">"link to message ML"</span> #'+mu4e-ml-message-link) t))
</pre>
</div>
</details>

<p>
In a similar manner, when clicking on such a link (say when someone uses a link
to the archive to refer to an earlier email) I'd much rather look at it in mu4e.
</p>

<details id='mail-list-archive,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mail-list-archive,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+browse-url-orgmode-ml</span> (url <span class="org-type">&amp;optional</span> _)
  <span class="org-doc">"Open an orgmode list url using notmuch."</span>
  (<span class="org-keyword">let</span> ((id (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> (string-match <span class="org-string">"^https?://orgmode\\.org/list/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> url)
                     (string-match <span class="org-string">"^https?://list\\.orgmode\\.org/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> url))
                 (match-string 1 url))))
    (mu4e-view-message-with-message-id id)))

(add-to-list 'browse-url-handlers (cons <span class="org-string">"^https?://orgmode\\.org/list"</span> #'+browse-url-orgmode-ml))
(add-to-list 'browse-url-handlers (cons <span class="org-string">"^https?://list\\.orgmode\\.org/"</span> #'+browse-url-orgmode-ml))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-setup-when-composing" class="outline-6">
<h6 id="setup-when-composing"><span class="section-number-6">4.5.4.3.4.</span> Setup when composing a new email<a aria-hidden="true" href="#setup-when-composing">#</a> </h6>
<div class="outline-text-6" id="text-4-5-4-3-4">
<p>
Thanks to having a dedicated address for my interactions with the Org <span class='acr'>ML</span>, and
Doom's <code>+mu4e-set-from-address-h</code>, we can tell at the end of compose setup whether
I'm composing an email to the Org <span class='acr'>ML</span> and then do a little setup for convenience,
namely:
</p>
<ul class="org-ul">
<li>Pre-fill the <kbd>To</kbd> address</li>
<li>Ensure that <kbd>org-msg</kbd> is set up to send plaintext only</li>
<li>Set <code>default-directory</code> to my local Org repository (where patch files are
generated)</li>
<li>Move <code>(point)</code> to the <kbd>Subject:</kbd> line</li>
<li>Use a special Org-<span class='acr'>ML</span>-specific signature</li>
</ul>

<details id='setup-when-composing,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#setup-when-composing,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-compose-org-ml-setup</span> ()
  (<span class="org-keyword">when</span> (string-match-p <span class="org-string">"\\`orgmode@"</span> user-mail-address)
    (goto-char (point-min))
    (<span class="org-keyword">save-restriction</span>
      (mail-narrow-to-head)
      (<span class="org-keyword">when</span> (string-empty-p (mail-fetch-field <span class="org-string">"to"</span>))
        (re-search-forward <span class="org-string">"^To: .*$"</span>)
        (replace-match <span class="org-string">"To: emacs-orgmode@gnu.org"</span>)
        (advice-add 'message-goto-to <span class="org-builtin">:after</span> #'+mu4e-goto-subject-not-to-once)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> org-msg-mode
               (re-search-forward <span class="org-string">"^:alternatives: (</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">utf-8 html</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">)"</span> nil t))
      (replace-match <span class="org-string">"utf-8"</span> t t nil 1))
    (<span class="org-keyword">if</span> org-msg-mode
        (<span class="org-keyword">let</span> ((final-elem (org-element-at-point (point-max))))
          (<span class="org-keyword">when</span> (equal (org-element-property <span class="org-builtin">:type</span> final-elem) <span class="org-string">"signature"</span>)
            (goto-char (org-element-property <span class="org-builtin">:contents-begin</span> final-elem))
            (delete-region (org-element-property <span class="org-builtin">:contents-begin</span> final-elem)
                           (org-element-property <span class="org-builtin">:contents-end</span> final-elem))
            (<span class="org-keyword">setq-local</span> org-msg-signature
                        (format <span class="org-string">"\n\n#+begin_signature\n%s\n#+end_signature"</span>
                                (cdr +mu4e-org-ml-signature)))
            (insert (cdr +mu4e-org-ml-signature) <span class="org-string">"\n"</span>)))
      (goto-char (point-max))
      (insert (car +mu4e-org-ml-signature)))
    (<span class="org-keyword">setq</span> default-directory
          (file-name-concat doom-user-dir <span class="org-string">"lisp/org/"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">+mu4e-goto-subject-not-to-once</span> ()
  (message-goto-subject)
  (advice-remove 'message-goto-to #'+mu4e-goto-subject-not-to-once))
</pre>
</div>
</details>

<p>
Now let's set up that signature.
</p>

<details id='setup-when-composing,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#setup-when-composing,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+mu4e-org-ml-signature</span>
  (cons
   <span class="org-string">"All the best,</span>
<span class="org-string">Timothy</span>

<span class="org-string">-- \</span>
<span class="org-string">Timothy (&#8216;</span><span class="org-string"><span class="org-constant">tecosaur</span></span><span class="org-string">&#8217;/&#8216;</span><span class="org-string"><span class="org-constant">TEC</span></span><span class="org-string">&#8217;), Org mode contributor.</span>
<span class="org-string">Learn more about Org mode at <a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">&lt;https://orgmode.org/&gt;.</a></span><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">
</a><span class="org-string"><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">Support Org development at &lt;https://liberapay.com/org-mode&gt;,</a></span><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">
</a><span class="org-string"><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">or support my work at &lt;https://liberapay.com/tec&gt;.</a></span><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">
</a><span class="org-string"><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">"</a></span><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">
   </a><span class="org-string"><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">"All the best,\\\\</a></span><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">
</a><span class="org-string"><a href="https://orgmode.org/&gt;.
Support Org development at &lt;https://liberapay.com/org-mode&gt;,
or support my work at &lt;https://liberapay.com/tec&gt;.
&quot;
   &quot;All the best,\\\\
@@html:&lt;b&gt;@@Timothy@@html:&lt;/b">@@html:&lt;b&gt;@@Timothy@@html:&lt;/b&gt;</a>@@</span>

<span class="org-string">-\u200b- \\\\</span>
<span class="org-string">Timothy (&#8216;</span><span class="org-string"><span class="org-constant">tecosaur</span></span><span class="org-string">&#8217;/&#8216;</span><span class="org-string"><span class="org-constant">TEC</span></span><span class="org-string">&#8217;), Org mode contributor.\\\\</span>
<span class="org-string">Learn more about Org mode at https://orgmode.org/.\\\\</span>
<span class="org-string">Support Org development at https://liberapay.com/org-mode,\\\\</span>
<span class="org-string">or support my work at https://liberapay.com/tec."</span>)
  <span class="org-doc">"Plain and Org version of the org-ml specific signature."</span>)
</pre>
</div>
</details>

<p>
Now to make this take effect, we can just add it a bit later on in
<code>mu4e-compose-mode-hook</code> (after <code>org-msg-post-setup</code>) by setting a hook depth of 1.
</p>

<details id='setup-when-composing,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#setup-when-composing,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'mu4e-compose-mode-hook #'+mu4e-compose-org-ml-setup 1)
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
<div id="outline-container-org-msg" class="outline-4">
<h4 id="org-msg"><span class="section-number-4">4.5.5.</span> Org Msg<a aria-hidden="true" href="#org-msg">#</a> </h4>
<div class="outline-text-4" id="text-4-5-5">
<p>
Doom does a fantastic stuff with the defaults with this, so we only make a few
minor tweaks. First, some stylistic things:
</p>

<details id='org-msg,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-msg,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-msg-greeting-fmt <span class="org-string">"\nHi%s,\n\n"</span>
      org-msg-signature <span class="org-string">"\n\n#+begin_signature\nAll the best,\\\\\n@@html:&lt;b&gt;@@Timothy@@html:&lt;/b&gt;@@\n#+end_signature"</span>)
</pre>
</div>
</details>

<p>
We also want to set the accent colour used in the Doom <kbd>mu4e</kbd> module's
construction of the default org-msg style.
</p>

<details id='org-msg,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-msg,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> +org-msg-accent-color <span class="org-string">"#1a5fb4"</span>)
</pre>
</div>
</details>

<p>
Now, it would be nice to easily jump to and between the ends of the message
body, so let's make a function for this.
</p>

<details id='org-msg,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-msg,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+org-msg-goto-body</span> (<span class="org-type">&amp;optional</span> end)
  <span class="org-doc">"Go to either the beginning or the end of the body.</span>
<span class="org-doc">END can be the symbol top, bottom, or nil to toggle."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((initial-pos (point)))
    (org-msg-goto-body)
    (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (eq end 'top)
              (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> (memq initial-pos <span class="org-comment-delimiter">; </span><span class="org-comment">Already at bottom</span>
                             (list (point) (1- (point))))
                       (&lt;= initial-pos <span class="org-comment-delimiter">; </span><span class="org-comment">Above message body</span>
                           (<span class="org-keyword">save-excursion</span>
                             (message-goto-body)
                             (point))))
                   (not (eq end 'bottom))))
      (message-goto-body)
      (re-search-forward
       (format (regexp-quote org-msg-greeting-fmt) <span class="org-comment-delimiter">; </span><span class="org-comment">%s is unaffected.</span>
               (concat <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> "</span> (regexp-quote (org-msg-get-to-name)) <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>))))))
</pre>
</div>
</details>

<p>
We can replace the evil binding of <kbd>mu4e-compose-goto-bottom</kbd> with this function.
</p>

<details id='org-msg,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-msg,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:map</span> org-msg-edit-mode-map
      <span class="org-builtin">:after</span> org-msg
      <span class="org-builtin">:n</span> <span class="org-string">"G"</span> #'+org-msg-goto-body)
</pre>
</div>
</details>

<p>
It would also be good to call this when replying to a message. This has to be
implemented as advice as the compose hooks are run before <code>mu4e~compose-handler</code>
moves the point with <code>message-goto-&lt;location&gt;</code>.
</p>

<details id='org-msg,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-msg,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+org-msg-goto-body-when-replying</span> (compose-type <span class="org-type">&amp;rest</span> _)
  <span class="org-doc">"Call `</span><span class="org-doc"><span class="org-constant">+org-msg-goto-body</span></span><span class="org-doc">' when the current message is a reply."</span>
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> org-msg-edit-mode (eq compose-type 'reply))
    (+org-msg-goto-body)))

(advice-add 'mu4e~compose-handler <span class="org-builtin">:after</span> #'+org-msg-goto-body-when-replying)
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
<div id="outline-container-language-configuration" class="outline-2">
<h2 id="language-configuration"><span class="section-number-2">5.</span> Language configuration<a aria-hidden="true" href="#language-configuration">#</a> </h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-general" class="outline-3">
<h3 id="general"><span class="section-number-3">5.1.</span> General<a aria-hidden="true" href="#general">#</a> </h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-file-templates" class="outline-4">
<h4 id="file-templates"><span class="section-number-4">5.1.1.</span> File Templates<a aria-hidden="true" href="#file-templates">#</a> </h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
For some file types, we overwrite defaults in the <a href="./snippets">snippets</a> directory, others
need to have a template assigned.
</p>

<details id='file-templates,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#file-templates,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(set-file-template! <span class="org-string">"\\.tex$"</span> <span class="org-builtin">:trigger</span> <span class="org-string">"__"</span> <span class="org-builtin">:mode</span> 'latex-mode)
(set-file-template! <span class="org-string">"\\.org$"</span> <span class="org-builtin">:trigger</span> <span class="org-string">"__"</span> <span class="org-builtin">:mode</span> 'org-mode)
(set-file-template! <span class="org-string">"/LICEN[CS]E$"</span> <span class="org-builtin">:trigger</span> '+file-templates/insert-license)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-plaintext" class="outline-3">
<h3 id="plaintext"><span class="section-number-3">5.2.</span> Plaintext<a aria-hidden="true" href="#plaintext">#</a> </h3>
<div class="outline-text-3" id="text-5-2">
</div>
<div id="outline-container-ansi-colours" class="outline-4">
<h4 id="ansi-colours"><span class="section-number-4">5.2.1.</span> Ansi colours<a aria-hidden="true" href="#ansi-colours">#</a> </h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
It's nice to see <span class='acr'>ANSI</span> colour codes displayed, however we don't want to disrupt
<span class='acr'>ANSI</span> codes in Org src blocks.
</p>

<details id='ansi-colours,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ansi-colours,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> text-mode
  (<span class="org-keyword">add-hook!</span> 'text-mode-hook
    (<span class="org-keyword">unless</span> (derived-mode-p 'org-mode)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Apply ANSI color codes</span>
      (<span class="org-keyword">with-silent-modifications</span>
        (ansi-color-apply-on-region (point-min) (point-max) t)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-margin-without-line" class="outline-4">
<h4 id="margin-without-line"><span class="section-number-4">5.2.2.</span> Margin without line numbers<a aria-hidden="true" href="#margin-without-line">#</a> </h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
Display-wise, somehow I don't mind code buffers without any margin on the left,
but it feels a bit off with text buffers once the padding provided by line
numbers is stripped away.
</p>

<details id='margin-without-line,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#margin-without-line,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+text-mode-left-margin-width</span> 1
  <span class="org-doc">"The `</span><span class="org-doc"><span class="org-constant">left-margin-width</span></span><span class="org-doc">' to be used in `</span><span class="org-doc"><span class="org-constant">text-mode</span></span><span class="org-doc">' buffers."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">+setup-text-mode-left-margin</span> ()
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (derived-mode-p 'text-mode)
             (not (<span class="org-keyword">and</span> (<span class="org-keyword">bound-and-true-p</span> visual-fill-column-mode)
                       visual-fill-column-center-text))
             (eq (current-buffer) <span class="org-comment-delimiter">; </span><span class="org-comment">Check current buffer is active.</span>
                 (window-buffer (frame-selected-window))))
    (<span class="org-keyword">setq</span> left-margin-width (<span class="org-keyword">if</span> display-line-numbers
                                0 +text-mode-left-margin-width))
    (set-window-buffer (get-buffer-window (current-buffer))
                       (current-buffer))))

</pre>
</div>
</details>

<p>
Now we just need to hook this up to all the events which could either indicate a
change in the conditions or require the setup to be re-applied.
</p>

<details id='margin-without-line,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#margin-without-line,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'window-configuration-change-hook #'+setup-text-mode-left-margin)
(add-hook 'display-line-numbers-mode-hook #'+setup-text-mode-left-margin)
(add-hook 'text-mode-hook #'+setup-text-mode-left-margin)
</pre>
</div>
</details>

<p>
There's one little niggle with Doom, as <code>doom/toggle-line-numbers</code> doesn't run
<code>display-line-numbers-mode-hook</code>, so some advice is needed.
</p>

<details id='margin-without-line,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#margin-without-line,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +doom/toggle-line-numbers--call-hook-a ()
  <span class="org-builtin">:after</span> #'doom/toggle-line-numbers
  (run-hooks 'display-line-numbers-mode-hook))
</pre>
</div>
</details>

<p>
Lastly, I think I actually like this enough that I'll go ahead and remove line
numbers in text mode.
</p>

<details id='margin-without-line,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#margin-without-line,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(remove-hook 'text-mode-hook #'display-line-numbers-mode)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-org" class="outline-3">
<h3 id="org"><span class="section-number-3">5.3.</span> Org<a aria-hidden="true" href="#org">#</a> </h3>
<div class="outline-text-3" id="text-org">
<p>
I really like org mode, I've given some thought to why, and below is the result.
</p>

<div id=',table--1' class='table'>
<div class='gutter'><a href='#,table--1'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Format</th>
<th scope="col" class="org-right">Fine-grained control</th>
<th scope="col" class="org-right">Initial ease of use</th>
<th scope="col" class="org-right">Syntax simplicity</th>
<th scope="col" class="org-right">Editor Support</th>
<th scope="col" class="org-right">Integrations</th>
<th scope="col" class="org-right">Ease-of-referencing</th>
<th scope="col" class="org-right">Versatility</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Word</td>
<td class="org-right">2</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">LaTeX</td>
<td class="org-right">4</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">Org Mode</td>
<td class="org-right">4</td>
<td class="org-right">2</td>
<td class="org-right">3.5</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">Markdown</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">Markdown + Pandoc</td>
<td class="org-right">2.5</td>
<td class="org-right">2.5</td>
<td class="org-right">2.5</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
</div></div>


<figure id="orgcfc14c0">
<img src="misc/document-format-comparison.svg" alt="Radar chart comparing my opinions of document formats." class="invertible">

</figure>

<p>
Beyond the elegance in the markup language, tremendously rich integrations with
Emacs allow for some fantastic <a href="https://orgmode.org/features.html">features</a>, such as what seems to be the best
support for <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a> of any currently available technology.
</p>

<details id='org501690a' class='code' open>
<summary></summary>
<div class='gutter'><a href='#org501690a'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre style="line-height:1.13;" class="example" id="org501690a">
      ╭─╴Code╶─╮            ╭─╴Raw Code╶─▶ Computer
Ideas╺┥        ┝━▶ Org Mode╺┥
      ╰─╴Text╶─╯            ╰─╴Document╶─▶ People
</pre>

</details>

<p>
An <kbd>.org</kbd> file can contain blocks of code (with <a href="https://en.wikipedia.org/wiki/Noweb">noweb</a> templating support), which
can be <a href="https://orgmode.org/manual/Extracting-Source-Code.html">tangled</a> to dedicated source code files, and <a href="https://orgmode.org/manual/Extracting-Source-Code.html">woven</a> into a document
(report, documentation, presentation, etc.) through various (<i>extensible</i>) methods.
These source blocks may even create images or other content to be included in
the document, or generate source code.
</p>

<details id='orgda0cbae' class='code' open>
<summary></summary>
<div class='gutter'><a href='#orgda0cbae'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre style="line-height:1.13;" class="example" id="orgda0cbae">
                   ╭───────────────────────────────────▶ .pdf ⎫
                  pdfLaTeX ▶╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╮                 ⎪
                   ╿     ╿                  ┊                 ⎪
                   │     ┊                  ┊                 ⎪
                 .tex    ┊                  ┊                 ⎪
                   ╿     ┊                  ┊                 ⎪
                ╭──┴╌╌╮  ┊                  ┊ style.scss      ⎬ Weaving
graphc.png ─╮   │  embedded TeX             ┊      ╽          ⎪ (Documents)
image.jpeg ─┤ filters   ╿                   ┊    .css         ⎪
            ╎     ╿     ┊                   ┊     ▾╎          ⎪
figure.png╶─╧─▶ PROJECT.ORG ▶───╴filters╶───╧──────╪──▶ .html ⎪
     ╿           ╿┊ ║ │ ╰╌╌╌▷╌╌ embedded html ▶╌╌╌╌╯          ⎪
     ├╌╌╌╌╌╌╌▷╌╌╌╯┊ ║ │                                       ⎪
    result╶╌╌╌╌╌╮ ┊ ║ ├──────╴filters╶────────────────▶ .txt  ⎪
     ┊▴         ┊ ┊ ║ │                                       ⎪
    execution   ┊ ┊ ║ ╰──────╴filters╶────────────────▶ .md   ⎭
     ┊▴         ┊ ┊ ║
    code blocks◀╯ ┊ ╟─────────────────────────────────▶ .c    ⎫
     ╰╌╌╌╌◁╌╌╌╌╌╌╌╯ ╟─────────────────────────────────▶ .sh   ⎬ Tangling
                    ╟─────────────────────────────────▶ .hs   ⎪ (Code)
                    ╙─────────────────────────────────▶ .el   ⎭
</pre>

</details>
</div>
<div id="outline-container-system-config" class="outline-4">
<h4 id="system-config"><span class="section-number-4">5.3.1.</span> System config<a aria-hidden="true" href="#system-config">#</a> </h4>
<div class="outline-text-4" id="text-5-3-1">
</div>
<div id="outline-container-mime-types" class="outline-5">
<h5 id="mime-types"><span class="section-number-5">5.3.1.1.</span> Mime types<a aria-hidden="true" href="#mime-types">#</a> </h5>
<div class="outline-text-5" id="text-5-3-1-1">
<p>
Org mode isn't recognised as it's own mime type by default, but that can easily
be changed with the following file. For system-wide changes try
<code>/usr/share/mime/packages/org.xml</code>.
</p>
<details id='mime-types,code--1' class='code' open><summary><span class="lang">XML</span></summary>
<div class='gutter'>
<a href='#mime-types,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">mime-info</span> <span class="org-nxml-namespace-attribute-xmlns">xmlns</span>=<span class="org-string">'http://www.freedesktop.org/standards/shared-mime-info'</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">mime-type</span> <span class="org-nxml-attribute-local-name">type</span>=<span class="org-string">"text/org"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">comment</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">Emacs Org-mode File</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">comment</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">glob</span> <span class="org-nxml-attribute-local-name">pattern</span>=<span class="org-string">"*.org"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">alias</span> <span class="org-nxml-attribute-local-name">type</span>=<span class="org-string">"text/org"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">mime-type</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">mime-info</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
</details>
<p>
What's nice is that Papirus <a href="https://github.com/PapirusDevelopmentTeam/papirus-icon-theme/commit/a10fb7f2423d5e30b9c4477416ccdc93c4f3849d">now</a> has an icon for <kbd>text/org</kbd>.
One simply needs to refresh their mime database
</p>
<details id='mime-types,code--2' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#mime-types,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">update-mime-database ~/.local/share/mime
</pre>
</div>
</details>
<p>
Then set Emacs as the default editor
</p>
<details id='mime-types,code--3' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#mime-types,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">xdg-mime default emacs.desktop text/org
</pre>
</div>
</details>

<p>
Once again, we will add <kbd>doctor</kbd> checks around this.
</p>

<details id='mime-types,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mime-types,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">if</span> (string= (shell-command-to-string <span class="org-string">"xdg-mime query default text/org"</span>) <span class="org-string">""</span>)
  (warn! <span class="org-string">"text/org is not a registered mime type."</span>)
  (<span class="org-keyword">unless</span> (string= (shell-command-to-string <span class="org-string">"xdg-mime query default text/org"</span>) <span class="org-string">"emacs-client.desktop\n"</span>)
    (warn! <span class="org-string">"Emacs(client) is not set up as the text/org handler."</span>)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-git-diffs" class="outline-5">
<h5 id="git-diffs"><span class="section-number-5">5.3.1.2.</span> Git diffs<a aria-hidden="true" href="#git-diffs">#</a> </h5>
<div class="outline-text-5" id="text-5-3-1-2">
<p>
Protesilaos wrote a <a href="https://protesilaos.com/codelog/2021-01-26-git-diff-hunk-elisp-org/">very helpful article</a> in which he explains how to change the
git diff chunk heading to something more useful than just the immediate line
above the hunk &#x2014; like the parent heading.
</p>

<p>
This can be achieved by first adding a new diff mode to git in <kbd>~/.config/git/attributes</kbd>
</p>
<details id='git-diffs,code--1' class='code' open><summary><span class="lang">gitattributes</span></summary>
<div class='gutter'>
<a href='#git-diffs,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-gitattributes"><span class="org-keyword">*</span>.org   <span class="org-variable-name">diff</span>=org
</pre>
</div>
</details>

<p>
Then adding a regex for it to <kbd>~/.config/git/config</kbd>
</p>
<details id='git-diffs,code--2' class='code' open><summary><span class="lang">gitconfig</span></summary>
<div class='gutter'>
<a href='#git-diffs,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-gitconfig">[<span class="org-type">diff</span> <span class="org-function-name">"org"</span>]
  <span class="org-variable-name">xfuncname</span> = <span class="org-string">"^(\\*+ +.*)$"</span>
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-org-packages" class="outline-4">
<h4 id="org-packages"><span class="section-number-4">5.3.2.</span> Packages<a aria-hidden="true" href="#org-packages">#</a> </h4>
<div class="outline-text-4" id="text-5-3-2">
</div>
<div id="outline-container-org-itself" class="outline-5">
<h5 id="org-itself"><span class="section-number-5">5.3.2.1.</span> Org itself<a aria-hidden="true" href="#org-itself">#</a> </h5>
<div class="outline-text-5" id="text-5-3-2-1">
<p>
There are actually three possible package statements I may want to use for Org.
</p>

<p>
If I'm on a machine where I can push changes, I want to be able to develop Org.
I can check this by checking the content of the <span class='acr'>SSH</span> key <kbd>~/.ssh/id_ed25519.pub</kbd>.
</p>
<ol class="org-ol">
<li>If this key exists and there isn't a repo at
<kbd>$doom-user-dir/lisp/org</kbd> with the right remote, we should
install it as such.</li>
<li>If the key exists and repo are both set up, the package should just be ignored.</li>
<li>If the key does not exist, the Org's <code>HEAD</code> should just be used</li>
</ol>

<p>
To account for this situation properly, we need a short script to determine the
correct package statement needed.
</p>

<details id='org-pkg-statement' class='code' open><summary class='named'><span class="name">org-pkg-statement</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-pkg-statement'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">or</span> (<span class="org-keyword">require</span> '<span class="org-constant">doom</span> (expand-file-name <span class="org-string">"lisp/doom.el"</span>
                                     (<span class="org-keyword">or</span> (<span class="org-keyword">bound-and-true-p</span> doom-emacs-dir)
                                         user-emacs-directory)))
    (<span class="org-keyword">setq</span> doom-local-dir
          (expand-file-name <span class="org-string">".local/"</span> (<span class="org-keyword">or</span> (<span class="org-keyword">bound-and-true-p</span> doom-emacs-dir)
                                          user-emacs-directory))))
(<span class="org-keyword">let</span> ((dev-key-p (<span class="org-keyword">and</span> (file-exists-p <span class="org-string">"~/.ssh/id_ed25519.pub"</span>)
                      (= 0 (shell-command <span class="org-string">"cat ~/.ssh/id_ed25519.pub | grep -q AAAAC3NzaC1lZDI1NTE5AAAAIOZZqcJOLdN+QFHKyW8ST2zz750+8TdvO9IT5geXpQVt"</span>))))
      (recipe-common '(<span class="org-builtin">:files</span> (<span class="org-builtin">:defaults</span> <span class="org-string">"etc"</span>)
                       <span class="org-builtin">:build</span> t
                       <span class="org-builtin">:pre-build</span>
                       (<span class="org-keyword">with-temp-file</span> <span class="org-string">"lisp/org-version.el"</span>
                         (<span class="org-keyword">require</span> '<span class="org-constant">lisp-mnt</span>)
                         (<span class="org-keyword">let</span> ((version <span class="org-comment-delimiter">;; </span><span class="org-comment">(lm-version "lisp/org.el")</span>
                                (<span class="org-keyword">with-temp-buffer</span>
                                  (insert-file-contents <span class="org-string">"lisp/org.el"</span>)
                                  (lm-header <span class="org-string">"version"</span>)))
                               (git-version (string-trim
                                             (<span class="org-keyword">with-temp-buffer</span>
                                               (call-process <span class="org-string">"git"</span> nil t nil
                                                             <span class="org-string">"rev-parse"</span> <span class="org-string">"--short"</span> <span class="org-string">"HEAD"</span>)
                                               (buffer-string)))))
                           (insert (format <span class="org-string">"(defun org-release () \"The release version of Org.\" %S)\n"</span>
                                           version)
                                   (format <span class="org-string">"(defun org-git-version () \"The truncate git commit hash of Org mode.\" %S)\n"</span>
                                           git-version)
                                   <span class="org-string">"(provide 'org-version)\n"</span>))))))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert
     (pp `(<span class="org-keyword">package!</span> org
            <span class="org-builtin">:recipe</span> (,@(<span class="org-keyword">if</span> dev-key-p
                           (list <span class="org-builtin">:host</span> nil <span class="org-builtin">:repo</span> <span class="org-string">"tec@git.savannah.gnu.org:/srv/git/emacs/org-mode.git"</span> <span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/org"</span>
                                 <span class="org-builtin">:fork</span> (list <span class="org-builtin">:host</span> nil <span class="org-builtin">:repo</span> <span class="org-string">"git@ssh.tecosaur.net:tec/org-mode.git"</span> <span class="org-builtin">:branch</span> <span class="org-string">"dev"</span> <span class="org-builtin">:remote</span> <span class="org-string">"tecosaur"</span>))
                         (list <span class="org-builtin">:host</span> nil <span class="org-builtin">:repo</span> <span class="org-string">"https://code.tecosaur.net/mirrors/org-mode.git"</span> <span class="org-builtin">:remote</span> <span class="org-string">"mirror"</span>
                               <span class="org-builtin">:fork</span> (list <span class="org-builtin">:host</span> nil <span class="org-builtin">:repo</span> <span class="org-string">"https://code.tecosaur.net/tec/org-mode.git"</span> <span class="org-builtin">:branch</span> <span class="org-string">"dev"</span> <span class="org-builtin">:remote</span> <span class="org-string">"tecosaur"</span>)))
                     ,@recipe-common)
            <span class="org-builtin">:pin</span> nil)))
    (untabify (point-min) (point-max))
    (buffer-string)))
</pre>
</div>
</details>

<details id='org-itself,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-itself,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;org-pkg-statement()&gt;&gt;
(<span class="org-keyword">unpin!</span> org) <span class="org-comment-delimiter">; </span><span class="org-comment">there be bugs</span>
(<span class="org-keyword">package!</span> org-contrib
  <span class="org-comment-delimiter">;; </span><span class="org-comment">The `</span><span class="org-comment"><span class="org-constant">sr.ht</span></span><span class="org-comment">' repo has been a bit flaky as of late.</span>
  <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"emacsmirror/org-contrib"</span>
           <span class="org-builtin">:files</span> (<span class="org-string">"lisp/*.el"</span>))
  <span class="org-builtin">:pin</span> <span class="org-string">"8d14a600a2069ffc494edfc9a12b8e5fc8840bf1"</span>)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-packages-visuals" class="outline-5">
<h5 id="packages-visuals"><span class="section-number-5">5.3.2.2.</span> Visuals<a aria-hidden="true" href="#packages-visuals">#</a> </h5>
<div class="outline-text-5" id="text-5-3-2-2">
</div>
<div id="outline-container-org-modern" class="outline-6">
<h6 id="org-modern"><span class="section-number-6">5.3.2.2.1.</span> Org Modern<a aria-hidden="true" href="#org-modern">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-2-1">
<p>
Fontifying <kbd>org-mode</kbd> buffers to be as pretty as possible is of paramount importance,
and Minad's lovely <kbd>org-modern</kbd> goes a long way in this regard.
</p>

<details id='org-modern,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-modern,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-modern <span class="org-builtin">:pin</span> <span class="org-string">"a58534475b4312b0920aa9d3824272470c8e3500"</span>)
</pre>
</div>
</details>

<p>
&#x2026;with a touch of configuration&#x2026;
</p>

<details id='org-modern,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-modern,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-modern
  <span class="org-builtin">:hook</span> (org-mode . org-modern-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-modern-star '(<span class="org-string">"&#9673;"</span> <span class="org-string">"&#9675;"</span> <span class="org-string">"&#10040;"</span> <span class="org-string">"&#10047;"</span> <span class="org-string">"&#10020;"</span> <span class="org-string">"&#10012;"</span> <span class="org-string">"&#9670;"</span> <span class="org-string">"&#9654;"</span>)
        org-modern-table-vertical 1
        org-modern-table-horizontal 0.2
        org-modern-list '((43 . <span class="org-string">"&#10148;"</span>)
                          (45 . <span class="org-string">"&#8211;"</span>)
                          (42 . <span class="org-string">"&#8226;"</span>))
        org-modern-todo-faces
        '((<span class="org-string">"TODO"</span> <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> org-todo)
          (<span class="org-string">"PROJ"</span> <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-project)
          (<span class="org-string">"STRT"</span> <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-active)
          (<span class="org-string">"[-]"</span>  <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-active)
          (<span class="org-string">"HOLD"</span> <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-onhold)
          (<span class="org-string">"WAIT"</span> <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-onhold)
          (<span class="org-string">"[?]"</span>  <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-onhold)
          (<span class="org-string">"KILL"</span> <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-cancel)
          (<span class="org-string">"NO"</span>   <span class="org-builtin">:inverse-video</span> t <span class="org-builtin">:inherit</span> +org-todo-cancel))
        org-modern-footnote
        (cons nil (cadr org-script-display))
        org-modern-block-fringe nil
        org-modern-block-name
        '((t . t)
          (<span class="org-string">"src"</span> <span class="org-string">"&#187;"</span> <span class="org-string">"&#171;"</span>)
          (<span class="org-string">"example"</span> <span class="org-string">"&#187;&#8211;"</span> <span class="org-string">"&#8211;&#171;"</span>)
          (<span class="org-string">"quote"</span> <span class="org-string">"&#10077;"</span> <span class="org-string">"&#10078;"</span>)
          (<span class="org-string">"export"</span> <span class="org-string">"&#9193;"</span> <span class="org-string">"&#9194;"</span>))
        org-modern-progress nil
        org-modern-priority nil
        org-modern-horizontal-rule (make-string 36 ?&#9472;)
        org-modern-keyword
        '((t . t)
          (<span class="org-string">"title"</span> . <span class="org-string">"&#120399;"</span>)
          (<span class="org-string">"subtitle"</span> . <span class="org-string">"&#120425;"</span>)
          (<span class="org-string">"author"</span> . <span class="org-string">"&#120380;"</span>)
          (<span class="org-string">"email"</span> . <span class="org-string">"&#62511;"</span>)
          (<span class="org-string">"date"</span> . <span class="org-string">"&#120383;"</span>)
          (<span class="org-string">"property"</span> . <span class="org-string">"&#985139;"</span>)
          (<span class="org-string">"options"</span> . #(<span class="org-string">"&#984629;"</span> 0 1 (display (height 0.75))))
          (<span class="org-string">"startup"</span> . <span class="org-string">"&#9211;"</span>)
          (<span class="org-string">"macro"</span> . <span class="org-string">"&#120028;"</span>)
          (<span class="org-string">"bind"</span> . <span class="org-string">"&#983863;"</span>)
          (<span class="org-string">"bibliography"</span> . <span class="org-string">"&#62469;"</span>)
          (<span class="org-string">"print_bibliography"</span> . <span class="org-string">"&#983857;"</span>)
          (<span class="org-string">"cite_export"</span> . <span class="org-string">"&#62469;&#11181;"</span>)
          (<span class="org-string">"print_glossary"</span> . <span class="org-string">"&#983857;&#7468;&#7611;"</span>)
          (<span class="org-string">"glossary_sources"</span> . <span class="org-string">"&#984251;"</span>)
          (<span class="org-string">"include"</span> . <span class="org-string">"&#8676;"</span>)
          (<span class="org-string">"setupfile"</span> . <span class="org-string">"&#8666;"</span>)
          (<span class="org-string">"html_head"</span> . <span class="org-string">"&#127351;"</span>)
          (<span class="org-string">"html"</span> . <span class="org-string">"&#127319;"</span>)
          (<span class="org-string">"latex_class"</span> . <span class="org-string">"&#127291;"</span>)
          (<span class="org-string">"latex_class_options"</span> . <span class="org-string">"&#127291;&#984211;"</span>)
          (<span class="org-string">"latex_header"</span> . <span class="org-string">"&#127355;"</span>)
          (<span class="org-string">"latex_header_extra"</span> . <span class="org-string">"&#127355;&#8314;"</span>)
          (<span class="org-string">"latex"</span> . <span class="org-string">"&#127323;"</span>)
          (<span class="org-string">"beamer_theme"</span> . <span class="org-string">"&#127281;"</span>)
          (<span class="org-string">"beamer_color_theme"</span> . <span class="org-string">"&#127281;&#984024;"</span>)
          (<span class="org-string">"beamer_font_theme"</span> . <span class="org-string">"&#127281;&#119808;"</span>)
          (<span class="org-string">"beamer_header"</span> . <span class="org-string">"&#127345;"</span>)
          (<span class="org-string">"beamer"</span> . <span class="org-string">"&#127313;"</span>)
          (<span class="org-string">"attr_latex"</span> . <span class="org-string">"&#127259;"</span>)
          (<span class="org-string">"attr_html"</span> . <span class="org-string">"&#127255;"</span>)
          (<span class="org-string">"attr_org"</span> . <span class="org-string">"&#9386;"</span>)
          (<span class="org-string">"call"</span> . <span class="org-string">"&#984846;"</span>)
          (<span class="org-string">"name"</span> . <span class="org-string">"&#8269;"</span>)
          (<span class="org-string">"header"</span> . <span class="org-string">"&#8250;"</span>)
          (<span class="org-string">"caption"</span> . <span class="org-string">"&#9776;"</span>)
          (<span class="org-string">"results"</span> . <span class="org-string">"&#129078;"</span>)))
  (custom-set-faces! '(org-modern-statistics <span class="org-builtin">:inherit</span> org-checkbox-statistics-todo)))
</pre>
</div>
</details>

<p>
Since <kbd>org-modern</kbd>'s tag face supplants Org's tag face, we need to adjust the
spell-check face ignore list
</p>

<details id='org-modern,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-modern,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> spell-fu
  (<span class="org-keyword">cl-pushnew</span> 'org-modern-tag (alist-get 'org-mode +spell-excluded-faces-alist)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-emphasis-markers" class="outline-6">
<h6 id="emphasis-markers"><span class="section-number-6">5.3.2.2.2.</span> Emphasis markers<a aria-hidden="true" href="#emphasis-markers">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-2-2">
<p>
While <code>org-hide-emphasis-markers</code> is very nice, it can sometimes make edits which
occur at the border a bit more fiddley. We can improve this situation without
sacrificing visual amenities with the <kbd>org-appear</kbd> package.
</p>
<details id='emphasis-markers,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emphasis-markers,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-appear <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"awth13/org-appear"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"32ee50f8fdfa449bbc235617549c1bccb503cb09"</span>)
</pre>
</div>
</details>

<details id='emphasis-markers,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emphasis-markers,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-appear
  <span class="org-builtin">:hook</span> (org-mode . org-appear-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-appear-autoemphasis t
        org-appear-autosubmarkers t
        org-appear-autolinks nil)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">for proper first-time setup, `</span><span class="org-comment"><span class="org-constant">org-appear--set-elements</span></span><span class="org-comment">'</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">needs to be run after other hooks have acted.</span>
  (run-at-time nil nil #'org-appear--set-elements))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-heading-structure" class="outline-6">
<h6 id="heading-structure"><span class="section-number-6">5.3.2.2.3.</span> Heading structure<a aria-hidden="true" href="#heading-structure">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-2-3">
<p>
Speaking of headlines, a nice package for viewing and managing the heading
structure has come to my attention.
</p>
<details id='heading-structure,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#heading-structure,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-ol-tree <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"Townk/org-ol-tree"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"207c748aa5fea8626be619e8c55bdb1c16118c25"</span>)
</pre>
</div>
</details>

<p>
We'll bind this to <kbd>O</kbd> on the org-mode localleader, and manually apply a <a href="https://github.com/Townk/org-ol-tree/pull/13"><span class='acr'>PR</span>
recognising the pgtk window system</a>.
</p>

<details id='heading-structure,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#heading-structure,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-ol-tree
  <span class="org-builtin">:commands</span> org-ol-tree
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-ol-tree-ui-icon-set
        (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (display-graphic-p)
                 (fboundp 'all-the-icons-material))
            'all-the-icons
          'unicode))
  (org-ol-tree-ui--update-icon-set))

(map! <span class="org-builtin">:map</span> org-mode-map
      <span class="org-builtin">:after</span> org
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"Outline"</span> <span class="org-string">"O"</span> #'org-ol-tree)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-extra-functionality" class="outline-5">
<h5 id="extra-functionality"><span class="section-number-5">5.3.2.3.</span> Extra functionality<a aria-hidden="true" href="#extra-functionality">#</a> </h5>
<div class="outline-text-5" id="text-5-3-2-3">
</div>
<div id="outline-container-julia-support" class="outline-6">
<h6 id="julia-support"><span class="section-number-6">5.3.2.3.1.</span> Julia support<a aria-hidden="true" href="#julia-support">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-1">
<p>
<kbd>ob-julia</kbd> is currently a bit borked, but there's an effort to improve this.
</p>
<details id='julia-support,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#julia-support,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> ob-julia <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/ob-julia"</span> <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span> <span class="org-string">"julia"</span>)))
</pre>
</div>
</details>

<details id='julia-support,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#julia-support,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! ob-julia
  <span class="org-builtin">:commands</span> org-babel-execute:julia
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-babel-julia-command-arguments
        `(<span class="org-string">"--sysimage"</span>
          ,(<span class="org-keyword">when-let</span> ((img <span class="org-string">"~/.local/lib/julia.so"</span>)
                      (exists? (file-exists-p img)))
             (expand-file-name img))
          <span class="org-string">"--threads"</span>
          ,(number-to-string (- (doom-system-cpus) 2))
          <span class="org-string">"--banner=no"</span>)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-http-requests" class="outline-6">
<h6 id="http-requests"><span class="section-number-6">5.3.2.3.2.</span> <span class='acr'><span class='acr'>HTTP</span></span> requests<a aria-hidden="true" href="#http-requests">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-2">
<p>
I like the idea of being able to make <span class='acr'>HTTP</span> requests with Babel.
</p>
<details id='http-requests,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#http-requests,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> ob-http <span class="org-builtin">:pin</span> <span class="org-string">"b1428ea2a63bcb510e7382a1bf5fe82b19c104a7"</span>)
</pre>
</div>
</details>

<details id='http-requests,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#http-requests,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! ob-http
  <span class="org-builtin">:commands</span> org-babel-execute:http)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-rss-feeds" class="outline-6">
<h6 id="rss-feeds"><span class="section-number-6">5.3.2.3.3.</span> <span class='acr'><span class='acr'>RSS</span></span> feeds<a aria-hidden="true" href="#rss-feeds">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-3">
<p>
I need this for blog publishing. It used to be bundled with Org, but now it's
pretty much abandoned.
</p>

<details id='rss-feeds,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#rss-feeds,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> ox-rss <span class="org-builtin">:pin</span> <span class="org-string">"d2964eca3614f84db85b498d065862a1e341868d"</span>)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-transclusion" class="outline-6">
<h6 id="transclusion"><span class="section-number-6">5.3.2.3.4.</span> Transclusion<a aria-hidden="true" href="#transclusion">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-4">
<p>
There's a really cool package in development to <i>transclude</i> Org document content.
</p>
<details id='transclusion,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#transclusion,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-transclusion <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"nobiot/org-transclusion"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"e9728b0b14b5c2e5d3b68af98f772ed99e136b48"</span>)
</pre>
</div>
</details>

<details id='transclusion,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#transclusion,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-transclusion
  <span class="org-builtin">:commands</span> org-transclusion-mode
  <span class="org-builtin">:init</span>
  (map! <span class="org-builtin">:after</span> org <span class="org-builtin">:map</span> org-mode-map
        <span class="org-string">"&lt;f12&gt;"</span> #'org-transclusion-mode))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-heading-graph" class="outline-6">
<h6 id="heading-graph"><span class="section-number-6">5.3.2.3.5.</span> Heading graph<a aria-hidden="true" href="#heading-graph">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-5">
<p>
Came across this and &#x2026; it's cool
</p>
<details id='heading-graph,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#heading-graph,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-graph-view <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"alphapapa/org-graph-view"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"172157aee1131ea59f0bd724a10abfdbccbd860e"</span>)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-cooking-recipes" class="outline-6">
<h6 id="cooking-recipes"><span class="section-number-6">5.3.2.3.6.</span> Cooking recipes<a aria-hidden="true" href="#cooking-recipes">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-6">
<p>
I <b>need</b> this in my life. It take a <span class='acr'>URL</span> to a recipe from a common site, and
inserts an org-ified version at point. Isn't that just great.
</p>
<details id='cooking-recipes,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#cooking-recipes,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-chef <span class="org-builtin">:pin</span> <span class="org-string">"1710b54441ed744dcdfb125d08fb88cfaf452f10"</span>)
</pre>
</div>
</details>

<p>
Loading after org seems a bit premature. Let's just load it when we try to use
it, either by command or in a capture template.
</p>
<details id='cooking-recipes,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#cooking-recipes,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-chef
  <span class="org-builtin">:commands</span> (org-chef-insert-recipe org-chef-get-recipe-from-url))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-importing-with-pandoc" class="outline-6">
<h6 id="importing-with-pandoc"><span class="section-number-6">5.3.2.3.7.</span> Importing with Pandoc<a aria-hidden="true" href="#importing-with-pandoc">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-7">
<p>
Sometimes I'm given non-org files, that's very sad. Luckily Pandoc offers a way
to make that right again, and this package makes that even easier to do.
</p>
<details id='importing-with-pandoc,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#importing-with-pandoc,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-pandoc-import <span class="org-builtin">:recipe</span>
  (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/org-pandoc-import"</span> <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span> <span class="org-string">"filters"</span> <span class="org-string">"preprocessors"</span>)))
</pre>
</div>
</details>

<details id='importing-with-pandoc,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#importing-with-pandoc,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-pandoc-import
  <span class="org-builtin">:after</span> org)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-glossaries-more" class="outline-6">
<h6 id="glossaries-more"><span class="section-number-6">5.3.2.3.8.</span> Glossaries and more<a aria-hidden="true" href="#glossaries-more">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-8">
<p>
For glossary-type entries, there's a nice package for this I'm developing.
</p>

<details id='glossaries-more,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#glossaries-more,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-glossary <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/org-glossary"</span>))
</pre>
</div>
</details>

<p>
Other than hooking this to <kbd>org-mode</kbd>, we also want to set a collection root and
improve the LaTeX usage references with <kbd>cleveref</kbd>'s <code>\labelcpageref</code> command.
</p>

<details id='glossaries-more,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#glossaries-more,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-glossary
  <span class="org-builtin">:hook</span> (org-mode . org-glossary-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-glossary-collection-root <span class="org-string">"~/.config/doom/misc/glossaries/"</span>)
  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-glossary--latex-cdef</span> (backend info term-entry form <span class="org-type">&amp;optional</span> ref-index plural-p capitalized-p extra-parameters)
    (org-glossary--export-template
     (<span class="org-keyword">if</span> (plist-get term-entry <span class="org-builtin">:uses</span>)
         <span class="org-string">"*%d*\\emsp{}%v\\ensp{}@@latex:\\labelcpageref{@@%b@@latex:}@@\n"</span>
       <span class="org-string">"*%d*\\emsp{}%v\n"</span>)
     backend info term-entry ref-index
     plural-p capitalized-p extra-parameters))
  (org-glossary-set-export-spec
   'latex t
   <span class="org-builtin">:backref</span> <span class="org-string">"gls-%K-use-%r"</span>
   <span class="org-builtin">:backref-seperator</span> <span class="org-string">","</span>
   <span class="org-builtin">:definition-structure</span> #'+org-glossary--latex-cdef))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-document-comparison" class="outline-6">
<h6 id="document-comparison"><span class="section-number-6">5.3.2.3.9.</span> Document comparison<a aria-hidden="true" href="#document-comparison">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-9">
<p>
It's quite nice to compare Org files, and the richest way to compare content is
probably <kbd>latexdiff</kbd>. There are a few annoying steps involved here, and so I've
written a package to streamline the process.
</p>

<details id='document-comparison,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#document-comparison,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> orgdiff <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/orgdiff"</span>))
</pre>
</div>
</details>

<p>
The only little annoyance is the fact that <kbd>latexdiff</kbd> uses <code>#FF0000</code> and <code>#0000FF</code> as
the red/blue change indication colours. We can make this a bit nicer by
post-processing the <kbd>latexdiff</kbd> result.
</p>

<details id='document-comparison,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#document-comparison,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! orgdiff
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">+orgdiff-nicer-change-colours</span> ()
    (goto-char (point-min))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Set red/blue based on whether chameleon is being used</span>
    (<span class="org-keyword">if</span> (search-forward <span class="org-string">"%% make document follow Emacs theme"</span> nil t)
        (<span class="org-keyword">setq</span> red  (substring (doom-blend 'red 'fg 0.8) 1)
              blue (substring (doom-blend 'blue 'teal 0.6) 1))
      (<span class="org-keyword">setq</span> red  <span class="org-string">"c82829"</span>
            blue <span class="org-string">"00618a"</span>))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (search-forward <span class="org-string">"%DIF PREAMBLE EXTENSION ADDED BY LATEXDIFF"</span> nil t)
               (search-forward <span class="org-string">"\\RequirePackage{color}"</span> nil t))
      (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"definecolor{red}{rgb}{1,0,0}"</span> (cdr (bounds-of-thing-at-point 'line)) t)
        (replace-match (format <span class="org-string">"definecolor{red}{HTML}{%s}"</span> red)))
      (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"definecolor{blue}{rgb}{0,0,1}"</span> (cdr (bounds-of-thing-at-point 'line)) t)
        (replace-match (format <span class="org-string">"definecolor{blue}{HTML}{%s}"</span> blue)))))
  (<span class="org-keyword">setq</span> orgdiff-latexdiff-args '(<span class="org-string">"--append-safecmd=acr,acrs"</span>))
  (add-to-list 'orgdiff-latexdiff-postprocess-hooks #'+orgdiff-nicer-change-colours))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-org-music" class="outline-6">
<h6 id="org-music"><span class="section-number-6">5.3.2.3.10.</span> Org music<a aria-hidden="true" href="#org-music">#</a> </h6>
<div class="outline-text-6" id="text-5-3-2-3-10">
<p>
It's nice to be able to link to music
</p>
<details id='org-music,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-music,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-music <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/org-music"</span>))
</pre>
</div>
</details>

<details id='org-music,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-music,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-music
  <span class="org-builtin">:after</span> org
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-music-mpris-player <span class="org-string">"Lollypop"</span>
        org-music-track-search-method 'beets
        org-music-beets-db <span class="org-string">"~/Music/library.db"</span>))
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
<div id="outline-container-behaviour" class="outline-4">
<h4 id="behaviour"><span class="section-number-4">5.3.3.</span> Behaviour<a aria-hidden="true" href="#behaviour">#</a> </h4>
<div class="outline-text-4" id="text-5-3-3">
<p>

</p>
</div>
<div id="outline-container-tweaking-defaults" class="outline-5">
<h5 id="tweaking-defaults"><span class="section-number-5">5.3.3.1.</span> Tweaking defaults<a aria-hidden="true" href="#tweaking-defaults">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-1">
<details id='tweaking-defaults,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#tweaking-defaults,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-directory (expand-file-name <span class="org-string">"org"</span> (xdg-data-home)) <span class="org-comment-delimiter">; </span><span class="org-comment">Let's put files here.</span>
      org-agenda-files (list org-directory)                  <span class="org-comment-delimiter">; </span><span class="org-comment">Seems like the obvious place.</span>
      org-use-property-inheritance t                         <span class="org-comment-delimiter">; </span><span class="org-comment">It's convenient to have properties inherited.</span>
      org-log-done 'time                                     <span class="org-comment-delimiter">; </span><span class="org-comment">Having the time a item is done sounds convenient.</span>
      org-list-allow-alphabetical t                          <span class="org-comment-delimiter">; </span><span class="org-comment">Have a. A. a) A) list bullets.</span>
      org-catch-invisible-edits 'smart                       <span class="org-comment-delimiter">; </span><span class="org-comment">Try not to accidently do weird stuff in invisible regions.</span>
      org-export-with-sub-superscripts '{}                   <span class="org-comment-delimiter">; </span><span class="org-comment">Don't treat lone _ / ^ as sub/superscripts, require _{} / ^{}.</span>
      org-export-allow-bind-keywords t                       <span class="org-comment-delimiter">; </span><span class="org-comment">Bind keywords can be handy</span>
      org-image-actual-width '(0.9))                         <span class="org-comment-delimiter">; </span><span class="org-comment">Make the in-buffer display closer to the exported result..</span>
</pre>
</div>
</details>
<p>
I also like the <code class="src src-elisp"><span class="org-builtin">:comments</span></code> header-argument, so let's make that a
default.
</p>
<details id='tweaking-defaults,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#tweaking-defaults,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-babel-default-header-args
      '((<span class="org-builtin">:session</span> . <span class="org-string">"none"</span>)
        (<span class="org-builtin">:results</span> . <span class="org-string">"replace"</span>)
        (<span class="org-builtin">:exports</span> . <span class="org-string">"code"</span>)
        (<span class="org-builtin">:cache</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:noweb</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:hlines</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:tangle</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:comments</span> . <span class="org-string">"link"</span>)))
</pre>
</div>
</details>

<p>
By default, <code>visual-line-mode</code> is turned <kbd>on</kbd>, and <code>auto-fill-mode</code> <kbd>off</kbd> by a hook.
However this messes with tables in Org-mode, and other plaintext files (e.g.
markdown, \LaTeX) so I'll turn it off for this, and manually enable it for more
specific modes as desired.
</p>
<details id='tweaking-defaults,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#tweaking-defaults,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(remove-hook 'text-mode-hook #'visual-line-mode)
(add-hook 'text-mode-hook #'auto-fill-mode)
</pre>
</div>
</details>

<p>
There also seem to be a few keybindings which use <kbd>hjkl</kbd>, but miss arrow key equivalents.
</p>
<details id='tweaking-defaults,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#tweaking-defaults,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:map</span> evil-org-mode-map
      <span class="org-builtin">:after</span> evil-org
      <span class="org-builtin">:n</span> <span class="org-string">"g &lt;up&gt;"</span> #'org-backward-heading-same-level
      <span class="org-builtin">:n</span> <span class="org-string">"g &lt;down&gt;"</span> #'org-forward-heading-same-level
      <span class="org-builtin">:n</span> <span class="org-string">"g &lt;left&gt;"</span> #'org-up-element
      <span class="org-builtin">:n</span> <span class="org-string">"g &lt;right&gt;"</span> #'org-down-element)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-behaviour-extra-functionality" class="outline-5">
<h5 id="behaviour-extra-functionality"><span class="section-number-5">5.3.3.2.</span> Extra functionality<a aria-hidden="true" href="#behaviour-extra-functionality">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-2">
</div>
<div id="outline-container-utility-zero-width" class="outline-6">
<h6 id="utility-zero-width"><span class="section-number-6">5.3.3.2.1.</span> The utility of zero-width spaces<a aria-hidden="true" href="#utility-zero-width">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-2-1">
<p>
Occasionally in Org you run into annoyances where you want to have two seperate
blocks right together without a space. For example, to <b>emph</b>asise part of a word,
or put a currency symbol immediately before an inline source block.
There is a solution to this, it just sounds slightly hacky &#x2014; zero width spaces.
Because this is Emacs, we can make this feel much less hacky by making a minor
addition to the Org key map 🙂.
</p>

<details id='utility-zero-width,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#utility-zero-width,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:map</span> org-mode-map
      <span class="org-builtin">:nie</span> <span class="org-string">"M-SPC M-SPC"</span> (<span class="org-keyword">cmd!</span> (insert <span class="org-string">"\u200B"</span>)))
</pre>
</div>
</details>

<p>
We then want to stop the space from being included in exports, which is done <a href="#strip-zero-width">here</a>.
</p>
</div>
</div>
<div id="outline-container-list-bullet-sequence" class="outline-6">
<h6 id="list-bullet-sequence"><span class="section-number-6">5.3.3.2.2.</span> List bullet sequence<a aria-hidden="true" href="#list-bullet-sequence">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-2-2">
<p>
I think it makes sense to have list bullets change with depth
</p>
<details id='list-bullet-sequence,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#list-bullet-sequence,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-list-demote-modify-bullet '((<span class="org-string">"+"</span> . <span class="org-string">"-"</span>) (<span class="org-string">"-"</span> . <span class="org-string">"+"</span>) (<span class="org-string">"*"</span> . <span class="org-string">"+"</span>) (<span class="org-string">"1."</span> . <span class="org-string">"a."</span>)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-easier-file-links" class="outline-6">
<h6 id="easier-file-links"><span class="section-number-6">5.3.3.2.3.</span> Easier file links<a aria-hidden="true" href="#easier-file-links">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-2-3">
<p>
While <code>org-insert-link</code> is all very well and good, a large portion of the time I
want to insert a file, and so it would be good to have a way to skip straight to
that and avoid the description prompt. Looking at <code>org-link-parameters</code>, we can
see that the <kbd>"file"</kbd> link type uses the completion function
<code>org-link-complete-file</code>, so let's use that to make a little file-link inserting
function.
</p>

<details id='easier-file-links,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#easier-file-links,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+org-insert-file-link</span> ()
  <span class="org-doc">"Insert a file link.  At the prompt, enter the filename."</span>
  (<span class="org-keyword">interactive</span>)
  (org-insert-link nil (org-link-complete-file)))
</pre>
</div>
</details>

<p>
Now we'll just add that under the Org mode link localleader for convenience.
</p>

<details id='easier-file-links,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#easier-file-links,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:after</span> org
      <span class="org-builtin">:map</span> org-mode-map
      <span class="org-builtin">:localleader</span>
      <span class="org-string">"l f"</span> #'+org-insert-file-link)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-citation" class="outline-6">
<h6 id="citation"><span class="section-number-6">5.3.3.2.4.</span> Citation<a aria-hidden="true" href="#citation">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-2-4">
<blockquote>
<p>
Extending the <kbd>:tools biblio</kbd> module.
</p>
</blockquote>

<p>
References in Org are fairly easy now, thanks to <kbd>org-cite</kbd>. The <kbd>:tools biblio</kbd>
module gives a fairly decent basic setup, but it would be nice to take it a bit
further. This mostly consists of tweaking settings, but there is one extra
package I'll grab for prettier in-buffer citations.
</p>

<details id='citation,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#citation,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-cite-csl-activate <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"andras-simonyi/org-cite-csl-activate"</span>) <span class="org-builtin">:pin</span> <span class="org-string">"ccadbdcdfd1b4cb0cea132324cc1912e0f1900b6"</span>)
</pre>
</div>
</details>

<p>
In particular, by setting <code>org-cite-csl-activate-use-document-style</code>, we can have
the in-buffer displayed citations be the same as the exported form. Isn't that lovely!
</p>

<p>
Unfortunately, there's currently a potential for undesirable buffer
modifications, so we'll put all the activation code behind a function we can
call when we want it.
</p>

<details id='citation,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#citation,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! oc-csl-activate
  <span class="org-builtin">:after</span> oc
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-cite-csl-activate-use-document-style t)
  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-cite-csl-activate/enable</span> ()
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">setq</span> org-cite-activate-processor 'csl-activate)
    (<span class="org-keyword">add-hook!</span> 'org-mode-hook '((<span class="org-keyword">lambda</span> () (cursor-sensor-mode 1)) org-cite-csl-activate-render-all))
    (<span class="org-keyword">defadvice!</span> +org-cite-csl-activate-render-all-silent (orig-fn)
      <span class="org-builtin">:around</span> #'org-cite-csl-activate-render-all
      (<span class="org-keyword">with-silent-modifications</span> (funcall orig-fn)))
    (<span class="org-keyword">when</span> (eq major-mode 'org-mode)
      (<span class="org-keyword">with-silent-modifications</span>
        (<span class="org-keyword">save-excursion</span>
          (goto-char (point-min))
          (org-cite-activate (point-max)))
        (org-cite-csl-activate-render-all)))
    (fmakunbound #'+org-cite-csl-activate/enable)))
</pre>
</div>
</details>

<p>
Now that <kbd>oc-csl-activate</kbd> is set up, let's go ahead and customise some of the
packages already loaded. For starters, we can make use of the my Zotero files
with <kbd>citar</kbd>, and make the symbols a bit prettier.
</p>

<details id='citation,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#citation,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> citar
  (<span class="org-keyword">setq</span> org-cite-global-bibliography
        (<span class="org-keyword">let</span> ((libfile-search-names '(<span class="org-string">"library.json"</span> <span class="org-string">"Library.json"</span> <span class="org-string">"library.bib"</span> <span class="org-string">"Library.bib"</span>))
              (libfile-dir <span class="org-string">"~/Zotero"</span>)
              paths)
          (<span class="org-keyword">dolist</span> (libfile libfile-search-names)
            (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not paths)
                       (file-exists-p (expand-file-name libfile libfile-dir)))
              (<span class="org-keyword">setq</span> paths (list (expand-file-name libfile libfile-dir)))))
          paths)
        citar-bibliography org-cite-global-bibliography
        citar-symbols
        `((file ,(nerd-icons-faicon <span class="org-string">"nf-fa-file_o"</span> <span class="org-builtin">:face</span> 'nerd-icons-green <span class="org-builtin">:v-adjust</span> -0.1) . <span class="org-string">" "</span>)
          (note ,(nerd-icons-octicon <span class="org-string">"nf-oct-note"</span> <span class="org-builtin">:face</span> 'nerd-icons-blue <span class="org-builtin">:v-adjust</span> -0.3) . <span class="org-string">" "</span>)
          (link ,(nerd-icons-octicon <span class="org-string">"nf-oct-link"</span> <span class="org-builtin">:face</span> 'nerd-icons-orange <span class="org-builtin">:v-adjust</span> 0.01) . <span class="org-string">" "</span>))))
</pre>
</div>
</details>

<p>
We can also make the Zotero <span class='acr'>CSL</span> styles available to use.
</p>

<details id='citation,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#citation,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> oc-csl
  (<span class="org-keyword">setq</span> org-cite-csl-styles-dir <span class="org-string">"~/Zotero/styles"</span>))
</pre>
</div>
</details>

<p>
Since <span class='acr'>CSL</span> works so nicely everywhere, we might as well use it as the default
citation export processor for everything.
</p>

<details id='citation,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#citation,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> oc
  (<span class="org-keyword">setq</span> org-cite-export-processors '((t csl))))
</pre>
</div>
</details>

<p>
Then, for convenience we'll cap things off by putting the citation command under
Org's localleader.
</p>

<details id='citation,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#citation,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:after</span> org
      <span class="org-builtin">:map</span> org-mode-map
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"Insert citation"</span> <span class="org-string">"@"</span> #'org-cite-insert)
</pre>
</div>
</details>

<p>
Lastly, just in case I come across any old citations of mine, I think it would
be nice to have a function to convert <kbd>org-ref</kbd> citations to <kbd>org-cite</kbd> forms.
</p>

<details id='citation,code--7' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#citation,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> oc
  (<span class="org-keyword">defun</span> <span class="org-function-name">org-ref-to-org-cite</span> ()
    <span class="org-doc">"Attempt to convert org-ref citations to org-cite syntax."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">let*</span> ((cite-conversions '((<span class="org-string">"cite"</span> . <span class="org-string">"//b"</span>) (<span class="org-string">"Cite"</span> . <span class="org-string">"//bc"</span>)
                               (<span class="org-string">"nocite"</span> . <span class="org-string">"/n"</span>)
                               (<span class="org-string">"citep"</span> . <span class="org-string">""</span>) (<span class="org-string">"citep*"</span> . <span class="org-string">"//f"</span>)
                               (<span class="org-string">"parencite"</span> . <span class="org-string">""</span>) (<span class="org-string">"Parencite"</span> . <span class="org-string">"//c"</span>)
                               (<span class="org-string">"citeauthor"</span> . <span class="org-string">"/a/f"</span>) (<span class="org-string">"citeauthor*"</span> . <span class="org-string">"/a"</span>)
                               (<span class="org-string">"citeyear"</span> . <span class="org-string">"/na/b"</span>)
                               (<span class="org-string">"Citep"</span> . <span class="org-string">"//c"</span>) (<span class="org-string">"Citealp"</span> . <span class="org-string">"//bc"</span>)
                               (<span class="org-string">"Citeauthor"</span> . <span class="org-string">"/a/cf"</span>) (<span class="org-string">"Citeauthor*"</span> . <span class="org-string">"/a/c"</span>)
                               (<span class="org-string">"autocite"</span> . <span class="org-string">""</span>) (<span class="org-string">"Autocite"</span> . <span class="org-string">"//c"</span>)
                               (<span class="org-string">"notecite"</span> . <span class="org-string">"/l/b"</span>) (<span class="org-string">"Notecite"</span> . <span class="org-string">"/l/bc"</span>)
                               (<span class="org-string">"pnotecite"</span> . <span class="org-string">"/l"</span>) (<span class="org-string">"Pnotecite"</span> . <span class="org-string">"/l/bc"</span>)))
           (cite-regexp (<span class="org-keyword">rx</span> (regexp (regexp-opt (mapcar #'car cite-conversions) t))
                            <span class="org-string">":"</span> (group (+ (not (any <span class="org-string">"\n         ,.)]}"</span>)))))))
      (<span class="org-keyword">save-excursion</span>
        (goto-char (point-min))
        (<span class="org-keyword">while</span> (re-search-forward cite-regexp nil t)
          (message (format <span class="org-string">"[cite%s:@%s]"</span>
                                 (cdr (assoc (match-string 1) cite-conversions))
                                 (match-string 2)))
          (replace-match (format <span class="org-string">"[cite%s:@%s]"</span>
                                 (cdr (assoc (match-string 1) cite-conversions))
                                 (match-string 2))))))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-cdlatex-environments" class="outline-6">
<h6 id="cdlatex-environments"><span class="section-number-6">5.3.3.2.5.</span> cdlatex environments<a aria-hidden="true" href="#cdlatex-environments">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-2-5">
<p>
I prefer <kbd>auto-activating-snippets</kbd> to <kbd>cdlatex</kbd>, but do like
<code>org-cdlatex-environment-indent</code> (bound to <kbd>C-c }</kbd>). I almost always want to edit
them afterwards though, so let's make that happen by default.
</p>

<details id='cdlatex-environments,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#cdlatex-environments,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +org-edit-latex-env-after-insert-a (<span class="org-type">&amp;rest</span> _)
  <span class="org-builtin">:after</span> #'org-cdlatex-environment-indent
  (org-edit-latex-environment))
</pre>
</div>
</details>

<p>
At some point in the future it could be good to investigate <a href="https://scripter.co/splitting-an-org-block-into-two/">splitting org blocks</a>.
Likewise <a href="https://archive.casouri.cat/note/2020/insert-math-symbol-in-emacs/">this</a> looks good for symbols.
</p>
</div>
</div>
<div id="outline-container-lsp-support-src" class="outline-6">
<h6 id="lsp-support-src"><span class="section-number-6">5.3.3.2.6.</span> <span class='acr'><span class='acr'>LSP</span></span> support in <code>src</code> blocks<a aria-hidden="true" href="#lsp-support-src">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-2-6">
<p>
Now, by default, <span class='acr'>LSP</span><small>s</small> don't really function at all in <code>src</code> blocks.
</p>
<details id='lsp-support-src,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#lsp-support-src,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cl-defmacro</span> <span class="org-function-name">lsp-org-babel-enable</span> (lang)
  <span class="org-doc">"Support LANG in org source code block."</span>
  (<span class="org-keyword">setq</span> centaur-lsp 'lsp-mode)
  (<span class="org-warning">cl-check-type</span> lang string)
  (<span class="org-keyword">let*</span> ((edit-pre (intern (format <span class="org-string">"org-babel-edit-prep:%s"</span> lang)))
         (intern-pre (intern (format <span class="org-string">"lsp--%s"</span> (symbol-name edit-pre)))))
    `(<span class="org-keyword">progn</span>
       (<span class="org-keyword">defun</span> ,intern-pre (info)
         (<span class="org-keyword">let</span> ((file-name (<span class="org-keyword">-&gt;&gt;</span> info caddr (alist-get <span class="org-builtin">:file</span>))))
           (<span class="org-keyword">unless</span> file-name
             (<span class="org-keyword">setq</span> file-name (make-temp-file <span class="org-string">"babel-lsp-"</span>)))
           (<span class="org-keyword">setq</span> buffer-file-name file-name)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format <span class="org-string">"Enable lsp-mode in the buffer of org source block (%s)."</span>
                    (upcase ,lang)))
       (<span class="org-keyword">if</span> (fboundp ',edit-pre)
           (advice-add ',edit-pre <span class="org-builtin">:after</span> ',intern-pre)
         (<span class="org-keyword">progn</span>
           (<span class="org-keyword">defun</span> ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format <span class="org-string">"Prepare local buffer environment for org source block (%s)."</span>
                        (upcase ,lang))))))))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-babel-lang-list</span>
  '(<span class="org-string">"go"</span> <span class="org-string">"python"</span> <span class="org-string">"ipython"</span> <span class="org-string">"bash"</span> <span class="org-string">"sh"</span>))
(<span class="org-keyword">dolist</span> (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-view-exported-file" class="outline-6">
<h6 id="view-exported-file"><span class="section-number-6">5.3.3.2.7.</span> View exported file<a aria-hidden="true" href="#view-exported-file">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-2-7">
<p>
<kbd>'localeader v</kbd> has no pre-existing binding, so I may as well use it with the same
functionality as in LaTeX. Let's try viewing possible output files with this.
</p>
<details id='view-exported-file,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#view-exported-file,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(map! <span class="org-builtin">:map</span> org-mode-map
      <span class="org-builtin">:localleader</span>
      <span class="org-builtin">:desc</span> <span class="org-string">"View exported file"</span> <span class="org-string">"v"</span> #'org-view-output-file)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-view-output-file</span> (<span class="org-type">&amp;optional</span> org-file-path)
  <span class="org-doc">"Visit buffer open on the first output file (if any) found, using `</span><span class="org-doc"><span class="org-constant">org-view-output-file-extensions</span></span><span class="org-doc">'"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((org-file-path (<span class="org-keyword">or</span> org-file-path (buffer-file-name) <span class="org-string">""</span>))
         (dir (file-name-directory org-file-path))
         (basename (file-name-base org-file-path))
         (output-file nil))
    (<span class="org-keyword">dolist</span> (ext org-view-output-file-extensions)
      (<span class="org-keyword">unless</span> output-file
        (<span class="org-keyword">when</span> (file-exists-p
               (concat dir basename <span class="org-string">"."</span> ext))
          (<span class="org-keyword">setq</span> output-file (concat dir basename <span class="org-string">"."</span> ext)))))
    (<span class="org-keyword">if</span> output-file
        (<span class="org-keyword">if</span> (member (file-name-extension output-file) org-view-external-file-extensions)
            (browse-url-xdg-open output-file)
          (pop-to-buffer (<span class="org-keyword">or</span> (find-buffer-visiting output-file)
                             (find-file-noselect output-file))))
      (message <span class="org-string">"No exported file found"</span>))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-view-output-file-extensions</span> '(<span class="org-string">"pdf"</span> <span class="org-string">"md"</span> <span class="org-string">"rst"</span> <span class="org-string">"txt"</span> <span class="org-string">"tex"</span> <span class="org-string">"html"</span>)
  <span class="org-doc">"Search for output files with these extensions, in order, viewing the first that matches"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-view-external-file-extensions</span> '(<span class="org-string">"html"</span>)
  <span class="org-doc">"File formats that should be opened externally."</span>)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-super-agenda" class="outline-5">
<h5 id="super-agenda"><span class="section-number-5">5.3.3.3.</span> Super agenda<a aria-hidden="true" href="#super-agenda">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-3">
<p>
The agenda is nice, but a souped up version is nicer.
</p>
<details id='super-agenda,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#super-agenda,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-super-agenda <span class="org-builtin">:pin</span> <span class="org-string">"fb20ad9c8a9705aa05d40751682beae2d094e0fe"</span>)
</pre>
</div>
</details>

<details id='super-agenda,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#super-agenda,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! org-super-agenda
  <span class="org-builtin">:commands</span> org-super-agenda-mode)
</pre>
</div>
</details>

<details id='super-agenda,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#super-agenda,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> org-agenda
  (<span class="org-keyword">let</span> ((inhibit-message t))
    (org-super-agenda-mode)))

(<span class="org-keyword">setq</span> org-agenda-skip-scheduled-if-done t
      org-agenda-skip-deadline-if-done t
      org-agenda-include-deadlines t
      org-agenda-block-separator nil
      org-agenda-tags-column 100 <span class="org-comment-delimiter">;; </span><span class="org-comment">from testing this seems to be a good value</span>
      org-agenda-compact-blocks t)

(<span class="org-keyword">setq</span> org-agenda-custom-commands
      '((<span class="org-string">"o"</span> <span class="org-string">"Overview"</span>
         ((agenda <span class="org-string">""</span> ((org-agenda-span 'day)
                      (org-super-agenda-groups
                       '((<span class="org-builtin">:name</span> <span class="org-string">"Today"</span>
                          <span class="org-builtin">:time-grid</span> t
                          <span class="org-builtin">:date</span> today
                          <span class="org-builtin">:todo</span> <span class="org-string">"TODAY"</span>
                          <span class="org-builtin">:scheduled</span> today
                          <span class="org-builtin">:order</span> 1)))))
          (alltodo <span class="org-string">""</span> ((org-agenda-overriding-header <span class="org-string">""</span>)
                       (org-super-agenda-groups
                        '((<span class="org-builtin">:name</span> <span class="org-string">"Next to do"</span>
                           <span class="org-builtin">:todo</span> <span class="org-string">"NEXT"</span>
                           <span class="org-builtin">:order</span> 1)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Important"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"Important"</span>
                           <span class="org-builtin">:priority</span> <span class="org-string">"A"</span>
                           <span class="org-builtin">:order</span> 6)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Due Today"</span>
                           <span class="org-builtin">:deadline</span> today
                           <span class="org-builtin">:order</span> 2)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Due Soon"</span>
                           <span class="org-builtin">:deadline</span> future
                           <span class="org-builtin">:order</span> 8)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Overdue"</span>
                           <span class="org-builtin">:deadline</span> past
                           <span class="org-builtin">:face</span> error
                           <span class="org-builtin">:order</span> 7)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Assignments"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"Assignment"</span>
                           <span class="org-builtin">:order</span> 10)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Issues"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"Issue"</span>
                           <span class="org-builtin">:order</span> 12)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Emacs"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"Emacs"</span>
                           <span class="org-builtin">:order</span> 13)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Projects"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"Project"</span>
                           <span class="org-builtin">:order</span> 14)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Research"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"Research"</span>
                           <span class="org-builtin">:order</span> 15)
                          (<span class="org-builtin">:name</span> <span class="org-string">"To read"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"Read"</span>
                           <span class="org-builtin">:order</span> 30)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Waiting"</span>
                           <span class="org-builtin">:todo</span> <span class="org-string">"WAITING"</span>
                           <span class="org-builtin">:order</span> 20)
                          (<span class="org-builtin">:name</span> <span class="org-string">"University"</span>
                           <span class="org-builtin">:tag</span> <span class="org-string">"uni"</span>
                           <span class="org-builtin">:order</span> 32)
                          (<span class="org-builtin">:name</span> <span class="org-string">"Trivial"</span>
                           <span class="org-builtin">:priority&lt;=</span> <span class="org-string">"E"</span>
                           <span class="org-builtin">:tag</span> (<span class="org-string">"Trivial"</span> <span class="org-string">"Unimportant"</span>)
                           <span class="org-builtin">:todo</span> (<span class="org-string">"SOMEDAY"</span> )
                           <span class="org-builtin">:order</span> 90)
                          (<span class="org-builtin">:discard</span> (<span class="org-builtin">:tag</span> (<span class="org-string">"Chore"</span> <span class="org-string">"Routine"</span> <span class="org-string">"Daily"</span>)))))))))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-capture" class="outline-5">
<h5 id="capture"><span class="section-number-5">5.3.3.4.</span> Capture<a aria-hidden="true" href="#capture">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-4">
<p>
Let's setup some org-capture templates, and make them visually nice to access.
</p>


<figure id="orgb4d5e5c">
<img src="https://code.tecosaur.net/tec/emacs-config/media/branch/master/misc/screenshots/org-capture.png" alt="My org-capture dialouge." class="invertible">

</figure>

<p>
<code>doct</code> (Declarative Org Capture Templates) seems to be a nicer way to
set up org-capture.
</p>
<details id='capture,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#capture,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> doct
  <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"progfolio/doct"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"5cab660dab653ad88c07b0493360252f6ed1d898"</span>)
</pre>
</div>
</details>

<details id='capture,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#capture,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! doct
  <span class="org-builtin">:commands</span> doct)
</pre>
</div>
</details>

<details id='capture,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#capture,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> org-capture
  &lt;&lt;prettify-capture&gt;&gt;

  (<span class="org-keyword">defun</span> <span class="org-function-name">+doct-icon-declaration-to-icon</span> (declaration)
    <span class="org-doc">"Convert :icon declaration to icon"</span>
    (<span class="org-keyword">let</span> ((name (<span class="org-keyword">pop</span> declaration))
          (set  (intern (concat <span class="org-string">"nerd-icons-"</span> (plist-get declaration <span class="org-builtin">:set</span>))))
          (face (intern (concat <span class="org-string">"nerd-icons-"</span> (plist-get declaration <span class="org-builtin">:color</span>))))
          (v-adjust (<span class="org-keyword">or</span> (plist-get declaration <span class="org-builtin">:v-adjust</span>) 0.01)))
      (apply set `(,name <span class="org-builtin">:face</span> ,face <span class="org-builtin">:v-adjust</span> ,v-adjust))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+doct-iconify-capture-templates</span> (groups)
    <span class="org-doc">"Add declaration's :icon to each template group in GROUPS."</span>
    (<span class="org-keyword">let</span> ((templates (doct-flatten-lists-in groups)))
      (<span class="org-keyword">setq</span> doct-templates (mapcar (<span class="org-keyword">lambda</span> (template)
                                     (<span class="org-keyword">when-let*</span> ((props (nthcdr (<span class="org-keyword">if</span> (= (length template) 4) 2 5) template))
                                                 (spec (plist-get (plist-get props <span class="org-builtin">:doct</span>) <span class="org-builtin">:icon</span>)))
                                       (<span class="org-keyword">setf</span> (nth 1 template) (concat (+doct-icon-declaration-to-icon spec)
                                                                      <span class="org-string">"\t"</span>
                                                                      (nth 1 template))))
                                     template)
                                   templates))))

  (<span class="org-keyword">setq</span> doct-after-conversion-functions '(+doct-iconify-capture-templates))

  (<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-capture-recipies</span>  <span class="org-string">"~/Desktop/TEC/Organisation/recipies.org"</span>)

  (<span class="org-keyword">defun</span> <span class="org-function-name">set-org-capture-templates</span> ()
    (<span class="org-keyword">setq</span> org-capture-templates
          (doct `((<span class="org-string">"Personal todo"</span> <span class="org-builtin">:keys</span> <span class="org-string">"t"</span>
                   <span class="org-builtin">:icon</span> (<span class="org-string">"nf-oct-checklist"</span> <span class="org-builtin">:set</span> <span class="org-string">"octicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"green"</span>)
                   <span class="org-builtin">:file</span> +org-capture-todo-file
                   <span class="org-builtin">:prepend</span> t
                   <span class="org-builtin">:headline</span> <span class="org-string">"Inbox"</span>
                   <span class="org-builtin">:type</span> entry
                   <span class="org-builtin">:template</span> (<span class="org-string">"* TODO %?"</span>
                              <span class="org-string">"%i %a"</span>))
                  (<span class="org-string">"Personal note"</span> <span class="org-builtin">:keys</span> <span class="org-string">"n"</span>
                   <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-sticky_note_o"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"green"</span>)
                   <span class="org-builtin">:file</span> +org-capture-todo-file
                   <span class="org-builtin">:prepend</span> t
                   <span class="org-builtin">:headline</span> <span class="org-string">"Inbox"</span>
                   <span class="org-builtin">:type</span> entry
                   <span class="org-builtin">:template</span> (<span class="org-string">"* %?"</span>
                              <span class="org-string">"%i %a"</span>))
                  (<span class="org-string">"Email"</span> <span class="org-builtin">:keys</span> <span class="org-string">"e"</span>
                   <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-envelope"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"blue"</span>)
                   <span class="org-builtin">:file</span> +org-capture-todo-file
                   <span class="org-builtin">:prepend</span> t
                   <span class="org-builtin">:headline</span> <span class="org-string">"Inbox"</span>
                   <span class="org-builtin">:type</span> entry
                   <span class="org-builtin">:template</span> (<span class="org-string">"* TODO %^{type|reply to|contact} %\\3 %? :email:"</span>
                              <span class="org-string">"Send an email %^{urgancy|soon|ASAP|anon|at some point|eventually} to %^{recipiant}"</span>
                              <span class="org-string">"about %^{topic}"</span>
                              <span class="org-string">"%U %i %a"</span>))
                  (<span class="org-string">"Interesting"</span> <span class="org-builtin">:keys</span> <span class="org-string">"i"</span>
                   <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-eye"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"lcyan"</span>)
                   <span class="org-builtin">:file</span> +org-capture-todo-file
                   <span class="org-builtin">:prepend</span> t
                   <span class="org-builtin">:headline</span> <span class="org-string">"Interesting"</span>
                   <span class="org-builtin">:type</span> entry
                   <span class="org-builtin">:template</span> (<span class="org-string">"* [ ] %{desc}%? :%{i-type}:"</span>
                              <span class="org-string">"%i %a"</span>)
                   <span class="org-builtin">:children</span> ((<span class="org-string">"Webpage"</span> <span class="org-builtin">:keys</span> <span class="org-string">"w"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-globe"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"green"</span>)
                               <span class="org-builtin">:desc</span> <span class="org-string">"%(org-cliplink-capture) "</span>
                               <span class="org-builtin">:i-type</span> <span class="org-string">"read:web"</span>)
                              (<span class="org-string">"Article"</span> <span class="org-builtin">:keys</span> <span class="org-string">"a"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-file_text_o"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"yellow"</span>)
                               <span class="org-builtin">:desc</span> <span class="org-string">""</span>
                               <span class="org-builtin">:i-type</span> <span class="org-string">"read:reaserch"</span>)
                              (<span class="org-string">"\tRecipie"</span> <span class="org-builtin">:keys</span> <span class="org-string">"r"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-spoon"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"dorange"</span>)
                               <span class="org-builtin">:file</span> +org-capture-recipies
                               <span class="org-builtin">:headline</span> <span class="org-string">"Unsorted"</span>
                               <span class="org-builtin">:template</span> <span class="org-string">"%(org-chef-get-recipe-from-url)"</span>)
                              (<span class="org-string">"Information"</span> <span class="org-builtin">:keys</span> <span class="org-string">"i"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-info_circle"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"blue"</span>)
                               <span class="org-builtin">:desc</span> <span class="org-string">""</span>
                               <span class="org-builtin">:i-type</span> <span class="org-string">"read:info"</span>)
                              (<span class="org-string">"Idea"</span> <span class="org-builtin">:keys</span> <span class="org-string">"I"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-md-chart_bubble"</span> <span class="org-builtin">:set</span> <span class="org-string">"mdicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"silver"</span>)
                               <span class="org-builtin">:desc</span> <span class="org-string">""</span>
                               <span class="org-builtin">:i-type</span> <span class="org-string">"idea"</span>)))
                  (<span class="org-string">"Tasks"</span> <span class="org-builtin">:keys</span> <span class="org-string">"k"</span>
                   <span class="org-builtin">:icon</span> (<span class="org-string">"nf-oct-inbox"</span> <span class="org-builtin">:set</span> <span class="org-string">"octicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"yellow"</span>)
                   <span class="org-builtin">:file</span> +org-capture-todo-file
                   <span class="org-builtin">:prepend</span> t
                   <span class="org-builtin">:headline</span> <span class="org-string">"Tasks"</span>
                   <span class="org-builtin">:type</span> entry
                   <span class="org-builtin">:template</span> (<span class="org-string">"* TODO %? %^G%{extra}"</span>
                              <span class="org-string">"%i %a"</span>)
                   <span class="org-builtin">:children</span> ((<span class="org-string">"General Task"</span> <span class="org-builtin">:keys</span> <span class="org-string">"k"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-oct-inbox"</span> <span class="org-builtin">:set</span> <span class="org-string">"octicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"yellow"</span>)
                               <span class="org-builtin">:extra</span> <span class="org-string">""</span>)
                              (<span class="org-string">"Task with deadline"</span> <span class="org-builtin">:keys</span> <span class="org-string">"d"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-md-timer"</span> <span class="org-builtin">:set</span> <span class="org-string">"mdicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"orange"</span> <span class="org-builtin">:v-adjust</span> -0.1)
                               <span class="org-builtin">:extra</span> <span class="org-string">"\nDEADLINE: %^{Deadline:}t"</span>)
                              (<span class="org-string">"Scheduled Task"</span> <span class="org-builtin">:keys</span> <span class="org-string">"s"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-oct-calendar"</span> <span class="org-builtin">:set</span> <span class="org-string">"octicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"orange"</span>)
                               <span class="org-builtin">:extra</span> <span class="org-string">"\nSCHEDULED: %^{Start time:}t"</span>)))
                  (<span class="org-string">"Project"</span> <span class="org-builtin">:keys</span> <span class="org-string">"p"</span>
                   <span class="org-builtin">:icon</span> (<span class="org-string">"nf-oct-repo"</span> <span class="org-builtin">:set</span> <span class="org-string">"octicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"silver"</span>)
                   <span class="org-builtin">:prepend</span> t
                   <span class="org-builtin">:type</span> entry
                   <span class="org-builtin">:headline</span> <span class="org-string">"Inbox"</span>
                   <span class="org-builtin">:template</span> (<span class="org-string">"* %{time-or-todo} %?"</span>
                              <span class="org-string">"%i"</span>
                              <span class="org-string">"%a"</span>)
                   <span class="org-builtin">:file</span> <span class="org-string">""</span>
                   <span class="org-builtin">:custom</span> (<span class="org-builtin">:time-or-todo</span> <span class="org-string">""</span>)
                   <span class="org-builtin">:children</span> ((<span class="org-string">"Project-local todo"</span> <span class="org-builtin">:keys</span> <span class="org-string">"t"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-oct-checklist"</span> <span class="org-builtin">:set</span> <span class="org-string">"octicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"green"</span>)
                               <span class="org-builtin">:time-or-todo</span> <span class="org-string">"TODO"</span>
                               <span class="org-builtin">:file</span> +org-capture-project-todo-file)
                              (<span class="org-string">"Project-local note"</span> <span class="org-builtin">:keys</span> <span class="org-string">"n"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-sticky_note"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"yellow"</span>)
                               <span class="org-builtin">:time-or-todo</span> <span class="org-string">"%U"</span>
                               <span class="org-builtin">:file</span> +org-capture-project-notes-file)
                              (<span class="org-string">"Project-local changelog"</span> <span class="org-builtin">:keys</span> <span class="org-string">"c"</span>
                               <span class="org-builtin">:icon</span> (<span class="org-string">"nf-fa-list"</span> <span class="org-builtin">:set</span> <span class="org-string">"faicon"</span> <span class="org-builtin">:color</span> <span class="org-string">"blue"</span>)
                               <span class="org-builtin">:time-or-todo</span> <span class="org-string">"%U"</span>
                               <span class="org-builtin">:heading</span> <span class="org-string">"Unreleased"</span>
                               <span class="org-builtin">:file</span> +org-capture-project-changelog-file)))
                  (<span class="org-string">"\tCentralised project templates"</span>
                   <span class="org-builtin">:keys</span> <span class="org-string">"o"</span>
                   <span class="org-builtin">:type</span> entry
                   <span class="org-builtin">:prepend</span> t
                   <span class="org-builtin">:template</span> (<span class="org-string">"* %{time-or-todo} %?"</span>
                              <span class="org-string">"%i"</span>
                              <span class="org-string">"%a"</span>)
                   <span class="org-builtin">:children</span> ((<span class="org-string">"Project todo"</span>
                               <span class="org-builtin">:keys</span> <span class="org-string">"t"</span>
                               <span class="org-builtin">:prepend</span> nil
                               <span class="org-builtin">:time-or-todo</span> <span class="org-string">"TODO"</span>
                               <span class="org-builtin">:heading</span> <span class="org-string">"Tasks"</span>
                               <span class="org-builtin">:file</span> +org-capture-central-project-todo-file)
                              (<span class="org-string">"Project note"</span>
                               <span class="org-builtin">:keys</span> <span class="org-string">"n"</span>
                               <span class="org-builtin">:time-or-todo</span> <span class="org-string">"%U"</span>
                               <span class="org-builtin">:heading</span> <span class="org-string">"Notes"</span>
                               <span class="org-builtin">:file</span> +org-capture-central-project-notes-file)
                              (<span class="org-string">"Project changelog"</span>
                               <span class="org-builtin">:keys</span> <span class="org-string">"c"</span>
                               <span class="org-builtin">:time-or-todo</span> <span class="org-string">"%U"</span>
                               <span class="org-builtin">:heading</span> <span class="org-string">"Unreleased"</span>
                               <span class="org-builtin">:file</span> +org-capture-central-project-changelog-file)))))))

  (set-org-capture-templates)
  (<span class="org-keyword">unless</span> (display-graphic-p)
    (add-hook 'server-after-make-frame-hook
              (<span class="org-keyword">defun</span> <span class="org-function-name">org-capture-reinitialise-hook</span> ()
                (<span class="org-keyword">when</span> (display-graphic-p)
                  (set-org-capture-templates)
                  (remove-hook 'server-after-make-frame-hook
                               #'org-capture-reinitialise-hook))))))
</pre>
</div>
</details>
<p>
It would also be nice to improve how the capture dialogue looks
</p>
<details id='prettify-capture' class='code' open><summary class='named'><span class="name">prettify-capture</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prettify-capture'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-capture-select-template-prettier</span> (<span class="org-type">&amp;optional</span> keys)
  <span class="org-doc">"Select a capture template, in a prettier way than default</span>
<span class="org-doc">Lisp programs can force the template by setting KEYS to a string."</span>
  (<span class="org-keyword">let</span> ((org-capture-templates
         (<span class="org-keyword">or</span> (org-contextualize-keys
              (org-capture-upgrade-templates org-capture-templates)
              org-capture-templates-contexts)
             '((<span class="org-string">"t"</span> <span class="org-string">"Task"</span> entry (file+headline <span class="org-string">""</span> <span class="org-string">"Tasks"</span>)
                <span class="org-string">"* TODO %?\n  %u\n  %a"</span>)))))
    (<span class="org-keyword">if</span> keys
        (<span class="org-keyword">or</span> (assoc keys org-capture-templates)
            (<span class="org-warning">error</span> <span class="org-string">"No capture template referred to by \"%s\" keys"</span> keys))
      (org-mks org-capture-templates
               <span class="org-string">"Select a capture template\n&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;"</span>
               <span class="org-string">"Template key: "</span>
               `((<span class="org-string">"q"</span> ,(concat (nerd-icons-octicon <span class="org-string">"nf-oct-stop"</span> <span class="org-builtin">:face</span> 'nerd-icons-red <span class="org-builtin">:v-adjust</span> 0.01) <span class="org-string">"\tAbort"</span>)))))))
(advice-add 'org-capture-select-template <span class="org-builtin">:override</span> #'org-capture-select-template-prettier)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-mks-pretty</span> (table title <span class="org-type">&amp;optional</span> prompt specials)
  <span class="org-doc">"Select a member of an alist with multiple keys. Prettified.</span>

<span class="org-doc">TABLE is the alist which should contain entries where the car is a string.</span>
<span class="org-doc">There should be two types of entries.</span>

<span class="org-doc">1. prefix descriptions like (\"a\" \"Description\")</span>
<span class="org-doc">   This indicates that `</span><span class="org-doc"><span class="org-constant">a</span></span><span class="org-doc">' is a prefix key for multi-letter selection, and</span>
<span class="org-doc">   that there are entries following with keys like \"ab\", \"ax\"&#8230;</span>

<span class="org-doc">2. Select-able members must have more than two elements, with the first</span>
<span class="org-doc">   being the string of keys that lead to selecting it, and the second a</span>
<span class="org-doc">   short description string of the item.</span>

<span class="org-doc">The command will then make a temporary buffer listing all entries</span>
<span class="org-doc">that can be selected with a single key, and all the single key</span>
<span class="org-doc">prefixes.  When you press the key for a single-letter entry, it is selected.</span>
<span class="org-doc">When you press a prefix key, the commands (and maybe further prefixes)</span>
<span class="org-doc">under this key will be shown and offered for selection.</span>

<span class="org-doc">TITLE will be placed over the selection in the temporary buffer,</span>
<span class="org-doc">PROMPT will be used when prompting for a key.  SPECIALS is an</span>
<span class="org-doc">alist with (\"key\" \"description\") entries.  When one of these</span>
<span class="org-doc">is selected, only the bare key is returned."</span>
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">let</span> ((inhibit-quit t)
          (buffer (org-switch-to-buffer-other-window <span class="org-string">"*Org Select*"</span>))
          (prompt (<span class="org-keyword">or</span> prompt <span class="org-string">"Select: "</span>))
          case-fold-search
          current)
      (<span class="org-keyword">unwind-protect</span>
          (<span class="org-keyword">catch</span> '<span class="org-constant">exit</span>
            (<span class="org-keyword">while</span> t
              (<span class="org-keyword">setq-local</span> evil-normal-state-cursor (list nil))
              (erase-buffer)
              (insert title <span class="org-string">"\n\n"</span>)
              (<span class="org-keyword">let</span> ((des-keys nil)
                    (allowed-keys '(<span class="org-string">"\C-g"</span>))
                    (tab-alternatives '(<span class="org-string">"\s"</span> <span class="org-string">"\t"</span> <span class="org-string">"\r"</span>))
                    (cursor-type nil))
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Populate allowed keys and descriptions keys</span>
                <span class="org-comment-delimiter">;; </span><span class="org-comment">available with CURRENT selector.</span>
                (<span class="org-keyword">let</span> ((re (format <span class="org-string">"\\`%s</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span>
                                  (<span class="org-keyword">if</span> current (regexp-quote current) <span class="org-string">""</span>)))
                      (prefix (<span class="org-keyword">if</span> current (concat current <span class="org-string">" "</span>) <span class="org-string">""</span>)))
                  (<span class="org-keyword">dolist</span> (entry table)
                    (<span class="org-keyword">pcase</span> entry
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">Description.</span>
                      (`(,(<span class="org-keyword">and</span> key (pred (string-match re))) ,desc)
                       (<span class="org-keyword">let</span> ((k (match-string 1 key)))
                         (<span class="org-keyword">push</span> k des-keys)
                         <span class="org-comment-delimiter">;; </span><span class="org-comment">Keys ending in tab, space or RET are equivalent.</span>
                         (<span class="org-keyword">if</span> (member k tab-alternatives)
                             (<span class="org-keyword">push</span> <span class="org-string">"\t"</span> allowed-keys)
                           (<span class="org-keyword">push</span> k allowed-keys))
                         (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) (propertize <span class="org-string">"&#8250;"</span> 'face 'font-lock-comment-face) <span class="org-string">"  "</span> desc <span class="org-string">"&#8230;"</span> <span class="org-string">"\n"</span>)))
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">Usable entry.</span>
                      (`(,(<span class="org-keyword">and</span> key (pred (string-match re))) ,desc . ,_)
                       (<span class="org-keyword">let</span> ((k (match-string 1 key)))
                         (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) <span class="org-string">"   "</span> desc <span class="org-string">"\n"</span>)
                         (<span class="org-keyword">push</span> k allowed-keys)))
                      (_ nil))))
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Insert special entries, if any.</span>
                (<span class="org-keyword">when</span> specials
                  (insert <span class="org-string">"&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;\n"</span>)
                  (<span class="org-keyword">pcase-dolist</span> (`(,key ,description) specials)
                    (insert (format <span class="org-string">"%s   %s\n"</span> (propertize key 'face '(bold nerd-icons-red)) description))
                    (<span class="org-keyword">push</span> key allowed-keys)))
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Display UI and let user select an entry or</span>
                <span class="org-comment-delimiter">;; </span><span class="org-comment">a sub-level prefix.</span>
                (goto-char (point-min))
                (<span class="org-keyword">unless</span> (pos-visible-in-window-p (point-max))
                  (org-fit-window-to-buffer))
                (<span class="org-keyword">let</span> ((pressed (org--mks-read-key allowed-keys
                                                  prompt
                                                  (not (pos-visible-in-window-p (1- (point-max)))))))
                  (<span class="org-keyword">setq</span> current (concat current pressed))
                  (<span class="org-keyword">cond</span>
                   ((equal pressed <span class="org-string">"\C-g"</span>) (<span class="org-warning">user-error</span> <span class="org-string">"Abort"</span>))
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">Selection is a prefix: open a new menu.</span>
                   ((member pressed des-keys))
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">Selection matches an association: return it.</span>
                   ((<span class="org-keyword">let</span> ((entry (assoc current table)))
                      (<span class="org-keyword">and</span> entry (<span class="org-keyword">throw</span> '<span class="org-constant">exit</span> entry))))
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">Selection matches a special entry: return the</span>
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">selection prefix.</span>
                   ((assoc current specials) (<span class="org-keyword">throw</span> '<span class="org-constant">exit</span> current))
                   (t (<span class="org-warning">error</span> <span class="org-string">"No entry available"</span>)))))))
        (<span class="org-keyword">when</span> buffer (kill-buffer buffer))))))
(advice-add 'org-mks <span class="org-builtin">:override</span> #'org-mks-pretty)
</pre>
</div>
</details>
<p>
The <a href="file:///home/runner/.config/emacs/bin/org-capture">org-capture bin</a> is rather nice, but I'd be nicer with a smaller frame, and
no modeline.
</p>
<details id='capture,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#capture,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setf</span> (alist-get 'height +org-capture-frame-parameters) 15)
<span class="org-comment-delimiter">;; </span><span class="org-comment">(alist-get 'name +org-capture-frame-parameters) "&#10070; Capture") ;; ATM hardcoded in other places, so changing breaks stuff</span>
(<span class="org-keyword">setq</span> +org-capture-fn
      (<span class="org-keyword">lambda</span> ()
        (<span class="org-keyword">interactive</span>)
        (set-window-parameter nil 'mode-line-format 'none)
        (org-capture)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-roam" class="outline-5">
<h5 id="roam"><span class="section-number-5">5.3.3.5.</span> Roam<a aria-hidden="true" href="#roam">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-5">
</div>
<div id="outline-container-basic-settings" class="outline-6">
<h6 id="basic-settings"><span class="section-number-6">5.3.3.5.1.</span> Basic settings<a aria-hidden="true" href="#basic-settings">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-5-1">
<p>
I'll just set this to be within <kbd>Organisation</kbd> folder for now, in the future it
could be worth seeing if I could hook this up to a <a href="https://nextcloud.com/">Nextcloud</a> instance.
</p>

<details id='basic-settings,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#basic-settings,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-roam-directory <span class="org-string">"~/Desktop/TEC/Organisation/Roam/"</span>)
</pre>
</div>
</details>

<p>
That said, if the directory doesn't exist we likely don't want to be using roam.
Since we don't want to trigger errors (which will happen as soon as roam tries
to initialise), let's not load roam.
</p>

<details id='basic-settings,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#basic-settings,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-roam <span class="org-builtin">:disable</span> t)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-modeline-file-name" class="outline-6">
<h6 id="modeline-file-name"><span class="section-number-6">5.3.3.5.2.</span> Modeline file name<a aria-hidden="true" href="#modeline-file-name">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-5-2">
<p>
All those numbers! It's messy. Let's adjust this in a similar way that I have in
the <a href="#window-title">Window title</a>.
</p>

<details id='modeline-file-name,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#modeline-file-name,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> doom-modeline--buffer-file-name-roam-aware-a (orig-fun)
  <span class="org-builtin">:around</span> #'doom-modeline-buffer-file-name <span class="org-comment-delimiter">; </span><span class="org-comment">takes no args</span>
  (<span class="org-keyword">if</span> (string-match-p (regexp-quote org-roam-directory) (<span class="org-keyword">or</span> buffer-file-name <span class="org-string">""</span>))
      (replace-regexp-in-string
       <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">.*/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]\\{</span><span class="org-string"><span class="org-variable-name">4\\</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]\\{</span><span class="org-string"><span class="org-variable-name">2\\</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]\\{</span><span class="org-string"><span class="org-variable-name">2\\</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[0-9]*-"</span>
       <span class="org-string">"&#129172;(\\1-\\2-\\3) "</span>
       (subst-char-in-string ?_ ?  buffer-file-name))
    (funcall orig-fun)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-graph-view" class="outline-6">
<h6 id="graph-view"><span class="section-number-6">5.3.3.5.3.</span> Graph view<a aria-hidden="true" href="#graph-view">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-5-3">
<p>
Org-roam is nice by itself, but there are so <i>extra</i> nice packages which integrate
with it.
</p>

<details id='graph-view,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#graph-view,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> org-roam-ui <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"org-roam/org-roam-ui"</span> <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span> <span class="org-string">"out"</span>)) <span class="org-builtin">:pin</span> <span class="org-string">"5ac74960231db0bf7783c2ba7a19a60f582e91ab"</span>)
(<span class="org-keyword">package!</span> websocket <span class="org-builtin">:pin</span> <span class="org-string">"40c208eaab99999d7c1e4bea883648da24c03be3"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">dependency of `</span><span class="org-comment"><span class="org-constant">org-roam-ui</span></span><span class="org-comment">'</span>
</pre>
</div>
</details>

<details id='graph-view,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#graph-view,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! websocket
  <span class="org-builtin">:after</span> org-roam)

(use-package! org-roam-ui
  <span class="org-builtin">:after</span> org-roam
  <span class="org-builtin">:commands</span> org-roam-ui-open
  <span class="org-builtin">:hook</span> (org-roam . org-roam-ui-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">org-roam</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">in case autoloaded</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">org-roam-ui-open</span> ()
    <span class="org-doc">"Ensure the server is active, then open the roam graph."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">unless</span> org-roam-ui-mode (org-roam-ui-mode 1))
    (browse-url-xdg-open (format <span class="org-string">"http://localhost:%d"</span> org-roam-ui-port))))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-nicer-org-return" class="outline-5">
<h5 id="nicer-org-return"><span class="section-number-5">5.3.3.6.</span> Nicer <code>org-return</code><a aria-hidden="true" href="#nicer-org-return">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-6">
<p>
Once again, from <a href="https://github.com/alphapapa/unpackaged.el#org-return-dwim">unpackaged.el</a>
</p>
<details id='nicer-org-return,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#nicer-org-return,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">unpackaged/org-element-descendant-of</span> (type element)
  <span class="org-doc">"Return non-nil if ELEMENT is a descendant of TYPE.</span>
<span class="org-doc">TYPE should be an element type, like `</span><span class="org-doc"><span class="org-constant">item</span></span><span class="org-doc">' or `</span><span class="org-doc"><span class="org-constant">paragraph</span></span><span class="org-doc">'.</span>
<span class="org-doc">ELEMENT should be a list like that returned by `</span><span class="org-doc"><span class="org-constant">org-element-context</span></span><span class="org-doc">'."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">MAYBE: Use `</span><span class="org-comment"><span class="org-constant">org-element-lineage</span></span><span class="org-comment">'.</span>
  (<span class="org-keyword">when-let*</span> ((parent (org-element-property <span class="org-builtin">:parent</span> element)))
    (<span class="org-keyword">or</span> (eq type (car parent))
        (unpackaged/org-element-descendant-of type parent))))

<span class="org-comment-delimiter">;;;</span><span class="org-comment">###</span><span class="org-comment"><span class="org-warning">autoload</span></span>
(<span class="org-keyword">defun</span> <span class="org-function-name">unpackaged/org-return-dwim</span> (<span class="org-type">&amp;optional</span> default)
  <span class="org-doc">"A helpful replacement for `</span><span class="org-doc"><span class="org-constant">org-return-indent</span></span><span class="org-doc">'.  With prefix, call `</span><span class="org-doc"><span class="org-constant">org-return-indent</span></span><span class="org-doc">'.</span>

<span class="org-doc">On headings, move point to position after entry content.  In</span>
<span class="org-doc">lists, insert a new item or end the list, with checkbox if</span>
<span class="org-doc">appropriate.  In tables, insert a new row or end the table."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Inspired by John Kitchin: http://kitchingroup.cheme.cmu.edu/blog/2017/04/09/A-better-return-in-org-mode/</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">if</span> default
      (org-return t)
    (<span class="org-keyword">cond</span>
     <span class="org-comment-delimiter">;; </span><span class="org-comment">Act depending on context around point.</span>

     <span class="org-comment-delimiter">;; </span><span class="org-comment">NOTE: I prefer RET to not follow links, but by uncommenting this block, links will be</span>
     <span class="org-comment-delimiter">;; </span><span class="org-comment">followed.</span>

     <span class="org-comment-delimiter">;; </span><span class="org-comment">((eq 'link (car (org-element-context)))</span>
     <span class="org-comment-delimiter">;;  </span><span class="org-comment">;; Link: Open it.</span>
     <span class="org-comment-delimiter">;;  </span><span class="org-comment">(org-open-at-point-global))</span>

     ((org-at-heading-p)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Heading: Move to position after entry content.</span>
      <span class="org-comment-delimiter">;; </span><span class="org-comment">NOTE: This is probably the most interesting feature of this function.</span>
      (<span class="org-keyword">let</span> ((heading-start (org-entry-beginning-position)))
        (goto-char (org-entry-end-position))
        (<span class="org-keyword">cond</span> ((<span class="org-keyword">and</span> (org-at-heading-p)
                    (= heading-start (org-entry-beginning-position)))
               <span class="org-comment-delimiter">;; </span><span class="org-comment">Entry ends on its heading; add newline after</span>
               (end-of-line)
               (insert <span class="org-string">"\n\n"</span>))
              (t
               <span class="org-comment-delimiter">;; </span><span class="org-comment">Entry ends after its heading; back up</span>
               (forward-line -1)
               (end-of-line)
               (<span class="org-keyword">when</span> (org-at-heading-p)
                 <span class="org-comment-delimiter">;; </span><span class="org-comment">At the same heading</span>
                 (forward-line)
                 (insert <span class="org-string">"\n"</span>)
                 (forward-line -1))
               (<span class="org-keyword">while</span> (not (looking-back <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[[:blank:]]?\n</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\{</span><span class="org-string"><span class="org-variable-name">3\\</span></span><span class="org-string">}"</span> nil))
                 (insert <span class="org-string">"\n"</span>))
               (forward-line -1)))))

     ((org-at-item-checkbox-p)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Checkbox: Insert new item with checkbox.</span>
      (org-insert-todo-heading nil))

     ((org-in-item-p)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Plain list.  Yes, this gets a little complicated...</span>
      (<span class="org-keyword">let</span> ((context (org-element-context)))
        (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (eq 'plain-list (car context))  <span class="org-comment-delimiter">; </span><span class="org-comment">First item in list</span>
                (<span class="org-keyword">and</span> (eq 'item (car context))
                     (not (eq (org-element-property <span class="org-builtin">:contents-begin</span> context)
                              (org-element-property <span class="org-builtin">:contents-end</span> context))))
                (unpackaged/org-element-descendant-of 'item context))  <span class="org-comment-delimiter">; </span><span class="org-comment">Element in list item, e.g. a link</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Non-empty item: Add new item.</span>
            (org-insert-item)
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Empty item: Close the list.</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">TODO: Do this with org functions rather than operating on the text. Can't seem to find the right function.</span>
          (delete-region (line-beginning-position) (line-end-position))
          (insert <span class="org-string">"\n"</span>))))

     ((<span class="org-keyword">when</span> (fboundp 'org-inlinetask-in-task-p)
        (org-inlinetask-in-task-p))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Inline task: Don't insert a new heading.</span>
      (org-return t))

     ((org-at-table-p)
      (<span class="org-keyword">cond</span> ((<span class="org-keyword">save-excursion</span>
               (beginning-of-line)
               <span class="org-comment-delimiter">;; </span><span class="org-comment">See `</span><span class="org-comment"><span class="org-constant">org-table-next-field</span></span><span class="org-comment">'.</span>
               (<span class="org-keyword">cl-loop</span> with end = (line-end-position)
                        for cell = (org-element-table-cell-parser)
                        always (equal (org-element-property <span class="org-builtin">:contents-begin</span> cell)
                                      (org-element-property <span class="org-builtin">:contents-end</span> cell))
                        while (re-search-forward <span class="org-string">"|"</span> end t)))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">Empty row: end the table.</span>
             (delete-region (line-beginning-position) (line-end-position))
             (org-return t))
            (t
             <span class="org-comment-delimiter">;; </span><span class="org-comment">Non-empty row: call `</span><span class="org-comment"><span class="org-constant">org-return-indent</span></span><span class="org-comment">'.</span>
             (org-return t))))
     (t
      <span class="org-comment-delimiter">;; </span><span class="org-comment">All other cases: call `</span><span class="org-comment"><span class="org-constant">org-return-indent</span></span><span class="org-comment">'.</span>
      (org-return t)))))

(map!
 <span class="org-builtin">:after</span> evil-org
 <span class="org-builtin">:map</span> evil-org-mode-map
 <span class="org-builtin">:i</span> [return] #'unpackaged/org-return-dwim)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-snippet-helpers" class="outline-5">
<h5 id="snippet-helpers"><span class="section-number-5">5.3.3.7.</span> Snippet Helpers<a aria-hidden="true" href="#snippet-helpers">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-7">
<p>
I often want to set <kbd>src-block</kbd> headers, and it's a pain to
</p>
<ul class="org-ul">
<li>type them out</li>
<li>remember what the accepted values are</li>
<li>oh, and specifying the same language again and again</li>
</ul>

<p>
We can solve this in three steps
</p>
<ul class="org-ul">
<li>having one-letter snippets, conditioned on <code>(point)</code> being within a src header</li>
<li>creating a nice prompt showing accepted values and the current default</li>
<li>pre-filling the <kbd>src-block</kbd> language with the last language used</li>
</ul>

<p>
For header args, the keys I'll use are
</p>
<ul class="org-ul">
<li><kbd>r</kbd> for <kbd>:results</kbd></li>
<li><kbd>e</kbd> for <kbd>:exports</kbd></li>
<li><kbd>v</kbd> for <kbd>:eval</kbd></li>
<li><kbd>s</kbd> for <kbd>:session</kbd></li>
<li><kbd>d</kbd> for <kbd>:dir</kbd></li>
</ul>

<details id='snippet-helpers,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#snippet-helpers,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+yas/org-src-header-p</span> ()
  <span class="org-doc">"Determine whether `</span><span class="org-doc"><span class="org-constant">point</span></span><span class="org-doc">' is within a src-block header or header-args."</span>
  (<span class="org-keyword">pcase</span> (org-element-type (org-element-context))
    ('src-block (&lt; (point) <span class="org-comment-delimiter">; </span><span class="org-comment">before code part of the src-block</span>
                   (<span class="org-keyword">save-excursion</span> (goto-char (org-element-property <span class="org-builtin">:begin</span> (org-element-context)))
                                   (forward-line 1)
                                   (point))))
    ('inline-src-block (&lt; (point) <span class="org-comment-delimiter">; </span><span class="org-comment">before code part of the inline-src-block</span>
                          (<span class="org-keyword">save-excursion</span> (goto-char (org-element-property <span class="org-builtin">:begin</span> (org-element-context)))
                                          (search-forward <span class="org-string">"]{"</span>)
                                          (point))))
    ('keyword (string-match-p <span class="org-string">"^header-args"</span> (org-element-property <span class="org-builtin">:value</span> (org-element-context))))))
</pre>
</div>
</details>

<p>
Now let's write a function we can reference in yasnippets to produce a nice
interactive way to specify header args.
</p>

<details id='snippet-helpers,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#snippet-helpers,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+yas/org-prompt-header-arg</span> (arg question values)
  <span class="org-doc">"Prompt the user to set ARG header property to one of VALUES with QUESTION.</span>
<span class="org-doc">The default value is identified and indicated. If either default is selected,</span>
<span class="org-doc">or no selection is made: nil is returned."</span>
  (<span class="org-keyword">let*</span> ((src-block-p (not (looking-back <span class="org-string">"^#\\+property:[ \t]+header-args:.*"</span> (line-beginning-position))))
         (default
           (<span class="org-keyword">or</span>
            (cdr (assoc arg
                        (<span class="org-keyword">if</span> src-block-p
                            (nth 2 (org-babel-get-src-block-info t))
                          (org-babel-merge-params
                           org-babel-default-header-args
                           (<span class="org-keyword">let</span> ((lang-headers
                                  (intern (concat <span class="org-string">"org-babel-default-header-args:"</span>
                                                  (+yas/org-src-lang)))))
                             (<span class="org-keyword">when</span> (boundp lang-headers) (eval lang-headers t)))))))
            <span class="org-string">""</span>))
         default-value)
    (<span class="org-keyword">setq</span> values (mapcar
                  (<span class="org-keyword">lambda</span> (value)
                    (<span class="org-keyword">if</span> (string-match-p (regexp-quote value) default)
                        (<span class="org-keyword">setq</span> default-value
                              (concat value <span class="org-string">" "</span>
                                      (propertize <span class="org-string">"(default)"</span> 'face 'font-lock-doc-face)))
                      value))
                  values))
    (<span class="org-keyword">let</span> ((selection (consult--read values <span class="org-builtin">:prompt</span> question <span class="org-builtin">:default</span> default-value)))
      (<span class="org-keyword">unless</span> (<span class="org-keyword">or</span> (string-match-p <span class="org-string">"(default)$"</span> selection)
                  (string= <span class="org-string">""</span> selection))
        selection))))
</pre>
</div>
</details>

<p>
Finally, we fetch the language information for new source blocks.
</p>

<p>
Since we're getting this info, we might as well go a step further and also
provide the ability to determine the most popular language in the buffer that
doesn't have any <kbd>header-args</kbd> set for it (with <kbd>#+properties</kbd>).
</p>

<details id='snippet-helpers,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#snippet-helpers,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+yas/org-src-lang</span> ()
  <span class="org-doc">"Try to find the current language of the src/header at `</span><span class="org-doc"><span class="org-constant">point</span></span><span class="org-doc">'.</span>
<span class="org-doc">Return nil otherwise."</span>
  (<span class="org-keyword">let</span> ((context (org-element-context)))
    (<span class="org-keyword">pcase</span> (org-element-type context)
      ('src-block (org-element-property <span class="org-builtin">:language</span> context))
      ('inline-src-block (org-element-property <span class="org-builtin">:language</span> context))
      ('keyword (<span class="org-keyword">when</span> (string-match <span class="org-string">"^header-args:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> (org-element-property <span class="org-builtin">:value</span> context))
                  (match-string 1 (org-element-property <span class="org-builtin">:value</span> context)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">+yas/org-last-src-lang</span> ()
  <span class="org-doc">"Return the language of the last src-block, if it exists."</span>
  (<span class="org-keyword">save-excursion</span>
    (beginning-of-line)
    (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"^[ \t]*#\\+begin_src"</span> nil t)
      (org-element-property <span class="org-builtin">:language</span> (org-element-context)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">+yas/org-most-common-no-property-lang</span> ()
  <span class="org-doc">"Find the lang with the most source blocks that has no global header-args, else nil."</span>
  (<span class="org-keyword">let</span> (src-langs header-langs)
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^[ \t]*#\\+begin_src"</span> nil t)
        (<span class="org-keyword">push</span> (+yas/org-src-lang) src-langs))
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^[ \t]*#\\+property: +header-args"</span> nil t)
        (<span class="org-keyword">push</span> (+yas/org-src-lang) header-langs)))

    (<span class="org-keyword">setq</span> src-langs
          (mapcar #'car
                  <span class="org-comment-delimiter">;; </span><span class="org-comment">sort alist by frequency (desc.)</span>
                  (sort
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">generate alist with form (value . frequency)</span>
                   (<span class="org-keyword">cl-loop</span> for (n . m) in (seq-group-by #'identity src-langs)
                            collect (cons n (length m)))
                   (<span class="org-keyword">lambda</span> (a b) (&gt; (cdr a) (cdr b))))))

    (car (cl-set-difference src-langs header-langs <span class="org-builtin">:test</span> #'string=))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-translate-capital-keywords" class="outline-5">
<h5 id="translate-capital-keywords"><span class="section-number-5">5.3.3.8.</span> Translate capital keywords (old) to lower case (new)<a aria-hidden="true" href="#translate-capital-keywords">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-8">
<p>
Everyone used to use <code>#+CAPITAL</code> keywords. Then people realised that <code>#+lowercase</code>
is actually both marginally easier and visually nicer, so now the capital
version is just used in the manual.
</p>
<blockquote>
<p>
Org is standardized on lower case. Uppercase is used in the manual as a poor
man's bold, and supported for historical reasons. &#x2014; <a href="https://orgmode.org/list/87tuuw3n15.fsf@nicolasgoaziou.fr">Nicolas Goaziou on the Org <span class='acr'>ML</span></a>
</p>
</blockquote>

<p>
To avoid sometimes having to choose between the hassle out of updating old
documents and using mixed syntax, I'll whip up a basic transcode-y function.
It likely misses some edge cases, but should mostly work.
</p>

<details id='translate-capital-keywords,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#translate-capital-keywords,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-syntax-convert-keyword-case-to-lower</span> ()
  <span class="org-doc">"Convert all #+KEYWORDS to #+keywords."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (goto-char (point-min))
    (<span class="org-keyword">let</span> ((count 0)
          (case-fold-search nil))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^[ \t]*#\\+[A-Z_]+"</span> nil t)
        (<span class="org-keyword">unless</span> (string-match-p <span class="org-string">"RESULTS"</span> (match-string 0))
          (replace-match (downcase (match-string 0)) t)
          (<span class="org-keyword">setq</span> count (1+ count))))
      (message <span class="org-string">"Replaced %d occurances"</span> count))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-extra-links" class="outline-5">
<h5 id="extra-links"><span class="section-number-5">5.3.3.9.</span> Extra links<a aria-hidden="true" href="#extra-links">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-9">
</div>
<div id="outline-container-extra-links-xkcd" class="outline-6">
<h6 id="extra-links-xkcd"><span class="section-number-6">5.3.3.9.1.</span> xkcd<a aria-hidden="true" href="#extra-links-xkcd">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-9-1">
<p>
Because xkcd is cool, let's make it as easy and fun as possible to insert them.
Saving seconds adds up after all! (but only so much)
</p>

<p>

</p>

<details id='xkcd,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#xkcd,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters <span class="org-string">"xkcd"</span>
                         <span class="org-builtin">:image-data-fun</span> #'+org-xkcd-image-fn
                         <span class="org-builtin">:follow</span> #'+org-xkcd-open-fn
                         <span class="org-builtin">:export</span> #'+org-xkcd-export
                         <span class="org-builtin">:complete</span> #'+org-xkcd-complete)

(<span class="org-keyword">defun</span> <span class="org-function-name">+org-xkcd-open-fn</span> (link)
  (+org-xkcd-image-fn nil link nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">+org-xkcd-image-fn</span> (protocol link description)
  <span class="org-doc">"Get image data for xkcd num LINK"</span>
  (<span class="org-keyword">let*</span> ((xkcd-info (+xkcd-fetch-info (string-to-number link)))
         (img (plist-get xkcd-info <span class="org-builtin">:img</span>))
         (alt (plist-get xkcd-info <span class="org-builtin">:alt</span>)))
    (message alt)
    (+org-image-file-data-fn protocol (xkcd-download img (string-to-number link)) description)))

(<span class="org-keyword">defun</span> <span class="org-function-name">+org-xkcd-export</span> (num desc backend _com)
  <span class="org-doc">"Convert xkcd to html/LaTeX form"</span>
  (<span class="org-keyword">let*</span> ((xkcd-info (+xkcd-fetch-info (string-to-number num)))
         (img (plist-get xkcd-info <span class="org-builtin">:img</span>))
         (alt (plist-get xkcd-info <span class="org-builtin">:alt</span>))
         (title (plist-get xkcd-info <span class="org-builtin">:title</span>))
         (file (xkcd-download img (string-to-number num))))
    (<span class="org-keyword">cond</span> ((org-export-derived-backend-p backend 'html)
           (format <span class="org-string">"&lt;img class='</span><span class="org-string"><span class="org-constant">invertible</span></span><span class="org-string">' src='</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' title=\"%s\" alt='</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'&gt;"</span> img (subst-char-in-string ?\" ?<span class="org-warning">&#8220;</span> alt) title))
          ((org-export-derived-backend-p backend 'latex)
           (format <span class="org-string">"\\begin{figure}[!htb]</span>
<span class="org-string">  \\centering</span>
<span class="org-string">  \\includegraphics[scale=0.4]{%s}%s</span>
<span class="org-string">\\end{figure}"</span> file (<span class="org-keyword">if</span> (equal desc (format <span class="org-string">"xkcd:%s"</span> num)) <span class="org-string">""</span>
                      (format <span class="org-string">"\n  \\caption*{\\label{xkcd:%s} %s}"</span>
                              num
                              (<span class="org-keyword">or</span> desc
                                  (format <span class="org-string">"\\textbf{%s} %s"</span> title alt))))))
          (t (format <span class="org-string">"https://xkcd.com/%s"</span> num)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">+org-xkcd-complete</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Complete xkcd using `</span><span class="org-doc"><span class="org-constant">+xkcd-stored-info</span></span><span class="org-doc">'"</span>
  (format <span class="org-string">"xkcd:%d"</span> (+xkcd-select)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-youtube" class="outline-6">
<h6 id="youtube"><span class="section-number-6">5.3.3.9.2.</span> YouTube<a aria-hidden="true" href="#youtube">#</a> </h6>
<div class="outline-text-6" id="text-5-3-3-9-2">
<p>
The <code>[[yt:...]]</code> links preview nicely, but don't export nicely. Thankfully, we can
fix that.
</p>
<details id='youtube,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#youtube,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters <span class="org-string">"yt"</span> <span class="org-builtin">:export</span> #'+org-export-yt)
(<span class="org-keyword">defun</span> <span class="org-function-name">+org-export-yt</span> (path desc backend _com)
  (<span class="org-keyword">cond</span> ((org-export-derived-backend-p backend 'html)
         (format <span class="org-string">"&lt;iframe width='</span><span class="org-string"><span class="org-constant">440</span></span><span class="org-string">' \</span>
<span class="org-string">height='</span><span class="org-string"><span class="org-constant">335</span></span><span class="org-string">' \</span>
<span class="org-string">src='</span><span class="org-string"><span class="org-constant">https://www.youtube.com/embed/%s</span></span><span class="org-string">' \</span>
<span class="org-string">frameborder='</span><span class="org-string"><span class="org-constant">0</span></span><span class="org-string">' \</span>
<span class="org-string">allowfullscreen&gt;%s&lt;/iframe&gt;"</span> path (<span class="org-keyword">or</span> <span class="org-string">""</span> desc)))
        ((org-export-derived-backend-p backend 'latex)
         (format <span class="org-string">"\\href{https://youtu.be/%s}{%s}"</span> path (<span class="org-keyword">or</span> desc <span class="org-string">"youtube"</span>)))
        (t (format <span class="org-string">"https://youtu.be/%s"</span> path))))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-fix-problematic-hooks" class="outline-5">
<h5 id="fix-problematic-hooks"><span class="section-number-5">5.3.3.10.</span> Fix problematic hooks<a aria-hidden="true" href="#fix-problematic-hooks">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-10">
<p>
When one of the <code class="src src-elisp">org-mode-hook</code> functions errors, it halts the hook
execution. This is problematic, and there are two hooks in particular which
cause issues. Let's make their failure less eventful.
</p>

<details id='fix-problematic-hooks,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fix-problematic-hooks,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> shut-up-org-problematic-hooks (orig-fn <span class="org-type">&amp;rest</span> args)
  <span class="org-builtin">:around</span> #'org-fancy-priorities-mode
  (<span class="org-keyword">ignore-errors</span> (apply orig-fn args)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-flycheck-with-org" class="outline-5">
<h5 id="flycheck-with-org"><span class="section-number-5">5.3.3.11.</span> Flycheck with org-lint<a aria-hidden="true" href="#flycheck-with-org">#</a> </h5>
<div class="outline-text-5" id="text-5-3-3-11">
<p>
Org may be simple, but that doesn't mean there's no such thing as malformed Org.
Thankfully, malformed Org is a much less annoying affair than malformed zipped
<span class='acr'>XML</span> (looks at <span class='acr'>DOCX</span>/<span class='acr'>ODT</span>&#x2026;), particularly because there's a rather helpful little
tool called <code>org-lint</code> bundled with Org that can tell you about your mistakes.
</p>

<p>

</p>

<p>
Flycheck doesn't currently support Org, and there's aren't any packages to do so
☹. However, in an issue on <code>org-lint</code> there is <a href="https://github.com/flycheck/flycheck/issues/1757#issuecomment-759546940">some code</a> which apparently works.
Surely this is what the clipboard was invented for? With that said, let's
regurgitate the code, cross our fingers, and hope it works.
</p>

<details id='flycheck-with-org,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#flycheck-with-org,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defconst</span> <span class="org-variable-name">flycheck-org-lint-form</span>
  (<span class="org-keyword">flycheck-prepare-emacs-lisp-form</span>
    (<span class="org-keyword">require</span> '<span class="org-constant">org</span>)
    (<span class="org-keyword">require</span> '<span class="org-constant">org-lint</span>)
    (<span class="org-keyword">require</span> '<span class="org-constant">org-attach</span>)
    (<span class="org-keyword">let</span> ((source (car command-line-args-left))
          (process-default-directory default-directory))
      (<span class="org-keyword">with-temp-buffer</span>
        (insert-file-contents source 'visit)
        (<span class="org-keyword">setq</span> buffer-file-name source)
        (<span class="org-keyword">setq</span> default-directory process-default-directory)
        (<span class="org-keyword">delay-mode-hooks</span> (org-mode))
        (<span class="org-keyword">setq</span> delayed-mode-hooks nil)
        (<span class="org-keyword">dolist</span> (err (org-lint))
          (<span class="org-keyword">let</span> ((inf (cl-second err)))
            (princ (elt inf 0))
            (princ <span class="org-string">": "</span>)
            (princ (elt inf 2))
            (terpri)))))))

(<span class="org-keyword">defconst</span> <span class="org-variable-name">flycheck-org-lint-variables</span>
  '(org-directory
    org-id-locations
    org-id-locations-file
    org-attach-id-dir
    org-attach-use-inheritance
    org-attach-id-to-path-function-list
    org-link-parameters)
  <span class="org-doc">"Variables inherited by the org-lint subprocess."</span>)

(<span class="org-keyword">defconst</span> <span class="org-variable-name">flycheck-org-lint-babel-langs</span>
  '&lt;&lt;org-babel-list-langs()&gt;&gt;
  <span class="org-string">"Languages that org-babel should know of."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">flycheck-org-lint-variables-form</span> ()
  (<span class="org-keyword">require</span> '<span class="org-constant">org-attach</span>)  <span class="org-comment-delimiter">; </span><span class="org-comment">Needed to make variables available</span>
  `(<span class="org-keyword">progn</span>
     ,@(seq-map (<span class="org-keyword">lambda</span> (opt) `(<span class="org-keyword">setq-default</span> ,opt ',(symbol-value opt)))
                (seq-filter #'boundp flycheck-org-lint-variables))))

(<span class="org-keyword">defun</span> <span class="org-function-name">flycheck-org-lint-babel-langs-form</span> ()
  `(<span class="org-keyword">progn</span>
     ,@(mapcar
        (<span class="org-keyword">lambda</span> (lang)
          `(<span class="org-keyword">defun</span> ,(intern (format <span class="org-string">"org-babel-execute:%s"</span> lang)) (_body _params)
             <span class="org-doc">"Stub for org-lint."</span>))
        flycheck-org-lint-babel-langs)))

(eval <span class="org-comment-delimiter">; </span><span class="org-comment">To preveant eager macro expansion form loading flycheck early.</span>
 '(flycheck-define-checker org-lint
   <span class="org-doc">"Org buffer checker using `</span><span class="org-doc"><span class="org-constant">org-lint</span></span><span class="org-doc">'."</span>
   <span class="org-builtin">:command</span> (<span class="org-string">"emacs"</span> (eval flycheck-emacs-args)
             <span class="org-string">"--eval"</span> (eval (concat <span class="org-string">"(add-to-list 'load-path \""</span>
                                    (file-name-directory (locate-library <span class="org-string">"org"</span>))
                                    <span class="org-string">"\")"</span>))
             <span class="org-string">"--eval"</span> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-variables-form)))
             <span class="org-string">"--eval"</span> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-customisations-form)))
             <span class="org-string">"--eval"</span> (eval (flycheck-sexp-to-string
                             (flycheck-org-lint-babel-langs-form)))
             <span class="org-string">"--eval"</span> (eval flycheck-org-lint-form)
             <span class="org-string">"--"</span> source)
   <span class="org-builtin">:error-patterns</span>
   ((<span class="org-warning">error</span> line-start line <span class="org-string">": "</span> (message) line-end))
   <span class="org-builtin">:modes</span> org-mode))
</pre>
</div>
</details>

<p>
Turns out it almost works. Running <kbd>M-x flycheck-verify-setup</kbd> after running that
snippet produces the following:
</p>
<details id='orgd163813' class='code' open>
<summary></summary>
<div class='gutter'><a href='#orgd163813'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="orgd163813">
The following syntax checkers are not registered:
  - org-lint
Try adding these syntax checkers to `flycheck-checkers'.
</pre>

</details>

<p>
Well that's very nice and helpful. We'll just do that 🙂.
</p>
<details id='flycheck-with-org,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#flycheck-with-org,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'flycheck-checkers 'org-lint)
</pre>
</div>
</details>

<p>
It was missing custom link types, but that's easily fixed just by adding
<code>org-link-parameters</code> to <code>flycheck-org-lint-variables</code>.
</p>

<p>
One remaining little annoyance is that it reports extra <kbd>#+options</kbd> that I've
added to Org as errors. So we need to tell <code>org-lint</code> about them without having it
load my whole config. Code duplication isn't great, but at least this isn't
much.
</p>

<details id='flycheck-with-org,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#flycheck-with-org,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">flycheck-org-lint-customisations-form</span> ()
  `(<span class="org-keyword">progn</span>
     (<span class="org-keyword">require</span> '<span class="org-constant">ox</span>)
     (<span class="org-keyword">cl-pushnew</span> '(<span class="org-builtin">:latex-cover-page</span> nil <span class="org-string">"coverpage"</span> nil)
                 (org-export-backend-options (org-export-get-backend 'latex)))
     (<span class="org-keyword">cl-pushnew</span> '(<span class="org-builtin">:latex-font-set</span> nil <span class="org-string">"fontset"</span> nil)
                 (org-export-backend-options (org-export-get-backend 'latex)))))
</pre>
</div>
</details>

<p>
A larger annoyance is that org-lint doesn't actually know what languages
org-babel should recognise, with Doom's lazy loading system. Since the list of
languages should really only change when packages are added/removed, we might as
well statically determine a list of all org-babel languages at configuration
generation time.
</p>

<details id='org-babel-list' class='code' open><summary class='named'><span class="name">org-babel-list-langs</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-babel-list'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let</span> (langs)
  (<span class="org-keyword">dolist</span> (dir load-path)
    (<span class="org-keyword">when</span> (file-directory-p dir)
      (<span class="org-keyword">dolist</span> (file (directory-files dir t <span class="org-string">"\\.elc?$"</span>))
        (<span class="org-keyword">let</span> ((basename (file-name-base file)))
          (<span class="org-keyword">when</span> (string-prefix-p <span class="org-string">"ob-"</span> basename)
            (<span class="org-keyword">ignore-errors</span>
              (<span class="org-keyword">require</span> (intern basename) file t)))))))
  (mapatoms
   (<span class="org-keyword">lambda</span> (symb)
     (<span class="org-keyword">when</span> (functionp symb)
       (<span class="org-keyword">let</span> ((name (symbol-name symb)))
         (<span class="org-keyword">let</span> ((fn (symbol-function symb)))
           (<span class="org-keyword">when</span> (symbolp fn)
             (<span class="org-keyword">setq</span> symb (symbol-function symb)
                   fn (symbol-function symb)))
           (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string-suffix-p <span class="org-string">"-mode"</span> name)
                      (autoloadp fn))
             (<span class="org-keyword">ignore-errors</span> (autoload-do-load fn))))
         (<span class="org-keyword">cond</span>
          ((string-prefix-p <span class="org-string">"org-babel-execute:"</span> name)
           (<span class="org-keyword">push</span> (replace-regexp-in-string <span class="org-string">"^org-babel-execute:"</span> <span class="org-string">""</span> name)
                 langs))
          ((<span class="org-keyword">and</span> (string-suffix-p <span class="org-string">"-mode"</span> name)
                (provided-mode-derived-p
                 symb 'prog-mode 'text-mode 'conf-mode))
           (<span class="org-keyword">push</span> (replace-regexp-in-string <span class="org-string">"-mode$"</span> <span class="org-string">""</span> name)
                 langs))))))
   obarray)
  (<span class="org-keyword">dolist</span> (mode-mapping org-src-lang-modes)
    (<span class="org-keyword">push</span> (car mode-mapping) langs))
  (mapcar #'intern
          (sort (delete-dups langs) #'string&lt;)))
</pre>
</div>
</details>

<p>
This increases the tangle time by about 10&#x2013;20%, but I think it's worth it to be
extra thorough. If this really becomes a pain, we can always think about doing
some sort of cache file based on the load-path/packages installed.
</p>
</div>
</div>
</div>
<div id="outline-container-org-visuals" class="outline-4">
<h4 id="org-visuals"><span class="section-number-4">5.3.4.</span> Visuals<a aria-hidden="true" href="#org-visuals">#</a> </h4>
<div class="outline-text-4" id="text-5-3-4">
<p>
Here I try to do two things: improve the styling of the various documents, via
font changes etc, and also propagate colours from the current theme.
</p>

<p>

</p>
</div>
<div id="outline-container-font-display" class="outline-5">
<h5 id="font-display"><span class="section-number-5">5.3.4.1.</span> Font Display<a aria-hidden="true" href="#font-display">#</a> </h5>
<div class="outline-text-5" id="text-5-3-4-1">
<p>
Mixed pitch is great. As is <code>+org-pretty-mode</code>, let's use them.
</p>
<details id='font-display,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-display,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'org-mode-hook #'+org-pretty-mode)
</pre>
</div>
</details>

<p>
Let's make headings a bit bigger
</p>
<details id='font-display,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-display,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(custom-set-faces!
  '(outline-1 <span class="org-builtin">:weight</span> extra-bold <span class="org-builtin">:height</span> 1.25)
  '(outline-2 <span class="org-builtin">:weight</span> bold <span class="org-builtin">:height</span> 1.15)
  '(outline-3 <span class="org-builtin">:weight</span> bold <span class="org-builtin">:height</span> 1.12)
  '(outline-4 <span class="org-builtin">:weight</span> semi-bold <span class="org-builtin">:height</span> 1.09)
  '(outline-5 <span class="org-builtin">:weight</span> semi-bold <span class="org-builtin">:height</span> 1.06)
  '(outline-6 <span class="org-builtin">:weight</span> semi-bold <span class="org-builtin">:height</span> 1.03)
  '(outline-8 <span class="org-builtin">:weight</span> semi-bold)
  '(outline-9 <span class="org-builtin">:weight</span> semi-bold))
</pre>
</div>
</details>

<p>
And the same with the title.
</p>
<details id='font-display,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-display,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(custom-set-faces!
  '(org-document-title <span class="org-builtin">:height</span> 1.2))
</pre>
</div>
</details>

<p>
It seems reasonable to have deadlines in the error face when they're passed.
</p>
<details id='font-display,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-display,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-agenda-deadline-faces
      '((1.001 . error)
        (1.0 . org-warning)
        (0.5 . org-upcoming-deadline)
        (0.0 . org-upcoming-distant-deadline)))
</pre>
</div>
</details>

<p>
We can then have quote blocks stand out a bit more by making them <i>italic</i>.
</p>
<details id='font-display,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-display,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-fontify-quote-and-verse-blocks t)
</pre>
</div>
</details>

<p>
Org files can be rather nice to look at, particularly with some of the
customisations here. This comes at a cost however, expensive font-lock.
Feeling like you're typing through molasses in large files is no fun, but there
is a way I can defer font-locking when typing to make the experience more
responsive.
</p>
<details id='font-display,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-display,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">locally-defer-font-lock</span> ()
  <span class="org-doc">"Set jit-lock defer and stealth, when buffer is over a certain size."</span>
  (<span class="org-keyword">when</span> (&gt; (buffer-size) 50000)
    (<span class="org-keyword">setq-local</span> jit-lock-defer-time 0.05
                jit-lock-stealth-time 1)))

(add-hook 'org-mode-hook #'locally-defer-font-lock)
</pre>
</div>
</details>
<p>
Apparently this causes issues with some people, but I haven't noticed anything
problematic beyond the expected slight delay in some fontification, so until I
do I'll use the above.
</p>
</div>
</div>
<div id="outline-container-reduced-text-indent" class="outline-5">
<h5 id="reduced-text-indent"><span class="section-number-5">5.3.4.2.</span> Reduced text indent<a aria-hidden="true" href="#reduced-text-indent">#</a> </h5>
<div class="outline-text-5" id="text-5-3-4-2">
<p>
Thanks to the various bits and bobs of setup we have here, the non-heading lines
tend to appear over-indented in <code>org-indent-mode</code>. We can adjust this by modifying
the generated text prefixes.
</p>

<p>
There's another issue we can have when using mixed-pitch mode, where the line
height is set by the indent prefix displayed with the fixed-pitch font. This
means that on 0-indent lines the line spacing can be different, which doesn't
look very good. We can also solve this problem by modifying the generated text
prefixes to but a fixed-pitch zero width space at the start of 0-indent lines
instead of nothing.
</p>

<details id='reduced-text-indent,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#reduced-text-indent,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> +org-indent--reduced-text-prefixes ()
  <span class="org-builtin">:after</span> #'org-indent--compute-prefixes
  (<span class="org-keyword">setq</span> org-indent--text-line-prefixes
        (make-vector org-indent--deepest-level nil))
  (<span class="org-keyword">when</span> (&gt; org-indent-indentation-per-level 0)
    (<span class="org-keyword">dotimes</span> (n org-indent--deepest-level)
      (aset org-indent--text-line-prefixes
            n
            (org-add-props
                (concat (make-string (* n (1- org-indent-indentation-per-level))
                                     ?\s)
                        (<span class="org-keyword">if</span> (&gt; n 0)
                             (char-to-string org-indent-boundary-char)
                          <span class="org-string">"\u200b"</span>))
                nil 'face 'org-indent)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-fontifying-inline-src" class="outline-5">
<h5 id="fontifying-inline-src"><span class="section-number-5">5.3.4.3.</span> Fontifying inline src blocks<a aria-hidden="true" href="#fontifying-inline-src">#</a> </h5>
<div class="outline-text-5" id="text-5-3-4-3">
<p>
Org does lovely things with <kbd>#+begin_src</kbd> blocks, like using font-lock for
language's major-mode behind the scenes and pulling out the lovely colourful
results. By contrast, inline <kbd>src_</kbd> blocks are somewhat neglected.
</p>

<p>
I am not the first person to feel this way, thankfully others have <a href="https://stackoverflow.com/questions/20309842/how-to-syntax-highlight-for-org-mode-inline-source-code-src-lang/28059832">taken to
stackexchange</a> to voice their desire for inline src fontification. I was going to
steal their work, but unfortunately they didn't perform <i>true</i> source code
fontification, but simply applied the <kbd>org-code</kbd> face to the content.
</p>

<p>
We can do better than that, and we shall! Using <code>org-src-font-lock-fontify-block</code>
we can apply language-appropriate syntax highlighting. Then, continuing on to
<kbd>{{{results(...)}}}</kbd> , it can have the <kbd>org-block</kbd> face applied to match, and then
the value-surrounding constructs hidden by mimicking the behaviour of
<code>prettify-symbols-mode</code>.
</p>

<div class="warning" id="org4b9a34e">
<p>
This currently only highlights a single inline src block per line.
I have no idea why it stops, but I'd rather it didn't.
If you have any idea what's going on or how to fix this <i>please</i> get in touch.
</p>

</div>

<details id='fontifying-inline-src,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fontifying-inline-src,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-inline-src-prettify-results '(<span class="org-string">"&#10216;"</span> . <span class="org-string">"&#10217;"</span>))
</pre>
</div>
</details>

<p>
Doom theme's extra fontification is more problematic than helpful.
</p>
<details id='fontifying-inline-src,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fontifying-inline-src,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> doom-themes-org-fontify-special-tags nil)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-symbols" class="outline-5">
<h5 id="symbols"><span class="section-number-5">5.3.4.4.</span> Symbols<a aria-hidden="true" href="#symbols">#</a> </h5>
<div class="outline-text-5" id="text-5-3-4-4">
<p>
It's also nice to change the character used for collapsed items (by default <code>…</code>),
I think <code>▾</code> is better for indicating 'collapsed section'.
and add an extra <code>org-bullet</code> to the default list of four.
</p>

<details id='symbols,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#symbols,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-ellipsis <span class="org-string">" &#9662; "</span>
      org-hide-leading-stars t
      org-priority-highest ?A
      org-priority-lowest ?E
      org-priority-faces
      '((?A . 'nerd-icons-red)
        (?B . 'nerd-icons-orange)
        (?C . 'nerd-icons-yellow)
        (?D . 'nerd-icons-green)
        (?E . 'nerd-icons-blue)))
</pre>
</div>
</details>

<p>
It's also nice to make use of the <kbd>prettify-symbols-mode</kbd> for a few Org syntactic
tokens which we'd like to prettify that aren't covered by <kbd>org-modern</kbd> or any
other settings.
</p>

<details id='symbols,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#symbols,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">appendq!</span> +ligatures-extra-symbols
          (list <span class="org-builtin">:list_property</span> <span class="org-string">"&#8759;"</span>
                <span class="org-builtin">:em_dash</span>       <span class="org-string">"&#8212;"</span>
                <span class="org-builtin">:ellipses</span>      <span class="org-string">"&#8230;"</span>
                <span class="org-builtin">:arrow_right</span>   <span class="org-string">"&#8594;"</span>
                <span class="org-builtin">:arrow_left</span>    <span class="org-string">"&#8592;"</span>
                <span class="org-builtin">:arrow_lr</span>      <span class="org-string">"&#8596;"</span>
                <span class="org-builtin">:properties</span>    <span class="org-string">"&#9881;"</span>
                <span class="org-builtin">:end</span>           <span class="org-string">"&#8718;"</span>
                <span class="org-builtin">:priority_a</span>    #(<span class="org-string">"&#9873;"</span> 0 1 (face nerd-icons-red))
                <span class="org-builtin">:priority_b</span>    #(<span class="org-string">"&#11014;"</span> 0 1 (face nerd-icons-orange))
                <span class="org-builtin">:priority_c</span>    #(<span class="org-string">"&#9632;"</span> 0 1 (face nerd-icons-yellow))
                <span class="org-builtin">:priority_d</span>    #(<span class="org-string">"&#11015;"</span> 0 1 (face nerd-icons-green))
                <span class="org-builtin">:priority_e</span>    #(<span class="org-string">"&#10067;"</span> 0 1 (face nerd-icons-blue))))

(<span class="org-keyword">defadvice!</span> +org-init-appearance-h--no-ligatures-a ()
  <span class="org-builtin">:after</span> #'+org-init-appearance-h
  (set-ligatures! 'org-mode nil)
  (set-ligatures! 'org-mode
    <span class="org-builtin">:list_property</span> <span class="org-string">"::"</span>
    <span class="org-builtin">:em_dash</span>       <span class="org-string">"---"</span>
    <span class="org-builtin">:ellipsis</span>      <span class="org-string">"..."</span>
    <span class="org-builtin">:arrow_right</span>   <span class="org-string">"-&gt;"</span>
    <span class="org-builtin">:arrow_left</span>    <span class="org-string">"&lt;-"</span>
    <span class="org-builtin">:arrow_lr</span>      <span class="org-string">"&lt;-&gt;"</span>
    <span class="org-builtin">:properties</span>    <span class="org-string">":PROPERTIES:"</span>
    <span class="org-builtin">:end</span>           <span class="org-string">":END:"</span>
    <span class="org-builtin">:priority_a</span>    <span class="org-string">"[#A]"</span>
    <span class="org-builtin">:priority_b</span>    <span class="org-string">"[#B]"</span>
    <span class="org-builtin">:priority_c</span>    <span class="org-string">"[#C]"</span>
    <span class="org-builtin">:priority_d</span>    <span class="org-string">"[#D]"</span>
    <span class="org-builtin">:priority_e</span>    <span class="org-string">"[#E]"</span>))
</pre>
</div>
</details>

<p>
While we're at it we may as well make tags prettier as well 🙂
</p>
<details id='symbols,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#symbols,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">(package! org-pretty-tags :pin "5c7521651b35ae9a7d3add4a66ae8cc176ae1c76")</span>
</pre>
</div>
</details>

<details id='symbols,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#symbols,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">(use-package org-pretty-tags</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">:config</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">(setq org-pretty-tags-surrogate-strings</span>
<span class="org-comment-delimiter">;;        </span><span class="org-comment">`(("uni"        . ,(all-the-icons-faicon   "graduation-cap" :face 'all-the-icons-purple  :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("ucc"        . ,(all-the-icons-material "computer"       :face 'all-the-icons-silver  :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("assignment" . ,(all-the-icons-material "library_books"  :face 'all-the-icons-orange  :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("test"       . ,(all-the-icons-material "timer"          :face 'all-the-icons-red     :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("lecture"    . ,(all-the-icons-fileicon "keynote"        :face 'all-the-icons-orange  :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("email"      . ,(all-the-icons-faicon   "envelope"       :face 'all-the-icons-blue    :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("read"       . ,(all-the-icons-octicon  "book"           :face 'all-the-icons-lblue   :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("article"    . ,(all-the-icons-octicon  "file-text"      :face 'all-the-icons-yellow  :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("web"        . ,(all-the-icons-faicon   "globe"          :face 'all-the-icons-green   :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("info"       . ,(all-the-icons-faicon   "info-circle"    :face 'all-the-icons-blue    :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("issue"      . ,(all-the-icons-faicon   "bug"            :face 'all-the-icons-red     :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("someday"    . ,(all-the-icons-faicon   "calendar-o"     :face 'all-the-icons-cyan    :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("idea"       . ,(all-the-icons-octicon  "light-bulb"     :face 'all-the-icons-yellow  :v-adjust 0.01))</span>
<span class="org-comment-delimiter">;;          </span><span class="org-comment">("emacs"      . ,(all-the-icons-fileicon "emacs"          :face 'all-the-icons-lpurple :v-adjust 0.01))))</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">(org-pretty-tags-global-mode))</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-latex-fragments" class="outline-5">
<h5 id="latex-fragments"><span class="section-number-5">5.3.4.5.</span> LaTeX Fragments<a aria-hidden="true" href="#latex-fragments">#</a> </h5>
<div class="outline-text-5" id="text-5-3-4-5">
</div>
<div id="outline-container-prettier-highlighting" class="outline-6">
<h6 id="prettier-highlighting"><span class="section-number-6">5.3.4.5.1.</span> Prettier highlighting<a aria-hidden="true" href="#prettier-highlighting">#</a> </h6>
<div class="outline-text-6" id="text-5-3-4-5-1">
<p>
First off, we want those fragments to look good.
</p>
<details id='prettier-highlighting,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prettier-highlighting,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-highlight-latex-and-related '(latex script entities))
</pre>
</div>
</details>

<p>
However, by using <kbd>native</kbd> highlighting the <kbd>org-block</kbd> face is added, and that
doesn't look too great &#x2014; particularly when the fragments are previewed.
</p>

<p>
Ideally <code>org-src-font-lock-fontify-block</code> wouldn't add the <kbd>org-block</kbd> face, but we
can avoid advising that entire function by just adding another face with
<kbd>:inherit default</kbd> which will override the background colour.
</p>

<p>
Inspecting <code>org-do-latex-and-related</code> shows that <kbd>"latex"</kbd> is the language argument
passed, and so we can override the background as discussed above.
</p>
<details id='prettier-highlighting,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prettier-highlighting,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">org-src</span>)
(add-to-list 'org-src-block-faces '(<span class="org-string">"latex"</span> (<span class="org-builtin">:inherit</span> default <span class="org-builtin">:extend</span> t)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-automatic-previewing" class="outline-6">
<h6 id="automatic-previewing"><span class="section-number-6">5.3.4.5.2.</span> Automatic previewing<a aria-hidden="true" href="#automatic-previewing">#</a> </h6>
<div class="outline-text-6" id="text-5-3-4-5-2">
<p>
It would be nice if fragments could automatically be previewed after being
typed, and the overlays automatically showed and hidden when moving the point in
and out of the LaTeX fragments.
</p>

<p>
Thankfully, all we need to do to make this happen is use <code>org-latex-preview-auto-mode</code>.
</p>

<details id='automatic-previewing,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#automatic-previewing,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'org-mode-hook #'org-latex-preview-auto-mode)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-prettier-rendering" class="outline-6">
<h6 id="prettier-rendering"><span class="section-number-6">5.3.4.5.3.</span> Prettier rendering<a aria-hidden="true" href="#prettier-rendering">#</a> </h6>
<div class="outline-text-6" id="text-5-3-4-5-3">
<p>
It's nice to customise the look of LaTeX fragments so they fit better in the
text &#x2014; like this \(\sqrt{\beta^2+3}-\sum_{\phi=1}^\infty \frac{x^\phi-1}{\Gamma(a)}\).
</p>

<p>
The default snippet preamble basically just sets the margins and text size, with
templates to be filled in by <code>org-latex-default-packages-alist</code> and
<kbd>#+latex_header:</kbd> entries (but not <kbd>#+latex_header_extra:</kbd>).
</p>

<details id='latex-default-snippet' class='code' open><summary class='named'><span class="name">latex-default-snippet-preamble</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-default-snippet'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\documentclass</span></span>{<span class="org-function-name">article</span>}
[<span class="org-variable-name">DEFAULT-PACKAGES</span>]
[PACKAGES]
<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">xcolor</span>}
</pre>
</div>
</details>

<p>
To this, we make two additions:
</p>
<ul class="org-ul">
<li>Selection of a maths font that fits better with displayed text.</li>
<li>My collection <a href="#maths-notation-conveniences">mathematical notation conveniences</a>.</li>
</ul>

<details id='prettier-rendering,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prettier-rendering,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-latex-preview-preamble
      (concat
       &lt;&lt;grab(<span class="org-string">"latex-default-snippet-preamble"</span>)&gt;&gt;
       <span class="org-string">"\n% Custom font\n\\usepackage{arev}\n\n"</span>
       &lt;&lt;grab(<span class="org-string">"latex-maths-conveniences"</span>)&gt;&gt;))
</pre>
</div>
</details>

<p>
Since we can, instead of making the background colour match the <kbd>default</kbd> face,
let's make it transparent.
</p>

<details id='prettier-rendering,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#prettier-rendering,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Calibrated based on the TeX font and org-buffer font.</span>
(plist-put org-format-latex-options <span class="org-builtin">:zoom</span> 0.93)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-rendering-speed-tests" class="outline-6">
<h6 id="rendering-speed-tests"><span class="section-number-6">5.3.4.5.4.</span> Rendering speed tests<a aria-hidden="true" href="#rendering-speed-tests">#</a> </h6>
<div class="outline-text-6" id="text-5-3-4-5-4">
<p>
We can either render from a <code>dvi</code> or <code>pdf</code> file, so let's benchmark <code>latex</code> and
<code>pdflatex</code>.
</p>
<div id='rendering-speed-tests,table--1' class='table'>
<div class='gutter'><a href='#rendering-speed-tests,table--1'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><code>latex</code> time</th>
<th scope="col" class="org-left"><code>pdflatex</code> time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">135 &plusmn; 2 ms</td>
<td class="org-left">215 &plusmn; 3 ms</td>
</tr>
</tbody>
</table>
</div></div>

<p>
On the rendering side, there are two <code>.dvi</code>-to-image converters which I am
interested in: <code>dvipng</code> and <code>dvisvgm</code>.
</p>

<p>
Using the above latex expression and benchmarking lead to the following results:
</p>
<div id='rendering-speed-tests,table--2' class='table'>
<div class='gutter'><a href='#rendering-speed-tests,table--2'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><code>dvipng</code> time</th>
<th scope="col" class="org-left"><code>dvisvgm</code> time</th>
<th scope="col" class="org-left"><code>pdf2svg</code> time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">89 &plusmn; 2 ms</td>
<td class="org-left">178 &plusmn; 2 ms</td>
<td class="org-left">12 &plusmn; 2 ms</td>
</tr>
</tbody>
</table>
</div></div>

<p>
Now let's combine this to see what's best
</p>
<div id='rendering-speed-tests,table--3' class='table'>
<div class='gutter'><a href='#rendering-speed-tests,table--3'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Tool chain</th>
<th scope="col" class="org-left">Total time</th>
<th scope="col" class="org-left">Resulting file size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>latex</code> + <code>dvipng</code></td>
<td class="org-left">226 &plusmn; 2 ms</td>
<td class="org-left">7 KiB</td>
</tr>

<tr>
<td class="org-left"><code>latex</code> + <code>dvisvgm</code></td>
<td class="org-left">392 &plusmn; 4 ms</td>
<td class="org-left">8 KiB</td>
</tr>

<tr>
<td class="org-left"><code>pdflatex</code> + <code>pdf2svg</code></td>
<td class="org-left">230 &plusmn; 2 ms</td>
<td class="org-left">16 KiB</td>
</tr>
</tbody>
</table>
</div></div>

<p>
So, let's use <code>dvipng</code> for previewing LaTeX fragments in-Emacs, but <code>dvisvgm</code> for <a href="#latex-rendering">5.3.6.12</a>.
</p>

<div class="warning" id="org8d0bf7d">
<p>
Unfortunately, it seems that <span class='acr'>SVG</span> sizing is annoying <span class='acr'>ATM</span>, so let's actually not do this right now.
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-org-plot" class="outline-5">
<h5 id="org-plot"><span class="section-number-5">5.3.4.6.</span> Org Plot<a aria-hidden="true" href="#org-plot">#</a> </h5>
<div class="outline-text-5" id="text-5-3-4-6">
<p>
We can use some of the variables in <kbd>org-plot</kbd> to use the current doom theme
colours.
</p>
<details id='org-plot,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-plot,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-plot-term-size</span> '(1050 . 650)
  <span class="org-doc">"The size of the GNUPlot terminal, in the form (WIDTH . HEIGHT)."</span>)

(<span class="org-keyword">after!</span> org-plot
  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-plot-generate-theme</span> (_type)
    <span class="org-doc">"Use the current Doom theme colours to generate a GnuPlot preamble."</span>
    (format <span class="org-string">"</span>
<span class="org-string">fgt = \"textcolor rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'\" # foreground text</span>
<span class="org-string">fgat = \"textcolor rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'\" # foreground alt text</span>
<span class="org-string">fgl = \"linecolor rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'\" # foreground line</span>
<span class="org-string">fgal = \"linecolor rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'\" # foreground alt line</span>

<span class="org-string"># foreground colors</span>
<span class="org-string">set border lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'</span>
<span class="org-string"># change text colors of  tics</span>
<span class="org-string">set xtics @fgt</span>
<span class="org-string">set ytics @fgt</span>
<span class="org-string"># change text colors of labels</span>
<span class="org-string">set title @fgt</span>
<span class="org-string">set xlabel @fgt</span>
<span class="org-string">set ylabel @fgt</span>
<span class="org-string"># change a text color of key</span>
<span class="org-string">set key @fgt</span>

<span class="org-string"># line styles</span>
<span class="org-string">set linetype 1 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # red</span>
<span class="org-string">set linetype 2 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # blue</span>
<span class="org-string">set linetype 3 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # green</span>
<span class="org-string">set linetype 4 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # magenta</span>
<span class="org-string">set linetype 5 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # orange</span>
<span class="org-string">set linetype 6 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # yellow</span>
<span class="org-string">set linetype 7 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # teal</span>
<span class="org-string">set linetype 8 lw 2 lc rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' # violet</span>

<span class="org-string"># border styles</span>
<span class="org-string">set tics out nomirror</span>
<span class="org-string">set border 3</span>

<span class="org-string"># palette</span>
<span class="org-string">set palette maxcolors 8</span>
<span class="org-string">set palette defined ( 0 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">',\</span>
<span class="org-string">1 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">',\</span>
<span class="org-string">2 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">',\</span>
<span class="org-string">3 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">',\</span>
<span class="org-string">4 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">',\</span>
<span class="org-string">5 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">',\</span>
<span class="org-string">6 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">',\</span>
<span class="org-string">7 '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' )</span>
<span class="org-string">"</span>
            (doom-color 'fg)
            (doom-color 'fg-alt)
            (doom-color 'fg)
            (doom-color 'fg-alt)
            (doom-color 'fg)
            <span class="org-comment-delimiter">;; </span><span class="org-comment">colours</span>
            (doom-color 'red)
            (doom-color 'blue)
            (doom-color 'green)
            (doom-color 'magenta)
            (doom-color 'orange)
            (doom-color 'yellow)
            (doom-color 'teal)
            (doom-color 'violet)
            <span class="org-comment-delimiter">;; </span><span class="org-comment">duplicated</span>
            (doom-color 'red)
            (doom-color 'blue)
            (doom-color 'green)
            (doom-color 'magenta)
            (doom-color 'orange)
            (doom-color 'yellow)
            (doom-color 'teal)
            (doom-color 'violet)))

  (<span class="org-keyword">defun</span> <span class="org-function-name">+org-plot-gnuplot-term-properties</span> (_type)
    (format <span class="org-string">"background rgb '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' size %s,%s"</span>
            (doom-color 'bg) (car +org-plot-term-size) (cdr +org-plot-term-size)))

  (<span class="org-keyword">setq</span> org-plot/gnuplot-script-preamble #'+org-plot-generate-theme)
  (<span class="org-keyword">setq</span> org-plot/gnuplot-term-extra #'+org-plot-gnuplot-term-properties))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-exporting" class="outline-4">
<h4 id="exporting"><span class="section-number-4">5.3.5.</span> Exporting<a aria-hidden="true" href="#exporting">#</a> </h4>
<div class="outline-text-4" id="text-5-3-5">
</div>
<div id="outline-container-general-settings" class="outline-5">
<h5 id="general-settings"><span class="section-number-5">5.3.5.1.</span> General settings<a aria-hidden="true" href="#general-settings">#</a> </h5>
<div class="outline-text-5" id="text-5-3-5-1">
<p>
By default Org only exports the first three levels of headings as &#x2026; headings.
This is rather unfortunate as my documents frequently stray far beyond three
levels of depth. The two main formats I care about exporting to are LaTeX and
<span class='acr'>HTML</span>. When using an <kbd>article</kbd> class, LaTeX headlines go from <kbd>\section</kbd>,
<kbd>\subsection</kbd>, <kbd>\subsubsection</kbd>, and <kbd>\paragraph</kbd> to <kbd>\subgraph</kbd> &#x2014; <i>five</i> levels.
<span class='acr'>HTML</span>5 has six levels of headings (<kbd>&lt;h1&gt;</kbd> to <kbd>&lt;h6&gt;</kbd>), but first level Org headings
get exported as <kbd>&lt;h2&gt;</kbd> elements &#x2014; leaving <i>five</i> usable levels.
</p>

<p>
As such, it would seem to make sense to recognise the first <i>five</i> levels of Org
headings when exporting.
</p>

<details id='general-settings,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#general-settings,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-export-headline-levels 5) <span class="org-comment-delimiter">; </span><span class="org-comment">I like nesting</span>
</pre>
</div>
</details>

<p>
I'm also going to make use of an item in <kbd>ox-extra</kbd> so that I can add an <kbd>:ignore:</kbd>
tag to headings for the content to be kept, but the heading itself ignored
(unlike <kbd>:noexport:</kbd> which ignored both heading and content). This is useful when
I want to use headings to provide a structure for writing that doesn't appear in
the final documents.
</p>
<details id='general-settings,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#general-settings,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">ox-extra</span>)
(ox-extras-activate '(ignore-headlines))
</pre>
</div>
</details>

<p>
Since I (roughly) track Org <code>HEAD</code>, it makes sense to include the git version in
the creator string.
</p>
<details id='general-settings,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#general-settings,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-export-creator-string
      (format <span class="org-string">"Emacs %s (Org mode %s&#8211;%s)"</span> emacs-version (org-release) (org-git-version)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-acronym-formatting" class="outline-5">
<h5 id="acronym-formatting"><span class="section-number-5">5.3.5.2.</span> Acronym formatting<a aria-hidden="true" href="#acronym-formatting">#</a> </h5>
<div class="outline-text-5" id="text-5-3-5-2">
<p>
I like automatically using spaced small caps for acronyms. For strings I want to
be unaffected let's use <code>;</code> as a prefix to prevent the transformation &#x2014; i.e.
<code>;JFK</code> (as one would want for two-letter geographic locations and names).
</p>

<p>
This has to be implemented on a per-format basis, currently <span class='acr'>HTML</span> and LaTeX
exports are supported.
</p>

<details id='acronym-formatting,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#acronym-formatting,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-export-filter-text-acronym</span> (text backend _info)
  <span class="org-doc">"Wrap suspected acronyms in acronyms-specific formatting.</span>
<span class="org-doc">Treat sequences of 2+ capital letters (optionally succeeded by \"s\") as an acronym.</span>
<span class="org-doc">Ignore if preceeded by \";\" (for manual prevention) or \"\\\" (for LaTeX commands).</span>

<span class="org-doc">TODO abstract backend implementations."</span>
  (<span class="org-keyword">let</span> ((base-backend
         (<span class="org-keyword">cond</span>
          ((org-export-derived-backend-p backend 'latex) 'latex)
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Markdown is derived from HTML, but we don't want to format it</span>
          ((org-export-derived-backend-p backend 'md) nil)
          ((org-export-derived-backend-p backend 'html) 'html)))
        (case-fold-search nil))
    (<span class="org-keyword">when</span> base-backend
      (replace-regexp-in-string
       <span class="org-string">"[;\\\\]?\\b[A-Z][A-Z]+s?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">A-Za-z]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\b</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
       (<span class="org-keyword">lambda</span> (all-caps-str)
         (<span class="org-keyword">cond</span> ((equal (aref all-caps-str 0) ?\\) all-caps-str)                <span class="org-comment-delimiter">; </span><span class="org-comment">don't format LaTeX commands</span>
               ((equal (aref all-caps-str 0) ?\;) (substring all-caps-str 1))  <span class="org-comment-delimiter">; </span><span class="org-comment">just remove not-acronym indicator char ";"</span>
               (t (<span class="org-keyword">let*</span> ((final-char (<span class="org-keyword">if</span> (string-match-p <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">A-Za-z]"</span> (substring all-caps-str -1 (length all-caps-str)))
                                         (substring all-caps-str -1 (length all-caps-str))
                                       nil)) <span class="org-comment-delimiter">; </span><span class="org-comment">needed to re-insert the [</span><span class="org-comment"><span class="org-negation-char">^</span></span><span class="org-comment">A-Za-z] at the end</span>
                         (trailing-s (equal (aref all-caps-str (- (length all-caps-str) (<span class="org-keyword">if</span> final-char 2 1))) ?s))
                         (acr (<span class="org-keyword">if</span> final-char
                                  (substring all-caps-str 0 (<span class="org-keyword">if</span> trailing-s -2 -1))
                                (substring all-caps-str 0 (+ (<span class="org-keyword">if</span> trailing-s -1 (length all-caps-str)))))))
                    (<span class="org-keyword">pcase</span> base-backend
                      ('latex (concat <span class="org-string">"\\acr{"</span> (downcase acr) <span class="org-string">"}"</span> (<span class="org-keyword">when</span> trailing-s <span class="org-string">"\\acrs{}"</span>) final-char))
                      ('html (concat <span class="org-string">"&lt;span class='</span><span class="org-string"><span class="org-constant">acr</span></span><span class="org-string">'&gt;"</span> acr <span class="org-string">"&lt;/span&gt;"</span> (<span class="org-keyword">when</span> trailing-s <span class="org-string">"&lt;small&gt;s&lt;/small&gt;"</span>) final-char)))))))
       text t t))))

(add-to-list 'org-export-filter-plain-text-functions
             #'org-export-filter-text-acronym)

<span class="org-comment-delimiter">;; </span><span class="org-comment">We won't use `</span><span class="org-comment"><span class="org-constant">org-export-filter-headline-functions</span></span><span class="org-comment">' because it</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">passes (and formats) the entire section contents. That's no good.</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">org-html-format-headline-acronymised</span> (todo todo-type priority text tags info)
  <span class="org-doc">"Like `</span><span class="org-doc"><span class="org-constant">org-html-format-headline-default-function</span></span><span class="org-doc">', but with acronym formatting."</span>
  (org-html-format-headline-default-function
   todo todo-type priority (org-export-filter-text-acronym text 'html info) tags info))
(<span class="org-keyword">setq</span> org-html-format-headline-function #'org-html-format-headline-acronymised)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-format-headline-acronymised</span> (todo todo-type priority text tags info)
  <span class="org-doc">"Like `</span><span class="org-doc"><span class="org-constant">org-latex-format-headline-default-function</span></span><span class="org-doc">', but with acronym formatting."</span>
  (org-latex-format-headline-default-function
   todo todo-type priority (org-export-filter-text-acronym text 'latex info) tags info))
(<span class="org-keyword">setq</span> org-latex-format-headline-function #'org-latex-format-headline-acronymised)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-nicer-generated-heading" class="outline-5">
<h5 id="nicer-generated-heading"><span class="section-number-5">5.3.5.3.</span> Nicer generated heading <span class='acr'><span class='acr'>ID</span></span><small>s</small><a aria-hidden="true" href="#nicer-generated-heading">#</a> </h5>
<div class="outline-text-5" id="text-5-3-5-3">
<p>
Thanks to alphapapa's <a href="https://github.com/alphapapa/unpackaged.el#export-to-html-with-useful-anchors">unpackaged.el</a>.
</p>

<p>
By default, Org generated heading <span class='acr'>ID</span><small>s</small> like <kbd>#org80fc2a5</kbd> which &#x2026; works, but has
two issues
</p>
<ul class="org-ul">
<li>It's completely uninformative, I have no idea what's being referenced</li>
<li>If I export the same file, everything will change.
Now, while without hardcoded values it's impossible to set references in
stone, it would be nice for there to be a decent chance of staying the same.</li>
</ul>

<p>
Both of these issues can be addressed by generating <span class='acr'>ID</span><small>s</small> like
<kbd>#language-configuration</kbd>, which is what I'll do here.
</p>

<p>
It's worth noting that alphapapa's use of <code>url-hexify-string</code> seemed to cause me
some issues. Replacing that in <code>a53899</code> resolved this for me. To go one step
further, I create a function for producing nice short links, like an inferior
version of <code>reftex-label</code>.
</p>

<details id='nicer-generated-heading,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#nicer-generated-heading,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-reference-contraction-max-words</span> 3
  <span class="org-doc">"Maximum number of words in a reference reference."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-reference-contraction-max-length</span> 35
  <span class="org-doc">"Maximum length of resulting reference reference, including joining characters."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-reference-contraction-stripped-words</span>
  '(<span class="org-string">"the"</span> <span class="org-string">"on"</span> <span class="org-string">"in"</span> <span class="org-string">"off"</span> <span class="org-string">"a"</span> <span class="org-string">"for"</span> <span class="org-string">"by"</span> <span class="org-string">"of"</span> <span class="org-string">"and"</span> <span class="org-string">"is"</span> <span class="org-string">"to"</span> <span class="org-string">"as"</span>)
  <span class="org-doc">"Superfluous words to be removed from a reference."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-reference-contraction-joining-char</span> <span class="org-string">"-"</span>
  <span class="org-doc">"Character used to join words in the reference reference."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-reference-contraction-truncate-words</span> (words)
  <span class="org-doc">"Using `</span><span class="org-doc"><span class="org-constant">org-reference-contraction-max-length</span></span><span class="org-doc">' as the total character '</span><span class="org-doc"><span class="org-constant">budget</span></span><span class="org-doc">' for the WORDS</span>
<span class="org-doc">and truncate individual words to conform to this budget.</span>

<span class="org-doc">To arrive at a budget that accounts for words undershooting their requisite average length,</span>
<span class="org-doc">the number of characters in the budget freed by short words is distributed among the words</span>
<span class="org-doc">exceeding the average length.  This adjusts the per-word budget to be the maximum feasable for</span>
<span class="org-doc">this particular situation, rather than the universal maximum average.</span>

<span class="org-doc">This budget-adjusted per-word maximum length is given by the mathematical expression below:</span>

<span class="org-doc">max length = \\floor{ \\frac{total length - chars for seperators - \\sum_{word \\leq average length} length(word) }{num(words) &gt; average length} }"</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">trucate each word to a max word length determined by</span>
  <span class="org-comment-delimiter">;;</span>
  (<span class="org-keyword">let*</span> ((total-length-budget (- org-reference-contraction-max-length  <span class="org-comment-delimiter">; </span><span class="org-comment">how many non-separator chars we can use</span>
                                 (1- (length words))))
         (word-length-budget (/ total-length-budget                      <span class="org-comment-delimiter">; </span><span class="org-comment">max length of each word to keep within budget</span>
                                org-reference-contraction-max-words))
         (num-overlong (-count (<span class="org-keyword">lambda</span> (word)                            <span class="org-comment-delimiter">; </span><span class="org-comment">how many words exceed that budget</span>
                                 (&gt; (length word) word-length-budget))
                               words))
         (total-short-length (-sum (mapcar (<span class="org-keyword">lambda</span> (word)                <span class="org-comment-delimiter">; </span><span class="org-comment">total length of words under that budget</span>
                                             (<span class="org-keyword">if</span> (&lt;= (length word) word-length-budget)
                                                 (length word) 0))
                                           words)))
         (max-length (/ (- total-length-budget total-short-length)       <span class="org-comment-delimiter">; </span><span class="org-comment">max(max-length) that we can have to fit within the budget</span>
                        num-overlong)))
    (mapcar (<span class="org-keyword">lambda</span> (word)
              (<span class="org-keyword">if</span> (&lt;= (length word) max-length)
                  word
                (substring word 0 max-length)))
            words)))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-reference-contraction</span> (reference-string)
  <span class="org-doc">"Give a contracted form of REFERENCE-STRING that is only contains alphanumeric characters.</span>
<span class="org-doc">Strips '</span><span class="org-doc"><span class="org-constant">joining</span></span><span class="org-doc">' words present in `</span><span class="org-doc"><span class="org-constant">org-reference-contraction-stripped-words</span></span><span class="org-doc">',</span>
<span class="org-doc">and then limits the result to the first `</span><span class="org-doc"><span class="org-constant">org-reference-contraction-max-words</span></span><span class="org-doc">' words.</span>
<span class="org-doc">If the total length is &gt; `</span><span class="org-doc"><span class="org-constant">org-reference-contraction-max-length</span></span><span class="org-doc">' then individual words are</span>
<span class="org-doc">truncated to fit within the limit using `</span><span class="org-doc"><span class="org-constant">org-reference-contraction-truncate-words</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">let</span> ((reference-words
         (cl-remove-if-not
          (<span class="org-keyword">lambda</span> (word)
            (not (member word org-reference-contraction-stripped-words)))
          (<span class="org-keyword">let</span> ((str reference-string))
            (<span class="org-keyword">setq</span> str (downcase str))
            (<span class="org-keyword">setq</span> str (replace-regexp-in-string <span class="org-string">"\\[\\[[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+\\]\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]\\]"</span> <span class="org-string">"\\1"</span> str)) <span class="org-comment-delimiter">; </span><span class="org-comment">get description from org-link</span>
            (<span class="org-keyword">setq</span> str (replace-regexp-in-string <span class="org-string">"[-/ ]+"</span> <span class="org-string">" "</span> str)) <span class="org-comment-delimiter">; </span><span class="org-comment">replace seperator-type chars with space</span>
            (<span class="org-keyword">setq</span> str (puny-encode-string str))
            (<span class="org-keyword">setq</span> str (replace-regexp-in-string <span class="org-string">"^xn--</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> ?-?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[a-z0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> <span class="org-string">"\\2 \\1"</span> str)) <span class="org-comment-delimiter">; </span><span class="org-comment">rearrange punycode</span>
            (<span class="org-keyword">setq</span> str (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">A-Za-z0-9 ]"</span> <span class="org-string">""</span> str)) <span class="org-comment-delimiter">; </span><span class="org-comment">strip chars which need %-encoding in a uri</span>
            (split-string str <span class="org-string">" +"</span>)))))
    (<span class="org-keyword">when</span> (&gt; (length reference-words)
             org-reference-contraction-max-words)
      (<span class="org-keyword">setq</span> reference-words
            (cl-subseq reference-words 0 org-reference-contraction-max-words)))

    (<span class="org-keyword">when</span> (&gt; (apply #'+ (1- (length reference-words))
                    (mapcar #'length reference-words))
             org-reference-contraction-max-length)
      (<span class="org-keyword">setq</span> reference-words (org-reference-contraction-truncate-words reference-words)))

    (string-join reference-words org-reference-contraction-joining-char)))
</pre>
</div>
</details>

<p>
Now here's alphapapa's subtly tweaked mode.
</p>
<details id='nicer-generated-heading,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#nicer-generated-heading,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">unpackaged/org-export-html-with-useful-ids-mode</span>
  <span class="org-doc">"Attempt to export Org as HTML with useful link IDs.</span>
<span class="org-doc">Instead of random IDs like \"#orga1b2c3\", use heading titles,</span>
<span class="org-doc">made unique when necessary."</span>
  <span class="org-builtin">:global</span> t
  (<span class="org-keyword">if</span> unpackaged/org-export-html-with-useful-ids-mode
      (advice-add #'org-export-get-reference <span class="org-builtin">:override</span> #'unpackaged/org-export-get-reference)
    (advice-remove #'org-export-get-reference #'unpackaged/org-export-get-reference)))
(unpackaged/org-export-html-with-useful-ids-mode 1) <span class="org-comment-delimiter">; </span><span class="org-comment">ensure enabled, and advice run</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">unpackaged/org-export-get-reference</span> (datum info)
  <span class="org-doc">"Like `</span><span class="org-doc"><span class="org-constant">org-export-get-reference</span></span><span class="org-doc">', except uses heading titles instead of random numbers."</span>
  (<span class="org-keyword">let</span> ((cache (plist-get info <span class="org-builtin">:internal-references</span>)))
    (<span class="org-keyword">or</span> (car (rassq datum cache))
        (<span class="org-keyword">let*</span> ((crossrefs (plist-get info <span class="org-builtin">:crossrefs</span>))
               (cells (org-export-search-cells datum))
               <span class="org-comment-delimiter">;; </span><span class="org-comment">Preserve any pre-existing association between</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">a search cell and a reference, i.e., when some</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">previously published document referenced a location</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">within current file (see</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">`</span><span class="org-comment"><span class="org-constant">org-publish-resolve-external-link</span></span><span class="org-comment">').</span>
               <span class="org-comment-delimiter">;;</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">However, there is no guarantee that search cells are</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">unique, e.g., there might be duplicate custom ID or</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">two headings with the same title in the file.</span>
               <span class="org-comment-delimiter">;;</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">As a consequence, before re-using any reference to</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">an element or object, we check that it doesn't refer</span>
               <span class="org-comment-delimiter">;; </span><span class="org-comment">to a previous element or object.</span>
               (new (<span class="org-keyword">or</span> (cl-some
                         (<span class="org-keyword">lambda</span> (cell)
                           (<span class="org-keyword">let</span> ((stored (cdr (assoc cell crossrefs))))
                             (<span class="org-keyword">when</span> stored
                               (<span class="org-keyword">let</span> ((old (org-export-format-reference stored)))
                                 (<span class="org-keyword">and</span> (not (assoc old cache)) stored)))))
                         cells)
                        (<span class="org-keyword">when</span> (org-element-property <span class="org-builtin">:raw-value</span> datum)
                          <span class="org-comment-delimiter">;; </span><span class="org-comment">Heading with a title</span>
                          (unpackaged/org-export-new-named-reference datum cache))
                        (<span class="org-keyword">when</span> (member (car datum) '(src-block table example fixed-width property-drawer))
                          <span class="org-comment-delimiter">;; </span><span class="org-comment">Nameable elements</span>
                          (unpackaged/org-export-new-named-reference datum cache))
                        <span class="org-comment-delimiter">;; </span><span class="org-comment">NOTE: This probably breaks some Org Export</span>
                        <span class="org-comment-delimiter">;; </span><span class="org-comment">feature, but if it does what I need, fine.</span>
                        (org-export-format-reference
                         (org-export-new-reference cache))))
               (reference-string new))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Cache contains both data already associated to</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">a reference and in-use internal references, so as to make</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">unique references.</span>
          (<span class="org-keyword">dolist</span> (cell cells) (<span class="org-keyword">push</span> (cons cell new) cache))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Retain a direct association between reference string and</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">DATUM since (1) not every object or element can be given</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">a search cell (2) it permits quick lookup.</span>
          (<span class="org-keyword">push</span> (cons reference-string datum) cache)
          (plist-put info <span class="org-builtin">:internal-references</span> cache)
          reference-string))))

(<span class="org-keyword">defun</span> <span class="org-function-name">unpackaged/org-export-new-named-reference</span> (datum cache)
  <span class="org-doc">"Return new reference for DATUM that is unique in CACHE."</span>
  (<span class="org-keyword">cl-macrolet</span> ((inc-suffixf (place)
                  `(<span class="org-keyword">progn</span>
                     (string-match (<span class="org-keyword">rx</span> bos
                                       (minimal-match (group (1+ anything)))
                                       (optional <span class="org-string">"--"</span> (group (1+ digit)))
                                       eos)
                                   ,place)
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">HACK: `</span><span class="org-comment"><span class="org-constant">s1</span></span><span class="org-comment">' instead of a gensym.</span>
                     (<span class="org-keyword">let*</span> ((s1 (match-string 1 ,place))
                            (suffix-1 (match-string 2 ,place))
                            (suffix (<span class="org-keyword">if</span> suffix-1 (string-to-number suffix-1) 0)))
                       (<span class="org-keyword">setf</span> ,place (format <span class="org-string">"%s--%s"</span> s1 (1+ suffix)))))))
    (<span class="org-keyword">let*</span> ((headline-p (eq (car datum) 'headline))
           (title (<span class="org-keyword">if</span> headline-p
                      (org-element-property <span class="org-builtin">:raw-value</span> datum)
                    (<span class="org-keyword">or</span> (org-element-property <span class="org-builtin">:name</span> datum)
                        (concat (org-element-property <span class="org-builtin">:raw-value</span>
                                                      (org-element-property <span class="org-builtin">:parent</span>
                                                                            (org-element-property <span class="org-builtin">:parent</span> datum)))))))
           <span class="org-comment-delimiter">;; </span><span class="org-comment">get ascii-only form of title without needing percent-encoding</span>
           (ref (concat (org-reference-contraction (substring-no-properties title))
                        (<span class="org-keyword">unless</span> (<span class="org-keyword">or</span> headline-p (org-element-property <span class="org-builtin">:name</span> datum))
                          (concat <span class="org-string">","</span>
                                  (<span class="org-keyword">pcase</span> (car datum)
                                    ('src-block <span class="org-string">"code"</span>)
                                    ('example <span class="org-string">"example"</span>)
                                    ('fixed-width <span class="org-string">"mono"</span>)
                                    ('property-drawer <span class="org-string">"properties"</span>)
                                    (_ (symbol-name (car datum))))
                                  <span class="org-string">"--1"</span>))))
           (parent (<span class="org-keyword">when</span> headline-p (org-element-property <span class="org-builtin">:parent</span> datum))))
      (<span class="org-keyword">while</span> (member ref (mapcar #'car cache))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Title not unique: make it so.</span>
        (<span class="org-keyword">if</span> parent
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Append ancestor title.</span>
            (<span class="org-keyword">setf</span> title (concat (org-element-property <span class="org-builtin">:raw-value</span> parent)
                                <span class="org-string">"--"</span> title)
                  <span class="org-comment-delimiter">;; </span><span class="org-comment">get ascii-only form of title without needing percent-encoding</span>
                  ref (org-reference-contraction (substring-no-properties title))
                  parent (<span class="org-keyword">when</span> headline-p (org-element-property <span class="org-builtin">:parent</span> parent)))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">No more ancestors: add and increment a number.</span>
          (inc-suffixf ref)))
      ref)))

(add-hook 'org-load-hook #'unpackaged/org-export-html-with-useful-ids-mode)
</pre>
</div>
</details>
<p>
We also need to redefine <code class="src src-elisp">(org-export-format-reference)</code> as it now may
be passed a string as well as a number.
</p>
<details id='nicer-generated-heading,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#nicer-generated-heading,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-export-format-reference-a (reference)
  <span class="org-doc">"Format REFERENCE into a string.</span>

<span class="org-doc">REFERENCE is a either a number or a string representing a reference,</span>
<span class="org-doc">as returned by `</span><span class="org-doc"><span class="org-constant">org-export-new-reference</span></span><span class="org-doc">'."</span>
  <span class="org-builtin">:override</span> #'org-export-format-reference
  (<span class="org-keyword">if</span> (stringp reference) reference (format <span class="org-string">"org%07x"</span> reference)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-strip-zero-width" class="outline-5">
<h5 id="strip-zero-width"><span class="section-number-5">5.3.5.4.</span> Strip zero width spaces<a aria-hidden="true" href="#strip-zero-width">#</a> </h5>
<div class="outline-text-5" id="text-5-3-5-4">
<p>
Zero width spaces are handy as a semantic separator, but not something we want
passed through to the exports.
</p>

<details id='strip-zero-width,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#strip-zero-width,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+org-export-remove-zero-width-space</span> (text _backend _info)
  <span class="org-doc">"Remove zero width spaces from TEXT."</span>
  (<span class="org-keyword">unless</span> (org-export-derived-backend-p 'org)
    (replace-regexp-in-string <span class="org-string">"\u200B"</span> <span class="org-string">""</span> text)))

(add-to-list 'org-export-filter-final-output-functions #'+org-export-remove-zero-width-space t)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-exporting-org-code" class="outline-5">
<h5 id="exporting-org-code"><span class="section-number-5">5.3.5.5.</span> Exporting Org code<a aria-hidden="true" href="#exporting-org-code">#</a> </h5>
<div class="outline-text-5" id="text-5-3-5-5">
<p>
With all our Org config and hooks, exporting an Org code block when using
a font-lock based method can produce undesirable results. To address this, we
can tweak <code>+org-babel-mode-alist</code> when exporting.
</p>

<details id='exporting-org-code,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#exporting-org-code,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+org-mode--fontlock-only-mode</span> ()
  <span class="org-doc">"Just apply org-mode's font-lock once."</span>
  (<span class="org-keyword">let</span> (org-mode-hook
        org-hide-leading-stars
        org-hide-emphasis-markers)
    (org-set-font-lock-defaults)
    (font-lock-ensure))
  (<span class="org-keyword">setq-local</span> major-mode #'fundamental-mode))

(<span class="org-keyword">defun</span> <span class="org-function-name">+org-export-babel-mask-org-config</span> (_backend)
  <span class="org-doc">"Use `</span><span class="org-doc"><span class="org-constant">+org-mode--fontlock-only-mode</span></span><span class="org-doc">' instead of `</span><span class="org-doc"><span class="org-constant">org-mode</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">setq-local</span> org-src-lang-modes
              (append org-src-lang-modes
                      (list (cons <span class="org-string">"org"</span> #'+org-mode--fontlock-only)))))

(add-hook 'org-export-before-processing-hook #'+org-export-babel-mask-org-config)
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-html-export" class="outline-4">
<h4 id="html-export"><span class="section-number-4">5.3.6.</span> <span class='acr'><span class='acr'>HTML</span></span> Export<a aria-hidden="true" href="#html-export">#</a> </h4>
<div class="outline-text-4" id="text-5-3-6">
<p>
I want to tweak a whole bunch of things. While I'll want my tweaks almost all
the time, occasionally I may want to test how something turns out using a more
default config. With that in mind, a global minor mode seems like the most
appropriate architecture to use.
</p>

<details id='html-export,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#html-export,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">org-fancy-html-export-mode</span>
  <span class="org-doc">"Toggle my fabulous org export tweaks. While this mode itself does a little bit,</span>
<span class="org-doc">the vast majority of the change in behaviour comes from switch statements in:</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-html-template-fancier</span></span><span class="org-doc">'</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-html--build-meta-info-extended</span></span><span class="org-doc">'</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-html-src-block-collapsable</span></span><span class="org-doc">'</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-html-block-collapsable</span></span><span class="org-doc">'</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-html-table-wrapped</span></span><span class="org-doc">'</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-html--format-toc-headline-colapseable</span></span><span class="org-doc">'</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-html--toc-text-stripped-leaves</span></span><span class="org-doc">'</span>
<span class="org-doc"> - `</span><span class="org-doc"><span class="org-constant">org-export-html-headline-anchor</span></span><span class="org-doc">'"</span>
  <span class="org-builtin">:global</span> t
  <span class="org-builtin">:init-value</span> t
  (<span class="org-keyword">if</span> org-fancy-html-export-mode
      (<span class="org-keyword">setq</span> org-html-style-default org-html-style-fancy
            org-html-meta-tags #'org-html-meta-tags-fancy
            org-html-checkbox-type 'html-span)
    (<span class="org-keyword">setq</span> org-html-style-default org-html-style-plain
          org-html-meta-tags #'org-html-meta-tags-default
          org-html-checkbox-type 'html)))
</pre>
</div>
</details>
</div>
<div id="outline-container-extra-header-content" class="outline-5">
<h5 id="extra-header-content"><span class="section-number-5">5.3.6.1.</span> Extra header content<a aria-hidden="true" href="#extra-header-content">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-1">
<p>
We want to tack on a few more bits to the start of the body. Unfortunately, there
doesn't seem to be any nice variable or hook, so we'll just override the
relevant function.
</p>

<p>
This is done to allow me to add the date and author to the page header,
implement a <span class='acr'>CSS</span>-only light/dark theme toggle, and a sprinkle of <a href="https://ogp.me/">Open Graph</a>
metadata.
</p>
<details id='extra-header-content,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#extra-header-content,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-html-template-fancier (orig-fn contents info)
  <span class="org-doc">"Return complete document string after HTML conversion.</span>
<span class="org-doc">CONTENTS is the transcoded contents string.  INFO is a plist</span>
<span class="org-doc">holding export options. Adds a few extra things to the body</span>
<span class="org-doc">compared to the default implementation."</span>
  <span class="org-builtin">:around</span> #'org-html-template
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not org-fancy-html-export-mode) (<span class="org-keyword">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn contents info)
    (concat
     (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not (org-html-html5-p info)) (org-html-xhtml-p info))
       (<span class="org-keyword">let*</span> ((xml-declaration (plist-get info <span class="org-builtin">:html-xml-declaration</span>))
              (decl (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> (stringp xml-declaration) xml-declaration)
                        (cdr (assoc (plist-get info <span class="org-builtin">:html-extension</span>)
                                    xml-declaration))
                        (cdr (assoc <span class="org-string">"html"</span> xml-declaration))
                        <span class="org-string">""</span>)))
         (<span class="org-keyword">when</span> (not (<span class="org-keyword">or</span> (not decl) (string= <span class="org-string">""</span> decl)))
           (format <span class="org-string">"%s\n"</span>
                   (format decl
                           (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> org-html-coding-system
                                    (fboundp 'coding-system-get)
                                    (coding-system-get org-html-coding-system 'mime-charset))
                               <span class="org-string">"iso-8859-1"</span>))))))
     (org-html-doctype info)
     <span class="org-string">"\n"</span>
     (concat <span class="org-string">"&lt;html"</span>
             (<span class="org-keyword">cond</span> ((org-html-xhtml-p info)
                    (format
                     <span class="org-string">" xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"%s\" xml:lang=\"%s\""</span>
                     (plist-get info <span class="org-builtin">:language</span>) (plist-get info <span class="org-builtin">:language</span>)))
                   ((org-html-html5-p info)
                    (format <span class="org-string">" lang=\"%s\""</span> (plist-get info <span class="org-builtin">:language</span>))))
             <span class="org-string">"&gt;\n"</span>)
     <span class="org-string">"&lt;head&gt;\n"</span>
     (org-html--build-meta-info info)
     (org-html--build-head info)
     (org-html--build-mathjax-config info)
     <span class="org-string">"&lt;/head&gt;\n"</span>
     <span class="org-string">"&lt;body&gt;\n&lt;input type='</span><span class="org-string"><span class="org-constant">checkbox</span></span><span class="org-string">' id='</span><span class="org-string"><span class="org-constant">theme-switch</span></span><span class="org-string">'&gt;&lt;div id='</span><span class="org-string"><span class="org-constant">page</span></span><span class="org-string">'&gt;&lt;label id='</span><span class="org-string"><span class="org-constant">switch-label</span></span><span class="org-string">' for='</span><span class="org-string"><span class="org-constant">theme-switch</span></span><span class="org-string">'&gt;&lt;/label&gt;"</span>
     (<span class="org-keyword">let</span> ((link-up (org-trim (plist-get info <span class="org-builtin">:html-link-up</span>)))
           (link-home (org-trim (plist-get info <span class="org-builtin">:html-link-home</span>))))
       (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> (string= link-up <span class="org-string">""</span>) (string= link-home <span class="org-string">""</span>))
         (format (plist-get info <span class="org-builtin">:html-home/up-format</span>)
                 (<span class="org-keyword">or</span> link-up link-home)
                 (<span class="org-keyword">or</span> link-home link-up))))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">Preamble.</span>
     (org-html--build-pre/postamble 'preamble info)
     <span class="org-comment-delimiter">;; </span><span class="org-comment">Document contents.</span>
     (<span class="org-keyword">let</span> ((div (assq 'content (plist-get info <span class="org-builtin">:html-divs</span>))))
       (format <span class="org-string">"&lt;%s id=\"%s\"&gt;\n"</span> (nth 1 div) (nth 2 div)))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">Document title.</span>
     (<span class="org-keyword">when</span> (plist-get info <span class="org-builtin">:with-title</span>)
       (<span class="org-keyword">let</span> ((title (<span class="org-keyword">and</span> (plist-get info <span class="org-builtin">:with-title</span>)
                         (plist-get info <span class="org-builtin">:title</span>)))
             (subtitle (plist-get info <span class="org-builtin">:subtitle</span>))
             (html5-fancy (org-html--html5-fancy-p info)))
         (<span class="org-keyword">when</span> title
           (format
            (<span class="org-keyword">if</span> html5-fancy
                <span class="org-string">"&lt;header class=\"page-header\"&gt;%s\n&lt;h1 class=\"title\"&gt;%s&lt;/h1&gt;\n%s&lt;/header&gt;"</span>
              <span class="org-string">"&lt;h1 class=\"title\"&gt;%s%s&lt;/h1&gt;\n"</span>)
            (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (plist-get info <span class="org-builtin">:with-date</span>)
                    (plist-get info <span class="org-builtin">:with-author</span>))
                (concat <span class="org-string">"&lt;div class=\"page-meta\"&gt;"</span>
                        (<span class="org-keyword">when</span> (plist-get info <span class="org-builtin">:with-date</span>)
                          (org-export-data (plist-get info <span class="org-builtin">:date</span>) info))
                        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (plist-get info <span class="org-builtin">:with-date</span>) (plist-get info <span class="org-builtin">:with-author</span>)) <span class="org-string">", "</span>)
                        (<span class="org-keyword">when</span> (plist-get info <span class="org-builtin">:with-author</span>)
                          (org-export-data (plist-get info <span class="org-builtin">:author</span>) info))
                        <span class="org-string">"&lt;/div&gt;\n"</span>)
              <span class="org-string">""</span>)
            (org-export-data title info)
            (<span class="org-keyword">if</span> subtitle
                (format
                 (<span class="org-keyword">if</span> html5-fancy
                     <span class="org-string">"&lt;p class=\"subtitle\" role=\"doc-subtitle\"&gt;%s&lt;/p&gt;\n"</span>
                   (concat <span class="org-string">"\n"</span> (org-html-close-tag <span class="org-string">"br"</span> nil info) <span class="org-string">"\n"</span>
                           <span class="org-string">"&lt;span class=\"subtitle\"&gt;%s&lt;/span&gt;\n"</span>))
                 (org-export-data subtitle info))
              <span class="org-string">""</span>)))))
     contents
     (format <span class="org-string">"&lt;/%s&gt;\n"</span> (nth 1 (assq 'content (plist-get info <span class="org-builtin">:html-divs</span>))))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">Postamble.</span>
     (org-html--build-pre/postamble 'postamble info)
     <span class="org-comment-delimiter">;; </span><span class="org-comment">Possibly use the Klipse library live code blocks.</span>
     (<span class="org-keyword">when</span> (plist-get info <span class="org-builtin">:html-klipsify-src</span>)
       (concat <span class="org-string">"&lt;script&gt;"</span> (plist-get info <span class="org-builtin">:html-klipse-selection-script</span>)
               <span class="org-string">"&lt;/script&gt;&lt;script src=\""</span>
               org-html-klipse-js
               <span class="org-string">"\"&gt;&lt;/script&gt;&lt;link rel=\"stylesheet\" type=\"text/css\" href=\""</span>
               org-html-klipse-css <span class="org-string">"\"/&gt;"</span>))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">Closing document.</span>
     <span class="org-string">"&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;"</span>)))
</pre>
</div>
</details>

<p>
I think it would be nice if "Table of Contents" brought you back to the top of
the page. Well, since we've done this much advising already&#x2026;
</p>
<details id='extra-header-content,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#extra-header-content,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-html-toc-linked (depth info <span class="org-type">&amp;optional</span> scope)
  <span class="org-doc">"Build a table of contents.</span>

<span class="org-doc">Just like `</span><span class="org-doc"><span class="org-constant">org-html-toc</span></span><span class="org-doc">', except the header is a link to \"#\".</span>

<span class="org-doc">DEPTH is an integer specifying the depth of the table.  INFO is</span>
<span class="org-doc">a plist used as a communication channel.  Optional argument SCOPE</span>
<span class="org-doc">is an element defining the scope of the table.  Return the table</span>
<span class="org-doc">of contents as a string, or nil if it is empty."</span>
  <span class="org-builtin">:override</span> #'org-html-toc
  (<span class="org-keyword">let</span> ((toc-entries
         (mapcar (<span class="org-keyword">lambda</span> (headline)
                   (cons (org-html--format-toc-headline headline info)
                         (org-export-get-relative-level headline info)))
                 (org-export-collect-headlines info depth scope))))
    (<span class="org-keyword">when</span> toc-entries
      (<span class="org-keyword">let</span> ((toc (concat <span class="org-string">"&lt;div id=\"text-table-of-contents\"&gt;"</span>
                         (org-html--toc-text toc-entries)
                         <span class="org-string">"&lt;/div&gt;\n"</span>)))
        (<span class="org-keyword">if</span> scope toc
          (<span class="org-keyword">let</span> ((outer-tag (<span class="org-keyword">if</span> (org-html--html5-fancy-p info)
                               <span class="org-string">"nav"</span>
                             <span class="org-string">"div"</span>)))
            (concat (format <span class="org-string">"&lt;%s id=\"table-of-contents\"&gt;\n"</span> outer-tag)
                    (<span class="org-keyword">let</span> ((top-level (plist-get info <span class="org-builtin">:html-toplevel-hlevel</span>)))
                      (format <span class="org-string">"&lt;h%d&gt;&lt;a href=\"#\" style=\"color:inherit; text-decoration: none;\"&gt;%s&lt;/a&gt;&lt;/h%d&gt;\n"</span>
                              top-level
                              (org-html--translate <span class="org-string">"Table of Contents"</span> info)
                              top-level))
                    toc
                    (format <span class="org-string">"&lt;/%s&gt;\n"</span> outer-tag))))))))
</pre>
</div>
</details>

<p>
Lastly, let's pile on some metadata. This gives my pages nice embeds.
</p>
<details id='extra-header-content,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#extra-header-content,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-html-meta-tags-opengraph-image</span>
  '(<span class="org-builtin">:image</span> <span class="org-string">"https://tecosaur.com/resources/org/nib.png"</span>
    <span class="org-builtin">:type</span> <span class="org-string">"image/png"</span>
    <span class="org-builtin">:width</span> <span class="org-string">"200"</span>
    <span class="org-builtin">:height</span> <span class="org-string">"200"</span>
    <span class="org-builtin">:alt</span> <span class="org-string">"Green fountain pen nib"</span>)
  <span class="org-doc">"Plist of og:image:PROP properties and their value, for use in `</span><span class="org-doc"><span class="org-constant">org-html-meta-tags-fancy</span></span><span class="org-doc">'."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-html-meta-tags-fancy</span> (info)
  <span class="org-doc">"Use the INFO plist to construct the meta tags, as described in `</span><span class="org-doc"><span class="org-constant">org-html-meta-tags</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">let*</span> ((title (org-html-plain-text
                 (org-element-interpret-data (plist-get info <span class="org-builtin">:title</span>)) info))
         (author (<span class="org-keyword">and</span> (plist-get info <span class="org-builtin">:with-author</span>)
                      (<span class="org-keyword">let</span> ((auth (plist-get info <span class="org-builtin">:author</span>)))
                        <span class="org-comment-delimiter">;; </span><span class="org-comment">Return raw Org syntax.</span>
                        (<span class="org-keyword">and</span> auth (org-html-plain-text
                                   (org-element-interpret-data auth) info)))))
         (author-first-last
          (<span class="org-keyword">and</span> (not (org-string-nw-p author))
               (<span class="org-keyword">save-match-data</span>
                 (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\`</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span> author)
                     (cons (match-string 1 author)
                           (match-string 2 author))
                   (cons author nil))))))
    (append
     (list
      (<span class="org-keyword">when</span> (org-string-nw-p author)
        (list <span class="org-string">"name"</span> <span class="org-string">"author"</span> author))
      (<span class="org-keyword">when</span> (org-string-nw-p (plist-get info <span class="org-builtin">:description</span>))
        (list <span class="org-string">"name"</span> <span class="org-string">"description"</span>
              (plist-get info <span class="org-builtin">:description</span>)))
      '(<span class="org-string">"name"</span> <span class="org-string">"generator"</span> <span class="org-string">"org mode"</span>)
      '(<span class="org-string">"name"</span> <span class="org-string">"theme-color"</span> <span class="org-string">"#77aa99"</span>)
      '(<span class="org-string">"property"</span> <span class="org-string">"og:type"</span> <span class="org-string">"article"</span>)
      (list <span class="org-string">"property"</span> <span class="org-string">"og:title"</span> title)
      (<span class="org-keyword">let</span> ((subtitle (org-export-data (plist-get info <span class="org-builtin">:subtitle</span>) info)))
        (<span class="org-keyword">when</span> (org-string-nw-p subtitle)
          (list <span class="org-string">"property"</span> <span class="org-string">"og:description"</span> subtitle))))
     (<span class="org-keyword">when</span> org-html-meta-tags-opengraph-image
       (list (list <span class="org-string">"property"</span> <span class="org-string">"og:image"</span> (plist-get org-html-meta-tags-opengraph-image <span class="org-builtin">:image</span>))
             (list <span class="org-string">"property"</span> <span class="org-string">"og:image:type"</span> (plist-get org-html-meta-tags-opengraph-image <span class="org-builtin">:type</span>))
             (list <span class="org-string">"property"</span> <span class="org-string">"og:image:width"</span> (plist-get org-html-meta-tags-opengraph-image <span class="org-builtin">:width</span>))
             (list <span class="org-string">"property"</span> <span class="org-string">"og:image:height"</span> (plist-get org-html-meta-tags-opengraph-image <span class="org-builtin">:height</span>))
             (list <span class="org-string">"property"</span> <span class="org-string">"og:image:alt"</span> (plist-get org-html-meta-tags-opengraph-image <span class="org-builtin">:alt</span>))))
     (list
      (<span class="org-keyword">when</span> (car author-first-last)
        (list <span class="org-string">"property"</span> <span class="org-string">"og:article:author:first_name"</span> (car author-first-last)))
      (<span class="org-keyword">when</span> (cdr author-first-last)
        (list <span class="org-string">"property"</span> <span class="org-string">"og:article:author:last_name"</span> (cdr author-first-last)))
      (list <span class="org-string">"property"</span> <span class="org-string">"og:article:published_time"</span>
            (format-time-string
             <span class="org-string">"%FT%T%z"</span>
             (<span class="org-keyword">or</span>
              (<span class="org-keyword">when-let</span> ((date-str (cadar (org-collect-keywords '(<span class="org-string">"DATE"</span>)))))
                (<span class="org-keyword">unless</span> (string= date-str (format-time-string <span class="org-string">"%F"</span>))
                  (<span class="org-keyword">ignore-errors</span> (encode-time (org-parse-time-string date-str)))))
              (<span class="org-keyword">if</span> buffer-file-name
                  (file-attribute-modification-time (file-attributes buffer-file-name))
                (current-time)))))
      (<span class="org-keyword">when</span> buffer-file-name
        (list <span class="org-string">"property"</span> <span class="org-string">"og:article:modified_time"</span>
              (format-time-string <span class="org-string">"%FT%T%z"</span> (file-attribute-modification-time (file-attributes buffer-file-name)))))))))

(<span class="org-keyword">unless</span> (functionp #'org-html-meta-tags-default)
  (<span class="org-keyword">defalias</span> '<span class="org-function-name">org-html-meta-tags-default</span> #'ignore))
(<span class="org-keyword">setq</span> org-html-meta-tags #'org-html-meta-tags-fancy)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-custom-css-js" class="outline-5">
<h5 id="custom-css-js"><span class="section-number-5">5.3.6.2.</span> Custom <span class='acr'><span class='acr'>CSS</span></span>/<span class='acr'><span class='acr'>JS</span></span><a aria-hidden="true" href="#custom-css-js">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-2">
<p>
The default org <span class='acr'>HTML</span> export is &#x2026; alright, but we can really jazz it up.
<a href="https://lepisma.xyz">lepisma.xyz</a> has a really nice style, and from and org export too!
Suffice to say I've snatched it, with a few of my own tweaks applied.
</p>

<details id='custom-css-js,code--1' class='code' open><summary><span class="lang">HTML</span></summary>
<div class='gutter'>
<a href='#custom-css-js,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-html">&lt;<span class="org-function-name">link</span> <span class="org-variable-name">rel</span>=<span class="org-string">"icon"</span> <span class="org-variable-name">href</span>=<span class="org-string">"https://tecosaur.com/resources/org/nib.ico"</span> <span class="org-variable-name">type</span>=<span class="org-string">"image/ico"</span> /&gt;

&lt;<span class="org-function-name">link</span> <span class="org-variable-name">rel</span>=<span class="org-string">"preload"</span> <span class="org-variable-name">as</span>=<span class="org-string">"font"</span> <span class="org-variable-name">crossorigin</span>=<span class="org-string">"anonymous"</span> <span class="org-variable-name">type</span>=<span class="org-string">"font/woff2"</span> <span class="org-variable-name">href</span>=<span class="org-string">"https://tecosaur.com/resources/org/etbookot-roman-webfont.woff2"</span>&gt;
&lt;<span class="org-function-name">link</span> <span class="org-variable-name">rel</span>=<span class="org-string">"preload"</span> <span class="org-variable-name">as</span>=<span class="org-string">"font"</span> <span class="org-variable-name">crossorigin</span>=<span class="org-string">"anonymous"</span> <span class="org-variable-name">type</span>=<span class="org-string">"font/woff2"</span> <span class="org-variable-name">href</span>=<span class="org-string">"https://tecosaur.com/resources/org/etbookot-italic-webfont.woff2"</span>&gt;
&lt;<span class="org-function-name">link</span> <span class="org-variable-name">rel</span>=<span class="org-string">"preload"</span> <span class="org-variable-name">as</span>=<span class="org-string">"font"</span> <span class="org-variable-name">crossorigin</span>=<span class="org-string">"anonymous"</span> <span class="org-variable-name">type</span>=<span class="org-string">"font/woff2"</span> <span class="org-variable-name">href</span>=<span class="org-string">"https://tecosaur.com/resources/org/Merriweather-TextRegular.woff2"</span>&gt;
&lt;<span class="org-function-name">link</span> <span class="org-variable-name">rel</span>=<span class="org-string">"preload"</span> <span class="org-variable-name">as</span>=<span class="org-string">"font"</span> <span class="org-variable-name">crossorigin</span>=<span class="org-string">"anonymous"</span> <span class="org-variable-name">type</span>=<span class="org-string">"font/woff2"</span> <span class="org-variable-name">href</span>=<span class="org-string">"https://tecosaur.com/resources/org/Merriweather-TextItalic.woff2"</span>&gt;
&lt;<span class="org-function-name">link</span> <span class="org-variable-name">rel</span>=<span class="org-string">"preload"</span> <span class="org-variable-name">as</span>=<span class="org-string">"font"</span> <span class="org-variable-name">crossorigin</span>=<span class="org-string">"anonymous"</span> <span class="org-variable-name">type</span>=<span class="org-string">"font/woff2"</span> <span class="org-variable-name">href</span>=<span class="org-string">"https://tecosaur.com/resources/org/Merriweather-TextBold.woff2"</span>&gt;
</pre>
</div>
</details>

<details id='custom-css-js,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#custom-css-js,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-style-plain org-html-style-default
      org-html-htmlize-output-type 'css
      org-html-doctype <span class="org-string">"html5"</span>
      org-html-html5-fancy t)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-html-reload-fancy-style</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> org-html-style-fancy
        (<span class="org-keyword">with-temp-buffer</span>
          (insert-file-contents (expand-file-name <span class="org-string">"misc/org-export-header.html"</span> doom-user-dir))
          (goto-char (point-max))
          (insert <span class="org-string">"&lt;script&gt;\n"</span>)
          (insert-file-contents (expand-file-name <span class="org-string">"misc/org-css/main.js"</span> doom-user-dir))
          (goto-char (point-max))
          (insert <span class="org-string">"&lt;/script&gt;\n&lt;style&gt;\n"</span>)
          (insert-file-contents (expand-file-name <span class="org-string">"misc/org-css/main.min.css"</span> doom-user-dir))
          (goto-char (point-max))
          (insert <span class="org-string">"&lt;/style&gt;"</span>)
          (buffer-string)))
  (<span class="org-keyword">when</span> org-fancy-html-export-mode
    (<span class="org-keyword">setq</span> org-html-style-default org-html-style-fancy)))
(org-html-reload-fancy-style)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-collapsable-src-example" class="outline-5">
<h5 id="collapsable-src-example"><span class="section-number-5">5.3.6.3.</span> Collapsable src and example blocks<a aria-hidden="true" href="#collapsable-src-example">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-3">
<p>
By wrapping the <code>&lt;pre&gt;</code> element in a <code>&lt;details&gt;</code> block, we can obtain collapsable
blocks with no <span class='acr'>CSS</span>, though we will toss a little in anyway to have this looking
somewhat spiffy.
</p>

<p>
Since this collapsability seems useful to have on by default for certain chunks
of code, it would be nice if you could set it with <kbd>#+attr_html: :collapsed t</kbd>.
</p>

<p>
It would be nice to also have a corresponding global / session-local way of
setting this, but I haven't quite been able to get that working (yet).
</p>

<details id='collapsable-src-example,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#collapsable-src-example,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-html-export-collapsed</span> nil)
(eval '(cl-pushnew '(<span class="org-builtin">:collapsed</span> <span class="org-string">"COLLAPSED"</span> <span class="org-string">"collapsed"</span> org-html-export-collapsed t)
                   (org-export-backend-options (org-export-get-backend 'html))))
(add-to-list 'org-default-properties <span class="org-string">"EXPORT_COLLAPSED"</span>)
</pre>
</div>
</details>

<p>
We can take our src block modification a step further, and add a gutter on the
side of the src block containing both an anchor referencing the current block,
and a button to copy the content of the block.
</p>

<details id='src-blocks' class='code' open><summary class='named'><span class="name">Src blocks</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#src-blocks'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-html-src-block-collapsable (orig-fn src-block contents info)
  <span class="org-doc">"Wrap the usual &lt;pre&gt; block in a &lt;details&gt;"</span>
  <span class="org-builtin">:around</span> #'org-html-src-block
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not org-fancy-html-export-mode) (<span class="org-keyword">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn src-block contents info)
    (<span class="org-keyword">let*</span> ((properties (cadr src-block))
           (lang (mode-name-to-lang-name
                  (plist-get properties <span class="org-builtin">:language</span>)))
           (name (plist-get properties <span class="org-builtin">:name</span>))
           (ref (org-export-get-reference src-block info))
           (collapsed-p (member (<span class="org-keyword">or</span> (org-export-read-attribute <span class="org-builtin">:attr_html</span> src-block <span class="org-builtin">:collapsed</span>)
                                    (plist-get info <span class="org-builtin">:collapsed</span>))
                                '(<span class="org-string">"y"</span> <span class="org-string">"yes"</span> <span class="org-string">"t"</span> t <span class="org-string">"true"</span> <span class="org-string">"all"</span>))))
      (format
       <span class="org-string">"&lt;details id='</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' class='</span><span class="org-string"><span class="org-constant">code</span></span><span class="org-string">'%s&gt;&lt;summary%s&gt;%s&lt;/summary&gt;</span>
<span class="org-string">&lt;div class='</span><span class="org-string"><span class="org-constant">gutter</span></span><span class="org-string">'&gt;</span>
<span class="org-string">&lt;a href='#%s'&gt;#&lt;/a&gt;</span>
<span class="org-string">&lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;&#9112;&lt;/button&gt;\</span>
<span class="org-string">&lt;/div&gt;</span>
<span class="org-string">%s</span>
<span class="org-string">&lt;/details&gt;"</span>
       ref
       (<span class="org-keyword">if</span> collapsed-p <span class="org-string">""</span> <span class="org-string">" open"</span>)
       (<span class="org-keyword">if</span> name <span class="org-string">" class='</span><span class="org-string"><span class="org-constant">named</span></span><span class="org-string">'"</span> <span class="org-string">""</span>)
       (concat
        (<span class="org-keyword">when</span> name (concat <span class="org-string">"&lt;span class=\"name\"&gt;"</span> name <span class="org-string">"&lt;/span&gt;"</span>))
        <span class="org-string">"&lt;span class=\"lang\"&gt;"</span> lang <span class="org-string">"&lt;/span&gt;"</span>)
       ref
       (<span class="org-keyword">if</span> name
           (replace-regexp-in-string (format <span class="org-string">"&lt;pre</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> class=\"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">? id=\"%s\"&gt;"</span> ref) <span class="org-string">"&lt;pre\\1&gt;"</span>
                                     (funcall orig-fn src-block contents info))
         (funcall orig-fn src-block contents info))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">mode-name-to-lang-name</span> (mode)
  (<span class="org-keyword">or</span> (cadr (assoc mode
                   '((<span class="org-string">"asymptote"</span> <span class="org-string">"Asymptote"</span>)
                     (<span class="org-string">"awk"</span> <span class="org-string">"Awk"</span>)
                     (<span class="org-string">"C"</span> <span class="org-string">"C"</span>)
                     (<span class="org-string">"clojure"</span> <span class="org-string">"Clojure"</span>)
                     (<span class="org-string">"css"</span> <span class="org-string">"CSS"</span>)
                     (<span class="org-string">"D"</span> <span class="org-string">"D"</span>)
                     (<span class="org-string">"ditaa"</span> <span class="org-string">"ditaa"</span>)
                     (<span class="org-string">"dot"</span> <span class="org-string">"Graphviz"</span>)
                     (<span class="org-string">"calc"</span> <span class="org-string">"Emacs Calc"</span>)
                     (<span class="org-string">"emacs-lisp"</span> <span class="org-string">"Emacs Lisp"</span>)
                     (<span class="org-string">"fortran"</span> <span class="org-string">"Fortran"</span>)
                     (<span class="org-string">"gnuplot"</span> <span class="org-string">"gnuplot"</span>)
                     (<span class="org-string">"haskell"</span> <span class="org-string">"Haskell"</span>)
                     (<span class="org-string">"hledger"</span> <span class="org-string">"hledger"</span>)
                     (<span class="org-string">"java"</span> <span class="org-string">"Java"</span>)
                     (<span class="org-string">"js"</span> <span class="org-string">"Javascript"</span>)
                     (<span class="org-string">"latex"</span> <span class="org-string">"LaTeX"</span>)
                     (<span class="org-string">"ledger"</span> <span class="org-string">"Ledger"</span>)
                     (<span class="org-string">"lisp"</span> <span class="org-string">"Lisp"</span>)
                     (<span class="org-string">"lilypond"</span> <span class="org-string">"Lilypond"</span>)
                     (<span class="org-string">"lua"</span> <span class="org-string">"Lua"</span>)
                     (<span class="org-string">"matlab"</span> <span class="org-string">"MATLAB"</span>)
                     (<span class="org-string">"mscgen"</span> <span class="org-string">"Mscgen"</span>)
                     (<span class="org-string">"ocaml"</span> <span class="org-string">"Objective Caml"</span>)
                     (<span class="org-string">"octave"</span> <span class="org-string">"Octave"</span>)
                     (<span class="org-string">"org"</span> <span class="org-string">"Org mode"</span>)
                     (<span class="org-string">"oz"</span> <span class="org-string">"OZ"</span>)
                     (<span class="org-string">"plantuml"</span> <span class="org-string">"Plantuml"</span>)
                     (<span class="org-string">"processing"</span> <span class="org-string">"Processing.js"</span>)
                     (<span class="org-string">"python"</span> <span class="org-string">"Python"</span>)
                     (<span class="org-string">"R"</span> <span class="org-string">"R"</span>)
                     (<span class="org-string">"ruby"</span> <span class="org-string">"Ruby"</span>)
                     (<span class="org-string">"sass"</span> <span class="org-string">"Sass"</span>)
                     (<span class="org-string">"scheme"</span> <span class="org-string">"Scheme"</span>)
                     (<span class="org-string">"screen"</span> <span class="org-string">"Gnu Screen"</span>)
                     (<span class="org-string">"sed"</span> <span class="org-string">"Sed"</span>)
                     (<span class="org-string">"sh"</span> <span class="org-string">"shell"</span>)
                     (<span class="org-string">"sql"</span> <span class="org-string">"SQL"</span>)
                     (<span class="org-string">"sqlite"</span> <span class="org-string">"SQLite"</span>)
                     (<span class="org-string">"forth"</span> <span class="org-string">"Forth"</span>)
                     (<span class="org-string">"io"</span> <span class="org-string">"IO"</span>)
                     (<span class="org-string">"J"</span> <span class="org-string">"J"</span>)
                     (<span class="org-string">"makefile"</span> <span class="org-string">"Makefile"</span>)
                     (<span class="org-string">"maxima"</span> <span class="org-string">"Maxima"</span>)
                     (<span class="org-string">"perl"</span> <span class="org-string">"Perl"</span>)
                     (<span class="org-string">"picolisp"</span> <span class="org-string">"Pico Lisp"</span>)
                     (<span class="org-string">"scala"</span> <span class="org-string">"Scala"</span>)
                     (<span class="org-string">"shell"</span> <span class="org-string">"Shell Script"</span>)
                     (<span class="org-string">"ebnf2ps"</span> <span class="org-string">"ebfn2ps"</span>)
                     (<span class="org-string">"cpp"</span> <span class="org-string">"C++"</span>)
                     (<span class="org-string">"abc"</span> <span class="org-string">"ABC"</span>)
                     (<span class="org-string">"coq"</span> <span class="org-string">"Coq"</span>)
                     (<span class="org-string">"groovy"</span> <span class="org-string">"Groovy"</span>)
                     (<span class="org-string">"bash"</span> <span class="org-string">"bash"</span>)
                     (<span class="org-string">"csh"</span> <span class="org-string">"csh"</span>)
                     (<span class="org-string">"ash"</span> <span class="org-string">"ash"</span>)
                     (<span class="org-string">"dash"</span> <span class="org-string">"dash"</span>)
                     (<span class="org-string">"ksh"</span> <span class="org-string">"ksh"</span>)
                     (<span class="org-string">"mksh"</span> <span class="org-string">"mksh"</span>)
                     (<span class="org-string">"posh"</span> <span class="org-string">"posh"</span>)
                     (<span class="org-string">"ada"</span> <span class="org-string">"Ada"</span>)
                     (<span class="org-string">"asm"</span> <span class="org-string">"Assembler"</span>)
                     (<span class="org-string">"caml"</span> <span class="org-string">"Caml"</span>)
                     (<span class="org-string">"delphi"</span> <span class="org-string">"Delphi"</span>)
                     (<span class="org-string">"html"</span> <span class="org-string">"HTML"</span>)
                     (<span class="org-string">"idl"</span> <span class="org-string">"IDL"</span>)
                     (<span class="org-string">"mercury"</span> <span class="org-string">"Mercury"</span>)
                     (<span class="org-string">"metapost"</span> <span class="org-string">"MetaPost"</span>)
                     (<span class="org-string">"modula-2"</span> <span class="org-string">"Modula-2"</span>)
                     (<span class="org-string">"pascal"</span> <span class="org-string">"Pascal"</span>)
                     (<span class="org-string">"ps"</span> <span class="org-string">"PostScript"</span>)
                     (<span class="org-string">"prolog"</span> <span class="org-string">"Prolog"</span>)
                     (<span class="org-string">"simula"</span> <span class="org-string">"Simula"</span>)
                     (<span class="org-string">"tcl"</span> <span class="org-string">"tcl"</span>)
                     (<span class="org-string">"tex"</span> <span class="org-string">"LaTeX"</span>)
                     (<span class="org-string">"plain-tex"</span> <span class="org-string">"TeX"</span>)
                     (<span class="org-string">"verilog"</span> <span class="org-string">"Verilog"</span>)
                     (<span class="org-string">"vhdl"</span> <span class="org-string">"VHDL"</span>)
                     (<span class="org-string">"xml"</span> <span class="org-string">"XML"</span>)
                     (<span class="org-string">"nxml"</span> <span class="org-string">"XML"</span>)
                     (<span class="org-string">"conf"</span> <span class="org-string">"Configuration File"</span>))))
      mode))
</pre>
</div>
</details>

<details id='example-fixed-width' class='code' open><summary class='named'><span class="name">Example, fixed width, and property blocks</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#example-fixed-width'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-html-block-collapsable</span> (orig-fn block contents info)
  <span class="org-doc">"Wrap the usual block in a &lt;details&gt;"</span>
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not org-fancy-html-export-mode) (<span class="org-keyword">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn block contents info)
    (<span class="org-keyword">let</span> ((ref (org-export-get-reference block info))
          (type (<span class="org-keyword">pcase</span> (car block)
                  ('property-drawer <span class="org-string">"Properties"</span>)))
          (collapsed-default (<span class="org-keyword">pcase</span> (car block)
                               ('property-drawer t)
                               (_ nil)))
          (collapsed-value (org-export-read-attribute <span class="org-builtin">:attr_html</span> block <span class="org-builtin">:collapsed</span>))
          (collapsed-p (<span class="org-keyword">or</span> (member (org-export-read-attribute <span class="org-builtin">:attr_html</span> block <span class="org-builtin">:collapsed</span>)
                                   '(<span class="org-string">"y"</span> <span class="org-string">"yes"</span> <span class="org-string">"t"</span> t <span class="org-string">"true"</span>))
                           (member (plist-get info <span class="org-builtin">:collapsed</span>) '(<span class="org-string">"all"</span>)))))
      (format
       <span class="org-string">"&lt;details id='</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' class='</span><span class="org-string"><span class="org-constant">code</span></span><span class="org-string">'%s&gt;</span>
<span class="org-string">&lt;summary%s&gt;%s&lt;/summary&gt;</span>
<span class="org-string">&lt;div class='</span><span class="org-string"><span class="org-constant">gutter</span></span><span class="org-string">'&gt;\</span>
<span class="org-string">&lt;a href='#%s'&gt;#&lt;/a&gt;</span>
<span class="org-string">&lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;&#9112;&lt;/button&gt;\</span>
<span class="org-string">&lt;/div&gt;</span>
<span class="org-string">%s\n</span>
<span class="org-string">&lt;/details&gt;"</span>
       ref
       (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> collapsed-p collapsed-default) <span class="org-string">""</span> <span class="org-string">" open"</span>)
       (<span class="org-keyword">if</span> type <span class="org-string">" class='</span><span class="org-string"><span class="org-constant">named</span></span><span class="org-string">'"</span> <span class="org-string">""</span>)
       (<span class="org-keyword">if</span> type (format <span class="org-string">"&lt;span class='</span><span class="org-string"><span class="org-constant">type</span></span><span class="org-string">'&gt;%s&lt;/span&gt;"</span> type) <span class="org-string">""</span>)
       ref
       (funcall orig-fn block contents info)))))

(advice-add 'org-html-example-block   <span class="org-builtin">:around</span> #'org-html-block-collapsable)
(advice-add 'org-html-fixed-width     <span class="org-builtin">:around</span> #'org-html-block-collapsable)
(advice-add 'org-html-property-drawer <span class="org-builtin">:around</span> #'org-html-block-collapsable)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-include-extra-font" class="outline-5">
<h5 id="include-extra-font"><span class="section-number-5">5.3.6.4.</span> Include extra font-locking in htmlize<a aria-hidden="true" href="#include-extra-font">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-4">
<p>
Org uses <a href="https://github.com/hniksic/emacs-htmlize">htmlize.el</a> to export buffers with syntax highlighting.
</p>

<p>
The works fantastically, for the most part. Minor modes that provide
font-locking are <i>not</i> loaded, and so do not impact the result.
</p>

<p>
By enabling these modes in <code>htmlize-before-hook</code> we can correct this behaviour.
</p>

<details id='include-extra-font,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#include-extra-font,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(autoload #'highlight-numbers--turn-on <span class="org-string">"highlight-numbers"</span>)
(add-hook 'htmlize-before-hook #'highlight-numbers--turn-on)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-handle-table-overflow" class="outline-5">
<h5 id="handle-table-overflow"><span class="section-number-5">5.3.6.5.</span> Handle table overflow<a aria-hidden="true" href="#handle-table-overflow">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-5">
<p>
In order to accommodate wide tables &#x2014;particularly on mobile devices&#x2014; we want
to set a maximum width and scroll overflow. Unfortunately, this cannot be applied
directly to the <code>table</code> element, so we have to wrap it in a <code>div</code>.
</p>

<p>
While we're at it, we can a link gutter, as we did with src blocks, and show the
<code>#+name</code>, if one is given.
</p>

<details id='handle-table-overflow,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#handle-table-overflow,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-html-table-wrapped (orig-fn table contents info)
  <span class="org-doc">"Wrap the usual &lt;table&gt; in a &lt;div&gt;"</span>
  <span class="org-builtin">:around</span> #'org-html-table
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not org-fancy-html-export-mode) (<span class="org-keyword">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn table contents info)
    (<span class="org-keyword">let*</span> ((name (plist-get (cadr table) <span class="org-builtin">:name</span>))
           (ref (org-export-get-reference table info)))
      (format <span class="org-string">"&lt;div id='</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' class='</span><span class="org-string"><span class="org-constant">table</span></span><span class="org-string">'&gt;</span>
<span class="org-string">&lt;div class='</span><span class="org-string"><span class="org-constant">gutter</span></span><span class="org-string">'&gt;&lt;a href='#%s'&gt;#&lt;/a&gt;&lt;/div&gt;</span>
<span class="org-string">&lt;div class='</span><span class="org-string"><span class="org-constant">tabular</span></span><span class="org-string">'&gt;</span>
<span class="org-string">%s</span>
<span class="org-string">&lt;/div&gt;\</span>
<span class="org-string">&lt;/div&gt;"</span>
              ref ref
              (<span class="org-keyword">if</span> name
                  (replace-regexp-in-string (format <span class="org-string">"&lt;table id=\"%s\""</span> ref) <span class="org-string">"&lt;table"</span>
                                            (funcall orig-fn table contents info))
                (funcall orig-fn table contents info))))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-toc-collapsable-tree" class="outline-5">
<h5 id="toc-collapsable-tree"><span class="section-number-5">5.3.6.6.</span> <span class='acr'><span class='acr'>TOC</span></span> as a collapsable tree<a aria-hidden="true" href="#toc-collapsable-tree">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-6">
<p>
The <span class='acr'>TOC</span> is much nicer to navigate as a collapsable tree. Unfortunately we cannot
achieve this with <span class='acr'>CSS</span> alone. Thankfully we can avoid <span class='acr'>JS</span> though, by adapting the
<span class='acr'>TOC</span> generation code to use a <code>label</code> for each item, and a hidden <code>checkbox</code> to keep
track of state.
</p>

<p>
To add this, we need to change one line in .
</p>

<p>
Since we can actually accomplish the desired effect by adding advice <i>around</i> the
function, without overriding it &#x2014; let's do that to reduce the bug surface of
this config a tad.
</p>
<details id='toc-collapsable-tree,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#toc-collapsable-tree,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-html--format-toc-headline-colapseable (orig-fn headline info)
  <span class="org-doc">"Add a label and checkbox to `</span><span class="org-doc"><span class="org-constant">org-html--format-toc-headline</span></span><span class="org-doc">'s usual output,</span>
<span class="org-doc">to allow the TOC to be a collapseable tree."</span>
  <span class="org-builtin">:around</span> #'org-html--format-toc-headline
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not org-fancy-html-export-mode) (<span class="org-keyword">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn headline info)
    (<span class="org-keyword">let</span> ((id (<span class="org-keyword">or</span> (org-element-property <span class="org-builtin">:CUSTOM_ID</span> headline)
                  (org-export-get-reference headline info))))
      (format <span class="org-string">"&lt;input type='</span><span class="org-string"><span class="org-constant">checkbox</span></span><span class="org-string">' id='</span><span class="org-string"><span class="org-constant">toc--%s</span></span><span class="org-string">'/&gt;&lt;label for='</span><span class="org-string"><span class="org-constant">toc--%s</span></span><span class="org-string">'&gt;%s&lt;/label&gt;"</span>
              id id (funcall orig-fn headline info)))))
</pre>
</div>
</details>

<p>
Now, leaves (headings with no children) shouldn't have the <code>label</code> item. The
obvious way to achieve this is by including some <i>if no children&#x2026;</i> logic in
<code>org-html--format-toc-headline-colapseable</code>. Unfortunately, I can't my elisp isn't
up to par to extract the number of child headings from the mountain of info that
org provides.
</p>
<details id='toc-collapsable-tree,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#toc-collapsable-tree,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-html--toc-text-stripped-leaves (orig-fn toc-entries)
  <span class="org-doc">"Remove label"</span>
  <span class="org-builtin">:around</span> #'org-html--toc-text
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not org-fancy-html-export-mode) (<span class="org-keyword">bound-and-true-p</span> org-msg-export-in-progress))
      (funcall orig-fn toc-entries)
    (replace-regexp-in-string <span class="org-string">"&lt;input [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;&lt;label [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/label&gt;&lt;/li&gt;"</span> <span class="org-string">"\\1&lt;/li&gt;"</span>
                              (funcall orig-fn toc-entries))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-make-verbatim-different" class="outline-5">
<h5 id="make-verbatim-different"><span class="section-number-5">5.3.6.7.</span> Make verbatim different to code<a aria-hidden="true" href="#make-verbatim-different">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-7">
<p>
Since we have <kbd>verbatim</kbd> and <code>code</code>, let's make use of the difference.
</p>

<p>
We can use <code>code</code> exclusively for code snippets and commands like: "calling
<code class="src src-elisp">(message <span class="org-string">"Hello"</span>)</code> in batch-mode Emacs prints to stdout like <code>echo</code>".
Then we can use <kbd>verbatim</kbd> for miscellaneous 'other monospace' like keyboard
shortcuts: "either <kbd>C-c C-c</kbd> or <kbd>C-g</kbd> is likely the most useful keybinding in Emacs",
or file names: "I keep my configuration in <kbd>~/.config/doom/</kbd>", among other things.
</p>

<p>
Then, styling these two cases differently can help improve clarity in a document.
</p>

<details id='make-verbatim-different,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#make-verbatim-different,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-text-markup-alist
      '((bold . <span class="org-string">"&lt;b&gt;%s&lt;/b&gt;"</span>)
        (code . <span class="org-string">"&lt;code&gt;%s&lt;/code&gt;"</span>)
        (italic . <span class="org-string">"&lt;i&gt;%s&lt;/i&gt;"</span>)
        (strike-through . <span class="org-string">"&lt;del&gt;%s&lt;/del&gt;"</span>)
        (underline . <span class="org-string">"&lt;span class=\"underline\"&gt;%s&lt;/span&gt;"</span>)
        (verbatim . <span class="org-string">"&lt;kbd&gt;%s&lt;/kbd&gt;"</span>)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-change-checkbox-type" class="outline-5">
<h5 id="change-checkbox-type"><span class="section-number-5">5.3.6.8.</span> Change checkbox type<a aria-hidden="true" href="#change-checkbox-type">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-8">
<p>
We also want to use <span class='acr'>HTML</span> checkboxes, however we want to get a bit fancier than default
</p>
<details id='change-checkbox-type,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#change-checkbox-type,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">appendq!</span> org-html-checkbox-types
          '((html-span
             (on . <span class="org-string">"&lt;span class='</span><span class="org-string"><span class="org-constant">checkbox</span></span><span class="org-string">'&gt;&lt;/span&gt;"</span>)
             (off . <span class="org-string">"&lt;span class='</span><span class="org-string"><span class="org-constant">checkbox</span></span><span class="org-string">'&gt;&lt;/span&gt;"</span>)
             (trans . <span class="org-string">"&lt;span class='</span><span class="org-string"><span class="org-constant">checkbox</span></span><span class="org-string">'&gt;&lt;/span&gt;"</span>))))
(<span class="org-keyword">setq</span> org-html-checkbox-type 'html-span)
</pre>
</div>
</details>
<ul class="org-ul">
<li class="off"><span class='checkbox'></span> I'm yet to do this</li>
<li class="trans"><span class='checkbox'></span> Work in progress</li>
<li class="on"><span class='checkbox'></span> This is done</li>
</ul>
</div>
</div>
<div id="outline-container-extra-special-strings" class="outline-5">
<h5 id="extra-special-strings"><span class="section-number-5">5.3.6.9.</span> Extra special strings<a aria-hidden="true" href="#extra-special-strings">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-9">
<p>
The <code>org-html-special-string-regexps</code> variable defines substitutions for:
</p>
<ul class="org-ul">
<li><kbd>\-</kbd>, a shy hyphen</li>
<li><kbd>---</kbd>, an em dash</li>
<li><kbd>--</kbd>, an en dash</li>
<li><kbd>...</kbd>, (horizontal) ellipses</li>
</ul>

<p>
However I think it would be nice if there was also a substitution for left/right
arrows (<kbd>-&gt;</kbd> and <kbd>&lt;-</kbd>). This is a <code>defconst</code>, but as you may tell from the amount of
advice in this config, I'm not above messing with things I'm not 'supposed' to.
</p>

<p>
The only minor complication is that <kbd>&lt;</kbd> and <kbd>&gt;</kbd> are converted to <kbd>&amp;lt;</kbd> and <kbd>&amp;gt;</kbd>
before this stage of output processing.
</p>

<details id='extra-special-strings,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#extra-special-strings,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">pushnew!</span> org-html-special-string-regexps
          '(<span class="org-string">"-&amp;gt;"</span> . <span class="org-string">"&amp;#8594;"</span>)
          '(<span class="org-string">"&amp;lt;-"</span> . <span class="org-string">"&amp;#8592;"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-header-anchors" class="outline-5">
<h5 id="header-anchors"><span class="section-number-5">5.3.6.10.</span> Header anchors<a aria-hidden="true" href="#header-anchors">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-10">
<p>
I want to add GitHub-style links on hover for headings.
</p>
<details id='header-anchors,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#header-anchors,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-export-html-headline-anchor</span> (text backend info)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (org-export-derived-backend-p backend 'html)
             (not (org-export-derived-backend-p backend 're-reveal))
             org-fancy-html-export-mode)
    (<span class="org-keyword">unless</span> (<span class="org-keyword">bound-and-true-p</span> org-msg-export-in-progress)
      (replace-regexp-in-string
       <span class="org-string">"&lt;h</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> id=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[a-z0-9-]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\"&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;\\/h[0-9]&gt;"</span> <span class="org-comment-delimiter">; </span><span class="org-comment">this is quite restrictive, but due to `</span><span class="org-comment"><span class="org-constant">org-reference-contraction</span></span><span class="org-comment">' I can do this</span>
       <span class="org-string">"&lt;h\\1 id=\"\\2\"&gt;\\3&lt;a aria-hidden=\"true\" href=\"#\\2\"&gt;#&lt;/a&gt; &lt;/h\\1&gt;"</span>
       text))))

(add-to-list 'org-export-filter-headline-functions
             'org-export-html-headline-anchor)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-link-previews" class="outline-5">
<h5 id="link-previews"><span class="section-number-5">5.3.6.11.</span> Link previews<a aria-hidden="true" href="#link-previews">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-11">
<p>
Sometimes it's nice to make a link particularly prominent, an embed/preview like
Twitter does would be nice I think.
</p>

<p>
We can do this without too much trouble by adding a new link type ever so
slightly different from <kbd>https</kbd> &#x2014; <kbd>Https</kbd>.
</p>

<details id='link-previews,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#link-previews,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters <span class="org-string">"Https"</span>
                         <span class="org-builtin">:follow</span> (<span class="org-keyword">lambda</span> (url arg) (browse-url (concat <span class="org-string">"https:"</span> url) arg))
                         <span class="org-builtin">:export</span> #'org-url-fancy-export)
</pre>
</div>
</details>

<p>
Then, if we can fetch a plist of the form <code class="src src-elisp">(<span class="org-builtin">:title</span> <span class="org-string">"..."</span> <span class="org-builtin">:description</span> <span class="org-string">"..."</span> <span class="org-builtin">:image</span> <span class="org-string">"..."</span>)</code> for such links via a function <code>org-url-unfurl-metadata</code>, we
can make a fancy export.
</p>

<details id='link-previews,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#link-previews,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-url-fancy-export</span> (url _desc backend)
  (<span class="org-keyword">let</span> ((metadata (org-url-unfurl-metadata (concat <span class="org-string">"https:"</span> url))))
    (<span class="org-keyword">cond</span>
     ((org-export-derived-backend-p backend 'html)
      (concat
       <span class="org-string">"&lt;div class=\"link-preview\"&gt;"</span>
       (format <span class="org-string">"&lt;a href=\"%s\"&gt;"</span> (concat <span class="org-string">"https:"</span> url))
       (<span class="org-keyword">when</span> (plist-get metadata <span class="org-builtin">:image</span>)
         (format <span class="org-string">"&lt;img src=\"%s\"/&gt;"</span> (plist-get metadata <span class="org-builtin">:image</span>)))
       <span class="org-string">"&lt;small&gt;"</span>
       (replace-regexp-in-string <span class="org-string">"//</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">www\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/?.*"</span> <span class="org-string">"\\1"</span> url)
       <span class="org-string">"&lt;/small&gt;&lt;p&gt;"</span>
       (<span class="org-keyword">when</span> (plist-get metadata <span class="org-builtin">:title</span>)
         (concat <span class="org-string">"&lt;b&gt;"</span> (org-html-encode-plain-text (plist-get metadata <span class="org-builtin">:title</span>)) <span class="org-string">"&lt;/b&gt;&lt;/br&gt;"</span>))
       (<span class="org-keyword">when</span> (plist-get metadata <span class="org-builtin">:description</span>)
         (org-html-encode-plain-text (plist-get metadata <span class="org-builtin">:description</span>)))
       <span class="org-string">"&lt;/p&gt;&lt;/a&gt;&lt;/div&gt;"</span>))
     (t url))))
</pre>
</div>
</details>

<p>
Now we just need to actually implement that metadata extraction function.
</p>
<details id='link-previews,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#link-previews,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-url-unfurl-metadata--cache nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">org-url-unfurl-metadata</span> (url)
  (cdr (<span class="org-keyword">or</span> (assoc url org-url-unfurl-metadata--cache)
           (car (<span class="org-keyword">push</span>
                 (cons
                  url
                  (<span class="org-keyword">let*</span> ((head-data
                          (cl-remove-if-not
                           #'listp
                           (cdaddr
                            (<span class="org-keyword">with-current-buffer</span>
                                (<span class="org-keyword">progn</span> (message <span class="org-string">"Fetching metadata from %s"</span> url)
                                       (<span class="org-keyword">if</span> (executable-find <span class="org-string">"curl"</span>)
                                           (<span class="org-keyword">with-current-buffer</span> (generate-new-buffer <span class="org-string">" *curl*"</span>)
                                             (call-process <span class="org-string">"curl"</span> nil t nil <span class="org-string">"--max-time"</span> <span class="org-string">"5"</span> <span class="org-string">"-sSL"</span> url)
                                             (current-buffer))
                                         (url-retrieve-synchronously url t t 5)))
                              (goto-char (point-min))
                              (delete-region (point-min) (- (search-forward <span class="org-string">"&lt;head"</span>) 6))
                              (delete-region (search-forward <span class="org-string">"&lt;/head&gt;"</span>) (point-max))
                              (goto-char (point-min))
                              (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;script[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\u2800]+?&lt;/script&gt;"</span> nil t)
                                (replace-match <span class="org-string">""</span>))
                              (goto-char (point-min))
                              (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;style[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\u2800]+?&lt;/style&gt;"</span> nil t)
                                (replace-match <span class="org-string">""</span>))
                              (libxml-parse-html-region (point-min) (point-max))))))
                         (meta (delq nil
                                     (mapcar
                                      (<span class="org-keyword">lambda</span> (tag)
                                        (<span class="org-keyword">when</span> (eq 'meta (car tag))
                                          (cons (<span class="org-keyword">or</span> (cdr (assoc 'name (cadr tag)))
                                                    (cdr (assoc 'property (cadr tag))))
                                                (cdr (assoc 'content (cadr tag))))))
                                      head-data))))
                    (<span class="org-keyword">let</span> ((title (<span class="org-keyword">or</span> (cdr (assoc <span class="org-string">"og:title"</span> meta))
                                     (cdr (assoc <span class="org-string">"twitter:title"</span> meta))
                                     (nth 2 (assq 'title head-data))))
                          (description (<span class="org-keyword">or</span> (cdr (assoc <span class="org-string">"og:description"</span> meta))
                                           (cdr (assoc <span class="org-string">"twitter:description"</span> meta))
                                           (cdr (assoc <span class="org-string">"description"</span> meta))))
                          (image (<span class="org-keyword">or</span> (cdr (assoc <span class="org-string">"og:image"</span> meta))
                                     (cdr (assoc <span class="org-string">"twitter:image"</span> meta)))))
                      (<span class="org-keyword">when</span> image
                        (<span class="org-keyword">setq</span> image (replace-regexp-in-string
                                     <span class="org-string">"^/"</span> (concat <span class="org-string">"https://"</span> (replace-regexp-in-string <span class="org-string">"//</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/?.*"</span> <span class="org-string">"\\1"</span> url) <span class="org-string">"/"</span>)
                                     (replace-regexp-in-string
                                      <span class="org-string">"^//"</span> <span class="org-string">"https://"</span>
                                      image))))
                      (list <span class="org-builtin">:title</span> title <span class="org-builtin">:description</span> description <span class="org-builtin">:image</span> image))))
                 org-url-unfurl-metadata--cache)))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-latex-rendering" class="outline-5">
<h5 id="latex-rendering"><span class="section-number-5">5.3.6.12.</span> LaTeX Rendering<a aria-hidden="true" href="#latex-rendering">#</a> </h5>
<div class="outline-text-5" id="text-5-3-6-12">
</div>
<div id="outline-container-pre-rendered" class="outline-6">
<h6 id="pre-rendered"><span class="section-number-6">5.3.6.12.1.</span> Pre-rendered<a aria-hidden="true" href="#pre-rendered">#</a> </h6>
<div class="outline-text-6" id="text-5-3-6-12-1">
<p>
I consider <code>dvisvgm</code> to be a rather compelling option. However this isn't scaled
very well at the moment.
</p>
<details id='pre-rendered,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#pre-rendered,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">(setq-default org-html-with-latex `dvisvgm)</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-mathjax" class="outline-6">
<h6 id="mathjax"><span class="section-number-6">5.3.6.12.2.</span> MathJax<a aria-hidden="true" href="#mathjax">#</a> </h6>
<div class="outline-text-6" id="text-5-3-6-12-2">
<p>
I want to use svg MathJax by default, and with a few of the custom commands that
are part of my LaTeX preamble.
</p>

<details id='mathjax,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mathjax,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(setcdr (assoc 'path org-html-mathjax-options)
        (list <span class="org-string">"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"</span>))

(<span class="org-keyword">setq</span> org-html-mathjax-template
  <span class="org-string">"&lt;script&gt;</span>
<span class="org-string">  window.MathJax = {</span>
<span class="org-string">    loader: {</span>
<span class="org-string">      load: ['[tex]/mathtools'],</span>
<span class="org-string">    },</span>
<span class="org-string">    tex: {</span>
<span class="org-string">      ams: {</span>
<span class="org-string">        multlineWidth: '</span><span class="org-string"><span class="org-constant">%MULTLINEWIDTH</span></span><span class="org-string">'</span>
<span class="org-string">      },</span>
<span class="org-string">      tags: '</span><span class="org-string"><span class="org-constant">%TAGS</span></span><span class="org-string">',</span>
<span class="org-string">      tagSide: '</span><span class="org-string"><span class="org-constant">%TAGSIDE</span></span><span class="org-string">',</span>
<span class="org-string">      tagIndent: '</span><span class="org-string"><span class="org-constant">%TAGINDENT</span></span><span class="org-string">',</span>
<span class="org-string">      packages: {'[+]': ['</span><span class="org-string"><span class="org-constant">mathtools</span></span><span class="org-string">']},</span>
<span class="org-string">      macros: {</span>
<span class="org-string">        RR: ['\\\\ifstrempty{#1}{\\\\mathbb{R}}{\\\\mathbb{R}^{#1}}', 1, ''],</span>
<span class="org-string">        NN: ['\\\\ifstrempty{#1}{\\\\mathbb{N}}{\\\\mathbb{N}^{#1}}', 1, ''],</span>
<span class="org-string">        ZZ: ['\\\\ifstrempty{#1}{\\\\mathbb{Z}}{\\\\mathbb{Z}^{#1}}', 1, ''],</span>
<span class="org-string">        QQ: ['\\\\ifstrempty{#1}{\\\\mathbb{Q}}{\\\\mathbb{Q}^{#1}}', 1, ''],</span>
<span class="org-string">        CC: ['\\\\ifstrempty{#1}{\\\\mathbb{C}}{\\\\mathbb{C}^{#1}}', 1, ''],</span>
<span class="org-string">        EE: '</span><span class="org-string"><span class="org-constant">\\\\mathbb{E}</span></span><span class="org-string">',</span>
<span class="org-string">        Lap: '</span><span class="org-string"><span class="org-constant">\\\\operatorname{\\\\mathcal{L}}</span></span><span class="org-string">',</span>
<span class="org-string">        Var: '</span><span class="org-string"><span class="org-constant">\\\\operatorname{Var}</span></span><span class="org-string">',</span>
<span class="org-string">        Cor: '</span><span class="org-string"><span class="org-constant">\\\\operatorname{Cor}</span></span><span class="org-string">',</span>
<span class="org-string">        E: '</span><span class="org-string"><span class="org-constant">\\\\operatorname{E}</span></span><span class="org-string">',</span>
<span class="org-string">      },</span>
<span class="org-string">      mathtools: {</span>
<span class="org-string">        pairedDelimiters: {</span>
<span class="org-string">          abs: ['</span><span class="org-string"><span class="org-constant">\\\\lvert</span></span><span class="org-string">', '</span><span class="org-string"><span class="org-constant">\\\\rvert</span></span><span class="org-string">'],</span>
<span class="org-string">          norm: ['</span><span class="org-string"><span class="org-constant">\\\\lVert</span></span><span class="org-string">', '</span><span class="org-string"><span class="org-constant">\\\\rVert</span></span><span class="org-string">'],</span>
<span class="org-string">          ceil: ['</span><span class="org-string"><span class="org-constant">\\\\lceil</span></span><span class="org-string">', '</span><span class="org-string"><span class="org-constant">\\\\rceil</span></span><span class="org-string">'],</span>
<span class="org-string">          floor: ['</span><span class="org-string"><span class="org-constant">\\\\lfloor</span></span><span class="org-string">', '</span><span class="org-string"><span class="org-constant">\\\\rfloor</span></span><span class="org-string">'],</span>
<span class="org-string">          round: ['</span><span class="org-string"><span class="org-constant">\\\\lfloor</span></span><span class="org-string">', '</span><span class="org-string"><span class="org-constant">\\\\rceil</span></span><span class="org-string">'],</span>
<span class="org-string">        }</span>
<span class="org-string">      }</span>
<span class="org-string">    },</span>
<span class="org-string">    chtml: {</span>
<span class="org-string">      scale: %SCALE,</span>
<span class="org-string">      displayAlign: '</span><span class="org-string"><span class="org-constant">%ALIGN</span></span><span class="org-string">',</span>
<span class="org-string">      displayIndent: '</span><span class="org-string"><span class="org-constant">%INDENT</span></span><span class="org-string">'</span>
<span class="org-string">    },</span>
<span class="org-string">    svg: {</span>
<span class="org-string">      scale: %SCALE,</span>
<span class="org-string">      displayAlign: '</span><span class="org-string"><span class="org-constant">%ALIGN</span></span><span class="org-string">',</span>
<span class="org-string">      displayIndent: '</span><span class="org-string"><span class="org-constant">%INDENT</span></span><span class="org-string">'</span>
<span class="org-string">    },</span>
<span class="org-string">    output: {</span>
<span class="org-string">      font: '</span><span class="org-string"><span class="org-constant">%FONT</span></span><span class="org-string">',</span>
<span class="org-string">      displayOverflow: '</span><span class="org-string"><span class="org-constant">%OVERFLOW</span></span><span class="org-string">'</span>
<span class="org-string">    }</span>
<span class="org-string">  };</span>
<span class="org-string">&lt;/script&gt;</span>

<span class="org-string">&lt;script</span>
<span class="org-string">  id=\"MathJax-script\"</span>
<span class="org-string">  async</span>
<span class="org-string">  src=\"%PATH\"&gt;</span>
<span class="org-string">&lt;/script&gt;"</span>)
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
<div id="outline-container-latex-export" class="outline-4">
<h4 id="latex-export"><span class="section-number-4">5.3.7.</span> LaTeX Export<a aria-hidden="true" href="#latex-export">#</a> </h4>
<div class="outline-text-4" id="text-5-3-7">
</div>
<div id="outline-container-compiling" class="outline-5">
<h5 id="compiling"><span class="section-number-5">5.3.7.1.</span> Compiling<a aria-hidden="true" href="#compiling">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-1">
<p>
By default Org uses <code>pdflatex</code> &times; 3 + <code>bibtex</code>. This simply won't do in our
modern world. <code>latexmk</code> + <code>biber</code> (which is used automatically with <code>latexmk</code>) is a
simply superior combination.
</p>

<details id='compiling,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#compiling,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">org-latex-compilers = ("pdflatex" "xelatex" "lualatex"), which are the possible values for %latex</span>
(<span class="org-keyword">setq</span> org-latex-pdf-process '(<span class="org-string">"LC_ALL=en_US.UTF-8 latexmk -f -pdf -%latex -shell-escape -interaction=nonstopmode -output-directory=%o %f"</span>))
</pre>
</div>
</details>

<p>
While <code>org-latex-pdf-process</code> does support a function, and we could use that
instead, this would no longer use the log buffer &#x2014; it's a bit blind, you give
it the file name and expect it to do its thing.
</p>

<p>
The default values of <code>org-latex-compilers</code> is given in commented form to see how
<code>org-latex-pdf-process</code> works with them.
</p>

<p>
While the <code>-%latex</code> above is slightly hacky (<code>-pdflatex</code> expects to be given a
value) it allows us to leave <code>org-latex-compilers</code> unmodified.
This is nice in case I open an org file that uses <kbd>#+LATEX_COMPILER</kbd> for example,
it should still work.
</p>
</div>
</div>
<div id="outline-container-nicer-checkboxes" class="outline-5">
<h5 id="nicer-checkboxes"><span class="section-number-5">5.3.7.2.</span> Nicer checkboxes<a aria-hidden="true" href="#nicer-checkboxes">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-2">
<p>
We'll assume that thanks to the clever preamble the various custom <kbd>\checkbox...</kbd>
commands below are defined.
</p>

<details id='nicer-checkboxes,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#nicer-checkboxes,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">+org-export-latex-fancy-item-checkboxes</span> (text backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'latex)
    (replace-regexp-in-string
     <span class="org-string">"\\\\item\\[{$\\\\</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\w+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$}\\]"</span>
     (<span class="org-keyword">lambda</span> (fullmatch)
       (concat <span class="org-string">"\\\\item["</span> (<span class="org-keyword">pcase</span> (substring fullmatch 9 -3) <span class="org-comment-delimiter">; </span><span class="org-comment">content of capture group</span>
                             (<span class="org-string">"square"</span>   <span class="org-string">"\\\\checkboxUnchecked"</span>)
                             (<span class="org-string">"boxminus"</span> <span class="org-string">"\\\\checkboxTransitive"</span>)
                             (<span class="org-string">"boxtimes"</span> <span class="org-string">"\\\\checkboxChecked"</span>)
                             (_ (substring fullmatch 9 -3))) <span class="org-string"><span class="org-warning">"]"</span></span><span class="org-warning">))</span>
     text)))

(add-to-list 'org-export-filter-item-functions
             '+org-export-latex-fancy-item-checkboxes)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-class-templates" class="outline-5">
<h5 id="class-templates"><span class="section-number-5">5.3.7.3.</span> Class templates<a aria-hidden="true" href="#class-templates">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-3">
<p>
I really like the <span class='acr'>KOMA</span> bundle. It provides a set of mechanisms to tweak document
styling which is both easy to use, and quite comprehensive.
For example, I rather like section numbers in the margin, which can be
accomplished with
</p>
<details id='latex-hanging-secnum' class='code' open><summary class='named'><span class="name">latex-hanging-secnum</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-hanging-secnum'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\sectionformat</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\llap</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\thesection\autodot\enskip</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\subsectionformat</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\llap</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\thesubsection\autodot\enskip</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\subsubsectionformat</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\llap</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\thesubsubsection\autodot\enskip</span></span><span class="org-function-name">}</span>}
</pre>
</div>
</details>

<p>
It can also be nice to have big <kbd>\chapter</kbd>s.
</p>
<details id='latex-big-chapter' class='code' open><summary class='named'><span class="name">latex-big-chapter</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-big-chapter'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate">\RedeclareSectionCommand</span>[afterindent=false, beforeskip=0pt, afterskip=0pt, innerskip=0pt]{chapter}
<span class="org-font-latex-sedate">\setkomafont</span>{chapter}{<span class="org-font-latex-sedate"><span class="org-keyword">\normalfont</span></span><span class="org-font-latex-sedate"><span class="org-type">\Huge</span></span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-keyword">*</span>{<span class="org-font-latex-sedate"><span class="org-function-name">\chapterheadstartvskip</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\vspace</span></span><span class="org-function-name">*{0</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselineskip</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-keyword">*</span>{<span class="org-font-latex-sedate"><span class="org-function-name">\chapterheadendvskip</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\vspace</span></span><span class="org-function-name">*{0</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselineskip</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-keyword">*</span>{<span class="org-font-latex-sedate"><span class="org-function-name">\chapterformat</span></span>}{<span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\fontsize</span></span><span class="org-function-name">{60}{30}</span><span class="org-font-latex-sedate"><span class="org-function-name">\selectfont\rlap</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\hspace</span></span><span class="org-function-name">{6pt}</span><span class="org-font-latex-sedate"><span class="org-function-name">\thechapter</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-keyword">*</span><span class="org-font-latex-sedate"><span class="org-function-name">\chapterlinesformat</span></span>[<span class="org-variable-name">3</span>]{<span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\parbox</span></span><span class="org-function-name">[b]{</span><span class="org-font-latex-sedate"><span class="org-function-name">\dimexpr\textwidth</span></span><span class="org-function-name">-0.5em</span><span class="org-font-latex-sedate"><span class="org-function-name">\relax</span></span><span class="org-function-name">}{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\raggedleft</span></span><span class="org-function-name">{{</span><span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\large</span></span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-font-latex-bold"><span class="org-function-name">\scshape</span></span></span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\bfseries\chapapp</span></span></span><span class="org-function-name">}</span><span class="org-font-latex-sedate"><span class="org-function-name">\vspace</span></span><span class="org-function-name">{-0.5ex}</span><span class="org-font-latex-sedate"><span class="org-function-name">\par</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\Huge</span></span></span><span class="org-function-name">#3}}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\hfill\makebox</span></span><span class="org-function-name">[0pt][l]{#2}</span>}
</pre>
</div>
</details>

<p>
Now let's just sprinkle some <span class='acr'>KOMA</span> all over the Org LaTeX classes.
</p>

<details id='class-templates,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#class-templates,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> ox-latex
  (<span class="org-keyword">let*</span> ((article-sections '((<span class="org-string">"\\section{%s}"</span> . <span class="org-string">"\\section*{%s}"</span>)
                             (<span class="org-string">"\\subsection{%s}"</span> . <span class="org-string">"\\subsection*{%s}"</span>)
                             (<span class="org-string">"\\subsubsection{%s}"</span> . <span class="org-string">"\\subsubsection*{%s}"</span>)
                             (<span class="org-string">"\\paragraph{%s}"</span> . <span class="org-string">"\\paragraph*{%s}"</span>)
                             (<span class="org-string">"\\subparagraph{%s}"</span> . <span class="org-string">"\\subparagraph*{%s}"</span>)))
         (book-sections (append '((<span class="org-string">"\\chapter{%s}"</span> . <span class="org-string">"\\chapter*{%s}"</span>))
                                article-sections))
         (hanging-secnum-preamble &lt;&lt;grab(<span class="org-string">"latex-hanging-secnum"</span>)&gt;&gt;)
         (big-chap-preamble &lt;&lt;grab(<span class="org-string">"latex-big-chapter"</span>)&gt;&gt;))
    (setcdr (assoc <span class="org-string">"article"</span> org-latex-classes)
            `(,(concat <span class="org-string">"\\documentclass{scrartcl}"</span> hanging-secnum-preamble)
              ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="org-string">"report"</span> ,(concat <span class="org-string">"\\documentclass{scrartcl}"</span> hanging-secnum-preamble)
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="org-string">"book"</span> ,(concat <span class="org-string">"\\documentclass[twoside=false]{scrbook}"</span>
                                   big-chap-preamble hanging-secnum-preamble)
                   ,@book-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="org-string">"blank"</span> <span class="org-string">"[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span>
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="org-string">"bmc-article"</span> <span class="org-string">"\\documentclass[article,code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span>
                   ,@article-sections))
    (add-to-list 'org-latex-classes
                 `(<span class="org-string">"bmc"</span> <span class="org-string">"\\documentclass[code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"</span>
                   ,@book-sections))))

(<span class="org-keyword">setq</span> org-latex-tables-booktabs t
      org-latex-hyperref-template
      &lt;&lt;grab(<span class="org-string">"latex-fancy-hyperref"</span>)&gt;&gt;
      org-latex-reference-command <span class="org-string">"\\cref{%s}"</span>)
</pre>
</div>
</details>


<p>
The <kbd>hyperref</kbd> setup needs to be handled separately however.
</p>
<details id='latex-fancy-hyperref' class='code' open><summary class='named'><span class="name">latex-fancy-hyperref</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-fancy-hyperref'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate">\providecolor</span>{url}{HTML}{0077bb}
<span class="org-font-latex-sedate">\providecolor</span>{link}{HTML}{882255}
<span class="org-font-latex-sedate">\providecolor</span>{cite}{HTML}{999933}
<span class="org-font-latex-sedate">\hypersetup</span>{
  pdfauthor={<span class="org-comment">%a},</span>
  pdftitle={<span class="org-comment">%t},</span>
  pdfkeywords={<span class="org-comment">%k},</span>
  pdfsubject={<span class="org-comment">%d},</span>
  pdfcreator={<span class="org-comment">%c},</span>
  pdflang={<span class="org-comment">%L},</span>
  breaklinks=true,
  colorlinks=true,
  linkcolor=link,
  urlcolor=url,
  citecolor=cite
}
<span class="org-font-latex-sedate">\urlstyle</span>{same}
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-cleverer-preamble" class="outline-5">
<h5 id="cleverer-preamble"><span class="section-number-5">5.3.7.4.</span> A cleverer preamble<a aria-hidden="true" href="#cleverer-preamble">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-4">
</div>
<div id="outline-container-use-case" class="outline-6">
<h6 id="use-case"><span class="section-number-6">5.3.7.4.1.</span> Use case<a aria-hidden="true" href="#use-case">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-4-1">
<p>
We often want particular snippets of LaTeX in our documents preambles.
It's a pain to have to work out / remember them every time.
</p>

<p>
We could have every package we could possibly need in every one of
<code>org-latex-classes</code>, but that's <i>horribly</i> inefficient and I don't want to think
about maintaining that.
</p>

<p>
Instead we can provide some granularity by splitting up the features we want,
and then take the experience to a whole new level by implementing a system to
automatically detect which features are desired and generating a preamble that
provides these features.
</p>
</div>
</div>
<div id="outline-container-conditional-content" class="outline-6">
<h6 id="conditional-content"><span class="section-number-6">5.3.7.4.2.</span> Conditional Content<a aria-hidden="true" href="#conditional-content">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-4-2">
<p>
Let's consider content we want in particular situations.
</p>

<p>
Captions could do with a bit of tweaking such that
</p>
<ul class="org-ul">
<li>You can easily have multiple captions</li>
<li>Links to figures take you to the <i>top</i> of the figure (not the bottom)</li>
<li>Caption labels could do with being emphasised slightly more</li>
<li>Multiline captions should run ragged-right, but only when then span more than
one line</li>
</ul>

<details id='org-latex-caption' class='code' open><summary class='named'><span class="name">org-latex-caption-preamble</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#org-latex-caption'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">subcaption</span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>[<span class="org-variable-name">hypcap=true</span>]{<span class="org-function-name">caption</span>}
<span class="org-font-latex-sedate">\setkomafont</span>{caption}{<span class="org-font-latex-sedate"><span class="org-keyword">\sffamily</span></span><span class="org-font-latex-sedate"><span class="org-type">\small</span></span>}
<span class="org-font-latex-sedate">\setkomafont</span>{captionlabel}{<span class="org-font-latex-sedate"><span class="org-keyword">\upshape</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-bold">\bfseries</span></span>}
<span class="org-font-latex-sedate">\captionsetup</span>{justification=raggedright,singlelinecheck=true}
<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">capt-of</span>} <span class="org-comment">% required by Org</span>
</pre>
</div>
</details>

<p>
The default checkboxes look rather ugly, so let's provide some prettier alternatives.
</p>

<details id='org-latex-checkbox' class='code' open><summary class='named'><span class="name">org-latex-checkbox-preamble</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#org-latex-checkbox'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\checkboxUnchecked</span></span>}{<span class="org-function-name"><span class="org-font-latex-math">$</span></span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-font-latex-math">\square</span></span></span><span class="org-function-name"><span class="org-font-latex-math">$</span></span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\checkboxTransitive</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\rlap</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\raisebox</span></span><span class="org-function-name">{-0.1ex}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\hspace</span></span><span class="org-function-name">{0.35ex}</span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\Large</span></span></span><span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-font-latex-warning"><span class="org-function-name">\</span></span></span></span><span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">textbf</span></span></span><span class="org-function-name"> -}}</span><span class="org-function-name"><span class="org-font-latex-math">$</span></span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-font-latex-math">\square</span></span></span><span class="org-function-name"><span class="org-font-latex-math">$</span></span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\checkboxChecked</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\rlap</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\raisebox</span></span><span class="org-function-name">{0.2ex}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\hspace</span></span><span class="org-function-name">{0.35ex}</span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\scriptsize</span></span></span><span class="org-function-name"> </span><span class="org-font-latex-sedate"><span class="org-function-name">\ding</span></span><span class="org-function-name">{52}}}</span><span class="org-function-name"><span class="org-font-latex-math">$</span></span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-font-latex-math">\square</span></span></span><span class="org-function-name"><span class="org-font-latex-math">$</span></span>}
</pre>
</div>
</details>

<p>
We set up a maths typesetting preamble <a href="#maths-notation-conveniences">later on</a>, but it would be nice to save it
to a variable here:
</p>

<details id='conditional-content,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#conditional-content,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-maths-preamble</span>
  &lt;&lt;grab(<span class="org-string">"latex-maths-conveniences"</span>)&gt;&gt;
  <span class="org-string">"Preamble that sets up a bunch of mathematical conveniences."</span>)
</pre>
</div>
</details>

<p>
It's nice to have "message blocks", things like info/warning/error/success.
A LaTeX macro should make them trivial to create.
</p>

<details id='org-latex-box' class='code' open><summary class='named'><span class="name">org-latex-box-preamble</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#org-latex-box'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate">\ExplSyntaxOn</span>
<span class="org-font-latex-sedate">\NewCoffin\SBXBaseline</span>
<span class="org-font-latex-sedate">\NewCoffin\SBXHeader</span>
<span class="org-font-latex-sedate">\NewCoffin\SBXContent</span>
<span class="org-font-latex-sedate">\NewCoffin\SBXSideRule</span>
<span class="org-font-latex-sedate">\newbox\SBXSplitBox</span>
<span class="org-font-latex-sedate">\cs</span>_new_protected:Nn <span class="org-font-latex-sedate">\simplebox</span>_start:nnn {
  <span class="org-comment">% #1 ding, #3 name, #4 label</span>
  <span class="org-font-latex-sedate">\vcoffin</span>_set:Nnn <span class="org-font-latex-sedate">\SBXHeader</span> { <span class="org-font-latex-sedate">\linewidth</span> - 1em } {
  <span class="org-font-latex-sedate"><span class="org-keyword">\noindent</span></span><span class="org-font-latex-sedate">\textcolor</span>{#2}{#1}~<span class="org-font-latex-sedate">\textcolor</span>{#2}{<span class="org-font-latex-sedate"><span class="org-keyword">\textbf</span></span>{<span class="org-font-latex-bold">#3</span>}}}
  <span class="org-font-latex-sedate">\vcoffin</span>_set:Nnw <span class="org-font-latex-sedate">\SBXContent</span> { <span class="org-font-latex-sedate">\linewidth</span> - 1.5em }
}
<span class="org-font-latex-sedate">\cs</span>_new_protected:Nn <span class="org-font-latex-sedate">\simplebox</span>_split_content:n {
  <span class="org-comment">% #1 name</span>
  <span class="org-font-latex-sedate">\setbox\SBXSplitBox</span> = <span class="org-font-latex-sedate">\vbox</span>:n { <span class="org-font-latex-sedate">\vbox</span>_unpack_drop:N <span class="org-font-latex-sedate">\SBXContent</span> }
  <span class="org-font-latex-sedate">\dim</span>_set:Nn <span class="org-font-latex-sedate">\l</span>_tmpa_dim { <span class="org-font-latex-sedate">\dim</span>_eval:n { <span class="org-font-latex-sedate">\dim</span>_min:nn { <span class="org-font-latex-sedate">\pagegoal</span> } { <span class="org-font-latex-sedate">\textheight</span> } - <span class="org-font-latex-sedate">\pagetotal</span> - 2<span class="org-font-latex-sedate">\baselineskip</span> } }
  <span class="org-font-latex-sedate">\setbox</span>0 = <span class="org-font-latex-sedate">\vsplit\SBXSplitBox</span> to <span class="org-font-latex-sedate">\l</span>_tmpa_dim
  <span class="org-font-latex-sedate">\vcoffin</span>_set:Nnn <span class="org-font-latex-sedate">\SBXContent</span> { <span class="org-font-latex-sedate">\CoffinWidth</span> <span class="org-font-latex-sedate">\SBXContent</span> } { <span class="org-font-latex-sedate">\box</span>0 <span class="org-comment">%</span>
    <span class="org-font-latex-sedate"><span class="org-keyword">\vspace</span></span>{<span class="org-function-name">-1.7</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselineskip</span></span>}
    <span class="org-font-latex-sedate"><span class="org-keyword">\noindent</span></span><span class="org-font-latex-sedate">\textcolor</span>{#1}{<span class="org-font-latex-sedate"><span class="org-keyword">\textbf</span></span>{<span class="org-font-latex-sedate"><span class="org-font-latex-bold"><span class="org-keyword">\ldots</span></span></span><span class="org-font-latex-bold"> </span>}}
    <span class="org-font-latex-sedate"><span class="org-keyword">\vspace</span></span><span class="org-keyword">*</span>{<span class="org-function-name">-0.3</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselineskip</span></span>}}
}
<span class="org-font-latex-sedate">\cs</span>_new_protected:Nn <span class="org-font-latex-sedate">\simplebox</span>_split_refill:nnnn {
  <span class="org-comment">% #1 ding, #2 ding offset, #3 name, #4 label</span>
  <span class="org-font-latex-sedate">\simplebox</span>_start:nnn {#1} {#3} {#4,<span class="org-font-latex-sedate">\space</span>{}<span class="org-font-latex-sedate"><span class="org-keyword">\emph</span></span>{<span class="org-font-latex-italic">continued</span>}}
  <span class="org-font-latex-sedate"><span class="org-keyword">\vspace</span></span><span class="org-keyword">*</span>{<span class="org-function-name">-0.2</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselineskip</span></span>}
  <span class="org-font-latex-sedate">\vbox</span>_unpack_drop:N <span class="org-font-latex-sedate">\SBXSplitBox</span>
  <span class="org-font-latex-sedate">\vcoffin</span>_set_end:
}
<span class="org-font-latex-sedate">\cs</span>_new_protected:Nn <span class="org-font-latex-sedate">\simplebox</span>_typeset:nn {
    <span class="org-comment">% #1 name, #2 ding offset</span>
    <span class="org-font-latex-sedate">\vcoffin</span>_set:Nnn <span class="org-font-latex-sedate">\SBXBaseline</span> {0pt} {<span class="org-font-latex-sedate">\vbox</span>{}}
    <span class="org-font-latex-sedate">\SetHorizontalCoffin\SBXSideRule</span>{<span class="org-font-latex-sedate">\color</span>{#1}<span class="org-font-latex-sedate"><span class="org-keyword">\rule</span></span>{<span class="org-function-name">1pt</span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\dim</span></span><span class="org-function-name">_eval:n { </span><span class="org-font-latex-sedate"><span class="org-function-name">\CoffinTotalHeight\SBXContent</span></span><span class="org-function-name"> + </span><span class="org-font-latex-sedate"><span class="org-function-name">\baselineskip</span></span><span class="org-function-name"> }</span>}}
    <span class="org-font-latex-sedate">\JoinCoffins</span>*<span class="org-font-latex-sedate">\SBXContent</span>[l,t]<span class="org-font-latex-sedate">\SBXSideRule</span>[l,t](<span class="org-font-latex-sedate">\dim</span>_eval:n {#2 - 1em}, <span class="org-font-latex-sedate">\dim</span>_eval:n{<span class="org-font-latex-sedate">\baselineskip</span> - 0.5em})
    <span class="org-font-latex-sedate">\JoinCoffins</span>*<span class="org-font-latex-sedate">\SBXContent</span>[l,t]<span class="org-font-latex-sedate">\SBXHeader</span>[l,B](-1em, 0.5<span class="org-font-latex-sedate">\baselineskip</span>)
    <span class="org-font-latex-sedate">\JoinCoffins</span>*<span class="org-font-latex-sedate">\SBXBaseline</span>[l,T]<span class="org-font-latex-sedate">\SBXContent</span>[l,T]
    <span class="org-font-latex-sedate"><span class="org-keyword">\vspace</span></span>{<span class="org-function-name">-0.5</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselineskip</span></span>}
    <span class="org-font-latex-sedate"><span class="org-keyword">\noindent</span></span><span class="org-font-latex-sedate">\TypesetCoffin\SBXBaseline</span>(<span class="org-font-latex-sedate">\dim</span>_eval:n { 1em - #2 + 1pt }, 0pt)
    <span class="org-font-latex-sedate"><span class="org-keyword">\vspace</span></span><span class="org-keyword">*</span>{<span class="org-font-latex-sedate"><span class="org-function-name">\CoffinTotalHeight\SBXContent</span></span>}
    <span class="org-font-latex-sedate"><span class="org-keyword">\vspace</span></span>{<span class="org-function-name">-0.08em</span>} <span class="org-comment">% Why on earth is this needed for baseline alignment!?</span>
}
<span class="org-font-latex-sedate">\cs</span>_new_protected:Nn <span class="org-font-latex-sedate">\simplebox</span>_typeset_breakable:nnnn {
    <span class="org-comment">% #1 ding, #2 ding offset, #3 name, #4 label</span>
    <span class="org-font-latex-sedate">\dim</span>_set:Nn <span class="org-font-latex-sedate">\l</span>_tmpa_dim {<span class="org-font-latex-sedate">\dim</span>_eval:n { <span class="org-font-latex-sedate">\CoffinTotalHeight\SBXContent</span> + <span class="org-font-latex-sedate">\baselineskip</span> }}
    <span class="org-font-latex-sedate">\dim</span>_set:Nn <span class="org-font-latex-sedate">\l</span>_tmpb_dim { <span class="org-font-latex-sedate">\dim</span>_eval:n { <span class="org-font-latex-sedate">\dim</span>_min:nn { <span class="org-font-latex-sedate">\pagegoal</span> } { <span class="org-font-latex-sedate">\textheight</span> } - <span class="org-font-latex-sedate">\pagetotal</span> - <span class="org-font-latex-sedate">\baselineskip</span> } }
    <span class="org-font-latex-sedate">\dim</span>_compare:nNnTF {<span class="org-font-latex-sedate">\l</span>_tmpa_dim} &gt; {<span class="org-font-latex-sedate">\l</span>_tmpb_dim} {
      <span class="org-font-latex-sedate">\simplebox</span>_split_content:n {#3}
      <span class="org-font-latex-sedate">\simplebox</span>_typeset:nn {#3} {#2}
      <span class="org-font-latex-sedate"><span class="org-font-latex-warning">\newpage</span></span>
      <span class="org-font-latex-sedate">\simplebox</span>_split_refill:nnnn {#1} {#2} {#3} {#4}
      <span class="org-font-latex-sedate">\simplebox</span>_typeset_breakable:nnnn {#1} {#2} {#3} {#4}
    }{
      <span class="org-font-latex-sedate">\simplebox</span>_typeset:nn {#3} {#2}
    }
}
<span class="org-font-latex-sedate"><span class="org-keyword">\NewDocumentCommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\defsimplebox</span></span>}{<span class="org-function-name">O{</span><span class="org-font-latex-sedate"><span class="org-function-name">\ding</span></span><span class="org-function-name">{117}} O{0.35em} O{#1} O{#2} m m m</span>}{
<span class="org-function-name">  </span><span class="org-function-name"><span class="org-comment">% #1 ding, #2 ding offset, #3 alt-ding, #4 alt-ding offset,</span></span>
<span class="org-function-name">  </span><span class="org-function-name"><span class="org-comment">% #5 name, #6 colour, #7 default label</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\definecolor</span></span><span class="org-function-name">{#5}{HTML}{#6}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\NewDocumentEnvironment</span></span><span class="org-function-name">{#5}{ O{#7} }{</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\simplebox</span></span><span class="org-function-name">_start:nnn {#1} {#5} {##1}</span>
<span class="org-function-name">  }{</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\vcoffin</span></span><span class="org-function-name">_set_end:</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\simplebox</span></span><span class="org-function-name">_typeset_breakable:nnnn {#3} {#4} {#5} {##1}</span>
<span class="org-function-name">  }</span>
}
<span class="org-font-latex-sedate">\ExplSyntaxOff</span>
</pre>
</div>
</details>

<p>
Lastly, we will pass this content into some global variables we for ease of
access.
</p>

<details id='conditional-content,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#conditional-content,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-embed-files-preamble</span>
  &lt;&lt;grab(<span class="org-string">"org-latex-embed-files-preamble"</span>)&gt;&gt;
  <span class="org-string">"Preamble that embeds files within the pdf."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-caption-preamble</span>
  &lt;&lt;grab(<span class="org-string">"org-latex-caption-preamble"</span>)&gt;&gt;
  <span class="org-string">"Preamble that improves captions."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-checkbox-preamble</span>
  &lt;&lt;grab(<span class="org-string">"org-latex-checkbox-preamble"</span>)&gt;&gt;
  <span class="org-string">"Preamble that improves checkboxes."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-box-preamble</span>
  &lt;&lt;grab(<span class="org-string">"org-latex-box-preamble"</span>)&gt;&gt;
  <span class="org-string">"Preamble that provides a macro for custom boxes."</span>)
</pre>
</div>
</details>

<p>
In the "universal preamble", we already embed the source <kbd>.org</kbd> file, but it would
be nice to embed all the tangled files. This is fairly easy to accomplish by
mapping each tangled file to a form which embeds the file if it exists.
Considering we're going this far, why not add a dedicated <kbd>#+emded</kbd> keyword, so we
can embed whatever we want.
</p>

<details id='conditional-content,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#conditional-content,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-embed-extra-files</span> ()
  <span class="org-doc">"Return a string that uses embedfile to embed all tangled files."</span>
  (mapconcat
   (<span class="org-keyword">lambda</span> (file-desc)
     (format <span class="org-string">"\\IfFileExists{%1$s}{\\embedfile[desc=%2$s]{%1$s}}{}"</span>
             (<span class="org-keyword">thread-last</span> (car file-desc)
                          (replace-regexp-in-string <span class="org-string">"\\\\"</span> <span class="org-string">"\\\\\\\\"</span>)
                          (replace-regexp-in-string <span class="org-string">"~"</span> <span class="org-string">"\\\\string~"</span>))
             (cdr file-desc)))
   (append
    (<span class="org-keyword">let</span> (tangle-fspecs) <span class="org-comment-delimiter">; </span><span class="org-comment">All files being tangled to.</span>
      (org-element-cache-map
       (<span class="org-keyword">lambda</span> (src)
         (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not (org-in-commented-heading-p nil src))
                    (not (org-in-archived-heading-p nil src)))
           (<span class="org-keyword">when-let</span> ((lang (org-element-property <span class="org-builtin">:language</span> src))
                      (params
                       (apply
                        #'org-babel-merge-params
                        (append
                         (<span class="org-keyword">org-with-point-at</span> (org-element-property <span class="org-builtin">:begin</span> src)
                           (org-babel-params-from-properties lang t))
                         (mapcar
                          (<span class="org-keyword">lambda</span> (h)
                            (org-babel-parse-header-arguments h t))
                          (cons (org-element-property <span class="org-builtin">:parameters</span> src)
                                (org-element-property <span class="org-builtin">:header</span> src))))))
                      (tangle-value
                       (<span class="org-keyword">pcase</span> (alist-get <span class="org-builtin">:tangle</span> params)
                         ((<span class="org-keyword">and</span> (pred stringp) (pred (string-match-p <span class="org-string">"^(.*)$"</span>)) expr)
                          (eval (read expr)))
                         (val val)))
                      (tangle-file
                       (<span class="org-keyword">pcase</span> tangle-value
                         ((<span class="org-keyword">or</span> <span class="org-string">"no"</span> (guard (member (alist-get <span class="org-builtin">:export-embed</span> params) '(<span class="org-string">"no"</span> <span class="org-string">"nil"</span>))))
                          nil)
                         (<span class="org-string">"yes"</span>
                          (file-name-with-extension
                           (file-name-nondirectory (buffer-file-name))
                           (<span class="org-keyword">or</span> (alist-get lang org-babel-tangle-lang-exts nil nil #'equal)
                               lang)))
                         (val val))))
             (<span class="org-keyword">unless</span> (assoc tangle-file tangle-fspecs)
               (<span class="org-keyword">push</span>
                (cons tangle-file (format <span class="org-string">"Tangled %s file"</span> lang))
                tangle-fspecs)))))
       <span class="org-builtin">:granularity</span> 'element
       <span class="org-builtin">:restrict-elements</span> '(src-block))
      (nreverse tangle-fspecs))
    (<span class="org-keyword">let</span> (extra-files)
      (<span class="org-keyword">save-excursion</span>
        (goto-char (point-min))
        (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^[ \t]*#\\+embed:"</span> nil t)
          (<span class="org-keyword">let*</span> ((file-desc (split-string (org-element-property <span class="org-builtin">:value</span> (org-element-at-point)) <span class="org-string">" :desc</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">ription</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">? "</span>)))
            (<span class="org-keyword">push</span> (cons (car file-desc) (<span class="org-keyword">or</span> (cdr file-desc) <span class="org-string">"Extra file"</span>)) extra-files))))
      (nreverse extra-files)))
   <span class="org-string">"\n"</span>))
</pre>
</div>
</details>

<p>
Now all tangled files will be embedded, and we can embed arbitrary files like
so:
</p>
<details id='conditional-content,code--4' class='code' open><summary><span class="lang">Org mode</span></summary>
<div class='gutter'>
<a href='#conditional-content,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-org"><span class="org-org-meta-line">#+embed: some-file :description flavour text about the file</span>
</pre>
</div>
</details>

<p>
This currently won't complete or anything like that, as we haven't told Org that
it's a keyword yet. It's also LaTeX-specific, so maybe it should be changed to
<kbd>#+latex_embed</kbd> or something like that.
</p>
</div>
</div>
<div id="outline-container-content-feature-preamble" class="outline-6">
<h6 id="content-feature-preamble"><span class="section-number-6">5.3.7.4.3.</span> Content-feature-preamble association<a aria-hidden="true" href="#content-feature-preamble">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-4-3">
<p>
Initially this idea was implemented with an alist that associated a construct
that would search the current Org file for an indication that some feature was
needed, with a LaTeX snippet to be inserted in the preamble which would provide
that feature.
This is all well and good when there is a bijection between detected features
and the LaTeX code needed to support those features, but in many cases this
relation is not injective.
</p>

<p>
To better model the reality of the situation, I add an extra layer to this
process where each detected feature gives a list of required "feature flags".
Simply be merging the lists of feature flags we no longer have to require
injectivity to avoid LaTeX duplication. Then the extra layer forms a bijection
between there feature flags and a specification which can be used to implement
the feature.
</p>

<p>
This model also provides a number of nice secondary benefits, such as a simple
implementation of feature dependency.
</p>


<figure id="orged0642b">
<img src="misc/org-latex-clever-preamble.svg" alt="DAG showing how Org features flow through to LaTeX" class="invertible" style="max-width:min(24em,100%)">

<figcaption><span class="figure-number">Figure 2: </span>Association between Org features, feature flags, and LaTeX snippets required.</figcaption>
</figure>

<p>
First we will implement the feature detection component of this model. I'd like
this to be able to use as much state information as possible, so the feature
tests should be very versatile.
</p>

<details id='content-feature-preamble,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#content-feature-preamble,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-embed-files</span> t
  <span class="org-doc">"Embed the source .org, .tex, and any tangled files."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-use-microtype</span> t
  <span class="org-doc">"Use the microtype pakage."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-italic-quotes</span> t
  <span class="org-doc">"Make \"quote\" environments italic."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-par-sep</span> t
  <span class="org-doc">"Vertically seperate paragraphs, and remove indentation."</span>)

(<span class="org-keyword">org-export-update-features</span> 'latex
  ((image caption)
   <span class="org-builtin">:condition</span> <span class="org-string">"\\[\\[xkcd:"</span>))
</pre>
</div>
</details>

<p>
Then we provide a way to generate the preamble that provides those features. In
addition to the features named in <code>org-latex-conditional-features</code> we'll also
create <i>meta-features</i>, which can be required by other features (with <kbd>:requires</kbd>).
For further control I some features may only be used when certain other features
are active (with <kbd>:when</kbd>), and masked by other features (with <kbd>:prevents</kbd>). I will
use the convention of starting meta-features with <kbd>.</kbd>, to make their nature more
readily apparent.
</p>

<p>
Another consideration in LaTeX is load order, which matters in some cases.
Beyond that, it's nice to have some sort of sensible ordering. For this I'll
introduce an <kbd>:order</kbd> keyword. Using this I'll arrange snippets as follows.
</p>

<ul class="org-ul">
<li><kbd>0</kbd> Typography
<ul class="org-ul">
<li><kbd>0</kbd> Fonts themselves</li>
<li><kbd>0.1</kbd> Typographic tweaks (<kbd>microtype</kbd>)</li>
<li><kbd>0.2</kbd> Maths setup</li>
<li><kbd>0.3</kbd> Maths font</li>
<li><kbd>0.4</kbd> Extra text shaping (<code>\acr</code>)</li>
<li><kbd>0.5-0.9</kbd> Miscellaneous text modifications, trying to put shorter snippets first</li>
</ul></li>
<li><kbd>1</kbd> (<i>default</i>)</li>
<li><kbd>2</kbd> Tables and figures</li>
<li><kbd>3</kbd> Miscellaneous short content</li>
<li><kbd>4</kbd> Fancy boxes</li>
<li><kbd>70</kbd> setup for non-precompilable content</li>
<li><kbd>80</kbd> non-precompileable content</li>
</ul>

<details id='content-feature-preamble,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#content-feature-preamble,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">org-export-update-features</span> 'latex
  (maths
   <span class="org-builtin">:snippet</span> org-latex-maths-preamble
   <span class="org-builtin">:order</span> 0.2)
  (cleveref
   <span class="org-builtin">:condition</span> <span class="org-string">"cref:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\cref{</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\[\\[[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\\]+\n?[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\\]\\]\\]"</span>
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage[capitalize]{cleveref}</span>
<span class="org-string">% Fix for cleveref in order to work with long range of pages</span>
<span class="org-string">% See https://tex.stackexchange.com/a/620066</span>
<span class="org-string">\\makeatletter</span>
<span class="org-string">\\newcommand*{\\@setcpagerefrange}[3]{%</span>
<span class="org-string">  \\@@setcpagerefrange{#1}{#2}{cref}{#3}}</span>
<span class="org-string">\\newcommand*{\\@setCpagerefrange}[3]{%</span>
<span class="org-string">  \\@@setcpagerefrange{#1}{#2}{Cref}{#3}}</span>
<span class="org-string">\\newcommand*{\\@setlabelcpagerefrange}[3]{%</span>
<span class="org-string">  \\@@setcpagerefrange{#1}{#2}{labelcref}{#3}}</span>
<span class="org-string">\\makeatother"</span>
   <span class="org-builtin">:order</span> 1)
  (caption
   <span class="org-builtin">:snippet</span> org-latex-caption-preamble
   <span class="org-builtin">:order</span> 2.1)
  (microtype
   <span class="org-builtin">:condition</span> org-latex-use-microtype
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000]{microtype}"</span>
   <span class="org-builtin">:order</span> 0.1)
  (embed-files
   <span class="org-builtin">:condition</span> org-latex-embed-files
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage[include]{embedall}"</span>
   <span class="org-builtin">:order</span> 70)
  (embed-source
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> embed-files
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\IfFileExists{./\\jobname.org}{\\embedfile[desc=Primary source file]{\\jobname.org}}{}</span>
<span class="org-string">\\IfFileExists{./\\jobname.tex}{\\embedfile[desc=The (generated) LaTeX source file]{\\jobname.tex}}{}"</span>
   <span class="org-builtin">:no-precompile</span> t
   <span class="org-builtin">:after</span> embed-files
   <span class="org-builtin">:order</span> 80)
  (embed-tangled
   <span class="org-builtin">:condition</span> (<span class="org-keyword">and</span> org-latex-embed-files
                   <span class="org-string">"^[ \t]*#\\+embed</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[ \t]*#\\+begin_src</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[ \t]*#\\+BEGIN_SRC"</span>)
   <span class="org-builtin">:requires</span> embed-files
   <span class="org-builtin">:snippet</span> (org-latex-embed-extra-files)
   <span class="org-builtin">:no-precompile</span> t
   <span class="org-builtin">:after</span> (embed-source embed-files)
   <span class="org-builtin">:order</span> 80)
  (acronym
   <span class="org-builtin">:condition</span> <span class="org-string">"[;\\\\]?\\b[A-Z][A-Z]+s?[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">A-Za-z]"</span>
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\newcommand{\\acr}[1]{\\protect\\textls*[110]{\\scshape #1}}\n\\newcommand{\\acrs}{\\protect\\scalebox{.91}[.84]{\\hspace{0.15ex}s}}"</span>
   <span class="org-builtin">:order</span> 0.4)
  (box-drawing
   <span class="org-builtin">:condition</span> <span class="org-string">"[\u2500-\u259F]"</span>
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage{pmboxdraw}"</span>
   <span class="org-builtin">:order</span> 0.05)
  (italic-quotes
   <span class="org-builtin">:condition</span> (<span class="org-keyword">and</span> org-latex-italic-quotes <span class="org-string">"^[ \t]*#\\+begin_quote</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\\\begin{quote}"</span>)
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\renewcommand{\\quote}{\\list{}{\\rightmargin\\leftmargin}\\item\\relax\\em}\n"</span>
   <span class="org-builtin">:order</span> 0.5)
  (par-sep
   <span class="org-builtin">:condition</span> org-latex-par-sep
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\setlength{\\parskip}{\\baselineskip}\n\\setlength{\\parindent}{0pt}"</span>
   <span class="org-builtin">:order</span> 0.5)
  (.pifont
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage{pifont}"</span>)
  (.xcoffins
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage{xcoffins}"</span>)
  (checkbox
   <span class="org-builtin">:condition</span> <span class="org-string">"^[ \t]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[-+*]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">[0-9]+[.)]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">[A-Za-z]+[.)]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> \\[[ -X]\\]"</span>
   <span class="org-builtin">:requires</span> .pifont
   <span class="org-builtin">:snippet</span> (concat (<span class="org-keyword">unless</span> (memq 'maths features)
                      <span class="org-string">"\\usepackage{amssymb} % provides \\square"</span>)
                    org-latex-checkbox-preamble)
   <span class="org-builtin">:after</span> .pifont)
  (.fancy-box
   <span class="org-builtin">:requires</span> (.pifont .xcoffins)
   <span class="org-builtin">:snippet</span> org-latex-box-preamble
   <span class="org-builtin">:after</span> (.pifont .xcoffins))
  (box-warning
   <span class="org-builtin">:condition</span> <span class="org-string">"^[ \t]*#\\+begin_warning</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\\\begin{warning}"</span>
   <span class="org-builtin">:requires</span> .fancy-box
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\defsimplebox{warning}{e66100}{Warning}"</span>
   <span class="org-builtin">:after</span> .fancy-box)
  (box-info
   <span class="org-builtin">:condition</span> <span class="org-string">"^[ \t]*#\\+begin_info</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\\\begin{info}"</span>
   <span class="org-builtin">:requires</span> .fancy-box
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\defsimplebox{info}{3584e4}{Information}"</span>
   <span class="org-builtin">:after</span> .fancy-box)
  (box-notes
   <span class="org-builtin">:condition</span> <span class="org-string">"^[ \t]*#\\+begin_notes</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\\\begin{notes}"</span>
   <span class="org-builtin">:requires</span> .fancy-box
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\defsimplebox{notes}{26a269}{Notes}"</span>
   <span class="org-builtin">:after</span> .fancy-box)
  (box-success
   <span class="org-builtin">:condition</span> <span class="org-string">"^[ \t]*#\\+begin_success</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\\\begin{success}"</span>
   <span class="org-builtin">:requires</span> .fancy-box
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\defsimplebox{success}{26a269}{\\vspace{-\\baselineskip}}"</span>
   <span class="org-builtin">:after</span> .fancy-box)
  (box-error
   <span class="org-builtin">:condition</span> <span class="org-string">"^[ \t]*#\\+begin_error</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\\\begin{error}"</span>
   <span class="org-builtin">:requires</span> .fancy-box
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\defsimplebox{error}{c01c28}{Important}"</span>
   <span class="org-builtin">:after</span> .fancy-box)
  (hanging-section-numbers
   <span class="org-builtin">:condition</span>
   (<span class="org-keyword">let</span> ((latex-class
          (assoc (plist-get info <span class="org-builtin">:latex-class</span>) (plist-get info <span class="org-builtin">:latex-classes</span>))))
     (<span class="org-keyword">and</span> (cadr latex-class)
          (string-match-p <span class="org-string">"\\`\\\\documentclass</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">\\[</span><span class="org-string"><span class="org-constant">.*\\</span></span><span class="org-string">]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?{scr"</span> (cadr latex-class))
          (not (string-match-p <span class="org-string">"[[,]twocolumn[],]"</span> (<span class="org-keyword">or</span> (plist-get info <span class="org-builtin">:latex-class-options</span>) <span class="org-string">""</span>)))))
   <span class="org-builtin">:snippet</span>
   <span class="org-string">"\\renewcommand\\sectionformat{\\llap{\\thesection\\autodot\\enskip}}</span>
<span class="org-string">\\renewcommand\\subsectionformat{\\llap{\\thesubsection\\autodot\\enskip}}</span>
<span class="org-string">\\renewcommand\\subsubsectionformat{\\llap{\\thesubsubsection\\autodot\\enskip}}"</span>)
  (toc-hidelinks
   <span class="org-builtin">:condition</span>
   (<span class="org-keyword">or</span> (plist-get info <span class="org-builtin">:with-toc</span>)
       (<span class="org-keyword">save-excursion</span>
         (goto-char (point-min))
         (re-search-forward <span class="org-string">"\\tableofcontents"</span> nil t)))
   <span class="org-builtin">:snippet</span> <span class="org-string">"%% hide links styles in toc</span>
<span class="org-string">\\NewCommandCopy{\\oldtoc}{\\tableofcontents}</span>
<span class="org-string">\\renewcommand{\\tableofcontents}{\\begingroup\\hypersetup{hidelinks}\\oldtoc\\endgroup}"</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-content-feature-graph" class="outline-6">
<h6 id="content-feature-graph"><span class="section-number-6">5.3.7.4.4.</span> Content-feature graph<a aria-hidden="true" href="#content-feature-graph">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-4-4">
<details id='generate-cfg' class='code' open><summary class='named'><span class="name">generate-cfg</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#generate-cfg'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-temp-buffer</span>
  (<span class="org-keyword">let</span> ((lambda-count 0)
        (regexp-count 0)
        (string-count 0)
        (nil-count 0)
        cond-names feats impl-names)
    (<span class="org-keyword">dolist</span> (cond-feats (org-export-get-all-feature-conditions (intern backend)))
      (<span class="org-keyword">dolist</span> (feat (cdr cond-feats))
        (<span class="org-keyword">let</span> ((cond-name
               (<span class="org-keyword">pcase</span> (car cond-feats)
                 ((<span class="org-keyword">and</span> (pred symbolp) f)
                  (symbol-name f))
                 ((<span class="org-keyword">and</span> (pred stringp) f)
                  (format <span class="org-string">"Regexp #%d"</span> (<span class="org-keyword">cl-incf</span> regexp-count)))
                 ((<span class="org-keyword">and</span> (pred functionp) f)
                  (format <span class="org-string">"&#955; #%d"</span> (<span class="org-keyword">cl-incf</span> lambda-count)))
                 (_ <span class="org-string">"???"</span>))))
          (<span class="org-keyword">push</span> cond-name cond-names)
          (<span class="org-keyword">push</span> feat feats)
          (insert (format <span class="org-string">"\"%s\" -&gt; \"%s\"\n"</span> cond-name feat)))))
    (<span class="org-keyword">dolist</span> (feat-impl (org-export-get-all-feature-implementations (intern backend)))
      (<span class="org-keyword">let</span> ((impl-name
             (<span class="org-keyword">pcase</span> (plist-get (cdr feat-impl) <span class="org-builtin">:snippet</span>)
               ((pred not)
                (format <span class="org-string">"nil #%d"</span> (<span class="org-keyword">cl-incf</span> nil-count)))
               ((<span class="org-keyword">and</span> (pred symbolp) imp)
                (symbol-name imp))
               ((pred stringp)
                (format <span class="org-string">"String #%d"</span> (<span class="org-keyword">cl-incf</span> string-count)))
               ((pred functionp)
                (format <span class="org-string">"&#955; #%d"</span> (<span class="org-keyword">cl-incf</span> lambda-count))))))
        (<span class="org-keyword">push</span> impl-name impl-names)
        (<span class="org-keyword">push</span> (car feat-impl) feats)
        (insert (format <span class="org-string">"\"%s\" -&gt; \"%s\"\n"</span> (car feat-impl) impl-name))
        (<span class="org-keyword">dolist</span> (req (ensure-list (plist-get (cdr feat-impl) <span class="org-builtin">:requires</span>)))
          (insert (format <span class="org-string">"\"%s\" -&gt; \"%s\" [color=\"#a991f1\" labelfontcolor=\"#a991f1\"]"</span> impl-name req)))
        (<span class="org-keyword">dolist</span> (prv (ensure-list (plist-get (cdr feat-impl) <span class="org-builtin">:prevents</span>)))
          (insert (format <span class="org-string">"\"%s\" -&gt; \"%s\" [color=\"#ff665c\" penwidth=\"0.9\" arrowhead=empty]"</span> impl-name prv)))
        (<span class="org-keyword">dolist</span> (whn (ensure-list (plist-get (cdr feat-impl) <span class="org-builtin">:when</span>)))
          (insert (format <span class="org-string">"\"%s\" -&gt; \"%s\" [style=\"dashed\" color=\"#4db5bd\" penwidth=\"0.9\" arrowhead=empty labelfontcolor=\"#4db5bd\" taillabel=\"%s\"]"</span> whn impl-name impl-name)))
        (<span class="org-keyword">dolist</span> (bfr (ensure-list (plist-get (cdr feat-impl) <span class="org-builtin">:before</span>)))
          (insert (format <span class="org-string">"\"%s\" -&gt; \"%s\" [style=\"dotted\" color=\"#fcce7b\" penwidth=\"1.4\" arrowhead=halfopen]"</span> impl-name bfr)))
        (<span class="org-keyword">dolist</span> (afr (ensure-list (plist-get (cdr feat-impl) <span class="org-builtin">:after</span>)))
          (insert (format <span class="org-string">"\"%s\" -&gt; \"%s\" [style=\"dotted\" color=\"#7bc275\" penwidth=\"1.4\" arrowhead=halfopen]"</span> afr impl-name)))))
    (goto-char (point-min))
    (insert (concat <span class="org-string">"subgraph cluster_0 {\n  peripheries=0\n  \""</span>
                    (string-join (nreverse cond-names) <span class="org-string">"\" [color=\"#e69055\"]\n  \""</span>)
                    <span class="org-string">"\" [color=\"#e69055\"]\n}\n"</span>)
            (concat <span class="org-string">"subgraph cluster_1 {\n  peripheries=0\n  \""</span>
                    (string-join (mapcar #'symbol-name (nreverse (delete-dups feats))) <span class="org-string">"\"\n  \""</span>)
                    <span class="org-string">"\"\n}\n"</span>)
            (concat <span class="org-string">"subgraph cluster_2 {\n  peripheries=0\n  \""</span>
                    (string-join (nreverse impl-names) <span class="org-string">"\" [color=\"#4db5bd\"]\n  \""</span>)
                    <span class="org-string">"\" [color=\"#4db5bd\"]\n}\n"</span>))
    )
  (buffer-string))
</pre>
</div>
</details>

<details id='content-feature-graph,code--1' class='code' open><summary><span class="lang">Graphviz</span></summary>
<div class='gutter'>
<a href='#content-feature-graph,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-dot">digraph {
    graph [bgcolor="transparent", ranksep="2.5"];
    node  [shape="underline" penwidth="2" style="rounded,filled" fillcolor="#efefef" color="#c9c9c9" fontcolor="#000000" fontname="Alegreya Sans"];
    edge  [color="#9ca0a4" penwidth="1.2" fontname="Alegreya Sans"]
    rankdir="LR"
    &lt;&lt;generate-cfg("beamer")&gt;&gt;
}
</pre>
</div>
</details>


<figure id="org982712f">
<img src="misc/ox-latex-cfg.svg" alt="ox-latex-cfg.svg" class="org-svg">

</figure>
</div>
</div>
<div id="outline-container-adding-xcolor-an" class="outline-6">
<h6 id="adding-xcolor-an"><span class="section-number-6">5.3.7.4.5.</span> Adding xcolor as an unconditional package<a aria-hidden="true" href="#adding-xcolor-an">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-4-5">
<p>
<kbd>xcolor</kbd> is just convenient to have.
</p>

<details id='adding-xcolor-an,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#adding-xcolor-an,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-latex-packages-alist
      '((<span class="org-string">""</span> <span class="org-string">"xcolor"</span> t)))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-font-collections" class="outline-5">
<h5 id="font-collections"><span class="section-number-5">5.3.7.5.</span> Font collections<a aria-hidden="true" href="#font-collections">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-5">
<p>
Using the lovely conditional preamble, I'll define a number of font collections
that can be used for LaTeX exports. Who knows, maybe I'll use it with other
export formats too at some point.
</p>

<p>
To start with I'll create a default state variable and register <kbd>fontset</kbd> as part
of <kbd>#+options</kbd>.
</p>

<details id='font-collections,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-collections,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-default-fontset</span> 'alegreya
  <span class="org-doc">"Fontset from `</span><span class="org-doc"><span class="org-constant">org-latex-fontsets</span></span><span class="org-doc">' to use by default.</span>
<span class="org-doc">As cm (computer modern) is TeX's default, that causes nothing</span>
<span class="org-doc">to be added to the document.</span>

<span class="org-doc">If \"nil\" no custom fonts will ever be used."</span>)

(eval '(cl-pushnew '(<span class="org-builtin">:latex-font-set</span> nil <span class="org-string">"fontset"</span> org-latex-default-fontset)
                   (org-export-backend-options (org-export-get-backend 'latex))))
</pre>
</div>
</details>

<p>
Then a function is needed to generate a LaTeX snippet which applies the fontset. It
would be nice if this could be done for individual styles and use different
styles as the main document font. If the individual typefaces for a fontset are
defined individually as
<code class="src src-elisp"><span class="org-builtin">:serif</span></code>, <code class="src src-elisp"><span class="org-builtin">:sans</span></code>, <code class="src src-elisp"><span class="org-builtin">:mono</span></code>, and <code class="src src-elisp"><span class="org-builtin">:maths</span></code>.
I can use those to generate LaTeX for subsets of the full fontset. Then, if I
don't let any fontset names have <kbd>-</kbd> in them, I can use <kbd>-sans</kbd> and <kbd>-mono</kbd> as
suffixes that specify the document font to use.
</p>

<details id='font-collections,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-collections,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-fontset-entry</span> ()
  <span class="org-doc">"Get the fontset spec of the current file.</span>
<span class="org-doc">Has format \"name\" or \"name-style\" where '</span><span class="org-doc"><span class="org-constant">name</span></span><span class="org-doc">' is one of</span>
<span class="org-doc">the cars in `</span><span class="org-doc"><span class="org-constant">org-latex-fontsets</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">let</span> ((fontset-spec
         (symbol-name
          (<span class="org-keyword">or</span> (car (delq nil
                         (mapcar
                          (<span class="org-keyword">lambda</span> (opt-line)
                            (plist-get (org-export--parse-option-keyword opt-line 'latex)
                                       <span class="org-builtin">:latex-font-set</span>))
                          (cdar (org-collect-keywords '(<span class="org-string">"OPTIONS"</span>))))))
              org-latex-default-fontset))))
    (cons (intern (car (split-string fontset-spec <span class="org-string">"-"</span>)))
          (<span class="org-keyword">when</span> (cadr (split-string fontset-spec <span class="org-string">"-"</span>))
            (intern (concat <span class="org-string">":"</span> (cadr (split-string fontset-spec <span class="org-string">"-"</span>))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-fontset</span> (<span class="org-type">&amp;rest</span> desired-styles)
  <span class="org-doc">"Generate a LaTeX preamble snippet which applies the current fontset for DESIRED-STYLES."</span>
  (<span class="org-keyword">let*</span> ((fontset-spec (org-latex-fontset-entry))
         (fontset (alist-get (car fontset-spec) org-latex-fontsets)))
    (<span class="org-keyword">if</span> fontset
        (string-trim
         (concat
          (mapconcat
           (<span class="org-keyword">lambda</span> (style)
             (<span class="org-keyword">when</span> (plist-get fontset style)
               (concat (plist-get fontset style) <span class="org-string">"\n"</span>)))
           desired-styles
           <span class="org-string">""</span>)
          (<span class="org-keyword">when</span> (memq (cdr fontset-spec) desired-styles)
            (<span class="org-keyword">pcase</span> (cdr fontset-spec)
              (<span class="org-builtin">:serif</span> <span class="org-string">"\\renewcommand{\\familydefault}{\\rmdefault}\n"</span>)
              (<span class="org-builtin">:sans</span> <span class="org-string">"\\renewcommand{\\familydefault}{\\sfdefault}\n"</span>)
              (<span class="org-builtin">:mono</span> <span class="org-string">"\\renewcommand{\\familydefault}{\\ttdefault}\n"</span>)))))
      (<span class="org-warning">error</span> <span class="org-string">"Font-set %s is not provided in org-latex-fontsets"</span> (car fontset-spec)))))
</pre>
</div>
</details>

<p>
Now that all the functionality has been implemented, we should hook it into our
preamble generation.
</p>

<details id='font-collections,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-collections,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">org-export-update-features</span> 'latex
  (custom-font
   <span class="org-builtin">:condition</span> org-latex-default-fontset
   <span class="org-builtin">:snippet</span> (org-latex-fontset <span class="org-builtin">:serif</span> <span class="org-builtin">:sans</span> <span class="org-builtin">:mono</span>)
   <span class="org-builtin">:order</span> 0)
  (custom-maths-font
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> (custom-font maths)
   <span class="org-builtin">:snippet</span> (org-latex-fontset <span class="org-builtin">:maths</span>)
   <span class="org-builtin">:after</span> (custom-font maths)
   <span class="org-builtin">:order</span> 0))
</pre>
</div>
</details>

<p>
Finally, we just need to add some fonts.
</p>

<details id='font-collections,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-collections,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-fontsets</span>
  '((cm nil) <span class="org-comment-delimiter">; </span><span class="org-comment">computer modern</span>
    (## nil) <span class="org-comment-delimiter">; </span><span class="org-comment">no font set</span>
    (alegreya
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage[osf]{Alegreya}"</span>
     <span class="org-builtin">:sans</span> <span class="org-string">"\\usepackage{AlegreyaSans}"</span>
     <span class="org-builtin">:mono</span> <span class="org-string">"\\usepackage[scale=0.88]{sourcecodepro}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\let\\Bbbk\\relax\n\\usepackage[varbb]{newpxmath}"</span>)
    (biolinum
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage[osf]{libertineRoman}"</span>
     <span class="org-builtin">:sans</span> <span class="org-string">"\\usepackage[sfdefault,osf]{biolinum}"</span>
     <span class="org-builtin">:mono</span> <span class="org-string">"\\usepackage[scale=0.88]{sourcecodepro}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\usepackage[libertine,varvw]{newtxmath}"</span>)
    (fira
     <span class="org-builtin">:sans</span> <span class="org-string">"\\usepackage[sfdefault,scale=0.85]{FiraSans}"</span>
     <span class="org-builtin">:mono</span> <span class="org-string">"\\usepackage[scale=0.80]{FiraMono}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\usepackage{newtxsf} % change to firamath in future?"</span>)
    (kp
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage{kpfonts}"</span>)
    (newpx
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage{newpxtext}"</span>
     <span class="org-builtin">:sans</span> <span class="org-string">"\\usepackage{gillius}"</span>
     <span class="org-builtin">:mono</span> <span class="org-string">"\\usepackage[scale=0.9]{sourcecodepro}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\let\\Bbbk\\relax\n\\usepackage[varbb]{newpxmath}"</span>)
    (noto
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage[osf]{noto-serif}"</span>
     <span class="org-builtin">:sans</span> <span class="org-string">"\\usepackage[osf]{noto-sans}"</span>
     <span class="org-builtin">:mono</span> <span class="org-string">"\\usepackage[scale=0.96]{noto-mono}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\usepackage{notomath}"</span>)
    (plex
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage{plex-serif}"</span>
     <span class="org-builtin">:sans</span> <span class="org-string">"\\usepackage{plex-sans}"</span>
     <span class="org-builtin">:mono</span> <span class="org-string">"\\usepackage[scale=0.95]{plex-mono}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\usepackage{newtxmath}"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">may be plex-based in future</span>
    (source
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage[osf,semibold]{sourceserifpro}"</span>
     <span class="org-builtin">:sans</span> <span class="org-string">"\\usepackage[osf,semibold]{sourcesanspro}"</span>
     <span class="org-builtin">:mono</span> <span class="org-string">"\\usepackage[scale=0.92]{sourcecodepro}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\usepackage{newtxmath}"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">may be sourceserifpro-based in future</span>
    (times
     <span class="org-builtin">:serif</span> <span class="org-string">"\\usepackage{newtxtext}"</span>
     <span class="org-builtin">:maths</span> <span class="org-string">"\\usepackage{newtxmath}"</span>))
  <span class="org-doc">"Alist of fontset specifications.</span>
<span class="org-doc">Each car is the name of the fontset (which cannot include \"-\").</span>

<span class="org-doc">Each cdr is a plist with (optional) keys :serif, :sans, :mono, and :maths.</span>
<span class="org-doc">A key's value is a LaTeX snippet which loads such a font."</span>)
</pre>
</div>
</details>

<p>
When we're using Alegreya we can apply a lovely little tweak to <kbd>tabular</kbd> which
(locally) changes the figures used to lining fixed-width.
</p>

<details id='font-collections,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-collections,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">org-export-update-features</span> 'latex
  (alegreya-typeface
   <span class="org-builtin">:condition</span> (string= (car (org-latex-fontset-entry)) <span class="org-string">"alegreya"</span>)
   <span class="org-builtin">:snippet</span> nil)
  (alegreya-tabular-figures
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> (alegreya-typeface table)
   <span class="org-builtin">:snippet</span> <span class="org-string">"\</span>
<span class="org-string">\\makeatletter</span>
<span class="org-string">% tabular lining figures in tables</span>
<span class="org-string">\\renewcommand{\\tabular}{\\AlegreyaTLF\\let\\@halignto\\@empty\\@tabular}</span>
<span class="org-string">\\makeatother"</span>
   <span class="org-builtin">:after</span> custom-font
   <span class="org-builtin">:order</span> 0.5))
</pre>
</div>
</details>

<p>
Due to Alegreya's metrics, the <kbd>\LaTeX</kbd> symbol doesn't quite look right. We
can correct for this by redefining it with subtlety shifted kerning.
</p>

<details id='font-collections,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#font-collections,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">org-export-update-features</span> 'latex
  (alegreya-latex-symbol
    <span class="org-builtin">:condition</span> <span class="org-string">"LaTeX"</span>
    <span class="org-builtin">:when</span> alegreya-typeface
    <span class="org-builtin">:snippet</span> <span class="org-string">"\</span>
<span class="org-string">\\makeatletter</span>
<span class="org-string">% Kerning around the A needs adjusting</span>
<span class="org-string">\\DeclareRobustCommand{\\LaTeX}{L\\kern-.24em%</span>
<span class="org-string">        {\\sbox\\z@ T%</span>
<span class="org-string">         \\vbox to\\ht\\z@{\\hbox{\\check@mathfonts</span>
<span class="org-string">                              \\fontsize\\sf@size\\z@</span>
<span class="org-string">                              \\math@fontsfalse\\selectfont</span>
<span class="org-string">                              A}%</span>
<span class="org-string">                        \\vss}%</span>
<span class="org-string">        }%</span>
<span class="org-string">        \\kern-.10em%</span>
<span class="org-string">        \\TeX}</span>
<span class="org-string">\\makeatother"</span>
    <span class="org-builtin">:after</span> alegreya-typeface
    <span class="org-builtin">:order</span> 0.5))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-maths-notation-conveniences" class="outline-5">
<h5 id="maths-notation-conveniences"><span class="section-number-5">5.3.7.6.</span> Maths notation conveniences<a aria-hidden="true" href="#maths-notation-conveniences">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-6">
<p>
Maths has a way of popping up relentlessly. I think this says something both
about me and the subject itself. While the LaTeX set of commands is quite
reasonable, we can make a few common bits of notation a tad more convenient.
</p>
</div>
<div id="outline-container-latex-export-maths" class="outline-6">
<h6 id="latex-export-maths"><span class="section-number-6">5.3.7.6.1.</span> Packages<a aria-hidden="true" href="#latex-export-maths">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-1">
<p>
First, there are a few useful packages we want to use.
</p>

<details id='packages,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#packages,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">%% </span><span class="org-comment">Maths-related packages</span>
<span class="org-comment-delimiter">% </span><span class="org-comment">More maths environments, commands, and symbols.</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">amsmath, amssymb</span>}
<span class="org-comment-delimiter">% </span><span class="org-comment">Slanted fractions with </span><span class="org-font-latex-sedate"><span class="org-comment">\sfrac</span></span><span class="org-comment">{a}{b}, in text and maths.</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">xfrac</span>}
<span class="org-comment-delimiter">% </span><span class="org-comment">Visually cancel expressions with </span><span class="org-font-latex-sedate"><span class="org-comment">\cancel</span></span><span class="org-comment">{value} and </span><span class="org-font-latex-sedate"><span class="org-comment">\cancelto</span></span><span class="org-comment">{expression}{value}</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>[<span class="org-variable-name">makeroom</span>]{<span class="org-function-name">cancel</span>}
<span class="org-comment-delimiter">% </span><span class="org-comment">Improvements on amsmath and utilities for mathematical typesetting</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">mathtools</span>}
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-custom-delimiters" class="outline-6">
<h6 id="custom-delimiters"><span class="section-number-6">5.3.7.6.2.</span> Custom delimiters<a aria-hidden="true" href="#custom-delimiters">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-2">
<p>
Next up we want to make the various types of rounding-related and absolute value
delimitors accessible as commands.
</p>

<details id='custom-delimiters,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#custom-delimiters,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">% </span><span class="org-comment">Deliminators</span>
<span class="org-font-latex-sedate">\DeclarePairedDelimiter</span>{<span class="org-font-latex-sedate">\abs</span>}{<span class="org-font-latex-sedate">\lvert</span>}{<span class="org-font-latex-sedate">\rvert</span>}
<span class="org-font-latex-sedate">\DeclarePairedDelimiter</span>{<span class="org-font-latex-sedate">\norm</span>}{<span class="org-font-latex-sedate">\lVert</span>}{<span class="org-font-latex-sedate">\rVert</span>}

<span class="org-font-latex-sedate">\DeclarePairedDelimiter</span>{<span class="org-font-latex-sedate">\ceil</span>}{<span class="org-font-latex-sedate">\lceil</span>}{<span class="org-font-latex-sedate">\rceil</span>}
<span class="org-font-latex-sedate">\DeclarePairedDelimiter</span>{<span class="org-font-latex-sedate">\floor</span>}{<span class="org-font-latex-sedate">\lfloor</span>}{<span class="org-font-latex-sedate">\rfloor</span>}
<span class="org-font-latex-sedate">\DeclarePairedDelimiter</span>{<span class="org-font-latex-sedate">\round</span>}{<span class="org-font-latex-sedate">\lfloor</span>}{<span class="org-font-latex-sedate">\rceil</span>}
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-number-sets" class="outline-6">
<h6 id="number-sets"><span class="section-number-6">5.3.7.6.3.</span> Number sets<a aria-hidden="true" href="#number-sets">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-3">
<p>
Then we have the various common number sets, it would be nice to have a
convenient way of typing them and optionally giving them powers. It's fairly
easy to support both <kbd>\XX</kbd> and <kbd>\XX[n]</kbd>.
</p>

<details id='number-sets,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#number-sets,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\RR</span></span>}[<span class="org-variable-name">1</span>][]{<span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\ensuremath</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\ifstrempty</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{#1}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{R}}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{R}</span></span><span class="org-font-latex-math"><span class="org-function-name"><span class="org-font-latex-script-char">^{#1}</span></span></span><span class="org-font-latex-math"><span class="org-function-name">}</span></span><span class="org-function-name">}</span>} <span class="org-comment">% Real numbers</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\NN</span></span>}[<span class="org-variable-name">1</span>][]{<span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\ensuremath</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\ifstrempty</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{#1}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{N}}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{N}</span></span><span class="org-font-latex-math"><span class="org-function-name"><span class="org-font-latex-script-char">^{#1}</span></span></span><span class="org-font-latex-math"><span class="org-function-name">}</span></span><span class="org-function-name">}</span>} <span class="org-comment">% Natural numbers</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\ZZ</span></span>}[<span class="org-variable-name">1</span>][]{<span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\ensuremath</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\ifstrempty</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{#1}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{Z}}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{Z}</span></span><span class="org-font-latex-math"><span class="org-function-name"><span class="org-font-latex-script-char">^{#1}</span></span></span><span class="org-font-latex-math"><span class="org-function-name">}</span></span><span class="org-function-name">}</span>} <span class="org-comment">% Integer numbers</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\QQ</span></span>}[<span class="org-variable-name">1</span>][]{<span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\ensuremath</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\ifstrempty</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{#1}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{Q}}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{Q}</span></span><span class="org-font-latex-math"><span class="org-function-name"><span class="org-font-latex-script-char">^{#1}</span></span></span><span class="org-font-latex-math"><span class="org-function-name">}</span></span><span class="org-function-name">}</span>} <span class="org-comment">% Rational numbers</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\CC</span></span>}[<span class="org-variable-name">1</span>][]{<span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\ensuremath</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\ifstrempty</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{#1}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{C}}{</span></span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{C}</span></span><span class="org-font-latex-math"><span class="org-function-name"><span class="org-font-latex-script-char">^{#1}</span></span></span><span class="org-font-latex-math"><span class="org-function-name">}</span></span><span class="org-function-name">}</span>} <span class="org-comment">% Complex numbers</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-derivatives" class="outline-6">
<h6 id="derivatives"><span class="section-number-6">5.3.7.6.4.</span> Derivatives<a aria-hidden="true" href="#derivatives">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-4">
<p>
Derivatives are actually a bit of a pain to typeset, it would be nice to have a
<kbd>\dv</kbd> command that supports:
</p>
<ul class="org-ul">
<li><kbd>\dv{x}</kbd> for the derivative with respect to <kbd>x</kbd></li>
<li><kbd>\dv{f}{x}</kbd> for the derivative of <kbd>f</kbd> with respect to <kbd>x</kbd></li>
<li><kbd>\dv[2]{f}{x}</kbd> for the second order derivative of <kbd>f</kbd> with respect to <kbd>x</kbd></li>
</ul>

<p>
Similarly, it would be nice to have a partial derivate counterpart <kbd>\pdv</kbd> which
behaves in a similar way, but with the possibility of providing multiple
comma-delimited variables &#x2014; e.g. <kbd>\pdv{f}{x,y,z}</kbd>.
</p>

<details id='derivatives,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#derivatives,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">% </span><span class="org-comment">Easy derivatives</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\ProvideDocumentCommand</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\dv</span></span>{<span class="org-function-name">o m g</span>}{<span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\IfNoValueTF</span></span><span class="org-function-name">{#3}{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\dv</span></span><span class="org-function-name">[#1]{}{#2}}{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\IfNoValueTF</span></span><span class="org-function-name">{#1}{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\frac</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\dd</span></span><span class="org-function-name"> #2}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\dd</span></span><span class="org-function-name"> #3}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    }{</span><span class="org-font-latex-sedate"><span class="org-function-name">\frac</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\dd</span></span><span class="org-function-name">[#1] #2}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\dd</span></span><span class="org-function-name"> {#3}^{#1}}}}</span>}
<span class="org-comment-delimiter">% </span><span class="org-comment">Easy partial derivatives</span>
<span class="org-font-latex-sedate">\ExplSyntaxOn</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\ProvideDocumentCommand</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\pdv</span></span>{<span class="org-function-name">o m g</span>}{<span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\IfNoValueTF</span></span><span class="org-function-name">{#3}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\pdv</span></span><span class="org-function-name">[#1]{}{#2}}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">  {</span><span class="org-font-latex-sedate"><span class="org-function-name">\ifnum\clist</span></span><span class="org-function-name">_count:n{#3}&lt;2</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\IfValueTF</span></span><span class="org-function-name">{#1}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\frac</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\partial</span></span><span class="org-function-name">^{#1} #2}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\partial</span></span><span class="org-function-name"> {#3}^{#1}}}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\frac</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\partial</span></span><span class="org-function-name"> #2}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\partial</span></span><span class="org-function-name"> #3}}</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\else</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\frac</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\IfValueTF</span></span><span class="org-function-name">{#1}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\partial</span></span><span class="org-function-name">^{#1}}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\partial</span></span><span class="org-function-name">^{</span><span class="org-font-latex-sedate"><span class="org-function-name">\clist</span></span><span class="org-function-name">_count:n{#3}}}#2}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\clist</span></span><span class="org-function-name">_map_inline:nn{#3}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\partial</span></span><span class="org-function-name"> ##1 \,}</span><span class="org-font-latex-sedate"><span class="org-function-name">\!</span></span><span class="org-function-name">}</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\fi</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate">\ExplSyntaxOff</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-common-operators" class="outline-6">
<h6 id="common-operators"><span class="section-number-6">5.3.7.6.5.</span> Common operators<a aria-hidden="true" href="#common-operators">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-5">
<p>
The default set of operators could benefit from a bit of expansion.
</p>

<details id='common-operators,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#common-operators,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">% </span><span class="org-comment">Laplacian</span>
<span class="org-font-latex-sedate">\DeclareMathOperator</span>{<span class="org-font-latex-sedate">\Lap</span>}{<span class="org-font-latex-sedate">\mathcal</span>{L}}

<span class="org-comment-delimiter">% </span><span class="org-comment">Statistics</span>
<span class="org-font-latex-sedate">\DeclareMathOperator</span>{<span class="org-font-latex-sedate">\Var</span>}{Var} <span class="org-comment">% varience</span>
<span class="org-font-latex-sedate">\DeclareMathOperator</span>{<span class="org-font-latex-sedate">\Cov</span>}{Cov} <span class="org-comment">% covarience</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\EE</span></span>}{<span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\ensuremath</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-font-latex-math"><span class="org-function-name">\mathbb</span></span></span><span class="org-font-latex-math"><span class="org-function-name">{E}</span></span><span class="org-function-name">}</span>} <span class="org-comment">% expected value</span>
<span class="org-font-latex-sedate">\DeclareMathOperator</span>{<span class="org-font-latex-sedate">\E</span>}{E} <span class="org-comment">% expected value</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-slanted-inequalities" class="outline-6">
<h6 id="slanted-inequalities"><span class="section-number-6">5.3.7.6.6.</span> Slanted inequalities<a aria-hidden="true" href="#slanted-inequalities">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-6">
<p>
As a matter of personal taste, I prefer the slanted less/greater than or equal
to operators, and would like to use them by default.
</p>

<details id='slanted-inequalities,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#slanted-inequalities,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">% </span><span class="org-comment">I prefer the slanted </span><span class="org-font-latex-sedate"><span class="org-comment">\leq</span></span><span class="org-comment">/</span><span class="org-font-latex-sedate"><span class="org-comment">\geq</span></span>
<span class="org-font-latex-sedate">\let\barleq\leq</span> <span class="org-comment">% Save them in case they're every wanted</span>
<span class="org-font-latex-sedate">\let\bargeq\geq</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\leq</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\leqslant</span></span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\geq</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\geqslant</span></span>}
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-alignment-matrix-columns" class="outline-6">
<h6 id="alignment-matrix-columns"><span class="section-number-6">5.3.7.6.7.</span> Alignment of matrix columns<a aria-hidden="true" href="#alignment-matrix-columns">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-7">
<p>
By default, everything in a matrix is centred, which I actually find often
undesirable. It would be much nicer to take the alignment as an optional
argument of the environment, and default to right-alignment.
</p>

<details id='alignment-matrix-columns,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#alignment-matrix-columns,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">% </span><span class="org-comment">Redefine the matrix environment to allow for alignment</span>
<span class="org-comment-delimiter">% </span><span class="org-comment">via an optional argument, and use r as the default.</span>
<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatletter</span></span>
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-keyword">*</span><span class="org-font-latex-sedate"><span class="org-function-name">\env@matrix</span></span>[<span class="org-variable-name">1</span>][<span class="org-variable-name">r</span>]{<span class="org-font-latex-sedate"><span class="org-function-name">\hskip</span></span><span class="org-function-name"> -</span><span class="org-font-latex-sedate"><span class="org-function-name">\arraycolsep</span></span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\let\@ifnextchar\new@ifnextchar</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\array</span></span><span class="org-function-name">{*</span><span class="org-font-latex-sedate"><span class="org-function-name">\c@MaxMatrixCols</span></span><span class="org-function-name"> #1}</span>}
<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatother</span></span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-slanted-derivative-d" class="outline-6">
<h6 id="slanted-derivative-d"><span class="section-number-6">5.3.7.6.8.</span> Slanted derivative "d"<a aria-hidden="true" href="#slanted-derivative-d">#</a> </h6>
<div class="outline-text-6" id="text-5-3-7-6-8">
<p>
Determining an appropriate styling for a derivative "d" (e.g. "dx") is
surprisingly hard, as the "d" is neither:
</p>
<ul class="org-ul">
<li>An operator (which are typeset as upright roman)</li>
<li>A variable (which are typeset as italic roman)</li>
</ul>

<p>
The <span class='acr'>ISO</span> 80000-2 standard (2009) specifies that it should be upright, however (a)
it is still not an operator, (b) not used in any maths book I've seen, and (c)
doesn't look very good. I'm not entirely comfortable with the variable styling
either though, so perhaps something else is in order?
</p>

<p>
After trying a few different options, I rather like the idea of using a <i>slanted
roman "d"</i>. This stylistically works for me, while being just distinct enough
from other faces. As long as we are creating a <span class='acr'>PDF</span>, we can apply a transform
that slants a "d".
</p>

<details id='slanted-derivative-d,code--1' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#slanted-derivative-d,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">% </span><span class="org-comment">Slanted roman "d" for derivatives</span>
<span class="org-font-latex-sedate">\ifcsname</span> pdfoutput<span class="org-font-latex-sedate">\endcsname</span>
  <span class="org-font-latex-sedate">\ifnum\pdfoutput</span>&gt;0 <span class="org-comment">% PDF</span>
    <span class="org-font-latex-sedate"><span class="org-keyword">\newsavebox</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\diffdbox</span></span>{}
    <span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\slantedromand</span></span>}{<span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\mathpalette\makesl</span></span><span class="org-function-name">{d}}</span>}
    <span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\makesl</span></span>}[<span class="org-variable-name">2</span>]{<span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\begingroup</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\sbox</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\diffdbox</span></span><span class="org-function-name">}{</span><span class="org-function-name"><span class="org-font-latex-math">$</span></span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-font-latex-math">\mathsurround</span></span></span><span class="org-function-name"><span class="org-font-latex-math">=0pt#1</span></span><span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name"><span class="org-font-latex-math">\mathrm</span></span></span></span><span class="org-function-name"><span class="org-font-latex-math">{</span></span><span class="org-type"><span class="org-function-name"><span class="org-font-latex-math">#2</span></span></span><span class="org-function-name"><span class="org-font-latex-math">}$</span></span><span class="org-function-name">}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\pdfsave</span></span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\pdfsetmatrix</span></span><span class="org-function-name">{1 0 0.2 1}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\rlap</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\usebox</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\diffdbox</span></span><span class="org-function-name">}}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\pdfrestore</span></span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\hskip\wd\diffdbox</span></span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\endgroup</span></span>}
  <span class="org-font-latex-sedate">\else</span> <span class="org-comment">% DVI</span>
    <span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\slantedromand</span></span>}{<span class="org-function-name">d</span>} <span class="org-comment">% fallback</span>
  <span class="org-font-latex-sedate">\fi</span>
<span class="org-font-latex-sedate">\else</span> <span class="org-comment">% Also DVI</span>
  <span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\slantedromand</span></span>}{<span class="org-function-name">d</span>} <span class="org-comment">% fallback</span>
<span class="org-font-latex-sedate">\fi</span>
</pre>
</div>
</details>

<p>
Now there's the matter of <i>placing</i> the "d", or rather adjusting the space around
it. After much fiddling, I've ended up with the following.
</p>

<details id='slanted-derivative-d,code--2' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#slanted-derivative-d,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-comment-delimiter">% </span><span class="org-comment">Derivative d^n, nicely spaced</span>
<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatletter</span></span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\dd</span></span>}[<span class="org-variable-name">1</span>][]{<span class="org-font-latex-sedate"><span class="org-function-name">\mathop</span></span><span class="org-function-name">{}</span><span class="org-font-latex-sedate"><span class="org-function-name">\!</span></span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\expandafter\ifx\expandafter</span></span><span class="org-function-name"><span class="org-font-latex-warning">&amp;</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\detokenize</span></span><span class="org-function-name">{#1}</span><span class="org-function-name"><span class="org-font-latex-warning">&amp;</span></span><span class="org-function-name"><span class="org-comment">% </span></span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-comment">\ifstrempty</span></span></span><span class="org-function-name"><span class="org-comment"> from etoolbox</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\slantedromand\@ifnextchar</span></span><span class="org-function-name">^{</span><span class="org-font-latex-sedate"><span class="org-function-name">\hspace</span></span><span class="org-function-name">{0.2ex}}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\hspace</span></span><span class="org-function-name">{0.1ex}}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\else</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\slantedromand\hspace</span></span><span class="org-function-name">{0.2ex}^{#1}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\fi</span></span>}
<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatother</span></span>
</pre>
</div>
</details>

<p>
While <kbd>\dd</kbd> isn't much effort to type, it would be much cleaner to be able to do
. The problem with defining <kbd>\d</kbd> is that it is already used
for the under-dot accent. However, since this is a text-mode (only) accent, and
defined with instead of
we can redefine the command to mean <kbd>\dd</kbd> in
math-mode.
</p>

<details id='slanted-derivative-d,code--3' class='code' open><summary><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#slanted-derivative-d,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\NewCommandCopy</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\daccent</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\d</span></span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\d</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\ifmmode\dd\else\daccent\fi</span></span>}
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-cover-page" class="outline-5">
<h5 id="cover-page"><span class="section-number-5">5.3.7.7.</span> Cover page<a aria-hidden="true" href="#cover-page">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-7">
<p>
To make a nice cover page, a simple method that comes to mind is just redefining
<kbd>\maketitle</kbd>. To get precise control over the positioning we'll use the <kbd>tikz</kbd>
package, and then add in the Tikz libraries <kbd>calc</kbd> and <kbd>shapes.geometric</kbd> to make
some nice decorations for the background.
</p>

<p>
I'll start off by setting up the required additions to the preamble.
This will accomplish the following:
</p>
<ul class="org-ul">
<li>Load the required packages</li>
<li>Redefine <kbd>\maketitle</kbd></li>
<li>Draw an Org icon with Tikz to use in the cover page (it's a little easter egg)</li>
<li>Start a new page after the table of contents by redefining <kbd>\tableofcontents</kbd></li>
</ul>

<details id='latex-cover-page' class='code' open><summary class='named'><span class="name">latex-cover-page</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-cover-page'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">tikz</span>}
<span class="org-font-latex-sedate">\usetikzlibrary</span>{shapes.geometric}
<span class="org-font-latex-sedate">\usetikzlibrary</span>{calc}

<span class="org-font-latex-sedate"><span class="org-keyword">\newsavebox</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\orgicon</span></span>
<span class="org-font-latex-sedate"><span class="org-keyword">\begin</span></span>{<span class="org-function-name">lrbox</span>}{<span class="org-font-latex-sedate">\orgicon</span>}
  <span class="org-font-latex-sedate"><span class="org-keyword">\begin</span></span>{<span class="org-function-name">tikzpicture</span>}[y=0.80pt, x=0.80pt, inner sep=0pt, outer sep=0pt]
    <span class="org-font-latex-sedate">\path</span>[fill=black!6] (16.15,24.00) .. controls (15.58,24.00) and (13.99,20.69) .. (12.77,18.06)arc(215.55:180.20:2.19) .. controls (12.33,19.91) and (11.27,19.09) .. (11.43,18.05) .. controls (11.36,18.09) and (10.17,17.83) .. (10.17,17.82) .. controls (9.94,18.75) and (9.37,19.44) .. (9.02,18.39) .. controls (8.32,16.72) and (8.14,15.40) .. (9.13,13.80) .. controls (8.22,9.74) and (2.18,7.75) .. (2.81,4.47) .. controls (2.99,4.47) and (4.45,0.99) .. (9.15,2.41) .. controls (14.71,3.99) and (17.77,0.30) .. (18.13,0.04) .. controls (18.65,-0.49) and (16.78,4.61) .. (12.83,6.90) .. controls (10.49,8.18) and (11.96,10.38) .. (12.12,11.15) .. controls (12.12,11.15) and (14.00,9.84) .. (15.36,11.85) .. controls (16.58,11.53) and (17.40,12.07) .. (18.46,11.69) .. controls (19.10,11.41) and (21.79,11.58) .. (20.79,13.08) .. controls (20.79,13.08) and (21.71,13.90) .. (21.80,13.99) .. controls (21.97,14.75) and (21.59,14.91) .. (21.47,15.12) .. controls (21.44,15.60) and (21.04,15.79) .. (20.55,15.44) .. controls (19.45,15.64) and (18.36,15.55) .. (17.83,15.59) .. controls (16.65,15.76) and (15.67,16.38) .. (15.67,16.38) .. controls (15.40,17.19) and (14.82,17.01) .. (14.09,17.32) .. controls (14.70,18.69) and (14.76,19.32) .. (15.50,21.32) .. controls (15.76,22.37) and (16.54,24.00) .. (16.15,24.00) -- cycle(7.83,16.74) .. controls (6.83,15.71) and (5.72,15.70) .. (4.05,15.42) .. controls (2.75,15.19) and (0.39,12.97) .. (0.02,10.68) .. controls (-0.02,10.07) and (-0.06,8.50) .. (0.45,7.18) .. controls (0.94,6.05) and (1.27,5.45) .. (2.29,4.85) .. controls (1.41,8.02) and (7.59,10.18) .. (8.55,13.80) -- (8.55,13.80) .. controls (7.73,15.00) and (7.80,15.64) .. (7.83,16.74) -- cycle;
  <span class="org-font-latex-sedate"><span class="org-keyword">\end</span></span>{<span class="org-function-name">tikzpicture</span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\end</span></span>{<span class="org-function-name">lrbox</span>}

<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatletter</span></span>
<span class="org-font-latex-sedate">\g@addto@macro</span><span class="org-font-latex-sedate"><span class="org-keyword">\tableofcontents</span></span>{<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\clearpage</span></span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\maketitle</span></span>{
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\thispagestyle</span></span><span class="org-function-name">{empty}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\hyphenpenalty</span></span><span class="org-function-name">=10000 </span><span class="org-function-name"><span class="org-comment">% hyphens look bad in titles</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\renewcommand</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselinestretch</span></span><span class="org-function-name">}{1.1}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\NewCommandCopy</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\oldtoday</span></span><span class="org-function-name">}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\today</span></span><span class="org-function-name">}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\renewcommand</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\today</span></span><span class="org-function-name">}{</span><span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\LARGE</span></span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\number\year</span></span></span><span class="org-type"><span class="org-function-name"><span class="org-font-latex-warning">\\</span></span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\large</span></span></span><span class="org-type"><span class="org-function-name"><span class="org-comment">%</span></span></span>
<span class="org-type"><span class="org-function-name">    </span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\ifcase</span></span></span><span class="org-type"><span class="org-function-name"> </span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\month</span></span></span><span class="org-type"><span class="org-function-name"> </span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Jan</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Feb</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Mar</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Apr</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> May </span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Jun</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Jul</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Aug</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Sep</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Oct</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Nov</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\or</span></span></span><span class="org-type"><span class="org-function-name"> Dec</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\fi</span></span></span>
<span class="org-type"><span class="org-function-name">    ~</span></span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\number\day</span></span></span><span class="org-function-name">}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\begin</span></span><span class="org-function-name">{tikzpicture}[remember picture,overlay]</span>
<span class="org-function-name">    </span><span class="org-function-name"><span class="org-comment-delimiter">%% </span></span><span class="org-function-name"><span class="org-comment">Background Polygons %%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\foreach</span></span><span class="org-function-name"> </span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> in {2.5,...,22} </span><span class="org-function-name"><span class="org-comment">% bottom left</span></span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[rounded corners,black!3.5,draw,regular polygon,regular polygon sides=6, minimum size=</span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> cm,ultra thick] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.west)+(2.5,-4.2)$</span></span><span class="org-function-name">) {} ;}</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\foreach</span></span><span class="org-function-name"> </span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> in {0.5,...,22} </span><span class="org-function-name"><span class="org-comment">% top left</span></span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[rounded corners,black!5,draw,regular polygon,regular polygon sides=6, minimum size=</span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> cm,ultra thick] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.north west)+(2.5,2)$</span></span><span class="org-function-name">) {} ;}</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[rounded corners,fill=black!4,regular polygon,regular polygon sides=6, minimum size=5.5 cm,ultra thick] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.north west)+(2.5,2)$</span></span><span class="org-function-name">) {};</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\foreach</span></span><span class="org-function-name"> </span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> in {0.5,...,24} </span><span class="org-function-name"><span class="org-comment">% top right</span></span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[rounded corners,black!2,draw,regular polygon,regular polygon sides=6, minimum size=</span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> cm,ultra thick] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.north east)+(0,-8.5)$</span></span><span class="org-function-name">) {} ;}</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2.5 cm,ultra thick] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.north east)+(0,-8.5)$</span></span><span class="org-function-name">) {};</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\foreach</span></span><span class="org-function-name"> </span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> in {21,...,3} </span><span class="org-function-name"><span class="org-comment">% bottom right</span></span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[black!3,rounded corners,draw,regular polygon,regular polygon sides=6, minimum size=</span><span class="org-font-latex-sedate"><span class="org-function-name">\i</span></span><span class="org-function-name"> cm,ultra thick] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.south east)+(-1.5,0.75)$</span></span><span class="org-function-name">) {} ;}</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2 cm,ultra thick] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.south east)+(-1.5,0.75)$</span></span><span class="org-function-name">) {};</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[align=center, scale=1.4] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.south east)+(-1.5,0.75)$</span></span><span class="org-function-name">) {</span><span class="org-font-latex-sedate"><span class="org-function-name">\usebox\orgicon</span></span><span class="org-function-name">};</span>
<span class="org-function-name">    </span><span class="org-function-name"><span class="org-comment-delimiter">%% </span></span><span class="org-function-name"><span class="org-comment">Text %%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[left, align=right, black, text width=0.8</span><span class="org-font-latex-sedate"><span class="org-function-name">\paperwidth</span></span><span class="org-function-name">, minimum height=3cm, rounded corners,font=</span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\Huge</span></span></span><span class="org-font-latex-sedate"><span class="org-font-latex-bold"><span class="org-function-name">\bfseries</span></span></span><span class="org-function-name">] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.north east)+(-2,-8.5)$</span></span><span class="org-function-name">)</span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\@title</span></span><span class="org-function-name">};</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[left, align=right, black, text width=0.8</span><span class="org-font-latex-sedate"><span class="org-function-name">\paperwidth</span></span><span class="org-function-name">, minimum height=2cm, rounded corners, font=</span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\Large</span></span></span><span class="org-function-name">] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.north east)+(-2,-11.8)$</span></span><span class="org-function-name">)</span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-keyword"><span class="org-function-name">\scshape</span></span></span><span class="org-font-latex-bold"><span class="org-function-name"> </span></span><span class="org-font-latex-sedate"><span class="org-font-latex-bold"><span class="org-function-name">\@author</span></span></span><span class="org-function-name">};</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\renewcommand</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\baselinestretch</span></span><span class="org-function-name">}{0.75}</span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\node</span></span><span class="org-function-name">[align=center,rounded corners,fill=black!3,text=black,regular polygon,regular polygon sides=6, minimum size=2.5 cm,inner sep=0, font=</span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\Large</span></span></span><span class="org-font-latex-sedate"><span class="org-font-latex-bold"><span class="org-function-name">\bfseries</span></span></span><span class="org-function-name"> ] at (</span><span class="org-function-name"><span class="org-font-latex-math">$(current page.west)+(2.5,-4.2)$</span></span><span class="org-function-name">)</span>
<span class="org-function-name">    {</span><span class="org-font-latex-sedate"><span class="org-function-name">\@date</span></span><span class="org-function-name">};</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\end</span></span><span class="org-function-name">{tikzpicture}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\let\today\oldtoday</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-font-latex-warning">\clearpage</span></span></span>}
<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatother</span></span>
</pre>
</div>
</details>

<p>
Now we've got a nice cover page to work with, we just need to use it every now
and then. Adding this to <kbd>#+options</kbd> feels most appropriate.
Let's have the <kbd>coverpage</kbd> option accept <kbd>auto</kbd> as a value and then decide whether
or not a cover page should be used based on the word count &#x2014; I'll have this be
the global default. Then we just want to insert a LaTeX snippet tweak the
subtitle format to use the cover page.
</p>

<details id='cover-page,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#cover-page,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-cover-page</span> 'auto
  <span class="org-doc">"When t, use a cover page by default.</span>
<span class="org-doc">When auto, use a cover page when the document's wordcount exceeds</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">org-latex-cover-page-wordcount-threshold</span></span><span class="org-doc">'.</span>

<span class="org-doc">Set with #+option: coverpage:{yes,auto,no} in org buffers."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-cover-page-wordcount-threshold</span> 5000
  <span class="org-doc">"Document word count at which a cover page will be used automatically.</span>
<span class="org-doc">This condition is applied when cover page option is set to auto."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-subtitle-coverpage-format</span> <span class="org-string">"\\\\\\bigskip\n\\LARGE\\mdseries\\itshape\\color{black!80} %s\\par"</span>
  <span class="org-doc">"Variant of `</span><span class="org-doc"><span class="org-constant">org-latex-subtitle-format</span></span><span class="org-doc">' to use with the cover page."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-cover-page-maketitle</span>
  &lt;&lt;grab(<span class="org-string">"latex-cover-page"</span>)&gt;&gt;
  <span class="org-string">"LaTeX preamble snippet that sets \\maketitle to produce a cover page."</span>)

(eval '(cl-pushnew '(<span class="org-builtin">:latex-cover-page</span> nil <span class="org-string">"coverpage"</span> org-latex-cover-page)
                   (org-export-backend-options (org-export-get-backend 'latex))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-cover-page-p</span> ()
  <span class="org-doc">"Whether a cover page should be used when exporting this Org file."</span>
  (<span class="org-keyword">pcase</span> (<span class="org-keyword">or</span> (car
              (delq nil
                    (mapcar
                     (<span class="org-keyword">lambda</span> (opt-line)
                       (plist-get (org-export--parse-option-keyword opt-line 'latex) <span class="org-builtin">:latex-cover-page</span>))
                     (cdar (org-collect-keywords '(<span class="org-string">"OPTIONS"</span>))))))
             org-latex-cover-page)
    ((<span class="org-keyword">or</span> 't 'yes) t)
    ('auto (<span class="org-keyword">when</span> (&gt; (count-words (point-min) (point-max)) org-latex-cover-page-wordcount-threshold) t))
    (_ nil)))

(<span class="org-keyword">defadvice!</span> org-latex-set-coverpage-subtitle-format-a (contents info)
  <span class="org-doc">"Set the subtitle format when a cover page is being used."</span>
  <span class="org-builtin">:before</span> #'org-latex-template
  (<span class="org-keyword">when</span> (org-latex-cover-page-p)
    (<span class="org-keyword">setf</span> info (plist-put info <span class="org-builtin">:latex-subtitle-format</span> org-latex-subtitle-coverpage-format))))

(<span class="org-keyword">org-export-update-features</span> 'latex
  (cover-page
   <span class="org-builtin">:condition</span> (org-latex-cover-page-p)
   <span class="org-builtin">:snippet</span> org-latex-cover-page-maketitle
   <span class="org-builtin">:order</span> 9))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-condensed-lists" class="outline-5">
<h5 id="condensed-lists"><span class="section-number-5">5.3.7.8.</span> Condensed lists<a aria-hidden="true" href="#condensed-lists">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-8">
<p>
LaTeX is generally pretty good by default, but it's <i>really</i> generous with how
much space it puts between list items by default. I'm generally not a fan.
</p>

<p>
Thankfully this is easy to correct with a small snippet:
</p>
<details id='latex-condense-lists' class='code' open><summary class='named'><span class="name">latex-condense-lists</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-condense-lists'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\setuplistspacing</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-keyword">\setlength</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-variable-name">\itemsep</span></span></span><span class="org-function-name">}{</span><span class="org-function-name"><span class="org-variable-name">-0.5ex</span></span><span class="org-function-name">}</span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-keyword">\setlength</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-variable-name">\parskip</span></span></span><span class="org-function-name">}{</span><span class="org-function-name"><span class="org-variable-name">1.5ex</span></span><span class="org-function-name">}</span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-keyword">\setlength</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-variable-name">\parsep</span></span></span><span class="org-function-name">}{</span><span class="org-function-name"><span class="org-variable-name">0pt</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate">\let\olditem\itemize</span><span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\itemize</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\olditem\setuplistspacing</span></span>}
<span class="org-font-latex-sedate">\let\oldenum\enumerate</span><span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\enumerate</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\oldenum\setuplistspacing</span></span>}
<span class="org-font-latex-sedate">\let\olddesc\description</span><span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\description</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\olddesc\setuplistspacing</span></span>}
</pre>
</div>
</details>

<p>
Then we can just hook this in with our clever preamble.
</p>

<details id='condensed-lists,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#condensed-lists,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-condense-lists</span> t
  <span class="org-doc">"Reduce the space between list items."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-condensed-lists</span>
  &lt;&lt;grab(<span class="org-string">"latex-condense-lists"</span>)&gt;&gt;
  <span class="org-string">"LaTeX preamble snippet that reduces the space between list items."</span>)

(<span class="org-keyword">org-export-update-features</span> 'latex
  (condensed-lists
   <span class="org-builtin">:condition</span> (<span class="org-keyword">and</span> org-latex-condense-lists <span class="org-string">"^[ \t]*[-+]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[ \t]*[1Aa][.)] "</span>)
   <span class="org-builtin">:snippet</span> org-latex-condensed-lists
   <span class="org-builtin">:order</span> 0.7))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-upright-parentheses-italic" class="outline-5">
<h5 id="upright-parentheses-italic"><span class="section-number-5">5.3.7.9.</span> Upright parentheses in italic text<a aria-hidden="true" href="#upright-parentheses-italic">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-9">
<p>
<span class='acr'>TODO</span>, see <a href="https://tex.stackexchange.com/a/13057/167605">https://tex.stackexchange.com/a/13057/167605</a>
</p>
</div>
</div>
<div id="outline-container-pretty-code-blocks" class="outline-5">
<h5 id="pretty-code-blocks"><span class="section-number-5">5.3.7.10.</span> Pretty code blocks<a aria-hidden="true" href="#pretty-code-blocks">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-10">
<p>
We could just use minted for syntax highlighting &#x2014; however, we can do better!
The <kbd>engrave-faces</kbd> package lets us use Emacs' font-lock for syntax highlighting,
exporting that as LaTeX commands.
</p>

<details id='pretty-code-blocks,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#pretty-code-blocks,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> engrave-faces <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/engrave-faces"</span>))
</pre>
</div>
</details>

<details id='pretty-code-blocks,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#pretty-code-blocks,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! engrave-faces-latex
  <span class="org-builtin">:after</span> ox-latex)
</pre>
</div>
</details>

<p>
Using this as in LaTeX exports is now as easy as
</p>

<details id='pretty-code-blocks,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#pretty-code-blocks,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-latex-listings 'engraved
      org-latex-engraved-theme 'doom-one-light)
</pre>
</div>
</details>

<p>
One little annoyance with this is the interaction between microtype and <kbd>Verbatim</kbd>
environments. Protrusion is not desirable here. Thankfully, we can patch the
<kbd>Verbatim</kbd> environment to turn off protrusion locally.
</p>

<details id='pretty-code-blocks,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#pretty-code-blocks,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">org-export-update-features</span> 'latex
  (no-protrusion-in-code
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> (microtype engraved-code)
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\ifcsname Code\\endcsname\n  \\let\\oldcode\\Code\\renewcommand{\\Code}{\\microtypesetup{protrusion=false}\\oldcode}\n\\fi"</span>
   <span class="org-builtin">:after</span> (engraved-code microtype)))
</pre>
</div>
</details>

<p>
At some point it would be nice to make the box colours easily customisable. At
the moment it's fairly easy to change the syntax highlighting colours with
<code class="src src-elisp">(<span class="org-keyword">setq</span> engrave-faces-preset-styles (engrave-faces-generate-preset))</code>,
but perhaps a toggle which specifies whether to use the default values, the
current theme, or any named theme could be a good idea. It should also possible
to set the box background dynamically to match. The named theme could work by
looking for a style definition with a certain name in a cache dir, and then
switching to that theme and producing (and saving) the style definition if it
doesn't exist.
</p>

<p>
Now let's have the example block be styled similarly.
</p>

<details id='pretty-code-blocks,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#pretty-code-blocks,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-latex-example-block-engraved (orig-fn example-block contents info)
  <span class="org-doc">"Like `</span><span class="org-doc"><span class="org-constant">org-latex-example-block</span></span><span class="org-doc">', but supporting an engraved backend"</span>
  <span class="org-builtin">:around</span> #'org-latex-example-block
  (<span class="org-keyword">let</span> ((output-block (funcall orig-fn example-block contents info)))
    (<span class="org-keyword">if</span> (eq 'engraved (plist-get info <span class="org-builtin">:latex-listings</span>))
        (format <span class="org-string">"\\begin{Code}[alt]\n%s\n\\end{Code}"</span> output-block)
      output-block)))
</pre>
</div>
</details>

<p>
In addition to the vastly superior visual output, this should also be much
faster to compile for code-heavy documents (like this config).
</p>

<p>
Performing a little benchmark with this document, I find that this is indeed the
case.
</p>

<div id='pretty-code-blocks,table--1' class='table'>
<div class='gutter'><a href='#pretty-code-blocks,table--1'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">LaTeX syntax highlighting backend</th>
<th scope="col" class="org-left">Compile time</th>
<th scope="col" class="org-left">Overhead</th>
<th scope="col" class="org-right">Overhead ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">verbatim</td>
<td class="org-left">12 s</td>
<td class="org-left">0</td>
<td class="org-right">0.0</td>
</tr>

<tr>
<td class="org-left">lstlistings</td>
<td class="org-left">15 s</td>
<td class="org-left">3 s</td>
<td class="org-right">0.2</td>
</tr>

<tr>
<td class="org-left">Engrave</td>
<td class="org-left">34 s</td>
<td class="org-left">22 s</td>
<td class="org-right">1.8</td>
</tr>

<tr>
<td class="org-left">Pygments (Minted)</td>
<td class="org-left">184 s</td>
<td class="org-left">172 s</td>
<td class="org-right">14.3</td>
</tr>
</tbody>
</table>
</div></div>

<p>
Treating the verbatim (no syntax highlighting) result as a baseline; this
rudimentary test suggest that <kbd>engrave-faces</kbd> is around eight times faster than
<kbd>pygments</kbd>, and takes three times as long as no syntax highlighting (verbatim).
</p>
</div>
</div>
<div id="outline-container-julia-code-blocks" class="outline-5">
<h5 id="julia-code-blocks"><span class="section-number-5">5.3.7.11.</span> Julia code blocks<a aria-hidden="true" href="#julia-code-blocks">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-11">
<p>
Julia code has fantastic support for unicode! The downside is that <kbd>pdflatex</kbd> is
<i>still</i> a pain to use with unicode symbols. The solution &#x2014; <kbd>lualatex</kbd>. Now we just
need to make it automatic
</p>

<details id='julia-code-blocks,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#julia-code-blocks,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-latex-pick-compiler (_contents info)
  <span class="org-builtin">:before</span> #'org-latex-template
  <span class="org-builtin">:before</span> #'org-beamer-template
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (memq 'code (plist-get info <span class="org-builtin">:features</span>))
             (memq 'julia-code (plist-get info <span class="org-builtin">:features</span>))
             (<span class="org-keyword">save-excursion</span>
               (goto-char (point-min))
               (re-search-forward <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\x00-\x7F\u200b]"</span> nil t)))
    (<span class="org-keyword">setf</span> info (plist-put
                (<span class="org-keyword">if</span> (member #'+org-latex-replace-non-ascii-chars (plist-get info <span class="org-builtin">:filter-final-output</span>))
                    (plist-put info <span class="org-builtin">:filter-final-output</span>
                               (delq #'+org-latex-replace-non-ascii-chars (plist-get info <span class="org-builtin">:filter-final-output</span>)))
                  info)
                <span class="org-builtin">:latex-compiler</span> <span class="org-string">"lualatex"</span>))))
</pre>
</div>
</details>

<p>
Then a font with unicode support must be used. JuliaMono is the obvious choice,
and we can use it with the <kbd>fontspec</kbd> package. In future it may be nice to set
this just as a fallback font (when it isn't a pain to do so).
</p>

<details id='julia-mono-fontspec' class='code' open><summary class='named'><span class="name">julia-mono-fontspec</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#julia-mono-fontspec'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate">\ifcsname</span> directlua<span class="org-font-latex-sedate">\endcsname</span>
  <span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">fontspec</span>}
  <span class="org-font-latex-sedate">\newfontfamily\JuliaMono</span>{JuliaMono-Regular.ttf}[Path=/usr/share/fonts/truetype/, Extension=.ttf]
  <span class="org-font-latex-sedate">\newfontface\JuliaMonoRegular</span>{JuliaMono-Regular}
  <span class="org-font-latex-sedate">\setmonofont</span>{JuliaMonoRegular}[Contextuals=Alternate, Scale=MatchLowercase]
<span class="org-font-latex-sedate">\fi</span>
</pre>
</div>
</details>

<p>
Now all that remains is to hook this into the preamble generation.
</p>

<details id='julia-code-blocks,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#julia-code-blocks,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-julia-mono-fontspec</span>
  &lt;&lt;grab(<span class="org-string">"julia-mono-fontspec"</span>)&gt;&gt;
  <span class="org-string">"LaTeX preamble snippet that sets LuaLaTeX's fontspec to use Julia Mono."</span>)

(<span class="org-keyword">org-export-update-features</span> 'latex
  (julia-code
   <span class="org-builtin">:condition</span> <span class="org-string">"^[ \t]*#\\+begin_src julia</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[ \t]*#\\+BEGIN_SRC julia</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">src_julia"</span>
   <span class="org-builtin">:when</span> code
   <span class="org-builtin">:snippet</span> org-latex-julia-mono-fontspec
   <span class="org-builtin">:after</span> custom-font
   <span class="org-builtin">:order</span> 0)
  (microtype-lualatex
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> (microtype julia-code)
   <span class="org-builtin">:prevents</span> microtype
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage[activate={true,nocompatibility},final,tracking=true,factor=2000]{microtype}\n"</span>
   <span class="org-builtin">:order</span> 0.1)
  (custom-font-no-mono
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> julia-code
   <span class="org-builtin">:prevents</span> custom-font
   <span class="org-builtin">:snippet</span> (org-latex-fontset <span class="org-builtin">:serif</span> <span class="org-builtin">:sans</span>)
   <span class="org-builtin">:order</span> 0))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-latex-export-emojis" class="outline-5">
<h5 id="latex-export-emojis"><span class="section-number-5">5.3.7.12.</span> Emojis<a aria-hidden="true" href="#latex-export-emojis">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-12">
<p>
It would be nice to actually include emojis where used.
Thanks to <kbd>emojify</kbd>, we have a folder of emoji images just sitting and waiting to
be used 🙂.
</p>

<p>
First up, we want to detect when emojis are actually present. Manually
constructing a regex for this would be a huge pain with the way the codepoints
are scattered around, but thanks to <code>char-script-table</code> we don't have to!
</p>

<details id='emojis,code--6' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-emoji--rx</span>
  (<span class="org-keyword">let</span> (emojis)
    (map-char-table
     (<span class="org-keyword">lambda</span> (char set)
       (<span class="org-keyword">when</span> (eq set 'emoji)
         (<span class="org-keyword">push</span> (copy-tree char) emojis)))
     char-script-table)
    (rx-to-string `(any ,@emojis)))
  <span class="org-doc">"A regexp to find all emoji-script characters."</span>)
</pre>
</div>
</details>

<p>
Once we've found an Emoji, we would like to include it in LaTeX. We'll set up
the infrastructure for this with the help of two packages
</p>
<ul class="org-ul">
<li><kbd>accsupp</kbd>, to provide the copy-paste text overlay</li>
<li><kbd>transparent</kbd>, to provide invisible text to enable text copying at the image</li>
</ul>

<p>
With these packages we can insert an emoji image at the point and then place
some invisible text on-top of it that copies as the emoji codepoint.
</p>

<p>
Unfortunately though, <kbd>accsupp</kbd> doesn't seem to accept five digit hexadecimal
codepoints at this point in time, instead we need to convert to <span class='acr'>UTF</span>-16 surrogate
pairs, so we'll give our <kbd>\DeclareEmoji</kbd> command two arguments: one for the
non-surrogate form required by <kbd>\DeclareUnicodeCharacter</kbd>, and another for the
surrogate form required by <kbd>\BeginAccSupp</kbd>.
</p>

<details id='latex-emoji-preamble' class='code' open><summary class='named'><span class="name">latex-emoji-preamble</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-emoji-preamble'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">accsupp</span>}
<span class="org-comment-delimiter">% </span><span class="org-comment">The transparent package is also needed, but will be loaded later.</span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newsavebox</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\emojibox</span></span>

<span class="org-font-latex-sedate"><span class="org-keyword">\NewDocumentCommand</span></span><span class="org-font-latex-sedate"><span class="org-function-name">\DeclareEmoji</span></span>{<span class="org-function-name">m m</span>}{<span class="org-function-name"><span class="org-comment">% UTF-8 codepoint, UTF-16 codepoint</span></span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\DeclareUnicodeCharacter</span></span><span class="org-function-name">{#1}{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\sbox\emojibox</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\raisebox</span></span><span class="org-function-name">{OFFSET}{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">        </span><span class="org-font-latex-sedate"><span class="org-function-name">\includegraphics</span></span><span class="org-function-name">[height=HEIGHT]{EMOJI-FOLDER/#1}}}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\usebox\emojibox</span></span>
<span class="org-function-name">    </span><span class="org-font-latex-sedate"><span class="org-function-name">\llap</span></span><span class="org-function-name">{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">      </span><span class="org-font-latex-sedate"><span class="org-function-name">\resizebox</span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name">\wd\emojibox</span></span><span class="org-function-name">}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\height</span></span><span class="org-function-name">}{</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">        </span><span class="org-font-latex-sedate"><span class="org-function-name">\BeginAccSupp</span></span><span class="org-function-name">{method=hex,unicode,ActualText=#2}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">        </span><span class="org-font-latex-sedate"><span class="org-function-name">\texttransparent</span></span><span class="org-function-name">{0}{X}</span><span class="org-function-name"><span class="org-comment">%</span></span>
<span class="org-function-name">        </span><span class="org-font-latex-sedate"><span class="org-function-name">\EndAccSupp</span></span><span class="org-function-name">{}}}}</span>}
</pre>
</div>
</details>

<p>
Once we know that there are emojis present we can add a bit of preamble to the
buffer to make insertion easier.
</p>

<details id='emojis,code--7' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defconst</span> <span class="org-variable-name">org-latex-emoji-base-dir</span>
  (expand-file-name <span class="org-string">"emojis/"</span> doom-cache-dir)
  <span class="org-doc">"Directory where emojis should be saved and look for."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-emoji-sets</span>
  '((<span class="org-string">"twemoji"</span> <span class="org-builtin">:url</span> <span class="org-string">"https://github.com/jdecked/twemoji/archive/refs/tags/v15.1.0.zip"</span>
     <span class="org-builtin">:folder</span> <span class="org-string">"twemoji-15.1.0/assets/svg"</span> <span class="org-builtin">:height</span> <span class="org-string">"1.8ex"</span> <span class="org-builtin">:offset</span> <span class="org-string">"-0.3ex"</span>)
    (<span class="org-string">"twemoji-bw"</span> <span class="org-builtin">:url</span> <span class="org-string">"https://github.com/youdly/twemoji-color-font/archive/refs/heads/v11-release.zip"</span>
     <span class="org-builtin">:folder</span> <span class="org-string">"twemoji-color-font-11-release/assets/builds/svg-bw"</span> <span class="org-builtin">:height</span> <span class="org-string">"1.8ex"</span> <span class="org-builtin">:offset</span> <span class="org-string">"-0.3ex"</span>)
    (<span class="org-string">"openmoji"</span> <span class="org-builtin">:url</span> <span class="org-string">"https://github.com/hfg-gmuend/openmoji/releases/latest/download/openmoji-svg-color.zip"</span>
     <span class="org-builtin">:height</span> <span class="org-string">"2.2ex"</span> <span class="org-builtin">:offset</span> <span class="org-string">"-0.45ex"</span>)
    (<span class="org-string">"openmoji-bw"</span> <span class="org-builtin">:url</span> <span class="org-string">"https://github.com/hfg-gmuend/openmoji/releases/latest/download/openmoji-svg-black.zip"</span>
     <span class="org-builtin">:height</span> <span class="org-string">"2.2ex"</span> <span class="org-builtin">:offset</span> <span class="org-string">"-0.45ex"</span>)
    (<span class="org-string">"emojione"</span> <span class="org-builtin">:url</span> <span class="org-string">"https://github.com/joypixels/emojione/archive/refs/tags/v2.2.7.zip"</span>
     <span class="org-builtin">:folder</span> <span class="org-string">"emojione-2.2.7/assets/svg"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">Warning, poor coverage</span>
    (<span class="org-string">"noto"</span> <span class="org-builtin">:url</span> <span class="org-string">"https://github.com/googlefonts/noto-emoji/archive/refs/tags/v2.038.zip"</span>
     <span class="org-builtin">:folder</span> <span class="org-string">"noto-emoji-2.038/svg"</span> <span class="org-builtin">:file-regexp</span> <span class="org-string">"^emoji_u</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9a-f_]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
     <span class="org-builtin">:height</span> <span class="org-string">"2.0ex"</span> <span class="org-builtin">:offset</span> <span class="org-string">"-0.3ex"</span>))
  <span class="org-doc">"An alist of plistst of emoji sets.</span>
<span class="org-doc">Specified with the minimal form:</span>
<span class="org-doc">  (\"SET-NAME\" :url \"URL\")</span>
<span class="org-doc">The following optional parameters are supported:</span>
<span class="org-doc">  :folder (defaults to \"\")</span>
<span class="org-doc">  The folder within the archive where the emojis exist.</span>
<span class="org-doc">  :file-regexp (defaults to nil)</span>
<span class="org-doc">  Pattern with the emoji code point as the first capture group.</span>
<span class="org-doc">  :height (defaults to \"1.8ex\")</span>
<span class="org-doc">  Height of the emojis to be used.</span>
<span class="org-doc">  :offset (defaults to \"-0.3ex\")</span>
<span class="org-doc">  Baseline offset of the emojis."</span>)

(<span class="org-keyword">defconst</span> <span class="org-variable-name">org-latex-emoji-keyword</span>
  <span class="org-string">"LATEX_EMOJI_SET"</span>
  <span class="org-doc">"Keyword used to set the emoji set from `</span><span class="org-doc"><span class="org-constant">org-latex-emoji-sets</span></span><span class="org-doc">'."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-emoji-preamble</span> &lt;&lt;grab(<span class="org-string">"latex-emoji-preamble"</span>)&gt;&gt;
  <span class="org-string">"LaTeX preamble snippet that will allow for emojis to be declared.</span>
<span class="org-string">Contains the string \"EMOJI-FOLDER\" which should be replaced with</span>
<span class="org-string">the path to the emoji folder."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-utf16</span> (char)
  <span class="org-doc">"Return the pair of UTF-16 surrogates that represent CHAR."</span>
  (list
   (+ #xD7C0 (ash char -10))
   (+ #xDC00 (logand char #x03FF))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-declaration</span> (char)
  <span class="org-doc">"Construct the LaTeX command declaring CHAR as an emoji."</span>
  (format <span class="org-string">"\\DeclareEmoji{%X}{%s} %% %s"</span>
          char
          (<span class="org-keyword">if</span> (&lt; char #xFFFF)
              (format <span class="org-string">"%X"</span> char)
            (apply #'format <span class="org-string">"%X%X"</span> (org-latex-emoji-utf16 char)))
          (capitalize (get-char-code-property char 'name))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-fill-preamble</span> (emoji-folder <span class="org-type">&amp;optional</span> height offset svg-p)
  <span class="org-doc">"Fill in `</span><span class="org-doc"><span class="org-constant">org-latex-emoji-preamble</span></span><span class="org-doc">' with EMOJI-FOLDER, HEIGHT, and OFFSET.</span>
<span class="org-doc">If SVG-P is set \"includegraphics\" will be replaced with \"includesvg\"."</span>
  (<span class="org-keyword">let*</span> (case-fold-search
         (filled-preamble
          (replace-regexp-in-string
           <span class="org-string">"HEIGHT"</span>
           (<span class="org-keyword">or</span> height <span class="org-string">"1.8ex"</span>)
           (replace-regexp-in-string
            <span class="org-string">"OFFSET"</span>
            (<span class="org-keyword">or</span> offset <span class="org-string">"-0.3ex"</span>)
            (replace-regexp-in-string
             <span class="org-string">"EMOJI-FOLDER"</span>
             (directory-file-name
              (<span class="org-keyword">if</span> (getenv <span class="org-string">"HOME"</span>)
                  (replace-regexp-in-string
                   (regexp-quote (getenv <span class="org-string">"HOME"</span>))
                   <span class="org-string">"\\string~"</span>
                   emoji-folder t t)
                emoji-folder))
             org-latex-emoji-preamble t t)
            t t)
           t t)))
    (<span class="org-keyword">if</span> svg-p
        (replace-regexp-in-string
         <span class="org-string">"includegraphics"</span> <span class="org-string">"includesvg"</span>
         filled-preamble t t)
      filled-preamble)))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-setup</span> (<span class="org-type">&amp;optional</span> info)
  <span class="org-doc">"Construct a preamble snippet to set up emojis based on INFO."</span>
  (<span class="org-keyword">let*</span> ((emoji-set
          (<span class="org-keyword">or</span> (org-element-map
                  (plist-get info <span class="org-builtin">:parse-tree</span>)
                  'keyword
                (<span class="org-keyword">lambda</span> (keyword)
                  (<span class="org-keyword">and</span> (string= (org-element-property <span class="org-builtin">:key</span> keyword)
                                org-latex-emoji-keyword)
                       (org-element-property <span class="org-builtin">:value</span> keyword)))
                info t)
              (caar org-latex-emoji-sets)))
         (emoji-spec (cdr (assoc emoji-set org-latex-emoji-sets)))
         (emoji-folder
          (expand-file-name emoji-set org-latex-emoji-base-dir))
         (emoji-svg-only
          (<span class="org-keyword">and</span> (file-exists-p emoji-folder)
               (not (cl-some
                     (<span class="org-keyword">lambda</span> (path)
                       (not (string= (file-name-extension path) <span class="org-string">"svg"</span>)))
                     (directory-files emoji-folder nil <span class="org-string">"\\....$"</span>))))))
    (<span class="org-keyword">cond</span>
     ((not emoji-spec)
      (<span class="org-warning">error</span> <span class="org-string">"Emoji set `</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' is unknown. Try one of: %s"</span> emoji-set
             (string-join (mapcar #'car org-latex-emoji-sets) <span class="org-string">", "</span>)))
     ((not (file-exists-p emoji-folder))
      (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (not noninteractive)
               (yes-or-no-p (format <span class="org-string">"Emoji set `</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' is not installed, would you like to install it?"</span> emoji-set)))
          (org-latex-emoji-install
           emoji-set
           (<span class="org-keyword">or</span> (executable-find <span class="org-string">"cairosvg"</span>) (executable-find <span class="org-string">"inkscape"</span>)))
        (<span class="org-warning">error</span> <span class="org-string">"Emoji set `</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' is not installed"</span> emoji-set))))
    (org-latex-emoji-fill-preamble
     emoji-folder (plist-get emoji-spec <span class="org-builtin">:height</span>)
     (plist-get emoji-spec <span class="org-builtin">:offset</span>) emoji-svg-only)))

(<span class="org-keyword">org-export-update-features</span> 'latex
  (emoji-setup <span class="org-comment-delimiter">; </span><span class="org-comment">The precompilable bit</span>
   <span class="org-builtin">:condition</span> (<span class="org-keyword">save-excursion</span>
                (goto-char (point-min))
                (re-search-forward org-latex-emoji--rx nil t))
   <span class="org-builtin">:requires</span> (image pkg-transparent)
   <span class="org-builtin">:snippet</span> org-latex-emoji-setup
   <span class="org-builtin">:order</span> 3)
  (pkg-transparent <span class="org-comment-delimiter">; </span><span class="org-comment">Part of emoji setup, but non-precompilable.</span>
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage{transparent}"</span>
   <span class="org-builtin">:order</span> 84)
  (emoji-declarations
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> emoji-setup
   <span class="org-builtin">:snippet</span>
   (mapconcat
    #'org-latex-emoji-declaration
    (<span class="org-keyword">let</span> (unicode-cars)
      (<span class="org-keyword">save-excursion</span>
        (goto-char (point-min))
        (<span class="org-keyword">while</span> (re-search-forward org-latex-emoji--rx nil t)
          (<span class="org-keyword">push</span> (aref (match-string 0) 0) unicode-cars)))
      (cl-delete-duplicates unicode-cars))
    <span class="org-string">"\n"</span>)
   <span class="org-builtin">:order</span> 85))
</pre>
</div>
</details>

<p>
Unfortunately this isn't a global solution, as LuaLaTeX doesn't have
<kbd>\DeclareUnicodeCharacter</kbd>. However, we can fix this with a hack for the one case
when we know it will be used.
</p>

<details id='emojis,code--8' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--8'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">org-export-update-features</span> 'latex
  (emoji-lualatex-hack
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:when</span> (emoji julia-code) <span class="org-comment-delimiter">; </span><span class="org-comment">LuaLaTeX is used with julia-code.</span>
   <span class="org-builtin">:snippet</span>
   <span class="org-string">"\\usepackage{newunicodechar}</span>
<span class="org-string">\\newcommand{\\DeclareUnicodeCharacter}[2]{%</span>
<span class="org-string">    \\begingroup\\lccode`|=\\string\"#1\\relax</span>
<span class="org-string">    \\lowercase{\\endgroup\\newunicodechar{|}}{#2}}"</span>
   <span class="org-builtin">:before</span> emoji))
</pre>
</div>
</details>

<p>
This works fairly nicely, there's just one little <span class='acr'>QOL</span> upgrade that we can
perform. <kbd>emojify</kbd> downloads the <code>72x72</code> versions of Twemoji, however <span class='acr'>SVG</span> versions
are also produced. We could use <code>inkscape</code> to convert those to <span class='acr'>PDF</span><small>s</small>, which would
likely be best for including.
</p>

<p>
This works fairly nicely, but it would be good to use <kbd>.pdf</kbd> forms whenever
possible. We can use <kbd>texdef</kbd> to check the file extension priority list.
</p>

<details id='emojis,code--9' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#emojis,code--9'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">texdef -t pdflatex -p graphicx Gin@extensions
</pre>
</div>
</details>

<details id='orgd5e6748' class='code' open>
<summary></summary>
<div class='gutter'><a href='#orgd5e6748'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<pre class="example" id="orgd5e6748">
\Gin@extensions:
macro:-&gt;.pdf,.png,.jpg,.mps,.jpeg,.jbig2,.jb2,.PDF,.PNG,.JPG,.JPEG,.JBIG2,.JB2,.eps
</pre>

</details>

<p>
Fantastic! We can see that <kbd>.pdf</kbd> actually comes first in the priority list.
Now we just need to fetch and convert the emoji images.
</p>

<details id='emojis,code--10' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#emojis,code--10'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-install</span> (set <span class="org-type">&amp;optional</span> convert)
  <span class="org-doc">"Dowload, convert, and install emojis for use with LaTeX."</span>
  (<span class="org-keyword">interactive</span>
   (list (completing-read <span class="org-string">"Emoji set to install: "</span>
                          (mapcar
                           (<span class="org-keyword">lambda</span> (set-spec)
                             (<span class="org-keyword">if</span> (file-exists-p (expand-file-name (car set-spec) org-latex-emoji-base-dir))
                                 (propertize (car set-spec) 'face 'font-lock-doc-face)
                               (car set-spec)))
                           org-latex-emoji-sets)
                          nil t)
         (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (executable-find <span class="org-string">"cairosvg"</span>) (executable-find <span class="org-string">"inkscape"</span>))
             (yes-or-no-p <span class="org-string">"Would you like to create .pdf forms of the Emojis (strongly recommended)?"</span>)
           (message <span class="org-string">"Install `</span><span class="org-string"><span class="org-constant">cairosvg</span></span><span class="org-string">' (recommended) or `</span><span class="org-string"><span class="org-constant">inkscape</span></span><span class="org-string">' to convert to PDF forms"</span>)
           nil)))
  (<span class="org-keyword">let</span> ((emoji-folder (expand-file-name set org-latex-emoji-base-dir)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (not (file-exists-p emoji-folder))
              (<span class="org-keyword">and</span> (not noninteractive)
                   (yes-or-no-p <span class="org-string">"Emoji folder already present, would you like to re-download?"</span>)
                   (<span class="org-keyword">progn</span> (delete-directory emoji-folder t) t)))
      (<span class="org-keyword">let*</span> ((spec (cdr (assoc set org-latex-emoji-sets)))
             (dir (org-latex-emoji-install--download set (plist-get spec <span class="org-builtin">:url</span>)))
             (svg-dir (expand-file-name (<span class="org-keyword">or</span> (plist-get spec <span class="org-builtin">:folder</span>) <span class="org-string">""</span>) dir)))
        (org-latex-emoji-install--install
         set svg-dir (plist-get spec <span class="org-builtin">:file-regexp</span>))))
    (<span class="org-keyword">when</span> convert
      (org-latex-emoji-install--convert (file-name-as-directory emoji-folder))))
  (message <span class="org-string">"Emojis set `</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' installed."</span> set))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-install--download</span> (name url)
  <span class="org-doc">"Download the emoji archive URL for the set NAME."</span>
  (<span class="org-keyword">let*</span> ((dest-folder (make-temp-file (format <span class="org-string">"%s-"</span> name) t)))
    (message <span class="org-string">"Downloading %s..."</span> name)
    (<span class="org-keyword">let</span> ((default-directory dest-folder))
      (call-process <span class="org-string">"curl"</span> nil nil nil <span class="org-string">"-sL"</span> url <span class="org-string">"--output"</span> <span class="org-string">"emojis.zip"</span>)
      (message <span class="org-string">"Unzipping"</span>)
      (call-process <span class="org-string">"unzip"</span> nil nil nil <span class="org-string">"emojis.zip"</span>)
      dest-folder)))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-install--install</span> (name dir <span class="org-type">&amp;optional</span> filename-regexp)
  <span class="org-doc">"Install the emoji files in DIR to the NAME set folder.</span>
<span class="org-doc">If a FILENAME-REGEXP, only files matching this regexp will be moved,</span>
<span class="org-doc">and they will be renamed to the first capture group of the regexp."</span>
  (message <span class="org-string">"Installing %s emojis into emoji directory"</span> name)
  (<span class="org-keyword">let</span> ((images (append (directory-files dir t <span class="org-string">".*.svg"</span>)
                        (directory-files dir t <span class="org-string">".*.pdf"</span>)))
        (emoji-dir (file-name-as-directory
                    (expand-file-name name org-latex-emoji-base-dir))))
    (<span class="org-keyword">unless</span> (file-exists-p emoji-dir)
      (make-directory emoji-dir t))
    (mapc
     (<span class="org-keyword">lambda</span> (image)
       (<span class="org-keyword">if</span> filename-regexp
           (<span class="org-keyword">when</span> (string-match filename-regexp (file-name-nondirectory image))
             (rename-file image
                          (expand-file-name
                           (file-name-with-extension
                            (upcase (match-string 1 (file-name-nondirectory image)))
                            (file-name-extension image))
                           emoji-dir)
                          t))
         (rename-file image
                      (expand-file-name
                       (file-name-with-extension
                        (upcase (file-name-nondirectory image))
                        (file-name-extension image))
                       emoji-dir)
                      t)))
     images)
    (message <span class="org-string">"%d emojis installed"</span> (length images))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-emoji-install--convert</span> (dir)
  <span class="org-doc">"Convert all .svg files in DIR to .pdf forms.</span>
<span class="org-doc">Uses cairosvg if possible, falling back to inkscape."</span>
  (<span class="org-keyword">let</span> ((default-directory dir))
    (<span class="org-keyword">if</span> (executable-find <span class="org-string">"cairosvg"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">cairo's PDFs are ~10% smaller</span>
        (<span class="org-keyword">let*</span> ((images (directory-files dir nil <span class="org-string">".*.svg"</span>))
               (num-images (length images))
               (index 0)
               (max-threads (1- (string-to-number (shell-command-to-string <span class="org-string">"nproc"</span>))))
               (threads 0))
          (<span class="org-keyword">while</span> (&lt; index num-images)
            (<span class="org-keyword">setf</span> threads (1+ threads))
            (<span class="org-keyword">let</span> (message-log-max)
              (message <span class="org-string">"Converting emoji %d/%d (%s)"</span> (1+ index) num-images (nth index images)))
            (make-process <span class="org-builtin">:name</span> <span class="org-string">"cairosvg"</span>
                          <span class="org-builtin">:command</span> (list <span class="org-string">"cairosvg"</span> (nth index images) <span class="org-string">"-o"</span> (concat (file-name-sans-extension (nth index images)) <span class="org-string">".pdf"</span>))
                          <span class="org-builtin">:sentinel</span> (<span class="org-keyword">lambda</span> (proc msg)
                                      (<span class="org-keyword">when</span> (memq (process-status proc) '(exit signal))
                                        (<span class="org-keyword">setf</span> threads (1- threads)))))
            (<span class="org-keyword">setq</span> index (1+ index))
            (<span class="org-keyword">while</span> (&gt; threads max-threads)
              (sleep-for 0.01)))
          (<span class="org-keyword">while</span> (&gt; threads 0)
            (sleep-for 0.01)))
      (message <span class="org-string">"Cairosvg not found. Proceeding with inkscape as a fallback."</span>)
      (shell-command <span class="org-string">"inkscape --batch-process --export-type='</span><span class="org-string"><span class="org-constant">pdf</span></span><span class="org-string">' *.svg"</span>))
    (message <span class="org-string">"Finished conversion!"</span>)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-remove-non-ascii" class="outline-5">
<h5 id="remove-non-ascii"><span class="section-number-5">5.3.7.13.</span> Remove non-ascii chars<a aria-hidden="true" href="#remove-non-ascii">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-13">
<p>
When using <code>pdflatex</code>, almost non-ascii characters are generally problematic, and
don't appear in the pdf. It's preferable to see that there was <i>some</i> character
which wasn't displayed as opposed to nothing.
</p>

<p>
We check every non-ascii character to make sure it's not a character encoded by
the <kbd>inputenc</kbd> packages when loaded with the <kbd>utf8</kbd> option. We'll also allow
box-drawing characters since they can be mostly supported with <kbd>pmboxdraw</kbd>.
Finally, we see if we have our own LaTeX conversion we can apply and if there is
none we replace the non-ascii char with <kbd>¿</kbd>.
</p>

<p>
No to make sure we only remove characters that can't be displayed, we check
<kbd>/usr/share/texmf/tex/latex/base/utf8enc.dfu</kbd>.
</p>

<p>
We just need to make sure this is appended to the list of filter functions,
since we want to let emoji processing occur first.
</p>

<details id='remove-non-ascii,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#remove-non-ascii,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-pdflatex-inputenc-encoded-chars</span>
  <span class="org-string">"[[:ascii:]\u00A0-\u01F0\u0218-\u021B&#562;&#563;&#567;&#710;&#711;&#732;&#728;&#729;&#731;&#733;\u0400-\u04FF&#7682;&#7683;&#7838;\u200B\u200C\u2010-\u201E&#8224;&#8225;&#8226;&#8230;&#8240;&#8241;&#8249;&#8250;&#8251;&#8253;&#8260;&#8270;&#8274;&#8353;&#8356;&#8358;&#8361;&#8363;&#8364;&#8369;&#8451;&#8470;&#8471;&#8478;&#8480;&#8482;&#8486;&#8487;&#8494;&#8592;&#8593;&#8594;&#8595;&#9001;&#9002;&#9250;&#9251;&#9702;&#9711;&#9834;&#10216;&#10217;&#7712;&#7713;\uFB00-\uFB06\u2500-\u259F]"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">+org-latex-replace-non-ascii-chars</span> (text backend info)
  <span class="org-doc">"Replace non-ascii chars with \\char\"XYZ forms."</span>
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (org-export-derived-backend-p backend 'latex)
             (string= (plist-get info <span class="org-builtin">:latex-compiler</span>) <span class="org-string">"pdflatex"</span>))
    (<span class="org-keyword">let</span> (case-replace)
      (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">[:ascii:]]"</span>
                                (<span class="org-keyword">lambda</span> (nonascii)
                                  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (string-match-p +org-pdflatex-inputenc-encoded-chars nonascii)
                                          (string-match-p org-latex-emoji--rx nonascii))
                                      nonascii
                                    (<span class="org-keyword">or</span> (cdr (assoc nonascii +org-latex-non-ascii-char-substitutions))
                                        <span class="org-string">"&#191;"</span>)))
                                text))))

(add-to-list 'org-export-filter-plain-text-functions #'+org-latex-replace-non-ascii-chars t)
</pre>
</div>
</details>

<p>
Now, there are some symbols that aren't included in <kbd>inputenc</kbd>, but we should be
able to handle anyway. For them we define a table of LaTeX translations
</p>

<div id='latex-non-ascii' class='table'>
<div class='gutter'><a href='#latex-non-ascii'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Character</th>
<th scope="col" class="org-left">LaTeX</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ɑ</td>
<td class="org-left">\(\alpha\)</td>
</tr>

<tr>
<td class="org-left">β</td>
<td class="org-left">\(\beta\)</td>
</tr>

<tr>
<td class="org-left">γ</td>
<td class="org-left">\(\gamma\)</td>
</tr>

<tr>
<td class="org-left">δ</td>
<td class="org-left">\(\delta\)</td>
</tr>

<tr>
<td class="org-left">ε</td>
<td class="org-left">\(\epsilon\)</td>
</tr>

<tr>
<td class="org-left">ϵ</td>
<td class="org-left">\(\varepsilon\)</td>
</tr>

<tr>
<td class="org-left">ζ</td>
<td class="org-left">\(\zeta\)</td>
</tr>

<tr>
<td class="org-left">η</td>
<td class="org-left">\(\eta\)</td>
</tr>

<tr>
<td class="org-left">θ</td>
<td class="org-left">\(\theta\)</td>
</tr>

<tr>
<td class="org-left">ϑ</td>
<td class="org-left">\(\vartheta\)</td>
</tr>

<tr>
<td class="org-left">ι</td>
<td class="org-left">\(\iota\)</td>
</tr>

<tr>
<td class="org-left">κ</td>
<td class="org-left">\(\kappa\)</td>
</tr>

<tr>
<td class="org-left">λ</td>
<td class="org-left">\(\lambda\)</td>
</tr>

<tr>
<td class="org-left">μ</td>
<td class="org-left">\(\mu\)</td>
</tr>

<tr>
<td class="org-left">ν</td>
<td class="org-left">\(\nu\)</td>
</tr>

<tr>
<td class="org-left">ξ</td>
<td class="org-left">\(\xi\)</td>
</tr>

<tr>
<td class="org-left">π</td>
<td class="org-left">\(\pi\)</td>
</tr>

<tr>
<td class="org-left">ϖ</td>
<td class="org-left">\(\varpi\)</td>
</tr>

<tr>
<td class="org-left">ρ</td>
<td class="org-left">\(\rho\)</td>
</tr>

<tr>
<td class="org-left">ϱ</td>
<td class="org-left">\(\varrho\)</td>
</tr>

<tr>
<td class="org-left">σ</td>
<td class="org-left">\(\sigma\)</td>
</tr>

<tr>
<td class="org-left">ς</td>
<td class="org-left">\(\varsigma\)</td>
</tr>

<tr>
<td class="org-left">τ</td>
<td class="org-left">\(\tau\)</td>
</tr>

<tr>
<td class="org-left">υ</td>
<td class="org-left">\(\upsilon\)</td>
</tr>

<tr>
<td class="org-left">ϕ</td>
<td class="org-left">\(\phi\)</td>
</tr>

<tr>
<td class="org-left">φ</td>
<td class="org-left">\(\varphi\)</td>
</tr>

<tr>
<td class="org-left">ψ</td>
<td class="org-left">\(\psi\)</td>
</tr>

<tr>
<td class="org-left">ω</td>
<td class="org-left">\(\omega\)</td>
</tr>

<tr>
<td class="org-left">Γ</td>
<td class="org-left">\(\Gamma\)</td>
</tr>

<tr>
<td class="org-left">Δ</td>
<td class="org-left">\(\Delta\)</td>
</tr>

<tr>
<td class="org-left">Θ</td>
<td class="org-left">\(\Theta\)</td>
</tr>

<tr>
<td class="org-left">Λ</td>
<td class="org-left">\(\Lambda\)</td>
</tr>

<tr>
<td class="org-left">Ξ</td>
<td class="org-left">\(\Xi\)</td>
</tr>

<tr>
<td class="org-left">Π</td>
<td class="org-left">\(\Pi\)</td>
</tr>

<tr>
<td class="org-left">Σ</td>
<td class="org-left">\(\Sigma\)</td>
</tr>

<tr>
<td class="org-left">Υ</td>
<td class="org-left">\(\Upsilon\)</td>
</tr>

<tr>
<td class="org-left">Φ</td>
<td class="org-left">\(\Phi\)</td>
</tr>

<tr>
<td class="org-left">Ψ</td>
<td class="org-left">\(\Psi\)</td>
</tr>

<tr>
<td class="org-left">Ω</td>
<td class="org-left">\(\Omega\)</td>
</tr>

<tr>
<td class="org-left">א</td>
<td class="org-left">\(\aleph\)</td>
</tr>

<tr>
<td class="org-left">ב</td>
<td class="org-left">\(\beth\)</td>
</tr>

<tr>
<td class="org-left">ד</td>
<td class="org-left">\(\daleth\)</td>
</tr>

<tr>
<td class="org-left">ג</td>
<td class="org-left">\(\gimel\)</td>
</tr>
</tbody>
</table>
</div></div>

<details id='gen-latex-non' class='code' open><summary class='named'><span class="name">gen-latex-non-ascii-char-substitutions</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gen-latex-non'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(replace-regexp-in-string
 <span class="org-string">" '(("</span> <span class="org-string">"\n   '(("</span>
 (replace-regexp-in-string
  <span class="org-string">") ("</span> <span class="org-string">")\n     ("</span>
  (prin1-to-string
   `(<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-latex-non-ascii-char-substitutions</span>
      ',(mapcar
         (<span class="org-keyword">lambda</span> (entry)
           (cons (car entry) (replace-regexp-in-string <span class="org-string">"\\\\"</span> <span class="org-string">"\\\\\\\\"</span> (cadr entry))))
         latex-non-ascii-char-substitutions)))))
</pre>
</div>
</details>

<details id='remove-non-ascii,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#remove-non-ascii,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;gen-latex-non-ascii-char-substitutions()&gt;&gt;
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-normal-spaces-after" class="outline-5">
<h5 id="normal-spaces-after"><span class="section-number-5">5.3.7.14.</span> Normal spaces after abbreviations<a aria-hidden="true" href="#normal-spaces-after">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-14">
<p>
In LaTeX inter-word and sentence spaces are typically of different widths. This
can be an issue when using abbreviations i.e. e.g. etc. et al..
This can be corrected by forcing a normal space with .
When exporting Org documents, we can add a filter to check for common
abbreviations and make the space normal.
</p>

<details id='normal-spaces-after,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#normal-spaces-after,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">+org-latex-abbreviations</span>
  '(<span class="org-comment-delimiter">;; </span><span class="org-comment">Latin</span>
    <span class="org-string">"cf."</span> <span class="org-string">"e.g."</span> <span class="org-string">"etc."</span> <span class="org-string">"et al."</span> <span class="org-string">"i.e."</span> <span class="org-string">"v."</span> <span class="org-string">"vs."</span> <span class="org-string">"viz."</span> <span class="org-string">"n.b."</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Corperate</span>
    <span class="org-string">"inc."</span> <span class="org-string">"govt."</span> <span class="org-string">"ltd."</span> <span class="org-string">"pty."</span> <span class="org-string">"dept."</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Temporal</span>
    <span class="org-string">"est."</span> <span class="org-string">"c."</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Honorifics</span>
    <span class="org-string">"Prof."</span> <span class="org-string">"Dr."</span> <span class="org-string">"Mr."</span> <span class="org-string">"Mrs."</span> <span class="org-string">"Ms."</span> <span class="org-string">"Miss."</span> <span class="org-string">"Sr."</span> <span class="org-string">"Jr."</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Components of a work</span>
    <span class="org-string">"ed."</span> <span class="org-string">"vol."</span> <span class="org-string">"sec."</span> <span class="org-string">"chap."</span> <span class="org-string">"pt."</span> <span class="org-string">"pp."</span> <span class="org-string">"op."</span> <span class="org-string">"no."</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Common usage</span>
    <span class="org-string">"approx."</span> <span class="org-string">"misc."</span> <span class="org-string">"min."</span> <span class="org-string">"max."</span>)
  <span class="org-doc">"A list of abbreviations that should be spaced correctly when exporting to LaTeX."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">+org-latex-correct-latin-abbreviation-spaces</span> (text backend _info)
  <span class="org-doc">"Normalise spaces after Latin abbreviations."</span>
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'latex)
    (replace-regexp-in-string (<span class="org-keyword">rx</span> (group (<span class="org-keyword">or</span> line-start space)
                                         (regexp (regexp-opt-group +org-latex-abbreviations)))
                                  (<span class="org-keyword">or</span> line-end space))
                              <span class="org-string">"\\1\\\\ "</span>
                              text)))

(add-to-list 'org-export-filter-paragraph-functions #'+org-latex-correct-latin-abbreviation-spaces t)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-latex-export-extra" class="outline-5">
<h5 id="latex-export-extra"><span class="section-number-5">5.3.7.15.</span> Extra special strings<a aria-hidden="true" href="#latex-export-extra">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-15">
<p>
LaTeX already recognises <kbd>---</kbd> and <kbd>--</kbd> as em/en-dashes, <kbd>\-</kbd> as a shy hyphen, and the
conversion of <kbd>...</kbd> to <kbd>\ldots{}</kbd> is hardcoded into <code>org-latex-plain-text</code> (unlike
<code>org-html-plain-text</code>).
</p>

<p>
I'd quite like to also recognise <kbd>-&gt;</kbd> and <kbd>&lt;-</kbd>, so let's set come up with some advice.
</p>

<details id='extra-special-strings,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#extra-special-strings,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-latex-extra-special-string-regexps</span>
  '((<span class="org-string">"&lt;-&gt;"</span> . <span class="org-string">"\\\\(\\\\leftrightarrow{}\\\\)"</span>)
    (<span class="org-string">"-&gt;"</span> . <span class="org-string">"\\\\textrightarrow{}"</span>)
    (<span class="org-string">"&lt;-"</span> . <span class="org-string">"\\\\textleftarrow{}"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-latex-convert-extra-special-strings</span> (string)
  <span class="org-doc">"Convert special characters in STRING to LaTeX."</span>
  (<span class="org-keyword">dolist</span> (a org-latex-extra-special-string-regexps string)
    (<span class="org-keyword">let</span> ((re (car a))
          (rpl (cdr a)))
      (<span class="org-keyword">setq</span> string (replace-regexp-in-string re rpl string t)))))

(<span class="org-keyword">defadvice!</span> org-latex-plain-text-extra-special-a (orig-fn text info)
  <span class="org-doc">"Make `</span><span class="org-doc"><span class="org-constant">org-latex-plain-text</span></span><span class="org-doc">' handle some extra special strings."</span>
  <span class="org-builtin">:around</span> #'org-latex-plain-text
  (<span class="org-keyword">let</span> ((output (funcall orig-fn text info)))
    (<span class="org-keyword">when</span> (plist-get info <span class="org-builtin">:with-special-strings</span>)
      (<span class="org-keyword">setq</span> output (org-latex-convert-extra-special-strings output)))
    output))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-chameleon-aka-match" class="outline-5">
<h5 id="chameleon-aka-match"><span class="section-number-5">5.3.7.16.</span> Chameleon &#x2014; aka. match theme<a aria-hidden="true" href="#chameleon-aka-match">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-16">
<p>
Once I had the idea of having the look of the LaTeX document produced match the
current Emacs theme, I was enraptured. The result is the pseudo-class <code>chameleon</code>,
which I have implemented in the package <kbd>ox-chameleon</kbd>.
</p>

<details id='chameleon-aka-match,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#chameleon-aka-match,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> ox-chameleon <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/ox-chameleon"</span>))
</pre>
</div>
</details>

<details id='chameleon-aka-match,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#chameleon-aka-match,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! ox-chameleon
  <span class="org-builtin">:after</span> ox)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-latex-export-make" class="outline-5">
<h5 id="latex-export-make"><span class="section-number-5">5.3.7.17.</span> Make verbatim different to code<a aria-hidden="true" href="#latex-export-make">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-17">
<p>
Since have just gone to so much effort above let's make the most of it by making
<kbd>verbatim</kbd> use <code>verb</code> instead of <code>protectedtexttt</code> (default).
</p>

<p>
This gives the same advantages as mentioned in the <a href="#latex-export-make"><span class='acr'>HTML</span> export section</a>.
</p>

<details id='make-verbatim-different,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#make-verbatim-different,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-latex-text-markup-alist
      '((bold . <span class="org-string">"\\textbf{%s}"</span>)
        (code . protectedtexttt)
        (italic . <span class="org-string">"\\emph{%s}"</span>)
        (strike-through . <span class="org-string">"\\sout{%s}"</span>)
        (underline . <span class="org-string">"\\uline{%s}"</span>)
        (verbatim . verb)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-check-required-packages" class="outline-5">
<h5 id="check-required-packages"><span class="section-number-5">5.3.7.18.</span> Check for required packages<a aria-hidden="true" href="#check-required-packages">#</a> </h5>
<div class="outline-text-5" id="text-5-3-7-18">
<p>
For how I've setup Org's LaTeX export, the following packages are needed:
</p>
<div id='org-latex-required' class='table'>
<div class='gutter'><a href='#org-latex-required'>#</a></div>
<div class='tabular'>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Package</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">adjustbox</td>
<td class="org-left">Adjust general LaTeX material in like includegraphics</td>
</tr>

<tr>
<td class="org-left">accsupp</td>
<td class="org-left">Copy-paste text overlay for emoji images</td>
</tr>

<tr>
<td class="org-left">amsmath</td>
<td class="org-left">A near-essential maths package</td>
</tr>

<tr>
<td class="org-left">booktabs</td>
<td class="org-left">Nice horizontal lines in tables</td>
</tr>

<tr>
<td class="org-left">cancel</td>
<td class="org-left">Cancel terms in equations</td>
</tr>

<tr>
<td class="org-left">capt-of</td>
<td class="org-left">Captions outside floats</td>
</tr>

<tr>
<td class="org-left">caption</td>
<td class="org-left">Finer control over captions</td>
</tr>

<tr>
<td class="org-left">cleveref</td>
<td class="org-left">Easy cross-referencing</td>
</tr>

<tr>
<td class="org-left">embedall</td>
<td class="org-left">Embed files in the document</td>
</tr>

<tr>
<td class="org-left">etoolbox</td>
<td class="org-left">Document hooks</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">Floating environments</td>
</tr>

<tr>
<td class="org-left">fontenc</td>
<td class="org-left">Font encodings</td>
</tr>

<tr>
<td class="org-left">fvextra</td>
<td class="org-left">Enhanced verbatim environments</td>
</tr>

<tr>
<td class="org-left">graphicx</td>
<td class="org-left">An extended graphics package</td>
</tr>

<tr>
<td class="org-left">hanging</td>
<td class="org-left">Used by oc-csl</td>
</tr>

<tr>
<td class="org-left">hyperref</td>
<td class="org-left">Links</td>
</tr>

<tr>
<td class="org-left">inputenc</td>
<td class="org-left">Input file encodings</td>
</tr>

<tr>
<td class="org-left">longtable</td>
<td class="org-left">Multi-page tables</td>
</tr>

<tr>
<td class="org-left">mathalpha</td>
<td class="org-left">Set extended math alphabet fonts</td>
</tr>

<tr>
<td class="org-left">mathtools</td>
<td class="org-left">Typesetting tools for maths</td>
</tr>

<tr>
<td class="org-left">microtype</td>
<td class="org-left">Microtypography</td>
</tr>

<tr>
<td class="org-left">pdfx</td>
<td class="org-left">Create pdf/a- and pdf/x- compatible documents</td>
</tr>

<tr>
<td class="org-left">pifont</td>
<td class="org-left">A collection of symbols</td>
</tr>

<tr>
<td class="org-left">pmboxdraw</td>
<td class="org-left">Good-looking box drawing characters</td>
</tr>

<tr>
<td class="org-left">preview</td>
<td class="org-left">Needed for AUCTeX and ob-latex</td>
</tr>

<tr>
<td class="org-left">scrbase</td>
<td class="org-left"><span class='acr'>KOMA</span> classes and more</td>
</tr>

<tr>
<td class="org-left">scrextend</td>
<td class="org-left"><span class='acr'>KOMA</span> utilities</td>
</tr>

<tr>
<td class="org-left">siunitx</td>
<td class="org-left">Proper unit support</td>
</tr>

<tr>
<td class="org-left">soul</td>
<td class="org-left">Strikethrough and underline, flexibly</td>
</tr>

<tr>
<td class="org-left">subcaption</td>
<td class="org-left">Form subfigures and subcaptions</td>
</tr>

<tr>
<td class="org-left">svg</td>
<td class="org-left">Insert <span class='acr'>SVG</span> images</td>
</tr>

<tr>
<td class="org-left">tcolorbox</td>
<td class="org-left">Nice boxes for code</td>
</tr>

<tr>
<td class="org-left">textcomp</td>
<td class="org-left">Font encodings</td>
</tr>

<tr>
<td class="org-left">tikz</td>
<td class="org-left">Generally handy, as a dependancy and for graphics</td>
</tr>

<tr>
<td class="org-left">transparent</td>
<td class="org-left">Invisible text for emoji copying</td>
</tr>

<tr>
<td class="org-left">xcoffins</td>
<td class="org-left">Manipulate coffins (boxes) for typesetting</td>
</tr>

<tr>
<td class="org-left">xcolor</td>
<td class="org-left">Colours</td>
</tr>

<tr>
<td class="org-left">xparse</td>
<td class="org-left">Extended command/env definition forms</td>
</tr>
</tbody>
</table>
</div></div>

<p>
Then for the various fontsets:
</p>
<ul class="org-ul">
<li>Alegreya</li>
<li>arev</li>
<li>arevmath</li>
<li>biolinum</li>
<li>FiraMono</li>
<li>FiraSans</li>
<li>fourier</li>
<li>gillius</li>
<li>kpfonts</li>
<li>libertine</li>
<li>newpxmath</li>
<li>newpxtext</li>
<li>newtxmath</li>
<li>newtxtext</li>
<li>newtxsf</li>
<li>noto</li>
<li>notomath</li>
<li>plex-mono</li>
<li>plex-sans</li>
<li>plex-serif</li>
<li>sourcecodepro</li>
<li>sourcesanspro</li>
<li>sourceserifpro</li>
</ul>

<p>
We can write a function which will check for each of these packages with
<kbd>kpsewhich</kbd>, and then if any of them are missing we'll inject some advice into the
generated config that gets a list of missing packages and warns us every time we
export to a <span class='acr'>PDF</span>.
</p>

<details id='org-missing-latex' class='code' open><summary class='named'><span class="name">org-missing-latex-packages</span><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#org-missing-latex'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-required-latex-packages
      (append org-latex-required-packages-list
              org-latex-font-packages-list))

(<span class="org-keyword">defun</span> <span class="org-function-name">check-for-latex-packages</span> (packages)
  (delq nil (mapcar (<span class="org-keyword">lambda</span> (package)
                      (<span class="org-keyword">unless</span>
                          (= 0 (call-process <span class="org-string">"kpsewhich"</span> nil nil nil (concat package <span class="org-string">".sty"</span>)))
                        package))
                    packages)))

(<span class="org-keyword">if-let</span> (((executable-find <span class="org-string">"kpsewhich"</span>))
         (missing-pkgs (check-for-latex-packages org-required-latex-packages)))
    (concat
     (pp-to-string `(<span class="org-keyword">setq</span> org-required-latex-packages ',org-required-latex-packages))
     (message <span class="org-string">";; Detected missing LaTeX packages: %s\n"</span> (mapconcat #'identity missing-pkgs <span class="org-string">", "</span>))
     (pp-to-string
      '(<span class="org-keyword">defun</span> <span class="org-function-name">check-for-latex-packages</span> (packages)
         (delq nil (mapcar (<span class="org-keyword">lambda</span> (package)
                             (<span class="org-keyword">unless</span>
                                 (= 0 (call-process <span class="org-string">"kpsewhich"</span> nil nil nil (concat package <span class="org-string">".sty"</span>)))
                               package))
                           packages))))
     (pp-to-string
      '(<span class="org-keyword">defun</span> <span class="org-function-name">+org-warn-about-missing-latex-packages</span> (<span class="org-type">&amp;rest</span> _)
         (message <span class="org-string">"Checking for missing LaTeX packages..."</span>)
         (sleep-for 0.4)
         (<span class="org-keyword">if-let</span> (missing-pkgs (check-for-latex-packages org-required-latex-packages))
             (message <span class="org-string">"%s You are missing the following LaTeX packages: %s."</span>
                      (propertize <span class="org-string">"Warning!"</span> 'face '(bold warning))
                      (mapconcat (<span class="org-keyword">lambda</span> (pkg) (propertize pkg 'face 'font-lock-variable-name-face))
                                 missing-pkgs
                                 <span class="org-string">", "</span>))
           (message <span class="org-string">"%s You have all the required LaTeX packages. Run %s to make this message go away."</span>
                    (propertize <span class="org-string">"Success!"</span> 'face '(bold success))
                    (propertize <span class="org-string">"doom sync"</span> 'face 'font-lock-keyword-face))
           (advice-remove 'org-latex-export-to-pdf #'+org-warn-about-missing-latex-packages))
         (sleep-for 1)))
     (pp-to-string
      '(advice-add 'org-latex-export-to-pdf <span class="org-builtin">:before</span> #'+org-warn-about-missing-latex-packages)))
  <span class="org-string">";; No missing LaTeX packags detected"</span>)
</pre>
</div>
</details>

<details id='check-required-packages,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#check-required-packages,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;org-missing-latex-packages()&gt;&gt;
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-beamer-export" class="outline-4">
<h4 id="beamer-export"><span class="section-number-4">5.3.8.</span> Beamer Export<a aria-hidden="true" href="#beamer-export">#</a> </h4>
<div class="outline-text-4" id="text-5-3-8">
<p>
It's nice to use a different theme
</p>
<details id='beamer-export,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#beamer-export,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-beamer-theme <span class="org-string">"[progressbar=foot]metropolis"</span>)
</pre>
</div>
</details>

<p>
When using metropolis though, we want to make a few tweaks:
</p>
<details id='beamer-metropolis-tweaks' class='code' open><summary class='named'><span class="name">beamer-metropolis-tweaks</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#beamer-metropolis-tweaks'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-LaTeX"><span class="org-font-latex-sedate"><span class="org-keyword">\NewCommandCopy</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\moldusetheme</span></span>}{<span class="org-font-latex-sedate"><span class="org-function-name">\usetheme</span></span>}
<span class="org-font-latex-sedate"><span class="org-keyword">\renewcommand</span></span><span class="org-keyword">*</span>{<span class="org-font-latex-sedate"><span class="org-function-name">\usetheme</span></span>}[<span class="org-variable-name">2</span>][]{<span class="org-font-latex-sedate"><span class="org-function-name">\moldusetheme</span></span><span class="org-function-name">[#1]{#2}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\setbeamertemplate</span></span><span class="org-function-name">{items}{</span><span class="org-function-name"><span class="org-font-latex-math">$</span></span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-font-latex-math">\bullet</span></span></span><span class="org-function-name"><span class="org-font-latex-math">$</span></span><span class="org-function-name">}</span>
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name">\setbeamerfont</span></span><span class="org-function-name">{block title}{size=</span><span class="org-font-latex-sedate"><span class="org-type"><span class="org-function-name">\normalsize</span></span></span><span class="org-function-name">, series=</span><span class="org-font-latex-sedate"><span class="org-font-latex-bold"><span class="org-function-name">\bfseries</span></span></span><span class="org-font-latex-sedate"><span class="org-function-name">\parbox</span></span><span class="org-function-name">{0pt}{</span><span class="org-font-latex-sedate"><span class="org-function-name">\rule</span></span><span class="org-function-name">{0pt}{4ex}}}</span>}

<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatletter</span></span>
<span class="org-font-latex-sedate"><span class="org-keyword">\newcommand</span></span>{<span class="org-font-latex-sedate"><span class="org-function-name">\setmetropolislinewidth</span></span>}{
<span class="org-function-name">  </span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-keyword">\setlength</span></span></span><span class="org-function-name">{</span><span class="org-font-latex-sedate"><span class="org-function-name"><span class="org-variable-name">\metropolis@progressinheadfoot@linewidth</span></span></span><span class="org-function-name">}{</span><span class="org-function-name"><span class="org-variable-name">1.2px</span></span><span class="org-function-name">}</span>}
<span class="org-font-latex-sedate"><span class="org-font-latex-warning">\makeatother</span></span>

<span class="org-font-latex-sedate"><span class="org-keyword">\usepackage</span></span>{<span class="org-function-name">etoolbox</span>}
<span class="org-font-latex-sedate">\AtEndPreamble</span>{<span class="org-font-latex-sedate">\setmetropolislinewidth</span>}
</pre>
</div>
</details>

<p>
Now let's just apply this along with some extra beamer tweaks.
</p>

<details id='beamer-export,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#beamer-export,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-beamer-p</span> (info)
  (eq 'beamer (<span class="org-keyword">and</span> (plist-get info <span class="org-builtin">:back-end</span>)
                   (org-export-backend-name (plist-get info <span class="org-builtin">:back-end</span>)))))

(<span class="org-keyword">org-export-update-features</span> 'beamer
  (beamer-setup
   <span class="org-builtin">:condition</span> t
   <span class="org-builtin">:requires</span> .missing-koma
   <span class="org-builtin">:prevents</span> (italic-quotes condensed-lists cover-page)))

(<span class="org-keyword">org-export-update-features</span> 'latex
  (.missing-koma
   <span class="org-builtin">:snippet</span> <span class="org-string">"\\usepackage{scrextend}"</span>
   <span class="org-builtin">:order</span> 2))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-beamer-metropolis-tweaks</span>
  &lt;&lt;grab(<span class="org-string">"beamer-metropolis-tweaks"</span>)&gt;&gt;
  <span class="org-string">"LaTeX preamble snippet that tweaks the Beamer metropolis theme styling."</span>)

(<span class="org-keyword">org-export-update-features</span> 'beamer
  (beamer-metropolis
   <span class="org-builtin">:condition</span> (string-match-p <span class="org-string">"metropolis$"</span> (plist-get info <span class="org-builtin">:beamer-theme</span>))
   <span class="org-builtin">:snippet</span> org-beamer-metropolis-tweaks
   <span class="org-builtin">:order</span> 3))
</pre>
</div>
</details>

<p>
And I think that it's natural to divide a presentation into sections, e.g.
Introduction, Overview&#x2026; so let's set bump up the headline level that becomes a
frame from <code>1</code> to <code>2</code>.
</p>
<details id='beamer-export,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#beamer-export,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-beamer-frame-level 2)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-reveal-export" class="outline-4">
<h4 id="reveal-export"><span class="section-number-4">5.3.9.</span> Reveal export<a aria-hidden="true" href="#reveal-export">#</a> </h4>
<div class="outline-text-4" id="text-5-3-9">
<p>
By default reveal is rather nice, there are just a few tweaks that I consider a
good idea.
</p>

<details id='reveal-export,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#reveal-export,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-re-reveal-theme <span class="org-string">"white"</span>
      org-re-reveal-transition <span class="org-string">"slide"</span>
      org-re-reveal-plugins '(markdown notes math search zoom))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-ascii-export" class="outline-4">
<h4 id="ascii-export"><span class="section-number-4">5.3.10.</span> <span class='acr'><span class='acr'>ASCII</span></span> export<a aria-hidden="true" href="#ascii-export">#</a> </h4>
<div class="outline-text-4" id="text-5-3-10">
<p>
To start with, why settle for <span class='acr'>ASCII</span> when <span class='acr'>UTF</span>-8 exists?
</p>
<details id='ascii-export,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ascii-export,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-ascii-charset 'utf-8)
</pre>
</div>
</details>

<p>
The <span class='acr'>ASCII</span> export is generally fairly nice. I think the main aspect that could
benefit from improvement is the appearance of LaTeX fragments. There's a nice
utility we can use to create unicode representation, which are much nicer.
It's called <code>latex2text</code>, and it's part of the <kbd>pylatexenc</kbd> package, and it's <a href="https://repology.org/project/python:pylatexenc/versions">not
really packaged</a>. So, we'll resort to installing it with <kbd>pip</kbd>.
</p>

<details id='ascii-export,code--2' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#ascii-export,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">sudo python3 -m pip install pylatexenc
</pre>
</div>
</details>

<p>
With an accompanying <kbd>doctor</kbd> check.
</p>

<details id='ascii-export,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ascii-export,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (executable-find <span class="org-string">"latex2text"</span>)
  (warn! <span class="org-string">"Couldn't find latex2text executable (from pylatexenc), will be unable to render LaTeX fragments in org&#8594;text exports."</span>))
</pre>
</div>
</details>

<p>
With that installed, we can override the <code class="src src-elisp">(org-ascii-latex-fragment)</code> and
<code class="src src-elisp">(org-ascii-latex-environment)</code> functions, which are conveniently very
slim &#x2014; just extracting the content, and indenting. We'll only do something
different when <kbd>utf-8</kbd> is set.
</p>

<details id='ascii-export,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ascii-export,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (executable-find <span class="org-string">"latex2text"</span>)
  (<span class="org-keyword">after!</span> ox-ascii
    (<span class="org-keyword">defvar</span> <span class="org-variable-name">org-ascii-convert-latex</span> t
      <span class="org-doc">"Use latex2text to convert LaTeX elements to unicode."</span>)

    (<span class="org-keyword">defadvice!</span> org-ascii-latex-environment-unicode-a (latex-environment _contents info)
      <span class="org-doc">"Transcode a LATEX-ENVIRONMENT element from Org to ASCII, converting to unicode.</span>
<span class="org-doc">CONTENTS is nil.  INFO is a plist holding contextual</span>
<span class="org-doc">information."</span>
      <span class="org-builtin">:override</span> #'org-ascii-latex-environment
      (<span class="org-keyword">when</span> (plist-get info <span class="org-builtin">:with-latex</span>)
        (org-ascii--justify-element
         (org-remove-indentation
          (<span class="org-keyword">let*</span> ((latex (org-element-property <span class="org-builtin">:value</span> latex-environment))
                 (unicode (<span class="org-keyword">and</span> (eq (plist-get info <span class="org-builtin">:ascii-charset</span>) 'utf-8)
                               org-ascii-convert-latex
                               (doom-call-process <span class="org-string">"latex2text"</span> <span class="org-string">"-q"</span> <span class="org-string">"--code"</span> latex))))
            (<span class="org-keyword">if</span> (= (car unicode) 0) <span class="org-comment-delimiter">; </span><span class="org-comment">utf-8 set, and sucessfully ran latex2text</span>
                (cdr unicode) latex)))
         latex-environment info)))

    (<span class="org-keyword">defadvice!</span> org-ascii-latex-fragment-unicode-a (latex-fragment _contents info)
      <span class="org-doc">"Transcode a LATEX-FRAGMENT object from Org to ASCII, converting to unicode.</span>
<span class="org-doc">CONTENTS is nil.  INFO is a plist holding contextual</span>
<span class="org-doc">information."</span>
      <span class="org-builtin">:override</span> #'org-ascii-latex-fragment
      (<span class="org-keyword">when</span> (plist-get info <span class="org-builtin">:with-latex</span>)
        (<span class="org-keyword">let*</span> ((latex (org-element-property <span class="org-builtin">:value</span> latex-fragment))
               (unicode (<span class="org-keyword">and</span> (eq (plist-get info <span class="org-builtin">:ascii-charset</span>) 'utf-8)
                             org-ascii-convert-latex
                             (doom-call-process <span class="org-string">"latex2text"</span> <span class="org-string">"-q"</span> <span class="org-string">"--code"</span> latex))))
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> unicode (= (car unicode) 0)) <span class="org-comment-delimiter">; </span><span class="org-comment">utf-8 set, and sucessfully ran latex2text</span>
              (cdr unicode) latex))))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-markdown-export" class="outline-4">
<h4 id="markdown-export"><span class="section-number-4">5.3.11.</span> Markdown Export<a aria-hidden="true" href="#markdown-export">#</a> </h4>
<div class="outline-text-4" id="text-5-3-11">
</div>
<div id="outline-container-gfm" class="outline-5">
<h5 id="gfm"><span class="section-number-5">5.3.11.1.</span> <span class='acr'><span class='acr'>GFM</span></span><a aria-hidden="true" href="#gfm">#</a> </h5>
<div class="outline-text-5" id="text-5-3-11-1">
<p>
Because of the <i><a href="https://github.com/commonmark/commonmark-spec/wiki/markdown-flavors">lovely variety in markdown implementations</a></i> there isn't actually
such a thing a standard table spec &#x2026; or standard anything really. Because
<code>org-md</code> is a goody-two-shoes, it just uses <span class='acr'>HTML</span> for all these non-standardised
elements (a lot of them). So <code>ox-gfm</code> is handy for exporting markdown with all the
features that GitHub has.
</p>

<details id='gfm,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gfm,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> ox-gfm <span class="org-builtin">:pin</span> <span class="org-string">"4f774f13d34b3db9ea4ddb0b1edc070b1526ccbb"</span>)
</pre>
</div>
</details>

<details id='gfm,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gfm,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! ox-gfm
  <span class="org-builtin">:after</span> ox)
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-character-substitutions" class="outline-5">
<h5 id="character-substitutions"><span class="section-number-5">5.3.11.2.</span> Character substitutions<a aria-hidden="true" href="#character-substitutions">#</a> </h5>
<div class="outline-text-5" id="text-5-3-11-2">
<p>
When I want to paste exported markdown somewhere (for example when using <a href="#emacs-everywhere">Emacs
Everywhere</a>), it can be preferable to have unicode characters for <kbd>---</kbd> etc. instead
of <kbd>&amp;#x2014;</kbd>.
</p>

<p>
To accomplish this, we just need to locally rebind the alist which provides
these substitution.
</p>

<details id='character-substitutions,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#character-substitutions,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice!</span> org-md-plain-text-unicode-a (orig-fn text info)
  <span class="org-doc">"Locally rebind `</span><span class="org-doc"><span class="org-constant">org-html-special-string-regexps</span></span><span class="org-doc">'"</span>
  <span class="org-builtin">:around</span> #'org-md-plain-text
  (<span class="org-keyword">let</span> ((org-html-special-string-regexps
         '((<span class="org-string">"\\\\-"</span> . <span class="org-string">"-"</span>)
           (<span class="org-string">"---</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">-]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">$</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> . <span class="org-string">"&#8212;\\1"</span>)
           (<span class="org-string">"--</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">-]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">$</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> . <span class="org-string">"&#8211;\\1"</span>)
           (<span class="org-string">"\\.\\.\\."</span> . <span class="org-string">"&#8230;"</span>)
           (<span class="org-string">"&lt;-&gt;"</span> . <span class="org-string">"&#10231;"</span>)
           (<span class="org-string">"-&gt;"</span> . <span class="org-string">"&#8594;"</span>)
           (<span class="org-string">"&lt;-"</span> . <span class="org-string">"&#8592;"</span>))))
    (funcall orig-fn text (plist-put info <span class="org-builtin">:with-smart-quotes</span> nil))))
</pre>
</div>
</details>

<p>
In the future, I may want to check <kbd>info</kbd> to only have this active when <kbd>ox-gfm</kbd> is
being used.
</p>

<p>
Another worthwhile consideration is LaTeX formatting. It seems most Markdown
parsers are fixated on TeX-style syntax (<kbd>$</kbd> and <kbd>$$</kbd>). As unfortunate as this is,
it's probably best to accommodate them, for the sake of decent rendering.
</p>

<p>
<kbd>ox-md</kbd> doesn't provide any transcoders for this, so we'll have to whip up our own
and push them onto the <kbd>md</kbd> transcoders alist.
</p>

<details id='character-substitutions,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#character-substitutions,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> ox-md
  (<span class="org-keyword">defun</span> <span class="org-function-name">org-md-latex-fragment</span> (latex-fragment _contents info)
    <span class="org-doc">"Transcode a LATEX-FRAGMENT object from Org to Markdown."</span>
    (<span class="org-keyword">let</span> ((frag (org-element-property <span class="org-builtin">:value</span> latex-fragment)))
      (<span class="org-keyword">cond</span>
       ((string-match-p <span class="org-string">"^\\\\("</span> frag)
        (concat <span class="org-string">"$"</span> (substring frag 2 -2) <span class="org-string">"$"</span>))
       ((string-match-p <span class="org-string">"^\\\\\\["</span> frag)
        (concat <span class="org-string">"$$"</span> (substring frag 2 -2) <span class="org-string">"$$"</span>))
       (t (message <span class="org-string">"unrecognised fragment: %s"</span> frag)
          frag))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">org-md-latex-environment</span> (latex-environment contents info)
    <span class="org-doc">"Transcode a LATEX-ENVIRONMENT object from Org to Markdown."</span>
    (concat <span class="org-string">"$$\n"</span>
            (org-html-latex-environment latex-environment contents info)
            <span class="org-string">"$$\n"</span>))

  (<span class="org-keyword">defun</span> <span class="org-function-name">org-utf8-entity</span> (entity _contents _info)
    <span class="org-doc">"Transcode an ENTITY object from Org to utf-8.</span>
<span class="org-doc">CONTENTS are the definition itself.  INFO is a plist holding</span>
<span class="org-doc">contextual information."</span>
    (org-element-property <span class="org-builtin">:utf-8</span> entity))

  <span class="org-comment-delimiter">;; </span><span class="org-comment">We can't let this be immediately parsed and evaluated,</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">because eager macro-expansion tries to call as-of-yet</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">undefined functions.</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">NOTE in the near future this shouldn't be required</span>
  (eval
   '(dolist (extra-transcoder
             '((latex-fragment . org-md-latex-fragment)
               (latex-environment . org-md-latex-environment)
               (entity . org-utf8-entity)))
      (<span class="org-keyword">unless</span> (member extra-transcoder (org-export-backend-transcoders
                                        (org-export-get-backend 'md)))
        (<span class="org-keyword">push</span> extra-transcoder (org-export-backend-transcoders
                                (org-export-get-backend 'md)))))))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-babel" class="outline-4">
<h4 id="babel"><span class="section-number-4">5.3.12.</span> Babel<a aria-hidden="true" href="#babel">#</a> </h4>
<div class="outline-text-4" id="text-5-3-12">
<p>
Doom lazy-loads babel languages, with is lovely.
It also pulls in <a href="https://github.com/astahlman/ob-async">ob-async</a>, which is nice, but it would be even better if it was
used by default.
</p>

<p>
There are two caveats to <kbd>ob-async</kbd>:
</p>
<ol class="org-ol">
<li>It does not support <kbd>:session</kbd>
<ul class="org-ul">
<li>So, we don't want <kbd>:async</kbd> used when <kbd>:session</kbd> is set</li>
</ul></li>
<li>It adds a fixed delay to execution
<ul class="org-ul">
<li>This is undesirable in a number of cases, for example it's generally
unwanted with <kbd>emacs-lisp</kbd> code</li>
<li>As such, I also introduce a async language blacklist to control when it's
automatically enabled</li>
</ul></li>
</ol>

<p>
Due to the nuance in the desired behaviour, instead of just adding <kbd>:async</kbd> to
<code>org-babel-default-header-args</code>, I advice <code>org-babel-get-src-block-info</code> to add
<kbd>:async</kbd> intelligently. As an escape hatch, it also recognises <kbd>:sync</kbd> as an
indication that <kbd>:async</kbd> should not be added.
</p>

<p>
I did originally have this enabled for everything except for <kbd>emacs-lisp</kbd> and
<kbd>LaTeX</kbd> (there were weird issues), but this added  a ~3s "startup" cost to every
src block evaluation, which was a bit of a pain. Since <kbd>:async</kbd> can be added
easily with <kbd>#+properties</kbd>, I've turned this behaviour from a blacklist to a
whitelist.
</p>

<details id='babel,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#babel,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">add-transient-hook!</span> #'org-babel-execute-src-block
  (<span class="org-keyword">require</span> '<span class="org-constant">ob-async</span>))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-babel-auto-async-languages</span> '()
  <span class="org-doc">"Babel languages which should be executed asyncronously by default."</span>)

(<span class="org-keyword">defadvice!</span> org-babel-get-src-block-info-eager-async-a (orig-fn <span class="org-type">&amp;optional</span> light datum)
  <span class="org-doc">"Eagarly add an :async parameter to the src information, unless it seems problematic.</span>
<span class="org-doc">This only acts o languages in `</span><span class="org-doc"><span class="org-constant">org-babel-auto-async-languages</span></span><span class="org-doc">'.</span>
<span class="org-doc">Not added when either:</span>
<span class="org-doc">+ session is not \"none\"</span>
<span class="org-doc">+ :sync is set"</span>
  <span class="org-builtin">:around</span> #'org-babel-get-src-block-info
  (<span class="org-keyword">let</span> ((result (funcall orig-fn light datum)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string= <span class="org-string">"none"</span> (cdr (assoc <span class="org-builtin">:session</span> (caddr result))))
               (member (car result) org-babel-auto-async-languages)
               (not (assoc <span class="org-builtin">:async</span> (caddr result))) <span class="org-comment-delimiter">; </span><span class="org-comment">don't duplicate</span>
               (not (assoc <span class="org-builtin">:sync</span> (caddr result))))
      (<span class="org-keyword">push</span> '(<span class="org-builtin">:async</span>) (caddr result)))
    result))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-ess" class="outline-4">
<h4 id="ess"><span class="section-number-4">5.3.13.</span> <span class='acr'><span class='acr'>ESS</span></span><a aria-hidden="true" href="#ess">#</a> </h4>
<div class="outline-text-4" id="text-5-3-13">
<p>
We don't want <code>R</code> evaluation to hang the editor, hence
</p>
<details id='ess,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ess,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> ess-eval-visibly 'nowait)
</pre>
</div>
</details>

<p>
Syntax highlighting is nice, so let's turn all of that on
</p>
<details id='ess,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ess,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> ess-R-font-lock-keywords
      '((ess-R-fl-keyword:keywords . t)
        (ess-R-fl-keyword:constants . t)
        (ess-R-fl-keyword:modifiers . t)
        (ess-R-fl-keyword:fun-defs . t)
        (ess-R-fl-keyword:assign-ops . t)
        (ess-R-fl-keyword:%op% . t)
        (ess-fl-keyword:fun-calls . t)
        (ess-fl-keyword:numbers . t)
        (ess-fl-keyword:operators . t)
        (ess-fl-keyword:delimiters . t)
        (ess-fl-keyword:= . t)
        (ess-R-fl-keyword:F&amp;T . t)))
</pre>
</div>
</details>

<p>
Lastly, in the event that I use <kbd>JAGS</kbd>, it would be nice to be able to use <kbd>jags</kbd> as
the language identifier, not <kbd>ess-jags</kbd>.
</p>
<details id='ess,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#ess,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> org
  (add-to-list '+org-babel-mode-alist '(jags . ess-jags)))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-latex" class="outline-3">
<h3 id="latex"><span class="section-number-3">5.4.</span> LaTeX<a aria-hidden="true" href="#latex">#</a> </h3>
<div class="outline-text-3" id="text-5-4">
<p>

</p>
</div>
<div id="outline-container-be-implemented-ideas" class="outline-4">
<h4 id="be-implemented-ideas"><span class="section-number-4">5.4.1.</span> To-be-implemented ideas<a aria-hidden="true" href="#be-implemented-ideas">#</a> </h4>
<div class="outline-text-4" id="text-5-4-1">
<ul class="org-ul">
<li><p>
Paste image from clipboard
</p>
<ul class="org-ul">
<li>Determine first folder in <code>graphicspath</code> if applicable</li>
<li>Ask for file name</li>
<li>Use <code>xclip</code> to save file to graphics folder, or current directory (whichever applies)</li>
</ul>
<details id=',code--1' class='code' open><summary><span class="lang">Shell Script</span></summary>
<div class='gutter'>
<a href='#,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-shell">command -v xclip &gt;/dev/null 2&gt;&amp;1 || { <span class="org-builtin">echo</span> &gt;&amp;1 <span class="org-string">"no xclip"</span>; <span class="org-keyword">exit</span> 1; }

<span class="org-keyword">if</span>
    xclip -selection clipboard -target image/png -o &gt;/dev/null 2&gt;&amp;1
<span class="org-keyword">then</span>
    xclip -selection clipboard -target image/png -o &gt;$<span class="org-variable-name">1</span> 2&gt;/dev/null
    <span class="org-builtin">echo</span> $<span class="org-variable-name">1</span>
<span class="org-keyword">else</span>
    <span class="org-builtin">echo</span> <span class="org-string">"no image"</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</details>
<ul class="org-ul">
<li>Insert figure, with filled in details as a result (activate <kbd>yasnippet</kbd> with
filename as variable maybe?)</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-compilation" class="outline-4">
<h4 id="compilation"><span class="section-number-4">5.4.2.</span> Compilation<a aria-hidden="true" href="#compilation">#</a> </h4>
<div class="outline-text-4" id="text-5-4-2">
<details id='compilation,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#compilation,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> TeX-save-query nil
      TeX-show-compilation t
      TeX-command-extra-options <span class="org-string">"-shell-escape"</span>)
(<span class="org-keyword">after!</span> latex
  (add-to-list 'TeX-command-list '(<span class="org-string">"XeLaTeX"</span> <span class="org-string">"%`xelatex%(mode)%' %t"</span> TeX-run-TeX nil t)))
</pre>
</div>
</details>

<p>
For viewing the <span class='acr'>PDF</span>, I rather like the pdf-tools viewer. While auctex is trying
to be nice in recognising that I have some <span class='acr'>PDF</span> viewing apps installed, I'd
rather not have it default to using them, so let's re-order the preferences.
</p>
<details id='compilation,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#compilation,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> +latex-viewers '(pdf-tools evince zathura okular skim sumatrapdf))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-latex-snippet-helpers" class="outline-4">
<h4 id="latex-snippet-helpers"><span class="section-number-4">5.4.3.</span> Snippet helpers<a aria-hidden="true" href="#latex-snippet-helpers">#</a> </h4>
<div class="outline-text-4" id="text-5-4-3">
</div>
<div id="outline-container-template" class="outline-5">
<h5 id="template"><span class="section-number-5">5.4.3.1.</span> Template<a aria-hidden="true" href="#template">#</a> </h5>
<div class="outline-text-5" id="text-5-4-3-1">
<p>
For use in the new-file template, let's set out a nice preamble we may want to use.
</p>
<details id='latex-nice-preamble' class='code' open><summary class='named'><span class="name">latex-nice-preamble</span><span class="lang">LaTeX</span></summary>
<div class='gutter'>
<a href='#latex-nice-preamble'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-latex"><span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">pdfa,unicode=true,hidelinks</span>]{<span class="org-function-name">hyperref</span>}

<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">dvipsnames,svgnames,table,hyperref</span>]{<span class="org-function-name">xcolor</span>}
<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">renewcommand</span>{<span class="org-function-name"><span class="org-font-latex-warning">\\</span></span><span class="org-function-name">UrlFont</span>}{<span class="org-function-name"><span class="org-font-latex-warning">\</span></span><span class="org-type"><span class="org-function-name"><span class="org-font-latex-warning">\</span></span></span><span class="org-type"><span class="org-function-name">ttfamily</span></span><span class="org-function-name"><span class="org-font-latex-warning">\</span></span><span class="org-type"><span class="org-function-name"><span class="org-font-latex-warning">\</span></span></span><span class="org-type"><span class="org-function-name">small</span></span>}

<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">a-2b</span>]{<span class="org-function-name">pdfx</span>} <span class="org-comment">% why not be archival</span>

<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">T1</span>]{<span class="org-function-name">fontenc</span>}
<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">osf</span>]{<span class="org-function-name">newpxtext</span>}  <span class="org-comment">% Palatino</span>
<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>{<span class="org-function-name">gillius</span>}
<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">scale=0.9</span>]{<span class="org-function-name">sourcecodepro</span>}

<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>{<span class="org-function-name">mathtools</span>}
<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>{<span class="org-function-name">amssymb</span>}
<span class="org-font-latex-warning">\\</span>let<span class="org-font-latex-warning">\\</span>Bbbk<span class="org-font-latex-warning">\\</span>relax
<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">varbb</span>]{<span class="org-function-name">newpxmath</span>}

<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>[<span class="org-variable-name">activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000</span>]{<span class="org-function-name">microtype</span>}
<span class="org-comment-delimiter">% </span><span class="org-comment">microtype makes text look nicer</span>

<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>{<span class="org-function-name">graphicx</span>} <span class="org-comment">% include graphics</span>

<span class="org-font-latex-warning">\</span><span class="org-keyword"><span class="org-font-latex-warning">\</span></span><span class="org-keyword">usepackage</span>{<span class="org-function-name">booktabs</span>} <span class="org-comment">% nice table rules</span>
</pre>
</div>
</details>
<p>
Then let's bind the content to a function, and define some nice helpers.
</p>
<details id='template,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#template,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> tec/yas-latex-template-preamble <span class="org-string">"</span>
<span class="org-string">&lt;&lt;latex-nice-preamble&gt;&gt;</span>
<span class="org-string">"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">tec/yas-latex-get-class-choice</span> ()
  <span class="org-doc">"Prompt user for LaTeX class choice"</span>
  (<span class="org-keyword">setq</span> tec/yas-latex-class-choice (completing-read <span class="org-string">"Select document class: "</span> '(<span class="org-string">"article"</span> <span class="org-string">"scrartcl"</span> <span class="org-string">"bmc"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">tec/yas-latex-preamble-if</span> ()
  <span class="org-doc">"Based on class choice prompt for insertion of default preamble"</span>
  (<span class="org-keyword">if</span> (equal tec/yas-latex-class-choice <span class="org-string">"bmc"</span>) 'nil
    (eq (read-char-choice <span class="org-string">"Include default preamble? [Type y/n]"</span> '(?y ?n)) ?y)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-deliminators" class="outline-5">
<h5 id="deliminators"><span class="section-number-5">5.4.3.2.</span> Deliminators<a aria-hidden="true" href="#deliminators">#</a> </h5>
<div class="outline-text-5" id="text-5-4-3-2">
<details id='deliminators,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#deliminators,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> tex
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">tec/tex-last-delim-char</span> nil
    <span class="org-doc">"Last open delim expanded in a tex document"</span>)
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">tec/tex-delim-dot-second</span> t
    <span class="org-doc">"When the `</span><span class="org-doc"><span class="org-constant">tec/tex-last-delim-char</span></span><span class="org-doc">' is . a second character (this) is prompted for"</span>)
  (<span class="org-keyword">defun</span> <span class="org-function-name">tec/get-open-delim-char</span> ()
    <span class="org-doc">"Exclusivly read next char to tec/tex-last-delim-char"</span>
    (<span class="org-keyword">setq</span> tec/tex-delim-dot-second nil)
    (<span class="org-keyword">setq</span> tec/tex-last-delim-char (read-char-exclusive <span class="org-string">"Opening deliminator, recognises: 9 ( [ { &lt; | ."</span>))
    (<span class="org-keyword">when</span> (eql ?. tec/tex-last-delim-char)
      (<span class="org-keyword">setq</span> tec/tex-delim-dot-second (read-char-exclusive <span class="org-string">"Other deliminator, recognises: 0 9 (  ) [ ] { } &lt; &gt; |"</span>))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">tec/tex-open-delim-from-char</span> (<span class="org-type">&amp;optional</span> open-char)
    <span class="org-doc">"Find the associated opening delim as string"</span>
    (<span class="org-keyword">unless</span> open-char (<span class="org-keyword">setq</span> open-char (<span class="org-keyword">if</span> (eql ?. tec/tex-last-delim-char)
                                          tec/tex-delim-dot-second
                                        tec/tex-last-delim-char)))
    (<span class="org-keyword">pcase</span> open-char
      (?\( <span class="org-string">"("</span>)
      (?9  <span class="org-string">"("</span>)
      (?\[ <span class="org-string">"["</span>)
      (?\{ <span class="org-string">"\\{"</span>)
      (?&lt;  <span class="org-string">"&lt;"</span>)
      (?|  (<span class="org-keyword">if</span> tec/tex-delim-dot-second <span class="org-string">"."</span> <span class="org-string">"|"</span>))
      (_   <span class="org-string">"."</span>)))
  (<span class="org-keyword">defun</span> <span class="org-function-name">tec/tex-close-delim-from-char</span> (<span class="org-type">&amp;optional</span> open-char)
    <span class="org-doc">"Find the associated closing delim as string"</span>
    (<span class="org-keyword">if</span> tec/tex-delim-dot-second
        (<span class="org-keyword">pcase</span> tec/tex-delim-dot-second
          (?\) <span class="org-string">")"</span>)
          (?0  <span class="org-string">")"</span>)
          (?\] <span class="org-string">"]"</span>)
          (?\} <span class="org-string">"\\}"</span>)
          (?\&gt; <span class="org-string">"&gt;"</span>)
          (?|  <span class="org-string">"|"</span>)
          (_   <span class="org-string">"."</span>))
      (<span class="org-keyword">pcase</span> (<span class="org-keyword">or</span> open-char tec/tex-last-delim-char)
        (?\( <span class="org-string">")"</span>)
        (?9  <span class="org-string">")"</span>)
        (?\[ <span class="org-string">"]"</span>)
        (?\{ <span class="org-string">"\\}"</span>)
        (?&lt;  <span class="org-string">"&gt;"</span>)
        (?\) <span class="org-string">")"</span>)
        (?0  <span class="org-string">")"</span>)
        (?\] <span class="org-string">"]"</span>)
        (?\} <span class="org-string">"\\}"</span>)
        (?\&gt; <span class="org-string">"&gt;"</span>)
        (?|  <span class="org-string">"|"</span>)
        (_   <span class="org-string">"."</span>))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">tec/tex-next-char-smart-close-delim</span> (<span class="org-type">&amp;optional</span> open-char)
    (<span class="org-keyword">and</span> (<span class="org-keyword">bound-and-true-p</span> smartparens-mode)
         (eql (char-after) (<span class="org-keyword">pcase</span> (<span class="org-keyword">or</span> open-char tec/tex-last-delim-char)
                             (?\( ?\))
                             (?\[ ?\])
                             (?{ ?})
                             (?&lt; ?&gt;)))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">tec/tex-delim-yas-expand</span> (<span class="org-type">&amp;optional</span> open-char)
    (yas-expand-snippet (yas-lookup-snippet <span class="org-string">"_deliminators"</span> 'latex-mode) (point) (+ (point) (<span class="org-keyword">if</span> (tec/tex-next-char-smart-close-delim open-char) 2 1)))))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-editor-visuals" class="outline-4">
<h4 id="editor-visuals"><span class="section-number-4">5.4.4.</span> Editor visuals<a aria-hidden="true" href="#editor-visuals">#</a> </h4>
<div class="outline-text-4" id="text-5-4-4">
<p>
Let's enhance <code>TeX-fold-math</code> a bit
</p>
<details id='editor-visuals,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#editor-visuals,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> latex
  (setcar (assoc <span class="org-string">"&#8902;"</span> LaTeX-fold-math-spec-list) <span class="org-string">"&#9733;"</span>)) <span class="org-comment-delimiter">;; </span><span class="org-comment">make \star bigger</span>

(<span class="org-keyword">setq</span> TeX-fold-math-spec-list
      `(<span class="org-comment-delimiter">;; </span><span class="org-comment">missing/better symbols</span>
        (<span class="org-string">"&#8804;"</span> (<span class="org-string">"le"</span>))
        (<span class="org-string">"&#8805;"</span> (<span class="org-string">"ge"</span>))
        (<span class="org-string">"&#8800;"</span> (<span class="org-string">"ne"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">convenience shorts -- these don't work nicely ATM</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">("&#8249;" ("left"))</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">("&#8250;" ("right"))</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">private macros</span>
        (<span class="org-string">"&#8477;"</span> (<span class="org-string">"RR"</span>))
        (<span class="org-string">"&#8469;"</span> (<span class="org-string">"NN"</span>))
        (<span class="org-string">"&#8484;"</span> (<span class="org-string">"ZZ"</span>))
        (<span class="org-string">"&#8474;"</span> (<span class="org-string">"QQ"</span>))
        (<span class="org-string">"&#8450;"</span> (<span class="org-string">"CC"</span>))
        (<span class="org-string">"&#8473;"</span> (<span class="org-string">"PP"</span>))
        (<span class="org-string">"&#8461;"</span> (<span class="org-string">"HH"</span>))
        (<span class="org-string">"&#120124;"</span> (<span class="org-string">"EE"</span>))
        (<span class="org-string">"&#119889;"</span> (<span class="org-string">"dd"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">known commands</span>
        (<span class="org-string">""</span> (<span class="org-string">"phantom"</span>))
        (,(<span class="org-keyword">lambda</span> (num den) (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (TeX-string-single-token-p num) (TeX-string-single-token-p den))
                                (concat num <span class="org-string">"&#65295;"</span> den)
                              (concat <span class="org-string">"&#10090;"</span> num <span class="org-string">"&#65295;"</span> den <span class="org-string">"&#10091;"</span>))) <span class="org-warning">(</span><span class="org-string"><span class="org-warning">"frac"</span></span><span class="org-warning">))</span>
        (,(<span class="org-keyword">lambda</span> (arg) (concat <span class="org-string">"&#8730;"</span> (TeX-fold-parenthesize-as-necessary arg))) (<span class="org-string">"sqrt"</span>))
        (,(<span class="org-keyword">lambda</span> (arg) (concat <span class="org-string">"&#11105;"</span> (TeX-fold-parenthesize-as-necessary arg))) (<span class="org-string">"vec"</span>))
        (<span class="org-string">"&#8216;</span><span class="org-string"><span class="org-constant">{1}</span></span><span class="org-string">&#8217;"</span> (<span class="org-string">"text"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">private commands</span>
        (<span class="org-string">"|{1}|"</span> (<span class="org-string">"abs"</span>))
        (<span class="org-string">"&#8214;{1}&#8214;"</span> (<span class="org-string">"norm"</span>))
        (<span class="org-string">"&#8970;{1}&#8971;"</span> (<span class="org-string">"floor"</span>))
        (<span class="org-string">"&#8968;{1}&#8969;"</span> (<span class="org-string">"ceil"</span>))
        (<span class="org-string">"&#8970;{1}&#8969;"</span> (<span class="org-string">"round"</span>))
        (<span class="org-string">"&#119889;{1}/&#119889;{2}"</span> (<span class="org-string">"dv"</span>))
        (<span class="org-string">"&#8706;{1}/&#8706;{2}"</span> (<span class="org-string">"pdv"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">fancification</span>
        (<span class="org-string">"{1}"</span> (<span class="org-string">"mathrm"</span>))
        (,(<span class="org-keyword">lambda</span> (word) (string-offset-roman-chars 119743 word)) (<span class="org-string">"mathbf"</span>))
        (,(<span class="org-keyword">lambda</span> (word) (string-offset-roman-chars 119951 word)) (<span class="org-string">"mathcal"</span>))
        (,(<span class="org-keyword">lambda</span> (word) (string-offset-roman-chars 120003 word)) (<span class="org-string">"mathfrak"</span>))
        (,(<span class="org-keyword">lambda</span> (word) (string-offset-roman-chars 120055 word)) (<span class="org-string">"mathbb"</span>))
        (,(<span class="org-keyword">lambda</span> (word) (string-offset-roman-chars 120159 word)) (<span class="org-string">"mathsf"</span>))
        (,(<span class="org-keyword">lambda</span> (word) (string-offset-roman-chars 120367 word)) (<span class="org-string">"mathtt"</span>))
        )
      TeX-fold-macro-spec-list
      '(
        <span class="org-comment-delimiter">;; </span><span class="org-comment">as the defaults</span>
        (<span class="org-string">"[f]"</span> (<span class="org-string">"footnote"</span> <span class="org-string">"marginpar"</span>))
        (<span class="org-string">"[c]"</span> (<span class="org-string">"cite"</span>))
        (<span class="org-string">"[l]"</span> (<span class="org-string">"label"</span>))
        (<span class="org-string">"[r]"</span> (<span class="org-string">"ref"</span> <span class="org-string">"pageref"</span> <span class="org-string">"eqref"</span>))
        (<span class="org-string">"[i]"</span> (<span class="org-string">"index"</span> <span class="org-string">"glossary"</span>))
        (<span class="org-string">"..."</span> (<span class="org-string">"dots"</span>))
        (<span class="org-string">"{1}"</span> (<span class="org-string">"emph"</span> <span class="org-string">"textit"</span> <span class="org-string">"textsl"</span> <span class="org-string">"textmd"</span> <span class="org-string">"textrm"</span> <span class="org-string">"textsf"</span> <span class="org-string">"texttt"</span>
                <span class="org-string">"textbf"</span> <span class="org-string">"textsc"</span> <span class="org-string">"textup"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">tweaked defaults</span>
        (<span class="org-string">"&#169;"</span> (<span class="org-string">"copyright"</span>))
        (<span class="org-string">"&#174;"</span> (<span class="org-string">"textregistered"</span>))
        (<span class="org-string">"&#8482;"</span>  (<span class="org-string">"texttrademark"</span>))
        (<span class="org-string">"[1]:||&#9658;"</span> (<span class="org-string">"item"</span>))
        (<span class="org-string">"&#10081;&#10081;&#8198;{1}"</span> (<span class="org-string">"part"</span> <span class="org-string">"part*"</span>))
        (<span class="org-string">"&#10081;&#8198;{1}"</span> (<span class="org-string">"chapter"</span> <span class="org-string">"chapter*"</span>))
        (<span class="org-string">"&#167;&#8198;{1}"</span> (<span class="org-string">"section"</span> <span class="org-string">"section*"</span>))
        (<span class="org-string">"&#167;&#167;&#8198;{1}"</span> (<span class="org-string">"subsection"</span> <span class="org-string">"subsection*"</span>))
        (<span class="org-string">"&#167;&#167;&#167;&#8198;{1}"</span> (<span class="org-string">"subsubsection"</span> <span class="org-string">"subsubsection*"</span>))
        (<span class="org-string">"&#182;&#8198;{1}"</span> (<span class="org-string">"paragraph"</span> <span class="org-string">"paragraph*"</span>))
        (<span class="org-string">"&#182;&#182;&#8198;{1}"</span> (<span class="org-string">"subparagraph"</span> <span class="org-string">"subparagraph*"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">extra</span>
        (<span class="org-string">"&#11030;&#8198;{1}"</span> (<span class="org-string">"begin"</span>))
        (<span class="org-string">"&#11031;&#8198;{1}"</span> (<span class="org-string">"end"</span>))
        ))

(<span class="org-keyword">defun</span> <span class="org-function-name">string-offset-roman-chars</span> (offset word)
  <span class="org-doc">"Shift the codepoint of each character in WORD by OFFSET with an extra -6 shift if the letter is lowercase"</span>
  (apply 'string
         (mapcar (<span class="org-keyword">lambda</span> (c)
                   (string-offset-apply-roman-char-exceptions
                    (+ (<span class="org-keyword">if</span> (&gt;= c 97) (- c 6) c) offset)))
                 word)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">string-offset-roman-char-exceptions</span>
  '(<span class="org-comment-delimiter">;; </span><span class="org-comment">lowercase serif</span>
    (119892 .  8462) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8462;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">lowercase caligraphic</span>
    (119994 . 8495) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8495;</span>
    (119996 . 8458) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8458;</span>
    (120004 . 8500) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8500;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">caligraphic</span>
    (119965 . 8492) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8492;</span>
    (119968 . 8496) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8496;</span>
    (119969 . 8497) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8497;</span>
    (119971 . 8459) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8459;</span>
    (119972 . 8464) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8464;</span>
    (119975 . 8466) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8466;</span>
    (119976 . 8499) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8499;</span>
    (119981 . 8475) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8475;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">fraktur</span>
    (120070 . 8493) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8493;</span>
    (120075 . 8460) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8460;</span>
    (120076 . 8465) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8465;</span>
    (120085 . 8476) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8476;</span>
    (120092 . 8488) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8488;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">blackboard</span>
    (120122 . 8450) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8450;</span>
    (120127 . 8461) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8461;</span>
    (120133 . 8469) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8469;</span>
    (120135 . 8473) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8473;</span>
    (120136 . 8474) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8474;</span>
    (120137 . 8477) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8477;</span>
    (120145 . 8484) <span class="org-comment-delimiter">; </span><span class="org-comment">&#8484;</span>
    )
  <span class="org-doc">"An alist of deceptive codepoints, and then where the glyph actually resides."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">string-offset-apply-roman-char-exceptions</span> (char)
  <span class="org-doc">"Sometimes the codepoint doesn't contain the char you expect.</span>
<span class="org-doc">Such special cases should be remapped to another value, as given in `</span><span class="org-doc"><span class="org-constant">string-offset-roman-char-exceptions</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">if</span> (assoc char string-offset-roman-char-exceptions)
      (cdr (assoc char string-offset-roman-char-exceptions))
    char))

(<span class="org-keyword">defun</span> <span class="org-function-name">TeX-fold-parenthesize-as-necessary</span> (tokens <span class="org-type">&amp;optional</span> suppress-left suppress-right)
  <span class="org-doc">"Add &#10090; &#10091; parenthesis as if multiple LaTeX tokens appear to be present"</span>
  (<span class="org-keyword">if</span> (TeX-string-single-token-p tokens) tokens
    (concat (<span class="org-keyword">if</span> suppress-left <span class="org-string">""</span> <span class="org-string">"&#10090;"</span>)
            tokens
            (<span class="org-keyword">if</span> suppress-right <span class="org-string">""</span> <span class="org-string">"&#10091;"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">TeX-string-single-token-p</span> (teststring)
  <span class="org-doc">"Return t if TESTSTRING appears to be a single token, nil otherwise"</span>
  (<span class="org-keyword">if</span> (string-match-p <span class="org-string">"^\\\\?\\w+$"</span> teststring) t nil))
</pre>
</div>
</details>

<p>
Some local keybindings to make life a bit easier
</p>
<details id='editor-visuals,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#editor-visuals,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> tex
  (map!
   <span class="org-builtin">:map</span> LaTeX-mode-map
   <span class="org-builtin">:ei</span> [C-return] #'LaTeX-insert-item)
  (<span class="org-keyword">setq</span> TeX-electric-math '(<span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span> . <span class="org-string">""</span>)))
</pre>
</div>
</details>

<p>
Maths deliminators can be de-emphasised a bit
</p>
<details id='editor-visuals,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#editor-visuals,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Making \( \) less visible</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">unimportant-latex-face</span>
  '((t <span class="org-builtin">:inherit</span> font-lock-comment-face <span class="org-builtin">:weight</span> extra-light))
  <span class="org-doc">"Face used to make \\(\\), \\[</span><span class="org-doc"><span class="org-constant">\\</span></span><span class="org-doc">] less visible."</span>
  <span class="org-builtin">:group</span> 'LaTeX-math)

(font-lock-add-keywords
 'latex-mode
 `((<span class="org-string">"\\\\[]()[]"</span> 0 'unimportant-latex-face prepend))
 'end)

<span class="org-comment-delimiter">;; </span><span class="org-comment">(font-lock-add-keywords</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">'latex-mode</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">'(("\\\\[[:word:]]+" 0 'font-lock-keyword-face prepend))</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">'end)</span>
</pre>
</div>
</details>

<p>
And enable shell escape for the preview
</p>
<details id='editor-visuals,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#editor-visuals,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> preview-LaTeX-command '(<span class="org-string">"%`%l \"\\nonstopmode\\nofiles\</span>
<span class="org-string">\\PassOptionsToPackage{"</span> (<span class="org-string">","</span> . preview-required-option-list) <span class="org-string">"}{preview}\</span>
<span class="org-string">\\AtBeginDocument{\\ifx\\ifPreview\\undefined"</span>
preview-default-preamble <span class="org-string">"\\fi}\"%' \"\\detokenize{\" %t \"}\""</span>))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-math-input" class="outline-4">
<h4 id="math-input"><span class="section-number-4">5.4.5.</span> Math input<a aria-hidden="true" href="#math-input">#</a> </h4>
<div class="outline-text-4" id="text-5-4-5">
</div>
<div id="outline-container-cdlatex" class="outline-5">
<h5 id="cdlatex"><span class="section-number-5">5.4.5.1.</span> CDLaTeX<a aria-hidden="true" href="#cdlatex">#</a> </h5>
<div class="outline-text-5" id="text-5-4-5-1">
<p>
The symbols and modifies are very nice by default, but could do with a bit of
fleshing out. Let's change the prefix to a key which is similarly rarely used,
but more convenient, like <kbd>;</kbd>.
</p>
<details id='cdlatex,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#cdlatex,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> cdlatex
  (<span class="org-keyword">setq</span> cdlatex-env-alist
        '((<span class="org-string">"bmatrix"</span> <span class="org-string">"\\begin{bmatrix}\n?\n\\end{bmatrix}"</span> nil)
          (<span class="org-string">"equation*"</span> <span class="org-string">"\\begin{equation*}\n?\n\\end{equation*}"</span> nil)))
  (<span class="org-keyword">setq</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">cdlatex-math-symbol-prefix ?\; ;; doesn't work at the moment :(</span>
   cdlatex-math-symbol-alist
   '( <span class="org-comment-delimiter">;; </span><span class="org-comment">adding missing functions to 3rd level symbols</span>
     (?_    (<span class="org-string">"\\downarrow"</span>  <span class="org-string">""</span>           <span class="org-string">"\\inf"</span>))
     (?2    (<span class="org-string">"^2"</span>           <span class="org-string">"\\sqrt{?}"</span>     <span class="org-string">""</span>     ))
     (?3    (<span class="org-string">"^3"</span>           <span class="org-string">"\\sqrt[3]{?}"</span>  <span class="org-string">""</span>     ))
     (?^    (<span class="org-string">"\\uparrow"</span>    <span class="org-string">""</span>           <span class="org-string">"\\sup"</span>))
     (?k    (<span class="org-string">"\\kappa"</span>      <span class="org-string">""</span>           <span class="org-string">"\\ker"</span>))
     (?m    (<span class="org-string">"\\mu"</span>         <span class="org-string">""</span>           <span class="org-string">"\\lim"</span>))
     (?c    (<span class="org-string">""</span>             <span class="org-string">"\\circ"</span>     <span class="org-string">"\\cos"</span>))
     (?d    (<span class="org-string">"\\delta"</span>      <span class="org-string">"\\partial"</span>  <span class="org-string">"\\dim"</span>))
     (?D    (<span class="org-string">"\\Delta"</span>      <span class="org-string">"\\nabla"</span>    <span class="org-string">"\\deg"</span>))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">no idea why \Phi isnt on '</span><span class="org-comment"><span class="org-constant">F</span></span><span class="org-comment">' in first place, \phi is on '</span><span class="org-comment"><span class="org-constant">f</span></span><span class="org-comment">'.</span>
     (?F    (<span class="org-string">"\\Phi"</span>))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">now just convenience</span>
     (?.    (<span class="org-string">"\\cdot"</span> <span class="org-string">"\\dots"</span>))
     (?:    (<span class="org-string">"\\vdots"</span> <span class="org-string">"\\ddots"</span>))
     (?*    (<span class="org-string">"\\times"</span> <span class="org-string">"\\star"</span> <span class="org-string">"\\ast"</span>)))
   cdlatex-math-modify-alist
   '( <span class="org-comment-delimiter">;; </span><span class="org-comment">my own stuff</span>
     (?B    <span class="org-string">"\\mathbb"</span>        nil          t    nil  nil)
     (?a    <span class="org-string">"\\abs"</span>           nil          t    nil  nil))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-laas" class="outline-5">
<h5 id="laas"><span class="section-number-5">5.4.5.2.</span> <span class='acr'><span class='acr'>LAAS</span></span><a aria-hidden="true" href="#laas">#</a> </h5>
<div class="outline-text-5" id="text-5-4-5-2">
<p>
This makes use of <kbd>aas</kbd> (<i>Auto Activating Snippets</i>) for CDLaTeX-like symbol input.
</p>

<details id='laas,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#laas,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> laas <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/LaTeX-auto-activating-snippets"</span>))
</pre>
</div>
</details>

<details id='laas,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#laas,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! laas
  <span class="org-builtin">:hook</span> (LaTeX-mode . laas-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">laas-tex-fold-maybe</span> ()
    (<span class="org-keyword">unless</span> (equal <span class="org-string">"/"</span> aas-transient-snippet-key)
      (+latex-fold-last-macro-a)))
  (add-hook 'aas-post-snippet-expand-hook #'laas-tex-fold-maybe))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-synctex" class="outline-4">
<h4 id="synctex"><span class="section-number-4">5.4.6.</span> SyncTeX<a aria-hidden="true" href="#synctex">#</a> </h4>
<div class="outline-text-4" id="text-5-4-6">
<details id='synctex,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#synctex,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> tex
  (add-to-list 'TeX-view-program-list '(<span class="org-string">"Evince"</span> <span class="org-string">"evince %o"</span>))
  (add-to-list 'TeX-view-program-selection '(output-pdf <span class="org-string">"Evince"</span>)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-fixes" class="outline-4">
<h4 id="fixes"><span class="section-number-4">5.4.7.</span> Fixes<a aria-hidden="true" href="#fixes">#</a> </h4>
<div class="outline-text-4" id="text-5-4-7">
<p>
In case of Emacs28:
</p>

<details id='fixes,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fixes,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (&gt;= emacs-major-version 28)
  (add-hook 'latex-mode-hook #'TeX-latex-mode))
</pre>
</div>
</details>

<p>
With Emacs 29.4
</p>

<details id='fixes,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#fixes,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (= emacs-major-version 29) (= emacs-minor-version 4))
  (<span class="org-keyword">after!</span> auctex <span class="org-comment-delimiter">; </span><span class="org-comment">See <a href="https://github.com/minad/vertico/discussions/475">&lt;https://github.com/minad/vertico/discussions/475&gt;</a></span>
    (fmakunbound 'ConTeXt-mode)))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-python" class="outline-3">
<h3 id="python"><span class="section-number-3">5.5.</span> Python<a aria-hidden="true" href="#python">#</a> </h3>
<div class="outline-text-3" id="text-5-5">
<p>
Since I'm using <kbd>mypyls</kbd>, as suggested in <a href="file:///home/runner/.config/emacs/modules/lang/python/README.html#MissingReference">:lang python <span class='acr'>LSP</span> support</a> I'll tweak the
priority of <kbd>mypyls</kbd>
</p>

<details id='python,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#python,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> lsp-python-ms
  (set-lsp-priority! 'mspyls 1))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-pdf" class="outline-3">
<h3 id="pdf"><span class="section-number-3">5.6.</span> <span class='acr'><span class='acr'>PDF</span></span><a aria-hidden="true" href="#pdf">#</a> </h3>
<div class="outline-text-3" id="text-5-6">
</div>
<div id="outline-container-mupdf" class="outline-4">
<h4 id="mupdf"><span class="section-number-4">5.6.1.</span> MuPDF<a aria-hidden="true" href="#mupdf">#</a> </h4>
<div class="outline-text-4" id="text-5-6-1">
<p>
<kbd>pdf-tools</kbd> is nice, but a <kbd>mupdf</kbd>-based solution is nicer.
</p>

<details id='mupdf,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mupdf,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> paper <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"ymarco/paper-mode"</span>
                         <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span> <span class="org-string">".so"</span>)
                         <span class="org-builtin">:pre-build</span> (<span class="org-string">"make"</span>)))
</pre>
</div>
</details>

<details id='mupdf,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#mupdf,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">(use-package paper</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">;; :mode ("\\.pdf\\'"  . paper-mode)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">;; :mode ("\\.epub\\'"  . paper-mode)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">:config</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(require 'evil-collection-paper)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(evil-collection-paper-setup))</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-terminal-viewing" class="outline-4">
<h4 id="terminal-viewing"><span class="section-number-4">5.6.2.</span> Terminal viewing<a aria-hidden="true" href="#terminal-viewing">#</a> </h4>
<div class="outline-text-4" id="text-5-6-2">
<p>
Sometimes I'm in a terminal and I still want to see the content. Additionally,
sometimes I'd like to act on the textual content and so would like a plaintext version.
Thanks to we have a convenient way of performing this conversion.
I've integrated this into a little package, <kbd>pdftotext.el</kbd>.
</p>
<details id='terminal-viewing,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#terminal-viewing,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> pdftotext <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/pdftotext"</span>))
</pre>
</div>
</details>

<p>
The output can be slightly nicer without spelling errors, and with prettier page
feeds (<kbd>^L</kbd> by default).
</p>

<p>
This is very nice, now we just need to associate it with <kbd>.pdf</kbd> files, and make
sure <kbd>pdf-tools</kbd> doesn't take priority.
</p>

<p>
Lastly, whenever Emacs is non-graphical (i.e. a <span class='acr'>TUI</span>), we want to use this by default.
</p>

<details id='terminal-viewing,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#terminal-viewing,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! pdftotext
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">unless</span> (display-graphic-p)
    (add-to-list 'auto-mode-alist '(<span class="org-string">"\\.[pP][dD][fF]\\'"</span> . pdftotext-mode))
    (add-to-list 'magic-mode-alist '(<span class="org-string">"%PDF"</span> . pdftotext-mode)))
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">unless</span> (display-graphic-p) (<span class="org-keyword">after!</span> pdf-tools (pdftotext-install)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">For prettyness</span>
  (add-hook 'pdftotext-mode-hook #'spell-fu-mode-disable)
  (add-hook 'pdftotext-mode-hook (<span class="org-keyword">lambda</span> () (page-break-lines-mode 1)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">I have no idea why this is needed</span>
  (map! <span class="org-builtin">:map</span> pdftotext-mode-map
        <span class="org-string">"&lt;mouse-4&gt;"</span> (<span class="org-keyword">cmd!</span> (scroll-down mouse-wheel-scroll-amount-horizontal))
        <span class="org-string">"&lt;mouse-5&gt;"</span> (<span class="org-keyword">cmd!</span> (scroll-up mouse-wheel-scroll-amount-horizontal))))

</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-r" class="outline-3">
<h3 id="r"><span class="section-number-3">5.7.</span> R<a aria-hidden="true" href="#r">#</a> </h3>
<div class="outline-text-3" id="text-5-7">
</div>
<div id="outline-container-r-editor-visuals" class="outline-4">
<h4 id="r-editor-visuals"><span class="section-number-4">5.7.1.</span> Editor Visuals<a aria-hidden="true" href="#r-editor-visuals">#</a> </h4>
<div class="outline-text-4" id="text-5-7-1">
<details id='editor-visuals,code--5' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#editor-visuals,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">after!</span> ess-r-mode
  (<span class="org-keyword">appendq!</span> +ligatures-extra-symbols
            '(<span class="org-builtin">:assign</span> <span class="org-string">"&#10229;"</span>
              <span class="org-builtin">:multiply</span> <span class="org-string">"&#215;"</span>))
  (set-ligatures! 'ess-r-mode
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Functional</span>
    <span class="org-builtin">:def</span> <span class="org-string">"function"</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Types</span>
    <span class="org-builtin">:null</span> <span class="org-string">"NULL"</span>
    <span class="org-builtin">:true</span> <span class="org-string">"TRUE"</span>
    <span class="org-builtin">:false</span> <span class="org-string">"FALSE"</span>
    <span class="org-builtin">:int</span> <span class="org-string">"int"</span>
    <span class="org-builtin">:floar</span> <span class="org-string">"float"</span>
    <span class="org-builtin">:bool</span> <span class="org-string">"bool"</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Flow</span>
    <span class="org-builtin">:not</span> <span class="org-string">"!"</span>
    <span class="org-builtin">:and</span> <span class="org-string">"&amp;&amp;"</span> <span class="org-builtin">:or</span> <span class="org-string">"||"</span>
    <span class="org-builtin">:for</span> <span class="org-string">"for"</span>
    <span class="org-builtin">:in</span> <span class="org-string">"%in%"</span>
    <span class="org-builtin">:return</span> <span class="org-string">"return"</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Other</span>
    <span class="org-builtin">:assign</span> <span class="org-string">"&lt;-"</span>
    <span class="org-builtin">:multiply</span> <span class="org-string">"%*%"</span>))
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-julia" class="outline-3">
<h3 id="julia"><span class="section-number-3">5.8.</span> Julia<a aria-hidden="true" href="#julia">#</a> </h3>
<div class="outline-text-3" id="text-5-8">
<p>
It would be nice if <kbd>julia-mode</kbd> also highlighted the <kbd>julia&gt;</kbd> prompt when writing
<span class='acr'>REPL</span> examples.
</p>

<details id='julia,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#julia,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list
 'julia-font-lock-keywords
 '(<span class="org-string">"^julia&gt;"</span> 0 '(font-lock-string-face bold) prepend))
</pre>
</div>
</details>

<p>
As mentioned in <a href="https://github.com/non-Jedi/lsp-julia/issues/35">lsp-julia#35</a>, <kbd>lsp-mode</kbd> seems to serve an invalid response to the
Julia server. The pseudo-fix is rather simple at least
</p>
<details id='julia,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#julia,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'julia-mode-hook #'rainbow-delimiters-mode-enable)
(<span class="org-keyword">add-hook!</span> 'julia-mode-hook
  (<span class="org-keyword">setq-local</span> lsp-enable-folding t
              lsp-folding-range-limit 100))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-datatoml-files" class="outline-3">
<h3 id="datatoml-files"><span class="section-number-3">5.9.</span> Data.toml files<a aria-hidden="true" href="#datatoml-files">#</a> </h3>
<div class="outline-text-3" id="text-5-9">
<p>
For <kbd>DataToolkit.jl</kbd>-formatted <span class='acr'>TOML</span> files, I've made a major mode.
</p>

<details id='datatoml-files,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#datatoml-files,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> conf-data-toml <span class="org-builtin">:recipe</span> (<span class="org-builtin">:local-repo</span> <span class="org-string">"lisp/conf-data-toml"</span>))
</pre>
</div>
</details>

<p>
Since the major mode is autoloaded, all we need to do is register an appropriate
magic command for it to be used in <kbd>Data.toml</kbd> files.
</p>

<details id='datatoml-files,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#datatoml-files,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! conf-data-toml
  <span class="org-builtin">:magic</span> (<span class="org-string">"\\`data_config_version = [0-9]"</span> . conf-data-toml-mode))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-graphviz" class="outline-3">
<h3 id="graphviz"><span class="section-number-3">5.10.</span> Graphviz<a aria-hidden="true" href="#graphviz">#</a> </h3>
<div class="outline-text-3" id="text-5-10">
<p>
Graphviz is a nice method of visualising simple graphs, based on plaintext
<kbd>.dot</kbd> / <kbd>.gv</kbd> files.
</p>
<details id='graphviz,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#graphviz,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> graphviz-dot-mode <span class="org-builtin">:pin</span> <span class="org-string">"8ff793b13707cb511875f56e167ff7f980a31136"</span>)
</pre>
</div>
</details>

<details id='graphviz,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#graphviz,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! graphviz-dot-mode
  <span class="org-builtin">:commands</span> graphviz-dot-mode
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.dot\\'"</span> . graphviz-dot-mode)
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">after!</span> org
    (setcdr (assoc <span class="org-string">"dot"</span> org-src-lang-modes)
            'graphviz-dot)))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-markdown" class="outline-3">
<h3 id="markdown"><span class="section-number-3">5.11.</span> Markdown<a aria-hidden="true" href="#markdown">#</a> </h3>
<div class="outline-text-3" id="text-5-11">
<p>
Most of the time when I write markdown, it's going into some app/website which
will do it's own line wrapping, hence we <i>only</i> want to use visual line wrapping. No hard stuff.
</p>
<details id='markdown,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#markdown,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">add-hook!</span> (gfm-mode markdown-mode) #'visual-line-mode #'turn-off-auto-fill)
</pre>
</div>
</details>

<p>
Since markdown is often seen as rendered <span class='acr'>HTML</span>, let's try to somewhat mirror the
style or markdown renderers.
</p>

<p>
Most markdown renders seem to make the first three headings levels larger than
normal text, the first two much so. Then the fourth level tends to be the same
as body text, while the fifth and sixth are (increasingly) smaller, with the
sixth greyed out. Since the sixth level is so small, I'll turn up the boldness a notch.
</p>
<details id='markdown,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#markdown,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(custom-set-faces!
  '(markdown-header-face-1 <span class="org-builtin">:height</span> 1.25 <span class="org-builtin">:weight</span> extra-bold <span class="org-builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-2 <span class="org-builtin">:height</span> 1.15 <span class="org-builtin">:weight</span> bold       <span class="org-builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-3 <span class="org-builtin">:height</span> 1.08 <span class="org-builtin">:weight</span> bold       <span class="org-builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-4 <span class="org-builtin">:height</span> 1.00 <span class="org-builtin">:weight</span> bold       <span class="org-builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-5 <span class="org-builtin">:height</span> 0.90 <span class="org-builtin">:weight</span> bold       <span class="org-builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-6 <span class="org-builtin">:height</span> 0.75 <span class="org-builtin">:weight</span> extra-bold <span class="org-builtin">:inherit</span> markdown-header-face))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-beancount" class="outline-3">
<h3 id="beancount"><span class="section-number-3">5.12.</span> Beancount<a aria-hidden="true" href="#beancount">#</a> </h3>
<div class="outline-text-3" id="text-5-12">
<p>
There are a number of rather compelling advantages to <a href="https://plaintextaccounting.org/">plain text accounting</a>,
with <a href="https://www.ledger-cli.org/">ledger</a> being the most obvious example. However, <a href="https://github.com/beancount/beancount">beancount</a>, a more recent
implementation of the idea is ledger-compatible (meaning I can switch easily if
I change my mind) and has a gorgeous front-end &#x2014; <a href="https://beancount.github.io/fava/">fava</a>.
</p>

<p>
Of course, there's an Emacs mode for this.
</p>

<details id='beancount,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#beancount,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">package!</span> beancount <span class="org-builtin">:recipe</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"beancount/beancount-mode"</span>)
  <span class="org-builtin">:pin</span> <span class="org-string">"ddd4b8725703cf17a665b56cc26a3f9f95642424"</span>)
</pre>
</div>
</details>

<details id='beancount,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#beancount,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package! beancount
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.beancount\\'"</span> . beancount-mode)
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">after!</span> nerd-icons
    (add-to-list 'nerd-icons-extension-icon-alist
                 '(<span class="org-string">"beancount"</span> nerd-icons-faicon <span class="org-string">"nf-fa-dollar"</span> <span class="org-builtin">:face</span> nerd-icons-lblue))
    (add-to-list 'nerd-icons-mode-icon-alist
                 '(beancount-mode nerd-icons-faicon <span class="org-string">"nf-fa-dollar"</span> <span class="org-builtin">:face</span> nerd-icons-lblue)))
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> beancount-electric-currency t)
  (<span class="org-keyword">defun</span> <span class="org-function-name">beancount-bal</span> ()
    <span class="org-doc">"Run bean-report bal."</span>
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">let</span> ((compilation-read-command nil))
      (beancount--run <span class="org-string">"bean-report"</span>
                      (file-relative-name buffer-file-name) <span class="org-string">"bal"</span>)))
  (map! <span class="org-builtin">:map</span> beancount-mode-map
        <span class="org-builtin">:n</span> <span class="org-string">"TAB"</span> #'beancount-align-to-previous-number
        <span class="org-builtin">:i</span> <span class="org-string">"RET"</span> (<span class="org-keyword">cmd!</span> (newline-and-indent) (beancount-align-to-previous-number))))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-gimp-palette-files" class="outline-3">
<h3 id="gimp-palette-files"><span class="section-number-3">5.13.</span> <span class='acr'><span class='acr'>GIMP</span></span> Palette files<a aria-hidden="true" href="#gimp-palette-files">#</a> </h3>
<div class="outline-text-3" id="text-5-13">
<p>
I like using colour schemes with Inkscape, and it uses "<span class='acr'>GIMP</span> Palette" colour
scheme definition files. It's easy to edit them by hand, but often a bit annoying
as you need to keep the <span class='acr'>RGB</span> code and hex representation in sync. Let's make that
a little easier by writing a little major mode for it.
</p>

<p>
The major mode doesn't need to do much, just try to turn <code>rainbow-mode</code> on for
 pretty hex colours, turn off <code>hl-line-mode</code> (if required) so the <kbd>hl-line</kbd> face
 doesn't overshadow them, and then the most crucial part: syncing the <span class='acr'>RGB</span>/hex
 colour specifications on every buffer modification.
</p>

<p>
To catch all relevant modifications, but not trigger more frequently than needed
(as would happen if using <code>post-command-hook</code>, for example),
<code>after-change-functions</code> is the perfect option. We can make a buffer-local
addition that will sync all colours in the modified region.
</p>

<details id='gimp-palette-files,code--1' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gimp-palette-files,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">define-derived-mode</span> <span class="org-function-name">gimp-palette-mode</span> fundamental-mode <span class="org-string">"GIMP Palette"</span>
  <span class="org-doc">"A major mode for GIMP Palette (.gpl) files that keeps RGB and Hex colors in sync."</span>
  (<span class="org-keyword">when</span> (<span class="org-keyword">require</span> '<span class="org-constant">rainbow-mode</span>)
    (rainbow-mode 1))
  (<span class="org-keyword">when</span> (<span class="org-keyword">bound-and-true-p</span> hl-line-mode)
    (hl-line-mode -1))
  (add-hook 'after-change-functions #'gimp-palette-update-region nil t))
</pre>
</div>
</details>

<p>
Now we need to implement the <code>gimp-palette-update-region</code> function. If we plan on
implementing a per-line update function, this is simply a matter of calling it
on each line with a few quality of life improvements:
</p>
<ul class="org-ul">
<li>Batching all the changes into a single undo step (via <code>undo-amalgamate-change-group</code>)</li>
<li>Working interactively with a selected region, or the whole buffer.</li>
</ul>

<details id='gimp-palette-files,code--2' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gimp-palette-files,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">gimp-palette-update-region</span> (beg end <span class="org-type">&amp;optional</span> _)
  <span class="org-doc">"Update each line between BEG and END with `</span><span class="org-doc"><span class="org-constant">gimp-palette-update-line</span></span><span class="org-doc">'.</span>
<span class="org-doc">If run interactively without a region set, the whole buffer is affected."</span>
  (<span class="org-keyword">interactive</span>
   (<span class="org-keyword">if</span> (region-active-p)
       (list (region-beginning) (region-end))
     (list (point-min) (point-max))))
  (<span class="org-keyword">let</span> ((marker (prepare-change-group)))
    (<span class="org-keyword">unwind-protect</span>
        (<span class="org-keyword">save-excursion</span>
          (goto-char beg)
          (<span class="org-keyword">while</span> (&lt; (point) end)
            (gimp-palette-update-line)
            (forward-line 1)))
      (undo-amalgamate-change-group marker))))
</pre>
</div>
</details>

<p>
Now we need to implement the per-line update function. This won't be a
particularly short function, but it isn't complicated either. It should work as
follows:
</p>
<ol class="org-ol">
<li>Check to see whether the line starts with <kbd>R G B #HEX</kbd></li>
<li>Check that <code>point</code> is within the <span class='acr'>RGB</span>/hex part of the linen</li>
<li>If on the hex part, parse the hex string and update the <span class='acr'>RGB</span> to match
(inserting the <span class='acr'>RGB</span> component if it does not already exist)</li>
<li>If on the <span class='acr'>RGB</span> part, update the hex part to match</li>
</ol>

<details id='gimp-palette-files,code--3' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gimp-palette-files,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">gimp-palette-update-line</span> ()
  <span class="org-doc">"Update the RGB and Hex colour codes on the current line.</span>
<span class="org-doc">Whichever `</span><span class="org-doc"><span class="org-constant">point</span></span><span class="org-doc">' is currently on is taken as the source of truth."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((column (current-column))
        (ipoint (point)))
    (beginning-of-line)
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-builtin">\\=</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9 ]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">#[0-9A-Fa-f]\\{</span><span class="org-string"><span class="org-variable-name">6\\</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
               (&lt;= column (length (match-string 0))))
      (<span class="org-keyword">cond</span>
       ((&gt;= column (length (match-string 1))) <span class="org-comment-delimiter">; </span><span class="org-comment">Point in #HEX</span>
        (<span class="org-keyword">cl-destructuring-bind</span> (r g b) (color-name-to-rgb (match-string 2))
          (replace-match
           (format <span class="org-string">"%3d %3d %3d "</span>
                   (round (* 255 r))
                   (round (* 255 g))
                   (round (* 255 b)))
           nil t nil 1)))
       ((string-match-p <span class="org-string">"\\`[0-9]+ +[0-9]+ +[0-9]+\\'"</span> (match-string 1)) <span class="org-comment-delimiter">; </span><span class="org-comment">Valid R G B</span>
        (<span class="org-keyword">cl-destructuring-bind</span> (r g b)
            (mapcar #'string-to-number
                    (<span class="org-keyword">save-match-data</span>
                      (split-string (match-string 1) <span class="org-string">" +"</span> t)))
          (replace-match
           (format <span class="org-string">"%3d %3d %3d "</span> r g b)
           nil t nil 1)
          (replace-match
           (color-rgb-to-hex (/ r 255.0) (/ g 255.0) (/ b 255.0) 2)
           nil t nil 2)))))
    (goto-char ipoint)))
</pre>
</div>
</details>

<p>
The last thing that's needed to make this functionality convenient is to have it
automatically activate when appropriate. <span class='acr'>GIMP</span> palette files re-use the <kbd>.gpl</kbd>
extension, so <code>auto-mode-alist</code> isn't a good choice, but we can use the
<code>magic-mode-alist</code> to use this mode in any file that begins with <kbd>GIMP Palette</kbd>,
which is perfect for our needs.
</p>

<details id='gimp-palette-files,code--4' class='code' open><summary><span class="lang">Emacs Lisp</span></summary>
<div class='gutter'>
<a href='#gimp-palette-files,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'magic-mode-alist (cons <span class="org-string">"\\`GIMP Palette\n"</span> #'gimp-palette-mode))
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-snippets" class="outline-3">
<h3 id="snippets"><span class="section-number-3">5.14.</span> Snippets<a aria-hidden="true" href="#snippets">#</a> </h3>
<div class="outline-text-3" id="text-5-14">
</div>
<div id="outline-container-latex-mode" class="outline-4">
<h4 id="latex-mode"><span class="section-number-4">5.14.1.</span> Latex mode<a aria-hidden="true" href="#latex-mode">#</a> </h4>
<div class="outline-text-4" id="text-5-14-1">
<p>
File template
</p>
<details id='latex-mode,code--1' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: LaTeX template                                                                                         </span>
<span class="org-comment"># --</span>
\documentclass<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>opt1,...<span class="org-keyword">}</span>]<span class="org-keyword">}</span>{`(tec/yas-latex-get-class-choice)`<span class="org-keyword">}</span>

\title{<span class="org-keyword">${</span><span class="org-warning">3</span><span class="org-keyword">:</span>`(s-titleized-words (file-name-base (<span class="org-keyword">or</span> buffer-file-name <span class="org-string">"new buffer"</span>)))`<span class="org-keyword">}}</span>
\author{<span class="org-keyword">${</span><span class="org-warning">4</span><span class="org-keyword">:</span>`(user-full-name)`<span class="org-keyword">}}</span>
\date{<span class="org-keyword">${</span><span class="org-warning">5</span><span class="org-keyword">:</span>`(format-time-string <span class="org-string">"%Y-%m-%d"</span>)`<span class="org-keyword">}}</span>
`(<span class="org-keyword">if</span> (tec/yas-latex-preamble-if) tec/yas-latex-template-preamble <span class="org-string">""</span>)`
\begin{document<span class="org-keyword">}</span>

\maketitle

<span class="org-keyword">$</span><span class="org-string">0</span>

\end{document<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Deliminators
</p>
<details id='latex-mode,code--2' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># name: _deliminators                                                                 </span>
<span class="org-comment"># --</span>
\left`(tec/tex-open-delim-from-char)` `%`<span class="org-keyword">$</span><span class="org-string">1</span> \right`(tec/tex-close-delim-from-char)` <span class="org-keyword">$</span><span class="org-string">0</span>

</pre>
</div>
</details>

<p>
Aligned equals
</p>
<details id='latex-mode,code--3' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># key: ==</span>
<span class="org-comment"># name: aligned equals</span>
<span class="org-comment"># --</span>
<span class="org-type">&amp;=</span> 
</pre>
</div>
</details>

<p>
Begin alias
</p>
<details id='latex-mode,code--4' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: begin-alias</span>
<span class="org-comment"># key: beg</span>
<span class="org-comment"># type: command</span>
<span class="org-comment"># --</span>
(doom-snippets-expand :name <span class="org-string">"begin"</span>)
</pre>
</div>
</details>

<p>
Cases
</p>
<details id='latex-mode,code--5' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># key: cs</span>
<span class="org-comment"># name: cases</span>
<span class="org-comment"># group: math</span>
<span class="org-comment"># condition: (texmathp)</span>
<span class="org-comment"># --</span>
\begin{cases<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">1</span>
\end{cases<span class="org-keyword">}$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Code
</p>
<details id='latex-mode,code--6' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: code</span>
<span class="org-comment"># --</span>
\begin{minted<span class="org-keyword">}</span>{<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>language<span class="org-keyword">}}</span>
<span class="org-keyword">${</span><span class="org-warning">0</span><span class="org-keyword">:</span>`%`<span class="org-keyword">}</span>
\end{minted<span class="org-keyword">}</span>

</pre>
</div>
</details>

<p>
Corollary
</p>
<details id='latex-mode,code--7' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: corollary</span>
<span class="org-comment"># key: clr</span>
<span class="org-comment"># group: theorems</span>
<span class="org-comment"># --</span>
\begin{corollary<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>name<span class="org-keyword">}</span>]<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{corollary<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Definition
</p>
<details id='latex-mode,code--8' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--8'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: definition</span>
<span class="org-comment"># key: def</span>
<span class="org-comment"># group: theorems</span>
<span class="org-comment"># --</span>
\begin{definition<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>name<span class="org-keyword">}</span>]<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{definition<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Deliminators
</p>
<details id='latex-mode,code--9' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--9'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: deliminators</span>
<span class="org-comment"># key: @</span>
<span class="org-comment"># condition: (texmathp)</span>
<span class="org-comment"># type: command                                                    </span>
<span class="org-comment"># --</span>
(tec/get-open-delim-char)
(yas-expand-snippet (yas-lookup-snippet <span class="org-string">"_deliminators"</span> 'latex-mode))
</pre>
</div>
</details>

<p>
Deliminators angle
</p>
<details id='latex-mode,code--10' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--10'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: deliminators - angle &lt;&gt;</span>
<span class="org-comment"># key: &lt;</span>
<span class="org-comment"># condition: (texmathp)</span>
<span class="org-comment"># type: command                  </span>
<span class="org-comment"># --</span>
(<span class="org-keyword">setq</span> tec/tex-last-delim-char ?\&lt;)
(<span class="org-keyword">setq</span> tec/tex-delim-dot-second nil)
(tec/tex-delim-yas-expand)
</pre>
</div>
</details>

<p>
Deliminators bracket
</p>
<details id='latex-mode,code--11' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--11'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: deliminators - bracket []</span>
<span class="org-comment"># key: [</span>
<span class="org-comment"># condition: (texmathp)</span>
<span class="org-comment"># type: command</span>
<span class="org-comment"># --</span>
(<span class="org-keyword">setq</span> tec/tex-last-delim-char ?\[)
(<span class="org-keyword">setq</span> tec/tex-delim-dot-second nil)
(tec/tex-delim-yas-expand)
</pre>
</div>
</details>

<p>
Deliminators curly
</p>
<details id='latex-mode,code--12' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--12'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: deliminators - curley {}</span>
<span class="org-comment"># key: {</span>
<span class="org-comment"># condition: (texmathp)</span>
<span class="org-comment"># type: command                  </span>
<span class="org-comment"># --</span>
(<span class="org-keyword">setq</span> tec/tex-last-delim-char ?\{)
(<span class="org-keyword">setq</span> tec/tex-delim-dot-second nil)
(tec/tex-delim-yas-expand)

</pre>
</div>
</details>

<p>
Deliminators paren
</p>
<details id='latex-mode,code--13' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--13'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: deliminators - paren ()</span>
<span class="org-comment"># key: (</span>
<span class="org-comment"># condition: (texmathp)</span>
<span class="org-comment"># type: command</span>
<span class="org-comment"># --</span>
(<span class="org-keyword">setq</span> tec/tex-last-delim-char ?\()
(<span class="org-keyword">setq</span> tec/tex-delim-dot-second nil)
(tec/tex-delim-yas-expand)
</pre>
</div>
</details>

<p>
Enumerate
</p>
<details id='latex-mode,code--14' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--14'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: enumerate</span>
<span class="org-comment"># key: en          </span>
<span class="org-comment"># --</span>
\begin{enumerate<span class="org-keyword">}</span>
`(<span class="org-keyword">if</span> % % <span class="org-string">"  \\item "</span>)`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{enumerate<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Example
</p>
<details id='latex-mode,code--15' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--15'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: example</span>
<span class="org-comment"># key: eg</span>
<span class="org-comment"># group: theorems</span>
<span class="org-comment"># --</span>
\begin{example<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>name<span class="org-keyword">}</span>]<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{example<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Frac short
</p>
<details id='latex-mode,code--16' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--16'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># key: /</span>
<span class="org-comment"># name: frac-short</span>
<span class="org-comment"># group: math</span>
<span class="org-comment"># condition: (texmathp)      </span>
<span class="org-comment"># --</span>
\frac{<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>`(<span class="org-keyword">or</span> % <span class="org-string">""</span>)`<span class="org-keyword">}}</span>{<span class="org-keyword">$</span><span class="org-string">2</span><span class="org-keyword">}$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Int ^
</p>
<details id='latex-mode,code--17' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--17'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># key: int</span>
<span class="org-comment"># name: int_^</span>
<span class="org-comment"># --</span>
\int<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span><span class="org-preprocessor">$(</span><span class="org-keyword">when</span> (&gt; (length yas-text) 0) <span class="org-string">"_"</span>)
<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span><span class="org-preprocessor">$(</span><span class="org-keyword">when</span> (&gt; (length yas-text) 1) <span class="org-string">"{"</span>)
<span class="org-keyword">}</span><span class="org-warning">${1:left}${1:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"}"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 0) </span><span class="org-string"><span class="org-warning">"^"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"{"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:right}${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"}"</span></span><span class="org-warning">)} $</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Itemize
</p>
<details id='latex-mode,code--18' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--18'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: itemize</span>
<span class="org-comment"># key: it</span>
<span class="org-comment"># uuid: it              </span>
<span class="org-comment"># --</span>
\begin{itemize<span class="org-keyword">}</span>
`(<span class="org-keyword">if</span> % % <span class="org-string">"  \\item "</span>)`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{itemize<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Lemma
</p>
<details id='latex-mode,code--19' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--19'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: lemma</span>
<span class="org-comment"># key: lmm</span>
<span class="org-comment"># group: theorems</span>
<span class="org-comment"># --</span>
\begin{lemma<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>name<span class="org-keyword">}</span>]<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{lemma<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Lim
</p>
<details id='latex-mode,code--20' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--20'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: lim</span>
<span class="org-comment"># key: lim</span>
<span class="org-comment"># --</span>
\lim_{<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>n<span class="org-keyword">}</span> \to <span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>\infty<span class="org-keyword">}}</span> <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Mathclap
</p>
<details id='latex-mode,code--21' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--21'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># key: mc</span>
<span class="org-comment"># name: mathclap</span>
<span class="org-comment"># group: math</span>
<span class="org-comment"># condition: (texmathp)</span>
<span class="org-comment"># --</span>
\mathclap{`%`<span class="org-keyword">$</span><span class="org-string">1</span><span class="org-keyword">}$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Prod ^
</p>
<details id='latex-mode,code--22' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--22'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># key: prod</span>
<span class="org-comment"># name: prod_^</span>
<span class="org-comment"># --</span>
\prod<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span><span class="org-preprocessor">$(</span><span class="org-keyword">when</span> (&gt; (length yas-text) 0) <span class="org-string">"_"</span>)
<span class="org-keyword">}</span><span class="org-warning">${1:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"{"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${1:i=1}${1:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"}"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 0) </span><span class="org-string"><span class="org-warning">"^"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"{"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:n}${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"}"</span></span><span class="org-warning">)} $</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Proof
</p>
<details id='latex-mode,code--23' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--23'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: proof</span>
<span class="org-comment"># key: prf</span>
<span class="org-comment"># group: theorems</span>
<span class="org-comment"># --</span>
\begin{proof<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>name<span class="org-keyword">}</span>]<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{proof<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Remark
</p>
<details id='latex-mode,code--24' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--24'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: remark</span>
<span class="org-comment"># key: rmk</span>
<span class="org-comment"># group: theorems</span>
<span class="org-comment"># --</span>
\begin{remark<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>name<span class="org-keyword">}</span>]<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{remark<span class="org-keyword">}</span>
</pre>
</div>
</details>

<p>
Sum ^
</p>
<details id='latex-mode,code--25' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--25'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># key: sum</span>
<span class="org-comment"># name: sum_^</span>
<span class="org-comment"># --</span>
\sum<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span><span class="org-preprocessor">$(</span><span class="org-keyword">when</span> (&gt; (length yas-text) 0) <span class="org-string">"_"</span>)
<span class="org-keyword">}</span><span class="org-warning">${1:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"{"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${1:i=1}${1:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"}"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 0) </span><span class="org-string"><span class="org-warning">"^"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"{"</span></span><span class="org-warning">)</span>
<span class="org-keyword">}</span><span class="org-warning">${2:n}${2:$(</span><span class="org-keyword"><span class="org-warning">when</span></span><span class="org-warning"> (&gt; (length yas-text) 1) </span><span class="org-string"><span class="org-warning">"}"</span></span><span class="org-warning">)} $</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Theorem
</p>
<details id='latex-mode,code--26' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#latex-mode,code--26'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: theorem</span>
<span class="org-comment"># key: thm</span>
<span class="org-comment"># group: theorems</span>
<span class="org-comment"># --</span>
\begin{theorem<span class="org-keyword">}${</span><span class="org-warning">1</span><span class="org-keyword">:</span>[<span class="org-keyword">${</span><span class="org-warning">2</span><span class="org-keyword">:</span>name<span class="org-keyword">}</span>]<span class="org-keyword">}</span>
  `%`<span class="org-keyword">$</span><span class="org-string">0</span>
\end{theorem<span class="org-keyword">}</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-markdown-mode" class="outline-4">
<h4 id="markdown-mode"><span class="section-number-4">5.14.2.</span> Markdown mode<a aria-hidden="true" href="#markdown-mode">#</a> </h4>
<div class="outline-text-4" id="text-5-14-2">
<p>
File template
</p>
<details id='markdown-mode,code--1' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#markdown-mode,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Org template</span>
<span class="org-comment"># --</span>
# <span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>`(s-titleized-words (file-name-base (<span class="org-keyword">or</span> buffer-file-name <span class="org-string">"new buffer"</span>)))`<span class="org-keyword">}</span>

<span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>
</div>
</div>
<div id="outline-container-org-mode" class="outline-4">
<h4 id="org-mode"><span class="section-number-4">5.14.3.</span> Org mode<a aria-hidden="true" href="#org-mode">#</a> </h4>
<div class="outline-text-4" id="text-5-14-3">
<p>
File template
</p>
<details id='org-mode,code--1' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--1'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Org template</span>
<span class="org-comment"># --</span>
#+title: <span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>`(s-titleized-words (replace-regexp-in-string <span class="org-string">"^[0-9]\\{</span><span class="org-string"><span class="org-variable-name">4\\</span></span><span class="org-string">}-[0-9][0-9]-[0-9][0-9]-"</span> <span class="org-string">""</span> (file-name-base (<span class="org-keyword">or</span> buffer-file-name <span class="org-string">"new buffer"</span>))))`<span class="org-keyword">}</span>
<span class="org-comment">#+author: ${</span><span class="org-warning">2</span><span class="org-comment">:`(user-full-name)`}</span>
#+date: <span class="org-keyword">${</span><span class="org-warning">3</span><span class="org-keyword">:</span>`(format-time-string <span class="org-string">"%Y-%m-%d"</span>)`<span class="org-keyword">}</span>

<span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Display maths
</p>
<details id='org-mode,code--2' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--2'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: display math</span>
<span class="org-comment"># key: M</span>
<span class="org-comment"># condition: t</span>
# expand-env: ((yas-after-exit-snippet-hook (<span class="org-keyword">lambda</span> () (org-edit-latex-fragment) (evil-insert-state) (insert <span class="org-string">"\n  \n"</span>) (left-char))))
<span class="org-comment"># --</span>
\\[`%`<span class="org-keyword">$</span><span class="org-string">0</span>\\]
</pre>
</div>
</details>

<p>
Elisp source
</p>
<details id='org-mode,code--3' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--3'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: elisp src</span>
<span class="org-comment"># uuid: src_elisp</span>
<span class="org-comment"># key: &lt;el</span>
<span class="org-comment"># condition: t</span>
<span class="org-comment"># expand-env: ((yas-after-exit-snippet-hook #'org-edit-src-code))</span>
<span class="org-comment"># --</span>
<span class="org-comment">#+begin_src emacs-lisp</span>
`%`<span class="org-keyword">$</span><span class="org-string">0</span>
<span class="org-comment">#+end_src</span>
</pre>
</div>
</details>

<p>
Global property
</p>
<details id='org-mode,code--4' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--4'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Global property</span>
<span class="org-comment"># key: #+p</span>
<span class="org-comment"># condition: (&gt; 20 (line-number-at-pos))</span>
<span class="org-comment"># --</span>
<span class="org-comment">#+property: $</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument dir
</p>
<details id='org-mode,code--5' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--5'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - dir</span>
<span class="org-comment"># key: d</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:dir `(file-relative-name (read-directory-name <span class="org-string">"Working directory: "</span>))` <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument eval
</p>
<details id='org-mode,code--6' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--6'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - eval</span>
<span class="org-comment"># key: v</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
`(<span class="org-keyword">let</span> ((out (+yas/org-prompt-header-arg :eval <span class="org-string">"Evaluate: "</span> '(<span class="org-string">"no"</span> <span class="org-string">"query"</span> <span class="org-string">"no-export"</span> <span class="org-string">"query-export"</span>)))) (<span class="org-keyword">if</span> out (concat <span class="org-string">":eval "</span> out <span class="org-string">" "</span>) <span class="org-string">""</span>))`
</pre>
</div>
</details>

<p>
Header argument export
</p>
<details id='org-mode,code--7' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--7'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - export</span>
<span class="org-comment"># key: e</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
`(<span class="org-keyword">let</span> ((out (+yas/org-prompt-header-arg :exports <span class="org-string">"Exports: "</span> '(<span class="org-string">"code"</span> <span class="org-string">"results"</span> <span class="org-string">"both"</span> <span class="org-string">"none"</span>)))) (<span class="org-keyword">if</span> out (concat <span class="org-string">":exports "</span> out <span class="org-string">" "</span>) <span class="org-string">""</span>))`
</pre>
</div>
</details>

<p>
Header argument file
</p>
<details id='org-mode,code--8' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--8'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - file</span>
<span class="org-comment"># key: f</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:file <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument graphics
</p>
<details id='org-mode,code--9' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--9'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - graphics</span>
<span class="org-comment"># key: g</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:results file graphics <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument height
</p>
<details id='org-mode,code--10' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--10'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - height</span>
<span class="org-comment"># key: H</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:height <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument noweb
</p>
<details id='org-mode,code--11' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--11'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - noweb</span>
<span class="org-comment"># key: n</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
`(<span class="org-keyword">let</span> ((out (+yas/org-prompt-header-arg :noweb <span class="org-string">"NoWeb: "</span> '(<span class="org-string">"no"</span> <span class="org-string">"yes"</span> <span class="org-string">"tangle"</span> <span class="org-string">"no-export"</span> <span class="org-string">"strip-export"</span> <span class="org-string">"eval"</span>)))) (<span class="org-keyword">if</span> out (concat <span class="org-string">":noweb "</span> out <span class="org-string">" "</span>) <span class="org-string">""</span>))`
</pre>
</div>
</details>

<p>
Header argument output
</p>
<details id='org-mode,code--12' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--12'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - output</span>
<span class="org-comment"># key: o</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:results output <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument results
</p>
<details id='org-mode,code--13' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--13'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - results</span>
<span class="org-comment"># key: r</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
`(<span class="org-keyword">let</span> ((out
(string-trim-right
 (concat
  (+yas/org-prompt-header-arg :results <span class="org-string">"Result collection: "</span> '(<span class="org-string">"value "</span> <span class="org-string">"output "</span>))
  (+yas/org-prompt-header-arg :results <span class="org-string">"Results type: "</span> '(<span class="org-string">"table "</span> <span class="org-string">"vector "</span> <span class="org-string">"list "</span> <span class="org-string">"verbatim "</span> <span class="org-string">"file "</span>))
  (+yas/org-prompt-header-arg :results <span class="org-string">"Results format: "</span> '(<span class="org-string">"code "</span> <span class="org-string">"drawer "</span> <span class="org-string">"html "</span> <span class="org-string">"latex "</span> <span class="org-string">"link "</span> <span class="org-string">"graphics "</span> <span class="org-string">"org "</span> <span class="org-string">"pp "</span> <span class="org-string">"raw "</span>))
  (+yas/org-prompt-header-arg :results <span class="org-string">"Result output: "</span> '(<span class="org-string">"silent "</span> <span class="org-string">"replace "</span> <span class="org-string">"append "</span> <span class="org-string">"prepend "</span>))))))
  (<span class="org-keyword">if</span> (string= out <span class="org-string">""</span>) <span class="org-string">""</span>
  (concat <span class="org-string">":results "</span> out <span class="org-string">" "</span>)))
`
</pre>
</div>
</details>

<p>
Header argument session
</p>
<details id='org-mode,code--14' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--14'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - session</span>
<span class="org-comment"># key: S</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:session <span class="org-string">"${</span><span class="org-warning">1</span><span class="org-string">:`(file-name-base (or (buffer-file-name) "</span>unnnamed<span class="org-string">"))`-session}"</span> <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument silent
</p>
<details id='org-mode,code--15' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--15'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - silent</span>
<span class="org-comment"># key: s</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:results silent <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument tangle
</p>
<details id='org-mode,code--16' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--16'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - tangle</span>
<span class="org-comment"># key: t</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:tangle <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument width
</p>
<details id='org-mode,code--17' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--17'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - width</span>
<span class="org-comment"># key: W</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
:width <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Header argument wrap
</p>
<details id='org-mode,code--18' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--18'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Header arg - wrap</span>
<span class="org-comment"># key: w</span>
<span class="org-comment"># condition: (+yas/org-src-header-p)</span>
<span class="org-comment"># --</span>
`(<span class="org-keyword">let</span> ((out (+yas/org-prompt-header-arg :noweb <span class="org-string">"Wrap: "</span> '(<span class="org-string">"example"</span> <span class="org-string">"export"</span> <span class="org-string">"comment"</span> <span class="org-string">"src"</span>)))) (<span class="org-keyword">if</span> out (concat <span class="org-string">":wrap "</span> out <span class="org-string">" "</span>) <span class="org-string">""</span>))`
</pre>
</div>
</details>

<p>
Inline math
</p>
<details id='org-mode,code--19' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--19'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: inline math</span>
<span class="org-comment"># key: m</span>
<span class="org-comment"># condition: t</span>
<span class="org-comment"># expand-env: ((yas-after-exit-snippet-hook (lambda () (org-edit-latex-fragment) (evil-insert-state) (goto-char 3))))</span>
<span class="org-comment"># --</span>
\\(`%`<span class="org-keyword">$</span><span class="org-string">0</span>\\)
</pre>
</div>
</details>

<p>
Property header arguments
</p>
<details id='org-mode,code--20' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--20'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: Property - header arg</span>
<span class="org-comment"># key: h</span>
# condition: (<span class="org-keyword">or</span> (looking-back <span class="org-string">"^#\\+PROPERTY:.*"</span> (line-beginning-position)) (looking-back <span class="org-string">"^#\\+property:.*"</span> (line-beginning-position)))
<span class="org-comment"># --</span>
header-args:<span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>`(<span class="org-keyword">or</span> (+yas/org-most-common-no-property-lang) <span class="org-string">"?"</span>)`<span class="org-keyword">}</span> <span class="org-keyword">$</span><span class="org-string">0</span>
</pre>
</div>
</details>

<p>
Python source
</p>
<details id='org-mode,code--21' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--21'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: python src</span>
<span class="org-comment"># uuid: src_python</span>
<span class="org-comment"># key: &lt;py</span>
<span class="org-comment"># condition: t</span>
<span class="org-comment"># expand-env: ((yas-after-exit-snippet-hook #'org-edit-src-code))</span>
<span class="org-comment"># --</span>
<span class="org-comment">#+begin_src python</span>
`%`<span class="org-keyword">$</span><span class="org-string">0</span>
<span class="org-comment">#+end_src</span>
</pre>
</div>
</details>

<p>
Source
</p>
<details id='org-mode,code--22' class='code' open><summary><span class="lang">snippet</span></summary>
<div class='gutter'>
<a href='#org-mode,code--22'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>⎘</button></div>
<div class="org-src-container">
<pre class="src src-snippet"><span class="org-comment"># -*- mode: snippet -*-</span>
<span class="org-comment"># name: #+begin_src</span>
<span class="org-comment"># uuid: src</span>
<span class="org-comment"># key: src</span>
<span class="org-comment"># --</span>
#+begin_src <span class="org-keyword">${</span><span class="org-warning">1</span><span class="org-keyword">:</span>`(<span class="org-keyword">or</span> (+yas/org-last-src-lang) <span class="org-string">"?"</span>)`<span class="org-keyword">}</span>
`%`<span class="org-keyword">$</span><span class="org-string">0</span>
<span class="org-comment">#+end_src</span>
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: <!--<a href="https://code.tecosaur.net/tec/emacs-config/commit/e1dfc56" style="text-decoration: none"><code style="padding: 0; color: var(--text-light); font-size: inherit; opacity: 0.7">e1dfc56</code></a>-->2025-06-09 14:56 <span class='acr'>UTC</span>, <a href="https://code.tecosaur.net/tec/emacs-config/commit/e1dfc56" style="text-decoration: none"><code style="padding: 0; color: var(--text-light); font-size: inherit; opacity: 0.7">e1dfc56</code></a></p>
<p class="author">Author: tecosaur</p>
<p class="date">Created: 2025-06-14 Sat 10:35</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</div>
</body>
</html>
